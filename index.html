<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¥­å‹™é…ç½®èª¿æ•´ã‚·ã‚¹ãƒ†ãƒ </title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        .staff-card {
            transition: all 0.3s ease;
            cursor: grab;
            border-radius: 8px;
            padding: 8px;
            margin: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 60px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .staff-card:active {
            cursor: grabbing;
        }
        .staff-card.sortable-chosen {
            transform: rotate(5deg);
            opacity: 0.8;
        }
        .staff-card.sortable-drag {
            transform: rotate(0deg);
            opacity: 1;
        }
        .business-slot {
            min-height: 80px;
            border: 2px dashed #e5e7eb;
            border-radius: 8px;
            transition: all 0.3s ease;
            position: relative;
        }
        .business-slot.sortable-drag-over {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .business-slot.has-assignment {
            border-style: solid;
            border-color: #10b981;
        }
        .on-call-badge {
            font-size: 10px;
            background: #fbbf24;
            color: #1f2937;
            padding: 2px 4px;
            border-radius: 4px;
            margin-top: 2px;
        }
        .timeline-header {
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
            border-bottom: 2px solid #e5e7eb;
        }
        .time-slot {
            width: 40px;
            height: 30px;
            border: 1px solid #e5e7eb;
            display: inline-block;
            text-align: center;
            line-height: 28px;
            font-size: 10px;
            position: relative;
        }
        .time-slot.assigned {
            background-color: #dbeafe;
            color: #1e40af;
            font-weight: bold;
        }
        .time-slot.status-onCall {
            background-color: #fef3c7;
            color: #92400e;
        }
        .time-slot.status-offDuty {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .status-tab {
            padding: 8px 16px;
            margin: 2px;
            border: 2px solid #e5e7eb;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        .status-tab.active {
            border-color: #3b82f6;
            background-color: #eff6ff;
            color: #1e40af;
        }
        .status-day-panel {
            display: none;
        }
        .status-day-panel.active {
            display: block;
        }
        .assignment-counter {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }
        .business-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 8px;
            margin: 4px 0;
            cursor: pointer;
        }
        .business-card:hover {
            background: #f1f5f9;
        }
        .hidden-section {
            display: none;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .editable {
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 3px;
            transition: background-color 0.2s;
        }
        .editable:hover {
            background-color: #f3f4f6;
        }
        .editable.editing {
            background-color: #fef3c7;
            outline: 2px solid #f59e0b;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">

<!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ç”»é¢ -->
<div id="password-screen" class="fixed inset-0 bg-gray-900 flex items-center justify-center z-50">
    <div class="bg-white p-8 rounded-lg shadow-xl max-w-md w-full mx-4">
        <div class="text-center mb-6">
            <i class="fas fa-lock text-4xl text-blue-600 mb-4"></i>
            <h1 class="text-2xl font-bold text-gray-800">æ¥­å‹™é…ç½®èª¿æ•´ã‚·ã‚¹ãƒ†ãƒ </h1>
            <p class="text-gray-600 mt-2">è‡¨åºŠå·¥å­¦éƒ¨ é€±æ¬¡äººå“¡èª¿æ•´</p>
        </div>
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
            <input type="password" id="password-input" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
            <p class="text-xs text-gray-500 mt-1">ãƒ’ãƒ³ãƒˆ: me(OPEå†…ç·š)me</p>
        </div>
        <button onclick="checkPassword()" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition duration-200">
            <i class="fas fa-sign-in-alt mr-2"></i>ãƒ­ã‚°ã‚¤ãƒ³
        </button>
        <div id="password-error" class="text-red-600 text-sm mt-2 hidden">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“</div>
    </div>
</div>

<!-- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ -->
<div id="main-app" class="hidden">

<!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼ -->
<nav class="bg-white shadow-sm border-b-2 border-blue-200 mb-6">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16">
            <div class="flex items-center">
                <h1 class="text-xl font-bold text-gray-900">æ¥­å‹™é…ç½®èª¿æ•´ã‚·ã‚¹ãƒ†ãƒ </h1>
                <span class="ml-4 text-sm text-gray-600">è‡¨åºŠå·¥å­¦éƒ¨ é€±æ¬¡äººå“¡èª¿æ•´</span>
            </div>
            <div class="flex items-center space-x-4">
                <button onclick="showScreen('home')" class="nav-btn px-4 py-2 rounded-md text-sm font-medium transition-colors" data-screen="home">
                    <i class="fas fa-home mr-2"></i>HOME
                </button>
                <button onclick="showScreen('schedule')" class="nav-btn px-4 py-2 rounded-md text-sm font-medium transition-colors" data-screen="schedule">
                    <i class="fas fa-calendar-alt mr-2"></i>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆ
                </button>
                <button onclick="showScreen('timeline')" class="nav-btn px-4 py-2 rounded-md text-sm font-medium transition-colors" data-screen="timeline">
                    <i class="fas fa-clock mr-2"></i>é€±é…ç½®ä¸€è¦§
                </button>
                <button onclick="exportToPDF()" class="bg-green-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-green-700 transition-colors">
                    <i class="fas fa-file-pdf mr-2"></i>PDFå‡ºåŠ›
                </button>
            </div>
        </div>
    </div>
</nav>

<!-- HOMEç”»é¢ -->
<div id="home-screen" class="screen max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        
        <!-- ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç† -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">
                    <i class="fas fa-users mr-2"></i>ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç† (27å)
                </h2>
                <button onclick="restoreOriginalNames()" class="bg-blue-600 text-white px-4 py-2 rounded-md text-sm hover:bg-blue-700 transition-colors">
                    <i class="fas fa-undo mr-2"></i>å…ƒã®åå‰ã«å¾©å…ƒ
                </button>
            </div>
            
            <!-- éƒ¨é–€åˆ¥ã‚¹ã‚¿ãƒƒãƒ•è¡¨ç¤º -->
            <div class="space-y-4">
                <div class="dept-section">
                    <h3 class="text-lg font-semibold text-blue-700 mb-2">OPEéƒ¨é–€ (11å)</h3>
                    <div id="ope-staff" class="grid grid-cols-2 gap-2"></div>
                </div>
                
                <div class="dept-section">
                    <h3 class="text-lg font-semibold text-green-700 mb-2">MEéƒ¨é–€ (14å)</h3>
                    <div id="me-staff" class="grid grid-cols-2 gap-2"></div>
                </div>
                
                <div class="dept-section">
                    <h3 class="text-lg font-semibold text-pink-600 mb-2">HDéƒ¨é–€ (2å)</h3>
                    <div id="hd-staff" class="grid grid-cols-2 gap-2"></div>
                </div>
                
                <div class="dept-section">
                    <h3 class="text-lg font-semibold text-yellow-600 mb-2">FLEXéƒ¨é–€ (1å)</h3>
                    <div id="flex-staff" class="grid grid-cols-1 gap-2"></div>
                </div>
            </div>
        </div>

        <!-- ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">
                <i class="fas fa-info-circle mr-2"></i>ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹
            </h2>
            
            <div class="space-y-4">
                <div class="bg-blue-50 p-4 rounded-md">
                    <h3 class="font-semibold text-blue-800">ãƒ‡ãƒ¼ã‚¿ä¿å­˜çŠ¶æ³</h3>
                    <p id="save-status" class="text-sm text-blue-600 mt-1">è‡ªå‹•ä¿å­˜æ¸ˆã¿</p>
                </div>
                
                <div class="bg-green-50 p-4 rounded-md">
                    <h3 class="font-semibold text-green-800">é€±é–“ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h3>
                    <p id="schedule-status" class="text-sm text-green-600 mt-1">æº–å‚™å®Œäº†</p>
                </div>
                
                <div class="bg-yellow-50 p-4 rounded-md">
                    <h3 class="font-semibold text-yellow-800">æ©Ÿèƒ½çŠ¶æ…‹</h3>
                    <ul id="feature-status" class="text-sm text-yellow-700 mt-2 space-y-1">
                        <li><i class="fas fa-check-circle text-green-500"></i> ã‚¹ã‚¿ãƒƒãƒ•ãƒ‡ãƒ¼ã‚¿å¾©å…ƒæ¸ˆã¿</li>
                        <li><i class="fas fa-check-circle text-green-500"></i> æ¥­å‹™ç®¡ç†æ©Ÿèƒ½ ç¨¼åƒä¸­</li>
                        <li><i class="fas fa-check-circle text-green-500"></i> ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ— æ­£å¸¸</li>
                        <li><i class="fas fa-check-circle text-green-500"></i> è¤‡æ•°åé…ç½® å¯¾å¿œæ¸ˆã¿</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆç”»é¢ -->
<div id="schedule-screen" class="screen hidden-section max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="grid grid-cols-1 xl:grid-cols-4 gap-6">
        
        <!-- ã‚¹ã‚¿ãƒƒãƒ•ãƒ—ãƒ¼ãƒ« -->
        <div class="xl:col-span-1">
            <div class="bg-white rounded-lg shadow-md p-4">
                <h2 class="text-lg font-bold text-gray-800 mb-4">
                    <i class="fas fa-users mr-2"></i>ã‚¹ã‚¿ãƒƒãƒ•ãƒ—ãƒ¼ãƒ«
                </h2>
                
                <!-- æ›œæ—¥é¸æŠ -->
                <div class="mb-4">
                    <select id="current-day-select" onchange="switchDay(this.value)" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        <option value="Mon">æœˆæ›œæ—¥</option>
                        <option value="Tue">ç«æ›œæ—¥</option>
                        <option value="Wed">æ°´æ›œæ—¥</option>
                        <option value="Thu">æœ¨æ›œæ—¥</option>
                        <option value="Fri">é‡‘æ›œæ—¥</option>
                    </select>
                </div>
                
                <!-- ã‚¹ã‚¿ãƒƒãƒ•ä¸€è¦§ -->
                <div id="staff-pool" class="space-y-2 max-h-96 overflow-y-auto">
                    <!-- ã‚¹ã‚¿ãƒƒãƒ•ã‚«ãƒ¼ãƒ‰ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                </div>
            </div>
            
            <!-- ã‚¹ã‚¿ãƒƒãƒ•çŠ¶æ…‹è¨­å®š -->
            <div class="bg-white rounded-lg shadow-md p-4 mt-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">
                    <i class="fas fa-cog mr-2"></i>ã‚¹ã‚¿ãƒƒãƒ•çŠ¶æ…‹è¨­å®š
                </h3>
                <div id="staff-status-settings"></div>
            </div>
        </div>

        <!-- æ¥­å‹™é…ç½®ã‚¨ãƒªã‚¢ -->
        <div class="xl:col-span-3">
            <div class="bg-white rounded-lg shadow-md p-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-gray-800">
                        <i class="fas fa-clipboard-list mr-2"></i>æ¥­å‹™é…ç½® - <span id="current-day-display">æœˆæ›œæ—¥</span>
                    </h2>
                    <button onclick="addBusiness()" class="bg-green-600 text-white px-4 py-2 rounded-md text-sm hover:bg-green-700 transition-colors">
                        <i class="fas fa-plus mr-2"></i>æ¥­å‹™è¿½åŠ 
                    </button>
                </div>
                
                <!-- æ¥­å‹™ã‚¹ãƒ­ãƒƒãƒˆä¸€è¦§ -->
                <div id="business-slots" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- æ¥­å‹™ã‚¹ãƒ­ãƒƒãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- é€±é…ç½®ä¸€è¦§ç”»é¢ -->
<div id="timeline-screen" class="screen hidden-section max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-bold text-gray-800 mb-6">
            <i class="fas fa-clock mr-2"></i>å€‹äººåˆ¥é€±é–“ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ (8:00-17:00)
        </h2>
        <div id="weekly-timeline" class="overflow-x-auto"></div>
    </div>
</div>

</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="business-modal" class="modal">
    <div class="modal-content">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold">æ¥­å‹™ç®¡ç†</h3>
            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form id="business-form" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700">æ¥­å‹™å</label>
                <input type="text" id="business-title" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">é–‹å§‹æ™‚é–“</label>
                    <input type="time" id="business-start-time" required class="w-full px-3 py-2 border border-gray-300 rounded-md" value="08:00">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">çµ‚äº†æ™‚é–“</label>
                    <input type="time" id="business-end-time" required class="w-full px-3 py-2 border border-gray-300 rounded-md" value="17:00">
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">å¿…è¦äººæ•°</label>
                    <input type="number" id="business-required-people" required min="1" max="10" class="w-full px-3 py-2 border border-gray-300 rounded-md" value="1">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">æ¥­å‹™åŒºåˆ†</label>
                    <select id="business-category" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        <option value="OPE">OPE</option>
                        <option value="ME">ME</option>
                        <option value="HD">HD</option>
                        <option value="ä¸æ•´è„ˆ">ä¸æ•´è„ˆ</option>
                    </select>
                </div>
            </div>
            
            <div class="flex justify-end space-x-2 pt-4">
                <button type="button" id="delete-business-btn" onclick="deleteBusiness()" class="hidden bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-colors">
                    <i class="fas fa-trash mr-2"></i>å‰Šé™¤
                </button>
                <button type="button" onclick="closeModal()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400 transition-colors">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                    <i class="fas fa-save mr-2"></i>ä¿å­˜
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// ===== ãƒ‡ãƒ¼ã‚¿å®šç¾© =====
const CORRECT_STAFF_DATA = [
    { id: 'staff_001', name: 'å®‰å­«å­æ˜åš', baseCategory: 'OPE', color: '#1E90FF' },
    { id: 'staff_002', name: 'å…«é¬ç´”', baseCategory: 'ME', color: '#00B894' },
    { id: 'staff_003', name: 'æ‰å±±é™½å­', baseCategory: 'HD', color: '#FF69B4' },
    { id: 'staff_004', name: 'ä¸­æ‘åœ­ä½‘', baseCategory: 'OPE', color: '#1E90FF' },
    { id: 'staff_005', name: 'çŸ³å±±æ™ºä¹‹', baseCategory: 'ME', color: '#00B894' },
    { id: 'staff_006', name: 'äº€äº•ç¥å“‰', baseCategory: 'OPE', color: '#1E90FF' },
    { id: 'staff_007', name: 'ä¸¸è—¤å¥', baseCategory: 'OPE', color: '#1E90FF' },
    { id: 'staff_008', name: 'ä¸‰æ˜¥æ‘©å¼¥', baseCategory: 'ME', color: '#00B894' },
    { id: 'staff_009', name: 'æ–è—¤å¤§æ¨¹', baseCategory: 'FLEX', color: '#FFD700' },
    { id: 'staff_010', name: 'ç”°ä¸­éš†æ˜­', baseCategory: 'ME', color: '#00B894' },
    { id: 'staff_011', name: 'å®‡äº•å‹‡æ°—', baseCategory: 'OPE', color: '#1E90FF' },
    { id: 'staff_012', name: 'å®‡é‡æ²¢å¾¹', baseCategory: 'OPE', color: '#1E90FF' },
    { id: 'staff_013', name: 'ä½è—¤å°†å¿—', baseCategory: 'ME', color: '#00B894' },
    { id: 'staff_014', name: 'åº„å¸ç”±ç´€', baseCategory: 'HD', color: '#FF69B4' },
    { id: 'staff_015', name: 'å°æ²¼å’Œæ¨¹', baseCategory: 'OPE', color: '#1E90FF' },
    { id: 'staff_016', name: 'æ­¦ç”°å„ªæ–—', baseCategory: 'ME', color: '#00B894' },
    { id: 'staff_017', name: 'è¨­æ¥½ä½‘ä»‹', baseCategory: 'OPE', color: '#1E90FF' },
    { id: 'staff_018', name: 'ä¼Šè—¤å¤§æ™Ÿ', baseCategory: 'ME', color: '#00B894' },
    { id: 'staff_019', name: 'ä¸Šæ¾é‡è–', baseCategory: 'ME', color: '#00B894' },
    { id: 'staff_020', name: 'ç¬¹ç”Ÿè²´ä¹‹', baseCategory: 'ME', color: '#00B894' },
    { id: 'staff_021', name: 'å’Œç”°å½©èŠ±', baseCategory: 'OPE', color: '#1E90FF' },
    { id: 'staff_022', name: 'ä¼Šè—¤å¤§ç¨€', baseCategory: 'ME', color: '#00B894' },
    { id: 'staff_023', name: 'ä½è—¤åƒå„ª', baseCategory: 'OPE', color: '#1E90FF' },
    { id: 'staff_024', name: 'æ¡‘å³¶äºœä¾', baseCategory: 'ME', color: '#00B894' },
    { id: 'staff_025', name: 'æ‘ç”°ä¸ƒæ˜Ÿ', baseCategory: 'ME', color: '#00B894' },
    { id: 'staff_026', name: 'å°æ—å°†å·±', baseCategory: 'ME', color: '#00B894' },
    { id: 'staff_027', name: 'å¯’æ²³æ±Ÿæ‚ è¼', baseCategory: 'ME', color: '#00B894' }
];

const DAYS = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'];
const DAY_NAMES = {
    'Mon': 'æœˆæ›œæ—¥',
    'Tue': 'ç«æ›œæ—¥', 
    'Wed': 'æ°´æ›œæ—¥',
    'Thu': 'æœ¨æ›œæ—¥',
    'Fri': 'é‡‘æ›œæ—¥'
};

// ===== ä¸­å¤®ã‚¹ãƒˆã‚¢ =====
window.hospitalStore = {
    staff: [...CORRECT_STAFF_DATA],
    dailyBusinesses: {
        'Mon': [], 'Tue': [], 'Wed': [], 'Thu': [], 'Fri': []
    },
    assignments: {
        'Mon': {}, 'Tue': {}, 'Wed': {}, 'Thu': {}, 'Fri': {}
    },
    dailyStaffStatus: {
        'Mon': { onCall: [], offDuty: [], compensatory: [], annualLeave: [], businessTrip: [] },
        'Tue': { onCall: [], offDuty: [], compensatory: [], annualLeave: [], businessTrip: [] },
        'Wed': { onCall: [], offDuty: [], compensatory: [], annualLeave: [], businessTrip: [] },
        'Thu': { onCall: [], offDuty: [], compensatory: [], annualLeave: [], businessTrip: [] },
        'Fri': { onCall: [], offDuty: [], compensatory: [], annualLeave: [], businessTrip: [] }
    },
    currentDay: 'Mon',
    currentBusinessId: null,
    
    saveData() {
        try {
            localStorage.setItem('hospitalScheduleData', JSON.stringify({
                staff: this.staff,
                dailyBusinesses: this.dailyBusinesses,
                assignments: this.assignments,
                dailyStaffStatus: this.dailyStaffStatus
            }));
            console.log('âœ… ãƒ‡ãƒ¼ã‚¿ä¿å­˜æˆåŠŸ');
            this.updateSaveStatus('âœ… è‡ªå‹•ä¿å­˜æ¸ˆã¿');
        } catch (error) {
            console.error('âŒ ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
            this.updateSaveStatus('âŒ ä¿å­˜ã‚¨ãƒ©ãƒ¼');
        }
    },
    
    loadData() {
        try {
            const saved = localStorage.getItem('hospitalScheduleData');
            if (saved) {
                const data = JSON.parse(saved);
                
                // ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
                if (data.staff && data.staff.length === 27) {
                    this.staff = data.staff;
                } else {
                    console.warn('âš ï¸ ã‚¹ã‚¿ãƒƒãƒ•ãƒ‡ãƒ¼ã‚¿ä¸æ•´åˆã€åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨');
                    this.staff = [...CORRECT_STAFF_DATA];
                }
                
                this.dailyBusinesses = data.dailyBusinesses || { 'Mon': [], 'Tue': [], 'Wed': [], 'Thu': [], 'Fri': [] };
                this.assignments = data.assignments || { 'Mon': {}, 'Tue': {}, 'Wed': {}, 'Thu': {}, 'Fri': {} };
                this.dailyStaffStatus = data.dailyStaffStatus || {
                    'Mon': { onCall: [], offDuty: [], compensatory: [], annualLeave: [], businessTrip: [] },
                    'Tue': { onCall: [], offDuty: [], compensatory: [], annualLeave: [], businessTrip: [] },
                    'Wed': { onCall: [], offDuty: [], compensatory: [], annualLeave: [], businessTrip: [] },
                    'Thu': { onCall: [], offDuty: [], compensatory: [], annualLeave: [], businessTrip: [] },
                    'Fri': { onCall: [], offDuty: [], compensatory: [], annualLeave: [], businessTrip: [] }
                };
                
                console.log('âœ… ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æˆåŠŸ');
                this.updateSaveStatus('âœ… ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æ¸ˆã¿');
            } else {
                console.log('â„¹ï¸ åˆæœŸãƒ‡ãƒ¼ã‚¿ã§é–‹å§‹');
                this.updateSaveStatus('â„¹ï¸ åˆæœŸçŠ¶æ…‹');
            }
        } catch (error) {
            console.error('âŒ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            this.staff = [...CORRECT_STAFF_DATA];
            this.updateSaveStatus('âŒ èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼');
        }
    },
    
    updateSaveStatus(message) {
        const statusEl = document.getElementById('save-status');
        if (statusEl) {
            statusEl.textContent = message;
        }
    }
};

// ===== ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ç®¡ç† =====
window.hospitalDragDrop = {
    instances: new Map(),
    
    initialize() {
        this.destroyAll();
        this.initializeStaffPool();
        this.initializeBusinessSlots();
        console.log('âœ… ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—åˆæœŸåŒ–å®Œäº†');
    },
    
    destroyAll() {
        this.instances.forEach(instance => {
            if (instance && typeof instance.destroy === 'function') {
                instance.destroy();
            }
        });
        this.instances.clear();
    },
    
    initializeStaffPool() {
        const staffPool = document.getElementById('staff-pool');
        if (!staffPool) return;
        
        const sortable = new Sortable(staffPool, {
            group: {
                name: 'hospital-staff',
                pull: 'clone',
                put: false
            },
            animation: 150,
            sort: false
        });
        
        this.instances.set('staff-pool', sortable);
    },
    
    initializeBusinessSlots() {
        document.querySelectorAll('.business-drop-zone').forEach(zone => {
            const businessId = zone.dataset.businessId;
            const maxCapacity = parseInt(zone.dataset.maxCapacity) || 1;
            
            if (!businessId) return;
            
            const sortable = new Sortable(zone, {
                group: {
                    name: 'hospital-staff',
                    pull: false,
                    put: (to, from, dragEl) => {
                        const currentAssignments = hospitalStore.assignments[hospitalStore.currentDay]?.[businessId] || [];
                        const staffId = dragEl.dataset.staffId;
                        
                        // å®¹é‡ãƒã‚§ãƒƒã‚¯
                        if (currentAssignments.length >= maxCapacity) {
                            this.showMessage('é…ç½®ä¸Šé™ã«é”ã—ã¦ã„ã¾ã™', 'warning');
                            return false;
                        }
                        
                        // é‡è¤‡ãƒã‚§ãƒƒã‚¯
                        if (currentAssignments.includes(staffId)) {
                            this.showMessage('æ—¢ã«é…ç½®æ¸ˆã¿ã§ã™', 'info');
                            return false;
                        }
                        
                        return true;
                    }
                },
                animation: 150,
                onAdd: (evt) => this.handleStaffAssignment(evt),
                onRemove: (evt) => this.handleStaffRemoval(evt)
            });
            
            this.instances.set(`business-${businessId}`, sortable);
        });
    },
    
    handleStaffAssignment(evt) {
        const staffId = evt.item.dataset.staffId;
        const businessId = evt.to.dataset.businessId;
        
        if (!staffId || !businessId) return;
        
        // ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã«é…ç½®æƒ…å ±ã‚’ä¿å­˜
        if (!hospitalStore.assignments[hospitalStore.currentDay]) {
            hospitalStore.assignments[hospitalStore.currentDay] = {};
        }
        if (!hospitalStore.assignments[hospitalStore.currentDay][businessId]) {
            hospitalStore.assignments[hospitalStore.currentDay][businessId] = [];
        }
        
        hospitalStore.assignments[hospitalStore.currentDay][businessId].push(staffId);
        
        // UIã‚’æ›´æ–°
        this.updateAssignmentDisplay(businessId);
        hospitalStore.saveData();
        
        this.showMessage('ã‚¹ã‚¿ãƒƒãƒ•ã‚’é…ç½®ã—ã¾ã—ãŸ', 'success');
    },
    
    handleStaffRemoval(evt) {
        const staffId = evt.item.dataset.staffId;
        const businessId = evt.from.dataset.businessId;
        
        if (!staffId || !businessId) return;
        
        // ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã‹ã‚‰é…ç½®æƒ…å ±ã‚’å‰Šé™¤
        const assignments = hospitalStore.assignments[hospitalStore.currentDay]?.[businessId] || [];
        const index = assignments.indexOf(staffId);
        if (index > -1) {
            assignments.splice(index, 1);
        }
        
        // UIã‚’æ›´æ–°
        this.updateAssignmentDisplay(businessId);
        hospitalStore.saveData();
        
        this.showMessage('ã‚¹ã‚¿ãƒƒãƒ•ã®é…ç½®ã‚’è§£é™¤ã—ã¾ã—ãŸ', 'info');
    },
    
    updateAssignmentDisplay(businessId) {
        const zone = document.querySelector(`[data-business-id="${businessId}"]`);
        if (!zone) return;
        
        const assignments = hospitalStore.assignments[hospitalStore.currentDay]?.[businessId] || [];
        const maxCapacity = parseInt(zone.dataset.maxCapacity) || 1;
        
        // é…ç½®äººæ•°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã®æ›´æ–°
        const counter = zone.querySelector('.assignment-counter');
        if (counter) {
            counter.textContent = `${assignments.length}/${maxCapacity}`;
            counter.style.display = assignments.length > 0 ? 'flex' : 'none';
        }
        
        // ã‚¹ãƒ­ãƒƒãƒˆã®è¦‹ãŸç›®æ›´æ–°
        if (assignments.length > 0) {
            zone.classList.add('has-assignment');
        } else {
            zone.classList.remove('has-assignment');
        }
    },
    
    showMessage(message, type = 'info') {
        const colors = {
            success: 'bg-green-500',
            warning: 'bg-yellow-500', 
            error: 'bg-red-500',
            info: 'bg-blue-500'
        };
        
        const messageEl = document.createElement('div');
        messageEl.className = `fixed top-4 right-4 ${colors[type]} text-white px-4 py-2 rounded-md shadow-lg z-50 transition-all duration-300`;
        messageEl.textContent = message;
        
        document.body.appendChild(messageEl);
        
        setTimeout(() => {
            messageEl.style.opacity = '0';
            messageEl.style.transform = 'translateX(100%)';
            setTimeout(() => {
                if (messageEl.parentNode) {
                    messageEl.parentNode.removeChild(messageEl);
                }
            }, 300);
        }, 3000);
    }
};

// ===== èªè¨¼æ©Ÿèƒ½ =====
function checkPassword() {
    const password = document.getElementById('password-input').value;
    const errorEl = document.getElementById('password-error');
    
    if (password === 'me5711me') {
        document.getElementById('password-screen').style.display = 'none';
        document.getElementById('main-app').classList.remove('hidden');
        initializeApp();
    } else {
        errorEl.classList.remove('hidden');
        document.getElementById('password-input').value = '';
    }
}

// ===== ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ– =====
function initializeApp() {
    console.log('ğŸš€ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–é–‹å§‹');
    
    // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    hospitalStore.loadData();
    
    // åˆæœŸç”»é¢è¡¨ç¤º
    showScreen('home');
    
    // UIåˆæœŸåŒ–
    renderHomeScreen();
    renderScheduleScreen();
    renderTimelineScreen();
    
    console.log('âœ… ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–å®Œäº†');
}

// ===== ç”»é¢åˆ‡ã‚Šæ›¿ãˆ =====
function showScreen(screenName) {
    // å…¨ç”»é¢ã‚’éè¡¨ç¤º
    document.querySelectorAll('.screen').forEach(screen => {
        screen.classList.add('hidden-section');
    });
    
    // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
    document.querySelectorAll('.nav-btn').forEach(btn => {
        if (btn.dataset.screen === screenName) {
            btn.classList.add('bg-blue-600', 'text-white');
            btn.classList.remove('text-gray-500', 'hover:text-gray-700');
        } else {
            btn.classList.remove('bg-blue-600', 'text-white');
            btn.classList.add('text-gray-500', 'hover:text-gray-700');
        }
    });
    
    // é¸æŠã•ã‚ŒãŸç”»é¢ã‚’è¡¨ç¤º
    const targetScreen = document.getElementById(`${screenName}-screen`);
    if (targetScreen) {
        targetScreen.classList.remove('hidden-section');
    }
    
    // ç”»é¢å›ºæœ‰ã®åˆæœŸåŒ–
    switch (screenName) {
        case 'home':
            renderHomeScreen();
            break;
        case 'schedule':
            renderScheduleScreen();
            hospitalDragDrop.initialize();
            break;
        case 'timeline':
            renderTimelineScreen();
            break;
    }
}

// ===== HOMEç”»é¢ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° =====
function renderHomeScreen() {
    const departments = {
        'OPE': { container: 'ope-staff', staff: [] },
        'ME': { container: 'me-staff', staff: [] },
        'HD': { container: 'hd-staff', staff: [] },
        'FLEX': { container: 'flex-staff', staff: [] }
    };
    
    // ã‚¹ã‚¿ãƒƒãƒ•ã‚’éƒ¨é–€åˆ¥ã«åˆ†é¡
    hospitalStore.staff.forEach(staff => {
        if (departments[staff.baseCategory]) {
            departments[staff.baseCategory].staff.push(staff);
        }
    });
    
    // å„éƒ¨é–€ã®ã‚¹ã‚¿ãƒƒãƒ•ã‚’è¡¨ç¤º
    Object.keys(departments).forEach(dept => {
        const container = document.getElementById(departments[dept].container);
        if (!container) return;
        
        container.innerHTML = departments[dept].staff.map(staff => `
            <div class="bg-gray-50 p-3 rounded-md border">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-bold" 
                             style="background-color: ${staff.color}">
                            ${staff.name.charAt(0)}
                        </div>
                        <div class="ml-3">
                            <div class="editable font-medium" onclick="editStaffName('${staff.id}')" data-staff-id="${staff.id}">
                                ${staff.name}
                            </div>
                            <div class="text-xs text-gray-600">${staff.baseCategory}</div>
                        </div>
                    </div>
                    <select onchange="changeStaffCategory('${staff.id}', this.value)" 
                            class="text-xs border rounded px-2 py-1">
                        <option value="OPE" ${staff.baseCategory === 'OPE' ? 'selected' : ''}>OPE</option>
                        <option value="ME" ${staff.baseCategory === 'ME' ? 'selected' : ''}>ME</option>
                        <option value="HD" ${staff.baseCategory === 'HD' ? 'selected' : ''}>HD</option>
                        <option value="FLEX" ${staff.baseCategory === 'FLEX' ? 'selected' : ''}>FLEX</option>
                    </select>
                </div>
            </div>
        `).join('');
    });
}

// ===== ã‚¹ã‚¿ãƒƒãƒ•åç·¨é›†æ©Ÿèƒ½ =====
function editStaffName(staffId) {
    const staff = hospitalStore.staff.find(s => s.id === staffId);
    if (!staff) return;
    
    const element = document.querySelector(`.editable[data-staff-id="${staffId}"]`);
    if (!element) return;
    
    const originalName = staff.name;
    
    element.classList.add('editing');
    element.contentEditable = true;
    element.focus();
    
    const range = document.createRange();
    range.selectNodeContents(element);
    const selection = window.getSelection();
    selection.removeAllRanges();
    selection.addRange(range);
    
    const saveEdit = () => {
        const newName = element.textContent.trim();
        if (newName && newName !== originalName) {
            staff.name = newName;
            hospitalStore.saveData();
            renderHomeScreen(); // å…¨ä½“ã‚’å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            hospitalDragDrop.showMessage('åå‰ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
        } else {
            element.textContent = originalName;
        }
        
        element.classList.remove('editing');
        element.contentEditable = false;
    };
    
    element.addEventListener('blur', saveEdit, { once: true });
    element.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            element.blur();
        } else if (e.key === 'Escape') {
            element.textContent = originalName;
            element.blur();
        }
    }, { once: true });
}

// ===== ã‚¹ã‚¿ãƒƒãƒ•åŒºåˆ†å¤‰æ›´ =====
function changeStaffCategory(staffId, newCategory) {
    const staff = hospitalStore.staff.find(s => s.id === staffId);
    if (!staff) return;
    
    const colorMap = {
        'OPE': '#1E90FF',
        'ME': '#00B894', 
        'HD': '#FF69B4',
        'FLEX': '#FFD700'
    };
    
    staff.baseCategory = newCategory;
    staff.color = colorMap[newCategory];
    
    hospitalStore.saveData();
    renderHomeScreen();
    hospitalDragDrop.showMessage(`${staff.name}ã®åŒºåˆ†ã‚’${newCategory}ã«å¤‰æ›´ã—ã¾ã—ãŸ`, 'success');
}

// ===== å…ƒã®åå‰ã«å¾©å…ƒ =====
function restoreOriginalNames() {
    if (confirm('å…¨ã‚¹ã‚¿ãƒƒãƒ•ã®åå‰ã‚’å…ƒã®åå‰ã«å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ')) {
        hospitalStore.staff.forEach((staff, index) => {
            if (CORRECT_STAFF_DATA[index]) {
                staff.name = CORRECT_STAFF_DATA[index].name;
                staff.baseCategory = CORRECT_STAFF_DATA[index].baseCategory;
                staff.color = CORRECT_STAFF_DATA[index].color;
            }
        });
        
        hospitalStore.saveData();
        renderHomeScreen();
        hospitalDragDrop.showMessage('å…¨ã‚¹ã‚¿ãƒƒãƒ•ã®åå‰ã‚’å¾©å…ƒã—ã¾ã—ãŸ', 'success');
    }
}

// ===== ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç”»é¢ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° =====
function renderScheduleScreen() {
    renderStaffPool();
    renderStaffStatusSettings();
    renderBusinessSlots();
}

function renderStaffPool() {
    const currentDay = hospitalStore.currentDay;
    const availableStaff = getAvailableStaffForDay(currentDay);
    
    const staffPoolHTML = availableStaff.map(staff => {
        const status = getStaffStatusForDay(staff.id, currentDay);
        const isOnCall = status === 'onCall';
        
        return `
            <div class="staff-card ${isOnCall ? 'on-call' : ''}" 
                 data-staff-id="${staff.id}"
                 style="background-color: ${staff.color}; color: ${getReadableTextColor(staff.color)};">
                <span class="staff-name text-sm font-medium">${staff.name}</span>
                <span class="staff-category text-xs">${staff.baseCategory}</span>
                ${isOnCall ? '<span class="on-call-badge">ğŸŒ™å½“ç›´</span>' : ''}
            </div>
        `;
    }).join('');
    
    const staffPool = document.getElementById('staff-pool');
    if (staffPool) {
        staffPool.innerHTML = staffPoolHTML;
    }
}

function renderStaffStatusSettings() {
    const container = document.getElementById('staff-status-settings');
    if (!container) return;
    
    container.innerHTML = `
        <div class="status-tabs flex flex-wrap mb-4">
            ${DAYS.map((day, index) => `
                <button class="status-tab text-xs ${index === 0 ? 'active' : ''}" 
                        onclick="switchStatusDay('${day}')" 
                        data-day="${day}">
                    ${DAY_NAMES[day]}
                </button>
            `).join('')}
        </div>
        
        <div class="status-content">
            ${DAYS.map((day, index) => `
                <div class="status-day-panel ${index === 0 ? 'active' : ''}" id="status-${day}">
                    <div class="space-y-4">
                        <div class="status-group">
                            <h4 class="text-sm font-semibold text-gray-700 mb-2">ğŸŒ™ å½“ç›´</h4>
                            <select id="onCall-select-${day}" onchange="updateStaffStatus('${day}', 'onCall', this.value)" 
                                    class="w-full text-xs px-2 py-1 border border-gray-300 rounded">
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                ${hospitalStore.staff.map(staff => `
                                    <option value="${staff.id}" ${hospitalStore.dailyStaffStatus[day].onCall.includes(staff.id) ? 'selected' : ''}>
                                        ${staff.name} (${staff.baseCategory})
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div class="status-group">
                            <h4 class="text-sm font-semibold text-gray-700 mb-2">ğŸ  éç•ª</h4>
                            <select id="offDuty-select-${day}" onchange="updateStaffStatus('${day}', 'offDuty', this.value)"
                                    class="w-full text-xs px-2 py-1 border border-gray-300 rounded">
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                ${hospitalStore.staff.map(staff => `
                                    <option value="${staff.id}" ${hospitalStore.dailyStaffStatus[day].offDuty.includes(staff.id) ? 'selected' : ''}>
                                        ${staff.name} (${staff.baseCategory})
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div class="status-group">
                            <h4 class="text-sm font-semibold text-gray-700 mb-2">ğŸ“… ä»£ä¼‘</h4>
                            <div class="space-y-1 max-h-32 overflow-y-auto">
                                ${hospitalStore.staff.map(staff => `
                                    <label class="flex items-center text-xs">
                                        <input type="checkbox" value="${staff.id}" 
                                               ${hospitalStore.dailyStaffStatus[day].compensatory.includes(staff.id) ? 'checked' : ''}
                                               onchange="updateMultiStaffStatus('${day}', 'compensatory')" 
                                               class="mr-2">
                                        ${staff.name} (${staff.baseCategory})
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

function renderBusinessSlots() {
    const currentDay = hospitalStore.currentDay;
    const businesses = hospitalStore.dailyBusinesses[currentDay] || [];
    
    const businessSlotsHTML = businesses.map(business => {
        const assignments = hospitalStore.assignments[currentDay]?.[business.id] || [];
        
        return `
            <div class="business-slot bg-white border-2 border-dashed border-gray-300 rounded-lg p-4 relative"
                 data-business-id="${business.id}" 
                 data-max-capacity="${business.requiredPeople}">
                
                <div class="business-header mb-3">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-medium text-gray-800 cursor-pointer hover:text-blue-600" 
                                onclick="editBusiness('${business.id}')">
                                ${business.title}
                            </h3>
                            <p class="text-xs text-gray-600">
                                ${business.startTime} - ${business.endTime} | 
                                ${business.category} | 
                                ${business.requiredPeople}å
                            </p>
                        </div>
                        <div class="text-right">
                            <button onclick="editBusiness('${business.id}')" 
                                    class="text-blue-600 hover:text-blue-800 text-xs">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="business-drop-zone min-h-16 bg-gray-50 border border-gray-200 rounded p-2" 
                     data-business-id="${business.id}" 
                     data-max-capacity="${business.requiredPeople}">
                    ${assignments.map(staffId => {
                        const staff = hospitalStore.staff.find(s => s.id === staffId);
                        return staff ? `
                            <div class="staff-card assigned-staff mb-2" 
                                 data-staff-id="${staff.id}"
                                 style="background-color: ${staff.color}; color: ${getReadableTextColor(staff.color)};">
                                <span class="staff-name text-sm">${staff.name}</span>
                                <button onclick="removeStaffAssignment('${business.id}', '${staff.id}')" 
                                        class="ml-2 text-xs opacity-75 hover:opacity-100">âœ•</button>
                            </div>
                        ` : '';
                    }).join('')}
                    ${assignments.length === 0 ? '<div class="text-gray-400 text-center text-sm">ã‚¹ã‚¿ãƒƒãƒ•ã‚’ãƒ‰ãƒ©ãƒƒã‚°</div>' : ''}
                </div>
                
                <div class="assignment-counter ${assignments.length > 0 ? '' : 'hidden'}">${assignments.length}/${business.requiredPeople}</div>
            </div>
        `;
    }).join('');
    
    const container = document.getElementById('business-slots');
    if (container) {
        container.innerHTML = businessSlotsHTML;
        
        if (businesses.length === 0) {
            container.innerHTML = `
                <div class="col-span-full text-center py-8 text-gray-500">
                    <i class="fas fa-plus-circle text-4xl mb-4"></i>
                    <p>ã€Œæ¥­å‹™è¿½åŠ ã€ãƒœã‚¿ãƒ³ã§æ–°ã—ã„æ¥­å‹™ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</p>
                </div>
            `;
        }
    }
    
    // ç¾åœ¨ã®æ›œæ—¥è¡¨ç¤ºã‚’æ›´æ–°
    const dayDisplay = document.getElementById('current-day-display');
    if (dayDisplay) {
        dayDisplay.textContent = DAY_NAMES[currentDay];
    }
    
    const daySelect = document.getElementById('current-day-select');
    if (daySelect) {
        daySelect.value = currentDay;
    }
}

// ===== ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ç”»é¢ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° =====
function renderTimelineScreen() {
    const timeSlots = generateTimeSlots('08:00', '17:00', 60);
    
    const timelineHTML = `
        <div class="timeline-container overflow-x-auto">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="timeline-header bg-gray-100 border-b-2 border-gray-300 sticky top-0">
                <div class="flex">
                    <div class="w-32 flex-shrink-0 p-2 font-semibold border-r">ã‚¹ã‚¿ãƒƒãƒ•</div>
                    ${DAYS.map(day => `
                        <div class="flex-1 min-w-96 border-r">
                            <div class="text-center p-2 font-semibold border-b">
                                ${DAY_NAMES[day]}
                            </div>
                            <div class="flex">
                                ${timeSlots.map(time => `
                                    <div class="w-10 text-xs text-center p-1 border-r">
                                        ${time.substring(0, 2)}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
            
            <!-- ã‚¹ã‚¿ãƒƒãƒ•ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ -->
            <div class="timeline-body">
                ${hospitalStore.staff.map(staff => `
                    <div class="flex border-b hover:bg-gray-50">
                        <div class="w-32 flex-shrink-0 p-2 border-r flex items-center">
                            <div class="w-6 h-6 rounded-full flex items-center justify-center text-white text-xs font-bold mr-2" 
                                 style="background-color: ${staff.color}">
                                ${staff.name.charAt(0)}
                            </div>
                            <div>
                                <div class="text-sm font-medium">${staff.name}</div>
                                <div class="text-xs text-gray-600">${staff.baseCategory}</div>
                            </div>
                        </div>
                        
                        ${DAYS.map(day => `
                            <div class="flex-1 min-w-96 border-r flex">
                                ${timeSlots.map(time => {
                                    const assignment = getStaffAssignmentAtTime(staff.id, day, time);
                                    const status = getStaffDayStatus(staff.id, day);
                                    const timeSlotClass = getTimeSlotClass(assignment, status);
                                    
                                    return `
                                        <div class="time-slot ${timeSlotClass}"
                                             title="${getTimeSlotTooltip(staff, day, time, assignment, status)}"
                                             style="${assignment ? getAssignmentStyle(assignment) : ''}">
                                            ${assignment ? assignment.businessTitle.substring(0, 2) : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `).join('')}
                    </div>
                `).join('')}
            </div>
        </div>
    `;
    
    const container = document.getElementById('weekly-timeline');
    if (container) {
        container.innerHTML = timelineHTML;
    }
}

// ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° =====
function getAvailableStaffForDay(day) {
    return hospitalStore.staff.filter(staff => {
        const status = hospitalStore.dailyStaffStatus[day];
        return !status.offDuty.includes(staff.id) && 
               !status.compensatory.includes(staff.id) && 
               !status.annualLeave.includes(staff.id) && 
               !status.businessTrip.includes(staff.id);
    });
}

function getStaffStatusForDay(staffId, day) {
    const status = hospitalStore.dailyStaffStatus[day];
    if (status.onCall.includes(staffId)) return 'onCall';
    if (status.offDuty.includes(staffId)) return 'offDuty';
    if (status.compensatory.includes(staffId)) return 'compensatory';
    if (status.annualLeave.includes(staffId)) return 'annualLeave';
    if (status.businessTrip.includes(staffId)) return 'businessTrip';
    return 'normal';
}

function getStaffDayStatus(staffId, day) {
    return getStaffStatusForDay(staffId, day);
}

function getReadableTextColor(backgroundColor) {
    const rgb = hexToRgb(backgroundColor);
    const brightness = (rgb.r * 299 + rgb.g * 587 + rgb.b * 114) / 1000;
    return brightness > 128 ? '#000000' : '#FFFFFF';
}

function hexToRgb(hex) {
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
    } : null;
}

function generateTimeSlots(startTime, endTime, intervalMinutes) {
    const slots = [];
    const start = parseTime(startTime);
    const end = parseTime(endTime);
    
    for (let current = start; current < end; current += intervalMinutes) {
        slots.push(formatTime(current));
    }
    
    return slots;
}

function parseTime(timeString) {
    const [hours, minutes] = timeString.split(':').map(Number);
    return hours * 60 + minutes;
}

function formatTime(minutes) {
    const hours = Math.floor(minutes / 60).toString().padStart(2, '0');
    const mins = (minutes % 60).toString().padStart(2, '0');
    return `${hours}:${mins}`;
}

function getStaffAssignmentAtTime(staffId, day, time) {
    const businesses = hospitalStore.dailyBusinesses[day] || [];
    const assignments = hospitalStore.assignments[day] || {};
    
    for (const business of businesses) {
        if (assignments[business.id] && assignments[business.id].includes(staffId)) {
            const startMinutes = parseTime(business.startTime);
            const endMinutes = parseTime(business.endTime);
            const currentMinutes = parseTime(time);
            
            if (currentMinutes >= startMinutes && currentMinutes < endMinutes) {
                return {
                    businessId: business.id,
                    businessTitle: business.title,
                    businessCategory: business.category
                };
            }
        }
    }
    return null;
}

function getTimeSlotClass(assignment, status) {
    let classes = [];
    if (assignment) classes.push('assigned');
    if (status !== 'normal') classes.push(`status-${status}`);
    return classes.join(' ');
}

function getAssignmentStyle(assignment) {
    const categoryColors = {
        'OPE': '#1E90FF',
        'ME': '#00B894',
        'HD': '#FF69B4',
        'ä¸æ•´è„ˆ': '#8E44AD'
    };
    
    const bgColor = categoryColors[assignment.businessCategory] || '#6B7280';
    return `background-color: ${bgColor}; color: white;`;
}

function getTimeSlotTooltip(staff, day, time, assignment, status) {
    let tooltip = `${staff.name} - ${DAY_NAMES[day]} ${time}`;
    
    if (assignment) {
        tooltip += `\næ¥­å‹™: ${assignment.businessTitle}`;
    }
    
    const statusNames = {
        'onCall': 'å½“ç›´',
        'offDuty': 'éç•ª',
        'compensatory': 'ä»£ä¼‘',
        'annualLeave': 'å¹´ä¼‘',
        'businessTrip': 'å‡ºå¼µ'
    };
    
    if (status !== 'normal') {
        tooltip += `\nçŠ¶æ…‹: ${statusNames[status]}`;
    }
    
    return tooltip;
}

// ===== æ›œæ—¥ãƒ»çŠ¶æ…‹ç®¡ç† =====
function switchDay(day) {
    hospitalStore.currentDay = day;
    renderStaffPool();
    renderBusinessSlots();
    hospitalDragDrop.initialize();
}

function switchStatusDay(day) {
    // ã‚¿ãƒ–ã®çŠ¶æ…‹ã‚’æ›´æ–°
    document.querySelectorAll('.status-tab').forEach(tab => {
        if (tab.dataset.day === day) {
            tab.classList.add('active');
        } else {
            tab.classList.remove('active');
        }
    });
    
    // ãƒ‘ãƒãƒ«ã®çŠ¶æ…‹ã‚’æ›´æ–°
    document.querySelectorAll('.status-day-panel').forEach(panel => {
        if (panel.id === `status-${day}`) {
            panel.classList.add('active');
        } else {
            panel.classList.remove('active');
        }
    });
}

function updateStaffStatus(day, statusType, staffId) {
    if (!staffId) return;
    
    // æ—¢å­˜ã®çŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢ï¼ˆå˜ä¸€é¸æŠã®å ´åˆï¼‰
    if (statusType === 'onCall' || statusType === 'offDuty') {
        hospitalStore.dailyStaffStatus[day][statusType] = [staffId];
    }
    
    hospitalStore.saveData();
    renderStaffPool();
    hospitalDragDrop.showMessage(`${DAY_NAMES[day]}ã®${statusType}ã‚’è¨­å®šã—ã¾ã—ãŸ`, 'success');
}

function updateMultiStaffStatus(day, statusType) {
    const checkboxes = document.querySelectorAll(`#status-${day} input[type="checkbox"]`);
    const selectedStaff = Array.from(checkboxes)
        .filter(cb => cb.checked)
        .map(cb => cb.value);
    
    hospitalStore.dailyStaffStatus[day][statusType] = selectedStaff;
    hospitalStore.saveData();
    renderStaffPool();
}

// ===== æ¥­å‹™ç®¡ç† =====
function addBusiness() {
    hospitalStore.currentBusinessId = null;
    
    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
    document.getElementById('business-title').value = '';
    document.getElementById('business-start-time').value = '08:00';
    document.getElementById('business-end-time').value = '17:00';
    document.getElementById('business-required-people').value = '1';
    document.getElementById('business-category').value = 'OPE';
    
    // å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
    document.getElementById('delete-business-btn').classList.add('hidden');
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    document.getElementById('business-modal').classList.add('active');
}

function editBusiness(businessId) {
    const business = hospitalStore.dailyBusinesses[hospitalStore.currentDay]?.find(b => b.id === businessId);
    if (!business) return;
    
    hospitalStore.currentBusinessId = businessId;
    
    // ãƒ•ã‚©ãƒ¼ãƒ ã«æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
    document.getElementById('business-title').value = business.title;
    document.getElementById('business-start-time').value = business.startTime;
    document.getElementById('business-end-time').value = business.endTime;
    document.getElementById('business-required-people').value = business.requiredPeople;
    document.getElementById('business-category').value = business.category;
    
    // å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
    document.getElementById('delete-business-btn').classList.remove('hidden');
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    document.getElementById('business-modal').classList.add('active');
}

function deleteBusiness() {
    if (!hospitalStore.currentBusinessId) return;
    
    if (confirm('ã“ã®æ¥­å‹™ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿé…ç½®ã•ã‚ŒãŸã‚¹ã‚¿ãƒƒãƒ•ã‚‚è‡ªå‹•çš„ã«è§£é™¤ã•ã‚Œã¾ã™ã€‚')) {
        const currentDay = hospitalStore.currentDay;
        
        // æ¥­å‹™ã‚’å‰Šé™¤
        hospitalStore.dailyBusinesses[currentDay] = hospitalStore.dailyBusinesses[currentDay]
            .filter(b => b.id !== hospitalStore.currentBusinessId);
        
        // é…ç½®æƒ…å ±ã‚‚å‰Šé™¤
        delete hospitalStore.assignments[currentDay][hospitalStore.currentBusinessId];
        
        hospitalStore.saveData();
        closeModal();
        renderBusinessSlots();
        hospitalDragDrop.initialize();
        
        hospitalDragDrop.showMessage('æ¥­å‹™ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
    }
}

function closeModal() {
    document.getElementById('business-modal').classList.remove('active');
    hospitalStore.currentBusinessId = null;
}

function removeStaffAssignment(businessId, staffId) {
    const assignments = hospitalStore.assignments[hospitalStore.currentDay]?.[businessId] || [];
    const index = assignments.indexOf(staffId);
    
    if (index > -1) {
        assignments.splice(index, 1);
        hospitalStore.saveData();
        renderBusinessSlots();
        hospitalDragDrop.initialize();
        hospitalDragDrop.showMessage('ã‚¹ã‚¿ãƒƒãƒ•ã®é…ç½®ã‚’è§£é™¤ã—ã¾ã—ãŸ', 'info');
    }
}

// ===== PDFå‡ºåŠ› =====
function exportToPDF() {
    hospitalDragDrop.showMessage('ãƒ–ãƒ©ã‚¦ã‚¶ã®å°åˆ·æ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ã¦PDFå‡ºåŠ›ã—ã¦ãã ã•ã„', 'info');
    window.print();
}

// ===== ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ =====
document.addEventListener('DOMContentLoaded', () => {
    // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ã§Enterã‚­ãƒ¼å¯¾å¿œ
    document.getElementById('password-input').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            checkPassword();
        }
    });
    
    // æ¥­å‹™ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
    document.getElementById('business-form').addEventListener('submit', (e) => {
        e.preventDefault();
        
        const businessData = {
            id: hospitalStore.currentBusinessId || `business_${Date.now()}`,
            title: document.getElementById('business-title').value,
            startTime: document.getElementById('business-start-time').value,
            endTime: document.getElementById('business-end-time').value,
            requiredPeople: parseInt(document.getElementById('business-required-people').value),
            category: document.getElementById('business-category').value
        };
        
        const currentDay = hospitalStore.currentDay;
        
        if (hospitalStore.currentBusinessId) {
            // ç·¨é›†
            const index = hospitalStore.dailyBusinesses[currentDay].findIndex(b => b.id === hospitalStore.currentBusinessId);
            if (index > -1) {
                hospitalStore.dailyBusinesses[currentDay][index] = businessData;
            }
        } else {
            // æ–°è¦è¿½åŠ 
            if (!hospitalStore.dailyBusinesses[currentDay]) {
                hospitalStore.dailyBusinesses[currentDay] = [];
            }
            hospitalStore.dailyBusinesses[currentDay].push(businessData);
        }
        
        hospitalStore.saveData();
        closeModal();
        renderBusinessSlots();
        hospitalDragDrop.initialize();
        
        hospitalDragDrop.showMessage('æ¥­å‹™ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
    });
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    document.getElementById('business-modal').addEventListener('click', (e) => {
        if (e.target === document.getElementById('business-modal')) {
            closeModal();
        }
    });
    
    // ESCã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closeModal();
        }
    });
});

// åˆæœŸåŒ–
console.log('ğŸ¥ æ¥­å‹™é…ç½®èª¿æ•´ã‚·ã‚¹ãƒ†ãƒ èª­ã¿è¾¼ã¿å®Œäº†');
</script>

</body>
</html>
