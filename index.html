<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>業務配置調整システム</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        .staff-card {
            transition: all 0.3s ease;
            cursor: grab;
            border-radius: 8px;
            padding: 8px;
            margin: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 60px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .staff-card:active {
            cursor: grabbing;
        }
        .staff-card.sortable-chosen {
            transform: rotate(5deg);
            opacity: 0.8;
        }
        .staff-card.sortable-drag {
            transform: rotate(0deg);
            opacity: 1;
        }
        .business-slot {
            min-height: 80px;
            border: 2px dashed #e5e7eb;
            border-radius: 8px;
            transition: all 0.3s ease;
            position: relative;
        }
        .business-slot.sortable-drag-over {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .business-slot.has-assignment {
            border-style: solid;
            border-color: #10b981;
        }
        .on-call-badge {
            font-size: 10px;
            background: #fbbf24;
            color: #1f2937;
            padding: 2px 4px;
            border-radius: 4px;
            margin-top: 2px;
        }
        .timeline-header {
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
            border-bottom: 2px solid #e5e7eb;
        }
        .time-slot {
            width: 40px;
            height: 30px;
            border: 1px solid #e5e7eb;
            display: inline-block;
            text-align: center;
            line-height: 28px;
            font-size: 10px;
            position: relative;
        }
        .time-slot.assigned {
            background-color: #dbeafe;
            color: #1e40af;
            font-weight: bold;
        }
        .time-slot.status-onCall {
            background-color: #fef3c7;
            color: #92400e;
        }
        .time-slot.status-offDuty {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .status-tab {
            padding: 8px 16px;
            margin: 2px;
            border: 2px solid #e5e7eb;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        .status-tab.active {
            border-color: #3b82f6;
            background-color: #eff6ff;
            color: #1e40af;
        }
        .status-day-panel {
            display: none;
        }
        .status-day-panel.active {
            display: block;
        }
        .assignment-counter {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }
        .business-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 8px;
            margin: 4px 0;
            cursor: pointer;
        }
        .business-card:hover {
            background: #f1f5f9;
        }
        .hidden-section {
            display: none;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .editable {
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 3px;
            transition: background-color 0.2s;
        }
        .editable:hover {
            background-color: #f3f4f6;
        }
        .editable.editing {
            background-color: #fef3c7;
            outline: 2px solid #f59e0b;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">

<!-- パスワード認証画面 -->
<div id="password-screen" class="fixed inset-0 bg-gray-900 flex items-center justify-center z-50">
    <div class="bg-white p-8 rounded-lg shadow-xl max-w-md w-full mx-4">
        <div class="text-center mb-6">
            <i class="fas fa-lock text-4xl text-blue-600 mb-4"></i>
            <h1 class="text-2xl font-bold text-gray-800">業務配置調整システム</h1>
            <p class="text-gray-600 mt-2">臨床工学部 週次人員調整</p>
        </div>
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">パスワード</label>
            <input type="password" id="password-input" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="パスワードを入力">
            <p class="text-xs text-gray-500 mt-1">ヒント: me(OPE内線)me</p>
        </div>
        <button onclick="checkPassword()" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition duration-200">
            <i class="fas fa-sign-in-alt mr-2"></i>ログイン
        </button>
        <div id="password-error" class="text-red-600 text-sm mt-2 hidden">パスワードが正しくありません</div>
    </div>
</div>

<!-- メインアプリケーション -->
<div id="main-app" class="hidden">

<!-- ナビゲーションヘッダー -->
<nav class="bg-white shadow-sm border-b-2 border-blue-200 mb-6">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16">
            <div class="flex items-center">
                <h1 class="text-xl font-bold text-gray-900">業務配置調整システム</h1>
                <span class="ml-4 text-sm text-gray-600">臨床工学部 週次人員調整</span>
            </div>
            <div class="flex items-center space-x-4">
                <button onclick="showScreen('home')" class="nav-btn px-4 py-2 rounded-md text-sm font-medium transition-colors" data-screen="home">
                    <i class="fas fa-home mr-2"></i>HOME
                </button>
                <button onclick="showScreen('schedule')" class="nav-btn px-4 py-2 rounded-md text-sm font-medium transition-colors" data-screen="schedule">
                    <i class="fas fa-calendar-alt mr-2"></i>スケジュール作成
                </button>
                <button onclick="showScreen('timeline')" class="nav-btn px-4 py-2 rounded-md text-sm font-medium transition-colors" data-screen="timeline">
                    <i class="fas fa-clock mr-2"></i>週配置一覧
                </button>
                <button onclick="exportToPDF()" class="bg-green-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-green-700 transition-colors">
                    <i class="fas fa-file-pdf mr-2"></i>PDF出力
                </button>
            </div>
        </div>
    </div>
</nav>

<!-- HOME画面 -->
<div id="home-screen" class="screen max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        
        <!-- スタッフ管理 -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">
                    <i class="fas fa-users mr-2"></i>スタッフ管理 (27名)
                </h2>
                <button onclick="restoreOriginalNames()" class="bg-blue-600 text-white px-4 py-2 rounded-md text-sm hover:bg-blue-700 transition-colors">
                    <i class="fas fa-undo mr-2"></i>元の名前に復元
                </button>
            </div>
            
            <!-- 部門別スタッフ表示 -->
            <div class="space-y-4">
                <div class="dept-section">
                    <h3 class="text-lg font-semibold text-blue-700 mb-2">OPE部門 (11名)</h3>
                    <div id="ope-staff" class="grid grid-cols-2 gap-2"></div>
                </div>
                
                <div class="dept-section">
                    <h3 class="text-lg font-semibold text-green-700 mb-2">ME部門 (14名)</h3>
                    <div id="me-staff" class="grid grid-cols-2 gap-2"></div>
                </div>
                
                <div class="dept-section">
                    <h3 class="text-lg font-semibold text-pink-600 mb-2">HD部門 (2名)</h3>
                    <div id="hd-staff" class="grid grid-cols-2 gap-2"></div>
                </div>
                
                <div class="dept-section">
                    <h3 class="text-lg font-semibold text-yellow-600 mb-2">FLEX部門 (1名)</h3>
                    <div id="flex-staff" class="grid grid-cols-1 gap-2"></div>
                </div>
            </div>
        </div>

        <!-- システム状態 -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">
                <i class="fas fa-info-circle mr-2"></i>システム状態
            </h2>
            
            <div class="space-y-4">
                <div class="bg-blue-50 p-4 rounded-md">
                    <h3 class="font-semibold text-blue-800">データ保存状況</h3>
                    <p id="save-status" class="text-sm text-blue-600 mt-1">自動保存済み</p>
                </div>
                
                <div class="bg-green-50 p-4 rounded-md">
                    <h3 class="font-semibold text-green-800">週間スケジュール</h3>
                    <p id="schedule-status" class="text-sm text-green-600 mt-1">準備完了</p>
                </div>
                
                <div class="bg-yellow-50 p-4 rounded-md">
                    <h3 class="font-semibold text-yellow-800">機能状態</h3>
                    <ul id="feature-status" class="text-sm text-yellow-700 mt-2 space-y-1">
                        <li><i class="fas fa-check-circle text-green-500"></i> スタッフデータ復元済み</li>
                        <li><i class="fas fa-check-circle text-green-500"></i> 業務管理機能 稼働中</li>
                        <li><i class="fas fa-check-circle text-green-500"></i> ドラッグ&ドロップ 正常</li>
                        <li><i class="fas fa-check-circle text-green-500"></i> 複数名配置 対応済み</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- スケジュール作成画面 -->
<div id="schedule-screen" class="screen hidden-section max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="grid grid-cols-1 xl:grid-cols-4 gap-6">
        
        <!-- スタッフプール -->
        <div class="xl:col-span-1">
            <div class="bg-white rounded-lg shadow-md p-4">
                <h2 class="text-lg font-bold text-gray-800 mb-4">
                    <i class="fas fa-users mr-2"></i>スタッフプール
                </h2>
                
                <!-- 曜日選択 -->
                <div class="mb-4">
                    <select id="current-day-select" onchange="switchDay(this.value)" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        <option value="Mon">月曜日</option>
                        <option value="Tue">火曜日</option>
                        <option value="Wed">水曜日</option>
                        <option value="Thu">木曜日</option>
                        <option value="Fri">金曜日</option>
                    </select>
                </div>
                
                <!-- スタッフ一覧 -->
                <div id="staff-pool" class="space-y-2 max-h-96 overflow-y-auto">
                    <!-- スタッフカードがここに表示される -->
                </div>
            </div>
            
            <!-- スタッフ状態設定 -->
            <div class="bg-white rounded-lg shadow-md p-4 mt-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">
                    <i class="fas fa-cog mr-2"></i>スタッフ状態設定
                </h3>
                <div id="staff-status-settings"></div>
            </div>
        </div>

        <!-- 業務配置エリア -->
        <div class="xl:col-span-3">
            <div class="bg-white rounded-lg shadow-md p-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-gray-800">
                        <i class="fas fa-clipboard-list mr-2"></i>業務配置 - <span id="current-day-display">月曜日</span>
                    </h2>
                    <button onclick="addBusiness()" class="bg-green-600 text-white px-4 py-2 rounded-md text-sm hover:bg-green-700 transition-colors">
                        <i class="fas fa-plus mr-2"></i>業務追加
                    </button>
                </div>
                
                <!-- 業務スロット一覧 -->
                <div id="business-slots" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- 業務スロットがここに表示される -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 週配置一覧画面 -->
<div id="timeline-screen" class="screen hidden-section max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-bold text-gray-800 mb-6">
            <i class="fas fa-clock mr-2"></i>個人別週間タイムライン (8:00-17:00)
        </h2>
        <div id="weekly-timeline" class="overflow-x-auto"></div>
    </div>
</div>

</div>

<!-- モーダル -->
<div id="business-modal" class="modal">
    <div class="modal-content">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold">業務管理</h3>
            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form id="business-form" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700">業務名</label>
                <input type="text" id="business-title" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">開始時間</label>
                    <input type="time" id="business-start-time" required class="w-full px-3 py-2 border border-gray-300 rounded-md" value="08:00">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">終了時間</label>
                    <input type="time" id="business-end-time" required class="w-full px-3 py-2 border border-gray-300 rounded-md" value="17:00">
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">必要人数</label>
                    <input type="number" id="business-required-people" required min="1" max="10" class="w-full px-3 py-2 border border-gray-300 rounded-md" value="1">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">業務区分</label>
                    <select id="business-category" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        <option value="OPE">OPE</option>
                        <option value="ME">ME</option>
                        <option value="HD">HD</option>
                        <option value="不整脈">不整脈</option>
                    </select>
                </div>
            </div>
            
            <div class="flex justify-end space-x-2 pt-4">
                <button type="button" id="delete-business-btn" onclick="deleteBusiness()" class="hidden bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-colors">
                    <i class="fas fa-trash mr-2"></i>削除
                </button>
                <button type="button" onclick="closeModal()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400 transition-colors">
                    キャンセル
                </button>
                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                    <i class="fas fa-save mr-2"></i>保存
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// ===== データ定義 =====
const CORRECT_STAFF_DATA = [
    { id: 'staff_001', name: '安孫子明博', baseCategory: 'OPE', color: '#1E90FF' },
    { id: 'staff_002', name: '八鍬純', baseCategory: 'ME', color: '#00B894' },
    { id: 'staff_003', name: '杉山陽子', baseCategory: 'HD', color: '#FF69B4' },
    { id: 'staff_004', name: '中村圭佑', baseCategory: 'OPE', color: '#1E90FF' },
    { id: 'staff_005', name: '石山智之', baseCategory: 'ME', color: '#00B894' },
    { id: 'staff_006', name: '亀井祐哉', baseCategory: 'OPE', color: '#1E90FF' },
    { id: 'staff_007', name: '丸藤健', baseCategory: 'OPE', color: '#1E90FF' },
    { id: 'staff_008', name: '三春摩弥', baseCategory: 'ME', color: '#00B894' },
    { id: 'staff_009', name: '斎藤大樹', baseCategory: 'FLEX', color: '#FFD700' },
    { id: 'staff_010', name: '田中隆昭', baseCategory: 'ME', color: '#00B894' },
    { id: 'staff_011', name: '宇井勇気', baseCategory: 'OPE', color: '#1E90FF' },
    { id: 'staff_012', name: '宇野沢徹', baseCategory: 'OPE', color: '#1E90FF' },
    { id: 'staff_013', name: '佐藤将志', baseCategory: 'ME', color: '#00B894' },
    { id: 'staff_014', name: '庄司由紀', baseCategory: 'HD', color: '#FF69B4' },
    { id: 'staff_015', name: '小沼和樹', baseCategory: 'OPE', color: '#1E90FF' },
    { id: 'staff_016', name: '武田優斗', baseCategory: 'ME', color: '#00B894' },
    { id: 'staff_017', name: '設楽佑介', baseCategory: 'OPE', color: '#1E90FF' },
    { id: 'staff_018', name: '伊藤大晟', baseCategory: 'ME', color: '#00B894' },
    { id: 'staff_019', name: '上松野聖', baseCategory: 'ME', color: '#00B894' },
    { id: 'staff_020', name: '笹生貴之', baseCategory: 'ME', color: '#00B894' },
    { id: 'staff_021', name: '和田彩花', baseCategory: 'OPE', color: '#1E90FF' },
    { id: 'staff_022', name: '伊藤大稀', baseCategory: 'ME', color: '#00B894' },
    { id: 'staff_023', name: '佐藤千優', baseCategory: 'OPE', color: '#1E90FF' },
    { id: 'staff_024', name: '桑島亜依', baseCategory: 'ME', color: '#00B894' },
    { id: 'staff_025', name: '村田七星', baseCategory: 'ME', color: '#00B894' },
    { id: 'staff_026', name: '小林将己', baseCategory: 'ME', color: '#00B894' },
    { id: 'staff_027', name: '寒河江悠輝', baseCategory: 'ME', color: '#00B894' }
];

const DAYS = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'];
const DAY_NAMES = {
    'Mon': '月曜日',
    'Tue': '火曜日', 
    'Wed': '水曜日',
    'Thu': '木曜日',
    'Fri': '金曜日'
};

// ===== 中央ストア =====
window.hospitalStore = {
    staff: [...CORRECT_STAFF_DATA],
    dailyBusinesses: {
        'Mon': [], 'Tue': [], 'Wed': [], 'Thu': [], 'Fri': []
    },
    assignments: {
        'Mon': {}, 'Tue': {}, 'Wed': {}, 'Thu': {}, 'Fri': {}
    },
    dailyStaffStatus: {
        'Mon': { onCall: [], offDuty: [], compensatory: [], annualLeave: [], businessTrip: [] },
        'Tue': { onCall: [], offDuty: [], compensatory: [], annualLeave: [], businessTrip: [] },
        'Wed': { onCall: [], offDuty: [], compensatory: [], annualLeave: [], businessTrip: [] },
        'Thu': { onCall: [], offDuty: [], compensatory: [], annualLeave: [], businessTrip: [] },
        'Fri': { onCall: [], offDuty: [], compensatory: [], annualLeave: [], businessTrip: [] }
    },
    currentDay: 'Mon',
    currentBusinessId: null,
    
    saveData() {
        try {
            localStorage.setItem('hospitalScheduleData', JSON.stringify({
                staff: this.staff,
                dailyBusinesses: this.dailyBusinesses,
                assignments: this.assignments,
                dailyStaffStatus: this.dailyStaffStatus
            }));
            console.log('✅ データ保存成功');
            this.updateSaveStatus('✅ 自動保存済み');
        } catch (error) {
            console.error('❌ データ保存エラー:', error);
            this.updateSaveStatus('❌ 保存エラー');
        }
    },
    
    loadData() {
        try {
            const saved = localStorage.getItem('hospitalScheduleData');
            if (saved) {
                const data = JSON.parse(saved);
                
                // データ整合性チェック
                if (data.staff && data.staff.length === 27) {
                    this.staff = data.staff;
                } else {
                    console.warn('⚠️ スタッフデータ不整合、初期データを使用');
                    this.staff = [...CORRECT_STAFF_DATA];
                }
                
                this.dailyBusinesses = data.dailyBusinesses || { 'Mon': [], 'Tue': [], 'Wed': [], 'Thu': [], 'Fri': [] };
                this.assignments = data.assignments || { 'Mon': {}, 'Tue': {}, 'Wed': {}, 'Thu': {}, 'Fri': {} };
                this.dailyStaffStatus = data.dailyStaffStatus || {
                    'Mon': { onCall: [], offDuty: [], compensatory: [], annualLeave: [], businessTrip: [] },
                    'Tue': { onCall: [], offDuty: [], compensatory: [], annualLeave: [], businessTrip: [] },
                    'Wed': { onCall: [], offDuty: [], compensatory: [], annualLeave: [], businessTrip: [] },
                    'Thu': { onCall: [], offDuty: [], compensatory: [], annualLeave: [], businessTrip: [] },
                    'Fri': { onCall: [], offDuty: [], compensatory: [], annualLeave: [], businessTrip: [] }
                };
                
                console.log('✅ データ読み込み成功');
                this.updateSaveStatus('✅ データ読み込み済み');
            } else {
                console.log('ℹ️ 初期データで開始');
                this.updateSaveStatus('ℹ️ 初期状態');
            }
        } catch (error) {
            console.error('❌ データ読み込みエラー:', error);
            this.staff = [...CORRECT_STAFF_DATA];
            this.updateSaveStatus('❌ 読み込みエラー');
        }
    },
    
    updateSaveStatus(message) {
        const statusEl = document.getElementById('save-status');
        if (statusEl) {
            statusEl.textContent = message;
        }
    }
};

// ===== ドラッグ&ドロップ管理 =====
window.hospitalDragDrop = {
    instances: new Map(),
    
    initialize() {
        this.destroyAll();
        this.initializeStaffPool();
        this.initializeBusinessSlots();
        console.log('✅ ドラッグ&ドロップ初期化完了');
    },
    
    destroyAll() {
        this.instances.forEach(instance => {
            if (instance && typeof instance.destroy === 'function') {
                instance.destroy();
            }
        });
        this.instances.clear();
    },
    
    initializeStaffPool() {
        const staffPool = document.getElementById('staff-pool');
        if (!staffPool) return;
        
        const sortable = new Sortable(staffPool, {
            group: {
                name: 'hospital-staff',
                pull: 'clone',
                put: false
            },
            animation: 150,
            sort: false
        });
        
        this.instances.set('staff-pool', sortable);
    },
    
    initializeBusinessSlots() {
        document.querySelectorAll('.business-drop-zone').forEach(zone => {
            const businessId = zone.dataset.businessId;
            const maxCapacity = parseInt(zone.dataset.maxCapacity) || 1;
            
            if (!businessId) return;
            
            const sortable = new Sortable(zone, {
                group: {
                    name: 'hospital-staff',
                    pull: false,
                    put: (to, from, dragEl) => {
                        const currentAssignments = hospitalStore.assignments[hospitalStore.currentDay]?.[businessId] || [];
                        const staffId = dragEl.dataset.staffId;
                        
                        // 容量チェック
                        if (currentAssignments.length >= maxCapacity) {
                            this.showMessage('配置上限に達しています', 'warning');
                            return false;
                        }
                        
                        // 重複チェック
                        if (currentAssignments.includes(staffId)) {
                            this.showMessage('既に配置済みです', 'info');
                            return false;
                        }
                        
                        return true;
                    }
                },
                animation: 150,
                onAdd: (evt) => this.handleStaffAssignment(evt),
                onRemove: (evt) => this.handleStaffRemoval(evt)
            });
            
            this.instances.set(`business-${businessId}`, sortable);
        });
    },
    
    handleStaffAssignment(evt) {
        const staffId = evt.item.dataset.staffId;
        const businessId = evt.to.dataset.businessId;
        
        if (!staffId || !businessId) return;
        
        // データストアに配置情報を保存
        if (!hospitalStore.assignments[hospitalStore.currentDay]) {
            hospitalStore.assignments[hospitalStore.currentDay] = {};
        }
        if (!hospitalStore.assignments[hospitalStore.currentDay][businessId]) {
            hospitalStore.assignments[hospitalStore.currentDay][businessId] = [];
        }
        
        hospitalStore.assignments[hospitalStore.currentDay][businessId].push(staffId);
        
        // UIを更新
        this.updateAssignmentDisplay(businessId);
        hospitalStore.saveData();
        
        this.showMessage('スタッフを配置しました', 'success');
    },
    
    handleStaffRemoval(evt) {
        const staffId = evt.item.dataset.staffId;
        const businessId = evt.from.dataset.businessId;
        
        if (!staffId || !businessId) return;
        
        // データストアから配置情報を削除
        const assignments = hospitalStore.assignments[hospitalStore.currentDay]?.[businessId] || [];
        const index = assignments.indexOf(staffId);
        if (index > -1) {
            assignments.splice(index, 1);
        }
        
        // UIを更新
        this.updateAssignmentDisplay(businessId);
        hospitalStore.saveData();
        
        this.showMessage('スタッフの配置を解除しました', 'info');
    },
    
    updateAssignmentDisplay(businessId) {
        const zone = document.querySelector(`[data-business-id="${businessId}"]`);
        if (!zone) return;
        
        const assignments = hospitalStore.assignments[hospitalStore.currentDay]?.[businessId] || [];
        const maxCapacity = parseInt(zone.dataset.maxCapacity) || 1;
        
        // 配置人数カウンターの更新
        const counter = zone.querySelector('.assignment-counter');
        if (counter) {
            counter.textContent = `${assignments.length}/${maxCapacity}`;
            counter.style.display = assignments.length > 0 ? 'flex' : 'none';
        }
        
        // スロットの見た目更新
        if (assignments.length > 0) {
            zone.classList.add('has-assignment');
        } else {
            zone.classList.remove('has-assignment');
        }
    },
    
    showMessage(message, type = 'info') {
        const colors = {
            success: 'bg-green-500',
            warning: 'bg-yellow-500', 
            error: 'bg-red-500',
            info: 'bg-blue-500'
        };
        
        const messageEl = document.createElement('div');
        messageEl.className = `fixed top-4 right-4 ${colors[type]} text-white px-4 py-2 rounded-md shadow-lg z-50 transition-all duration-300`;
        messageEl.textContent = message;
        
        document.body.appendChild(messageEl);
        
        setTimeout(() => {
            messageEl.style.opacity = '0';
            messageEl.style.transform = 'translateX(100%)';
            setTimeout(() => {
                if (messageEl.parentNode) {
                    messageEl.parentNode.removeChild(messageEl);
                }
            }, 300);
        }, 3000);
    }
};

// ===== 認証機能 =====
function checkPassword() {
    const password = document.getElementById('password-input').value;
    const errorEl = document.getElementById('password-error');
    
    if (password === 'me5711me') {
        document.getElementById('password-screen').style.display = 'none';
        document.getElementById('main-app').classList.remove('hidden');
        initializeApp();
    } else {
        errorEl.classList.remove('hidden');
        document.getElementById('password-input').value = '';
    }
}

// ===== アプリケーション初期化 =====
function initializeApp() {
    console.log('🚀 アプリケーション初期化開始');
    
    // データ読み込み
    hospitalStore.loadData();
    
    // 初期画面表示
    showScreen('home');
    
    // UI初期化
    renderHomeScreen();
    renderScheduleScreen();
    renderTimelineScreen();
    
    console.log('✅ アプリケーション初期化完了');
}

// ===== 画面切り替え =====
function showScreen(screenName) {
    // 全画面を非表示
    document.querySelectorAll('.screen').forEach(screen => {
        screen.classList.add('hidden-section');
    });
    
    // ナビゲーションボタンの状態更新
    document.querySelectorAll('.nav-btn').forEach(btn => {
        if (btn.dataset.screen === screenName) {
            btn.classList.add('bg-blue-600', 'text-white');
            btn.classList.remove('text-gray-500', 'hover:text-gray-700');
        } else {
            btn.classList.remove('bg-blue-600', 'text-white');
            btn.classList.add('text-gray-500', 'hover:text-gray-700');
        }
    });
    
    // 選択された画面を表示
    const targetScreen = document.getElementById(`${screenName}-screen`);
    if (targetScreen) {
        targetScreen.classList.remove('hidden-section');
    }
    
    // 画面固有の初期化
    switch (screenName) {
        case 'home':
            renderHomeScreen();
            break;
        case 'schedule':
            renderScheduleScreen();
            hospitalDragDrop.initialize();
            break;
        case 'timeline':
            renderTimelineScreen();
            break;
    }
}

// ===== HOME画面レンダリング =====
function renderHomeScreen() {
    const departments = {
        'OPE': { container: 'ope-staff', staff: [] },
        'ME': { container: 'me-staff', staff: [] },
        'HD': { container: 'hd-staff', staff: [] },
        'FLEX': { container: 'flex-staff', staff: [] }
    };
    
    // スタッフを部門別に分類
    hospitalStore.staff.forEach(staff => {
        if (departments[staff.baseCategory]) {
            departments[staff.baseCategory].staff.push(staff);
        }
    });
    
    // 各部門のスタッフを表示
    Object.keys(departments).forEach(dept => {
        const container = document.getElementById(departments[dept].container);
        if (!container) return;
        
        container.innerHTML = departments[dept].staff.map(staff => `
            <div class="bg-gray-50 p-3 rounded-md border">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-bold" 
                             style="background-color: ${staff.color}">
                            ${staff.name.charAt(0)}
                        </div>
                        <div class="ml-3">
                            <div class="editable font-medium" onclick="editStaffName('${staff.id}')" data-staff-id="${staff.id}">
                                ${staff.name}
                            </div>
                            <div class="text-xs text-gray-600">${staff.baseCategory}</div>
                        </div>
                    </div>
                    <select onchange="changeStaffCategory('${staff.id}', this.value)" 
                            class="text-xs border rounded px-2 py-1">
                        <option value="OPE" ${staff.baseCategory === 'OPE' ? 'selected' : ''}>OPE</option>
                        <option value="ME" ${staff.baseCategory === 'ME' ? 'selected' : ''}>ME</option>
                        <option value="HD" ${staff.baseCategory === 'HD' ? 'selected' : ''}>HD</option>
                        <option value="FLEX" ${staff.baseCategory === 'FLEX' ? 'selected' : ''}>FLEX</option>
                    </select>
                </div>
            </div>
        `).join('');
    });
}

// ===== スタッフ名編集機能 =====
function editStaffName(staffId) {
    const staff = hospitalStore.staff.find(s => s.id === staffId);
    if (!staff) return;
    
    const element = document.querySelector(`.editable[data-staff-id="${staffId}"]`);
    if (!element) return;
    
    const originalName = staff.name;
    
    element.classList.add('editing');
    element.contentEditable = true;
    element.focus();
    
    const range = document.createRange();
    range.selectNodeContents(element);
    const selection = window.getSelection();
    selection.removeAllRanges();
    selection.addRange(range);
    
    const saveEdit = () => {
        const newName = element.textContent.trim();
        if (newName && newName !== originalName) {
            staff.name = newName;
            hospitalStore.saveData();
            renderHomeScreen(); // 全体を再レンダリング
            hospitalDragDrop.showMessage('名前を更新しました', 'success');
        } else {
            element.textContent = originalName;
        }
        
        element.classList.remove('editing');
        element.contentEditable = false;
    };
    
    element.addEventListener('blur', saveEdit, { once: true });
    element.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            element.blur();
        } else if (e.key === 'Escape') {
            element.textContent = originalName;
            element.blur();
        }
    }, { once: true });
}

// ===== スタッフ区分変更 =====
function changeStaffCategory(staffId, newCategory) {
    const staff = hospitalStore.staff.find(s => s.id === staffId);
    if (!staff) return;
    
    const colorMap = {
        'OPE': '#1E90FF',
        'ME': '#00B894', 
        'HD': '#FF69B4',
        'FLEX': '#FFD700'
    };
    
    staff.baseCategory = newCategory;
    staff.color = colorMap[newCategory];
    
    hospitalStore.saveData();
    renderHomeScreen();
    hospitalDragDrop.showMessage(`${staff.name}の区分を${newCategory}に変更しました`, 'success');
}

// ===== 元の名前に復元 =====
function restoreOriginalNames() {
    if (confirm('全スタッフの名前を元の名前に復元しますか？')) {
        hospitalStore.staff.forEach((staff, index) => {
            if (CORRECT_STAFF_DATA[index]) {
                staff.name = CORRECT_STAFF_DATA[index].name;
                staff.baseCategory = CORRECT_STAFF_DATA[index].baseCategory;
                staff.color = CORRECT_STAFF_DATA[index].color;
            }
        });
        
        hospitalStore.saveData();
        renderHomeScreen();
        hospitalDragDrop.showMessage('全スタッフの名前を復元しました', 'success');
    }
}

// ===== スケジュール画面レンダリング =====
function renderScheduleScreen() {
    renderStaffPool();
    renderStaffStatusSettings();
    renderBusinessSlots();
}

function renderStaffPool() {
    const currentDay = hospitalStore.currentDay;
    const availableStaff = getAvailableStaffForDay(currentDay);
    
    const staffPoolHTML = availableStaff.map(staff => {
        const status = getStaffStatusForDay(staff.id, currentDay);
        const isOnCall = status === 'onCall';
        
        return `
            <div class="staff-card ${isOnCall ? 'on-call' : ''}" 
                 data-staff-id="${staff.id}"
                 style="background-color: ${staff.color}; color: ${getReadableTextColor(staff.color)};">
                <span class="staff-name text-sm font-medium">${staff.name}</span>
                <span class="staff-category text-xs">${staff.baseCategory}</span>
                ${isOnCall ? '<span class="on-call-badge">🌙当直</span>' : ''}
            </div>
        `;
    }).join('');
    
    const staffPool = document.getElementById('staff-pool');
    if (staffPool) {
        staffPool.innerHTML = staffPoolHTML;
    }
}

function renderStaffStatusSettings() {
    const container = document.getElementById('staff-status-settings');
    if (!container) return;
    
    container.innerHTML = `
        <div class="status-tabs flex flex-wrap mb-4">
            ${DAYS.map((day, index) => `
                <button class="status-tab text-xs ${index === 0 ? 'active' : ''}" 
                        onclick="switchStatusDay('${day}')" 
                        data-day="${day}">
                    ${DAY_NAMES[day]}
                </button>
            `).join('')}
        </div>
        
        <div class="status-content">
            ${DAYS.map((day, index) => `
                <div class="status-day-panel ${index === 0 ? 'active' : ''}" id="status-${day}">
                    <div class="space-y-4">
                        <div class="status-group">
                            <h4 class="text-sm font-semibold text-gray-700 mb-2">🌙 当直</h4>
                            <select id="onCall-select-${day}" onchange="updateStaffStatus('${day}', 'onCall', this.value)" 
                                    class="w-full text-xs px-2 py-1 border border-gray-300 rounded">
                                <option value="">選択してください</option>
                                ${hospitalStore.staff.map(staff => `
                                    <option value="${staff.id}" ${hospitalStore.dailyStaffStatus[day].onCall.includes(staff.id) ? 'selected' : ''}>
                                        ${staff.name} (${staff.baseCategory})
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div class="status-group">
                            <h4 class="text-sm font-semibold text-gray-700 mb-2">🏠 非番</h4>
                            <select id="offDuty-select-${day}" onchange="updateStaffStatus('${day}', 'offDuty', this.value)"
                                    class="w-full text-xs px-2 py-1 border border-gray-300 rounded">
                                <option value="">選択してください</option>
                                ${hospitalStore.staff.map(staff => `
                                    <option value="${staff.id}" ${hospitalStore.dailyStaffStatus[day].offDuty.includes(staff.id) ? 'selected' : ''}>
                                        ${staff.name} (${staff.baseCategory})
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div class="status-group">
                            <h4 class="text-sm font-semibold text-gray-700 mb-2">📅 代休</h4>
                            <div class="space-y-1 max-h-32 overflow-y-auto">
                                ${hospitalStore.staff.map(staff => `
                                    <label class="flex items-center text-xs">
                                        <input type="checkbox" value="${staff.id}" 
                                               ${hospitalStore.dailyStaffStatus[day].compensatory.includes(staff.id) ? 'checked' : ''}
                                               onchange="updateMultiStaffStatus('${day}', 'compensatory')" 
                                               class="mr-2">
                                        ${staff.name} (${staff.baseCategory})
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

function renderBusinessSlots() {
    const currentDay = hospitalStore.currentDay;
    const businesses = hospitalStore.dailyBusinesses[currentDay] || [];
    
    const businessSlotsHTML = businesses.map(business => {
        const assignments = hospitalStore.assignments[currentDay]?.[business.id] || [];
        
        return `
            <div class="business-slot bg-white border-2 border-dashed border-gray-300 rounded-lg p-4 relative"
                 data-business-id="${business.id}" 
                 data-max-capacity="${business.requiredPeople}">
                
                <div class="business-header mb-3">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-medium text-gray-800 cursor-pointer hover:text-blue-600" 
                                onclick="editBusiness('${business.id}')">
                                ${business.title}
                            </h3>
                            <p class="text-xs text-gray-600">
                                ${business.startTime} - ${business.endTime} | 
                                ${business.category} | 
                                ${business.requiredPeople}名
                            </p>
                        </div>
                        <div class="text-right">
                            <button onclick="editBusiness('${business.id}')" 
                                    class="text-blue-600 hover:text-blue-800 text-xs">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="business-drop-zone min-h-16 bg-gray-50 border border-gray-200 rounded p-2" 
                     data-business-id="${business.id}" 
                     data-max-capacity="${business.requiredPeople}">
                    ${assignments.map(staffId => {
                        const staff = hospitalStore.staff.find(s => s.id === staffId);
                        return staff ? `
                            <div class="staff-card assigned-staff mb-2" 
                                 data-staff-id="${staff.id}"
                                 style="background-color: ${staff.color}; color: ${getReadableTextColor(staff.color)};">
                                <span class="staff-name text-sm">${staff.name}</span>
                                <button onclick="removeStaffAssignment('${business.id}', '${staff.id}')" 
                                        class="ml-2 text-xs opacity-75 hover:opacity-100">✕</button>
                            </div>
                        ` : '';
                    }).join('')}
                    ${assignments.length === 0 ? '<div class="text-gray-400 text-center text-sm">スタッフをドラッグ</div>' : ''}
                </div>
                
                <div class="assignment-counter ${assignments.length > 0 ? '' : 'hidden'}">${assignments.length}/${business.requiredPeople}</div>
            </div>
        `;
    }).join('');
    
    const container = document.getElementById('business-slots');
    if (container) {
        container.innerHTML = businessSlotsHTML;
        
        if (businesses.length === 0) {
            container.innerHTML = `
                <div class="col-span-full text-center py-8 text-gray-500">
                    <i class="fas fa-plus-circle text-4xl mb-4"></i>
                    <p>「業務追加」ボタンで新しい業務を追加してください</p>
                </div>
            `;
        }
    }
    
    // 現在の曜日表示を更新
    const dayDisplay = document.getElementById('current-day-display');
    if (dayDisplay) {
        dayDisplay.textContent = DAY_NAMES[currentDay];
    }
    
    const daySelect = document.getElementById('current-day-select');
    if (daySelect) {
        daySelect.value = currentDay;
    }
}

// ===== タイムライン画面レンダリング =====
function renderTimelineScreen() {
    const timeSlots = generateTimeSlots('08:00', '17:00', 60);
    
    const timelineHTML = `
        <div class="timeline-container overflow-x-auto">
            <!-- ヘッダー -->
            <div class="timeline-header bg-gray-100 border-b-2 border-gray-300 sticky top-0">
                <div class="flex">
                    <div class="w-32 flex-shrink-0 p-2 font-semibold border-r">スタッフ</div>
                    ${DAYS.map(day => `
                        <div class="flex-1 min-w-96 border-r">
                            <div class="text-center p-2 font-semibold border-b">
                                ${DAY_NAMES[day]}
                            </div>
                            <div class="flex">
                                ${timeSlots.map(time => `
                                    <div class="w-10 text-xs text-center p-1 border-r">
                                        ${time.substring(0, 2)}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
            
            <!-- スタッフタイムライン -->
            <div class="timeline-body">
                ${hospitalStore.staff.map(staff => `
                    <div class="flex border-b hover:bg-gray-50">
                        <div class="w-32 flex-shrink-0 p-2 border-r flex items-center">
                            <div class="w-6 h-6 rounded-full flex items-center justify-center text-white text-xs font-bold mr-2" 
                                 style="background-color: ${staff.color}">
                                ${staff.name.charAt(0)}
                            </div>
                            <div>
                                <div class="text-sm font-medium">${staff.name}</div>
                                <div class="text-xs text-gray-600">${staff.baseCategory}</div>
                            </div>
                        </div>
                        
                        ${DAYS.map(day => `
                            <div class="flex-1 min-w-96 border-r flex">
                                ${timeSlots.map(time => {
                                    const assignment = getStaffAssignmentAtTime(staff.id, day, time);
                                    const status = getStaffDayStatus(staff.id, day);
                                    const timeSlotClass = getTimeSlotClass(assignment, status);
                                    
                                    return `
                                        <div class="time-slot ${timeSlotClass}"
                                             title="${getTimeSlotTooltip(staff, day, time, assignment, status)}"
                                             style="${assignment ? getAssignmentStyle(assignment) : ''}">
                                            ${assignment ? assignment.businessTitle.substring(0, 2) : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `).join('')}
                    </div>
                `).join('')}
            </div>
        </div>
    `;
    
    const container = document.getElementById('weekly-timeline');
    if (container) {
        container.innerHTML = timelineHTML;
    }
}

// ===== ユーティリティ関数 =====
function getAvailableStaffForDay(day) {
    return hospitalStore.staff.filter(staff => {
        const status = hospitalStore.dailyStaffStatus[day];
        return !status.offDuty.includes(staff.id) && 
               !status.compensatory.includes(staff.id) && 
               !status.annualLeave.includes(staff.id) && 
               !status.businessTrip.includes(staff.id);
    });
}

function getStaffStatusForDay(staffId, day) {
    const status = hospitalStore.dailyStaffStatus[day];
    if (status.onCall.includes(staffId)) return 'onCall';
    if (status.offDuty.includes(staffId)) return 'offDuty';
    if (status.compensatory.includes(staffId)) return 'compensatory';
    if (status.annualLeave.includes(staffId)) return 'annualLeave';
    if (status.businessTrip.includes(staffId)) return 'businessTrip';
    return 'normal';
}

function getStaffDayStatus(staffId, day) {
    return getStaffStatusForDay(staffId, day);
}

function getReadableTextColor(backgroundColor) {
    const rgb = hexToRgb(backgroundColor);
    const brightness = (rgb.r * 299 + rgb.g * 587 + rgb.b * 114) / 1000;
    return brightness > 128 ? '#000000' : '#FFFFFF';
}

function hexToRgb(hex) {
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
    } : null;
}

function generateTimeSlots(startTime, endTime, intervalMinutes) {
    const slots = [];
    const start = parseTime(startTime);
    const end = parseTime(endTime);
    
    for (let current = start; current < end; current += intervalMinutes) {
        slots.push(formatTime(current));
    }
    
    return slots;
}

function parseTime(timeString) {
    const [hours, minutes] = timeString.split(':').map(Number);
    return hours * 60 + minutes;
}

function formatTime(minutes) {
    const hours = Math.floor(minutes / 60).toString().padStart(2, '0');
    const mins = (minutes % 60).toString().padStart(2, '0');
    return `${hours}:${mins}`;
}

function getStaffAssignmentAtTime(staffId, day, time) {
    const businesses = hospitalStore.dailyBusinesses[day] || [];
    const assignments = hospitalStore.assignments[day] || {};
    
    for (const business of businesses) {
        if (assignments[business.id] && assignments[business.id].includes(staffId)) {
            const startMinutes = parseTime(business.startTime);
            const endMinutes = parseTime(business.endTime);
            const currentMinutes = parseTime(time);
            
            if (currentMinutes >= startMinutes && currentMinutes < endMinutes) {
                return {
                    businessId: business.id,
                    businessTitle: business.title,
                    businessCategory: business.category
                };
            }
        }
    }
    return null;
}

function getTimeSlotClass(assignment, status) {
    let classes = [];
    if (assignment) classes.push('assigned');
    if (status !== 'normal') classes.push(`status-${status}`);
    return classes.join(' ');
}

function getAssignmentStyle(assignment) {
    const categoryColors = {
        'OPE': '#1E90FF',
        'ME': '#00B894',
        'HD': '#FF69B4',
        '不整脈': '#8E44AD'
    };
    
    const bgColor = categoryColors[assignment.businessCategory] || '#6B7280';
    return `background-color: ${bgColor}; color: white;`;
}

function getTimeSlotTooltip(staff, day, time, assignment, status) {
    let tooltip = `${staff.name} - ${DAY_NAMES[day]} ${time}`;
    
    if (assignment) {
        tooltip += `\n業務: ${assignment.businessTitle}`;
    }
    
    const statusNames = {
        'onCall': '当直',
        'offDuty': '非番',
        'compensatory': '代休',
        'annualLeave': '年休',
        'businessTrip': '出張'
    };
    
    if (status !== 'normal') {
        tooltip += `\n状態: ${statusNames[status]}`;
    }
    
    return tooltip;
}

// ===== 曜日・状態管理 =====
function switchDay(day) {
    hospitalStore.currentDay = day;
    renderStaffPool();
    renderBusinessSlots();
    hospitalDragDrop.initialize();
}

function switchStatusDay(day) {
    // タブの状態を更新
    document.querySelectorAll('.status-tab').forEach(tab => {
        if (tab.dataset.day === day) {
            tab.classList.add('active');
        } else {
            tab.classList.remove('active');
        }
    });
    
    // パネルの状態を更新
    document.querySelectorAll('.status-day-panel').forEach(panel => {
        if (panel.id === `status-${day}`) {
            panel.classList.add('active');
        } else {
            panel.classList.remove('active');
        }
    });
}

function updateStaffStatus(day, statusType, staffId) {
    if (!staffId) return;
    
    // 既存の状態をクリア（単一選択の場合）
    if (statusType === 'onCall' || statusType === 'offDuty') {
        hospitalStore.dailyStaffStatus[day][statusType] = [staffId];
    }
    
    hospitalStore.saveData();
    renderStaffPool();
    hospitalDragDrop.showMessage(`${DAY_NAMES[day]}の${statusType}を設定しました`, 'success');
}

function updateMultiStaffStatus(day, statusType) {
    const checkboxes = document.querySelectorAll(`#status-${day} input[type="checkbox"]`);
    const selectedStaff = Array.from(checkboxes)
        .filter(cb => cb.checked)
        .map(cb => cb.value);
    
    hospitalStore.dailyStaffStatus[day][statusType] = selectedStaff;
    hospitalStore.saveData();
    renderStaffPool();
}

// ===== 業務管理 =====
function addBusiness() {
    hospitalStore.currentBusinessId = null;
    
    // フォームをクリア
    document.getElementById('business-title').value = '';
    document.getElementById('business-start-time').value = '08:00';
    document.getElementById('business-end-time').value = '17:00';
    document.getElementById('business-required-people').value = '1';
    document.getElementById('business-category').value = 'OPE';
    
    // 削除ボタンを非表示
    document.getElementById('delete-business-btn').classList.add('hidden');
    
    // モーダルを表示
    document.getElementById('business-modal').classList.add('active');
}

function editBusiness(businessId) {
    const business = hospitalStore.dailyBusinesses[hospitalStore.currentDay]?.find(b => b.id === businessId);
    if (!business) return;
    
    hospitalStore.currentBusinessId = businessId;
    
    // フォームに既存データを設定
    document.getElementById('business-title').value = business.title;
    document.getElementById('business-start-time').value = business.startTime;
    document.getElementById('business-end-time').value = business.endTime;
    document.getElementById('business-required-people').value = business.requiredPeople;
    document.getElementById('business-category').value = business.category;
    
    // 削除ボタンを表示
    document.getElementById('delete-business-btn').classList.remove('hidden');
    
    // モーダルを表示
    document.getElementById('business-modal').classList.add('active');
}

function deleteBusiness() {
    if (!hospitalStore.currentBusinessId) return;
    
    if (confirm('この業務を削除しますか？配置されたスタッフも自動的に解除されます。')) {
        const currentDay = hospitalStore.currentDay;
        
        // 業務を削除
        hospitalStore.dailyBusinesses[currentDay] = hospitalStore.dailyBusinesses[currentDay]
            .filter(b => b.id !== hospitalStore.currentBusinessId);
        
        // 配置情報も削除
        delete hospitalStore.assignments[currentDay][hospitalStore.currentBusinessId];
        
        hospitalStore.saveData();
        closeModal();
        renderBusinessSlots();
        hospitalDragDrop.initialize();
        
        hospitalDragDrop.showMessage('業務を削除しました', 'success');
    }
}

function closeModal() {
    document.getElementById('business-modal').classList.remove('active');
    hospitalStore.currentBusinessId = null;
}

function removeStaffAssignment(businessId, staffId) {
    const assignments = hospitalStore.assignments[hospitalStore.currentDay]?.[businessId] || [];
    const index = assignments.indexOf(staffId);
    
    if (index > -1) {
        assignments.splice(index, 1);
        hospitalStore.saveData();
        renderBusinessSlots();
        hospitalDragDrop.initialize();
        hospitalDragDrop.showMessage('スタッフの配置を解除しました', 'info');
    }
}

// ===== PDF出力 =====
function exportToPDF() {
    hospitalDragDrop.showMessage('ブラウザの印刷機能を使用してPDF出力してください', 'info');
    window.print();
}

// ===== イベントリスナー =====
document.addEventListener('DOMContentLoaded', () => {
    // パスワード入力でEnterキー対応
    document.getElementById('password-input').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            checkPassword();
        }
    });
    
    // 業務フォーム送信処理
    document.getElementById('business-form').addEventListener('submit', (e) => {
        e.preventDefault();
        
        const businessData = {
            id: hospitalStore.currentBusinessId || `business_${Date.now()}`,
            title: document.getElementById('business-title').value,
            startTime: document.getElementById('business-start-time').value,
            endTime: document.getElementById('business-end-time').value,
            requiredPeople: parseInt(document.getElementById('business-required-people').value),
            category: document.getElementById('business-category').value
        };
        
        const currentDay = hospitalStore.currentDay;
        
        if (hospitalStore.currentBusinessId) {
            // 編集
            const index = hospitalStore.dailyBusinesses[currentDay].findIndex(b => b.id === hospitalStore.currentBusinessId);
            if (index > -1) {
                hospitalStore.dailyBusinesses[currentDay][index] = businessData;
            }
        } else {
            // 新規追加
            if (!hospitalStore.dailyBusinesses[currentDay]) {
                hospitalStore.dailyBusinesses[currentDay] = [];
            }
            hospitalStore.dailyBusinesses[currentDay].push(businessData);
        }
        
        hospitalStore.saveData();
        closeModal();
        renderBusinessSlots();
        hospitalDragDrop.initialize();
        
        hospitalDragDrop.showMessage('業務を保存しました', 'success');
    });
    
    // モーダル外クリックで閉じる
    document.getElementById('business-modal').addEventListener('click', (e) => {
        if (e.target === document.getElementById('business-modal')) {
            closeModal();
        }
    });
    
    // ESCキーでモーダルを閉じる
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closeModal();
        }
    });
});

// 初期化
console.log('🏥 業務配置調整システム読み込み完了');
</script>

</body>
</html>
