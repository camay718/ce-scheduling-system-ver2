<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEスケジュール管理システム V2 - 勤務表作成・編集</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- 外部ライブラリ -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- ✅ 統合CSS -->
    <link rel="stylesheet" href="../styles/main.css">

    <!-- 勤務表編集専用スタイル -->
    <style>
    .work-schedule-container {
        max-width: 100%;
        overflow-x: auto;
    }

    .work-schedule-table {
        min-width: 1200px;
        border-collapse: collapse;
        font-size: 12px;
    }

    .work-schedule-table th,
    .work-schedule-table td {
        border: 1px solid #e5e7eb;
        padding: 4px;
        text-align: center;
        min-width: 30px;
    }

    .name-header, .name-cell {
        min-width: 120px;
        max-width: 120px;
        position: sticky;
        left: 0;
        background: #f9fafb;
        font-weight: 600;
        z-index: 10;
    }

    .date-header {
        background: #f3f4f6;
        font-weight: 600;
        writing-mode: vertical-lr;
        text-orientation: mixed;
    }

    .weekend-header {
        background: #fef2f2;
        color: #dc2626;
    }

    .work-cell {
        cursor: pointer;
        user-select: none;
        position: relative;
    }

    .work-cell:hover {
        background: #dbeafe;
    }

    .work-cell.selected {
        background: #3b82f6;
        color: white;
    }

    .work-cell.desired {
        border: 2px solid #f59e0b;
        background: #fef3c7;
    }

    .work-cell.holiday {
        background: #fef2f2;
    }

    /* 勤務区分別色分け */
    .status-A { background: #dcfce7; }
    .status-A1 { background: #bfdbfe; }
    .status-B { background: #fde68a; }
    .status-非 { background: #e0e7ff; }
    .status-× { background: #f3f4f6; }
    .status-年 { background: #fed7d7; }
    .status-出 { background: #d1fae5; }
    .status-研 { background: #ddd6fe; }

    .summary-header, .summary-cell {
        background: #f9fafb;
        font-weight: 600;
        min-width: 40px;
    }

    .footer-summary-row {
        background: #f3f4f6;
        font-weight: 600;
    }

    .warning-count {
        background: #fecaca !important;
        color: #dc2626 !important;
        font-weight: bold;
    }

    .toolbar {
        position: sticky;
        top: 0;
        background: white;
        z-index: 20;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .status-selector {
        display: none;
        position: fixed;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 30;
        padding: 8px;
        grid-template-columns: repeat(4, 1fr);
        gap: 4px;
    }

    .status-button {
        padding: 6px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        transition: all 0.2s;
    }

    .status-button:hover {
        transform: scale(1.05);
    }

    .period-info {
        background: #f0f9ff;
        border: 1px solid #0ea5e9;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 16px;
    }
    </style>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <!-- Firebase設定 -->
    <script src="../js/config/firebase-config.js?v=20241212"></script>
</head>
<body class="theme-unified">
    <!-- ローディング画面 -->
    <div id="loading" class="fixed inset-0 bg-white flex items-center justify-center z-50">
        <div class="text-center">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-gray-600">勤務表エディターを読み込んでいます...</p>
        </div>
    </div>

    <!-- メインインターフェース -->
    <div id="mainInterface" style="display:none;">
        <!-- ツールバー -->
        <div class="toolbar">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-2xl font-bold text-gray-900">
                    <i class="fas fa-table mr-2 text-blue-600"></i>
                    勤務表作成・編集
                </h1>
                <div class="flex space-x-3">
                    <button id="saveScheduleBtn" class="btn-unified btn-primary-unified">
                        <i class="fas fa-save mr-2"></i>保存
                    </button>
                    <button id="previewBtn" class="btn-unified btn-outline-unified">
                        <i class="fas fa-eye mr-2"></i>プレビュー
                    </button>
                    <button id="exportBtn" class="btn-unified btn-outline-unified">
                        <i class="fas fa-download mr-2"></i>エクスポート
                    </button>
                    <button onclick="window.close()" class="btn-unified btn-outline-unified">
                        <i class="fas fa-times mr-2"></i>閉じる
                    </button>
                </div>
            </div>

            <!-- 期間設定 -->
            <div class="period-info">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">開始日</label>
                        <input type="date" id="startDateInput" class="input-unified">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">終了日</label>
                        <input type="date" id="endDateInput" class="input-unified">
                    </div>
                    <div class="flex items-end">
                        <button id="generatePeriodBtn" class="btn-unified btn-primary-unified w-full">
                            <i class="fas fa-calendar-plus mr-2"></i>期間生成
                        </button>
                    </div>
                </div>
            </div>

            <!-- 編集ツール -->
            <div class="flex flex-wrap items-center gap-4">
                <div class="flex items-center space-x-2">
                    <label class="text-sm font-medium">選択モード:</label>
                    <select id="selectionMode" class="input-unified" style="width: auto;">
                        <option value="single">単一選択</option>
                        <option value="range">範囲選択</option>
                        <option value="column">列選択</option>
                    </select>
                </div>
                
                <div class="flex items-center space-x-2">
                    <label class="text-sm font-medium">勤務区分:</label>
                    <div class="flex space-x-1">
                        <button class="status-button bg-green-200 hover:bg-green-300" data-status="A">A</button>
                        <button class="status-button bg-blue-200 hover:bg-blue-300" data-status="A1">A1</button>
                        <button class="status-button bg-yellow-200 hover:bg-yellow-300" data-status="B">B</button>
                        <button class="status-button bg-purple-200 hover:bg-purple-300" data-status="非">非</button>
                        <button class="status-button bg-gray-200 hover:bg-gray-300" data-status="×">×</button>
                        <button class="status-button bg-red-200 hover:bg-red-300" data-status="年">年</button>
                        <button class="status-button bg-green-200 hover:bg-green-300" data-status="出">出</button>
                        <button class="status-button bg-indigo-200 hover:bg-indigo-300" data-status="研">研</button>
                    </div>
                </div>

                <div class="flex items-center space-x-2">
                    <button id="clearSelectionBtn" class="btn-unified btn-outline-unified btn-sm">
                        <i class="fas fa-eraser mr-1"></i>クリア
                    </button>
                    <button id="autoFillBtn" class="btn-unified btn-outline-unified btn-sm">
                        <i class="fas fa-magic mr-1"></i>自動配置
                    </button>
                </div>

                <div class="flex items-center space-x-2">
                    <button id="undoBtn" class="btn-unified btn-outline-unified btn-sm">
                        <i class="fas fa-undo mr-1"></i>戻る
                    </button>
                    <button id="redoBtn" class="btn-unified btn-outline-unified btn-sm">
                        <i class="fas fa-redo mr-1"></i>進む
                    </button>
                </div>
            </div>
        </div>

        <!-- 勤務表エリア -->
        <div class="px-4 pb-4">
            <div id="scheduleTableContainer" class="work-schedule-container">
                <div id="noScheduleMessage" class="text-center py-16">
                    <i class="fas fa-calendar-plus text-4xl text-gray-400 mb-4"></i>
                    <h3 class="text-lg font-semibold text-gray-600 mb-2">勤務表を作成</h3>
                    <p class="text-gray-500 mb-4">期間を設定して「期間生成」ボタンを押してください</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 右クリックメニュー -->
    <div id="contextMenu" class="status-selector">
        <button class="status-button bg-green-200 hover:bg-green-300" data-status="A">A (日勤)</button>
        <button class="status-button bg-blue-200 hover:bg-blue-300" data-status="A1">A1 (早番)</button>
        <button class="status-button bg-yellow-200 hover:bg-yellow-300" data-status="B">B (当直)</button>
        <button class="status-button bg-purple-200 hover:bg-purple-300" data-status="非">非 (非番)</button>
        <button class="status-button bg-gray-200 hover:bg-gray-300" data-status="×">× (休日)</button>
        <button class="status-button bg-red-200 hover:bg-red-300" data-status="年">年 (年休)</button>
        <button class="status-button bg-green-200 hover:bg-green-300" data-status="出">出 (出張)</button>
        <button class="status-button bg-indigo-200 hover:bg-indigo-300" data-status="研">研 (研修)</button>
    </div>

    <!-- 保存確認モーダル -->
    <div id="saveConfirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display:none;">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="p-6">
                <div class="flex items-center mb-4">
                    <i class="fas fa-save text-2xl text-blue-600 mr-3"></i>
                    <h3 class="text-lg font-bold">勤務表を保存</h3>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">保存名</label>
                    <input type="text" id="scheduleNameInput" class="input-unified" 
                           placeholder="例：2024年1月期">
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">説明</label>
                    <textarea id="scheduleDescInput" class="input-unified" rows="3"
                              placeholder="この勤務表についての説明（任意）"></textarea>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button id="cancelSaveBtn" class="btn-unified btn-outline-unified">
                        キャンセル
                    </button>
                    <button id="confirmSaveBtn" class="btn-unified btn-primary-unified">
                        <i class="fas fa-save mr-2"></i>保存
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ✅ 最適化されたJavaScript -->
    <script type="module">
        // ✅ 統合ユーティリティをインポート
        import { Utils } from '../js/utils.js';
        import { DataManager } from '../js/data-manager.js';
        
        // グローバルに公開
        window.Utils = Utils;
        window.DataManager = DataManager;
        window.dataManager = new DataManager();
        
        console.log('✅ 勤務表エディター：モジュール読み込み完了');
    </script>

    <script>
    // ✅ 最適化されたWorkScheduleEditor
    class WorkScheduleEditor {
        constructor() {
            this.scheduleData = {};
            this.ceList = [];
            this.currentPeriod = null;
            this.selectedCells = [];
            this.selectionMode = 'single';
            this.isSelecting = false;
            this.history = [];
            this.historyIndex = -1;
            this.init();
        }

        async init() {
            try {
                await window.waitForFirebase();
                await this.checkAuth();
                await this.loadCEList();
                this.setupEventListeners();
                this.setupDefaultPeriod();
                this.showInterface();
                console.log('✅ 勤務表エディター初期化完了');
            } catch (error) {
                console.error('❌ 勤務表エディター初期化エラー:', error);
                this.redirectToLogin();
            }
        }

        async checkAuth() {
            const targetUID = sessionStorage.getItem('targetUID');
            if (!targetUID) {
                throw new Error('認証情報がありません');
            }

            // ✅ 最適化：dataManagerを使用
            let userData;
            if (window.dataManager) {
                const users = await window.dataManager.getUsersByRole(null, true);
                userData = users[targetUID];
            } else {
                const snapshot = await window.database.ref(`${window.DATA_ROOT}/users/${targetUID}`).once('value');
                userData = snapshot.val();
            }

            if (!userData || userData.role === 'viewer') {
                throw new Error('編集権限がありません');
            }

            window.currentUserData = userData;
        }

        // ✅ 最適化：CE一覧をキャッシュ付きで取得
        async loadCEList() {
            try {
                if (window.dataManager) {
                    const ceData = await window.dataManager.getCEList(true);
                    this.ceList = Object.keys(ceData).map(id => ({
                        id,
                        ...ceData[id]
                    })).filter(ce => ce.isActive !== false);
                } else {
                    const snapshot = await window.database.ref(`${window.DATA_ROOT}/ces`).once('value');
                    const ceData = snapshot.val() || {};
                    this.ceList = Object.keys(ceData).map(id => ({
                        id,
                        ...ceData[id]
                    })).filter(ce => ce.isActive !== false);
                }
                
                console.log(`✅ CE一覧読み込み完了: ${this.ceList.length}名`);
            } catch (error) {
                console.error('❌ CE一覧読み込みエラー:', error);
                if (window.Utils) {
                    window.Utils.showMessage('CE一覧の読み込みに失敗しました', 'error');
                }
            }
        }

        setupEventListeners() {
            // 期間設定
            document.getElementById('generatePeriodBtn').onclick = () => this.generatePeriod();
            
            // 保存・エクスポート
            document.getElementById('saveScheduleBtn').onclick = () => this.showSaveModal();
            document.getElementById('previewBtn').onclick = () => this.previewSchedule();
            document.getElementById('exportBtn').onclick = () => this.exportSchedule();
            
            // 編集ツール
            document.getElementById('selectionMode').onchange = (e) => {
                this.selectionMode = e.target.value;
                this.clearSelection();
            };
            
            document.getElementById('clearSelectionBtn').onclick = () => this.clearSelection();
            document.getElementById('autoFillBtn').onclick = () => this.autoFill();
            document.getElementById('undoBtn').onclick = () => this.undo();
            document.getElementById('redoBtn').onclick = () => this.redo();

            // 勤務区分ボタン
            document.querySelectorAll('.status-button').forEach(btn => {
                btn.onclick = (e) => {
                    e.stopPropagation();
                    this.applyStatusToSelection(btn.dataset.status);
                };
            });

            // 保存モーダル
            document.getElementById('confirmSaveBtn').onclick = () => this.saveSchedule();
            document.getElementById('cancelSaveBtn').onclick = () => this.hideSaveModal();
            
            // 右クリックメニュー
            document.addEventListener('click', () => this.hideContextMenu());
            document.addEventListener('contextmenu', (e) => e.preventDefault());

            // キーボードショートカット
            document.addEventListener('keydown', (e) => this.handleKeyboard(e));
        }

        setupDefaultPeriod() {
            const today = new Date();
            const startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            const endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            
            // 28日間に調整
            endDate.setDate(startDate.getDate() + 27);
            
            document.getElementById('startDateInput').value = this.formatDateInput(startDate);
            document.getElementById('endDateInput').value = this.formatDateInput(endDate);
        }

        formatDateInput(date) {
            return window.Utils ? window.Utils.formatDate(date) : date.toISOString().slice(0, 10);
        }

        // ✅ 最適化：期間生成とデータ初期化
        generatePeriod() {
            const startDate = new Date(document.getElementById('startDateInput').value);
            const endDate = new Date(document.getElementById('endDateInput').value);
            
            if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                if (window.Utils) {
                    window.Utils.showMessage('正しい日付を入力してください', 'warning');
                }
                return;
            }
            
            if (startDate >= endDate) {
                if (window.Utils) {
                    window.Utils.showMessage('終了日は開始日より後の日付を選択してください', 'warning');
                }
                return;
            }
            
            const daysDiff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
            if (daysDiff > 31) {
                if (window.Utils) {
                    window.Utils.showMessage('期間は31日以内で設定してください', 'warning');
                }
                return;
            }

            this.currentPeriod = {
                startDate: startDate,
                endDate: endDate,
                dates: this.generateDateRange(startDate, endDate)
            };

            // スケジュールデータ初期化
            this.initializeScheduleData();
            this.renderScheduleTable();
            this.hideNoScheduleMessage();
            
            if (window.Utils) {
                window.Utils.showMessage('勤務表を生成しました', 'success');
            }
        }

        generateDateRange(startDate, endDate) {
            const dates = [];
            const current = new Date(startDate);
            
            while (current <= endDate) {
                dates.push(new Date(current));
                current.setDate(current.getDate() + 1);
            }
            
            return dates;
        }

        initializeScheduleData() {
            this.scheduleData = {};
            
            this.ceList.forEach(ce => {
                this.scheduleData[ce.id] = {};
                this.currentPeriod.dates.forEach(date => {
                    const dateKey = this.formatDateInput(date);
                    const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                    
                    this.scheduleData[ce.id][dateKey] = {
                        status: isWeekend ? '×' : 'A',
                        desired: false
                    };
                });
            });
        }

        renderScheduleTable() {
            const container = document.getElementById('scheduleTableContainer');
            if (!container || !this.currentPeriod) return;

            const table = this.createScheduleTable();
            container.innerHTML = '';
            container.appendChild(table);
            
            this.setupTableEventListeners();
        }

        createScheduleTable() {
            const table = document.createElement('table');
            table.className = 'work-schedule-table';
            
            // ヘッダー作成
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            
            // 氏名ヘッダー
            const nameHeader = document.createElement('th');
            nameHeader.className = 'name-header';
            nameHeader.textContent = '氏名';
            headerRow.appendChild(nameHeader);
            
            // 日付ヘッダー
            this.currentPeriod.dates.forEach(date => {
                const th = document.createElement('th');
                th.className = 'date-header';
                if (date.getDay() === 0 || date.getDay() === 6) {
                    th.classList.add('weekend-header');
                }
                
                const dayOfWeek = ['日', '月', '火', '水', '木', '金', '土'][date.getDay()];
                th.innerHTML = `
                    <div>${date.getDate()}</div>
                    <div style="font-size: 10px;">${dayOfWeek}</div>
                `;
                headerRow.appendChild(th);
            });
            
            // サマリーヘッダー
            const summaryHeaders = ['A', 'A1', 'B', '非', '×', '年', '出', '研', '休日数', '実勤務', '当直回数'];
            summaryHeaders.forEach(header => {
                const th = document.createElement('th');
                th.className = 'summary-header';
                th.textContent = header;
                headerRow.appendChild(th);
            });
            
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // ボディ作成
            const tbody = document.createElement('tbody');
            
            this.ceList.forEach(ce => {
                const row = document.createElement('tr');
                
                // 氏名セル
                const nameCell = document.createElement('td');
                nameCell.className = 'name-cell';
                nameCell.innerHTML = `
                    <div style="font-weight: 600;">${ce.fullName || ce.name || ''}</div>
                    <div style="font-size: 10px; color: #6b7280;">${ce.workType}</div>
                `;
                row.appendChild(nameCell);
                
                // 勤務セル
                const summary = { A: 0, A1: 0, B: 0, non: 0, off: 0, year: 0, trip: 0, training: 0, holidays: 0, actual: 0, night: 0 };
                
                this.currentPeriod.dates.forEach(date => {
                    const dateKey = this.formatDateInput(date);
                    const workData = this.scheduleData[ce.id]?.[dateKey] || {};
                    const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                    
                    const cell = document.createElement('td');
                    cell.className = 'work-cell';
                    cell.dataset.ceId = ce.id;
                    cell.dataset.date = dateKey;
                    cell.textContent = workData.status || (isWeekend ? '×' : 'A');
                    
                    // スタイル適用
                    if (workData.status) {
                        cell.classList.add(`status-${workData.status}`);
                    }
                    if (workData.desired) {
                        cell.classList.add('desired');
                    }
                    if (isWeekend) {
                        cell.classList.add('holiday');
                    }
                    
                    // サマリー計算
                    const status = workData.status || (isWeekend ? '×' : 'A');
                    if (isWeekend) summary.holidays++;
                    switch (status) {
                        case 'A': summary.A++; summary.actual++; break;
                        case 'A1': summary.A1++; summary.actual++; break;
                        case 'B': summary.B++; summary.actual++; summary.night++; break;
                        case '非': summary.non++; summary.actual++; break;
                        case '×': summary.off++; break;
                        case '年': summary.year++; summary.actual++; break;
                        case '出': summary.trip++; summary.actual++; break;
                        case '研': summary.training++; summary.actual++; break;
                    }
                    
                    row.appendChild(cell);
                });
                
                // サマリーセル
                const summaryValues = [summary.A, summary.A1, summary.B, summary.non, summary.off, summary.year, summary.trip, summary.training, summary.holidays, summary.actual, summary.night];
                summaryValues.forEach(value => {
                    const cell = document.createElement('td');
                    cell.className = 'summary-cell';
                    cell.textContent = value;
                    row.appendChild(cell);
                });
                
                tbody.appendChild(row);
            });
            
            table.appendChild(tbody);
            
            // フッター（集計行）
            const tfoot = this.createFooterSummary();
            table.appendChild(tfoot);
            
            return table;
        }

        createFooterSummary() {
            const tfoot = document.createElement('tfoot');
            
            const footerTypes = [
                { label: 'OPE(A)', filter: (ce, status) => ce.workType === 'OPE' && status === 'A' },
                { label: 'OPE(A1)', filter: (ce, status) => ce.workType === 'OPE' && status === 'A1' },
                { label: 'ME', filter: (ce, status) => ce.workType === 'ME' && ['A', 'A1', 'B', '非', '年', '出', '研'].includes(status) },
                { label: 'HD', filter: (ce, status) => ce.workType === 'HD' && ['A', 'A1', 'B', '非', '年', '出', '研'].includes(status) },
                { label: 'FLEX', filter: (ce, status) => ce.workType === 'FLEX' && ['A', 'A1', 'B', '非', '年', '出', '研'].includes(status) },
                { label: '当直', filter: (ce, status) => status === 'B' },
                { label: '非番', filter: (ce, status) => status === '非' }
            ];

            footerTypes.forEach(type => {
                const row = document.createElement('tr');
                row.className = 'footer-summary-row';
                
                const labelCell = document.createElement('th');
                labelCell.className = 'name-cell';
                labelCell.textContent = type.label;
                row.appendChild(labelCell);
                
                this.currentPeriod.dates.forEach(date => {
                    const dateKey = this.formatDateInput(date);
                    let count = 0;
                    
                    this.ceList.forEach(ce => {
                        const workData = this.scheduleData[ce.id]?.[dateKey] || {};
                        const status = workData.status || (date.getDay() === 0 || date.getDay() === 6 ? '×' : 'A');
                        if (type.filter(ce, status)) {
                            count++;
                        }
                    });
                    
                    const cell = document.createElement('td');
                    cell.textContent = count;
                    
                    // 警告表示（当直・非番が0人または2人以上）
                    if ((type.label === '当直' || type.label === '非番') && (count === 0 || count >= 2)) {
                        cell.classList.add('warning-count');
                    }
                    
                    row.appendChild(cell);
                });
                
                // 空のサマリーセル
                for (let i = 0; i < 11; i++) {
                    const cell = document.createElement('td');
                    row.appendChild(cell);
                }
                
                tfoot.appendChild(row);
            });
            
            return tfoot;
        }

        setupTableEventListeners() {
            const table = document.querySelector('.work-schedule-table');
            if (!table) return;

            // セル選択
            table.addEventListener('mousedown', (e) => this.handleCellMouseDown(e));
            table.addEventListener('mouseover', (e) => this.handleCellMouseOver(e));
            table.addEventListener('mouseup', () => this.handleCellMouseUp());
            table.addEventListener('contextmenu', (e) => this.handleCellRightClick(e));

            // ドラッグ無効化
            table.addEventListener('dragstart', (e) => e.preventDefault());
            table.addEventListener('selectstart', (e) => e.preventDefault());
        }

        handleCellMouseDown(e) {
            if (!e.target.classList.contains('work-cell')) return;
            
            this.isSelecting = true;
            
            if (this.selectionMode === 'single') {
                this.clearSelection();
                this.selectCell(e.target);
            } else if (this.selectionMode === 'range') {
                if (this.selectedCells.length === 0) {
                    this.selectCell(e.target);
                }
            } else if (this.selectionMode === 'column') {
                this.selectColumn(e.target.dataset.date);
            }
        }

        handleCellMouseOver(e) {
            if (!this.isSelecting || !e.target.classList.contains('work-cell')) return;
            
            if (this.selectionMode === 'range' && this.selectedCells.length > 0) {
                this.selectRange(this.selectedCells[0], e.target);
            }
        }

        handleCellMouseUp() {
            this.isSelecting = false;
        }

        handleCellRightClick(e) {
            if (!e.target.classList.contains('work-cell')) return;
            
            e.preventDefault();
            this.clearSelection();
            this.selectCell(e.target);
            this.showContextMenu(e.pageX, e.pageY);
        }

        selectCell(cell) {
            if (!cell.classList.contains('selected')) {
                cell.classList.add('selected');
                this.selectedCells.push(cell);
            }
        }

        selectRange(startCell, endCell) {
            this.clearSelection();
            
            const startCeIndex = this.ceList.findIndex(ce => ce.id === startCell.dataset.ceId);
            const endCeIndex = this.ceList.findIndex(ce => ce.id === endCell.dataset.ceId);
            const startDate = new Date(startCell.dataset.date);
            const endDate = new Date(endCell.dataset.date);
            
            const minCeIndex = Math.min(startCeIndex, endCeIndex);
            const maxCeIndex = Math.max(startCeIndex, endCeIndex);
            const minDate = new Date(Math.min(startDate, endDate));
            const maxDate = new Date(Math.max(startDate, endDate));
            
            for (let ceIndex = minCeIndex; ceIndex <= maxCeIndex; ceIndex++) {
                const ce = this.ceList[ceIndex];
                const current = new Date(minDate);
                
                while (current <= maxDate) {
                    const dateKey = this.formatDateInput(current);
                    const cell = document.querySelector(`[data-ce-id="${ce.id}"][data-date="${dateKey}"]`);
                    if (cell) {
                        this.selectCell(cell);
                    }
                    current.setDate(current.getDate() + 1);
                }
            }
        }

        selectColumn(date) {
            this.clearSelection();
            this.ceList.forEach(ce => {
                const cell = document.querySelector(`[data-ce-id="${ce.id}"][data-date="${date}"]`);
                if (cell) {
                    this.selectCell(cell);
                }
            });
        }

        clearSelection() {
            this.selectedCells.forEach(cell => {
                cell.classList.remove('selected');
            });
            this.selectedCells = [];
        }

        showContextMenu(x, y) {
            const menu = document.getElementById('contextMenu');
            menu.style.display = 'grid';
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
        }

        hideContextMenu() {
            document.getElementById('contextMenu').style.display = 'none';
        }

        // ✅ 最適化：履歴管理付きステータス適用
        applyStatusToSelection(status) {
            if (this.selectedCells.length === 0) return;
            
            // 履歴保存
            this.saveToHistory();
            
            this.selectedCells.forEach(cell => {
                const ceId = cell.dataset.ceId;
                const date = cell.dataset.date;
                
                if (!this.scheduleData[ceId]) {
                    this.scheduleData[ceId] = {};
                }
                if (!this.scheduleData[ceId][date]) {
                    this.scheduleData[ceId][date] = {};
                }
                
                this.scheduleData[ceId][date].status = status;
                
                // セルの見た目を更新
                cell.textContent = status;
                cell.className = 'work-cell';
                cell.classList.add(`status-${status}`);
                
                if (this.scheduleData[ceId][date].desired) {
                    cell.classList.add('desired');
                }
                
                const dateObj = new Date(date);
                if (dateObj.getDay() === 0 || dateObj.getDay() === 6) {
                    cell.classList.add('holiday');
                }
            });
            
            this.clearSelection();
            this.hideContextMenu();
            this.updateSummary();
        }

        updateSummary() {
            // サマリー行とフッター集計を更新
            this.renderScheduleTable();
        }

        saveToHistory() {
            // 現在の状態を履歴に保存
            this.history = this.history.slice(0, this.historyIndex + 1);
            this.history.push(JSON.parse(JSON.stringify(this.scheduleData)));
            this.historyIndex++;
            
            // 履歴サイズ制限
            if (this.history.length > 50) {
                this.history.shift();
                this.historyIndex--;
            }
        }

        undo() {
            if (this.historyIndex > 0) {
                this.historyIndex--;
                this.scheduleData = JSON.parse(JSON.stringify(this.history[this.historyIndex]));
                this.renderScheduleTable();
                
                if (window.Utils) {
                    window.Utils.showMessage('操作を取り消しました', 'info');
                }
            }
        }

        redo() {
            if (this.historyIndex < this.history.length - 1) {
                this.historyIndex++;
                this.scheduleData = JSON.parse(JSON.stringify(this.history[this.historyIndex]));
                this.renderScheduleTable();
                
                if (window.Utils) {
                    window.Utils.showMessage('操作をやり直しました', 'info');
                }
            }
        }

        autoFill() {
            if (window.Utils) {
                window.Utils.showMessage('自動配置機能（実装予定）', 'info');
            }
        }

        handleKeyboard(e) {
            if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                    case 'z':
                        e.preventDefault();
                        if (e.shiftKey) {
                            this.redo();
                        } else {
                            this.undo();
                        }
                        break;
                    case 's':
                        e.preventDefault();
                        this.showSaveModal();
                        break;
                }
            }
        }

        showSaveModal() {
            if (!this.currentPeriod) {
                if (window.Utils) {
                    window.Utils.showMessage('保存する勤務表がありません', 'warning');
                }
                return;
            }
            
            const modal = document.getElementById('saveConfirmModal');
            const nameInput = document.getElementById('scheduleNameInput');
            
            // デフォルト名を設定
            const startDate = this.currentPeriod.startDate;
            const defaultName = `${startDate.getFullYear()}年${startDate.getMonth() + 1}月期勤務表`;
            nameInput.value = defaultName;
            
            modal.style.display = 'flex';
            nameInput.focus();
        }

        hideSaveModal() {
            document.getElementById('saveConfirmModal').style.display = 'none';
        }

        // ✅ 最適化：バッチ更新を使用した保存
        async saveSchedule() {
            const scheduleName = document.getElementById('scheduleNameInput').value.trim();
            const description = document.getElementById('scheduleDescInput').value.trim();
            
            if (!scheduleName) {
                if (window.Utils) {
                    window.Utils.showMessage('保存名を入力してください', 'warning');
                }
                return;
            }

            try {
                // ✅ ローディング表示
                if (window.Utils) {
                    window.Utils.showLoading(true, '勤務表を保存中...');
                }

                const periodKey = `${this.currentPeriod.startDate.getTime()}_${Date.now()}`;
                const saveData = {
                    metadata: {
                        name: scheduleName,
                        description: description,
                        startDate: this.formatDateInput(this.currentPeriod.startDate),
                        endDate: this.formatDateInput(this.currentPeriod.endDate),
                        createdAt: Date.now(),
                        createdBy: window.currentUserData.uid,
                        createdByName: window.currentUserData.displayName || window.currentUserData.username
                    },
                    scheduleData: this.scheduleData
                };

                // ✅ 最適化：dataManagerのbatchUpdateを使用
                if (window.dataManager) {
                    const updates = {};
                    updates[`${window.DATA_ROOT}/workSchedules/${periodKey}`] = saveData;
                    
                    // 監査ログも同時に保存
                    const auditEntry = {
                        action: 'create_work_schedule',
                        details: { name: scheduleName, period: `${saveData.metadata.startDate} - ${saveData.metadata.endDate}` },
                        uid: window.currentUserData.uid,
                        username: window.currentUserData.username,
                        displayName: window.currentUserData.displayName,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    };
                    updates[`${window.DATA_ROOT}/auditLogs/${Date.now()}`] = auditEntry;
                    
                    await window.dataManager.batchUpdate(updates);
                } else {
                    await window.database.ref(`${window.DATA_ROOT}/workSchedules/${periodKey}`).set(saveData);
                }

                this.hideSaveModal();
                
                if (window.Utils) {
                    window.Utils.showMessage('勤務表を保存しました', 'success');
                }

            } catch (error) {
                console.error('❌ 勤務表保存エラー:', error);
                if (window.Utils) {
                    window.Utils.showMessage('保存に失敗しました', 'error');
                }
            } finally {
                if (window.Utils) {
                    window.Utils.showLoading(false);
                }
            }
        }

        previewSchedule() {
            if (!this.currentPeriod) {
                if (window.Utils) {
                    window.Utils.showMessage('プレビューする勤務表がありません', 'warning');
                }
                return;
            }
            
            // 新しいウィンドウでプレビュー表示
            const previewWindow = window.open('', '_blank', 'width=1200,height=800');
            const previewContent = this.generatePreviewHTML();
            previewWindow.document.write(previewContent);
            previewWindow.document.close();
        }

        generatePreviewHTML() {
            const table = document.querySelector('.work-schedule-table');
            if (!table) return '<html><body><p>プレビューできません</p></body></html>';
            
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>勤務表プレビュー</title>
                    <style>
                        body { font-family: 'Noto Sans JP', sans-serif; margin: 20px; }
                        table { border-collapse: collapse; font-size: 12px; }
                        th, td { border: 1px solid #ccc; padding: 4px; text-align: center; }
                        .name-header, .name-cell { min-width: 120px; background: #f9fafb; font-weight: 600; }
                        .date-header { background: #f3f4f6; font-weight: 600; }
                        .weekend-header { background: #fef2f2; color: #dc2626; }
                        .summary-header, .summary-cell { background: #f9fafb; font-weight: 600; }
                        .footer-summary-row { background: #f3f4f6; font-weight: 600; }
                        .warning-count { background: #fecaca !important; color: #dc2626 !important; font-weight: bold; }
                        @media print { body { margin: 0; } }
                    </style>
                </head>
                <body>
                    <h2>勤務表プレビュー</h2>
                    <p>期間: ${this.formatDateInput(this.currentPeriod.startDate)} ～ ${this.formatDateInput(this.currentPeriod.endDate)}</p>
                    ${table.outerHTML}
                    <script>
                        window.onload = () => {
                            if (confirm('印刷しますか？')) {
                                window.print();
                            }
                        };
                    </script>
                </body>
                </html>
            `;
        }

        exportSchedule() {
            if (!this.currentPeriod) {
                if (window.Utils) {
                    window.Utils.showMessage('エクスポートする勤務表がありません', 'warning');
                }
                return;
            }

            // CSV形式でエクスポート
            const csvData = this.generateCSV();
            this.downloadCSV(csvData, `勤務表_${this.formatDateInput(this.currentPeriod.startDate)}.csv`);
            
            if (window.Utils) {
                window.Utils.showMessage('勤務表をエクスポートしました', 'success');
            }
        }

        generateCSV() {
            const headers = ['氏名', '勤務区分'];
            this.currentPeriod.dates.forEach(date => {
                const dayOfWeek = ['日', '月', '火', '水', '木', '金', '土'][date.getDay()];
                headers.push(`${date.getMonth() + 1}/${date.getDate()}(${dayOfWeek})`);
            });
            
            const rows = [headers];
            
            this.ceList.forEach(ce => {
                const row = [ce.fullName || ce.name || '', ce.workType];
                this.currentPeriod.dates.forEach(date => {
                    const dateKey = this.formatDateInput(date);
                    const workData = this.scheduleData[ce.id]?.[dateKey] || {};
                    const status = workData.status || (date.getDay() === 0 || date.getDay() === 6 ? '×' : 'A');
                    row.push(status);
                });
                rows.push(row);
            });
            
            return rows.map(row => 
                row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
            ).join('\n');
        }

        downloadCSV(csv, filename) {
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        hideNoScheduleMessage() {
            const message = document.getElementById('noScheduleMessage');
            if (message) {
                message.style.display = 'none';
            }
        }

        redirectToLogin() {
            sessionStorage.clear();
            window.location.href = '../index.html';
        }

        showInterface() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('mainInterface').style.display = 'block';
        }
    }

    // ✅ 初期化
    if (!window.workScheduleEditorInitialized) {
        window.workScheduleEditorInitialized = true;
        document.addEventListener('DOMContentLoaded', () => {
            window.workScheduleEditor = new WorkScheduleEditor();
        });
    }
    </script>
</body>
</html>
