<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€±é–“è¡¨ç¤º - CEã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  V2</title>
    
    <!-- å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/theme-unified.css?v=20241217">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="../js/config/firebase-config.js"></script>

    <!-- ç›£æŸ»ãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ  -->
    <script src="../js/utils/audit-logger.js"></script>

    <!-- æ—¢å­˜ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« -->
    <script src="../js/data/constants.js?v=20241213"></script>
    <script src="../js/utils/ui-utils.js?v=20241213"></script>
    <script src="../js/utils/date-utils.js?v=20241213"></script>
    <script src="../js/core/auth-guard.js"></script>
    <script src="../js/ui/ce-manager.js?v=20241213"></script>
    <script src="../js/schedule/published-schedule-resolver.js"></script>

    <style>
        /* é€±é–“è¡¨ç¤ºå°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .weekly-container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
        }

        .weekly-header {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.95));
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .weekly-navigation {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
        }

        .weekly-filter {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .filter-checkboxes {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
        }

        .filter-checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .filter-checkbox-label:hover {
            background: rgba(0,0,0,0.05);
        }

        /* ç”»é¢ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæ”¹å–„: 7åˆ—å›ºå®šï¼ˆæœˆã€œæ—¥ï¼‰ */
        .weekly-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }

        .day-card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }

        .day-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .day-card.today {
            border-color: #3b82f6;
            border-width: 2px;
        }

        .day-card-header {
            text-align: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid rgba(0,0,0,0.1);
        }

        .day-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .day-title.today {
            color: #3b82f6;
        }

        .day-summary {
            text-align: center;
            margin-bottom: 16px;
            padding: 12px;
            background: rgba(255,255,255,0.5);
            border-radius: 8px;
        }

        .department-section {
            background: rgba(255,255,255,0.85);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            border-left: 4px solid var(--dept-color);
        }

        .dept-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .dept-name {
            font-weight: bold;
            font-size: 14px;
        }

        .task-item {
            background: rgba(255,255,255,0.9);
            border-radius: 8px;
            padding: 8px;
            margin: 6px 0;
            border-left: 3px solid var(--dept-color);
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .task-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.12);
        }

        .task-title {
            font-weight: bold;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .task-info {
            font-size: 11px;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .task-memo {
            font-size: 10px;
            color: #059669;
            background: #f0fdf4;
            padding: 4px 6px;
            border-radius: 4px;
            margin-top: 4px;
            font-style: italic;
            border-left: 2px solid #10b981;
        }

        .ce-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 6px;
        }

        .ce-chip {
            display: inline-flex;
            align-items: center;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 500;
            white-space: nowrap;
            position: relative;
        }

        /* å‹¤å‹™åŒºåˆ†åˆ¥è‰²åˆ†ã‘ */
        .ce-chip.worktype-ope { background: #07E1FF; color: #1E3A8A; }
        .ce-chip.worktype-me { background: #CCFFCC; color: #006400; }
        .ce-chip.worktype-hd { background: #FFBCD4; color: #8B008B; }
        .ce-chip.worktype-flex { background: #FFFF00; color: #B8860B; }
        .ce-chip.worktype-error { background: #fee2e2; color: #dc2626; }

        .status-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            background: #4CAF50;
            color: white;
            font-size: 7px;
            padding: 1px 2px;
            border-radius: 2px;
            font-weight: bold;
            line-height: 1;
        }

        .status-badge.status-A1 { background: #0000FF; }
        .status-badge.status-Ã— { background: #FFFFFF; color: #333; border: 1px solid #ddd; }
        .status-badge.status-å¹´ { background: #2196F3; }
        .status-badge.status-å‡º { background: #2196F3; }
        .status-badge.status-ç ” { background: #795548; }

        .monthly-badge {
            background: #f97316;
            color: white;
            font-size: 8px;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: bold;
            margin-left: 4px;
        }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        /* å°åˆ·ãƒ¢ãƒ¼ãƒ‰é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« - ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæ”¹å–„ */
        .print-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .print-modal.active {
            display: flex;
        }

        .print-modal-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .print-modal h2 {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 8px;
            color: #1f2937;
        }

        .print-modal-subtitle {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 24px;
        }

        .print-options-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 24px;
        }

        .print-option {
            display: flex;
            align-items: flex-start;
            padding: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .print-option:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .print-option input[type="radio"] {
            margin-top: 4px;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .print-option-content {
            flex: 1;
        }

        .print-option-title {
            font-weight: bold;
            font-size: 1rem;
            margin-bottom: 4px;
            color: #1f2937;
        }

        .print-option-description {
            font-size: 0.875rem;
            color: #6b7280;
            line-height: 1.5;
        }

        .print-option-note {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-top: 4px;
        }

        .print-modal-buttons {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .print-modal-buttons button {
            flex: 1;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
        }

        .print-modal-buttons .btn-cancel {
            background: #f3f4f6;
            color: #374151;
        }

        .print-modal-buttons .btn-cancel:hover {
            background: #e5e7eb;
        }

        .print-modal-buttons .btn-execute {
            background: #3b82f6;
            color: white;
        }

        .print-modal-buttons .btn-execute:hover {
            background: #2563eb;
        }

        .print-hint-box {
            padding: 16px;
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
        }

        .print-hint-title {
            font-weight: bold;
            font-size: 0.875rem;
            color: #1e40af;
            margin-bottom: 8px;
        }

        .print-hint-list {
            font-size: 0.75rem;
            color: #1e40af;
            line-height: 1.6;
        }

        /* å°åˆ·ç”¨ã‚¹ã‚¿ã‚¤ãƒ« - ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼ˆé€±å…¨ä½“ã‚’1ãƒšãƒ¼ã‚¸ï¼‰ */
        @media print {
            @page {
                size: A4 landscape;
                margin: 10mm;
            }

            .no-print {
                display: none !important;
            }

            body {
                background: white;
                font-size: 9px;
            }

            .weekly-container {
                max-width: 100%;
                padding: 0;
                margin: 0;
            }

            .weekly-header {
                background: white;
                box-shadow: none;
                border: 1px solid #ddd;
                padding: 8px;
                margin-bottom: 8px;
                page-break-after: avoid;
            }

            .weekly-header h1 {
                font-size: 14px;
            }

            .weekly-filter {
                display: none;
            }

            /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼ˆ1ãƒšãƒ¼ã‚¸ï¼‰ */
            body:not(.print-mode-department) .weekly-grid {
                display: grid;
                grid-template-columns: repeat(7, 1fr);
                gap: 4px;
                page-break-inside: avoid;
            }

            body:not(.print-mode-department) .day-card {
                background: white;
                border: 1px solid #ddd;
                box-shadow: none;
                padding: 4px;
                page-break-inside: avoid;
                font-size: 8px;
            }

            body:not(.print-mode-department) .day-card-header {
                padding-bottom: 4px;
                margin-bottom: 4px;
            }

            body:not(.print-mode-department) .day-title {
                font-size: 10px;
            }

            body:not(.print-mode-department) .day-summary {
                padding: 4px;
                margin-bottom: 4px;
                font-size: 8px;
            }

            body:not(.print-mode-department) .department-section {
                padding: 4px;
                margin-bottom: 4px;
            }

            body:not(.print-mode-department) .dept-header {
                margin-bottom: 2px;
            }

            body:not(.print-mode-department) .dept-name {
                font-size: 9px;
            }

            body:not(.print-mode-department) .task-item {
                page-break-inside: avoid;
                font-size: 7px;
                padding: 3px;
                margin: 2px 0;
            }

            body:not(.print-mode-department) .task-title {
                font-size: 8px;
            }

            body:not(.print-mode-department) .task-info {
                font-size: 7px;
            }

            body:not(.print-mode-department) .task-memo {
                font-size: 7px;
                padding: 2px 4px;
                margin-top: 2px;
            }

            body:not(.print-mode-department) .ce-chip {
                font-size: 7px;
                padding: 1px 3px;
                border: 1px solid #ddd;
            }

            /* éƒ¨é–€åˆ¥ãƒ¢ãƒ¼ãƒ‰ */
            body.print-mode-department .weekly-grid {
                display: block;
            }

            body.print-mode-department .day-card {
                background: white;
                border: 1px solid #ddd;
                box-shadow: none;
                padding: 8px;
                margin-bottom: 12px;
                page-break-inside: avoid;
            }

            body.print-mode-department .department-section {
                page-break-after: always;
                padding: 12px;
                margin-bottom: 0;
            }

            body.print-mode-department .department-section:last-child {
                page-break-after: auto;
            }

            .day-card:hover {
                transform: none;
                box-shadow: none;
            }
        }

        /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆå¯¾å¿œ: æœˆã€œé‡‘ã®5åˆ—è¡¨ç¤º */
        @media (max-width: 1400px) and (min-width: 769px) {
            .weekly-grid {
                grid-template-columns: repeat(5, 1fr);
            }
        }

        /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
        @media (max-width: 768px) {
            .weekly-container {
                padding: 12px;
            }

            .weekly-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .filter-checkboxes {
                flex-direction: column;
                gap: 8px;
            }

            .day-card {
                padding: 12px;
            }
        }
    </style>

    <!-- PWAè¨­å®š -->
    <link rel="manifest" href="../manifest.webmanifest">
    <meta name="theme-color" content="#34495E">
    <link rel="icon" type="image/x-icon" href="../assets/icons/app-icons/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="../assets/icons/app-icons/apple-touch-icon.png">
</head>
<body class="theme-unified">
    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
    <div id="loading" class="loading-overlay">
        <div class="text-center">
            <div class="spinner mb-4"></div>
            <p class="text-gray-600">é€±é–“ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
        </div>
    </div>

    <!-- å°åˆ·ãƒ¢ãƒ¼ãƒ‰é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="printModal" class="print-modal no-print">
        <div class="print-modal-content">
            <h2>
                <i class="fas fa-print mr-2 text-blue-600"></i>å°åˆ·ãƒ¢ãƒ¼ãƒ‰é¸æŠ
            </h2>
            <p class="print-modal-subtitle">å°åˆ·ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</p>

            <div class="print-options-container">
                <!-- ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãƒ¢ãƒ¼ãƒ‰ -->
                <label class="print-option">
                    <input type="radio" name="printMode" value="compact" checked>
                    <div class="print-option-content">
                        <div class="print-option-title">
                            <i class="fas fa-compress-alt mr-2 text-green-600"></i>ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼ˆæ¨å¥¨ï¼‰
                        </div>
                        <div class="print-option-description">
                            é€±å…¨ä½“ã‚’1ãƒšãƒ¼ã‚¸ã«åã‚ã¾ã™ï¼ˆA4æ¨ªå‘ãæ¨å¥¨ï¼‰
                        </div>
                        <div class="print-option-note">
                            â€»æœ€ã‚‚ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã§è¦‹ã‚„ã™ã„
                        </div>
                    </div>
                </label>

                <!-- éƒ¨é–€åˆ¥ãƒ¢ãƒ¼ãƒ‰ -->
                <label class="print-option">
                    <input type="radio" name="printMode" value="department">
                    <div class="print-option-content">
                        <div class="print-option-title">
                            <i class="fas fa-layer-group mr-2 text-blue-600"></i>éƒ¨é–€åˆ¥ãƒ¢ãƒ¼ãƒ‰
                        </div>
                        <div class="print-option-description">
                            éƒ¨é–€ã”ã¨ã«æ”¹ãƒšãƒ¼ã‚¸ã—ã¦è©³ç´°è¡¨ç¤º
                        </div>
                        <div class="print-option-note">
                            â€»è¤‡æ•°ãƒšãƒ¼ã‚¸ã«ãªã‚Šã¾ã™ãŒè©³ç´°ãŒè¦‹ã‚„ã™ã„
                        </div>
                    </div>
                </label>
            </div>

            <div class="print-modal-buttons">
                <button id="cancelPrintBtn" class="btn-cancel">
                    <i class="fas fa-times mr-2"></i>ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button id="executePrintBtn" class="btn-execute">
                    <i class="fas fa-print mr-2"></i>å°åˆ·å®Ÿè¡Œ
                </button>
            </div>

            <div class="print-hint-box">
                <div class="print-hint-title">
                    <i class="fas fa-info-circle mr-1"></i>å°åˆ·ã®ãƒ’ãƒ³ãƒˆ
                </div>
                <div class="print-hint-list">
                    â€¢ ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãƒ¢ãƒ¼ãƒ‰ã¯<strong>A4æ¨ªå‘ã</strong>ãŒãŠã™ã™ã‚ã§ã™<br>
                    â€¢ å°åˆ·ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã§ã€ŒèƒŒæ™¯ã®ã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯ã€ã‚’ONã«ã™ã‚‹ã¨è‰²ãŒè¡¨ç¤ºã•ã‚Œã¾ã™<br>
                    â€¢ PDFã¨ã—ã¦ä¿å­˜ã™ã‚‹å ´åˆã¯ã€Œé€ä¿¡å…ˆã€ã‚’ã€ŒPDFã«ä¿å­˜ã€ã«å¤‰æ›´ã—ã¦ãã ã•ã„
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div id="mainContent" class="weekly-container" style="display:none;">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="weekly-header">
            <div class="flex items-center justify-between mb-4">
                <h1 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-calendar-week mr-2 text-blue-600"></i>
                    é€±é–“ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
                </h1>
                <div class="flex gap-2 no-print">
                    <button id="printPdfBtn" class="btn-unified btn-primary-unified btn-small">
                        <i class="fas fa-file-pdf mr-1"></i>PDFå‡ºåŠ›
                    </button>
                    <a href="./schedule.html" class="btn-unified btn-outline-unified btn-small">
                        <i class="fas fa-calendar-day mr-1"></i>æ—¥åˆ¥è¡¨ç¤º
                    </a>
                    <a href="../home.html" class="btn-unified btn-outline-unified btn-small">
                        <i class="fas fa-home mr-1"></i>ãƒ›ãƒ¼ãƒ 
                    </a>
                </div>
            </div>

            <!-- é€±ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <div class="weekly-navigation">
                <button id="prevWeekBtn" class="btn-unified btn-outline-unified btn-small">
                    <i class="fas fa-chevron-left mr-1"></i>å‰é€±
                </button>
                <div class="text-center">
                    <h2 id="weekTitle" class="text-xl font-bold text-gray-800"></h2>
                    <p id="weekRange" class="text-sm text-gray-600"></p>
                </div>
                <button id="nextWeekBtn" class="btn-unified btn-outline-unified btn-small">
                    æ¬¡é€±<i class="fas fa-chevron-right ml-1"></i>
                </button>
            </div>
        </div>

        <!-- éƒ¨é–€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
        <div class="weekly-filter no-print">
            <div class="flex items-center justify-between mb-3">
                <h3 class="font-bold text-gray-700">
                    <i class="fas fa-filter mr-2"></i>éƒ¨é–€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
                </h3>
                <div>
                    <button id="filterSelectAll" class="text-sm text-blue-600 hover:text-blue-800 mr-3">
                        ã™ã¹ã¦é¸æŠ
                    </button>
                    <button id="filterDeselectAll" class="text-sm text-gray-600 hover:text-gray-800">
                        ã™ã¹ã¦è§£é™¤
                    </button>
                </div>
            </div>
            <div id="departmentFilters" class="filter-checkboxes"></div>
        </div>

        <!-- é€±é–“ã‚°ãƒªãƒƒãƒ‰ -->
        <div id="weekGrid" class="weekly-grid"></div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentWeekStart = null;
        let allScheduleData = null;
        let selectedDepartments = new Set();

        // ãƒšãƒ¼ã‚¸åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('âœ… é€±é–“è¡¨ç¤ºãƒšãƒ¼ã‚¸åˆæœŸåŒ–é–‹å§‹');
            
            try {
                // èªè¨¼ç¢ºèª
                if (!window.authGuard) {
                    throw new Error('èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                }
                
                await window.authGuard.initialize();
                const currentUser = window.authGuard.getCurrentUser();
                
                if (!currentUser) {
                    console.warn('âš ï¸ æœªèªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ - ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ');
                    window.location.href = '../pages/login.html';
                    return;
                }
                
                console.log('âœ… èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼:', currentUser.email);
                
                // CEä¸€è¦§å–å¾—
                if (window.ceManager) {
                    await window.ceManager.loadCEList();
                    console.log('âœ… CEä¸€è¦§å–å¾—å®Œäº†');
                }
                
                // ä»Šé€±ã®æœˆæ›œæ—¥ã‚’å–å¾—
                currentWeekStart = getMonday(new Date());
                console.log('ğŸ“… ä»Šé€±ã®é–‹å§‹æ—¥:', currentWeekStart.toLocaleDateString('ja-JP'));
                
                // éƒ¨é–€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼åˆæœŸåŒ–
                initializeDepartmentFilters();
                
                // é€±é–“ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
                await loadWeekData();
                
                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
                setupEventListeners();
                
                // è¡¨ç¤º
                document.getElementById('loading').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                
                console.log('âœ… é€±é–“è¡¨ç¤ºãƒšãƒ¼ã‚¸åˆæœŸåŒ–å®Œäº†');
                
            } catch (error) {
                console.error('âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒšãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n' + error.message);
                document.getElementById('loading').style.display = 'none';
            }
        });

        // æœˆæ›œæ—¥ã‚’å–å¾—
        function getMonday(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        // é€±ã®æ—¥ä»˜é…åˆ—ã‚’ç”Ÿæˆï¼ˆæœˆã€œæ—¥ï¼‰
        function getWeekDates(startDate) {
            const dates = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                dates.push(date);
            }
            return dates;
        }

        // æ—¥ä»˜ã‚’ã‚­ãƒ¼ã«å¤‰æ›ï¼ˆYYYYMMDDï¼‰
        function dateToKey(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}${m}${d}`;
        }

        // éƒ¨é–€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼åˆæœŸåŒ–
        function initializeDepartmentFilters() {
            const filterContainer = document.getElementById('departmentFilters');
            const departments = window.DEPARTMENT_COLORS || {
                'æ‰‹è¡“éƒ¨': '#E6A8D7',
                'è¡€ç®¡æ’®å½±': '#FFB3BA',
                'MEå®¤': '#B0E57C',
                'æ”¾å°„ç·š': '#FFD59E',
                'ä¸æ•´è„ˆ': '#AEC6CF',
                'ç”Ÿç†æ¤œæŸ»': '#F4C2C2',
                'äººå·¥å¿ƒè‚º': '#D4A5A5',
                'å¿ƒã‚«ãƒ†': '#C9A0DC'
            };

            // localStorageã‹ã‚‰ä¿å­˜ã•ã‚ŒãŸãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®šã‚’èª­ã¿è¾¼ã¿
            const savedFilters = localStorage.getItem('weeklyDepartmentFilters');
            if (savedFilters) {
                selectedDepartments = new Set(JSON.parse(savedFilters));
            } else {
                // åˆå›ã¯ã™ã¹ã¦é¸æŠ
                selectedDepartments = new Set(Object.keys(departments));
            }

            filterContainer.innerHTML = '';
            
            Object.entries(departments).forEach(([dept, color]) => {
                const label = document.createElement('label');
                label.className = 'filter-checkbox-label';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = dept;
                checkbox.checked = selectedDepartments.has(dept);
                checkbox.addEventListener('change', handleFilterChange);
                
                const colorBox = document.createElement('span');
                colorBox.style.cssText = `
                    display: inline-block;
                    width: 16px;
                    height: 16px;
                    background: ${color};
                    border-radius: 4px;
                    border: 1px solid rgba(0,0,0,0.2);
                `;
                
                const text = document.createElement('span');
                text.textContent = dept;
                
                label.appendChild(checkbox);
                label.appendChild(colorBox);
                label.appendChild(text);
                filterContainer.appendChild(label);
            });
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¤‰æ›´ãƒãƒ³ãƒ‰ãƒ©
        function handleFilterChange(e) {
            const dept = e.target.value;
            if (e.target.checked) {
                selectedDepartments.add(dept);
            } else {
                selectedDepartments.delete(dept);
            }
            
            // localStorageã«ä¿å­˜
            localStorage.setItem('weeklyDepartmentFilters', JSON.stringify([...selectedDepartments]));
            
            // è¡¨ç¤ºæ›´æ–°
            renderWeekGrid();
        }

        // é€±é–“ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadWeekData() {
            try {
                console.log('ğŸ“Š é€±é–“ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹');
                
                const weekDates = getWeekDates(currentWeekStart);
                const startKey = dateToKey(weekDates[0]);
                const endKey = dateToKey(weekDates[6]);
                
                // ã‚¿ã‚¤ãƒˆãƒ«æ›´æ–°
                updateWeekTitle(weekDates);
                
                // Firebase ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—
                const scheduleRef = firebase.database().ref('schedules');
                const snapshot = await scheduleRef.orderByKey().startAt(startKey).endAt(endKey).once('value');
                
                allScheduleData = snapshot.val() || {};
                console.log('âœ… ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†:', Object.keys(allScheduleData).length, 'æ—¥åˆ†');
                
                // ã‚°ãƒªãƒƒãƒ‰æç”»
                renderWeekGrid();
                
            } catch (error) {
                console.error('âŒ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                throw error;
            }
        }

        // é€±ã‚¿ã‚¤ãƒˆãƒ«æ›´æ–°
        function updateWeekTitle(weekDates) {
            const weekTitle = document.getElementById('weekTitle');
            const weekRange = document.getElementById('weekRange');
            
            const startMonth = weekDates[0].getMonth() + 1;
            const startDay = weekDates[0].getDate();
            const endMonth = weekDates[6].getMonth() + 1;
            const endDay = weekDates[6].getDate();
            const year = weekDates[0].getFullYear();
            
            const today = new Date();
            const isThisWeek = weekDates.some(d => 
                d.toDateString() === today.toDateString()
            );
            
            weekTitle.textContent = isThisWeek ? 'ä»Šé€±' : `${year}å¹´ ${startMonth}/${startDay} - ${endMonth}/${endDay} ã®é€±`;
            weekRange.textContent = `${year}å¹´${startMonth}æœˆ${startDay}æ—¥ ã€œ ${year}å¹´${endMonth}æœˆ${endDay}æ—¥`;
        }

        // é€±é–“ã‚°ãƒªãƒƒãƒ‰æç”»
        async function renderWeekGrid() {
            const gridContainer = document.getElementById('weekGrid');
            const weekDates = getWeekDates(currentWeekStart);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            gridContainer.innerHTML = '';
            
            for (const date of weekDates) {
                const dateKey = dateToKey(date);
                const dayData = allScheduleData[dateKey] || {};
                
                // æ—¥ã‚«ãƒ¼ãƒ‰ä½œæˆ
                const dayCard = await createDayCard(date, dayData, date.getTime() === today.getTime());
                gridContainer.appendChild(dayCard);
            }
        }

        // æ—¥ã‚«ãƒ¼ãƒ‰ä½œæˆ
        async function createDayCard(date, dayData, isToday) {
            const card = document.createElement('div');
            card.className = 'day-card';
            if (isToday) card.classList.add('today');
            
            const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            const dayName = dayNames[date.getDay()];
            const month = date.getMonth() + 1;
            const day = date.getDate();
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼
            const header = document.createElement('div');
            header.className = 'day-card-header';
            header.innerHTML = `
                <div class="day-title ${isToday ? 'today' : ''}">
                    ${month}/${day} (${dayName})
                </div>
            `;
            card.appendChild(header);
            
            // éƒ¨é–€åˆ¥ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã¦è¡¨ç¤º
            const departments = window.DEPARTMENT_COLORS || {};
            const filteredDepts = Object.keys(departments).filter(dept => selectedDepartments.has(dept));
            
            if (filteredDepts.length === 0) {
                const emptyMsg = document.createElement('div');
                emptyMsg.className = 'text-center text-gray-400 py-4';
                emptyMsg.textContent = 'ãƒ•ã‚£ãƒ«ã‚¿ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“';
                card.appendChild(emptyMsg);
                return card;
            }
            
            let hasData = false;
            
            for (const dept of filteredDepts) {
                const deptData = dayData[dept];
                if (!deptData) continue;
                
                hasData = true;
                const deptSection = await createDepartmentSection(dept, deptData, dateToKey(date));
                card.appendChild(deptSection);
            }
            
            if (!hasData) {
                const emptyMsg = document.createElement('div');
                emptyMsg.className = 'text-center text-gray-400 py-4';
                emptyMsg.textContent = 'äºˆå®šãªã—';
                card.appendChild(emptyMsg);
            }
            
            return card;
        }

        // éƒ¨é–€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ä½œæˆ
        async function createDepartmentSection(deptName, deptData, dateKey) {
            const section = document.createElement('div');
            section.className = 'department-section';
            
            const color = (window.DEPARTMENT_COLORS || {})[deptName] || '#ccc';
            section.style.setProperty('--dept-color', color);
            
            const header = document.createElement('div');
            header.className = 'dept-header';
            header.innerHTML = `
                <span class="dept-name">${deptName}</span>
            `;
            section.appendChild(header);
            
            // æ¥­å‹™ä¸€è¦§
            const tasks = deptData.tasks || [];
            for (const task of tasks) {
                const taskItem = await createTaskItem(task, color, dateKey);
                section.appendChild(taskItem);
            }
            
            return section;
        }

        // æ¥­å‹™ã‚¢ã‚¤ãƒ†ãƒ ä½œæˆ
        async function createTaskItem(task, deptColor, dateKey) {
            const item = document.createElement('div');
            item.className = 'task-item';
            item.style.setProperty('--dept-color', deptColor);
            
            // ã‚¿ã‚¤ãƒˆãƒ«
            const title = document.createElement('div');
            title.className = 'task-title';
            
            const titleText = document.createElement('span');
            titleText.textContent = task.title || 'æ¥­å‹™';
            title.appendChild(titleText);
            
            // ãƒ¡ãƒ¢ã‚¢ã‚¤ã‚³ãƒ³
            if (task.description && task.description.trim()) {
                const memoIcon = document.createElement('span');
                memoIcon.innerHTML = '<i class="fas fa-sticky-note" style="color: #059669; cursor: pointer;" title="ãƒ¡ãƒ¢ã‚’è¡¨ç¤º"></i>';
                memoIcon.onclick = () => showMemoModal(task.title, task.description);
                title.appendChild(memoIcon);
            }
            
            item.appendChild(title);
            
            // æ‹…å½“CE
            if (task.assignedCEs && task.assignedCEs.length > 0) {
                const normalizedCEs = await normalizeAssignedCEs(task.assignedCEs);
                const ceChipsHtml = await generateCEChipsWithStatus(normalizedCEs, dateKey);
                
                const ceChips = document.createElement('div');
                ceChips.className = 'ce-chips';
                ceChips.innerHTML = ceChipsHtml;
                item.appendChild(ceChips);
            }
            
            return item;
        }

        // CEæƒ…å ±ã®æ­£è¦åŒ–
        async function normalizeAssignedCEs(assignedCEs) {
            if (!Array.isArray(assignedCEs)) {
                return [];
            }
            
            return assignedCEs.map(entry => {
                if (typeof entry === 'string') {
                    const ce = window.ceManager?.ceList?.find(c => c.id === entry);
                    return ce ? { 
                        id: ce.id, 
                        name: ce.iconName || ce.displayName || ce.name, 
                        workType: ce.workType || 'ME' 
                    } : { id: entry, name: entry, workType: 'ME' };
                } else if (entry && typeof entry === 'object') {
                    return { 
                        id: entry.id, 
                        name: entry.name, 
                        workType: entry.workType || 'ME' 
                    };
                }
                return null;
            }).filter(Boolean);
        }

        // CEå‹¤å‹™çŠ¶æ…‹ä»˜ããƒãƒƒãƒ—ç”Ÿæˆ
        async function generateCEChipsWithStatus(normalizedAssigned, dateKey) {
            const chips = [];
            
            for (const assigned of normalizedAssigned) {
                let effectiveWorkType = assigned.workType || 'ME';
                let statusBadge = '';
                let statusText = '';
                
                if (window.publishedScheduleResolver) {
                    try {
                        const workStatus = await window.publishedScheduleResolver.getCEWorkStatusForDate(assigned.id, dateKey);
                        if (workStatus?.workType) {
                            effectiveWorkType = workStatus.workType;
                        }
                        statusText = workStatus?.status || '';
                        if (statusText && statusText !== 'A') {
                            statusBadge = `<span class="status-badge status-${statusText}">${statusText}</span>`;
                        }
                    } catch (error) {
                        console.warn('âš ï¸ å‹¤å‹™çŠ¶æ…‹å–å¾—å¤±æ•—:', assigned.name, error);
                    }
                }
                
                const titleExtra = statusBadge ? ` (${statusText})` : '';
                chips.push(`
                    <span class="ce-chip worktype-${effectiveWorkType.toLowerCase()}" 
                          title="${escapeHtml(assigned.name)}${titleExtra}" 
                          style="position: relative;">
                        ${escapeHtml(assigned.name)}${statusBadge}
                    </span>
                `);
            }
            
            return chips.join('');
        }

        // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼ˆXSSå¯¾ç­–ï¼‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ãƒ¡ãƒ¢ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function showMemoModal(title, description) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                inset: 0;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10001;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                border-radius: 12px;
                padding: 24px;
                max-width: 500px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            `;
            
            content.innerHTML = `
                <h3 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 16px; color: #1f2937;">
                    <i class="fas fa-sticky-note mr-2 text-green-600"></i>${escapeHtml(title || 'æ¥­å‹™ãƒ¡ãƒ¢')}
                </h3>
                <div style="background: #f0fdf4; border-left: 4px solid #10b981; padding: 12px; border-radius: 4px; margin-bottom: 16px; white-space: pre-wrap; color: #059669; line-height: 1.6;">
                    ${escapeHtml(description)}
                </div>
                <button style="width: 100%; padding: 10px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                    <i class="fas fa-times mr-2"></i>é–‰ã˜ã‚‹
                </button>
            `;
            
            const closeBtn = content.querySelector('button');
            closeBtn.onclick = () => modal.remove();
            
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            
            modal.appendChild(content);
            document.body.appendChild(modal);
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        function setupEventListeners() {
            // å‰é€±ãƒ»æ¬¡é€±ãƒœã‚¿ãƒ³
            document.getElementById('prevWeekBtn').addEventListener('click', () => {
                currentWeekStart.setDate(currentWeekStart.getDate() - 7);
                loadWeekData();
            });
            
            document.getElementById('nextWeekBtn').addEventListener('click', () => {
                currentWeekStart.setDate(currentWeekStart.getDate() + 7);
                loadWeekData();
            });
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å…¨é¸æŠãƒ»å…¨è§£é™¤
            document.getElementById('filterSelectAll').addEventListener('click', () => {
                selectedDepartments = new Set(Object.keys(window.DEPARTMENT_COLORS || {}));
                localStorage.setItem('weeklyDepartmentFilters', JSON.stringify([...selectedDepartments]));
                document.querySelectorAll('#departmentFilters input[type="checkbox"]').forEach(cb => cb.checked = true);
                renderWeekGrid();
            });
            
            document.getElementById('filterDeselectAll').addEventListener('click', () => {
                selectedDepartments.clear();
                localStorage.setItem('weeklyDepartmentFilters', JSON.stringify([]));
                document.querySelectorAll('#departmentFilters input[type="checkbox"]').forEach(cb => cb.checked = false);
                renderWeekGrid();
            });
            
            // PDFå‡ºåŠ›ãƒœã‚¿ãƒ³
            document.getElementById('printPdfBtn').addEventListener('click', () => {
                const modal = document.getElementById('printModal');
                modal.classList.add('active');
            });
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹
            document.getElementById('cancelPrintBtn').addEventListener('click', () => {
                const modal = document.getElementById('printModal');
                modal.classList.remove('active');
            });
            
            // å°åˆ·å®Ÿè¡Œ
            document.getElementById('executePrintBtn').addEventListener('click', () => {
                const selectedMode = document.querySelector('input[name="printMode"]:checked').value;
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                const modal = document.getElementById('printModal');
                modal.classList.remove('active');
                
                // å°åˆ·ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦bodyã‚¯ãƒ©ã‚¹ã‚’è¨­å®š
                if (selectedMode === 'department') {
                    document.body.classList.add('print-mode-department');
                } else {
                    document.body.classList.remove('print-mode-department');
                }
                
                // å°åˆ·ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
                setTimeout(() => {
                    window.print();
                    // å°åˆ·å¾Œã«ã‚¯ãƒ©ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
                    document.body.classList.remove('print-mode-department');
                }, 100);
            });
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            document.getElementById('printModal').addEventListener('click', (e) => {
                if (e.target.id === 'printModal') {
                    e.target.classList.remove('active');
                }
            });
        }
    </script>
</body>
</html>
