<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  V2 - ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <button id="backBtn" class="mr-4 text-gray-600 hover:text-gray-800">
                        â† æˆ»ã‚‹
                    </button>
                    <h1 class="text-xl font-semibold text-gray-900">ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="adminNameDisplay" class="text-sm text-gray-600"></span>
                    <button id="logoutBtn" class="text-sm text-red-600 hover:text-red-800">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                </div>
            </div>
        </div>
    </header>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
        <div id="loadingIndicator" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6">
                <div class="flex items-center">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                    <span class="ml-3">èª­ã¿è¾¼ã¿ä¸­...</span>
                </div>
            </div>
        </div>

        <div class="px-4 py-6 sm:px-0">
            <!-- ç®¡ç†è€…ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç† -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</h3>
                    <p class="text-sm text-gray-600 mb-4">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¿½åŠ ã€å‰Šé™¤ã€æ¨©é™å¤‰æ›´</p>
                    <div class="space-y-2">
                        <button id="addUserBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm">
                            æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ 
                        </button>
                        <button id="manageUsersBtn" class="w-full bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md text-sm">
                            ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§
                        </button>
                    </div>
                </div>

                <!-- ã‚·ã‚¹ãƒ†ãƒ è¨­å®š -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</h3>
                    <p class="text-sm text-gray-600 mb-4">ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®è¨­å®šç®¡ç†</p>
                    <div class="space-y-2">
                        <button id="systemConfigBtn" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm">
                            åŸºæœ¬è¨­å®š
                        </button>
                        <button id="backupBtn" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-md text-sm">
                            ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
                        </button>
                    </div>
                </div>

                <!-- ç›£æŸ»ãƒ­ã‚° -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">ç›£æŸ»ãƒ­ã‚°</h3>
                    <p class="text-sm text-gray-600 mb-4">ã‚·ã‚¹ãƒ†ãƒ ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã®ç¢ºèª</p>
                    <div class="space-y-2">
                        <button id="viewLogsBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md text-sm">
                            ãƒ­ã‚°è¡¨ç¤º
                        </button>
                        <button id="exportLogsBtn" class="w-full bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md text-sm">
                            ãƒ­ã‚°ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                        </button>
                    </div>
                </div>
            </div>

            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ« -->
            <div class="bg-white rounded-lg shadow">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900">ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ãƒ¦ãƒ¼ã‚¶ãƒ¼å
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    æ¨©é™
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    æ“ä½œ
                                </th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒã“ã“ã«å‹•çš„ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="messageArea" class="fixed top-4 right-4 z-50"></div>

    <script>
        // Firebaseè¨­å®š
        const firebaseConfig = {
            databaseURL: "https://ce-schedule-management-default-rtdb.asia-southeast1.firebasedatabase.app/"
        };

        // FirebaseåˆæœŸåŒ–
        console.log('ğŸ”„ ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ FirebaseåˆæœŸåŒ–é–‹å§‹...');
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentUser = null;
        let userRole = null;
        let allUsers = {};

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        const Utils = {
            showMessage: function(message, type = 'info', duration = 3000) {
                const messageArea = document.getElementById('messageArea');
                const messageEl = document.createElement('div');
                
                const bgColor = {
                    'success': 'bg-green-500',
                    'error': 'bg-red-500',
                    'warning': 'bg-yellow-500',
                    'info': 'bg-blue-500'
                }[type] || 'bg-blue-500';

                messageEl.className = `${bgColor} text-white px-4 py-2 rounded-lg shadow-lg mb-2`;
                messageEl.textContent = message;
                
                messageArea.appendChild(messageEl);
                
                setTimeout(() => {
                    if (messageEl.parentNode) {
                        messageEl.parentNode.removeChild(messageEl);
                    }
                }, duration);
            },

            showLoading: function() {
                document.getElementById('loadingIndicator').style.display = 'flex';
            },

            hideLoading: function() {
                document.getElementById('loadingIndicator').style.display = 'none';
            },

            formatDate: function(timestamp) {
                if (!timestamp) return '-';
                const date = new Date(timestamp);
                return date.toLocaleDateString('ja-JP') + ' ' + date.toLocaleTimeString('ja-JP');
            }
        };

        // èªè¨¼çŠ¶æ…‹ç›£è¦–
        auth.onAuthStateChanged(async (user) => {
            console.log('ğŸ”„ ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ èªè¨¼çŠ¶æ…‹å¤‰æ›´:', user ? 'ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿' : 'æœªãƒ­ã‚°ã‚¤ãƒ³');
            
            if (user) {
                currentUser = user;
                console.log('âœ… ç®¡ç†è€…èªè¨¼æˆåŠŸ:', user.uid);
                
                try {
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã¨ãƒ­ãƒ¼ãƒ«ç¢ºèª
                    const userSnapshot = await db.ref(`users/${user.uid}`).once('value');
                    const userData = userSnapshot.val();
                    
                    if (userData && userData.role === 'admin') {
                        userRole = 'admin';
                        console.log('âœ… ç®¡ç†è€…æ¨©é™ç¢ºèªæ¸ˆã¿');
                        
                        // ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰åˆæœŸåŒ–
                        initializeAdminDashboard(userData);
                    } else {
                        console.warn('âš ï¸ ç®¡ç†è€…æ¨©é™ãªã—');
                        Utils.showMessage('ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™', 'error');
                        setTimeout(() => {
                            window.location.href = 'dashboard.html';
                        }, 2000);
                    }
                } catch (error) {
                    console.error('âŒ ç®¡ç†è€…æ¨©é™ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
                    Utils.showMessage('æ¨©é™ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            } else {
                console.log('ğŸ”„ æœªèªè¨¼ã®ãŸã‚ã€ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ');
                window.location.href = 'index.html';
            }
        });

        // ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰åˆæœŸåŒ–
        function initializeAdminDashboard(userData) {
            try {
                console.log('ğŸ”„ ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰åˆæœŸåŒ–é–‹å§‹');
                
                // ç®¡ç†è€…åè¡¨ç¤º
                document.getElementById('adminNameDisplay').textContent = userData.name || 'ç®¡ç†è€…';
                
                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
                setupEventListeners();
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
                loadUsersData();
                
                Utils.hideLoading();
                console.log('âœ… ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰åˆæœŸåŒ–å®Œäº†');
                
            } catch (error) {
                console.error('âŒ ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                Utils.showMessage('ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        function setupEventListeners() {
            // æˆ»ã‚‹ãƒœã‚¿ãƒ³
            document.getElementById('backBtn').addEventListener('click', () => {
                window.location.href = 'dashboard.html';
            });

            // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³
            document.getElementById('logoutBtn').addEventListener('click', logout);

            // ç®¡ç†è€…æ©Ÿèƒ½ãƒœã‚¿ãƒ³
            document.getElementById('addUserBtn').addEventListener('click', addUser);
            document.getElementById('manageUsersBtn').addEventListener('click', () => loadUsersData());
            document.getElementById('systemConfigBtn').addEventListener('click', systemConfig);
            document.getElementById('backupBtn').addEventListener('click', backupData);
            document.getElementById('viewLogsBtn').addEventListener('click', viewLogs);
            document.getElementById('exportLogsBtn').addEventListener('click', exportLogs);
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadUsersData() {
            try {
                console.log('ğŸ”„ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹');
                Utils.showLoading();
                
                const usersSnapshot = await db.ref('users').once('value');
                allUsers = usersSnapshot.val() || {};
                
                updateUsersTable(allUsers);
                Utils.hideLoading();
                
                console.log('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†', Object.keys(allUsers).length, 'ãƒ¦ãƒ¼ã‚¶ãƒ¼');
                
            } catch (error) {
                console.error('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                Utils.showMessage('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                Utils.hideLoading();
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°
        function updateUsersTable(users) {
            const tableBody = document.getElementById('usersTableBody');
            
            if (!users || Object.keys(users).length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">ç™»éŒ²ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                return;
            }

            let tableHTML = '';
            for (const [uid, userData] of Object.entries(users)) {
                const roleText = getRoleText(userData.role);
                const lastLoginText = Utils.formatDate(userData.lastLogin);
                
                tableHTML += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            ${userData.name || 'æœªè¨­å®š'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${userData.email || 'æœªè¨­å®š'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getRoleBadgeClass(userData.role)}">
                                ${roleText}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${lastLoginText}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                            <button onclick="editUser('${uid}')" class="text-blue-600 hover:text-blue-900">ç·¨é›†</button>
                            <button onclick="deleteUser('${uid}')" class="text-red-600 hover:text-red-900">å‰Šé™¤</button>
                        </td>
                    </tr>
                `;
            }
            
            tableBody.innerHTML = tableHTML;
        }

        // æ¨©é™ãƒ†ã‚­ã‚¹ãƒˆå–å¾—
        function getRoleText(role) {
            const roleMap = {
                'admin': 'ç®¡ç†è€…',
                'editor': 'ç·¨é›†è€…',
                'viewer': 'é–²è¦§è€…'
            };
            return roleMap[role] || 'æœªè¨­å®š';
        }

        // æ¨©é™ãƒãƒƒã‚¸ã‚¯ãƒ©ã‚¹å–å¾—
        function getRoleBadgeClass(role) {
            const classMap = {
                'admin': 'bg-red-100 text-red-800',
                'editor': 'bg-yellow-100 text-yellow-800',
                'viewer': 'bg-green-100 text-green-800'
            };
            return classMap[role] || 'bg-gray-100 text-gray-800';
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ 
        function addUser() {
            Utils.showMessage('ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ æ©Ÿèƒ½ã¯é–‹ç™ºä¸­ã§ã™', 'info');
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†
        function editUser(uid) {
            Utils.showMessage(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†æ©Ÿèƒ½ã¯é–‹ç™ºä¸­ã§ã™ (UID: ${uid})`, 'info');
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤
        function deleteUser(uid) {
            if (confirm('æœ¬å½“ã«ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                Utils.showMessage(`ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤æ©Ÿèƒ½ã¯é–‹ç™ºä¸­ã§ã™ (UID: ${uid})`, 'info');
            }
        }

        // ã‚·ã‚¹ãƒ†ãƒ è¨­å®š
        function systemConfig() {
            Utils.showMessage('ã‚·ã‚¹ãƒ†ãƒ è¨­å®šæ©Ÿèƒ½ã¯é–‹ç™ºä¸­ã§ã™', 'info');
        }

        // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
        function backupData() {
            Utils.showMessage('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ©Ÿèƒ½ã¯é–‹ç™ºä¸­ã§ã™', 'info');
        }

        // ãƒ­ã‚°è¡¨ç¤º
        function viewLogs() {
            Utils.showMessage('ãƒ­ã‚°è¡¨ç¤ºæ©Ÿèƒ½ã¯é–‹ç™ºä¸­ã§ã™', 'info');
        }

        // ãƒ­ã‚°ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportLogs() {
            Utils.showMessage('ãƒ­ã‚°ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã¯é–‹ç™ºä¸­ã§ã™', 'info');
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
        function logout() {
            auth.signOut().then(() => {
                console.log('âœ… ç®¡ç†è€…ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæˆåŠŸ');
                window.location.href = 'index.html';
            }).catch((error) => {
                console.error('âŒ ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                Utils.showMessage('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            });
        }

        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        window.addEventListener('error', (event) => {
            console.error('âŒ ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ JavaScript ã‚¨ãƒ©ãƒ¼:', event.error);
            Utils.showMessage('äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
        });

        // åˆæœŸåŒ–å®Œäº†ãƒ­ã‚°
        document.addEventListener('DOMContentLoaded', () => {
            console.log('âœ… Admin-Dashboard.html åˆæœŸåŒ–å®Œäº†');
        });
    </script>
</body>
</html>
