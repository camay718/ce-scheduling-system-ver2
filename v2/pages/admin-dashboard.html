<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEスケジュール管理システム V2 - 管理者ダッシュボード</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- ヘッダー -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <button id="backBtn" class="mr-4 text-gray-600 hover:text-gray-800">
                        ← 戻る
                    </button>
                    <h1 class="text-xl font-semibold text-gray-900">管理者ダッシュボード</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="adminNameDisplay" class="text-sm text-gray-600"></span>
                    <button id="logoutBtn" class="text-sm text-red-600 hover:text-red-800">ログアウト</button>
                </div>
            </div>
        </div>
    </header>

    <!-- メインコンテンツ -->
    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- ローディング表示 -->
        <div id="loadingIndicator" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6">
                <div class="flex items-center">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                    <span class="ml-3">読み込み中...</span>
                </div>
            </div>
        </div>

        <div class="px-4 py-6 sm:px-0">
            <!-- 管理者メニュー -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <!-- ユーザー管理 -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">ユーザー管理</h3>
                    <p class="text-sm text-gray-600 mb-4">ユーザーの追加、削除、権限変更</p>
                    <div class="space-y-2">
                        <button id="addUserBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm">
                            新規ユーザー追加
                        </button>
                        <button id="manageUsersBtn" class="w-full bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md text-sm">
                            ユーザー一覧
                        </button>
                    </div>
                </div>

                <!-- システム設定 -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">システム設定</h3>
                    <p class="text-sm text-gray-600 mb-4">システム全体の設定管理</p>
                    <div class="space-y-2">
                        <button id="systemConfigBtn" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm">
                            基本設定
                        </button>
                        <button id="backupBtn" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-md text-sm">
                            バックアップ
                        </button>
                    </div>
                </div>

                <!-- 監査ログ -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">監査ログ</h3>
                    <p class="text-sm text-gray-600 mb-4">システムアクティビティの確認</p>
                    <div class="space-y-2">
                        <button id="viewLogsBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md text-sm">
                            ログ表示
                        </button>
                        <button id="exportLogsBtn" class="w-full bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md text-sm">
                            ログエクスポート
                        </button>
                    </div>
                </div>
            </div>

            <!-- ユーザー一覧テーブル -->
            <div class="bg-white rounded-lg shadow">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900">登録ユーザー一覧</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ユーザー名
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    メールアドレス
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    権限
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    最終ログイン
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    操作
                                </th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- ユーザーデータがここに動的に表示される -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- メッセージ表示エリア -->
    <div id="messageArea" class="fixed top-4 right-4 z-50"></div>

    <script>
        // Firebase設定
        const firebaseConfig = {
            databaseURL: "https://ce-schedule-management-default-rtdb.asia-southeast1.firebasedatabase.app/"
        };

        // Firebase初期化
        console.log('🔄 管理者ダッシュボード Firebase初期化開始...');
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // グローバル変数
        let currentUser = null;
        let userRole = null;
        let allUsers = {};

        // ユーティリティ関数
        const Utils = {
            showMessage: function(message, type = 'info', duration = 3000) {
                const messageArea = document.getElementById('messageArea');
                const messageEl = document.createElement('div');
                
                const bgColor = {
                    'success': 'bg-green-500',
                    'error': 'bg-red-500',
                    'warning': 'bg-yellow-500',
                    'info': 'bg-blue-500'
                }[type] || 'bg-blue-500';

                messageEl.className = `${bgColor} text-white px-4 py-2 rounded-lg shadow-lg mb-2`;
                messageEl.textContent = message;
                
                messageArea.appendChild(messageEl);
                
                setTimeout(() => {
                    if (messageEl.parentNode) {
                        messageEl.parentNode.removeChild(messageEl);
                    }
                }, duration);
            },

            showLoading: function() {
                document.getElementById('loadingIndicator').style.display = 'flex';
            },

            hideLoading: function() {
                document.getElementById('loadingIndicator').style.display = 'none';
            },

            formatDate: function(timestamp) {
                if (!timestamp) return '-';
                const date = new Date(timestamp);
                return date.toLocaleDateString('ja-JP') + ' ' + date.toLocaleTimeString('ja-JP');
            }
        };

        // 認証状態監視
        auth.onAuthStateChanged(async (user) => {
            console.log('🔄 管理者ダッシュボード 認証状態変更:', user ? 'ログイン済み' : '未ログイン');
            
            if (user) {
                currentUser = user;
                console.log('✅ 管理者認証成功:', user.uid);
                
                try {
                    // ユーザー情報とロール確認
                    const userSnapshot = await db.ref(`users/${user.uid}`).once('value');
                    const userData = userSnapshot.val();
                    
                    if (userData && userData.role === 'admin') {
                        userRole = 'admin';
                        console.log('✅ 管理者権限確認済み');
                        
                        // 管理者ダッシュボード初期化
                        initializeAdminDashboard(userData);
                    } else {
                        console.warn('⚠️ 管理者権限なし');
                        Utils.showMessage('管理者権限が必要です', 'error');
                        setTimeout(() => {
                            window.location.href = 'dashboard.html';
                        }, 2000);
                    }
                } catch (error) {
                    console.error('❌ 管理者権限確認エラー:', error);
                    Utils.showMessage('権限確認に失敗しました', 'error');
                }
            } else {
                console.log('🔄 未認証のため、ログイン画面にリダイレクト');
                window.location.href = 'index.html';
            }
        });

        // 管理者ダッシュボード初期化
        function initializeAdminDashboard(userData) {
            try {
                console.log('🔄 管理者ダッシュボード初期化開始');
                
                // 管理者名表示
                document.getElementById('adminNameDisplay').textContent = userData.name || '管理者';
                
                // イベントリスナー設定
                setupEventListeners();
                
                // ユーザーデータ読み込み
                loadUsersData();
                
                Utils.hideLoading();
                console.log('✅ 管理者ダッシュボード初期化完了');
                
            } catch (error) {
                console.error('❌ 管理者ダッシュボード初期化エラー:', error);
                Utils.showMessage('ダッシュボードの初期化に失敗しました', 'error');
            }
        }

        // イベントリスナー設定
        function setupEventListeners() {
            // 戻るボタン
            document.getElementById('backBtn').addEventListener('click', () => {
                window.location.href = 'dashboard.html';
            });

            // ログアウトボタン
            document.getElementById('logoutBtn').addEventListener('click', logout);

            // 管理者機能ボタン
            document.getElementById('addUserBtn').addEventListener('click', addUser);
            document.getElementById('manageUsersBtn').addEventListener('click', () => loadUsersData());
            document.getElementById('systemConfigBtn').addEventListener('click', systemConfig);
            document.getElementById('backupBtn').addEventListener('click', backupData);
            document.getElementById('viewLogsBtn').addEventListener('click', viewLogs);
            document.getElementById('exportLogsBtn').addEventListener('click', exportLogs);
        }

        // ユーザーデータ読み込み
        async function loadUsersData() {
            try {
                console.log('🔄 ユーザーデータ読み込み開始');
                Utils.showLoading();
                
                const usersSnapshot = await db.ref('users').once('value');
                allUsers = usersSnapshot.val() || {};
                
                updateUsersTable(allUsers);
                Utils.hideLoading();
                
                console.log('✅ ユーザーデータ読み込み完了', Object.keys(allUsers).length, 'ユーザー');
                
            } catch (error) {
                console.error('❌ ユーザーデータ読み込みエラー:', error);
                Utils.showMessage('ユーザーデータの読み込みに失敗しました', 'error');
                Utils.hideLoading();
            }
        }

        // ユーザーテーブル更新
        function updateUsersTable(users) {
            const tableBody = document.getElementById('usersTableBody');
            
            if (!users || Object.keys(users).length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">登録されたユーザーがありません</td></tr>';
                return;
            }

            let tableHTML = '';
            for (const [uid, userData] of Object.entries(users)) {
                const roleText = getRoleText(userData.role);
                const lastLoginText = Utils.formatDate(userData.lastLogin);
                
                tableHTML += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            ${userData.name || '未設定'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${userData.email || '未設定'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getRoleBadgeClass(userData.role)}">
                                ${roleText}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${lastLoginText}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                            <button onclick="editUser('${uid}')" class="text-blue-600 hover:text-blue-900">編集</button>
                            <button onclick="deleteUser('${uid}')" class="text-red-600 hover:text-red-900">削除</button>
                        </td>
                    </tr>
                `;
            }
            
            tableBody.innerHTML = tableHTML;
        }

        // 権限テキスト取得
        function getRoleText(role) {
            const roleMap = {
                'admin': '管理者',
                'editor': '編集者',
                'viewer': '閲覧者'
            };
            return roleMap[role] || '未設定';
        }

        // 権限バッジクラス取得
        function getRoleBadgeClass(role) {
            const classMap = {
                'admin': 'bg-red-100 text-red-800',
                'editor': 'bg-yellow-100 text-yellow-800',
                'viewer': 'bg-green-100 text-green-800'
            };
            return classMap[role] || 'bg-gray-100 text-gray-800';
        }

        // ユーザー追加
        function addUser() {
            Utils.showMessage('ユーザー追加機能は開発中です', 'info');
        }

        // ユーザー編集
        function editUser(uid) {
            Utils.showMessage(`ユーザー編集機能は開発中です (UID: ${uid})`, 'info');
        }

        // ユーザー削除
        function deleteUser(uid) {
            if (confirm('本当にこのユーザーを削除しますか？')) {
                Utils.showMessage(`ユーザー削除機能は開発中です (UID: ${uid})`, 'info');
            }
        }

        // システム設定
        function systemConfig() {
            Utils.showMessage('システム設定機能は開発中です', 'info');
        }

        // バックアップ
        function backupData() {
            Utils.showMessage('バックアップ機能は開発中です', 'info');
        }

        // ログ表示
        function viewLogs() {
            Utils.showMessage('ログ表示機能は開発中です', 'info');
        }

        // ログエクスポート
        function exportLogs() {
            Utils.showMessage('ログエクスポート機能は開発中です', 'info');
        }

        // ログアウト処理
        function logout() {
            auth.signOut().then(() => {
                console.log('✅ 管理者ログアウト成功');
                window.location.href = 'index.html';
            }).catch((error) => {
                console.error('❌ ログアウトエラー:', error);
                Utils.showMessage('ログアウトに失敗しました', 'error');
            });
        }

        // エラーハンドリング
        window.addEventListener('error', (event) => {
            console.error('❌ 管理者ダッシュボード JavaScript エラー:', event.error);
            Utils.showMessage('予期しないエラーが発生しました', 'error');
        });

        // 初期化完了ログ
        document.addEventListener('DOMContentLoaded', () => {
            console.log('✅ Admin-Dashboard.html 初期化完了');
        });
    </script>
</body>
</html>
