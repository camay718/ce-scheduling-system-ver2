// v2/js/admin/admin-user-management.js (å®Œå…¨ä¿®æ­£ç‰ˆ)

class AdminUserManager {
    constructor() {
        this.database = null;
        this.auth = null;
        this.isInitialized = false;
        
        // ğŸ”§ å³åº§ã«åˆæœŸåŒ–é–‹å§‹ï¼ˆéåŒæœŸï¼‰
        this.initializationPromise = this.init();
    }

    // ğŸ”§ éåŒæœŸåˆæœŸåŒ–ãƒ¡ã‚½ãƒƒãƒ‰
    async init() {
        console.log('ğŸ”„ AdminUserManageråˆæœŸåŒ–é–‹å§‹...');
        
        try {
            // Firebaseç¢ºèª
            if (!window.firebase) {
                throw new Error('Firebase ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }

            if (!window.firebase.apps || window.firebase.apps.length === 0) {
                throw new Error('Firebase App ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
            }

            console.log('âœ… Firebase Appç¢ºèªOK');

            // Firebase ã‚µãƒ¼ãƒ“ã‚¹æ¥ç¶š
            this.database = firebase.database();
            this.auth = firebase.auth();
            
            console.log('âœ… Firebase ã‚µãƒ¼ãƒ“ã‚¹æ¥ç¶šOK');
            
            // æ¥ç¶šãƒ†ã‚¹ãƒˆ
            await this.database.ref('.info/connected').once('value');
            console.log('âœ… Firebase Databaseæ¥ç¶šãƒ†ã‚¹ãƒˆOK');
            
            this.isInitialized = true;
            console.log('âœ… AdminUserManageråˆæœŸåŒ–å®Œäº†');
            
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®š
            window.adminUserManager = this;
            
            return this;
        } catch (error) {
            console.error('âŒ AdminUserManageråˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
            this.isInitialized = false;
            throw error;
        }
    }

    // ğŸ”§ åˆæœŸåŒ–å¾…æ©Ÿãƒ¡ã‚½ãƒƒãƒ‰
    async waitForInitialization() {
        if (!this.isInitialized) {
            console.log('â³ AdminUserManageråˆæœŸåŒ–å¾…æ©Ÿä¸­...');
            await this.initializationPromise;
        }
        return this;
    }

    // ğŸ”§ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆãƒ¡ã‚½ãƒƒãƒ‰
    async createInitialUser(userData) {
        console.log('ğŸ“ createInitialUser å‘¼ã³å‡ºã—é–‹å§‹');
        
        await this.waitForInitialization();
        
        const username = userData.displayName;
        const permission = userData.role;
        const department = userData.department;
        
        console.log('ğŸ” ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆé–‹å§‹:', {username, permission, department});
        
        if (!username || !permission) {
            throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼ˆæ°åï¼‰ã¨æ¨©é™ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        }

        try {
            // ğŸ” Firebase Database æ¥ç¶šãƒ†ã‚¹ãƒˆ
            console.log('ğŸ“¡ Firebase Databaseæ¥ç¶šãƒ†ã‚¹ãƒˆ...');
            const testRef = this.database.ref('ceScheduleV2');
            await testRef.once('value');
            console.log('âœ… Databaseæ¥ç¶šOK');

            // 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼åé‡è¤‡ãƒã‚§ãƒƒã‚¯
            console.log('ğŸ” é‡è¤‡ãƒã‚§ãƒƒã‚¯ä¸­...');
            const existingInitial = await this.database.ref(`ceScheduleV2/initialUsers/${username}`).once('value');
            const existingUsername = await this.database.ref(`ceScheduleV2/usernames/${username}`).once('value');
            
            if (existingInitial.exists() || existingUsername.exists()) {
                throw new Error('ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼ˆæ°åï¼‰ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™');
            }
            console.log('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ååˆ©ç”¨å¯èƒ½');

            // 2. ä¸€æ™‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å–å¾—ï¼ˆãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ï¼‰
            const tempPassword = userData.initialPassword;
            console.log('ğŸ”‘ ä¸€æ™‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä½¿ç”¨:', tempPassword);
            
            if (!tempPassword) {
                throw new Error('ä¸€æ™‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“');
            }
            
            // 3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿æ§‹é€ ï¼ˆV2å½¢å¼ï¼‰
            const saveUserData = {
                username: username,        
                tempPassword: tempPassword,
                permission: permission,
                department: department,    
                isInitial: true,          
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                lastLogin: null,
                loginCount: 0
            };

            console.log('ğŸ’¾ ä¿å­˜ãƒ‡ãƒ¼ã‚¿:', saveUserData);

            // 4. æ®µéšçš„ä¿å­˜
            console.log('ğŸ“ Step 1: initialUsers ãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¿å­˜ä¸­...');
            await this.database.ref(`ceScheduleV2/initialUsers/${username}`).set(saveUserData);
            console.log('âœ… initialUsers ä¿å­˜å®Œäº†');

            console.log('ğŸ“ Step 2: usernames ãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¿å­˜ä¸­...');
            await this.database.ref(`ceScheduleV2/usernames/${username}`).set({
                status: 'initial',       
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                permission: permission
            });
            console.log('âœ… usernames ä¿å­˜å®Œäº†');
            
            console.log('ğŸ‰ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆå®Œå…¨æˆåŠŸ:', username);
            
            return {
                success: true,
                message: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆãŒå®Œäº†ã—ã¾ã—ãŸ',
                userId: username,
                initialPassword: tempPassword,
                loginUrl: `${window.location.origin}/v2/index.html`
            };
            
        } catch (error) {
            console.error('âŒ è©³ç´°ã‚¨ãƒ©ãƒ¼æƒ…å ±:');
            console.error('- ã‚¨ãƒ©ãƒ¼:', error);
            console.error('- ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰:', error.code);
            console.error('- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:', error.message);
            
            throw new Error(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
        }
    }

    // ğŸ”§ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆãƒ¡ã‚½ãƒƒãƒ‰
    generatePassword() {
        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
        let password = '';
        for (let i = 0; i < 8; i++) {
            password += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        console.log('ğŸ”‘ æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆ:', password);
        return password;
    }

    // ğŸ”§ åˆæœŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆå–å¾—
    async getInitialUsersList() {
        await this.waitForInitialization();
        
        try {
            const snapshot = await this.database.ref('ceScheduleV2/initialUsers').once('value');
            const users = [];
            
            if (snapshot.exists()) {
                snapshot.forEach((userSnapshot) => {
                    const userData = userSnapshot.val();
                    users.push({
                        userId: userSnapshot.key,
                        displayName: userData.username,
                        initialPassword: userData.tempPassword,
                        createdAt: userData.createdAt,
                        permission: userData.permission,
                        department: userData.department
                    });
                });
            }
            
            return users;
        } catch (error) {
            console.error('âŒ åˆæœŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            return [];
        }
    }

    // ğŸ”§ è¨­å®šæ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆå–å¾—
    async getConfiguredUsersList() {
        await this.waitForInitialization();
        return []; // å¾Œã§å®Ÿè£…
    }

    // ğŸ”§ ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤
    async deleteUser(userId) {
        await this.waitForInitialization();
        
        try {
            const updates = {};
            updates[`ceScheduleV2/initialUsers/${userId}`] = null;
            updates[`ceScheduleV2/usernames/${userId}`] = null;
            
            await this.database.ref().update(updates);
            console.log('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤å®Œäº†:', userId);
            
        } catch (error) {
            console.error('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
            throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
    }

    // ğŸ”§ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ
    async resetUserPassword(userId) {
        await this.waitForInitialization();
        
        try {
            const newPassword = this.generatePassword();
            
            await this.database.ref(`ceScheduleV2/initialUsers/${userId}`).update({
                tempPassword: newPassword,
                isInitial: true
            });
            
            console.log('âœ… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆå®Œäº†:', userId);
            return newPassword;
            
        } catch (error) {
            console.error('âŒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆã‚¨ãƒ©ãƒ¼:', error);
            throw new Error('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
    }

    // ğŸ”§ ç®¡ç†è€…è¨­å®š
    setCurrentAdmin(admin) {
        this.currentAdmin = admin;
        console.log('ğŸ‘¨â€ğŸ’¼ ç®¡ç†è€…è¨­å®š:', admin);
    }
}

// ğŸ”§ ã‚°ãƒ­ãƒ¼ãƒãƒ«åˆæœŸåŒ–ï¼ˆä¿®æ­£ç‰ˆï¼‰
console.log('ğŸ“¦ AdminUserManager ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿å®Œäº†');

// DOMContentLoadedã‚’å¾…æ©Ÿã—ã¦ã‹ã‚‰åˆæœŸåŒ–
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeAdminManager);
} else {
    // æ—¢ã«DOMãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯å³åº§ã«å®Ÿè¡Œ
    setTimeout(initializeAdminManager, 100);
}

async function initializeAdminManager() {
    try {
        console.log('ğŸš€ AdminUserManageråˆæœŸåŒ–é–‹å§‹...');
        const manager = new AdminUserManager();
        await manager.waitForInitialization();
        console.log('âœ… AdminUserManageræº–å‚™å®Œäº†');
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®šç¢ºèª
        if (window.adminUserManager) {
            console.log('âœ… ã‚°ãƒ­ãƒ¼ãƒãƒ«adminUserManagerè¨­å®šå®Œäº†');
        } else {
            console.error('âŒ ã‚°ãƒ­ãƒ¼ãƒãƒ«adminUserManagerè¨­å®šå¤±æ•—');
        }
        
    } catch (error) {
        console.error('âŒ AdminUserManageråˆæœŸåŒ–å¤±æ•—:', error);
    }
}
