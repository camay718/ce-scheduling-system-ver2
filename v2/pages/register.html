<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°è¦ç™»éŒ² - CEã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  V2</title>
    
    <!-- å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <!-- ã‚«ã‚¹ã‚¿ãƒ CSS -->
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/auth.css">
    <link rel="stylesheet" href="../css/registration.css">
</head>
<body>
    <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div id="messageContainer" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 w-96"></div>

    <!-- ç™»éŒ²ç”»é¢ -->
    <div class="registration-container">
        <div class="registration-card">
            <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹è¡¨ç¤º -->
            <div class="progress-steps">
                <div class="progress-step active">
                    <div class="step-number">1</div>
                    <div class="step-title">åŸºæœ¬æƒ…å ±</div>
                </div>
                <div class="progress-step">
                    <div class="step-number">2</div>
                    <div class="step-title">ç¢ºèª</div>
                </div>
                <div class="progress-step">
                    <div class="step-number">3</div>
                    <div class="step-title">å®Œäº†</div>
                </div>
            </div>

            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="registration-header">
                <h1 class="registration-title">
                    <i class="fas fa-user-plus mr-2 text-blue-600"></i>
                    æ–°è¦ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç™»éŒ²
                </h1>
                <p class="registration-subtitle">
                    CEã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  V2ã¸ã®å‚åŠ ç”³è«‹
                </p>
            </div>

            <!-- ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ  -->
            <form id="registrationForm" class="space-y-4">
                <!-- Step 1: åŸºæœ¬æƒ…å ± -->
                <div id="step1" class="registration-step">
                    <!-- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ -->
                    <div class="form-group">
                        <label for="registerEmail" class="form-label">
                            <i class="fas fa-envelope mr-1 text-blue-500"></i>
                            ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
                        </label>
                        <input type="email" id="registerEmail" class="form-input" 
                               placeholder="your.email@example.com" required>
                        <div class="text-xs text-gray-500 mt-1">
                            ç¢ºèªãƒ¡ãƒ¼ãƒ«ãŒé€ä¿¡ã•ã‚Œã‚‹ãŸã‚ã€æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
                        </div>
                    </div>

                    <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ -->
                    <div class="form-group">
                        <label for="registerPassword" class="form-label">
                            <i class="fas fa-lock mr-1 text-blue-500"></i>
                            ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
                        </label>
                        <input type="password" id="registerPassword" class="form-input" 
                               placeholder="6æ–‡å­—ä»¥ä¸Šã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" required>
                        <div class="text-xs text-gray-500 mt-1">
                            è‹±æ•°å­—ã‚’å«ã‚€6æ–‡å­—ä»¥ä¸Šã§è¨­å®šã—ã¦ãã ã•ã„
                        </div>
                    </div>

                    <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª -->
                    <div class="form-group">
                        <label for="registerPasswordConfirm" class="form-label">
                            <i class="fas fa-lock mr-1 text-blue-500"></i>
                            ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª
                        </label>
                        <input type="password" id="registerPasswordConfirm" class="form-input" 
                               placeholder="åŒã˜ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å†å…¥åŠ›" required>
                    </div>

                    <!-- è¡¨ç¤ºå -->
                    <div class="form-group">
                        <label for="registerDisplayName" class="form-label">
                            <i class="fas fa-user mr-1 text-blue-500"></i>
                            è¡¨ç¤ºå
                        </label>
                        <input type="text" id="registerDisplayName" class="form-input" 
                               placeholder="ã‚·ã‚¹ãƒ†ãƒ å†…ã§è¡¨ç¤ºã•ã‚Œã‚‹åå‰" required>
                    </div>

                    <!-- æ‰€å±éƒ¨é–€ -->
                    <div class="form-group">
                        <label for="registerDepartment" class="form-label">
                            <i class="fas fa-building mr-1 text-blue-500"></i>
                            æ‰€å±éƒ¨é–€
                        </label>
                        <select id="registerDepartment" class="form-select" required>
                            <option value="">éƒ¨é–€ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="æ‰‹è¡“ãƒ»éº»é…”">æ‰‹è¡“ãƒ»éº»é…”</option>
                            <option value="æ©Ÿå™¨ç®¡ç†ãƒ»äººå·¥å‘¼å¸">MEã‚»ãƒ³ã‚¿ãƒ¼ï¼ˆæ©Ÿå™¨ç®¡ç†ãƒ»äººå·¥å‘¼å¸ï¼‰</option>
                            <option value="è¡€æ¶²æµ„åŒ–">è¡€æ¶²æµ„åŒ–</option>
                            <option value="ä¸æ•´è„ˆ">ä¸æ•´è„ˆ</option>
                            <option value="äººå·¥å¿ƒè‚ºãƒ»è£œåŠ©å¾ªç’°">äººå·¥å¿ƒè‚ºãƒ»è£œåŠ©å¾ªç’°</option>
                            <option value="å¿ƒãƒ»ã‚«ãƒ†ãƒ¼ãƒ†ãƒ«">å¿ƒãƒ»ã‚«ãƒ†ãƒ¼ãƒ†ãƒ«</option>
                            <option value="ãã®ä»–">ãã®ä»–</option>
                        </select>
                    </div>

                    <!-- è·ç¨® -->
                    <div class="form-group">
                        <label for="registerPosition" class="form-label">
                            <i class="fas fa-id-badge mr-1 text-blue-500"></i>
                            è·ç¨®
                        </label>
                        <select id="registerPosition" class="form-select" required>
                            <option value="">è·ç¨®ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="CEï¼ˆè‡¨åºŠå·¥å­¦æŠ€å£«ï¼‰">CEï¼ˆè‡¨åºŠå·¥å­¦æŠ€å£«ï¼‰</option>
                            <option value="çœ‹è­·å¸«">çœ‹è­·å¸«</option>
                            <option value="åŒ»å¸«">åŒ»å¸«</option>
                            <option value="äº‹å‹™">äº‹å‹™</option>
                            <option value="ãã®ä»–">ãã®ä»–</option>
                        </select>
                    </div>

                    <!-- å¸Œæœ›æ¨©é™ -->
                    <div class="form-group">
                        <label for="registerRole" class="form-label">
                            <i class="fas fa-shield-alt mr-1 text-blue-500"></i>
                            å¸Œæœ›æ¨©é™ãƒ¬ãƒ™ãƒ«
                        </label>
                        <select id="registerRole" class="form-select" required>
                            <option value="viewer">é–²è¦§ã®ã¿ï¼ˆViewerï¼‰</option>
                            <option value="editor">ç·¨é›†å¯èƒ½ï¼ˆEditorï¼‰</option>
                            <option value="admin">ç®¡ç†è€…ï¼ˆè¦æ‰¿èªï¼‰</option>
                        </select>
                        <div class="text-xs text-gray-500 mt-1">
                            ç®¡ç†è€…æ¨©é™ã¯æ—¢å­˜ç®¡ç†è€…ã«ã‚ˆã‚‹æ‰¿èªãŒå¿…è¦ã§ã™
                        </div>
                    </div>

                    <!-- ç”³è«‹ç†ç”± -->
                    <div class="form-group">
                        <label for="registerReason" class="form-label">
                            <i class="fas fa-comment mr-1 text-blue-500"></i>
                            ç”³è«‹ç†ç”±ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆ
                        </label>
                        <textarea id="registerReason" class="form-input" rows="3" 
                                  placeholder="ã‚·ã‚¹ãƒ†ãƒ åˆ©ç”¨ã®ç›®çš„ã‚„ç†ç”±ã‚’ã”è¨˜å…¥ãã ã•ã„ï¼ˆä»»æ„ï¼‰"></textarea>
                    </div>

                    <!-- åˆ©ç”¨è¦ç´„åŒæ„ -->
                    <div class="form-group">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" id="agreeTerms" required 
                                   class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <span class="text-sm text-gray-700">
                                <a href="#" class="text-blue-600 hover:underline">åˆ©ç”¨è¦ç´„</a>
                                ãŠã‚ˆã³
                                <a href="#" class="text-blue-600 hover:underline">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>
                                ã«åŒæ„ã—ã¾ã™
                            </span>
                        </label>
                    </div>

                    <!-- ãƒœã‚¿ãƒ³ -->
                    <div class="flex space-x-3">
                        <button type="button" onclick="goBack()" class="flex-1 py-3 px-4 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                            <i class="fas fa-arrow-left mr-2"></i>
                            ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹
                        </button>
                        <button type="submit" id="registerButton" class="flex-1 btn-register">
                            <i class="fas fa-user-plus mr-2"></i>
                            ç™»éŒ²ç”³è«‹
                        </button>
                    </div>
                </div>

                <!-- Step 2: ç¢ºèªç”»é¢ï¼ˆéš ã—çŠ¶æ…‹ï¼‰ -->
                <div id="step2" class="registration-step" style="display: none;">
                    <div class="text-center">
                        <div class="success-icon">
                            <i class="fas fa-envelope-open-text"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-4">
                            ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸ
                        </h3>
                        <div class="bg-blue-50 p-4 rounded-lg text-left">
                            <p class="text-gray-700 mb-2">
                                <strong>ç™»éŒ²ã—ãŸãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹:</strong><br>
                                <span id="confirmEmail" class="text-blue-600"></span>
                            </p>
                            <p class="text-gray-600 text-sm">
                                ãƒ¡ãƒ¼ãƒ«ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€
                                ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ç¢ºèªã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚
                            </p>
                        </div>
                        <div class="mt-6">
                            <button type="button" onclick="goBack()" class="btn-register">
                                <i class="fas fa-sign-in-alt mr-2"></i>
                                ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Step 3: å®Œäº†ç”»é¢ï¼ˆéš ã—çŠ¶æ…‹ï¼‰ -->
                <div id="step3" class="registration-step" style="display: none;">
                    <div class="registration-success">
                        <div class="success-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-4">
                            ç™»éŒ²å®Œäº†ï¼
                        </h3>
                        <p class="text-gray-600 mb-6">
                            ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸã€‚<br>
                            ç®¡ç†è€…ã«ã‚ˆã‚‹æ‰¿èªã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚
                        </p>
                        <button type="button" onclick="goBack()" class="btn-register">
                            <i class="fas fa-sign-in-alt mr-2"></i>
                            ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã¿ã‚‹
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- JavaScriptèª­ã¿è¾¼ã¿ -->
    <script src="../js/core/firebase-config.js?v=20241205-3"></script>
    <script src="../js/auth/email-auth.js?v=20241205-3"></script>

    <!-- ç™»éŒ²ç”»é¢åˆ¶å¾¡ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script>
        // ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ åˆ¶å¾¡
        document.getElementById('registrationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            await handleRegistration();
        });

        // ç™»éŒ²å‡¦ç†
        async function handleRegistration() {
            const button = document.getElementById('registerButton');
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            const passwordConfirm = document.getElementById('registerPasswordConfirm').value;

            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if (password !== passwordConfirm) {
                showMessage('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“', 'error');
                return;
            }

            if (password.length < 6) {
                showMessage('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            // ãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ–
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ç™»éŒ²ä¸­...';

            try {
                // ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±åé›†
                const profile = {
                    displayName: document.getElementById('registerDisplayName').value.trim(),
                    department: document.getElementById('registerDepartment').value,
                    position: document.getElementById('registerPosition').value,
                    requestedRole: document.getElementById('registerRole').value,
                    reason: document.getElementById('registerReason').value.trim()
                };

                // Emailèªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã§ç™»éŒ²
                if (window.emailAuthSystem) {
                    const result = await window.emailAuthSystem.registerWithEmail(email, password, profile);
                    
                    if (result.success) {
                        showStep2(email);
                    } else {
                        showMessage(result.message, 'error');
                    }
                } else {
                    showMessage('èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ãŒæº–å‚™ã§ãã¦ã„ã¾ã›ã‚“ã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚', 'error');
                }
            } catch (error) {
                console.error('ç™»éŒ²ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('ç™»éŒ²ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', 'error');
            } finally {
                // ãƒœã‚¿ãƒ³å¾©å…ƒ
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-user-plus mr-2"></i>ç™»éŒ²ç”³è«‹';
            }
        }

        // Step 2è¡¨ç¤º
        function showStep2(email) {
            document.getElementById('step1').style.display = 'none';
            document.getElementById('step2').style.display = 'block';
            document.getElementById('confirmEmail').textContent = email;
            
            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–°
            document.querySelectorAll('.progress-step')[1].classList.add('active');
        }

        // ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹
        function goBack() {
            window.location.href = '../index.html';
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function showMessage(text, type = 'info') {
            const container = document.getElementById('messageContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type} px-4 py-2 mb-2 rounded-lg`;
            
            const icons = { success: 'check', error: 'times', warning: 'exclamation', info: 'info' };
            messageDiv.innerHTML = `<i class="fas fa-${icons[type]}-circle mr-2"></i>${text}`;
            
            const colors = {
                success: 'bg-green-100 text-green-800',
                error: 'bg-red-100 text-red-800',
                warning: 'bg-yellow-100 text-yellow-800',
                info: 'bg-blue-100 text-blue-800'
            };
            messageDiv.className += ` ${colors[type]}`;
            
            container.appendChild(messageDiv);
            setTimeout(() => messageDiv.remove(), 5000);
        }

        // åˆæœŸåŒ–
        console.log('ğŸ“§ ç™»éŒ²ç”»é¢åˆæœŸåŒ–å®Œäº†');
    </script>
</body>
</html>
