<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新規登録 - CEスケジュール管理システム V2</title>
    
    <!-- 外部ライブラリ -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <!-- カスタムCSS -->
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/auth.css">
    <link rel="stylesheet" href="../css/registration.css">
</head>
<body>
    <!-- メッセージコンテナ -->
    <div id="messageContainer" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 w-96"></div>

    <!-- 登録画面 -->
    <div class="registration-container">
        <div class="registration-card">
            <!-- ヘッダー -->
            <div class="registration-header">
                <h1 class="registration-title">
                    <i class="fas fa-user-plus mr-2 text-blue-600"></i>
                    新規アカウント登録
                </h1>
                <p class="registration-subtitle">
                    CEスケジュール管理システム V2への参加申請
                </p>
            </div>

            <!-- 登録フォーム -->
            <form id="registrationForm" class="space-y-4">
                <!-- メールアドレス -->
                <div class="form-group">
                    <label for="registerEmail" class="form-label">
                        <i class="fas fa-envelope mr-1 text-blue-500"></i>
                        メールアドレス
                    </label>
                    <input type="email" id="registerEmail" class="form-input" 
                           placeholder="your.email@example.com" required>
                    <div class="text-xs text-gray-500 mt-1">
                        確認メールが送信されるため、有効なメールアドレスを入力してください
                    </div>
                </div>

                <!-- パスワード -->
                <div class="form-group">
                    <label for="registerPassword" class="form-label">
                        <i class="fas fa-lock mr-1 text-blue-500"></i>
                        パスワード
                    </label>
                    <input type="password" id="registerPassword" class="form-input" 
                           placeholder="6文字以上のパスワード" required>
                    <div class="text-xs text-gray-500 mt-1">
                        英数字を含む6文字以上で設定してください
                    </div>
                </div>

                <!-- パスワード確認 -->
                <div class="form-group">
                    <label for="registerPasswordConfirm" class="form-label">
                        <i class="fas fa-lock mr-1 text-blue-500"></i>
                        パスワード確認
                    </label>
                    <input type="password" id="registerPasswordConfirm" class="form-input" 
                           placeholder="同じパスワードを再入力" required>
                </div>

                <!-- 表示名 -->
                <div class="form-group">
                    <label for="registerDisplayName" class="form-label">
                        <i class="fas fa-user mr-1 text-blue-500"></i>
                        表示名
                    </label>
                    <input type="text" id="registerDisplayName" class="form-input" 
                           placeholder="システム内で表示される名前" required>
                </div>

                <!-- 所属部門 -->
                <div class="form-group">
                    <label for="registerDepartment" class="form-label">
                        <i class="fas fa-building mr-1 text-blue-500"></i>
                        所属部門
                    </label>
                    <select id="registerDepartment" class="form-select" required>
                        <option value="">部門を選択してください</option>
                        <option value="手術・麻酔">手術・麻酔</option>
                        <option value="機器管理・人工呼吸">MEセンター（機器管理・人工呼吸）</option>
                        <option value="血液浄化">血液浄化</option>
                        <option value="不整脈">不整脈</option>
                        <option value="人工心肺・補助循環">人工心肺・補助循環</option>
                        <option value="心・カテーテル">心・カテーテル</option>
                        <option value="その他">その他</option>
                    </select>
                </div>

                <!-- 職種 -->
                <div class="form-group">
                    <label for="registerPosition" class="form-label">
                        <i class="fas fa-id-badge mr-1 text-blue-500"></i>
                        職種
                    </label>
                    <select id="registerPosition" class="form-select" required>
                        <option value="">職種を選択してください</option>
                        <option value="CE（臨床工学技士）">CE（臨床工学技士）</option>
                        <option value="看護師">看護師</option>
                        <option value="医師">医師</option>
                        <option value="事務">事務</option>
                        <option value="その他">その他</option>
                    </select>
                </div>

                <!-- 利用規約同意 -->
                <div class="form-group">
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" id="agreeTerms" required 
                               class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <span class="text-sm text-gray-700">
                            利用規約およびプライバシーポリシーに同意します
                        </span>
                    </label>
                </div>

                <!-- ボタン -->
                <div class="flex space-x-3">
                    <button type="button" onclick="goBack()" class="flex-1 py-3 px-4 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>
                        ログイン画面に戻る
                    </button>
                    <button type="submit" id="registerButton" class="flex-1 btn-register">
                        <i class="fas fa-user-plus mr-2"></i>
                        登録申請
                    </button>
                </div>

                <!-- 成功画面（隠し状態） -->
                <div id="successMessage" style="display: none;" class="text-center">
                    <div class="success-icon">
                        <i class="fas fa-check-circle text-green-500 text-4xl"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        登録完了！
                    </h3>
                    <p class="text-gray-600 mb-6">
                        確認メールを送信しました。<br>
                        メール内のリンクをクリックして確認を完了してください。
                    </p>
                </div>
            </form>
        </div>
    </div>

    <!-- JavaScript読み込み -->
    <script src="../js/core/firebase-config.js?v=20241205-3"></script>
    <script src="../js/auth/email-auth.js?v=20241205-3"></script>

    <!-- 登録画面制御スクリプト -->
    <script>
        // 登録フォーム制御
        document.getElementById('registrationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            await handleRegistration();
        });

        // 登録処理
        async function handleRegistration() {
            const button = document.getElementById('registerButton');
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            const passwordConfirm = document.getElementById('registerPasswordConfirm').value;

            // バリデーション
            if (password !== passwordConfirm) {
                showMessage('パスワードが一致しません', 'error');
                return;
            }

            if (password.length < 6) {
                showMessage('パスワードは6文字以上で入力してください', 'error');
                return;
            }

            // ボタン無効化
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>登録中...';

            try {
                // プロファイル情報収集
                const profile = {
                    displayName: document.getElementById('registerDisplayName').value.trim(),
                    department: document.getElementById('registerDepartment').value,
                    position: document.getElementById('registerPosition').value
                };

                // Email認証システムで登録
                if (window.emailAuthSystem) {
                    const result = await window.emailAuthSystem.registerWithEmail(email, password, profile);
                    
                    if (result.success) {
                        document.getElementById('registrationForm').style.display = 'none';
                        document.getElementById('successMessage').style.display = 'block';
                    } else {
                        showMessage(result.message, 'error');
                    }
                } else {
                    showMessage('認証システムが準備できていません。', 'error');
                }
            } catch (error) {
                console.error('登録エラー:', error);
                showMessage('登録中にエラーが発生しました。', 'error');
            } finally {
                // ボタン復元
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-user-plus mr-2"></i>登録申請';
            }
        }

        // ログイン画面に戻る
        function goBack() {
            window.location.href = '../index.html';
        }

        // メッセージ表示
        function showMessage(text, type = 'info') {
            const container = document.getElementById('messageContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type} px-4 py-2 mb-2 rounded-lg`;
            
            const icons = { success: 'check', error: 'times', warning: 'exclamation', info: 'info' };
            messageDiv.innerHTML = `<i class="fas fa-${icons[type]}-circle mr-2"></i>${text}`;
            
            const colors = {
                success: 'bg-green-100 text-green-800',
                error: 'bg-red-100 text-red-800',
                warning: 'bg-yellow-100 text-yellow-800',
                info: 'bg-blue-100 text-blue-800'
            };
            messageDiv.className += ` ${colors[type]}`;
            
            container.appendChild(messageDiv);
            setTimeout(() => messageDiv.remove(), 5000);
        }

        console.log('📧 登録画面初期化完了');
    </script>
</body>
</html>
