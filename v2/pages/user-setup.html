<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å€‹äººè¨­å®š - CEã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  V2</title>
    
    <!-- å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <!-- ã‚«ã‚¹ã‚¿ãƒ CSS -->
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/auth.css">
    <link rel="stylesheet" href="../css/registration.css">
</head>
<body>
    <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div id="messageContainer" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 w-96"></div>

    <div class="registration-container">
        <div class="registration-card">
            <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹è¡¨ç¤º -->
            <div class="progress-steps">
                <div class="progress-step active">
                    <div class="step-number">1</div>
                    <div class="step-title">åˆæœŸãƒ­ã‚°ã‚¤ãƒ³</div>
                </div>
                <div class="progress-step active">
                    <div class="step-number">2</div>
                    <div class="step-title">å€‹äººè¨­å®š</div>
                </div>
                <div class="progress-step">
                    <div class="step-number">3</div>
                    <div class="step-title">å®Œäº†</div>
                </div>
            </div>

            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="registration-header">
                <h1 class="registration-title">
                    <i class="fas fa-user-cog mr-2 text-blue-600"></i>
                    å€‹äººè¨­å®šã®å®Œäº†
                </h1>
                <p class="registration-subtitle">
                    åˆæœŸãƒ­ã‚°ã‚¤ãƒ³ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚å€‹äººè¨­å®šã‚’å®Œäº†ã—ã¦ã‚·ã‚¹ãƒ†ãƒ ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚
                </p>
            </div>

            <!-- ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¡¨ç¤º -->
            <div id="currentUserInfo" class="bg-blue-50 p-4 rounded-lg mb-6">
                <h3 class="font-semibold text-blue-800 mb-2">
                    <i class="fas fa-info-circle mr-2"></i>ç¾åœ¨ã®ç™»éŒ²æƒ…å ±
                </h3>
                <div id="userInfoDetails"></div>
            </div>

            <!-- å€‹äººè¨­å®šãƒ•ã‚©ãƒ¼ãƒ  -->
            <form id="userSetupForm" class="space-y-4">
                <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼åè¨­å®š -->
                <div class="form-group">
                    <label for="setupUsername" class="form-label required">
                        <i class="fas fa-user mr-1 text-blue-500"></i>
                        ãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼ˆãƒ­ã‚°ã‚¤ãƒ³IDï¼‰
                    </label>
                    <input type="text" id="setupUsername" class="form-input" 
                           placeholder="åŠè§’è‹±æ•°å­—3-20æ–‡å­—" required>
                    <div id="usernameCheck" class="text-xs mt-1"></div>
                    <div class="admin-help-text">
                        ä»Šå¾Œãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«ä½¿ç”¨ã™ã‚‹IDã§ã™ã€‚è‹±æ•°å­—ã€ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã€ãƒã‚¤ãƒ•ãƒ³ãŒä½¿ç”¨å¯èƒ½
                    </div>
                </div>

                <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®š -->
                <div class="form-group">
                    <label for="setupPassword" class="form-label required">
                        <i class="fas fa-lock mr-1 text-blue-500"></i>
                        æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
                    </label>
                    <input type="password" id="setupPassword" class="form-input" 
                           placeholder="6æ–‡å­—ä»¥ä¸Šã®å®‰å…¨ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" required>
                    <div id="passwordStrength" class="text-xs mt-1"></div>
                    <div class="admin-help-text">
                        è‹±æ•°å­—ã‚’çµ„ã¿åˆã‚ã›ãŸå®‰å…¨ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¦ãã ã•ã„
                    </div>
                </div>

                <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª -->
                <div class="form-group">
                    <label for="setupPasswordConfirm" class="form-label required">
                        <i class="fas fa-lock mr-1 text-blue-500"></i>
                        ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª
                    </label>
                    <input type="password" id="setupPasswordConfirm" class="form-input" 
                           placeholder="åŒã˜ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å†å…¥åŠ›" required>
                    <div id="passwordMatch" class="text-xs mt-1"></div>
                </div>
                <!-- è¨­å®šå®Œäº†ãƒœã‚¿ãƒ³ -->
                <div class="flex space-x-3 mt-8">
                    <button type="button" onclick="goBack()" 
                            class="flex-1 py-3 px-4 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>
                        ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹
                    </button>
                    <button type="submit" id="setupButton" 
                            class="flex-1 btn-register py-3">
                        <i class="fas fa-check mr-2"></i>
                        è¨­å®šå®Œäº†
                    </button>
                </div>
            </form>

            <!-- å®Œäº†ç”»é¢ï¼ˆéš ã—çŠ¶æ…‹ï¼‰ -->
            <div id="setupComplete" style="display: none;" class="text-center">
                <div class="success-icon mb-6">
                    <i class="fas fa-check-circle text-green-500 text-6xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-800 mb-4">
                    è¨­å®šå®Œäº†ï¼
                </h3>
                <div class="bg-green-50 p-6 rounded-lg mb-6">
                    <div id="setupCompleteDetails"></div>
                </div>
                <p class="text-gray-600 mb-6">
                    å€‹äººè¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸã€‚<br>
                    ä»Šå¾Œã¯è¨­å®šã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚
                </p>
                <button onclick="goToLogin()" class="btn-register">
                    <i class="fas fa-sign-in-alt mr-2"></i>
                    ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScriptèª­ã¿è¾¼ã¿ -->
    <script src="../js/core/firebase-config.js?v=20241205-5"></script>
    <script src="../js/auth/initial-login.js?v=20241205-5"></script>
    <script src="../js/user/user-setup.js?v=20241205-5"></script>

    <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šç”»é¢åˆ¶å¾¡ -->
    <script>
        class UserSetupController {
            constructor() {
                this.isInitialized = false;
                this.currentUserData = null;
                this.init();
            }

            async init() {
                // ã‚·ã‚¹ãƒ†ãƒ æº–å‚™å¾…ã¡
                let attempts = 0;
                while (attempts < 100 && (!window.userSetupSystem || !window.userSetupSystem.isInitialized)) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }

                if (window.userSetupSystem) {
                    this.isInitialized = true;
                    this.loadUserData();
                    this.setupEventListeners();
                    console.log('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šç”»é¢åˆæœŸåŒ–å®Œäº†');
                } else {
                    this.showError('ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            }

            loadUserData() {
                // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const urlParams = new URLSearchParams(window.location.search);
                const userDataStr = urlParams.get('userData');
                
                if (userDataStr) {
                    try {
                        this.currentUserData = JSON.parse(decodeURIComponent(userDataStr));
                        this.displayCurrentUserInfo();
                        this.fillPresetData();
                    } catch (error) {
                        console.error('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿è§£æã‚¨ãƒ©ãƒ¼:', error);
                        this.showError('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                } else {
                    this.showError('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
            }

            displayCurrentUserInfo() {
                if (!this.currentUserData) return;

                const profile = this.currentUserData.profile || {};
                const auth = this.currentUserData.auth || {};

                const infoDiv = document.getElementById('userInfoDetails');
                infoDiv.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <strong>æ°å:</strong> ${profile.displayName || 'æœªè¨­å®š'}
                        </div>
                        <div>
                            <strong>éƒ¨é–€:</strong> ${profile.department || 'æœªè¨­å®š'}
                        </div>
                        <div>
                            <strong>è·ç¨®:</strong> ${profile.position || 'æœªè¨­å®š'}
                        </div>
                        <div>
                            <strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼ID:</strong> <code class="bg-white px-2 py-1 rounded">${auth.userId || 'ä¸æ˜'}</code>
                        </div>
                    </div>
                `;
            }

            fillPresetData() {
                if (!window.userSetupSystem) return;

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã‚·ã‚¹ãƒ†ãƒ ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
                const userId = this.currentUserData.auth?.userId;
                if (userId) {
                    window.userSetupSystem.setUserData(userId, this.currentUserData);
                }

                // ãƒ—ãƒªã‚»ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿å–å¾—
                const presets = window.userSetupSystem.getSetupPresets();
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼åå€™è£œã‚’è¡¨ç¤º
                if (presets.suggestedUsername) {
                    document.getElementById('setupUsername').value = presets.suggestedUsername;
                    this.checkUsernameAvailability(presets.suggestedUsername);
                }
            }

            setupEventListeners() {
                // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
                document.getElementById('userSetupForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleSetupSubmit();
                });

                // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                document.getElementById('setupUsername').addEventListener('input', (e) => {
                    this.checkUsernameAvailability(e.target.value);
                });

                document.getElementById('setupPassword').addEventListener('input', (e) => {
                    this.checkPasswordStrength(e.target.value);
                    this.checkPasswordMatch();
                });

                document.getElementById('setupPasswordConfirm').addEventListener('input', () => {
                    this.checkPasswordMatch();
                });
            }

            async checkUsernameAvailability(username) {
                const checkDiv = document.getElementById('usernameCheck');
                
                if (!username) {
                    checkDiv.innerHTML = '';
                    return;
                }

                if (username.length < 3) {
                    checkDiv.innerHTML = '<span class="text-orange-600"><i class="fas fa-exclamation-triangle mr-1"></i>3æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„</span>';
                    return;
                }

                checkDiv.innerHTML = '<span class="text-gray-500"><i class="fas fa-spinner fa-spin mr-1"></i>ç¢ºèªä¸­...</span>';

                if (window.userSetupSystem) {
                    const result = await window.userSetupSystem.checkUsernameRealtime(username);
                    
                    if (result.valid) {
                        checkDiv.innerHTML = `<span class="text-green-600"><i class="fas fa-check mr-1"></i>${result.message}</span>`;
                    } else {
                        checkDiv.innerHTML = `<span class="text-red-600"><i class="fas fa-times mr-1"></i>${result.message}</span>`;
                    }
                }
            }

            checkPasswordStrength(password) {
                const strengthDiv = document.getElementById('passwordStrength');
                
                if (!password) {
                    strengthDiv.innerHTML = '';
                    return;
                }

                if (window.userSetupSystem) {
                    const evaluation = window.userSetupSystem.evaluatePasswordStrength(password);
                    
                    const colorClass = {
                        red: 'text-red-600',
                        orange: 'text-orange-600', 
                        yellow: 'text-yellow-600',
                        green: 'text-green-600',
                        blue: 'text-blue-600'
                    }[evaluation.color];

                    strengthDiv.innerHTML = `
                        <span class="${colorClass}">
                            <i class="fas fa-shield-alt mr-1"></i>
                            å¼·åº¦: ${evaluation.strength}
                            ${evaluation.feedback.length > 0 ? '(' + evaluation.feedback.join(', ') + ')' : ''}
                        </span>
                    `;
                }
            }

            checkPasswordMatch() {
                const password = document.getElementById('setupPassword').value;
                const confirm = document.getElementById('setupPasswordConfirm').value;
                const matchDiv = document.getElementById('passwordMatch');

                if (!confirm) {
                    matchDiv.innerHTML = '';
                    return;
                }

                if (password === confirm) {
                    matchDiv.innerHTML = '<span class="text-green-600"><i class="fas fa-check mr-1"></i>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¦ã„ã¾ã™</span>';
                } else {
                    matchDiv.innerHTML = '<span class="text-red-600"><i class="fas fa-times mr-1"></i>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“</span>';
                }
            }

            async handleSetupSubmit() {
                const button = document.getElementById('setupButton');
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>è¨­å®šä¸­...';

                try {
                    const setupData = {
                        username: document.getElementById('setupUsername').value.trim(),
                        password: document.getElementById('setupPassword').value,
                        email: document.getElementById('setupEmail').value.trim()
                    };

                    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                    const passwordConfirm = document.getElementById('setupPasswordConfirm').value;
                    if (setupData.password !== passwordConfirm) {
                        throw new Error('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“');
                    }

                    if (window.userSetupSystem) {
                        const result = await window.userSetupSystem.completeUserSetup(setupData);
                        
                        if (result.success) {
                            this.showSetupComplete(result);
                        }
                    } else {
                        throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã‚·ã‚¹ãƒ†ãƒ ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                    }

                } catch (error) {
                    this.showError(error.message);
                } finally {
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-check mr-2"></i>è¨­å®šå®Œäº†';
                }
            }

            showSetupComplete(result) {
                // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–°
                document.querySelectorAll('.progress-step')[2].classList.add('active');

                // ãƒ•ã‚©ãƒ¼ãƒ éè¡¨ç¤ºã€å®Œäº†ç”»é¢è¡¨ç¤º
                document.getElementById('userSetupForm').style.display = 'none';
                document.getElementById('currentUserInfo').style.display = 'none';
                document.getElementById('setupComplete').style.display = 'block';

                // å®Œäº†è©³ç´°è¡¨ç¤º
                document.getElementById('setupCompleteDetails').innerHTML = `
                    <div class="text-left space-y-2">
                        <p><strong>è¨­å®šå®Œäº†ãƒ¦ãƒ¼ã‚¶ãƒ¼å:</strong> <code class="bg-white px-2 py-1 rounded font-mono">${result.username}</code></p>
                        <p><strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼ID:</strong> <code class="bg-white px-2 py-1 rounded font-mono">${result.userId}</code></p>
                        <p class="text-sm text-gray-600 mt-4">
                            <i class="fas fa-info-circle mr-1"></i>
                            ä»Šå¾Œã¯ä¸Šè¨˜ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„
                        </p>
                    </div>
                `;
            }

            showError(message) {
                this.showMessage(message, 'error');
            }

            showSuccess(message) {
                this.showMessage(message, 'success');
            }

            showMessage(text, type = 'info') {
                const container = document.getElementById('messageContainer');
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type} px-4 py-2 mb-2 rounded-lg`;
                
                const icons = { success: 'check', error: 'times', warning: 'exclamation', info: 'info' };
                messageDiv.innerHTML = `<i class="fas fa-${icons[type]}-circle mr-2"></i>${text}`;
                
                const colors = {
                    success: 'bg-green-100 text-green-800',
                    error: 'bg-red-100 text-red-800',
                    warning: 'bg-yellow-100 text-yellow-800',
                    info: 'bg-blue-100 text-blue-800'
                };
                messageDiv.className += ` ${colors[type]}`;
                
                container.appendChild(messageDiv);
                setTimeout(() => messageDiv.remove(), 5000);
            }
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°
        function goBack() {
            if (confirm('è¨­å®šã‚’ä¸­æ–­ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ')) {
                window.location.href = '../index.html';
            }
        }

        function goToLogin() {
            window.location.href = '../index.html';
        }

        // åˆæœŸåŒ–
        window.userSetupController = new UserSetupController();
        console.log('ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šç”»é¢èª­ã¿è¾¼ã¿å®Œäº†');
    </script>
</body>
</html>
