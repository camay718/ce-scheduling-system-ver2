<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å€‹äººè¨­å®š - CEã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  V2</title>
    
    <!-- å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- çµ±ä¸€ãƒ†ãƒ¼ãƒ -->
    <link rel="stylesheet" href="../css/theme-unified.css?v=20241218">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <!-- Firebaseè¨­å®šãƒ•ã‚¡ã‚¤ãƒ« -->
    <script src="../js/config/firebase-config.js"></script>

    <!-- ç¢ºå®Ÿãªä¸­å¤®é…ç½®ã¨ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ -->
    <style>
        /* ä¸­å¤®é…ç½®ã®ç¢ºå®Ÿãªå®Ÿè£… */
        .center-layout {
            min-height: 100vh !important;
            min-height: 100svh !important; /* ãƒ¢ãƒã‚¤ãƒ«UIãƒãƒ¼è€ƒæ…® */
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            padding: 20px !important;
            box-sizing: border-box !important;
            width: 100% !important;
        }
        
        .center-card {
            width: 100% !important;
            max-width: 600px !important;
            margin: 0 auto !important;
        }

        /* ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³å¯¾å¿œ */
        @media (max-width: 768px) {
            .center-layout {
                padding: 16px !important;
                align-items: flex-start !important;
                padding-top: 40px !important;
            }
            
            .glass-card {
                padding: 20px !important;
            }
            
            h1 {
                font-size: 1.8rem !important;
            }
            
            .input-unified {
                font-size: 16px !important; /* iOSã‚ºãƒ¼ãƒ é˜²æ­¢ */
                padding: 12px !important;
            }
            
            .btn-unified {
                padding: 14px 20px !important;
                font-size: 14px !important;
            }
        }
        
        @media (max-width: 480px) {
            .center-layout {
                padding: 12px !important;
                padding-top: 20px !important;
            }
            
            .glass-card {
                padding: 16px !important;
            }
            
            h1 {
                font-size: 1.5rem !important;
            }
        }
    </style>
</head>
<body class="theme-unified user-setup-page">
    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ -->
    <div id="loadingScreen" class="center-layout">
        <div class="glass-card center-card text-center">
            <div class="spinner mb-4"></div>
            <h2 class="text-xl font-semibold text-gray-700">èªè¨¼çŠ¶æ…‹ã‚’ç¢ºèªä¸­...</h2>
            <p class="text-gray-500 mt-2">ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„</p>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div id="mainContent" class="center-layout" style="display: none;">
        <div class="glass-card center-card">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="text-center mb-8">
                <div class="bg-gradient-to-br from-green-100 to-blue-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                    <i class="fas fa-user-cog text-green-600 text-3xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">å€‹äººè¨­å®š</h1>
                <p class="text-gray-600">CEã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  V2</p>
                <div class="mt-4 text-right">
                    <div class="text-sm text-gray-500">ãƒ­ã‚°ã‚¤ãƒ³ä¸­</div>
                    <div id="currentUser" class="font-semibold text-gray-800"></div>
                </div>
            </div>

            <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
            <div id="statusMessage" class="status-unified mb-6" style="display: none;"></div>

            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šãƒ•ã‚©ãƒ¼ãƒ  -->
            <div id="userSetupSection">
                <div class="text-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-2">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®š</h2>
                    <p class="text-gray-600 text-sm">å€‹äººæƒ…å ±ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã‚’è¡Œã£ã¦ãã ã•ã„</p>
                </div>

                <form id="setupForm" class="space-y-6">
                    <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼åè¡¨ç¤º -->
                    <div>
                        <label class="block text-sm font-bold mb-2 text-gray-700">
                            <i class="fas fa-user text-green-600 mr-2"></i>ãƒ¦ãƒ¼ã‚¶ãƒ¼å
                        </label>
                        <div id="usernameDisplay" class="input-unified bg-gray-50 cursor-not-allowed"></div>
                        <p class="text-xs text-gray-500 mt-1">â€»ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯å¤‰æ›´ã§ãã¾ã›ã‚“</p>
                    </div>

                    <!-- è¡¨ç¤ºåå…¥åŠ› -->
                    <div>
                        <label for="displayNameInput" class="block text-sm font-bold mb-2 text-gray-700">
                            <i class="fas fa-id-card text-green-600 mr-2"></i>è¡¨ç¤ºå
                        </label>
                        <input type="text" id="displayNameInput" 
                               class="input-unified"
                               placeholder="ç”»é¢ã«è¡¨ç¤ºã™ã‚‹åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" 
                               autocomplete="name">
                        <p class="text-xs text-gray-500 mt-1">â€»ã‚·ã‚¹ãƒ†ãƒ å†…ã§ã®è¡¨ç¤ºåã¨ã—ã¦ä½¿ç”¨ã•ã‚Œã¾ã™</p>
                    </div>

                    <!-- æ¨©é™ãƒ¬ãƒ™ãƒ«è¡¨ç¤º -->
                    <div>
                        <label class="block text-sm font-bold mb-2 text-gray-700">
                            <i class="fas fa-shield text-green-600 mr-2"></i>æ¨©é™ãƒ¬ãƒ™ãƒ«
                        </label>
                        <div id="roleDisplay" class="input-unified bg-gray-50 cursor-not-allowed"></div>
                    </div>

                    <!-- æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ -->
                    <div>
                        <label for="newPassword" class="block text-sm font-bold mb-2 text-gray-700">
                            <i class="fas fa-lock text-green-600 mr-2"></i>æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ *
                        </label>
                        <div class="relative">
                            <input type="password" id="newPassword" 
                                   class="input-unified pr-12"
                                   placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" 
                                   required autocomplete="new-password">
                            <button type="button" onclick="togglePassword('newPassword')" 
                                    class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div id="passwordStrength" class="text-xs mt-2"></div>
                    </div>

                    <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª -->
                    <div>
                        <label for="confirmPassword" class="block text-sm font-bold mb-2 text-gray-700">
                            <i class="fas fa-lock text-green-600 mr-2"></i>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª *
                        </label>
                        <div class="relative">
                            <input type="password" id="confirmPassword" 
                                   class="input-unified pr-12"
                                   placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å†å…¥åŠ›ã—ã¦ãã ã•ã„" 
                                   required autocomplete="new-password">
                            <button type="button" onclick="togglePassword('confirmPassword')" 
                                    class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div id="passwordMatch" class="text-xs mt-2"></div>
                    </div>

                    <!-- ä¿å­˜ãƒœã‚¿ãƒ³ -->
                    <button type="submit" id="saveButton" class="btn-unified btn-primary-unified w-full">
                        <i class="fas fa-save mr-2"></i>è¨­å®šã‚’ä¿å­˜ã—ã¦HOMEã¸
                    </button>
                </form>

                <!-- ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ -->
                <div class="text-center mt-6">
                    <button onclick="logout()" class="btn-unified btn-outline-unified w-full">
                        <i class="fas fa-sign-out-alt mr-2"></i>ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // çµ±ä¸€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚·ã‚¹ãƒ†ãƒ 
        window.showMessage = window.showMessage || function(msg, type='info') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.className = `status-unified ${type}`;
            statusDiv.textContent = msg;
            statusDiv.style.display = 'block';
            setTimeout(() => statusDiv.style.display = 'none', 5000);
        };

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let auth, database;
        let currentUserData = null;
        let isProcessing = false;

        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ¤œè¨¼
        function validatePassword(password) {
            const minLength = 8;
            const hasUpper = /[A-Z]/.test(password);
            const hasLower = /[a-z]/.test(password);
            const hasNumber = /\d/.test(password);
            const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(password);

            let strength = 0;
            let feedback = [];

            if (password.length >= minLength) strength++;
            else feedback.push(`${minLength}æ–‡å­—ä»¥ä¸Š`);

            if (hasUpper) strength++;
            else feedback.push('å¤§æ–‡å­—');

            if (hasLower) strength++;
            else feedback.push('å°æ–‡å­—');

            if (hasNumber) strength++;
            else feedback.push('æ•°å­—');

            if (hasSpecial) strength++;
            else feedback.push('ç‰¹æ®Šæ–‡å­—');

            return { strength, feedback, isValid: strength >= 4 };
        }

        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¼·åº¦è¡¨ç¤ºæ›´æ–°
        function updatePasswordStrength() {
            const password = document.getElementById('newPassword').value;
            const strengthDiv = document.getElementById('passwordStrength');

            if (!password) {
                strengthDiv.innerHTML = '';
                return;
            }

            const validation = validatePassword(password);
            const colors = ['text-red-600', 'text-orange-600', 'text-yellow-600', 'text-green-600', 'text-green-700'];
            const labels = ['å¼±ã„', 'ã‚„ã‚„å¼±ã„', 'æ™®é€š', 'å¼·ã„', 'éå¸¸ã«å¼·ã„'];

            strengthDiv.innerHTML = `
                <span class="${colors[validation.strength - 1] || 'text-red-600'}">
                    ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¼·åº¦: ${labels[validation.strength - 1] || 'å¼±ã„'}
                </span>
                ${validation.feedback.length > 0 ? `<br>å¿…è¦ãªè¦ç´ : ${validation.feedback.join(', ')}` : ''}
            `;
        }

        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¸€è‡´ãƒã‚§ãƒƒã‚¯
        function checkPasswordMatch() {
            const password = document.getElementById('newPassword').value;
            const confirm = document.getElementById('confirmPassword').value;
            const matchDiv = document.getElementById('passwordMatch');

            if (!confirm) {
                matchDiv.innerHTML = '';
                return false;
            }

            const isMatch = password === confirm;
            matchDiv.innerHTML = `<span class="${isMatch ? 'text-green-600' : 'text-red-600'}">
                ${isMatch ? 'âœ“ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¦ã„ã¾ã™' : 'âœ— ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“'}
            </span>`;
            return isMatch;
        }

        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¡¨ç¤ºåˆ‡æ›¿
        function togglePassword(fieldId) {
            const field = document.getElementById(fieldId);
            const icon = field.nextElementSibling.querySelector('i');

            if (field.type === 'password') {
                field.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                field.type = 'password';
                icon.className = 'fas fa-eye';
            }
        }

        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥åŒ–ï¼ˆPBKDF2-SHA256ï¼‰
        async function hashPasswordPBKDF2(password, iterations = 100000) {
            const enc = new TextEncoder();
            const salt = crypto.getRandomValues(new Uint8Array(16));
            
            const keyMaterial = await crypto.subtle.importKey(
                'raw', 
                enc.encode(password), 
                'PBKDF2', 
                false, 
                ['deriveBits']
            );
            
            const bits = await crypto.subtle.deriveBits(
                { name: 'PBKDF2', salt, iterations, hash: 'SHA-256' },
                keyMaterial,
                256
            );
            
            const hashB64 = btoa(String.fromCharCode(...new Uint8Array(bits)));
            const saltB64 = btoa(String.fromCharCode(...salt));
            
            return { hash: hashB64, salt: saltB64, iterations };
        }

        // å¼·åŒ–ã•ã‚ŒãŸåˆæœŸåŒ–é–¢æ•°
        async function init() {
            try {
                console.log('ğŸš€ user-setup: åˆæœŸåŒ–é–‹å§‹');
                
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’ç¢ºå®Ÿã«è¡¨ç¤º
                document.getElementById('loadingScreen').style.display = 'flex';
                document.getElementById('mainContent').style.display = 'none';

                // FirebaseåˆæœŸåŒ–å¾…æ©Ÿï¼ˆ10ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰
                console.log('ğŸ”„ FirebaseåˆæœŸåŒ–å¾…æ©Ÿ...');
                let firebaseReady = false;
                
                if (typeof window.waitForFirebase === 'function') {
                    try {
                        await Promise.race([
                            window.waitForFirebase(),
                            new Promise((_, reject) => 
                                setTimeout(() => reject(new Error('FirebaseåˆæœŸåŒ–ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ')), 10000)
                            )
                        ]);
                        firebaseReady = true;
                        console.log('âœ… FirebaseåˆæœŸåŒ–å®Œäº†');
                    } catch (e) {
                        console.warn('âš ï¸ FirebaseåˆæœŸåŒ–ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ:', e.message);
                    }
                }

                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯åˆæœŸåŒ–
                if (!firebaseReady) {
                    console.log('ğŸ” ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯åˆæœŸåŒ–å®Ÿè¡Œ');
                    if (!firebase.apps.length) {
                        firebase.initializeApp(window.firebaseConfig);
                    }
                    window.auth = firebase.auth();
                    window.database = firebase.database();
                }

                auth = window.auth;
                database = window.database;

                if (!auth || !database) {
                    throw new Error('FirebaseåˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                // å¤šé‡ã‚»ãƒƒã‚·ãƒ§ãƒ³å¾©å…ƒãƒ­ã‚¸ãƒƒã‚¯
                let uid, username, role;
                const urlParams = new URLSearchParams(window.location.search);
                
                // 1. URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å¾©å…ƒï¼ˆæœ€å„ªå…ˆï¼‰
                const uidFromUrl = urlParams.get('uid');
                const usernameFromUrl = urlParams.get('username');
                const roleFromUrl = urlParams.get('role');

                if (uidFromUrl && usernameFromUrl) {
                    uid = uidFromUrl;
                    username = usernameFromUrl;
                    role = roleFromUrl || 'viewer';
                    sessionStorage.setItem('targetUID', uid);
                    sessionStorage.setItem('currentUsername', username);
                    sessionStorage.setItem('userRole', role);
                    console.log('âœ… URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰èªè¨¼æƒ…å ±å¾©å…ƒ');
                } else {
                    // 2. sessionStorageã‹ã‚‰å¾©å…ƒ
                    uid = sessionStorage.getItem('targetUID');
                    username = sessionStorage.getItem('currentUsername');
                    role = sessionStorage.getItem('userRole') || 'viewer';
                    
                    if (!uid || !username) {
                        // 3. localStorageã‹ã‚‰å¾©å…ƒï¼ˆHOMEã§ä¿å­˜ã—ãŸæƒ…å ±ï¼‰
                        try {
                            const saved = localStorage.getItem('dashboardAuth');
                            if (saved) {
                                const data = JSON.parse(saved);
                                if (data?.uid && data?.username) {
                                    uid = data.uid;
                                    username = data.username;
                                    role = data.role || 'viewer';
                                    sessionStorage.setItem('targetUID', uid);
                                    sessionStorage.setItem('currentUsername', username);
                                    sessionStorage.setItem('userRole', role);
                                    console.log('âœ… localStorageã‹ã‚‰èªè¨¼æƒ…å ±å¾©å…ƒ');
                                }
                            }
                        } catch (e) {
                            console.warn('localStorageå¾©å…ƒã‚¨ãƒ©ãƒ¼:', e);
                        }
                    }
                }

                // èªè¨¼æƒ…å ±ãŒå–å¾—ã§ããªã„å ´åˆã¯ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸
                if (!uid || !username) {
                    console.error('âŒ èªè¨¼æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    showMessage('èªè¨¼æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚Šã¾ã™ã€‚', 'error');
                    setTimeout(() => location.href = '../index.html', 2000);
                    return;
                }

                // åŒ¿åèªè¨¼ã®ç¢ºä¿ï¼ˆ8ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰
                console.log('ğŸ”„ åŒ¿åèªè¨¼ç¢ºèª...');
                try {
                    if (!auth.currentUser) {
                        await Promise.race([
                            auth.signInAnonymously(),
                            new Promise((_, reject) => 
                                setTimeout(() => reject(new Error('èªè¨¼ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ')), 8000)
                            )
                        ]);
                        console.log('âœ… åŒ¿åèªè¨¼æˆåŠŸ');
                    } else {
                        console.log('âœ… æ—¢å­˜èªè¨¼ç¢ºèªæ¸ˆã¿');
                    }
                } catch (e) {
                    console.error('âŒ åŒ¿åèªè¨¼ã‚¨ãƒ©ãƒ¼:', e);
                    showMessage('èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚Šã¾ã™ã€‚', 'error');
                    setTimeout(() => location.href = '../index.html', 2000);
                    return;
                }

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆ8ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰
                console.log('ğŸ”„ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—...');
                const dataRoot = window.DATA_ROOT || 'ceScheduleV2';
                let userSnap;
                
                try {
                    userSnap = await Promise.race([
                        database.ref(`${dataRoot}/users/${uid}`).once('value'),
                        new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ')), 8000)
                        )
                    ]);
                } catch (e) {
                    console.error('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', e);
                    showMessage('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
                    setTimeout(() => location.href = '../index.html', 2000);
                    return;
                }

                if (!userSnap?.exists()) {
                    console.error('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã›ã‚“');
                    showMessage('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
                    setTimeout(() => location.href = '../index.html', 2000);
                    return;
                }

                currentUserData = userSnap.val();
                console.log('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†');

                // UIè¨­å®š
                document.getElementById('currentUser').textContent = currentUserData.username || 'Unknown';
                document.getElementById('usernameDisplay').textContent = currentUserData.username || '';
                document.getElementById('displayNameInput').value = currentUserData.displayName || currentUserData.username || '';
                
                const roleBadges = {
                    admin: 'ç®¡ç†è€…',
                    editor: 'ç·¨é›†è€…', 
                    viewer: 'é–²è¦§è€…'
                };
                document.getElementById('roleDisplay').textContent = roleBadges[currentUserData.role] || 'ä¸æ˜';

                // ç”»é¢è¡¨ç¤º
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('mainContent').style.display = 'flex';
                console.log('âœ… åˆæœŸåŒ–å®Œäº† - UIè¡¨ç¤º');

                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
                document.getElementById('newPassword').addEventListener('input', updatePasswordStrength);
                document.getElementById('confirmPassword').addEventListener('input', checkPasswordMatch);
                document.getElementById('setupForm').addEventListener('submit', saveSettings);

            } catch (error) {
                console.error('âŒ åˆæœŸåŒ–è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
                setTimeout(() => location.href = '../index.html', 3000);
            }
        }

        // è¨­å®šä¿å­˜ï¼ˆå®Œå…¨ç‰ˆï¼‰
        async function saveSettings(event) {
            event.preventDefault();
            
            if (isProcessing) return;

            const displayName = document.getElementById('displayNameInput').value.trim();
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const saveButton = document.getElementById('saveButton');

            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if (!newPassword || !confirmPassword) {
                showMessage('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            if (!validatePassword(newPassword).isValid) {
                showMessage('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å¼·åº¦ãŒä¸ååˆ†ã§ã™', 'error');
                return;
            }

            if (!checkPasswordMatch()) {
                showMessage('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“', 'error');
                return;
            }

            // å‡¦ç†é–‹å§‹
            isProcessing = true;
            saveButton.disabled = true;
            saveButton.innerHTML = '<div class="spinner inline-block mr-2"></div>ä¿å­˜ä¸­...';

            try {
                const uid = sessionStorage.getItem('targetUID');
                const username = sessionStorage.getItem('currentUsername');
                
                if (!uid || !username) {
                    throw new Error('ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ãŒç„¡åŠ¹ã§ã™');
                }

                // åŒ¿åèªè¨¼ç¢ºèª
                if (!auth.currentUser) {
                    await auth.signInAnonymously();
                }

                // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥åŒ–
                const hashedPassword = await hashPasswordPBKDF2(newPassword);

                // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ›´æ–°
                const dataRoot = window.DATA_ROOT || 'ceScheduleV2';
                const updates = {
                    displayName: displayName || currentUserData.displayName || currentUserData.username,
                    password: hashedPassword,
                    setupCompleted: true,
                    hasCompletedSetup: true,
                    needsSetup: false,
                    passwordResetCompleted: false,
                    fromPending: false,
                    isInitialUser: false,
                    lastUpdate: firebase.database.ServerValue.TIMESTAMP,
                    setupCompletedAt: firebase.database.ServerValue.TIMESTAMP,
                    updatedBy: 'user-setup'
                };

                await database.ref(`${dataRoot}/users/${uid}`).update(updates);

                // å¾…æ©Ÿãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
                try {
                    await database.ref(`${dataRoot}/pendingUsers/${username}`).remove();
                } catch (e) { /* å­˜åœ¨ã—ãªã„å ´åˆã¯ç„¡è¦– */ }
                
                try {
                    await database.ref(`${dataRoot}/initialUsers/${uid}`).remove();
                } catch (e) { /* å­˜åœ¨ã—ãªã„å ´åˆã¯ç„¡è¦– */ }

                // ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°
                sessionStorage.setItem('userRole', currentUserData.role || 'viewer');

                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨HOMEã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                showMessage('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚HOMEã¸ç§»å‹•ã—ã¾ã™ã€‚', 'success');
                
                setTimeout(() => {
                    location.href = './home.html';
                }, 1500);

            } catch (error) {
                console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || error), 'error');
            } finally {
                isProcessing = false;
                saveButton.disabled = false;
                saveButton.innerHTML = '<i class="fas fa-save mr-2"></i>è¨­å®šã‚’ä¿å­˜ã—ã¦HOMEã¸';
            }
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        async function logout() {
            try {
                await auth?.signOut?.();
            } catch (e) { /* ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦– */ }
            
            sessionStorage.clear();
            localStorage.clear();
            location.href = '../index.html';
        }

        // åˆæœŸåŒ–å®Ÿè¡Œ
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
