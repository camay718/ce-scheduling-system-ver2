<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>勤務表管理 - CEスケジュール管理システム V2</title>
    
    <!-- 外部ライブラリ -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/theme-unified.css?v=20241217">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="../js/config/firebase-config.js"></script>
    <script src="../js/core/auth-guard.js"></script>

    <style>
        /* 勤務表管理専用スタイル */
        .schedule-layout {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .schedule-sidebar {
            width: 300px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border-right: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            position: relative;
            flex-shrink: 0;
            z-index: 90;
        }

.schedule-sidebar.collapsed {
    width: 60px;
    transform: none;
}

        .sidebar-content {
            padding: 20px;
            width: 300px;
            transition: opacity 0.3s ease;
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .sidebar-toggle {
            position: absolute;
            top: 15px;
            right: -15px;
            background: var(--brand-primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            z-index: 101;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: right 0.3s ease;
        }

        .schedule-sidebar.collapsed .sidebar-toggle {
            right: -45px;
        }

.schedule-main {
    flex-grow: 1;
    padding: 20px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    transition: all 0.3s ease;
}

        /* テーブルのスケール表示対応 */
.work-schedule-table-wrapper {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    margin-top: 20px;
    position: relative;
    overflow: auto;
    height: calc(100vh - 200px);
    min-height: 600px;
}

        .work-schedule-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 9px;
            min-width: 1000px;
            transform-origin: top left;
        }

        .work-schedule-table th,
        .work-schedule-table td {
            border: 1px solid #e0e0e0;
            padding: 2px;
            text-align: center;
            vertical-align: middle;
            height: 24px;
            overflow: hidden;
            white-space: nowrap;
        }

        .work-schedule-table th {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 8px;
        }

        /* 固定列 */
        .work-schedule-table .name-header,
        .work-schedule-table .name-cell {
            position: sticky;
            left: 0;
            background: white;
            z-index: 15;
            width: 80px;
            min-width: 80px;
            max-width: 80px;
            text-align: left;
            padding-left: 6px;
        }

        .work-schedule-table .name-header {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            z-index: 20;
        }

        /* 勤務区分別背景色 */
        .work-schedule-table .work-cell.type-ope { 
            background: #87CEEB; 
            color: #1E3A8A; 
        }

        .work-schedule-table .work-cell.type-me { 
            background: #90EE90; 
            color: #006400; 
        }

        .work-schedule-table .work-cell.type-hd { 
            background: #FFB6C1; 
            color: #8B008B; 
        }

        .work-schedule-table .work-cell.type-flex { 
            background: #FFFF99; 
            color: #B8860B; 
        }

        /* 非勤務状態（白色表示） */
        .work-schedule-table .work-cell.status-非,
        .work-schedule-table .work-cell.status-×,
        .work-schedule-table .work-cell.status-年,
        .work-schedule-table .work-cell.status-出,
        .work-schedule-table .work-cell.status-研 {
            background: white !important;
            color: #333 !important;
            border: 1px solid #ddd !important;
        }

        /* 休日セル */
        .work-schedule-table .work-cell.holiday {
            background: white !important;
            color: #333 !important;
            border: 1px solid #ddd !important;
        }

        /* 希望勤務 */
        .work-schedule-table .work-cell.desired {
            text-decoration: underline;
            text-decoration-thickness: 1px;
            text-underline-offset: 2px;
        }

        /* サマリーセル */
        .work-schedule-table .summary-cell {
            background: #f8f9fa;
            font-weight: 500;
            width: 30px;
            min-width: 30px;
            max-width: 30px;
            font-size: 7px;
        }

        /* 集計行スタイル */
        .work-schedule-table .footer-summary-row {
            background: #f1f3f4 !important;
            border-top: 2px solid #dee2e6 !important;
        }

        .work-schedule-table .footer-summary-row td {
            font-weight: 600;
            font-size: 7px;
            padding: 1px !important;
        }

        .work-schedule-table .type-label {
            background: #e9ecef !important;
            font-weight: 700;
            text-align: left !important;
            padding-left: 3px !important;
        }

        .work-schedule-table .warning-count {
            color: #dc3545 !important;
            font-weight: 700;
            background: #ffe6e6 !important;
        }

        /* スマートフォン対応 */
        @media (max-width: 768px) {
            .schedule-sidebar {
                position: fixed;
                top: 0;
                bottom: 0;
                left: -300px;
                width: 300px;
                height: 100vh;
                transform: translateX(0);
                transition: left 0.3s ease;
                z-index: 1000;
                background: rgba(255, 255, 255, 0.98);
                backdrop-filter: blur(10px);
                border-radius: 0 8px 8px 0;
                border-right: 2px solid #e5e7eb;
                overflow-y: auto;
                box-shadow: 2px 0 20px rgba(0, 0, 0, 0.15);
            }
            
            .schedule-sidebar.expanded {
                left: 0;
            }
            
            .sidebar-toggle {
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: var(--brand-primary);
                color: white;
                border-radius: 50%;
                width: 56px;
                height: 56px;
                border: none;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                z-index: 1001;
                font-size: 18px;
            }
            
            .schedule-main {
                margin-left: 0;
                padding: 12px;
                padding-bottom: 80px;
                width: 100%;
            }
        }
    </style>
</head>
<body class="theme-unified">
    <!-- ローディング -->
    <div id="loading" class="center-layout">
        <div class="glass-card center-card text-center">
            <div class="spinner mb-4"></div>
            <p class="text-gray-600">勤務表管理を読み込んでいます...</p>
        </div>
    </div>

    <!-- メインインターフェース -->
    <div id="mainInterface" class="schedule-layout" style="display:none;">
        <!-- サイドバー -->
        <div id="sidebar" class="schedule-sidebar">
            <button id="toggleSidebar" class="sidebar-toggle" title="サイドバー表示/非表示">
                <i class="fas fa-chevron-left"></i>
            </button>
            
            <div class="sidebar-content">
                <!-- ヘッダー -->
                <div class="mb-6 text-center">
                    <h1 class="text-lg font-bold text-gray-800 mb-2">
                        <i class="fas fa-table mr-2 text-green-600"></i>
                        勤務表管理
                    </h1>
                    <p class="text-xs text-gray-600">CEスケジュール管理システム V2</p>
                    <div class="mt-3 text-xs text-gray-600">
                        <span id="currentUserDisplay">ユーザー</span>
                    </div>
                </div>

                <!-- 同期ステータス -->
                <div class="mb-4">
                    <div id="mainSyncStatus" class="sync-indicator connected">
                        <div class="sync-dot pulse"></div>
                        <span class="text-xs">リアルタイム同期中</span>
                    </div>
                </div>

                <!-- 勤務表操作（管理者のみ） -->
                <div id="adminScheduleActions" class="mb-6" style="display:none;">
                    <h3 class="text-sm font-semibold mb-3">
                        <i class="fas fa-plus mr-2"></i>勤務表操作
                    </h3>
                    <div class="space-y-2">
                        <button id="createScheduleBtn" class="btn-unified btn-primary-unified btn-small w-full">
                            <i class="fas fa-edit mr-1"></i>勤務表を作成・編集
                        </button>
                    </div>
                </div>

                <!-- 表示フィルタ -->
                <div class="mb-6">
                    <h3 class="text-sm font-semibold mb-3">
                        <i class="fas fa-filter mr-2"></i>表示フィルタ
                    </h3>
                    <div class="space-y-2">
                        <div class="flex items-center">
                            <input type="radio" id="showFuture" name="timeFilter" class="mr-2" checked>
                            <label for="showFuture" class="text-xs">今後の勤務表</label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" id="showPast" name="timeFilter" class="mr-2">
                            <label for="showPast" class="text-xs">以前の勤務表</label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" id="showAll" name="timeFilter" class="mr-2">
                            <label for="showAll" class="text-xs">公開済み全て</label>
                        </div>
                        <div class="flex items-center" id="adminFilterContainer" style="display:none;">
                            <input type="checkbox" id="showHidden" class="mr-2">
                            <label for="showHidden" class="text-xs">非公開</label>
                        </div>
                    </div>
                </div>

                <!-- ナビゲーション -->
                <div class="mt-auto pt-4 border-t border-gray-200">
                    <div class="space-y-2">
                        <a href="./home.html" class="btn-unified btn-outline-unified btn-small w-full">
                            <i class="fas fa-home mr-1"></i>HOME
                        </a>
                        <button onclick="window.handleLogout()" 
                                class="btn-unified btn-outline-unified btn-small w-full text-red-600 border-red-600">
                            <i class="fas fa-sign-out-alt mr-1"></i>ログアウト
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- メインコンテンツ -->
        <div class="schedule-main">
            <!-- ヘッダー -->
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">勤務表管理</h2>
                <p class="text-gray-600">作成済みの勤務表の閲覧・管理を行います</p>
            </div>

            <!-- 期間表示・操作 -->
            <div class="glass-card p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h3 id="currentPeriodDisplay" class="text-xl font-bold">期間を読み込み中...</h3>
                        <div id="periodDetails" class="text-sm text-gray-600"></div>
                    </div>
                    <div class="flex gap-2">
                        <button id="prevPeriodBtn" class="btn-unified btn-outline-unified">
                            <i class="fas fa-chevron-left mr-1"></i>前の期間
                        </button>
                        <button id="nextPeriodBtn" class="btn-unified btn-outline-unified">
                            次の期間<i class="fas fa-chevron-right ml-1"></i>
                        </button>
                    </div>
                </div>
                
                <div class="flex justify-center gap-3">
                    <div id="adminControlsContainer" class="flex gap-2" style="display:none;">
                        <!-- 管理者操作ボタンがここに動的生成 -->
                    </div>
                </div>
            </div>

            <!-- 勤務表表示エリア -->
            <div id="workScheduleDisplayArea" class="flex-grow min-h-0">
                <div class="text-center py-12 text-gray-500">
                    <i class="fas fa-table text-4xl mb-4"></i>
                    <h3 class="text-lg font-semibold mb-2">CE勤務表</h3>
                    <p class="mb-4">作成済みの勤務表がここに表示されます</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 軽量メッセージ機能
        window.showMessage = window.showMessage || function(msg, type='info') {
            let cont = document.getElementById('messageContainer');
            if (!cont) {
                cont = document.createElement('div');
                cont.id = 'messageContainer';
                cont.style.cssText = 'position:fixed;top:16px;left:50%;transform:translateX(-50%);z-index:9999;width:min(92vw,480px);';
                document.body.appendChild(cont);
            }
            const div = document.createElement('div');
            div.className = `status-unified ${type}`;
            div.style.marginBottom = '8px';
            div.textContent = msg;
            cont.appendChild(div);
            setTimeout(() => div.remove(), 5000);
        };

        // ログアウト処理
        window.handleLogout = async () => {
            try {
                try {
                    const entry = {
                        action: 'logout',
                        details: {},
                        uid: window.currentUserData?.uid || null,
                        username: window.currentUserData?.username || 'unknown',
                        displayName: window.currentUserData?.displayName || 'unknown',
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        userAgent: navigator.userAgent.substring(0, 100)
                    };
                    await window.database.ref(`${window.DATA_ROOT}/auditLogs`).push(entry);
                } catch (logError) {
                    console.warn('監査ログ記録失敗:', logError);
                }
                if (window.auth && window.auth.currentUser) {
                    await window.auth.signOut();
                }
            } catch (error) {
                console.error('ログアウトエラー:', error);
            } finally {
                sessionStorage.clear();
                localStorage.clear();
                window.location.href = '../index.html';
            }
        };

        // 勤務表管理クラス
        class CEScheduleManager {
            constructor() {
                this.schedules = [];
                this.currentPeriodIndex = 0;
                this.availablePeriods = [];
                this.realtimeListener = null;
                this.isInitialized = false;
                this.currentFilter = 'future'; // デフォルトは今後の勤務表
            }

            async init() {
                if (this.isInitialized) return;
                this.isInitialized = true;

                try {
                    // 認証ガード実行
                    const authSuccess = await AuthGuard.init();
                    if (!authSuccess) return;

                    // ユーザーデータ取得
                    const userData = await AuthGuard.getUserData();
                    if (!userData || !userData.setupCompleted) {
                        console.error('ユーザーデータ不正:', userData);
                        location.href = '../index.html';
                        return;
                    }

                    window.userRole = userData.role || 'viewer';
                    window.currentUserData = userData;

                    this.showInterface();
                    this.setupEventListeners();
                    await this.loadAvailablePeriods();
                    
                    console.log('✅ 勤務表管理初期化完了');
                } catch (error) {
                    console.error('勤務表管理初期化エラー:', error);
                    location.href = '../index.html';
                }
            }

            showInterface() {
                const loadingEl = document.getElementById('loading');
                const mainEl = document.getElementById('mainInterface');
                if (loadingEl) loadingEl.style.display = 'none';
                if (mainEl) mainEl.style.display = 'flex';

                this.updateUserDisplay();
                
                // 管理者のみの機能表示
                if (window.userRole === 'admin') {
                    document.getElementById('adminScheduleActions').style.display = 'block';
                    document.getElementById('adminFilterContainer').style.display = 'flex';
                }
            }

            updateUserDisplay() {
                const userData = window.currentUserData;
                if (!userData) return;
                
                const displayName = userData.displayName || userData.username || 'ユーザー';
                document.querySelectorAll('#currentUserDisplay').forEach(el => {
                    el.textContent = displayName;
                });
            }

            setupEventListeners() {
                // サイドバートグル
                const toggle = document.getElementById('toggleSidebar');
                const sidebar = document.getElementById('sidebar');
                
                if (toggle && sidebar) {
                    let isCollapsed = false;
                    toggle.onclick = () => {
                        isCollapsed = !isCollapsed;
                        if (isCollapsed) {
                            sidebar.classList.add('collapsed');
                            toggle.querySelector('i').className = 'fas fa-chevron-right';
                        } else {
                            sidebar.classList.remove('collapsed');
                            toggle.querySelector('i').className = 'fas fa-chevron-left';
                        }
                        
                        if (window.matchMedia('(max-width: 768px)').matches) {
                            sidebar.classList.toggle('expanded');
                        }
                    };
                }

                // 勤務表作成（管理者のみ）
                const createBtn = document.getElementById('createScheduleBtn');
                if (createBtn) {
                    createBtn.onclick = () => this.openScheduleEditor();
                }

                // 期間ナビゲーション
                const prevBtn = document.getElementById('prevPeriodBtn');
                const nextBtn = document.getElementById('nextPeriodBtn');
                
                if (prevBtn) prevBtn.onclick = () => this.navigatePeriod(-1);
                if (nextBtn) nextBtn.onclick = () => this.navigatePeriod(1);

                // フィルタ変更
                ['showFuture', 'showPast', 'showAll', 'showHidden'].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.onchange = () => this.applyFilters();
                    }
                });

                // テーブルスケール調整（リサイズ時）
                let resizeTimer = null;
                window.addEventListener('resize', () => {
                    clearTimeout(resizeTimer);
                    resizeTimer = setTimeout(() => {
                        if (this.isInitialized) this.fitTableToViewport();
                    }, 250);
                });

                // リアルタイム更新
                this.setupRealtimeUpdates();
            }

            setupRealtimeUpdates() {
                try {
                    if (this.realtimeListener) {
                        this.realtimeListener.off();
                    }
                    
                    this.realtimeListener = window.database.ref(`${window.DATA_ROOT}/workSchedules`);
                    this.realtimeListener.on('value', async () => {
                        console.log('🔄 公開勤務表データ更新検知');
                        await this.loadAvailablePeriods();
                        this.displayCurrentPeriod();
                    });
                } catch (error) {
                    console.warn('リアルタイム更新設定失敗:', error);
                }
            }

            async loadAvailablePeriods() {
                try {
                    const snapshot = await window.database.ref(`${window.DATA_ROOT}/workSchedules`).once('value');
                    const data = snapshot.val() || {};
                    
                    const today = new Date().toISOString().slice(0, 10);
                    
                    this.availablePeriods = Object.keys(data)
                        .map(periodKey => ({
                            key: periodKey,
                            ...data[periodKey].metadata
                        }))
                        .filter(period => {
                            // 管理者以外は非公開を除外
                            if (window.userRole !== 'admin' && period.isVisible === false) {
                                return false;
                            }
                            
                            // フィルタ適用
                            return this.applyTimeFilter(period, today);
                        })
                        .sort((a, b) => (b.publishedAt || b.createdAt || 0) - (a.publishedAt || a.createdAt || 0));
                    
                    if (this.availablePeriods.length > 0) {
                        if (this.currentPeriodIndex >= this.availablePeriods.length) {
                            this.currentPeriodIndex = 0;
                        }
                        this.displayCurrentPeriod();
                    } else {
                        this.displayNoPeriods();
                    }
                    
                    console.log(`✅ 公開勤務表読み込み完了: ${this.availablePeriods.length}件`);
                } catch (error) {
                    console.error('❌ 期間データ読み込みエラー:', error);
                    window.showMessage('勤務表データの読み込みに失敗しました', 'error');
                }
            }

            applyTimeFilter(period, today) {
                const showFuture = document.getElementById('showFuture')?.checked;
                const showPast = document.getElementById('showPast')?.checked;
                const showAll = document.getElementById('showAll')?.checked;
                
                if (showAll) {
                    return true;
                }
                
                if (showFuture) {
                    return period.endDate >= today; // 今日を含む以降
                }
                
                if (showPast) {
                    return period.endDate < today; // 今日を含まない以前
                }
                
                return true; // デフォルト
            }

            applyFilters() {
                this.loadAvailablePeriods();
            }

            navigatePeriod(direction) {
                const newIndex = this.currentPeriodIndex + direction;
                
                if (newIndex < 0 || newIndex >= this.availablePeriods.length) {
                    window.showMessage('これ以上の期間はありません', 'info');
                    return;
                }
                
                this.currentPeriodIndex = newIndex;
                this.displayCurrentPeriod();
            }

            async displayCurrentPeriod() {
                const displayEl = document.getElementById('currentPeriodDisplay');
                const detailsEl = document.getElementById('periodDetails');
                const adminControlsEl = document.getElementById('adminControlsContainer');
                
                if (this.availablePeriods.length === 0) {
                    this.displayNoPeriods();
                    return;
                }

                const currentPeriod = this.availablePeriods[this.currentPeriodIndex];
                
                if (displayEl) {
                    const visibilityStatus = currentPeriod.isVisible === false ? ' (非公開)' : '';
                    displayEl.innerHTML = `
                        ${currentPeriod.startDate} ～ ${currentPeriod.endDate}${visibilityStatus}
                    `;
                }

                if (detailsEl) {
                    detailsEl.innerHTML = `
                        (${this.currentPeriodIndex + 1}/${this.availablePeriods.length})
                        ${currentPeriod.publishedBy ? ` / 作成者: ${currentPeriod.publishedBy}` : ''}
                        ${currentPeriod.publishedAt ? ` / 公開: ${new Date(currentPeriod.publishedAt).toLocaleString('ja-JP')}` : ''}
                    `;
                }

                await this.renderWorkScheduleTable(currentPeriod.key);
                
                if (adminControlsEl && window.userRole === 'admin') {
                    adminControlsEl.innerHTML = this.renderAdminControls(currentPeriod);
                    adminControlsEl.style.display = 'flex';
                } else if (adminControlsEl) {
                    adminControlsEl.style.display = 'none';
                }

                // テーブルスケール調整
                setTimeout(() => this.fitTableToViewport(), 100);
            }

            renderAdminControls(period) {
                return `
                    <button onclick="window.ceScheduleManager.toggleVisibility('${period.key}')" 
                            class="btn-unified btn-small ${period.isVisible === false ? 'btn-success' : 'btn-warning'}" 
                            title="表示/非表示切替">
                        <i class="fas fa-eye${period.isVisible === false ? '' : '-slash'}"></i>
                        ${period.isVisible === false ? '公開' : '非公開'}
                    </button>
                    <button onclick="window.ceScheduleManager.deleteSchedule('${period.key}')" 
                            class="btn-unified btn-small btn-danger" title="削除">
                        <i class="fas fa-trash"></i>削除
                    </button>
                `;
            }

            displayNoPeriods() {
                const displayEl = document.getElementById('currentPeriodDisplay');
                const detailsEl = document.getElementById('periodDetails');
                const areaEl = document.getElementById('workScheduleDisplayArea');
                const adminControlsEl = document.getElementById('adminControlsContainer');
                
                if (displayEl) displayEl.textContent = '該当する勤務表なし';
                if (detailsEl) detailsEl.textContent = '';
                if (areaEl) {
                    const createButton = window.userRole === 'admin' ? 
                        `<button onclick="window.ceScheduleManager.openScheduleEditor()" 
                                class="btn-unified btn-primary-unified">
                            <i class="fas fa-plus mr-2"></i>最初の勤務表を作成
                        </button>` : '';
                    
                    areaEl.innerHTML = `
                        <div class="text-center py-12">
                            <i class="fas fa-calendar-plus text-4xl text-gray-400 mb-4"></i>
                            <h3 class="text-lg font-semibold text-gray-600 mb-2">CE勤務表</h3>
                            <p class="text-gray-500 mb-4">該当する勤務表がありません</p>
                            ${createButton}
                        </div>
                    `;
                }
                if (adminControlsEl) adminControlsEl.style.display = 'none';
            }

            async renderWorkScheduleTable(periodKey) {
                const areaEl = document.getElementById('workScheduleDisplayArea');
                if (!areaEl) return;

                try {
                    const snapshot = await window.database.ref(`${window.DATA_ROOT}/workSchedules/${periodKey}`).once('value');
                    const periodData = snapshot.val();
                    
                    if (!periodData || !periodData.ceList) {
                        areaEl.innerHTML = `
                            <div class="text-center py-8">
                                <i class="fas fa-exclamation-triangle text-4xl text-yellow-500 mb-4"></i>
                                <p class="text-gray-600">勤務表データまたはCEリストが見つかりません</p>
                            </div>
                        `;
                        return;
                    }

                    const scheduleData = periodData.scheduleData || {};
                    const ceList = periodData.ceList;
                    const workTypeOverrides = periodData.workTypeOverrides || {};
                    const metadata = periodData.metadata || {};
                    const dates = this.generateDateRange(new Date(metadata.startDate), new Date(metadata.endDate));

                    areaEl.innerHTML = `
                        <div class="work-schedule-table-wrapper">
                            <table class="work-schedule-table">
                                ${this.generateTableHTML(dates, scheduleData, ceList, workTypeOverrides)}
                            </table>
                        </div>
                    `;

                } catch (error) {
                    console.error('❌ 勤務表表示エラー:', error);
                    areaEl.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                            <p class="text-gray-600">勤務表の読み込みでエラーが発生しました</p>
                        </div>
                    `;
                }
            }

            // テーブルを画面にフィット
            // テーブル最適表示（完全修正版）
fitTableToViewport() {
    setTimeout(() => {
        const wrapper = document.querySelector('.work-schedule-table-wrapper');
        const table = wrapper?.querySelector('.work-schedule-table');
        if (!wrapper || !table) return;

        // 初期化
        table.style.transform = 'none';
        table.style.fontSize = '9px';

        // 利用可能領域の計算
        const wrapperRect = wrapper.getBoundingClientRect();
        const availableWidth = wrapperRect.width - 16;
        const availableHeight = wrapperRect.height - 16;
        
        // テーブルの自然サイズ取得
        const tableWidth = table.scrollWidth;
        const tableHeight = table.scrollHeight;
        
        // スケール計算（最小0.6、最大1.2）
        const scaleX = availableWidth / tableWidth;
        const scaleY = availableHeight / tableHeight;
        let scale = Math.min(scaleX, scaleY);
        scale = Math.max(0.6, Math.min(1.2, scale));

        // 適用
        table.style.transform = `scale(${scale})`;
        table.style.transformOrigin = 'top left';
        
        console.log(`📏 テーブル表示最適化: scale=${scale.toFixed(3)}, 領域=${Math.round(availableWidth)}x${Math.round(availableHeight)}`);
    }, 150);
}

            generateDateRange(startDate, endDate) {
                const dates = [];
                const current = new Date(startDate);
                
                while (current <= endDate) {
                    dates.push(new Date(current));
                    current.setDate(current.getDate() + 1);
                }
                
                return dates;
            }

            formatDate(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            // 祝日判定（簡易実装）
            isJapaneseHoliday(date) {
                const holidays2024 = new Set([
                    '2024-01-01', '2024-01-08', '2024-02-11', '2024-02-12', '2024-02-23',
                    '2024-03-20', '2024-04-29', '2024-05-03', '2024-05-04', '2024-05-05',
                    '2024-07-15', '2024-08-11', '2024-08-12', '2024-09-16', '2024-09-22',
                    '2024-09-23', '2024-10-14', '2024-11-03', '2024-11-04', '2024-11-23',
                    '2024-12-23'
                ]);
                
                const holidays2025 = new Set([
                    '2025-01-01', '2025-01-13', '2025-02-11', '2025-02-23', '2025-03-20',
                    '2025-04-29', '2025-05-03', '2025-05-04', '2025-05-05', '2025-07-21',
                    '2025-08-11', '2025-09-15', '2025-09-23', '2025-10-13', '2025-11-03',
                    '2025-11-23', '2025-12-23'
                ]);

                const dateKey = this.formatDate(date);
                return holidays2024.has(dateKey) || holidays2025.has(dateKey);
            }

            getEffectiveWorkType(ceId, dateKey, ceList, workTypeOverrides) {
                const ce = ceList.find(c => c.id === ceId);
                if (!ce) return 'ME';

                const overrides = workTypeOverrides[ceId];
                if (Array.isArray(overrides)) {
                    const validOverrides = overrides
                        .filter(override => dateKey >= override.startDate && dateKey <= override.endDate)
                        .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                    
                    if (validOverrides.length > 0) {
                        return validOverrides[0].workType;
                    }
                } else if (overrides && overrides.startDate && dateKey >= overrides.startDate && dateKey <= overrides.endDate) {
                    return overrides.workType;
                }
                
                return ce.workType || 'ME';
            }

            generateTableHTML(dates, scheduleData, ceList, workTypeOverrides) {
                let html = '<thead><tr><th class="name-header">氏名</th>';
                
                dates.forEach(date => {
                    const dayOfWeek = ['日', '月', '火', '水', '木', '金', '土'][date.getDay()];
                    const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                    const isHoliday = this.isJapaneseHoliday(date);
                    
                    let headerClass = '';
                    if (date.getDay() === 0 || isHoliday) {
                        headerClass = 'text-red-600';
                    } else if (date.getDay() === 6) {
                        headerClass = 'text-blue-600';
                    }
                    
                    html += `
                        <th class="date-col">
                            <div>${date.getDate()}</div>
                            <div class="text-xs ${headerClass}">${dayOfWeek}</div>
                        </th>
                    `;
                });
                
                const summaryHeaders = ['A', 'A1', 'B', '非', '×', '年', '出', '研', '休日数', '実勤務', '当直回数'];
                summaryHeaders.forEach(header => {
                    html += `<th class="summary-cell">${header}</th>`;
                });
                html += '</tr></thead>';
                
                html += '<tbody>';
                ceList.forEach(ce => {
                    const fullName = ce.fullName || ce.name || '';
                    html += `<tr><td class="name-cell">
                        <div class="font-medium">${fullName}</div>
                    </td>`;
                    
                    const summary = { A: 0, A1: 0, B: 0, non: 0, off: 0, year: 0, trip: 0, training: 0, holidays: 0, actual: 0, night: 0 };
                    
                    dates.forEach(date => {
                        const dateKey = this.formatDate(date);
                        const workData = scheduleData[ce.id]?.[dateKey] || {};
                        const isWeekendOrHoliday = date.getDay() === 0 || date.getDay() === 6 || this.isJapaneseHoliday(date);
                        const status = workData.customText?.trim() || workData.status || (isWeekendOrHoliday ? '×' : 'A');
                        const desired = workData.desired || false;
                        
                        const effectiveWorkType = this.getEffectiveWorkType(ce.id, dateKey, ceList, workTypeOverrides);
                        
                        if (isWeekendOrHoliday) summary.holidays++;
                        switch (workData.status || (isWeekendOrHoliday ? '×' : 'A')) {
                            case 'A': summary.A++; summary.actual++; break;
                            case 'A1': summary.A1++; summary.actual++; break;
                            case 'B': summary.B++; summary.actual++; summary.night++; break;
                            case '非': summary.non++; summary.actual++; break;
                            case '×': summary.off++; break;
                            case '年': summary.year++; summary.actual++; break;
                            case '出': summary.trip++; summary.actual++; break;
                            case '研': summary.training++; summary.actual++; break;
                        }
                        
                        let cellClass = `work-cell type-${effectiveWorkType.toLowerCase()}`;
                        if (workData.status) cellClass += ` status-${workData.status}`;
                        if (desired) cellClass += ' desired';
                        if (isWeekendOrHoliday) cellClass += ' holiday';
                        
                        html += `<td class="${cellClass}">${status}</td>`;
                    });
                    
                    const summaryValues = [summary.A, summary.A1, summary.B, summary.non, summary.off, summary.year, summary.trip, summary.training, summary.holidays, summary.actual, summary.night];
                    summaryValues.forEach(value => {
                        html += `<td class="summary-cell">${value}</td>`;
                    });
                    
                    html += '</tr>';
                });
                html += '</tbody>';

                // フッター集計
html += '<tfoot>';
footerTypes.forEach(type => {
    html += `<tr class="footer-summary-row"><th class="type-label" colspan="2">${type.label}</th>`;
    
    dates.forEach(date => {
        const dateKey = this.formatDate(date);
        let count = 0;
        ceList.forEach(ce => {
            const workData = scheduleData[ce.id]?.[dateKey] || {};
            const isWeekendOrHoliday = date.getDay() === 0 || date.getDay() === 6 || this.isJapaneseHoliday(date);
            const status = workData.status || (isWeekendOrHoliday ? '×' : 'A');
            const effectiveType = this.getEffectiveWorkType(ce.id, dateKey, ceList, workTypeOverrides);
            
            if (type.filter(effectiveType, status)) {
                count++;
            }
        });
        
        const cellClass = (type.target !== undefined && count !== type.target) ? 'warning-count' : '';
        html += `<td class="${cellClass}">${count}</td>`;
    });
    
    // サマリー列は空白で統一（列数一致のため）
    summaryHeaders.forEach(() => {
        html += '<td class="summary-cell"></td>';
    });
    
    html += '</tr>';
});

html += '</tfoot>';
                return html;
            }

            async toggleVisibility(periodKey) {
                if (window.userRole !== 'admin') {
                    window.showMessage('管理者権限が必要です', 'warning');
                    return;
                }

                try {
                    const snapshot = await window.database.ref(`${window.DATA_ROOT}/workSchedules/${periodKey}/metadata`).once('value');
                    const metadata = snapshot.val();
                    
                    const newVisibility = !(metadata?.isVisible !== false);
                    await window.database.ref(`${window.DATA_ROOT}/workSchedules/${periodKey}/metadata/isVisible`).set(newVisibility);
                    
                    window.showMessage(`勤務表を${newVisibility ? '表示' : '非表示'}に設定しました`, 'success');
                    
                    await this.loadAvailablePeriods();
                    
                } catch (error) {
                    console.error('❌ 表示切替エラー:', error);
                    window.showMessage('表示設定の変更に失敗しました', 'error');
                }
            }

            async deleteSchedule(periodKey) {
                if (window.userRole !== 'admin') {
                    window.showMessage('管理者権限が必要です', 'warning');
                    return;
                }

                const period = this.availablePeriods.find(p => p.key === periodKey);
                if (!period) return;

                if (!confirm(`勤務表「${period.startDate} ～ ${period.endDate}」を完全に削除しますか？\n\nこの操作は元に戻せません。`)) {
                    return;
                }

                try {
                    await window.database.ref(`${window.DATA_ROOT}/workSchedules/${periodKey}`).remove();
                    window.showMessage('勤務表を削除しました', 'success');
                    
                    await this.loadAvailablePeriods();
                    
                } catch (error) {
                    console.error('❌ 勤務表削除エラー:', error);
                    window.showMessage('勤務表の削除に失敗しました', 'error');
                }
            }

            openScheduleEditor() {
                if (window.userRole !== 'admin') {
                    window.showMessage('管理者権限が必要です', 'warning');
                    return;
                }
                
                const targetUID = sessionStorage.getItem('targetUID');
                const currentUsername = sessionStorage.getItem('currentUsername');
                
                if (!targetUID || !currentUsername) {
                    window.showMessage('セッション情報が不足しています。再度ログインしてください。', 'error');
                    return;
                }
                
                const params = new URLSearchParams({
                    uid: targetUID,
                    username: currentUsername,
                    role: window.userRole,
                    timestamp: Date.now()
                });
                
                const url = `work-schedule-editor.html?${params.toString()}`;
                
                const win = window.open(url, 'workScheduleEditor', 'width=1400,height=900,scrollbars=yes,resizable=yes');
                
                if (!win || win.closed || typeof win.closed === 'undefined') {
                    if (confirm('新しいタブで開けませんでした。同じタブで勤務表エディタを開きますか？')) {
                        window.location.href = url;
                    } else {
                        window.showMessage('勤務表エディタを開くには、ポップアップを許可してください', 'warning');
                    }
                } else {
                    console.log('✅ 勤務表エディタを新しいタブで開きました');
                }
            }
        }

        // 初期化
        window.ceScheduleManager = null;
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                window.ceScheduleManager = new CEScheduleManager();
                await window.ceScheduleManager.init();
                console.log('✅ 勤務表管理初期化完了');
            } catch (error) {
                console.error('❌ 勤務表管理初期化エラー:', error);
                window.showMessage('勤務表管理の初期化に失敗しました', 'error');
            }
        });
    </script>
</body>
</html>
