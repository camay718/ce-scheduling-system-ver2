<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEスケジュール管理システム V2 - 統合ログイン</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- デバッグログパネル -->
    <div id="debugPanel" class="fixed top-4 right-4 bg-black bg-opacity-80 text-green-400 p-4 rounded-lg text-xs max-w-md max-h-96 overflow-y-auto font-mono" style="display: none;">
        <div class="flex justify-between items-center mb-2">
            <span class="text-yellow-400 font-bold">🔧 デバッグログ</span>
            <button onclick="toggleDebug()" class="text-red-400 hover:text-red-300">✕</button>
        </div>
        <div id="debugLog"></div>
    </div>

    <!-- デバッグボタン -->
    <button onclick="toggleDebug()" class="fixed top-4 left-4 bg-gray-800 text-white px-3 py-2 rounded-lg text-sm hover:bg-gray-700">
        <i class="fas fa-bug"></i> Debug
    </button>

    <div class="container mx-auto px-4 py-8">
        <!-- ログイン画面 -->
        <div id="loginScreen" class="max-w-md mx-auto bg-white rounded-xl shadow-2xl overflow-hidden">
            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 px-8 py-6">
                <h1 class="text-2xl font-bold text-white text-center">
                    <i class="fas fa-calendar-alt mr-2"></i>
                    CEスケジュール管理システム V2
                </h1>
                <p class="text-blue-100 text-center mt-2">統合ログインシステム</p>
            </div>
            
            <div class="px-8 py-6">
                <form id="loginForm" onsubmit="return false;">
                    <div class="mb-4">
                        <label for="loginInput" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-user mr-1"></i>
                            ユーザー名 または メールアドレス
                        </label>
                        <input type="text" id="loginInput" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                               placeholder="例: 田中太郎 または tanaka@example.com" 
                               autocomplete="username"
                               required>
                    </div>
                    
                    <div class="mb-6">
                        <label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-lock mr-1"></i>
                            パスワード
                        </label>
                        <input type="password" id="loginPassword" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                               placeholder="••••••••" 
                               autocomplete="current-password"
                               required>
                    </div>
                    
                    <button type="submit" id="loginBtn" onclick="handleLogin()"
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                        <i class="fas fa-sign-in-alt mr-2"></i>
                        ログイン
                    </button>
                </form>
                
                <div id="loginStatus" class="mt-4 text-center text-sm"></div>
            </div>
        </div>

        <!-- 個人設定画面 -->
        <div id="setupScreen" class="max-w-md mx-auto bg-white rounded-xl shadow-2xl overflow-hidden" style="display: none;">
            <div class="bg-gradient-to-r from-green-600 to-teal-600 px-8 py-6">
                <h1 class="text-2xl font-bold text-white text-center">
                    <i class="fas fa-user-cog mr-2"></i>
                    個人設定
                </h1>
                <p class="text-green-100 text-center mt-2">初期設定を完了してください</p>
            </div>
            
            <div class="px-8 py-6">
                <div id="currentUserInfo" class="mb-6 p-4 bg-blue-50 rounded-lg">
                    <h3 class="font-medium text-gray-700 mb-2">現在のユーザー情報</h3>
                    <div id="userInfoDisplay" class="text-sm text-gray-600"></div>
                </div>
                
                <form id="setupForm" onsubmit="return false;">
                    <div class="mb-4">
                        <label for="newUsername" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-user-edit mr-1"></i>
                            新しいユーザー名
                        </label>
                        <input type="text" id="newUsername" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" 
                               placeholder="例: 田中太郎"
                               autocomplete="username">
                    </div>
                    
                    <div class="mb-4">
                        <label for="newPassword" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-key mr-1"></i>
                            新しいパスワード
                        </label>
                        <input type="password" id="newPassword" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" 
                               placeholder="8文字以上の安全なパスワード"
                               autocomplete="new-password"
                               required>
                    </div>
                    
                    <div class="mb-6">
                        <label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-check-double mr-1"></i>
                            パスワード確認
                        </label>
                        <input type="password" id="confirmPassword" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" 
                               placeholder="上記と同じパスワード"
                               autocomplete="new-password"
                               required>
                    </div>
                    
                    <button type="submit" id="setupBtn" onclick="handleSetup()"
                            class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                        <i class="fas fa-check mr-2"></i>
                        設定を完了
                    </button>
                </form>
                
                <div id="setupStatus" class="mt-4 text-center text-sm"></div>
            </div>
        </div>

        <!-- 完了画面 -->
        <div id="completeScreen" class="max-w-md mx-auto bg-white rounded-xl shadow-2xl overflow-hidden" style="display: none;">
            <div class="bg-gradient-to-r from-purple-600 to-pink-600 px-8 py-6">
                <h1 class="text-2xl font-bold text-white text-center">
                    <i class="fas fa-check-circle mr-2"></i>
                    設定完了
                </h1>
                <p class="text-purple-100 text-center mt-2">お疲れ様でした！</p>
            </div>
            
            <div class="px-8 py-6 text-center">
                <div class="mb-6">
                    <i class="fas fa-user-check text-6xl text-green-500 mb-4"></i>
                    <h2 class="text-xl font-semibold text-gray-800 mb-2">セットアップ完了！</h2>
                    <p class="text-gray-600">個人設定が正常に保存されました。</p>
                </div>
                
                <div id="completionInfo" class="mb-6 p-4 bg-gray-50 rounded-lg text-sm text-left"></div>
                
                <button id="dashboardBtn" onclick="goToDashboard()"
                        class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                    <i class="fas fa-tachometer-alt mr-2"></i>
                    ダッシュボードへ進む
                </button>
            </div>
        </div>
    </div>

    <script>
        // Firebase設定
        const firebaseConfig = {
            apiKey: "AIzaSyCRUvvs0OSz_9L9bXtqteVFIIze1OaZObE",
            authDomain: "ce-scheduling-system-v2.firebaseapp.com",
            databaseURL: "https://ce-scheduling-system-v2-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ce-scheduling-system-v2",
            storageBucket: "ce-scheduling-system-v2.firebasestorage.app",
            messagingSenderId: "288279598010",
            appId: "1:288279598010:web:d545ee1d4d854513084383",
            measurementId: "G-LSEEMJE2R0"
        };

        // グローバル変数
        let app, auth, database;
        let currentUser = null;
        let currentUserData = null;
        let authStateListenerActive = false;

        // デバッグ機能
        function debugLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('debugLog');
            const color = type === 'error' ? 'text-red-400' : 
                         type === 'success' ? 'text-green-400' : 
                         type === 'warning' ? 'text-yellow-400' : 'text-blue-400';
            
            logElement.innerHTML += `<div class="${color}">[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[DEBUG] ${message}`);
        }

        function toggleDebug() {
            const panel = document.getElementById('debugPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        // Firebase初期化
        function initializeFirebase() {
            try {
                app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                database = firebase.database();
                debugLog('Firebase初期化完了', 'success');
                
                // 認証状態の監視を設定
                setupAuthStateListener();
                return true;
            } catch (error) {
                debugLog(`Firebase初期化エラー: ${error.message}`, 'error');
                return false;
            }
        }

        // 認証状態監視の設定
        function setupAuthStateListener() {
            if (authStateListenerActive) {
                debugLog('認証状態監視は既に有効', 'warning');
                return;
            }
            
            authStateListenerActive = true;
            debugLog('認証状態監視を開始', 'info');
            
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    debugLog(`認証状態: ログイン中 (${user.email})`, 'success');
                    currentUser = user;
                    
                    // ユーザーデータの取得
                    try {
                        await loadUserData(user.uid);
                    } catch (error) {
                        debugLog(`ユーザーデータ取得エラー: ${error.message}`, 'error');
                    }
                } else {
                    debugLog('認証状態: 未ログイン', 'warning');
                    currentUser = null;
                    currentUserData = null;
                }
            });
        }

        // ユーザーデータの読み込み
        async function loadUserData(uid) {
            try {
                const userRef = database.ref(`ceScheduleV2/users/${uid}`);
                const snapshot = await userRef.once('value');
                
                if (snapshot.exists()) {
                    currentUserData = snapshot.val();
                    debugLog(`ユーザーデータ取得完了: ${JSON.stringify(currentUserData)}`, 'success');
                    
                    // 初期ユーザーかどうかを判定
                    if (currentUserData.isInitialUser && !currentUserData.hasCompletedSetup) {
                        debugLog('初期ユーザー - 個人設定画面へ移行', 'info');
                        showSetupScreen();
                    } else {
                        debugLog('設定済みユーザー - ダッシュボードへ', 'info');
                        // 設定済みユーザーの場合はダッシュボードへ
                        setTimeout(() => {
                            goToDashboard();
                        }, 1000);
                    }
                } else {
                    debugLog('ユーザーデータが見つかりません', 'error');
                    showStatus('loginStatus', 'ユーザーデータが見つかりません', 'error');
                }
            } catch (error) {
                debugLog(`ユーザーデータ読み込みエラー: ${error.message}`, 'error');
                throw error;
            }
        }

        // ログイン処理
        async function handleLogin() {
            const loginInput = document.getElementById('loginInput').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!loginInput || !password) {
                showStatus('loginStatus', 'すべての項目を入力してください', 'error');
                return;
            }
            
            setButtonLoading('loginBtn', true);
            debugLog(`ログイン試行: ${loginInput}`, 'info');
            
            try {
                let email = loginInput;
                
                // ユーザー名の場合はメールアドレスに変換
                if (!loginInput.includes('@')) {
                    debugLog('ユーザー名でのログインを検出', 'info');
                    email = await getUsernameToEmail(loginInput);
                    if (!email) {
                        throw new Error('ユーザー名が見つかりません');
                    }
                    debugLog(`ユーザー名からメールアドレス取得: ${email}`, 'info');
                }

                // システムUIDを取得する関数
async function getSystemUidFromFirebaseUid(firebaseUid) {
    try {
        const userRef = database.ref(`ceScheduleV2/users/${firebaseUid}`);
        const snapshot = await userRef.once('value');
        if (snapshot.exists()) {
            return firebaseUid; // FirebaseのUIDがそのままシステムUIDとして使用される
        }
        
        // 旧システムのユーザー名ベースUIDをサポートする場合
        const mappingRef = database.ref(`ceScheduleV2/uidMapping/${firebaseUid}`);
        const mappingSnapshot = await mappingRef.once('value');
        if (mappingSnapshot.exists()) {
            return mappingSnapshot.val().systemUid;
        }
        
        return firebaseUid; // デフォルトとしてFirebase UIDを使用
    } catch (error) {
        debugLog(`システムUID取得エラー: ${error.message}`, 'error');
        return firebaseUid;
    }
}

// アクティブユーザー状態を更新
async function updateActiveUserStatus(userId, username) {
    try {
        const activeUsersRef = database.ref(`ceScheduleV2/activeUsers/${userId}`);
        await activeUsersRef.set({
            name: username,
            loginTime: firebase.database.ServerValue.TIMESTAMP,
            lastActivity: firebase.database.ServerValue.TIMESTAMP,
            isOnline: true
        });
        
        // 30分後に自動でオフラインにする
        setTimeout(async () => {
            try {
                await activeUsersRef.update({ isOnline: false });
            } catch (error) {
                console.error('オフライン更新エラー:', error);
            }
        }, 30 * 60 * 1000);
        
        debugLog('アクティブユーザー状態を更新', 'success');
    } catch (error) {
        debugLog(`アクティブユーザー更新エラー: ${error.message}`, 'error');
    }
}
                
        // Firebase認証
await auth.signInWithEmailAndPassword(email, password);
debugLog(`認証成功: ${email}`, 'success');

// UIDマッピングとセッション情報の管理
const firebaseUid = auth.currentUser.uid;
const systemUid = await getSystemUidFromFirebaseUid(firebaseUid);
if (systemUid) {
    // セッション情報を更新
    window.USER_SESSION = window.USER_SESSION || {};
    window.USER_SESSION.isAuthenticated = true;
    window.USER_SESSION.userId = systemUid; // システム内のUID
    window.USER_SESSION.firebaseUid = firebaseUid; // Firebase認証のUID
    window.USER_SESSION.lastActivity = Date.now();

    // アクティブユーザーとしてデータベースに登録
    await updateActiveUserStatus(systemUid, loginInput);
}
                showStatus('loginStatus', 'ログイン成功！', 'success');
                
            } catch (error) {
                debugLog(`ログインエラー: ${error.message}`, 'error');
                let errorMessage = 'ログインに失敗しました';
                
                if (error.code === 'auth/invalid-login-credentials' || error.code === 'auth/wrong-password') {
                    errorMessage = 'メールアドレスまたはパスワードが正しくありません';
                } else if (error.code === 'auth/user-not-found') {
                    errorMessage = 'ユーザーが見つかりません';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = '無効なメールアドレスです';
                }
                
                showStatus('loginStatus', errorMessage, 'error');
            } finally {
                setButtonLoading('loginBtn', false);
            }
        }

        // ユーザー名からメールアドレスを取得
        async function getUsernameToEmail(username) {
            try {
                const usernameRef = database.ref(`ceScheduleV2/usernames/${username}`);
                const snapshot = await usernameRef.once('value');
                
                if (snapshot.exists()) {
                    const uid = snapshot.val();
                    const userRef = database.ref(`ceScheduleV2/users/${uid}`);
                    const userSnapshot = await userRef.once('value');
                    
                    if (userSnapshot.exists()) {
                        return userSnapshot.val().email;
                    }
                }
                return null;
            } catch (error) {
                debugLog(`ユーザー名変換エラー: ${error.message}`, 'error');
                return null;
            }
        }

        // 個人設定画面表示
        function showSetupScreen() {
            debugLog('個人設定画面を表示', 'info');
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('setupScreen').style.display = 'block';
            document.getElementById('completeScreen').style.display = 'none';
            
            // 現在のユーザー情報を表示
            if (currentUserData) {
                document.getElementById('userInfoDisplay').innerHTML = `
                    <div><strong>ユーザー名:</strong> ${currentUserData.username}</div>
                    <div><strong>メール:</strong> ${currentUserData.email}</div>
                    <div><strong>権限:</strong> ${getRoleDisplayName(currentUserData.role)}</div>
                `;
                
                // フォームにデフォルト値を設定
                document.getElementById('newUsername').value = currentUserData.username || '';
            }
        }

        // 個人設定処理
        async function handleSetup() {
            const newUsername = document.getElementById('newUsername').value.trim();
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!newPassword || !confirmPassword) {
                showStatus('setupStatus', 'すべての項目を入力してください', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showStatus('setupStatus', 'パスワードが一致しません', 'error');
                return;
            }
            
            if (newPassword.length < 8) {
                showStatus('setupStatus', 'パスワードは8文字以上で入力してください', 'error');
                return;
            }
            
            setButtonLoading('setupBtn', true);
            debugLog('個人設定更新開始', 'info');
            
            try {
                // パスワード更新
                await currentUser.updatePassword(newPassword);
                debugLog('パスワード更新完了', 'success');
                
                // ユーザーデータ更新
                const updatedUserData = {
                    ...currentUserData,
                    username: newUsername || currentUserData.username,
                    hasCompletedSetup: true,
                    isInitialUser: false,
                    lastSetupDate: new Date().toISOString()
                };
                
                await database.ref(`ceScheduleV2/users/${currentUser.uid}`).update(updatedUserData);
                debugLog('ユーザーデータ更新完了', 'success');
                
                // ユーザー名マッピング更新（必要な場合）
                if (newUsername && newUsername !== currentUserData.username) {
                    await database.ref(`ceScheduleV2/usernames/${newUsername}`).set(currentUser.uid);
                    // 古いユーザー名マッピングを削除
                    if (currentUserData.username) {
                        await database.ref(`ceScheduleV2/usernames/${currentUserData.username}`).remove();
                    }
                    debugLog('ユーザー名マッピング更新完了', 'success');
                }
                
                // 初期ユーザーデータを削除
                await database.ref(`ceScheduleV2/initialUsers/${currentUser.uid}`).remove();
                debugLog('初期ユーザーデータ削除完了', 'success');
                
                currentUserData = updatedUserData;
                showStatus('setupStatus', '設定が完了しました！', 'success');
                
                // 完了画面へ移行
                setTimeout(() => {
                    showCompleteScreen();
                }, 1000);
                
            } catch (error) {
                debugLog(`設定更新エラー: ${error.message}`, 'error');
                showStatus('setupStatus', '設定の更新に失敗しました', 'error');
            } finally {
                setButtonLoading('setupBtn', false);
            }
        }

        // 完了画面表示
        function showCompleteScreen() {
            debugLog('完了画面を表示', 'info');
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('setupScreen').style.display = 'none';
            document.getElementById('completeScreen').style.display = 'block';
            
            // 完了情報を表示
            if (currentUserData) {
                document.getElementById('completionInfo').innerHTML = `
                    <div class="space-y-2">
                        <div><strong>ユーザー名:</strong> ${currentUserData.username}</div>
                        <div><strong>メール:</strong> ${currentUserData.email}</div>
                        <div><strong>権限:</strong> ${getRoleDisplayName(currentUserData.role)}</div>
                        <div><strong>完了日時:</strong> ${new Date().toLocaleString('ja-JP')}</div>
                    </div>
                `;
            }
        }

        // ダッシュボードへ移動
        function goToDashboard() {
            debugLog('ダッシュボードへ移動', 'info');
            
            if (currentUserData && currentUserData.role === 'admin') {
                debugLog('管理者ダッシュボードへリダイレクト', 'info');
                window.location.href = 'admin-debug.html';
            } else {
                debugLog('一般ユーザーダッシュボードへリダイレクト', 'info');
                // 一般ユーザー用ダッシュボードがある場合
                // window.location.href = 'user-dashboard.html';
                
                // 現在は管理者ダッシュボードへ（開発中のため）
                window.location.href = 'admin-debug.html';
            }
        }

        // ユーティリティ関数
        function getRoleDisplayName(role) {
            switch (role) {
                case 'admin': return '管理者';
                case 'editor': return '編集者';
                case 'viewer': return '閲覧者';
                default: return '不明';
            }
        }

        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `mt-4 text-center text-sm ${
                type === 'error' ? 'text-red-600' : 
                type === 'success' ? 'text-green-600' : 
                'text-gray-600'
            }`;
        }

        function setButtonLoading(buttonId, loading) {
            const button = document.getElementById(buttonId);
            if (loading) {
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>処理中...';
            } else {
                button.disabled = false;
                const originalText = buttonId === 'loginBtn' ? 
                    '<i class="fas fa-sign-in-alt mr-2"></i>ログイン' :
                    '<i class="fas fa-check mr-2"></i>設定を完了';
                button.innerHTML = originalText;
            }
        }

        // ページ読み込み時の初期化
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('ページ読み込み完了', 'success');

             // アクティブユーザー表示機能を初期化
    initializeActiveUserDisplay();
            
            if (initializeFirebase()) {
                debugLog('システム初期化完了', 'success');
            } else {
                debugLog('システム初期化失敗', 'error');
            }
            
            // Enter キーでのフォーム送信
            document.getElementById('loginForm').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleLogin();
                }
            });
            
            document.getElementById('setupForm').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleSetup();
                }
            });
        });

        // アクティブユーザー表示機能の初期化
function initializeActiveUserDisplay() {
    // 認証状態が確定してからアクティブユーザー監視を開始
    const checkAuthAndStartMonitoring = () => {
        if (auth && auth.currentUser) {
            displayActiveUsers();
        } else {
            // 認証完了を待機
            setTimeout(checkAuthAndStartMonitoring, 1000);
        }
    };
    
    // 3秒後に監視開始（認証処理完了を待つ）
    setTimeout(checkAuthAndStartMonitoring, 3000);
}

// アクティブユーザー表示機能
function displayActiveUsers() {
    // 認証状態を確認してからアクセス
    if (!auth || !auth.currentUser) {
        debugLog('認証が必要です - アクティブユーザー表示をスキップ', 'warning');
        return;
    }
    
    const activeUsersRef = database.ref('ceScheduleV2/activeUsers');
    
    activeUsersRef.on('value', (snapshot) => {
        const activeUsers = snapshot.val() || {};
        const activeUsersList = document.getElementById('activeUsersList');
        
        // アクティブユーザー表示エリアがある場合のみ処理
        if (activeUsersList) {
            activeUsersList.innerHTML = '';
            
            let onlineCount = 0;
            Object.entries(activeUsers).forEach(([userId, userData]) => {
                if (userData.isOnline) {
                    onlineCount++;
                    const userElement = document.createElement('div');
                    userElement.className = 'active-user-item flex items-center space-x-2 mb-2';
                    userElement.innerHTML = `
                        <i class="fas fa-user-circle text-green-500"></i>
                        <span class="font-medium">${userData.name}</span>
                        <small class="text-gray-500">${userData.role || 'ユーザー'}</small>
                    `;
                    activeUsersList.appendChild(userElement);
                }
            });
            
            debugLog(`アクティブユーザー更新: ${onlineCount}人オンライン`, 'info');
        } else {
            // アクティブユーザー表示エリアがない場合は、コンソールにログ出力
            const onlineUsers = Object.values(activeUsers).filter(u => u.isOnline);
            debugLog(`現在のアクティブユーザー: ${onlineUsers.length}人`, 'info');
        }
    }, (error) => {
        debugLog(`アクティブユーザー取得エラー: ${error.message}`, 'error');
    });
}

// ページ離脱時にオフライン状態に更新
window.addEventListener('beforeunload', () => {
    if (auth && auth.currentUser && window.USER_SESSION && window.USER_SESSION.userId) {
        try {
            database.ref(`ceScheduleV2/activeUsers/${window.USER_SESSION.userId}`).update({
                isOnline: false,
                lastActivity: firebase.database.ServerValue.TIMESTAMP
            });
        } catch (error) {
            console.error('オフライン状態更新エラー:', error);
        }
    }
});
        
    </script>
</body>
</html>
