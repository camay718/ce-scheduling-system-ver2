<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  V2 - çµ±åˆãƒ­ã‚°ã‚¤ãƒ³</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ãƒ‘ãƒãƒ« -->
    <div id="debugPanel" class="fixed top-4 right-4 bg-black bg-opacity-80 text-green-400 p-4 rounded-lg text-xs max-w-md max-h-96 overflow-y-auto font-mono" style="display: none;">
        <div class="flex justify-between items-center mb-2">
            <span class="text-yellow-400 font-bold">ğŸ”§ ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°</span>
            <button onclick="toggleDebug()" class="text-red-400 hover:text-red-300">âœ•</button>
        </div>
        <div id="debugLog"></div>
    </div>

    <!-- ãƒ‡ãƒãƒƒã‚°ãƒœã‚¿ãƒ³ -->
    <button onclick="toggleDebug()" class="fixed top-4 left-4 bg-gray-800 text-white px-3 py-2 rounded-lg text-sm hover:bg-gray-700">
        <i class="fas fa-bug"></i> Debug
    </button>

    <div class="container mx-auto px-4 py-8">
        <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
        <div id="loginScreen" class="max-w-md mx-auto bg-white rounded-xl shadow-2xl overflow-hidden">
            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 px-8 py-6">
                <h1 class="text-2xl font-bold text-white text-center">
                    <i class="fas fa-calendar-alt mr-2"></i>
                    CEã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  V2
                </h1>
                <p class="text-blue-100 text-center mt-2">çµ±åˆãƒ­ã‚°ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ </p>
            </div>
            
            <div class="px-8 py-6">
                <form id="loginForm" onsubmit="return false;">
                    <div class="mb-4">
                        <label for="loginInput" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-user mr-1"></i>
                            ãƒ¦ãƒ¼ã‚¶ãƒ¼å ã¾ãŸã¯ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
                        </label>
                        <input type="text" id="loginInput" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                               placeholder="ä¾‹: ç”°ä¸­å¤ªéƒ ã¾ãŸã¯ tanaka@example.com" 
                               autocomplete="username"
                               required>
                    </div>
                    
                    <div class="mb-6">
                        <label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-lock mr-1"></i>
                            ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
                        </label>
                        <input type="password" id="loginPassword" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                               placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" 
                               autocomplete="current-password"
                               required>
                    </div>
                    
                    <button type="submit" id="loginBtn" onclick="handleLogin()"
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                        <i class="fas fa-sign-in-alt mr-2"></i>
                        ãƒ­ã‚°ã‚¤ãƒ³
                    </button>
                </form>
                
                <div id="loginStatus" class="mt-4 text-center text-sm"></div>
            </div>
        </div>

        <!-- å€‹äººè¨­å®šç”»é¢ -->
        <div id="setupScreen" class="max-w-md mx-auto bg-white rounded-xl shadow-2xl overflow-hidden" style="display: none;">
            <div class="bg-gradient-to-r from-green-600 to-teal-600 px-8 py-6">
                <h1 class="text-2xl font-bold text-white text-center">
                    <i class="fas fa-user-cog mr-2"></i>
                    å€‹äººè¨­å®š
                </h1>
                <p class="text-green-100 text-center mt-2">åˆæœŸè¨­å®šã‚’å®Œäº†ã—ã¦ãã ã•ã„</p>
            </div>
            
            <div class="px-8 py-6">
                <div id="currentUserInfo" class="mb-6 p-4 bg-blue-50 rounded-lg">
                    <h3 class="font-medium text-gray-700 mb-2">ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±</h3>
                    <div id="userInfoDisplay" class="text-sm text-gray-600"></div>
                </div>
                
                <form id="setupForm" onsubmit="return false;">
                    <div class="mb-4">
                        <label for="newUsername" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-user-edit mr-1"></i>
                            æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼å
                        </label>
                        <input type="text" id="newUsername" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" 
                               placeholder="ä¾‹: ç”°ä¸­å¤ªéƒ"
                               autocomplete="username">
                    </div>
                    
                    <div class="mb-4">
                        <label for="newPassword" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-key mr-1"></i>
                            æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
                        </label>
                        <input type="password" id="newPassword" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" 
                               placeholder="8æ–‡å­—ä»¥ä¸Šã®å®‰å…¨ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"
                               autocomplete="new-password"
                               required>
                    </div>
                    
                    <div class="mb-6">
                        <label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-check-double mr-1"></i>
                            ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª
                        </label>
                        <input type="password" id="confirmPassword" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" 
                               placeholder="ä¸Šè¨˜ã¨åŒã˜ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"
                               autocomplete="new-password"
                               required>
                    </div>
                    
                    <button type="submit" id="setupBtn" onclick="handleSetup()"
                            class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                        <i class="fas fa-check mr-2"></i>
                        è¨­å®šã‚’å®Œäº†
                    </button>
                </form>
                
                <div id="setupStatus" class="mt-4 text-center text-sm"></div>
            </div>
        </div>

        <!-- å®Œäº†ç”»é¢ -->
        <div id="completeScreen" class="max-w-md mx-auto bg-white rounded-xl shadow-2xl overflow-hidden" style="display: none;">
            <div class="bg-gradient-to-r from-purple-600 to-pink-600 px-8 py-6">
                <h1 class="text-2xl font-bold text-white text-center">
                    <i class="fas fa-check-circle mr-2"></i>
                    è¨­å®šå®Œäº†
                </h1>
                <p class="text-purple-100 text-center mt-2">ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼</p>
            </div>
            
            <div class="px-8 py-6 text-center">
                <div class="mb-6">
                    <i class="fas fa-user-check text-6xl text-green-500 mb-4"></i>
                    <h2 class="text-xl font-semibold text-gray-800 mb-2">ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ï¼</h2>
                    <p class="text-gray-600">å€‹äººè¨­å®šãŒæ­£å¸¸ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚</p>
                </div>
                
                <div id="completionInfo" class="mb-6 p-4 bg-gray-50 rounded-lg text-sm text-left"></div>
                
                <button id="dashboardBtn" onclick="goToDashboard()"
                        class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                    <i class="fas fa-tachometer-alt mr-2"></i>
                    ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸é€²ã‚€
                </button>
            </div>
        </div>
    </div>

    <script>
        // Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyCRUvvs0OSz_9L9bXtqteVFIIze1OaZObE",
            authDomain: "ce-scheduling-system-v2.firebaseapp.com",
            databaseURL: "https://ce-scheduling-system-v2-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ce-scheduling-system-v2",
            storageBucket: "ce-scheduling-system-v2.firebasestorage.app",
            messagingSenderId: "288279598010",
            appId: "1:288279598010:web:d545ee1d4d854513084383",
            measurementId: "G-LSEEMJE2R0"
        };

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let app, auth, database;
        let currentUser = null;
        let currentUserData = null;
        let authStateListenerActive = false;

        // ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½
        function debugLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('debugLog');
            const color = type === 'error' ? 'text-red-400' : 
                         type === 'success' ? 'text-green-400' : 
                         type === 'warning' ? 'text-yellow-400' : 'text-blue-400';
            
            logElement.innerHTML += `<div class="${color}">[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[DEBUG] ${message}`);
        }

        function toggleDebug() {
            const panel = document.getElementById('debugPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        // FirebaseåˆæœŸåŒ–
        function initializeFirebase() {
            try {
                app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                database = firebase.database();
                debugLog('FirebaseåˆæœŸåŒ–å®Œäº†', 'success');
                
                // èªè¨¼çŠ¶æ…‹ã®ç›£è¦–ã‚’è¨­å®š
                setupAuthStateListener();
                return true;
            } catch (error) {
                debugLog(`FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                return false;
            }
        }

        // èªè¨¼çŠ¶æ…‹ç›£è¦–ã®è¨­å®š
        function setupAuthStateListener() {
            if (authStateListenerActive) {
                debugLog('èªè¨¼çŠ¶æ…‹ç›£è¦–ã¯æ—¢ã«æœ‰åŠ¹', 'warning');
                return;
            }
            
            authStateListenerActive = true;
            debugLog('èªè¨¼çŠ¶æ…‹ç›£è¦–ã‚’é–‹å§‹', 'info');
            
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    debugLog(`èªè¨¼çŠ¶æ…‹: ãƒ­ã‚°ã‚¤ãƒ³ä¸­ (${user.email})`, 'success');
                    currentUser = user;
                    
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
                    try {
                        await loadUserData(user.uid);
                    } catch (error) {
                        debugLog(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                    }
                } else {
                    debugLog('èªè¨¼çŠ¶æ…‹: æœªãƒ­ã‚°ã‚¤ãƒ³', 'warning');
                    currentUser = null;
                    currentUserData = null;
                }
            });
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
        async function loadUserData(uid) {
            try {
                const userRef = database.ref(`ceScheduleV2/users/${uid}`);
                const snapshot = await userRef.once('value');
                
                if (snapshot.exists()) {
                    currentUserData = snapshot.val();
                    debugLog(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†: ${JSON.stringify(currentUserData)}`, 'success');
                    
                    // åˆæœŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã©ã†ã‹ã‚’åˆ¤å®š
                    if (currentUserData.isInitialUser && !currentUserData.hasCompletedSetup) {
                        debugLog('åˆæœŸãƒ¦ãƒ¼ã‚¶ãƒ¼ - å€‹äººè¨­å®šç”»é¢ã¸ç§»è¡Œ', 'info');
                        showSetupScreen();
                    } else {
                        debugLog('è¨­å®šæ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ - ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸', 'info');
                        // è¨­å®šæ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã¯ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸
                        setTimeout(() => {
                            goToDashboard();
                        }, 1000);
                    }
                } else {
                    debugLog('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                    showStatus('loginStatus', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                }
            } catch (error) {
                debugLog(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                throw error;
            }
        }

        // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
        async function handleLogin() {
            const loginInput = document.getElementById('loginInput').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!loginInput || !password) {
                showStatus('loginStatus', 'ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            setButtonLoading('loginBtn', true);
            debugLog(`ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œ: ${loginInput}`, 'info');
            
            try {
                let email = loginInput;
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®å ´åˆã¯ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«å¤‰æ›
                if (!loginInput.includes('@')) {
                    debugLog('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã§ã®ãƒ­ã‚°ã‚¤ãƒ³ã‚’æ¤œå‡º', 'info');
                    email = await getUsernameToEmail(loginInput);
                    if (!email) {
                        throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    }
                    debugLog(`ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‹ã‚‰ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å–å¾—: ${email}`, 'info');
                }

                // ã‚·ã‚¹ãƒ†ãƒ UIDã‚’å–å¾—ã™ã‚‹é–¢æ•°
async function getSystemUidFromFirebaseUid(firebaseUid) {
    try {
        const userRef = database.ref(`ceScheduleV2/users/${firebaseUid}`);
        const snapshot = await userRef.once('value');
        if (snapshot.exists()) {
            return firebaseUid; // Firebaseã®UIDãŒãã®ã¾ã¾ã‚·ã‚¹ãƒ†ãƒ UIDã¨ã—ã¦ä½¿ç”¨ã•ã‚Œã‚‹
        }
        
        // æ—§ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åãƒ™ãƒ¼ã‚¹UIDã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹å ´åˆ
        const mappingRef = database.ref(`ceScheduleV2/uidMapping/${firebaseUid}`);
        const mappingSnapshot = await mappingRef.once('value');
        if (mappingSnapshot.exists()) {
            return mappingSnapshot.val().systemUid;
        }
        
        return firebaseUid; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¨ã—ã¦Firebase UIDã‚’ä½¿ç”¨
    } catch (error) {
        debugLog(`ã‚·ã‚¹ãƒ†ãƒ UIDå–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        return firebaseUid;
    }
}

// ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹ã‚’æ›´æ–°
async function updateActiveUserStatus(userId, username) {
    try {
        const activeUsersRef = database.ref(`ceScheduleV2/activeUsers/${userId}`);
        await activeUsersRef.set({
            name: username,
            loginTime: firebase.database.ServerValue.TIMESTAMP,
            lastActivity: firebase.database.ServerValue.TIMESTAMP,
            isOnline: true
        });
        
        // 30åˆ†å¾Œã«è‡ªå‹•ã§ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã«ã™ã‚‹
        setTimeout(async () => {
            try {
                await activeUsersRef.update({ isOnline: false });
            } catch (error) {
                console.error('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
            }
        }, 30 * 60 * 1000);
        
        debugLog('ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹ã‚’æ›´æ–°', 'success');
    } catch (error) {
        debugLog(`ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–°ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
    }
}
                
        // Firebaseèªè¨¼
await auth.signInWithEmailAndPassword(email, password);
debugLog(`èªè¨¼æˆåŠŸ: ${email}`, 'success');

// UIDãƒãƒƒãƒ”ãƒ³ã‚°ã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã®ç®¡ç†
const firebaseUid = auth.currentUser.uid;
const systemUid = await getSystemUidFromFirebaseUid(firebaseUid);
if (systemUid) {
    // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’æ›´æ–°
    window.USER_SESSION = window.USER_SESSION || {};
    window.USER_SESSION.isAuthenticated = true;
    window.USER_SESSION.userId = systemUid; // ã‚·ã‚¹ãƒ†ãƒ å†…ã®UID
    window.USER_SESSION.firebaseUid = firebaseUid; // Firebaseèªè¨¼ã®UID
    window.USER_SESSION.lastActivity = Date.now();

    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ç™»éŒ²
    await updateActiveUserStatus(systemUid, loginInput);
}
                showStatus('loginStatus', 'ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼', 'success');
                
            } catch (error) {
                debugLog(`ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                let errorMessage = 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ';
                
                if (error.code === 'auth/invalid-login-credentials' || error.code === 'auth/wrong-password') {
                    errorMessage = 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“';
                } else if (error.code === 'auth/user-not-found') {
                    errorMessage = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'ç„¡åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã™';
                }
                
                showStatus('loginStatus', errorMessage, 'error');
            } finally {
                setButtonLoading('loginBtn', false);
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‹ã‚‰ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—
        async function getUsernameToEmail(username) {
            try {
                const usernameRef = database.ref(`ceScheduleV2/usernames/${username}`);
                const snapshot = await usernameRef.once('value');
                
                if (snapshot.exists()) {
                    const uid = snapshot.val();
                    const userRef = database.ref(`ceScheduleV2/users/${uid}`);
                    const userSnapshot = await userRef.once('value');
                    
                    if (userSnapshot.exists()) {
                        return userSnapshot.val().email;
                    }
                }
                return null;
            } catch (error) {
                debugLog(`ãƒ¦ãƒ¼ã‚¶ãƒ¼åå¤‰æ›ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                return null;
            }
        }

        // å€‹äººè¨­å®šç”»é¢è¡¨ç¤º
        function showSetupScreen() {
            debugLog('å€‹äººè¨­å®šç”»é¢ã‚’è¡¨ç¤º', 'info');
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('setupScreen').style.display = 'block';
            document.getElementById('completeScreen').style.display = 'none';
            
            // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
            if (currentUserData) {
                document.getElementById('userInfoDisplay').innerHTML = `
                    <div><strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼å:</strong> ${currentUserData.username}</div>
                    <div><strong>ãƒ¡ãƒ¼ãƒ«:</strong> ${currentUserData.email}</div>
                    <div><strong>æ¨©é™:</strong> ${getRoleDisplayName(currentUserData.role)}</div>
                `;
                
                // ãƒ•ã‚©ãƒ¼ãƒ ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
                document.getElementById('newUsername').value = currentUserData.username || '';
            }
        }

        // å€‹äººè¨­å®šå‡¦ç†
        async function handleSetup() {
            const newUsername = document.getElementById('newUsername').value.trim();
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!newPassword || !confirmPassword) {
                showStatus('setupStatus', 'ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showStatus('setupStatus', 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“', 'error');
                return;
            }
            
            if (newPassword.length < 8) {
                showStatus('setupStatus', 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯8æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            setButtonLoading('setupBtn', true);
            debugLog('å€‹äººè¨­å®šæ›´æ–°é–‹å§‹', 'info');
            
            try {
                // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ›´æ–°
                await currentUser.updatePassword(newPassword);
                debugLog('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ›´æ–°å®Œäº†', 'success');
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿æ›´æ–°
                const updatedUserData = {
                    ...currentUserData,
                    username: newUsername || currentUserData.username,
                    hasCompletedSetup: true,
                    isInitialUser: false,
                    lastSetupDate: new Date().toISOString()
                };
                
                await database.ref(`ceScheduleV2/users/${currentUser.uid}`).update(updatedUserData);
                debugLog('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿æ›´æ–°å®Œäº†', 'success');
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼åãƒãƒƒãƒ”ãƒ³ã‚°æ›´æ–°ï¼ˆå¿…è¦ãªå ´åˆï¼‰
                if (newUsername && newUsername !== currentUserData.username) {
                    await database.ref(`ceScheduleV2/usernames/${newUsername}`).set(currentUser.uid);
                    // å¤ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼åãƒãƒƒãƒ”ãƒ³ã‚°ã‚’å‰Šé™¤
                    if (currentUserData.username) {
                        await database.ref(`ceScheduleV2/usernames/${currentUserData.username}`).remove();
                    }
                    debugLog('ãƒ¦ãƒ¼ã‚¶ãƒ¼åãƒãƒƒãƒ”ãƒ³ã‚°æ›´æ–°å®Œäº†', 'success');
                }
                
                // åˆæœŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
                await database.ref(`ceScheduleV2/initialUsers/${currentUser.uid}`).remove();
                debugLog('åˆæœŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿å‰Šé™¤å®Œäº†', 'success');
                
                currentUserData = updatedUserData;
                showStatus('setupStatus', 'è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸï¼', 'success');
                
                // å®Œäº†ç”»é¢ã¸ç§»è¡Œ
                setTimeout(() => {
                    showCompleteScreen();
                }, 1000);
                
            } catch (error) {
                debugLog(`è¨­å®šæ›´æ–°ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                showStatus('setupStatus', 'è¨­å®šã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            } finally {
                setButtonLoading('setupBtn', false);
            }
        }

        // å®Œäº†ç”»é¢è¡¨ç¤º
        function showCompleteScreen() {
            debugLog('å®Œäº†ç”»é¢ã‚’è¡¨ç¤º', 'info');
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('setupScreen').style.display = 'none';
            document.getElementById('completeScreen').style.display = 'block';
            
            // å®Œäº†æƒ…å ±ã‚’è¡¨ç¤º
            if (currentUserData) {
                document.getElementById('completionInfo').innerHTML = `
                    <div class="space-y-2">
                        <div><strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼å:</strong> ${currentUserData.username}</div>
                        <div><strong>ãƒ¡ãƒ¼ãƒ«:</strong> ${currentUserData.email}</div>
                        <div><strong>æ¨©é™:</strong> ${getRoleDisplayName(currentUserData.role)}</div>
                        <div><strong>å®Œäº†æ—¥æ™‚:</strong> ${new Date().toLocaleString('ja-JP')}</div>
                    </div>
                `;
            }
        }

        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸ç§»å‹•
        function goToDashboard() {
            debugLog('ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸ç§»å‹•', 'info');
            
            if (currentUserData && currentUserData.role === 'admin') {
                debugLog('ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ', 'info');
                window.location.href = 'admin-debug.html';
            } else {
                debugLog('ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ', 'info');
                // ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãŒã‚ã‚‹å ´åˆ
                // window.location.href = 'user-dashboard.html';
                
                // ç¾åœ¨ã¯ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸ï¼ˆé–‹ç™ºä¸­ã®ãŸã‚ï¼‰
                window.location.href = 'admin-debug.html';
            }
        }

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function getRoleDisplayName(role) {
            switch (role) {
                case 'admin': return 'ç®¡ç†è€…';
                case 'editor': return 'ç·¨é›†è€…';
                case 'viewer': return 'é–²è¦§è€…';
                default: return 'ä¸æ˜';
            }
        }

        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `mt-4 text-center text-sm ${
                type === 'error' ? 'text-red-600' : 
                type === 'success' ? 'text-green-600' : 
                'text-gray-600'
            }`;
        }

        function setButtonLoading(buttonId, loading) {
            const button = document.getElementById(buttonId);
            if (loading) {
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>å‡¦ç†ä¸­...';
            } else {
                button.disabled = false;
                const originalText = buttonId === 'loginBtn' ? 
                    '<i class="fas fa-sign-in-alt mr-2"></i>ãƒ­ã‚°ã‚¤ãƒ³' :
                    '<i class="fas fa-check mr-2"></i>è¨­å®šã‚’å®Œäº†';
                button.innerHTML = originalText;
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†', 'success');

             // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡¨ç¤ºæ©Ÿèƒ½ã‚’åˆæœŸåŒ–
    initializeActiveUserDisplay();
            
            if (initializeFirebase()) {
                debugLog('ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†', 'success');
            } else {
                debugLog('ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å¤±æ•—', 'error');
            }
            
            // Enter ã‚­ãƒ¼ã§ã®ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
            document.getElementById('loginForm').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleLogin();
                }
            });
            
            document.getElementById('setupForm').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleSetup();
                }
            });
        });

        // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡¨ç¤ºæ©Ÿèƒ½ã®åˆæœŸåŒ–
function initializeActiveUserDisplay() {
    // èªè¨¼çŠ¶æ…‹ãŒç¢ºå®šã—ã¦ã‹ã‚‰ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼ç›£è¦–ã‚’é–‹å§‹
    const checkAuthAndStartMonitoring = () => {
        if (auth && auth.currentUser) {
            displayActiveUsers();
        } else {
            // èªè¨¼å®Œäº†ã‚’å¾…æ©Ÿ
            setTimeout(checkAuthAndStartMonitoring, 1000);
        }
    };
    
    // 3ç§’å¾Œã«ç›£è¦–é–‹å§‹ï¼ˆèªè¨¼å‡¦ç†å®Œäº†ã‚’å¾…ã¤ï¼‰
    setTimeout(checkAuthAndStartMonitoring, 3000);
}

// ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡¨ç¤ºæ©Ÿèƒ½
function displayActiveUsers() {
    // èªè¨¼çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹
    if (!auth || !auth.currentUser) {
        debugLog('èªè¨¼ãŒå¿…è¦ã§ã™ - ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡¨ç¤ºã‚’ã‚¹ã‚­ãƒƒãƒ—', 'warning');
        return;
    }
    
    const activeUsersRef = database.ref('ceScheduleV2/activeUsers');
    
    activeUsersRef.on('value', (snapshot) => {
        const activeUsers = snapshot.val() || {};
        const activeUsersList = document.getElementById('activeUsersList');
        
        // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢ãŒã‚ã‚‹å ´åˆã®ã¿å‡¦ç†
        if (activeUsersList) {
            activeUsersList.innerHTML = '';
            
            let onlineCount = 0;
            Object.entries(activeUsers).forEach(([userId, userData]) => {
                if (userData.isOnline) {
                    onlineCount++;
                    const userElement = document.createElement('div');
                    userElement.className = 'active-user-item flex items-center space-x-2 mb-2';
                    userElement.innerHTML = `
                        <i class="fas fa-user-circle text-green-500"></i>
                        <span class="font-medium">${userData.name}</span>
                        <small class="text-gray-500">${userData.role || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼'}</small>
                    `;
                    activeUsersList.appendChild(userElement);
                }
            });
            
            debugLog(`ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–°: ${onlineCount}äººã‚ªãƒ³ãƒ©ã‚¤ãƒ³`, 'info');
        } else {
            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢ãŒãªã„å ´åˆã¯ã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ãƒ­ã‚°å‡ºåŠ›
            const onlineUsers = Object.values(activeUsers).filter(u => u.isOnline);
            debugLog(`ç¾åœ¨ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${onlineUsers.length}äºº`, 'info');
        }
    }, (error) => {
        debugLog(`ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
    });
}

// ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã«ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã«æ›´æ–°
window.addEventListener('beforeunload', () => {
    if (auth && auth.currentUser && window.USER_SESSION && window.USER_SESSION.userId) {
        try {
            database.ref(`ceScheduleV2/activeUsers/${window.USER_SESSION.userId}`).update({
                isOnline: false,
                lastActivity: firebase.database.ServerValue.TIMESTAMP
            });
        } catch (error) {
            console.error('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
        }
    }
});
        
    </script>
</body>
</html>
