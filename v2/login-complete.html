<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEスケジュール管理システム V2 - 統合ログイン</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 via-white to-indigo-50">
    <div class="container mx-auto px-4 py-8 max-w-md">
        <!-- ヘッダー -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">CEスケジュール管理</h1>
            <p class="text-gray-600">システム V2 - 統合ログイン</p>
        </div>

        <!-- プログレスバー -->
        <div id="progressBar" class="mb-8">
            <div class="flex items-center justify-between mb-2">
                <span id="step1" class="flex items-center text-blue-600">
                    <i class="fas fa-sign-in-alt w-5 h-5 mr-2"></i>
                    <span class="text-sm font-medium">ログイン</span>
                </span>
                <span id="step2" class="flex items-center text-gray-400">
                    <i class="fas fa-user-cog w-5 h-5 mr-2"></i>
                    <span class="text-sm font-medium">個人設定</span>
                </span>
                <span id="step3" class="flex items-center text-gray-400">
                    <i class="fas fa-check-circle w-5 h-5 mr-2"></i>
                    <span class="text-sm font-medium">完了</span>
                </span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div id="progressFill" class="bg-blue-600 h-2 rounded-full transition-all duration-500" style="width: 33%"></div>
            </div>
        </div>

        <!-- ログインセクション -->
        <div id="loginSection" class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-6 text-center">
                <i class="fas fa-sign-in-alt mr-2 text-blue-600"></i>
                ログイン
            </h2>
            
            <form id="loginForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        ユーザー名またはメールアドレス
                    </label>
                    <input type="text" id="loginInput" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="例: 田中太郎 または tanaka@example.com" required>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        パスワード
                    </label>
                    <input type="password" id="loginPassword" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="••••••••" required>
                </div>
                
                <button type="submit" id="loginBtn" 
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                    <i class="fas fa-sign-in-alt mr-2"></i>
                    ログイン
                </button>
            </form>

            <div class="mt-4 text-center">
                <a href="admin-debug.html" class="text-sm text-blue-600 hover:text-blue-800">
                    <i class="fas fa-user-shield mr-1"></i>
                    管理者ダッシュボード
                </a>
            </div>
        </div>

        <!-- 個人設定セクション -->
        <div id="userSetupSection" class="bg-white rounded-lg shadow-lg p-6 hidden">
            <h2 class="text-xl font-semibold text-gray-800 mb-6 text-center">
                <i class="fas fa-user-cog mr-2 text-green-600"></i>
                個人設定
            </h2>
            
            <div id="userInfo" class="mb-6 p-4 bg-blue-50 rounded-lg"></div>
            
            <form id="setupForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        ユーザー名
                    </label>
                    <input type="text" id="newUsername" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                           placeholder="新しいユーザー名" required>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        新しいパスワード
                    </label>
                    <input type="password" id="newPassword" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                           placeholder="新しいパスワード（8文字以上）" required>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        パスワード確認
                    </label>
                    <input type="password" id="confirmPassword" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                           placeholder="パスワードを再入力" required>
                </div>
                
                <button type="submit" id="setupBtn" 
                        class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                    <i class="fas fa-save mr-2"></i>
                    設定を完了
                </button>
            </form>
        </div>

        <!-- 完了セクション -->
        <div id="completionSection" class="bg-white rounded-lg shadow-lg p-6 hidden">
            <div class="text-center">
                <div class="mb-4">
                    <i class="fas fa-check-circle text-green-500 text-6xl"></i>
                </div>
                <h2 class="text-xl font-semibold text-gray-800 mb-4">設定完了！</h2>
                <p class="text-gray-600 mb-6">個人設定が正常に完了しました。</p>
                
                <div class="space-y-3">
                    <button onclick="goToDashboard()" 
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                        <i class="fas fa-tachometer-alt mr-2"></i>
                        ダッシュボードへ
                    </button>
                    
                    <button onclick="logout()" 
                            class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                        <i class="fas fa-sign-out-alt mr-2"></i>
                        ログアウト
                    </button>
                </div>
            </div>
        </div>

        <!-- ステータス表示 -->
        <div id="statusMessage" class="mt-4 p-4 rounded-lg hidden"></div>

        <!-- デバッグ情報 -->
        <div id="debugInfo" class="mt-6 p-4 bg-gray-100 rounded-lg text-xs text-gray-600 hidden"></div>
    </div>

    <script>
        // Firebase設定
        const firebaseConfig = {
            apiKey: "AIzaSyCRUvvs0OSz_9L9bXtqteVFIIze1OaZObE",
            authDomain: "ce-scheduling-system-v2.firebaseapp.com",
            databaseURL: "https://ce-scheduling-system-v2-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ce-scheduling-system-v2",
            storageBucket: "ce-scheduling-system-v2.firebasestorage.app",
            messagingSenderId: "288279598010",
            appId: "1:288279598010:web:d545ee1d4d854513084383",
            measurementId: "G-LSEEMJE2R0"
        };

        // Firebase初期化
        let app, auth, database;
        let currentUser = null;

        // デバッグログ
        function debugLog(message) {
            console.log(`[DEBUG] ${message}`);
            const debugDiv = document.getElementById('debugInfo');
            debugDiv.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message}</div>`;
            debugDiv.classList.remove('hidden');
        }

        // ステータス表示
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.className = `mt-4 p-4 rounded-lg ${type === 'error' ? 'bg-red-100 text-red-700 border border-red-300' : 
                                  type === 'success' ? 'bg-green-100 text-green-700 border border-green-300' : 
                                  'bg-blue-100 text-blue-700 border border-blue-300'}`;
            statusDiv.innerHTML = `<i class="fas fa-${type === 'error' ? 'exclamation-circle' : 
                                   type === 'success' ? 'check-circle' : 'info-circle'} mr-2"></i>${message}`;
            statusDiv.classList.remove('hidden');
        }

        // プログレスバー更新
        function updateProgress(step) {
            const steps = ['step1', 'step2', 'step3'];
            const progressFill = document.getElementById('progressFill');
            
            steps.forEach((stepId, index) => {
                const element = document.getElementById(stepId);
                if (index < step) {
                    element.className = element.className.replace('text-gray-400', 'text-green-600');
                } else if (index === step - 1) {
                    element.className = element.className.replace('text-gray-400', 'text-blue-600');
                }
            });
            
            progressFill.style.width = `${(step / 3) * 100}%`;
        }

        // セクション表示制御
        function showSection(sectionName) {
            ['loginSection', 'userSetupSection', 'completionSection'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(sectionName).classList.remove('hidden');
        }

        // Firebase初期化
        function initializeFirebase() {
            try {
                app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                database = firebase.database();
                debugLog('Firebase初期化完了');
                return true;
            } catch (error) {
                debugLog(`Firebase初期化エラー: ${error.message}`);
                showStatus(`Firebase初期化に失敗しました: ${error.message}`, 'error');
                return false;
            }
        }

        // ユーザー名からUIDを取得
        async function getUsernameUID(username) {
            try {
                const snapshot = await database.ref(`ceScheduleV2/usernames/${username}`).once('value');
                return snapshot.exists() ? snapshot.val() : null;
            } catch (error) {
                debugLog(`ユーザー名検索エラー: ${error.message}`);
                return null;
            }
        }

        // ユーザーデータ取得
        async function getUserData(uid) {
            try {
                const snapshot = await database.ref(`ceScheduleV2/users/${uid}`).once('value');
                return snapshot.exists() ? snapshot.val() : null;
            } catch (error) {
                debugLog(`ユーザーデータ取得エラー: ${error.message}`);
                return null;
            }
        }

        // ログイン処理
        async function handleLogin(loginInput, password) {
            try {
                debugLog(`ログイン試行: ${loginInput}`);
                showStatus('ログイン中...', 'info');

                let email = loginInput;
                
                // ユーザー名の場合、UIDを取得してユーザーデータからemailを取得
                if (!loginInput.includes('@')) {
                    debugLog('ユーザー名でのログインを検出');
                    const uid = await getUsernameUID(loginInput);
                    if (!uid) {
                        throw new Error('ユーザー名が見つかりません');
                    }
                    
                    const userData = await getUserData(uid);
                    if (!userData || !userData.email) {
                        throw new Error('ユーザーデータまたはメールアドレスが見つかりません');
                    }
                    
                    email = userData.email;
                    debugLog(`ユーザー名からメールアドレス取得: ${email}`);
                }

                // Firebase認証
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                
                debugLog(`認証成功: ${currentUser.email}`);
                
                // ユーザーデータ取得
                const userData = await getUserData(currentUser.uid);
                if (!userData) {
                    throw new Error('ユーザーデータが見つかりません');
                }

                debugLog(`ユーザーデータ取得完了: ${JSON.stringify(userData)}`);

                // 管理者の場合は管理ダッシュボードへ
                if (userData.role === 'admin') {
                    showStatus('管理者として認証されました。管理ダッシュボードにリダイレクトします...', 'success');
                    setTimeout(() => {
                        window.location.href = 'admin-debug.html';
                    }, 2000);
                    return;
                }

                // 初期ユーザーの場合は個人設定へ
                if (userData.isInitialUser === true || userData.hasCompletedSetup === false) {
                    debugLog('初期ユーザー - 個人設定画面へ移行');
                    showUserSetup(userData);
                } else {
                    debugLog('設定完了ユーザー - ダッシュボードへ');
                    showCompletion();
                }

            } catch (error) {
                debugLog(`ログインエラー: ${error.message}`);
                showStatus(`ログインに失敗しました: ${error.message}`, 'error');
            }
        }

        // 個人設定表示
        function showUserSetup(userData) {
            updateProgress(2);
            showSection('userSetupSection');
            
            const userInfo = document.getElementById('userInfo');
            userInfo.innerHTML = `
                <h3 class="font-semibold text-blue-800 mb-2">現在の情報</h3>
                <p><strong>ユーザー名:</strong> ${userData.username}</p>
                <p><strong>メールアドレス:</strong> ${userData.email}</p>
                <p><strong>権限:</strong> ${userData.role}</p>
                <p class="text-sm text-blue-600 mt-2">初回ログインです。個人設定を完了してください。</p>
            `;
            
            // フォームに現在の値を設定
            document.getElementById('newUsername').value = userData.username;
            
            showStatus('個人設定を行ってください', 'info');
        }

        // 個人設定完了処理
        async function handleUserSetup(newUsername, newPassword, confirmPassword) {
            try {
                debugLog('個人設定処理開始');
                showStatus('設定を保存中...', 'info');

                // パスワード確認
                if (newPassword !== confirmPassword) {
                    throw new Error('パスワードが一致しません');
                }

                if (newPassword.length < 8) {
                    throw new Error('パスワードは8文字以上で入力してください');
                }

                // パスワード更新
                await currentUser.updatePassword(newPassword);
                debugLog('パスワード更新完了');

                // データベース更新
                const updates = {
                    [`ceScheduleV2/users/${currentUser.uid}/username`]: newUsername,
                    [`ceScheduleV2/users/${currentUser.uid}/hasCompletedSetup`]: true,
                    [`ceScheduleV2/users/${currentUser.uid}/isInitialUser`]: false,
                    [`ceScheduleV2/users/${currentUser.uid}/lastLogin`]: Date.now(),
                    [`ceScheduleV2/usernames/${newUsername}`]: currentUser.uid
                };

                await database.ref().update(updates);
                debugLog('データベース更新完了');

                // 初期ユーザーデータ削除
                await database.ref(`ceScheduleV2/initialUsers/${currentUser.uid}`).remove();
                debugLog('初期ユーザーデータ削除完了');

                showCompletion();

            } catch (error) {
                debugLog(`個人設定エラー: ${error.message}`);
                showStatus(`設定の保存に失敗しました: ${error.message}`, 'error');
            }
        }

        // 完了画面表示
        function showCompletion() {
            updateProgress(3);
            showSection('completionSection');
            showStatus('個人設定が完了しました！', 'success');
        }

        // ダッシュボードへ移動
        function goToDashboard() {
            // TODO: 実際のダッシュボードページに遷移
            showStatus('ダッシュボード機能は開発中です', 'info');
        }

        // ログアウト
        async function logout() {
            try {
                await auth.signOut();
                currentUser = null;
                updateProgress(1);
                showSection('loginSection');
                showStatus('ログアウトしました', 'success');
                debugLog('ログアウト完了');
            } catch (error) {
                debugLog(`ログアウトエラー: ${error.message}`);
                showStatus(`ログアウトに失敗しました: ${error.message}`, 'error');
            }
        }

        // イベントリスナー
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('ページ読み込み完了');
            
            if (!initializeFirebase()) {
                return;
            }

            // ログインフォーム
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const loginInput = document.getElementById('loginInput').value.trim();
                const password = document.getElementById('loginPassword').value;
                
                if (loginInput && password) {
                    handleLogin(loginInput, password);
                }
            });

            // 個人設定フォーム
            document.getElementById('setupForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const newUsername = document.getElementById('newUsername').value.trim();
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                if (newUsername && newPassword && confirmPassword) {
                    handleUserSetup(newUsername, newPassword, confirmPassword);
                }
            });

            // 認証状態の監視
            auth.onAuthStateChanged(function(user) {
                if (user) {
                    debugLog(`認証状態変更: ログイン中 (${user.email})`);
                    currentUser = user;
                } else {
                    debugLog('認証状態変更: 未ログイン');
                    currentUser = null;
                }
            });

            debugLog('システム初期化完了');
        });
    </script>
</body>
</html>
