<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‡ãƒãƒƒã‚°ç‰ˆç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - CEã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  V2</title>
    
    <!-- Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        .debug-log {
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .role-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .role-admin { background: #fee2e2; color: #dc2626; }
        .role-editor { background: #dbeafe; color: #2563eb; }
        .role-viewer { background: #ecfdf5; color: #059669; }
        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .status-active { background: #ecfdf5; color: #059669; }
        .status-pending { background: #fef3c7; color: #d97706; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">
                <i class="fas fa-shield-alt text-blue-600 mr-3"></i>
                ãƒ‡ãƒãƒƒã‚°ç‰ˆç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
            </h1>
            <p class="text-gray-600">CEã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  V2 - è©³ç´°ãƒ­ã‚°ä»˜ããƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</p>
        </div>

        <!-- Debug Log Section -->
        <div class="bg-gray-900 text-green-400 rounded-lg p-4 mb-8">
            <h3 class="text-lg font-semibold mb-3 flex items-center">
                <i class="fas fa-bug mr-2"></i>
                ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
                <button onclick="clearDebugLog()" class="ml-auto text-xs bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded">
                    ã‚¯ãƒªã‚¢
                </button>
            </h3>
            <div id="debugLog" class="debug-log bg-black p-3 rounded border"></div>
        </div>

        <!-- Firebase Status -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h3 class="text-lg font-semibold mb-4 flex items-center">
                <i class="fas fa-fire text-orange-500 mr-2"></i>
                Firebaseæ¥ç¶šçŠ¶æ…‹
            </h3>
            <div class="grid md:grid-cols-3 gap-4">
                <div class="text-center">
                    <div id="authStatus" class="inline-block px-4 py-2 rounded-full bg-gray-200 text-gray-600">
                        <i class="fas fa-spinner fa-spin mr-2"></i>ç¢ºèªä¸­
                    </div>
                    <p class="text-sm text-gray-600 mt-2">Authentication</p>
                </div>
                <div class="text-center">
                    <div id="databaseStatus" class="inline-block px-4 py-2 rounded-full bg-gray-200 text-gray-600">
                        <i class="fas fa-spinner fa-spin mr-2"></i>ç¢ºèªä¸­
                    </div>
                    <p class="text-sm text-gray-600 mt-2">Realtime Database</p>
                </div>
                <div class="text-center">
                    <div id="configStatus" class="inline-block px-4 py-2 rounded-full bg-gray-200 text-gray-600">
                        <i class="fas fa-spinner fa-spin mr-2"></i>ç¢ºèªä¸­
                    </div>
                    <p class="text-sm text-gray-600 mt-2">Config</p>
                </div>
            </div>
        </div>

        <!-- Login Section -->
        <div id="loginSection" class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h3 class="text-lg font-semibold mb-4 flex items-center">
                <i class="fas fa-sign-in-alt text-blue-600 mr-2"></i>
                ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³
            </h3>
            
            <div class="max-w-md mx-auto">
                <div class="mb-4">
                    <label for="adminEmail" class="block text-sm font-medium text-gray-700 mb-2">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                    <input type="email" id="adminEmail" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="admin@ce-schedule.com">
                </div>
                
                <div class="mb-6">
                    <label for="adminPassword" class="block text-sm font-medium text-gray-700 mb-2">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                    <input type="password" id="adminPassword"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
                
                <button onclick="adminLogin()" id="loginBtn"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                    <i class="fas fa-sign-in-alt mr-2"></i>
                    ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³
                </button>
            </div>
        </div>

        <!-- Admin Dashboard (Hidden initially) -->
        <div id="dashboardSection" class="hidden">
            <!-- User Creation Section -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <i class="fas fa-user-plus text-green-600 mr-2"></i>
                    æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
                </h3>
                
                <div id="statusMessage" class="hidden p-4 rounded-lg mb-4"></div>
                
                <div class="grid md:grid-cols-3 gap-4">
                    <div>
                        <label for="newUsername" class="block text-sm font-medium text-gray-700 mb-2">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
                        <input type="text" id="newUsername"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="ä¾‹: ç”°ä¸­å¤ªéƒ">
                    </div>
                    
                    <div>
                        <label for="newEmail" class="block text-sm font-medium text-gray-700 mb-2">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                        <input type="email" id="newEmail"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="ä¾‹: tanaka@example.com">
                    </div>
                    
                    <div>
                        <label for="newRole" class="block text-sm font-medium text-gray-700 mb-2">æ¨©é™ãƒ¬ãƒ™ãƒ«</label>
                        <select id="newRole" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">æ¨©é™ã‚’é¸æŠ</option>
                            <option value="admin">ç®¡ç†è€… (å…¨æ¨©é™)</option>
                            <option value="editor">ç·¨é›†è€… (ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç·¨é›†å¯)</option>
                            <option value="viewer">é–²è¦§è€… (é–²è¦§ã®ã¿)</option>
                        </select>
                    </div>
                </div>
                
                <div class="mt-6">
                    <button onclick="createUser()" id="createUserBtn"
                            class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-lg transition duration-200">
                        <i class="fas fa-user-plus mr-2"></i>
                        ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ
                    </button>
                </div>
            </div>

            <!-- Users List Section -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <i class="fas fa-users text-purple-600 mr-2"></i>
                    ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§
                    <button onclick="loadUsers()" class="ml-auto text-sm bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">
                        <i class="fas fa-sync-alt mr-1"></i>
                        æ›´æ–°
                    </button>
                </h3>
                
                <div class="overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ¨©é™</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ä½œæˆæ—¥æ™‚</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="6" class="px-4 py-4 text-center text-gray-500">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration (æ­£ã—ã„è¨­å®š)
        const firebaseConfig = {
            apiKey: "AIzaSyCRUvvs0OSz_9L9bXtqteVFIIze1OaZObE",
            authDomain: "ce-scheduling-system-v2.firebaseapp.com",
            databaseURL: "https://ce-scheduling-system-v2-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ce-scheduling-system-v2",
            storageBucket: "ce-scheduling-system-v2.firebasestorage.app",
            messagingSenderId: "288279598010",
            appId: "1:288279598010:web:d545ee1d4d854513084383",
            measurementId: "G-LSEEMJE2R0"
        };

        // Global variables
        let app, auth, database;
        let currentUser = null;

        // Debug logging function
        function debugLog(message, type = 'info') {
            const now = new Date().toISOString();
            const logElement = document.getElementById('debugLog');
            const colors = {
                info: 'text-green-400',
                error: 'text-red-400',
                warn: 'text-yellow-400',
                success: 'text-blue-400'
            };
            
            const logEntry = document.createElement('div');
            logEntry.className = colors[type] || 'text-green-400';
            logEntry.innerHTML = `[${now.substr(11, 8)}] ${message}`;
            
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(`[DEBUG ${type.toUpperCase()}] ${message}`);
        }

        function clearDebugLog() {
            document.getElementById('debugLog').innerHTML = '';
        }

        // Initialize Firebase
        function initializeFirebase() {
            try {
                debugLog('ğŸ”¥ FirebaseåˆæœŸåŒ–é–‹å§‹...', 'info');
                debugLog(`ğŸ“‹ è¨­å®šç¢ºèª: ${firebaseConfig.projectId}`, 'info');
                debugLog(`ğŸ”— Database URL: ${firebaseConfig.databaseURL}`, 'info');
                debugLog(`ğŸ”‘ API Key: ${firebaseConfig.apiKey.substr(0, 20)}...`, 'info');
                
                app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                database = firebase.database();
                
                updateStatus('configStatus', 'âœ… è¨­å®šå®Œäº†', 'success');
                debugLog('âœ… FirebaseåˆæœŸåŒ–å®Œäº†', 'success');
                
                // Test connections
                testFirebaseConnections();
                
                return true;
            } catch (error) {
                debugLog(`âŒ FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                updateStatus('configStatus', 'âŒ è¨­å®šã‚¨ãƒ©ãƒ¼', 'error');
                return false;
            }
        }

        // Test Firebase connections
        async function testFirebaseConnections() {
            // Test Authentication
            try {
                auth.onAuthStateChanged((user) => {
                    if (user) {
                        debugLog(`âœ… èªè¨¼çŠ¶æ…‹: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ (${user.email})`, 'success');
                        updateStatus('authStatus', 'âœ… èªè¨¼æ¸ˆã¿', 'success');
                        currentUser = user;
                        checkAdminPermissions(user);
                    } else {
                        debugLog('â„¹ï¸ èªè¨¼çŠ¶æ…‹: æœªãƒ­ã‚°ã‚¤ãƒ³', 'info');
                        updateStatus('authStatus', 'â³ æœªãƒ­ã‚°ã‚¤ãƒ³', 'pending');
                        currentUser = null;
                    }
                });
                updateStatus('authStatus', 'âœ… æ¥ç¶šOK', 'success');
            } catch (error) {
                debugLog(`âŒ Authenticationæ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                updateStatus('authStatus', 'âŒ æ¥ç¶šã‚¨ãƒ©ãƒ¼', 'error');
            }

            // Test Database
            try {
                const testRef = database.ref('.info/connected');
                testRef.on('value', (snapshot) => {
                    if (snapshot.val() === true) {
                        debugLog('âœ… Databaseæ¥ç¶šç¢ºèªæ¸ˆã¿', 'success');
                        updateStatus('databaseStatus', 'âœ… æ¥ç¶šOK', 'success');
                    } else {
                        debugLog('âš ï¸ Databaseæ¥ç¶šãŒä¸å®‰å®š', 'warn');
                        updateStatus('databaseStatus', 'âš ï¸ æ¥ç¶šä¸å®‰å®š', 'warn');
                    }
                });
            } catch (error) {
                debugLog(`âŒ Databaseæ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                updateStatus('databaseStatus', 'âŒ æ¥ç¶šã‚¨ãƒ©ãƒ¼', 'error');
            }
        }

        // Update status indicators
        function updateStatus(elementId, text, type) {
            const element = document.getElementById(elementId);
            const colors = {
                success: 'bg-green-100 text-green-800',
                error: 'bg-red-100 text-red-800',
                warn: 'bg-yellow-100 text-yellow-800',
                pending: 'bg-blue-100 text-blue-800'
            };
            
            element.className = `inline-block px-4 py-2 rounded-full ${colors[type] || 'bg-gray-200 text-gray-600'}`;
            element.innerHTML = text;
        }

        // Admin login
        async function adminLogin() {
            const email = document.getElementById('adminEmail').value.trim();
            const password = document.getElementById('adminPassword').value.trim();
            const loginBtn = document.getElementById('loginBtn');

            if (!email || !password) {
                debugLog('âŒ ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒç©ºã§ã™', 'error');
                showMessage('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            try {
                loginBtn.disabled = true;
                loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ãƒ­ã‚°ã‚¤ãƒ³ä¸­...';
                
                debugLog(`ğŸ” ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œ: ${email}`, 'info');
                
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                debugLog(`âœ… Firebaseèªè¨¼æˆåŠŸ: ${user.email} (UID: ${user.uid})`, 'success');
                
                // Check admin permissions
                await checkAdminPermissions(user);
                
            } catch (error) {
                debugLog(`âŒ ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: ${error.code} - ${error.message}`, 'error');
                
                let errorMessage = 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ';
                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'ç„¡åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã™';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œå›æ•°ãŒå¤šã™ãã¾ã™ã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„';
                }
                
                showMessage(errorMessage, 'error');
            } finally {
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i>ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³';
            }
        }

        // Check admin permissions
        async function checkAdminPermissions(user) {
            try {
                debugLog(`ğŸ” ç®¡ç†è€…æ¨©é™ç¢ºèªä¸­: ${user.uid}`, 'info');
                
                const userRef = database.ref(`ceScheduleV2/users/${user.uid}`);
                const snapshot = await userRef.once('value');
                
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    debugLog(`ğŸ“‹ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—: ${JSON.stringify(userData)}`, 'info');
                    
                    if (userData.role === 'admin') {
                        debugLog('âœ… ç®¡ç†è€…æ¨©é™ç¢ºèªæ¸ˆã¿', 'success');
                        showMessage(`ç®¡ç†è€…ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ: ${userData.username}`, 'success');
                        showDashboard();
                        loadUsers();
                    } else {
                        debugLog(`âŒ ç®¡ç†è€…æ¨©é™ãªã—: role=${userData.role}`, 'error');
                        showMessage('ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™', 'error');
                        await auth.signOut();
                    }
                } else {
                    debugLog('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                    showMessage('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                    await auth.signOut();
                }
            } catch (error) {
                debugLog(`âŒ æ¨©é™ç¢ºèªã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                showMessage('æ¨©é™ç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }

        // Show dashboard
        function showDashboard() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('dashboardSection').classList.remove('hidden');
            debugLog('âœ… ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¡¨ç¤º', 'success');
        }

        // Generate secure password
        function generateSecurePassword() {
            const length = 12;
            const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*";
            let password = "";
            
            password += "ABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(Math.random() * 26)];
            password += "abcdefghijklmnopqrstuvwxyz"[Math.floor(Math.random() * 26)];
            password += "0123456789"[Math.floor(Math.random() * 10)];
            password += "!@#$%^&*"[Math.floor(Math.random() * 8)];
            
            for (let i = 4; i < length; i++) {
                password += charset[Math.floor(Math.random() * charset.length)];
            }
            
            return password.split('').sort(() => 0.5 - Math.random()).join('');
        }

        // Create user
        async function createUser() {
            const username = document.getElementById('newUsername').value.trim();
            const email = document.getElementById('newEmail').value.trim();
            const role = document.getElementById('newRole').value;
            const createBtn = document.getElementById('createUserBtn');

            if (!username || !email || !role) {
                debugLog('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ: å¿…é ˆé …ç›®ãŒæœªå…¥åŠ›', 'error');
                showMessage('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            if (!validateEmail(email)) {
                debugLog(`âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ: ç„¡åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ (${email})`, 'error');
                showMessage('æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            try {
                createBtn.disabled = true;
                createBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ä½œæˆä¸­...';
                
                debugLog(`ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆé–‹å§‹: ${username} (${email})`, 'info');
                
                // Check username uniqueness
                const usernameRef = database.ref(`ceScheduleV2/usernames/${username}`);
                const usernameSnapshot = await usernameRef.once('value');
                
                if (usernameSnapshot.exists()) {
                    debugLog(`âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼åé‡è¤‡: ${username}`, 'error');
                    showMessage('ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™', 'error');
                    return;
                }

                // Generate password
                const password = generateSecurePassword();
                debugLog(`ğŸ”‘ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆå®Œäº†: ${password.substr(0, 4)}...`, 'info');

                // Create Firebase user
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const uid = userCredential.user.uid;
                
                debugLog(`âœ… Firebaseèªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆå®Œäº†: ${uid}`, 'success');

                // Prepare user data
                const userData = {
                    uid: uid,
                    username: username,
                    email: email,
                    role: role,
                    isInitialUser: true,
                    hasCompletedSetup: false,
                    createdAt: new Date().toISOString(),
                    createdBy: currentUser?.uid || 'system'
                };

                // Save to database
                await Promise.all([
                    database.ref(`ceScheduleV2/users/${uid}`).set(userData),
                    database.ref(`ceScheduleV2/usernames/${username}`).set(uid),
                    database.ref(`ceScheduleV2/initialUsers/${uid}`).set({
                        username: username,
                        tempPassword: password,
                        created: new Date().toISOString()
                    })
                ]);

                debugLog('âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¿å­˜å®Œäº†', 'success');

                showMessage(`
                    ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸï¼<br><br>
                    <strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼å:</strong> ${username}<br>
                    <strong>ãƒ¡ãƒ¼ãƒ«:</strong> ${email}<br>
                    <strong>æ¨©é™:</strong> ${role}<br>
                    <strong>ä»®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</strong> <code class="bg-gray-100 px-2 py-1 rounded">${password}</code><br><br>
                    <em class="text-sm">â€»ã“ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å®‰å…¨ã«ä¼é”ã—ã¦ãã ã•ã„</em>
                `, 'success');

                // Clear form
                document.getElementById('newUsername').value = '';
                document.getElementById('newEmail').value = '';
                document.getElementById('newRole').value = '';

                // Reload users
                loadUsers();

            } catch (error) {
                debugLog(`âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆã‚¨ãƒ©ãƒ¼: ${error.code} - ${error.message}`, 'error');
                
                let errorMessage = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ';
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'ç„¡åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã™';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¼±ã™ãã¾ã™';
                }
                
                showMessage(errorMessage, 'error');
            } finally {
                createBtn.disabled = false;
                createBtn.innerHTML = '<i class="fas fa-user-plus mr-2"></i>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ';
            }
        }

        // Load users
        async function loadUsers() {
            try {
                debugLog('ğŸ“‹ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§èª­ã¿è¾¼ã¿é–‹å§‹', 'info');
                
                const usersRef = database.ref('ceScheduleV2/users');
                const snapshot = await usersRef.once('value');
                const tbody = document.getElementById('usersTableBody');
                
                tbody.innerHTML = '';
                
                if (snapshot.exists()) {
                    const users = snapshot.val();
                    const userCount = Object.keys(users).length;
                    debugLog(`ğŸ“Š ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: ${userCount}`, 'info');
                    
                    Object.entries(users).forEach(([uid, userData]) => {
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-gray-50';
                        
                        const statusBadge = userData.hasCompletedSetup 
                            ? '<span class="status-badge status-active">è¨­å®šå®Œäº†</span>' 
                            : '<span class="status-badge status-pending">åˆæœŸçŠ¶æ…‹</span>';
                        
                        const roleBadge = getRoleBadge(userData.role);
                        
                        row.innerHTML = `
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${userData.username || 'N/A'}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">${userData.email || 'N/A'}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">${roleBadge}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">${statusBadge}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">${formatDate(userData.createdAt)}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium">
                                <button onclick="deleteUser('${uid}', '${userData.username}')" 
                                        class="text-red-600 hover:text-red-900 ml-2">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        `;
                        
                        tbody.appendChild(row);
                    });
                    
                    debugLog(`âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§è¡¨ç¤ºå®Œäº†: ${userCount}ä»¶`, 'success');
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-4 text-center text-gray-500">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</td></tr>';
                    debugLog('â„¹ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãªã—', 'info');
                }
            } catch (error) {
                debugLog(`âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                showMessage('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // Delete user
        async function deleteUser(uid, username) {
            if (!confirm(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œ${username}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
                return;
            }

            try {
                debugLog(`ğŸ—‘ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤é–‹å§‹: ${username} (${uid})`, 'info');
                
                const userRef = database.ref(`ceScheduleV2/users/${uid}`);
                const userSnapshot = await userRef.once('value');
                
                if (!userSnapshot.exists()) {
                    debugLog('âŒ å‰Šé™¤å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                    showMessage('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                    return;
                }

                const userData = userSnapshot.val();

                await Promise.all([
                    database.ref(`ceScheduleV2/users/${uid}`).remove(),
                    database.ref(`ceScheduleV2/usernames/${userData.username}`).remove(),
                    database.ref(`ceScheduleV2/initialUsers/${uid}`).remove()
                ]);

                debugLog(`âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤å®Œäº†: ${username}`, 'success');
                showMessage(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œ${username}ã€ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ`, 'success');
                loadUsers();

            } catch (error) {
                debugLog(`âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                showMessage('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // Helper functions
        function getRoleBadge(role) {
            const badges = {
                admin: '<span class="role-badge role-admin">ç®¡ç†è€…</span>',
                editor: '<span class="role-badge role-editor">ç·¨é›†è€…</span>',
                viewer: '<span class="role-badge role-viewer">é–²è¦§è€…</span>'
            };
            return badges[role] || '<span class="role-badge">ä¸æ˜</span>';
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('ja-JP', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                return 'N/A';
            }
        }

        function validateEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function showMessage(message, type) {
            const statusMessage = document.getElementById('statusMessage');
            const colors = {
                success: 'bg-green-100 border-green-400 text-green-700',
                error: 'bg-red-100 border-red-400 text-red-700',
                info: 'bg-blue-100 border-blue-400 text-blue-700',
                warn: 'bg-yellow-100 border-yellow-400 text-yellow-700'
            };
            
            statusMessage.className = `p-4 rounded-lg mb-4 border-l-4 ${colors[type] || colors.info}`;
            statusMessage.innerHTML = message;
            statusMessage.classList.remove('hidden');
            
            if (type === 'success') {
                setTimeout(() => {
                    statusMessage.classList.add('hidden');
                }, 8000);
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('ğŸš€ ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†', 'info');
            
            if (initializeFirebase()) {
                debugLog('âœ… ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†', 'success');
            } else {
                debugLog('âŒ ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å¤±æ•—', 'error');
            }
            
            // Add enter key listeners
            document.getElementById('adminEmail').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') adminLogin();
            });
            
            document.getElementById('adminPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') adminLogin();
            });
        });
    </script>
</body>
</html>
