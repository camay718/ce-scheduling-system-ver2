<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¥­å‹™åˆ¥ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ - CEã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  V2</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/theme-unified.css">
    
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #E8F5E8 0%, #D4F1D4 100%);
            --accent-color: #B8E6B8;
            --text-color: #2C3E50;
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        body {
            background: var(--primary-gradient);
            font-family: 'Segoe UI', 'Hiragino Sans', 'Yu Gothic UI', sans-serif;
            color: var(--text-color);
            min-height: 100vh;
        }

        .glassmorphism {
            background: rgba(255,255,255,0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-primary {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 20px;
            font-weight: 600;
            box-shadow: var(--shadow);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .btn-primary:hover { 
            transform: translateY(-1px); 
            box-shadow: 0 6px 18px rgba(0,0,0,0.15); 
        }

        .department-area {
            background: rgba(255,255,255,0.85);
            border-radius: 14px;
            padding: 16px;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--dept-color);
            margin-bottom: 20px;
        }

        .dept-è¡€æ¶²æµ„åŒ– { --dept-color: #FFB6C1; }
        .dept-äººå·¥å¿ƒè‚ºãƒ»è£œåŠ©å¾ªç’° { --dept-color: #4169E1; }
        .dept-å¿ƒãƒ»ã‚«ãƒ†ãƒ¼ãƒ†ãƒ« { --dept-color: #32CD32; }
        .dept-æ‰‹è¡“ãƒ»éº»é…” { --dept-color: #87CEEB; }
        .dept-ä¸æ•´è„ˆ { --dept-color: #9370DB; }
        .dept-æ©Ÿå™¨ç®¡ç†ãƒ»äººå·¥å‘¼å¸ { --dept-color: #90EE90; }

        .timeline-day-row {
            padding: 12px;
            margin-bottom: 8px;
            background: rgba(255,255,255,0.9);
            border-radius: 8px;
            border: 1px solid rgba(0,0,0,0.06);
        }

        .timeline-track {
            position: relative;
            width: 100%;
            background: #f0f0f0;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #ddd;
            min-height: 30px;
        }

        .task-bar {
            position: absolute;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .task-bar:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .time-scale {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            padding: 0 4px;
            font-size: 10px;
            color: #666;
        }

        .filter-section {
            background: rgba(255,255,255,0.9);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .no-tasks-message {
            text-align: center;
            padding: 40px 20px;
            color: #999;
            background: rgba(255,255,255,0.5);
            border-radius: 8px;
            border: 2px dashed #ddd;
        }

        .auth-error {
            background: #fee2e2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 16px;
            margin: 20px;
            color: #991b1b;
        }

        /* å°åˆ·ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        @media print {
            body { 
                background: white !important; 
                color: #000 !important; 
            }
            .no-print { 
                display: none !important; 
            }
            .glassmorphism { 
                background: white !important; 
                border: 1px solid #ccc !important; 
            }
            .department-area {
                break-inside: avoid;
                margin-bottom: 15px;
            }
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 768px) {
            .filter-section {
                padding: 12px;
            }
            
            .department-area {
                padding: 12px;
            }
            
            .timeline-day-row {
                padding: 8px;
            }
            
            .task-bar {
                font-size: 10px;
                height: 20px;
            }
            
            .time-scale {
                font-size: 9px;
            }
        }
    </style>
</head>
<body>
    <div id="authWarning" class="auth-error" style="display: none;">
        <h3><i class="fas fa-exclamation-triangle mr-2"></i>èªè¨¼ã‚¨ãƒ©ãƒ¼</h3>
        <p>ã“ã®ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã«ã¯ã€ã¾ãš<a href="dashboard.html" class="underline font-bold">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>ã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚</p>
        <p class="text-sm mt-2">ã¾ãŸã¯ã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®ã€Œé›†è¨ˆãƒ»åˆ†æã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚</p>
    </div>

    <div class="container mx-auto p-4 max-w-7xl">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 no-print">
            <div>
                <h1 class="text-3xl font-bold mb-2">
                    <i class="fas fa-chart-gantt mr-3 text-green-600"></i>æ¥­å‹™åˆ¥ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³
                </h1>
                <p class="text-gray-600">éƒ¨é–€ã”ã¨ã®æ¥­å‹™ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’æ™‚é–“è»¸ã§å¯è¦–åŒ–</p>
            </div>
            <div class="flex gap-3 mt-4 md:mt-0">
                <button id="exportBtn" class="btn-primary">
                    <i class="fas fa-download mr-2"></i>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                </button>
                <button onclick="window.print()" class="btn-primary">
                    <i class="fas fa-print mr-2"></i>å°åˆ·
                </button>
                <button onclick="history.back()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                    <i class="fas fa-arrow-left mr-2"></i>æˆ»ã‚‹
                </button>
            </div>
        </div>

        <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ»è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="filter-section no-print">
            <h3 class="text-lg font-bold mb-4">
                <i class="fas fa-filter mr-2"></i>è¡¨ç¤ºè¨­å®š
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                <!-- æœŸé–“è¨­å®š -->
                <div>
                    <label class="block text-sm font-medium mb-2">é–‹å§‹æ—¥</label>
                    <input type="date" id="startDate" class="w-full p-3 border border-gray-300 rounded-lg">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">çµ‚äº†æ—¥</label>
                    <input type="date" id="endDate" class="w-full p-3 border border-gray-300 rounded-lg">
                </div>

                <!-- æ™‚é–“ç¯„å›²è¨­å®š -->
                <div>
                    <label class="block text-sm font-medium mb-2">è¡¨ç¤ºé–‹å§‹æ™‚åˆ»</label>
                    <input type="time" id="displayStartTime" value="07:00" class="w-full p-3 border border-gray-300 rounded-lg">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">è¡¨ç¤ºçµ‚äº†æ™‚åˆ»</label>
                    <input type="time" id="displayEndTime" value="19:00" class="w-full p-3 border border-gray-300 rounded-lg">
                </div>
            </div>

            <!-- éƒ¨é–€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">è¡¨ç¤ºéƒ¨é–€</label>
                <div class="flex flex-wrap gap-2">
                    <label class="flex items-center">
                        <input type="checkbox" class="department-filter" value="all" checked>
                        <span class="ml-2 font-bold">å…¨éƒ¨é–€</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" class="department-filter" value="è¡€æ¶²æµ„åŒ–" checked>
                        <span class="ml-2">è¡€æ¶²æµ„åŒ–</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" class="department-filter" value="äººå·¥å¿ƒè‚ºãƒ»è£œåŠ©å¾ªç’°" checked>
                        <span class="ml-2">äººå·¥å¿ƒè‚ºãƒ»è£œåŠ©å¾ªç’°</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" class="department-filter" value="å¿ƒãƒ»ã‚«ãƒ†ãƒ¼ãƒ†ãƒ«" checked>
                        <span class="ml-2">å¿ƒãƒ»ã‚«ãƒ†ãƒ¼ãƒ†ãƒ«</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" class="department-filter" value="æ‰‹è¡“ãƒ»éº»é…”" checked>
                        <span class="ml-2">æ‰‹è¡“ãƒ»éº»é…”</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" class="department-filter" value="ä¸æ•´è„ˆ" checked>
                        <span class="ml-2">ä¸æ•´è„ˆ</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" class="department-filter" value="æ©Ÿå™¨ç®¡ç†ãƒ»äººå·¥å‘¼å¸" checked>
                        <span class="ml-2">æ©Ÿå™¨ç®¡ç†ãƒ»äººå·¥å‘¼å¸</span>
                    </label>
                </div>
            </div>

            <div class="flex gap-3">
                <button id="applyFiltersBtn" class="btn-primary">
                    <i class="fas fa-search mr-2"></i>è¡¨ç¤ºæ›´æ–°
                </button>
                <button id="resetFiltersBtn" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                    <i class="fas fa-undo mr-2"></i>ãƒªã‚»ãƒƒãƒˆ
                </button>
                <button id="currentWeekBtn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                    <i class="fas fa-calendar-week mr-2"></i>ä»Šé€±è¡¨ç¤º
                </button>
            </div>
        </div>

        <!-- ã‚µãƒãƒªãƒ¼æƒ…å ± -->
        <div id="summarySection" class="glassmorphism rounded-2xl p-4 mb-6">
            <h3 class="text-lg font-bold mb-3">
                <i class="fas fa-info-circle mr-2"></i>è¡¨ç¤ºã‚µãƒãƒªãƒ¼
            </h3>
            <div id="summaryContent" class="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm">
                <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
            </div>
        </div>

        <!-- ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="timelineContainer">
            <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
        </div>

        <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
        <div id="loadingIndicator" class="text-center py-8" style="display: none;">
            <i class="fas fa-spinner fa-spin text-2xl text-green-600"></i>
            <p class="mt-2 text-gray-600">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
        // èªè¨¼ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½
        function checkAuthenticationStatus() {
            const targetUID = sessionStorage.getItem('targetUID');
            const currentUsername = sessionStorage.getItem('currentUsername');
            
            if (!targetUID || !currentUsername) {
                console.warn('âš ï¸ èªè¨¼æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚');
                document.getElementById('authWarning').style.display = 'block';
                return false;
            }
            
            return true;
        }

        // Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyBpfRTPDFFTEkWtuvksoF_hVkftQ__wH8Q",
            authDomain: "ce-scheduling-system.firebaseapp.com",
            databaseURL: "https://ce-scheduling-system-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ce-scheduling-system",
            storageBucket: "ce-scheduling-system.firebasestorage.app",
            messagingSenderId: "401096569342",
            appId: "1:401096569342:web:03b0a5f5bfd09e34ae90af",
            measurementId: "G-8C7X5WCED3"
        };

        const DATA_ROOT = 'ceScheduleSystem/v2';

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let database = null;
        let globalTasksData = {};
        let globalAssignmentsData = {};
        let currentDateRange = [];
        let displayStartHour = 7;
        let displayEndHour = 19;

        // ğŸ”§ ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ¼å½¢å¼ã®è‡ªå‹•åˆ¤å®šç”¨å¤‰æ•°
        const WEEKDAY_KEYS = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
        let dataKeyFormat = 'unknown'; // 'weekday' | 'date' | 'mixed'

        // éƒ¨é–€è¨­å®š
        const DEPARTMENTS = [
            'è¡€æ¶²æµ„åŒ–', 'äººå·¥å¿ƒè‚ºãƒ»è£œåŠ©å¾ªç’°', 'å¿ƒãƒ»ã‚«ãƒ†ãƒ¼ãƒ†ãƒ«', 
            'æ‰‹è¡“ãƒ»éº»é…”', 'ä¸æ•´è„ˆ', 'æ©Ÿå™¨ç®¡ç†ãƒ»äººå·¥å‘¼å¸'
        ];

        const DEPARTMENT_COLORS = {
            'è¡€æ¶²æµ„åŒ–': '#FFB6C1',
            'äººå·¥å¿ƒè‚ºãƒ»è£œåŠ©å¾ªç’°': '#4169E1',
            'å¿ƒãƒ»ã‚«ãƒ†ãƒ¼ãƒ†ãƒ«': '#32CD32',
            'æ‰‹è¡“ãƒ»éº»é…”': '#87CEEB',
            'ä¸æ•´è„ˆ': '#9370DB',
            'æ©Ÿå™¨ç®¡ç†ãƒ»äººå·¥å‘¼å¸': '#90EE90'
        };

        const DEPARTMENT_ICONS = {
            'è¡€æ¶²æµ„åŒ–': 'tint',
            'äººå·¥å¿ƒè‚ºãƒ»è£œåŠ©å¾ªç’°': 'procedures',
            'å¿ƒãƒ»ã‚«ãƒ†ãƒ¼ãƒ†ãƒ«': 'heart',
            'æ‰‹è¡“ãƒ»éº»é…”': 'user-md',
            'ä¸æ•´è„ˆ': 'heartbeat',
            'æ©Ÿå™¨ç®¡ç†ãƒ»äººå·¥å‘¼å¸': 'lungs'
        };

        // ========== åˆæœŸåŒ– ==========
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ”„ æ¥­å‹™åˆ¥ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³åˆæœŸåŒ–é–‹å§‹');
            
            if (!checkAuthenticationStatus()) {
                return;
            }
            
            initializeFirebase();
            setupEventListeners();
            setCurrentWeekRange();
            
            // ğŸ”§ Firebaseæ¥ç¶šå¾Œã«è‡ªå‹•çš„ã«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
            setTimeout(() => {
                loadTimelineData();
            }, 1000);
        });

        function initializeFirebase() {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                database = firebase.database();
                
                firebase.auth().signInAnonymously()
                    .then(() => {
                        console.log('âœ… Firebaseæ¥ç¶šæˆåŠŸ');
                    })
                    .catch((error) => {
                        console.error('âŒ Firebaseèªè¨¼ã‚¨ãƒ©ãƒ¼:', error);
                        document.getElementById('authWarning').style.display = 'block';
                    });
                    
            } catch (error) {
                console.error('âŒ FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('Firebaseæ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                document.getElementById('authWarning').style.display = 'block';
            }
        }

        function setupEventListeners() {
            document.getElementById('applyFiltersBtn').addEventListener('click', loadTimelineData);
            document.getElementById('resetFiltersBtn').addEventListener('click', resetFilters);
            document.getElementById('currentWeekBtn').addEventListener('click', setCurrentWeekAndLoad);
            document.getElementById('exportBtn').addEventListener('click', exportTimeline);
            
            // å…¨éƒ¨é–€ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ç‰¹åˆ¥å‡¦ç†
            document.querySelector('.department-filter[value="all"]').addEventListener('change', function() {
                const isChecked = this.checked;
                document.querySelectorAll('.department-filter:not([value="all"])').forEach(cb => {
                    cb.checked = isChecked;
                });
            });
            
            // å€‹åˆ¥éƒ¨é–€ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å‡¦ç†
            document.querySelectorAll('.department-filter:not([value="all"])').forEach(cb => {
                cb.addEventListener('change', updateAllDepartmentCheckbox);
            });
        }

        // ğŸ”§ å½“è©²é€±ã®æ—¥ä»˜ç¯„å›²ã‚’è¨­å®šï¼ˆæ—¥æ›œã€œåœŸæ›œï¼‰
        function setCurrentWeekRange() {
            const today = new Date();
            const currentDay = today.getDay(); // 0=æ—¥æ›œ, 1=æœˆæ›œ, ..., 6=åœŸæ›œ
            
            // é€±ã®é–‹å§‹æ—¥ï¼ˆæ—¥æ›œæ—¥ï¼‰ã‚’è¨ˆç®—
            const startDate = new Date(today);
            startDate.setDate(today.getDate() - currentDay);
            
            // é€±ã®çµ‚äº†æ—¥ï¼ˆåœŸæ›œæ—¥ï¼‰ã‚’è¨ˆç®—
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6);
            
            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
            
            console.log(`ğŸ“… å½“è©²é€±è¨­å®š: ${startDate.toISOString().split('T')[0]} ï½ ${endDate.toISOString().split('T')[0]}`);
        }

        // ğŸ”§ ä»Šé€±è¡¨ç¤ºãƒœã‚¿ãƒ³ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        function setCurrentWeekAndLoad() {
            setCurrentWeekRange();
            loadTimelineData();
        }

        function setDefaultDateRange() {
            setCurrentWeekRange();
        }

        // ğŸ”§ ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ¼å½¢å¼ã‚’è‡ªå‹•åˆ¤å®š
        function detectDataKeyFormat(data) {
            const keys = Object.keys(data || {});
            if (keys.length === 0) return 'empty';
            
            const hasWeekdayKeys = keys.some(key => WEEKDAY_KEYS.includes(key));
            const hasDateKeys = keys.some(key => /^\d{4}-\d{2}-\d{2}$/.test(key));
            
            if (hasDateKeys && !hasWeekdayKeys) return 'date';
            if (hasWeekdayKeys && !hasDateKeys) return 'weekday';
            return 'mixed';
        }

        // ğŸ”§ æ—¥ä»˜ã«å¯¾å¿œã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ¼ã‚’å–å¾—
        function getDataKeyForDate(date) {
            if (dataKeyFormat === 'date') {
                return formatDateAsISO(date);
            } else if (dataKeyFormat === 'weekday') {
                return WEEKDAY_KEYS[date.getDay()];
            } else {
                // mixed ã¾ãŸã¯ unknown ã®å ´åˆã€ã¾ãšæ—¥ä»˜ã‚­ãƒ¼ã‚’è©¦ã—ã€ãªã‘ã‚Œã°æ›œæ—¥ã‚­ãƒ¼
                const dateKey = formatDateAsISO(date);
                if (globalTasksData[dateKey] !== undefined) {
                    return dateKey;
                }
                return WEEKDAY_KEYS[date.getDay()];
            }
        }

        // ========== ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ ==========
        async function loadTimelineData() {
            showLoading(true);
            console.log('ğŸ”„ ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³èª­ã¿è¾¼ã¿é–‹å§‹');
            
            try {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                if (!startDate || !endDate) {
                    showMessage('é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„', 'warning');
                    return;
                }
                
                if (new Date(startDate) > new Date(endDate)) {
                    showMessage('é–‹å§‹æ—¥ã¯çµ‚äº†æ—¥ã‚ˆã‚Šå‰ã«è¨­å®šã—ã¦ãã ã•ã„', 'warning');
                    return;
                }
                
                console.log(`ğŸ“… æœŸé–“è¨­å®š: ${startDate} ï½ ${endDate}`);
                
                // æ—¥ä»˜ç¯„å›²ã‚’ç”Ÿæˆ
                currentDateRange = generateDateRange(startDate, endDate);
                console.log('ğŸ“… ç”Ÿæˆã•ã‚ŒãŸæ—¥ä»˜ç¯„å›²:', currentDateRange.map(d => d.toISOString().split('T')[0]));
                
                // Firebase ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
                await loadDataFromFirebase();
                
                // è¡¨ç¤ºæ™‚é–“ç¯„å›²ã‚’æ›´æ–°
                updateDisplayTimeRange();
                
                // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’ç”Ÿæˆãƒ»è¡¨ç¤º
                generateTimeline();
                
                // ã‚µãƒãƒªãƒ¼æƒ…å ±ã‚’æ›´æ–°
                updateSummary();
                
                console.log('âœ… ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³èª­ã¿è¾¼ã¿å®Œäº†');
                
            } catch (error) {
                console.error('âŒ ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function loadDataFromFirebase() {
            if (!database) {
                throw new Error('Firebaseæœªæ¥ç¶š');
            }
            
            try {
                console.log('ğŸ”„ Firebaseã‹ã‚‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...');
                const snapshot = await database.ref(`${DATA_ROOT}/state`).once('value');
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    globalTasksData = data.tasks || {};
                    globalAssignmentsData = data.assignments || {};
                    
                    // ğŸ”§ ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ¼å½¢å¼ã‚’è‡ªå‹•åˆ¤å®š
                    dataKeyFormat = detectDataKeyFormat(globalTasksData);
                    console.log(`ğŸ” æ¤œå‡ºã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚­ãƒ¼å½¢å¼: ${dataKeyFormat}`);
                    console.log('ğŸ“Š èª­ã¿è¾¼ã¾ã‚ŒãŸã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ¼:', Object.keys(globalTasksData));
                    console.log('ğŸ‘¥ èª­ã¿è¾¼ã¾ã‚ŒãŸé…ç½®ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ¼:', Object.keys(globalAssignmentsData));
                } else {
                    console.warn('âš ï¸ Firebaseã«ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã›ã‚“');
                    globalTasksData = {};
                    globalAssignmentsData = {};
                    dataKeyFormat = 'empty';
                }
                
                console.log('âœ… Firebaseãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†');
            } catch (error) {
                console.error('âŒ Firebaseèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                throw error;
            }
        }

        function generateDateRange(startDateStr, endDateStr) {
            const dates = [];
            const startDate = new Date(startDateStr);
            const endDate = new Date(endDateStr);
            
            startDate.setHours(0, 0, 0, 0);
            endDate.setHours(0, 0, 0, 0);
            
            const current = new Date(startDate);
            
            while (current <= endDate) {
                dates.push(new Date(current));
                current.setDate(current.getDate() + 1);
            }
            
            return dates;
        }

        function updateDisplayTimeRange() {
            const startTime = document.getElementById('displayStartTime').value;
            const endTime = document.getElementById('displayEndTime').value;
            
            displayStartHour = parseInt(startTime.split(':')[0]);
            displayEndHour = parseInt(endTime.split(':')[0]);
            
            console.log(`â° è¡¨ç¤ºæ™‚é–“ç¯„å›²: ${displayStartHour}:00 ï½ ${displayEndHour}:00`);
        }

        // ========== ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ç”Ÿæˆ ==========
        function generateTimeline() {
            console.log('ğŸ”„ ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ç”Ÿæˆé–‹å§‹');
            const container = document.getElementById('timelineContainer');
            container.innerHTML = '';
            
            const selectedDepartments = getSelectedDepartments();
            console.log('ğŸ¥ é¸æŠã•ã‚ŒãŸéƒ¨é–€:', selectedDepartments);
            
            if (selectedDepartments.length === 0) {
                container.innerHTML = `
                    <div class="no-tasks-message">
                        <i class="fas fa-info-circle text-3xl mb-4 block"></i>
                        <p class="text-lg font-bold mb-2">è¡¨ç¤ºã™ã‚‹éƒ¨é–€ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
                        <p>ä¸Šè¨˜ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‹ã‚‰è¡¨ç¤ºã—ãŸã„éƒ¨é–€ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚</p>
                    </div>
                `;
                return;
            }
            
            let hasAnyData = false;
            
            selectedDepartments.forEach(department => {
                const departmentElement = generateDepartmentTimeline(department, container);
                if (departmentElement) {
                    hasAnyData = true;
                }
            });
            
            if (!hasAnyData) {
                container.innerHTML = `
                    <div class="no-tasks-message">
                        <i class="fas fa-calendar-times text-3xl mb-4 block"></i>
                        <p class="text-lg font-bold mb-2">æŒ‡å®šæœŸé–“å†…ã«æ¥­å‹™ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
                        <p>æœŸé–“ã‚’å¤‰æ›´ã™ã‚‹ã‹ã€ãƒ‡ãƒ¼ã‚¿ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹ã”ç¢ºèªãã ã•ã„ã€‚</p>
                        <p class="text-sm mt-2">ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ¼å½¢å¼: ${dataKeyFormat}</p>
                    </div>
                `;
            }
            
            console.log('âœ… ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ç”Ÿæˆå®Œäº†');
        }

        function generateDepartmentTimeline(department, container) {
            console.log(`ğŸ”„ ${department} ã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ç”Ÿæˆä¸­...`);
            
            const departmentData = collectDepartmentData(department);
            console.log(`ğŸ“Š ${department} ã®ãƒ‡ãƒ¼ã‚¿:`, Object.keys(departmentData));
            
            // éƒ¨é–€ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ
            const deptCard = document.createElement('div');
            deptCard.className = `department-area dept-${department}`;
            deptCard.style.setProperty('--dept-color', DEPARTMENT_COLORS[department]);
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼
            const header = createDepartmentHeader(department, departmentData);
            deptCard.appendChild(header);
            
            // æ¥­å‹™ãŒå­˜åœ¨ã—ãªã„å ´åˆ
            if (Object.keys(departmentData).length === 0) {
                const noTasksDiv = document.createElement('div');
                noTasksDiv.className = 'no-tasks-message';
                noTasksDiv.innerHTML = `
                    <i class="fas fa-calendar-times text-2xl mb-2 block"></i>
                    <p>æŒ‡å®šæœŸé–“å†…ã« ${department} ã®æ¥­å‹™ã¯ã‚ã‚Šã¾ã›ã‚“</p>
                `;
                deptCard.appendChild(noTasksDiv);
            } else {
                // æ—¥åˆ¥ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³
                const timelineBody = createTimelineBody(departmentData);
                deptCard.appendChild(timelineBody);
            }
            
            container.appendChild(deptCard);
            return deptCard;
        }

        // ğŸ”§ éƒ¨é–€ãƒ‡ãƒ¼ã‚¿åé›†é–¢æ•°ï¼ˆæŸ”è»Ÿãªã‚­ãƒ¼å¯¾å¿œï¼‰
        function collectDepartmentData(department) {
            const departmentData = {};
            
            currentDateRange.forEach(date => {
                const dataKey = getDataKeyForDate(date);
                console.log(`ğŸ“… ${department} - ${formatDateAsISO(date)} (ã‚­ãƒ¼: ${dataKey}) ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯ä¸­...`);
                
                const dayTasks = (globalTasksData[dataKey] || []).filter(task => {
                    const matches = task.department === department;
                    if (matches) {
                        console.log(`âœ… ãƒãƒƒãƒã—ãŸæ¥­å‹™: ${task.name} (${task.startTime}-${task.endTime})`);
                    }
                    return matches;
                });
                
                if (dayTasks.length > 0) {
                    const displayKey = formatDateAsISO(date); // è¡¨ç¤ºç”¨ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚­ãƒ¼
                    departmentData[displayKey] = {
                        date: date,
                        tasks: dayTasks,
                        assignments: globalAssignmentsData[dataKey] || {},
                        originalDataKey: dataKey // å…ƒã®ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ¼ã‚’ä¿æŒ
                    };
                    console.log(`ğŸ“Š ${displayKey} ã« ${dayTasks.length} ä»¶ã®æ¥­å‹™ã‚’è¿½åŠ `);
                }
            });
            
            return departmentData;
        }

        function createDepartmentHeader(department, departmentData) {
            const totalTasks = Object.values(departmentData).reduce((sum, day) => sum + day.tasks.length, 0);
            
            const header = document.createElement('div');
            header.className = 'flex items-center justify-between mb-4';
            header.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-${DEPARTMENT_ICONS[department]} mr-3 text-2xl" 
                       style="color: ${DEPARTMENT_COLORS[department]};"></i>
                    <h3 class="text-xl font-bold">${department}</h3>
                </div>
                <div class="text-sm text-gray-600">
                    <span class="bg-white bg-opacity-70 px-3 py-1 rounded-full">
                        æœŸé–“å†…ç·æ¥­å‹™: ${totalTasks}ä»¶
                    </span>
                </div>
            `;
            
            return header;
        }

        function createTimelineBody(departmentData) {
            const body = document.createElement('div');
            body.className = 'space-y-3';
            
            // æ™‚é–“è»¸ãƒ©ãƒ™ãƒ«ã‚’ä½œæˆ
            const timeScale = createTimeScale();
            body.appendChild(timeScale);
            
            // æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆ
            const sortedEntries = Object.entries(departmentData).sort((a, b) => {
                return a[1].date.getTime() - b[1].date.getTime();
            });
            
            sortedEntries.forEach(([displayKey, dayData]) => {
                const dayRow = createDayRow(dayData);
                body.appendChild(dayRow);
            });
            
            return body;
        }

        function createTimeScale() {
            const timeScale = document.createElement('div');
            timeScale.className = 'time-scale';
            
            for (let hour = displayStartHour; hour <= displayEndHour; hour += 2) {
                const timeLabel = document.createElement('div');
                timeLabel.textContent = `${hour.toString().padStart(2, '0')}:00`;
                timeLabel.style.flex = '1';
                timeLabel.style.textAlign = 'center';
                timeScale.appendChild(timeLabel);
            }
            
            return timeScale;
        }

        function createDayRow(dayData) {
            const dayRow = document.createElement('div');
            dayRow.className = 'timeline-day-row';
            
            // æ—¥ä»˜ãƒ˜ãƒƒãƒ€ãƒ¼
            const dayHeader = document.createElement('div');
            dayHeader.className = 'flex justify-between items-center mb-2';
            dayHeader.innerHTML = `
                <div class="font-bold text-sm">
                    ${formatDisplayDate(dayData.date)} (${getJapaneseDayName(dayData.date)})
                </div>
                <div class="text-xs text-gray-600">
                    ${dayData.tasks.length}ä»¶ã®æ¥­å‹™
                </div>
            `;
            dayRow.appendChild(dayHeader);
            
            // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒˆãƒ©ãƒƒã‚¯
            const track = createTimelineTrack(dayData);
            dayRow.appendChild(track);
            
            return dayRow;
        }

        function createTimelineTrack(dayData) {
            const track = document.createElement('div');
            track.className = 'timeline-track';
            track.style.height = Math.max(30, dayData.tasks.length * 26 + 6) + 'px';
            
            const totalMinutes = (displayEndHour - displayStartHour) * 60;
            
            dayData.tasks.forEach((task, taskIdx) => {
                const taskBar = createTaskBar(task, dayData, taskIdx, totalMinutes);
                if (taskBar) {
                    track.appendChild(taskBar);
                }
            });
            
            return track;
        }

        function createTaskBar(task, dayData, taskIdx, totalMinutes) {
            const startMinutes = timeToMinutes(task.startTime);
            const endMinutes = timeToMinutes(task.endTime);
            const displayStartMinutes = displayStartHour * 60;
            const displayEndMinutes = displayEndHour * 60;
            
            // è¡¨ç¤ºç¯„å›²å¤–ã®æ¥­å‹™ã¯ã‚¹ã‚­ãƒƒãƒ—
            if (endMinutes <= displayStartMinutes || startMinutes >= displayEndMinutes) {
                return null;
            }
            
            const adjustedStart = Math.max(startMinutes, displayStartMinutes);
            const adjustedEnd = Math.min(endMinutes, displayEndMinutes);
            
            const left = ((adjustedStart - displayStartMinutes) / totalMinutes) * 100;
            const width = Math.max(2, ((adjustedEnd - adjustedStart) / totalMinutes) * 100);
            
            // ğŸ”§ ã‚¢ã‚µã‚¤ãƒ³æƒ…å ±ã®å–å¾—ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆå…ƒã®ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ¼ã‚’ä½¿ç”¨ï¼‰
            const originalDataKey = dayData.originalDataKey;
            const allTasksForDate = globalTasksData[originalDataKey] || [];
            const originalTaskIndex = allTasksForDate.findIndex(t => 
                t.name === task.name && 
                t.department === task.department && 
                t.startTime === task.startTime && 
                t.endTime === task.endTime
            );
            
            const assignedCEs = originalTaskIndex >= 0 ? 
                (dayData.assignments[originalTaskIndex] || []) : [];
            
            const taskBar = document.createElement('div');
            taskBar.className = 'task-bar';
            taskBar.style.left = left + '%';
            taskBar.style.width = width + '%';
            taskBar.style.top = (taskIdx * 26 + 3) + 'px';
            taskBar.style.backgroundColor = DEPARTMENT_COLORS[task.department];
            taskBar.style.opacity = '0.9';
            
            // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—
            taskBar.title = [
                `æ¥­å‹™: ${task.name}`,
                `æ™‚é–“: ${task.startTime}-${task.endTime}`,
                `ä»¶æ•°: ${task.count || 1}ä»¶`,
                `å¿…è¦äººæ•°: ${task.requiredPeople || 1}å`,
                `é…ç½®CE: ${assignedCEs.join(', ') || 'æœªé…ç½®'}`
            ].join('\n');
            
            // è¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆ
            let displayText = '';
            if (width > 25) {
                const ceText = assignedCEs.length > 0 ? ` | ${assignedCEs.join(',')}` : ' | æœªé…ç½®';
                displayText = `${task.name}${ceText}`;
            } else if (width > 15) {
                displayText = task.name;
            } else if (width > 8) {
                displayText = task.name.substring(0, 3) + '...';
            } else {
                displayText = 'â—';
            }
            
            taskBar.innerHTML = `
                <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding: 0 4px;">
                    ${displayText}
                </span>
            `;
            
            return taskBar;
        }

        // ========== ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ==========
        function timeToMinutes(timeString) {
            if (!timeString || !/^\d{1,2}:\d{2}$/.test(timeString)) return 0;
            const [hours, minutes] = timeString.split(':').map(Number);
            return hours * 60 + minutes;
        }

        // ğŸ”§ æ—¥ä»˜ã‚’ YYYY-MM-DD å½¢å¼ã§è¿”ã™é–¢æ•°
        function formatDateAsISO(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // ğŸ”§ å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ã®é–¢æ•°ï¼ˆæ—¢å­˜ã‚³ãƒ¼ãƒ‰ã¨ã®æ•´åˆæ€§ã‚’ä¿ã¤ï¼‰
        function formatDateKey(date) {
            return getDataKeyForDate(date);
        }

        function formatDisplayDate(date) {
            const month = date.getMonth() + 1;
            const day = date.getDate();
            return `${month}/${day}`;
        }

        function getJapaneseDayName(date) {
            const days = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            return days[date.getDay()];
        }

        function getSelectedDepartments() {
            const checkboxes = document.querySelectorAll('.department-filter:not([value="all"]):checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        function updateAllDepartmentCheckbox() {
            const allCheckbox = document.querySelector('.department-filter[value="all"]');
            const departmentCheckboxes = document.querySelectorAll('.department-filter:not([value="all"])');
            const checkedCount = document.querySelectorAll('.department-filter:not([value="all"]):checked').length;
            
            allCheckbox.checked = checkedCount === departmentCheckboxes.length;
        }

        function showLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
        }

        function showMessage(message, type = 'info') {
            console.log(`${type.toUpperCase()}: ${message}`);
            alert(message);
        }

        // ========== ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ»æ“ä½œé–¢æ•° ==========
        function resetFilters() {
            setCurrentWeekRange();
            document.getElementById('displayStartTime').value = '07:00';
            document.getElementById('displayEndTime').value = '19:00';
            
            document.querySelectorAll('.department-filter').forEach(cb => cb.checked = true);
            
            loadTimelineData();
        }

        // ğŸ”§ ã‚µãƒãƒªãƒ¼æ›´æ–°é–¢æ•°ï¼ˆæŸ”è»Ÿãªã‚­ãƒ¼å¯¾å¿œï¼‰
        function updateSummary() {
            const summaryContent = document.getElementById('summaryContent');
            const selectedDepartments = getSelectedDepartments();
            
            let totalTasks = 0;
            let totalAssigned = 0;
            let totalRequired = 0;
            
            currentDateRange.forEach(date => {
                const dataKey = getDataKeyForDate(date);
                const dayTasks = (globalTasksData[dataKey] || []).filter(task => 
                    selectedDepartments.includes(task.department)
                );
                const dayAssignments = globalAssignmentsData[dataKey] || {};
                
                dayTasks.forEach(task => {
                    const allTasksForDate = globalTasksData[dataKey] || [];
                    const originalTaskIndex = allTasksForDate.findIndex(t => 
                        t.name === task.name && 
                        t.department === task.department && 
                        t.startTime === task.startTime && 
                        t.endTime === task.endTime
                    );
                    
                    totalTasks++;
                    totalRequired += task.requiredPeople || 1;
                    if (originalTaskIndex >= 0) {
                        totalAssigned += (dayAssignments[originalTaskIndex] || []).length;
                    }
                });
            });
            
            const fulfillmentRate = totalRequired > 0 ? Math.round((totalAssigned / totalRequired) * 100) : 0;
            
            summaryContent.innerHTML = `
                <div class="bg-white bg-opacity-70 p-3 rounded-lg text-center">
                    <div class="font-bold text-lg text-blue-600">${currentDateRange.length}</div>
                    <div class="text-xs text-gray-600">è¡¨ç¤ºæ—¥æ•°</div>
                </div>
                <div class="bg-white bg-opacity-70 p-3 rounded-lg text-center">
                    <div class="font-bold text-lg text-green-600">${totalTasks}</div>
                    <div class="text-xs text-gray-600">ç·æ¥­å‹™æ•°</div>
                </div>
                <div class="bg-white bg-opacity-70 p-3 rounded-lg text-center">
                    <div class="font-bold text-lg text-purple-600">${totalAssigned}/${totalRequired}</div>
                    <div class="text-xs text-gray-600">é…ç½®çŠ¶æ³</div>
                </div>
                <div class="bg-white bg-opacity-70 p-3 rounded-lg text-center">
                    <div class="font-bold text-lg ${fulfillmentRate >= 100 ? 'text-green-600' : fulfillmentRate >= 80 ? 'text-yellow-600' : 'text-red-600'}">${fulfillmentRate}%</div>
                    <div class="text-xs text-gray-600">å……è¶³ç‡</div>
                </div>
            `;
            
            console.log(`ğŸ“Š ã‚µãƒãƒªãƒ¼æ›´æ–°: ${totalTasks}ä»¶ã®æ¥­å‹™, ${totalAssigned}/${totalRequired}åé…ç½®, ${fulfillmentRate}%å……è¶³ç‡`);
        }

        function exportTimeline() {
            showMessage('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã¯é–‹ç™ºä¸­ã§ã™', 'info');
        }

        console.log('âœ… æ¥­å‹™åˆ¥ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ V2 èª­ã¿è¾¼ã¿å®Œäº†');
    </script>
</body>
</html>
