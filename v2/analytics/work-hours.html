<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>業務時間分析 - CEスケジュール管理システムV2</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyCRUvvs0OSz_9L9bXtqteVFIIze1OaZObE",
            authDomain: "ce-scheduling-system-v2.firebaseapp.com",
            databaseURL: "https://ce-scheduling-system-v2-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ce-scheduling-system-v2",
            storageBucket: "ce-scheduling-system-v2.firebasestorage.app",
            messagingSenderId: "288279598010",
            appId: "1:288279598010:web:d545ee1d4d854513084383",
            measurementId: "G-LSEEMJE2R0"
        };
        
        const app = initializeApp(firebaseConfig);
        window.database = getDatabase(app);
        window.auth = getAuth(app);
        
        // Anonymous authentication
        signInAnonymously(window.auth).catch(console.error);
    </script>
    
    <style>
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; }
            .bg-gradient-to-br { background: white !important; }
            .shadow-lg { box-shadow: none !important; }
            .page-break { page-break-after: always; }
        }
        
        .hours-chart {
            background: white;
            border-radius: 0.5rem;
            padding: 1rem;
        }
        
        .stats-card {
            transition: transform 0.2s;
        }
        
        .stats-card:hover {
            transform: translateY(-2px);
        }
        
        .employee-card {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        
        .employee-card.normal {
            border-left-color: #10b981;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        }
        
        .employee-card.overtime {
            border-left-color: #f59e0b;
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        }
        
        .employee-card.excessive {
            border-left-color: #ef4444;
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
        }
        
        .hours-gauge {
            position: relative;
            width: 100px;
            height: 100px;
            margin: 0 auto;
        }
        
        .gauge-circle {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(from 180deg, #dcfce7 0deg, #fef3c7 216deg, #fee2e2 324deg, #fee2e2 360deg);
            position: relative;
        }
        
        .gauge-inner {
            position: absolute;
            top: 8px;
            left: 8px;
            width: 84px;
            height: 84px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .compliance-indicator {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .compliant {
            background: #dcfce7;
            color: #166534;
        }
        
        .warning {
            background: #fef3c7;
            color: #92400e;
        }
        
        .violation {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .efficiency-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .efficiency-fill {
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .efficiency-excellent { background: #10b981; }
        .efficiency-good { background: #f59e0b; }
        .efficiency-poor { background: #ef4444; }
        
        .time-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .time-item {
            text-align: center;
            padding: 0.5rem;
            border-radius: 0.5rem;
        }
        
        .time-regular { background: #f0f9ff; color: #0369a1; }
        .time-overtime { background: #fffbeb; color: #92400e; }
        .time-night { background: #f3f4f6; color: #374151; }
        .time-holiday { background: #fef2f2; color: #991b1b; }
        
        .alert-pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-cyan-50 to-blue-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b no-print">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <i class="fas fa-clock text-2xl text-cyan-600"></i>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">業務時間分析</h1>
                        <p class="text-sm text-gray-600">CEスケジュール管理システムV2</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2 text-sm text-gray-600">
                        <i class="fas fa-user-circle"></i>
                        <span id="currentUser">読み込み中...</span>
                    </div>
                    <button onclick="window.location.href='../dashboard.html'" 
        class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg text-gray-700 transition-colors">
    <i class="fas fa-arrow-left mr-2"></i>ダッシュボードに戻る
</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Compliance Alert Banner -->
    <div id="complianceAlert" class="bg-red-500 text-white px-4 py-2 no-print hidden">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                <span id="complianceMessage">労働基準法違反の可能性があります</span>
            </div>
            <button onclick="hideComplianceAlert()" class="text-white hover:text-red-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Filter Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6 no-print">
            <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-filter mr-2 text-cyan-600"></i>分析設定
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Date Range -->
                <div>
                    <label for="startDate" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-calendar-alt mr-1"></i>開始日
                    </label>
                    <input type="date" id="startDate" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500">
                </div>
                
                <div>
                    <label for="endDate" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-calendar-alt mr-1"></i>終了日
                    </label>
                    <input type="date" id="endDate" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500">
                </div>
                
                <!-- Department Filter -->
                <div>
                    <label for="departmentFilter" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-building mr-1"></i>部門フィルター
                    </label>
                    <select id="departmentFilter" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500">
                        <option value="">すべての部門</option>
                    </select>
                </div>
                
                <!-- Analysis View -->
                <div>
                    <label for="analysisView" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-chart-bar mr-1"></i>表示タイプ
                    </label>
                    <select id="analysisView" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500">
                        <option value="individual">個人別分析</option>
                        <option value="department">部門別分析</option>
                        <option value="compliance">法令遵守分析</option>
                        <option value="efficiency">効率性分析</option>
                    </select>
                </div>
            </div>
            
            <div class="flex flex-wrap gap-2 mt-4">
                <button onclick="analyzeWorkHours()" 
                        class="bg-cyan-600 hover:bg-cyan-700 text-white px-4 py-2 rounded-lg transition-colors">
                    <i class="fas fa-chart-line mr-2"></i>時間分析実行
                </button>
                <button onclick="resetAnalysis()" 
                        class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                    <i class="fas fa-undo mr-2"></i>リセット
                </button>
                <button onclick="exportWorkHoursReport()" 
                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                    <i class="fas fa-file-csv mr-2"></i>データ出力
                </button>
                <button onclick="window.print()" 
                        class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors">
                    <i class="fas fa-print mr-2"></i>印刷
                </button>
            </div>
        </div>

        <!-- Summary Statistics -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
            <div class="stats-card bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">総労働時間</p>
                        <p class="text-2xl font-bold text-cyan-600" id="totalWorkHours">0時間</p>
                    </div>
                    <div class="bg-cyan-100 p-3 rounded-full">
                        <i class="fas fa-clock text-cyan-600 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="stats-card bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">平均残業時間</p>
                        <p class="text-2xl font-bold text-yellow-600" id="avgOvertimeHours">0時間</p>
                    </div>
                    <div class="bg-yellow-100 p-3 rounded-full">
                        <i class="fas fa-user-clock text-yellow-600 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="stats-card bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">法令遵守率</p>
                        <p class="text-2xl font-bold text-green-600" id="complianceRate">0%</p>
                    </div>
                    <div class="bg-green-100 p-3 rounded-full">
                        <i class="fas fa-shield-alt text-green-600 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="stats-card bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">効率性スコア</p>
                        <p class="text-2xl font-bold text-purple-600" id="efficiencyScore">0点</p>
                    </div>
                    <div class="bg-purple-100 p-3 rounded-full">
                        <i class="fas fa-trophy text-purple-600 text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Individual Analysis -->
        <div class="mb-6" id="individualAnalysis">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-user mr-2 text-cyan-600"></i>個人別労働時間分析
            </h3>
            <div id="employeeCards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Dynamic employee cards will be inserted here -->
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Work Hours Distribution -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-chart-pie mr-2 text-cyan-600"></i>労働時間分布
                </h3>
                <canvas id="hoursDistributionChart" style="height: 300px;"></canvas>
            </div>
            
            <!-- Daily Trend Chart -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-chart-line mr-2 text-cyan-600"></i>日別労働時間推移
                </h3>
                <canvas id="dailyTrendChart" style="height: 300px;"></canvas>
            </div>
        </div>

        <!-- Department Comparison -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-building mr-2 text-cyan-600"></i>部門別労働時間比較
            </h3>
            <canvas id="departmentComparisonChart" style="height: 400px;"></canvas>
        </div>

        <!-- Overtime Analysis -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6 page-break">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-exclamation-triangle mr-2 text-cyan-600"></i>残業時間分析
                </h3>
                <canvas id="overtimeChart" style="height: 300px;"></canvas>
            </div>
            
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-calendar-week mr-2 text-cyan-600"></i>週別労働パターン
                </h3>
                <canvas id="weeklyPatternChart" style="height: 300px;"></canvas>
            </div>
        </div>

        <!-- Compliance Analysis -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-gavel mr-2 text-cyan-600"></i>労働基準法遵守状況
            </h3>
            <div id="complianceAnalysis" class="space-y-4">
                <!-- Dynamic compliance cards will be inserted here -->
            </div>
        </div>

        <!-- Detailed Table -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-table mr-2 text-cyan-600"></i>詳細労働時間テーブル
            </h3>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">従業員</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">部門</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">通常時間</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">残業時間</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">総労働時間</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">遵守状況</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">効率性</th>
                        </tr>
                    </thead>
                    <tbody id="workHoursTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Dynamic table rows will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Recommendations -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-lightbulb mr-2 text-cyan-600"></i>労働時間最適化提案
            </h3>
            <div id="workHoursRecommendations" class="space-y-3">
                <!-- Dynamic recommendations will be inserted here -->
            </div>
        </div>
    </main>

    <!-- Loading Modal -->
    <div id="loadingModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4">
            <div class="flex items-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-cyan-600 mr-4"></div>
                <span class="text-gray-700">労働時間を分析中...</span>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let hoursDistributionChart = null;
        let dailyTrendChart = null;
        let departmentComparisonChart = null;
        let overtimeChart = null;
        let weeklyPatternChart = null;
        let allSchedules = [];
        let allEmployees = [];
        let allDepartments = [];
        
        // Labor standards constants
        const STANDARD_WORK_HOURS_PER_DAY = 8;
        const STANDARD_WORK_HOURS_PER_WEEK = 40;
        const MAX_OVERTIME_PER_MONTH = 45; // 36協定基準
        const NIGHT_SHIFT_START = 22;
        const NIGHT_SHIFT_END = 5;
        
        // Authentication check
       function checkAuth() {
            let user = sessionStorage.getItem('currentUser') || sessionStorage.getItem('currentUsername');

            // URLパラメータから取得
            if (!user) {
                const params = new URLSearchParams(location.search);
                const qpUser = params.get('user') || params.get('username');
                const qpUid = params.get('uid');
                const qpRole = params.get('role');
                if (qpUser) {
                    user = qpUser;
                    try {
                        sessionStorage.setItem('currentUser', qpUser);
                        sessionStorage.setItem('currentUsername', qpUser);
                        if (qpUid) sessionStorage.setItem('targetUID', qpUid);
                        if (qpRole) sessionStorage.setItem('userRole', qpRole);
                    } catch (e) {
                        console.warn('sessionStorage保存エラー:', e);
                    }
                }
            }

            // localStorageから取得
            if (!user) {
                try {
                    const authData = localStorage.getItem('analyticsAuth');
                    if (authData) {
                        const parsed = JSON.parse(authData);
                        if (Date.now() - parsed.timestamp < 5 * 60 * 1000) {
                            user = parsed.displayName;
                            sessionStorage.setItem('currentUser', parsed.displayName);
                            sessionStorage.setItem('currentUsername', parsed.username);
                            sessionStorage.setItem('targetUID', parsed.uid);
                            sessionStorage.setItem('userRole', parsed.role);
                        }
                    }
                } catch (e) {
                    console.warn('localStorage読み込みエラー:', e);
                }
            }

            if (!user) {
                alert('認証が必要です。ダッシュボードからアクセスしてください。');
                window.location.href = '../dashboard.html';
                return false;
            }

            const headerUserEl = document.getElementById('currentUser');
            if (headerUserEl) headerUserEl.textContent = user;
            return true;
        }
        
        // Initialize application
        async function init() {
            if (!checkAuth()) return;
            
            showLoading(true);
            
            try {
                await Promise.all([
                    loadEmployees(),
                    loadDepartments(),
                    loadSchedules()
                ]);
                
                setupDateInputs();
                populateDepartmentFilter();
                initializeCharts();
            } catch (error) {
                console.error('初期化エラー:', error);
                alert('データの読み込みに失敗しました。ページをリロードしてください。');
            } finally {
                showLoading(false);
            }
        }
        
        // Load data functions
        async function loadEmployees() {
            try {
                const { ref, get } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js');
                const snapshot = await get(ref(window.database, 'employees'));
                
                if (snapshot.exists()) {
                    allEmployees = Object.entries(snapshot.val()).map(([id, data]) => ({
                        id,
                        ...data
                    }));
                }
            } catch (error) {
                console.error('従業員データの読み込みエラー:', error);
            }
        }
        
        async function loadDepartments() {
            try {
                const { ref, get } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js');
                const snapshot = await get(ref(window.database, 'departments'));
                
                if (snapshot.exists()) {
                    allDepartments = Object.entries(snapshot.val()).map(([id, data]) => ({
                        id,
                        ...data
                    }));
                }
            } catch (error) {
                console.error('部門データの読み込みエラー:', error);
            }
        }
        
        async function loadSchedules() {
            try {
                const { ref, get } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js');
                const snapshot = await get(ref(window.database, 'schedules'));
                
                if (snapshot.exists()) {
                    allSchedules = Object.entries(snapshot.val()).map(([id, data]) => ({
                        id,
                        ...data
                    }));
                }
            } catch (error) {
                console.error('スケジュールデータの読み込みエラー:', error);
            }
        }
        
        // Setup functions
        function setupDateInputs() {
            const startDate = document.getElementById('startDate');
            const endDate = document.getElementById('endDate');
            const today = new Date();
            const oneWeekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            startDate.value = oneWeekAgo.toISOString().split('T')[0];
            endDate.value = today.toISOString().split('T')[0];
        }
        
        function populateDepartmentFilter() {
            const select = document.getElementById('departmentFilter');
            select.innerHTML = '<option value="">すべての部門</option>';
            
            allDepartments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept.id;
                option.textContent = dept.name;
                select.appendChild(option);
            });
        }
        
        function showLoading(show) {
            const modal = document.getElementById('loadingModal');
            if (show) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            } else {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }
        
        // Initialize charts
        function initializeCharts() {
            initializeHoursDistributionChart();
            initializeDailyTrendChart();
            initializeDepartmentComparisonChart();
            initializeOvertimeChart();
            initializeWeeklyPatternChart();
        }
        
        function initializeHoursDistributionChart() {
            const ctx = document.getElementById('hoursDistributionChart').getContext('2d');
            
            hoursDistributionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['通常勤務', '残業', '深夜勤務', '休日出勤'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: ['#10B981', '#F59E0B', '#6366F1', '#EF4444']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${label}: ${value.toFixed(1)}時間 (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function initializeDailyTrendChart() {
            const ctx = document.getElementById('dailyTrendChart').getContext('2d');
            
            dailyTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: '総労働時間',
                            data: [],
                            borderColor: '#06B6D4',
                            backgroundColor: 'rgba(6, 182, 212, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: '残業時間',
                            data: [],
                            borderColor: '#F59E0B',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            fill: false,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '時間'
                            }
                        }
                    }
                }
            });
        }
        
        function initializeDepartmentComparisonChart() {
            const ctx = document.getElementById('departmentComparisonChart').getContext('2d');
            
            departmentComparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: '通常勤務時間',
                            data: [],
                            backgroundColor: '#10B981',
                            stack: 'Stack 0'
                        },
                        {
                            label: '残業時間',
                            data: [],
                            backgroundColor: '#F59E0B',
                            stack: 'Stack 0'
                        },
                        {
                            label: '深夜勤務時間',
                            data: [],
                            backgroundColor: '#6366F1',
                            stack: 'Stack 0'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '時間'
                            }
                        }
                    }
                }
            });
        }
        
        function initializeOvertimeChart() {
            const ctx = document.getElementById('overtimeChart').getContext('2d');
            
            overtimeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: '残業時間',
                        data: [],
                        backgroundColor: function(context) {
                            const value = context.parsed.y;
                            return value > MAX_OVERTIME_PER_MONTH ? '#EF4444' : 
                                   value > MAX_OVERTIME_PER_MONTH * 0.8 ? '#F59E0B' : '#10B981';
                        },
                        borderColor: '#374151',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '時間'
                            },
                            plugins: {
                                annotation: {
                                    annotations: {
                                        line1: {
                                            type: 'line',
                                            yMin: MAX_OVERTIME_PER_MONTH,
                                            yMax: MAX_OVERTIME_PER_MONTH,
                                            borderColor: 'red',
                                            borderWidth: 2,
                                            label: {
                                                content: '法定上限',
                                                enabled: true
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function initializeWeeklyPatternChart() {
            const ctx = document.getElementById('weeklyPatternChart').getContext('2d');
            
            weeklyPatternChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['月曜日', '火曜日', '水曜日', '木曜日', '金曜日', '土曜日', '日曜日'],
                    datasets: [{
                        label: '平均労働時間',
                        data: new Array(7).fill(0),
                        backgroundColor: 'rgba(6, 182, 212, 0.2)',
                        borderColor: '#06B6D4',
                        pointBackgroundColor: '#06B6D4'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 12,
                            title: {
                                display: true,
                                text: '時間'
                            }
                        }
                    }
                }
            });
        }
        
        // Analyze work hours
        function analyzeWorkHours() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const departmentFilter = document.getElementById('departmentFilter').value;
            const analysisView = document.getElementById('analysisView').value;
            
            if (!startDate || !endDate) {
                alert('期間を指定してください。');
                return;
            }
            
            showLoading(true);
            
            try {
                const filteredSchedules = filterSchedules(startDate, endDate, departmentFilter);
                const workHoursData = calculateWorkHoursData(filteredSchedules);
                
                updateSummaryStats(workHoursData);
                updateEmployeeCards(workHoursData, analysisView);
                updateAllCharts(workHoursData, filteredSchedules);
                updateComplianceAnalysis(workHoursData);
                updateWorkHoursTable(workHoursData);
                updateWorkHoursRecommendations(workHoursData);
                checkComplianceAlerts(workHoursData);
            } catch (error) {
                console.error('労働時間分析エラー:', error);
                alert('分析中にエラーが発生しました。');
            } finally {
                showLoading(false);
            }
        }
        
        // Filter schedules
        function filterSchedules(startDate, endDate, departmentFilter) {
            return allSchedules.filter(schedule => {
                if (schedule.date < startDate || schedule.date > endDate) return false;
                
                if (departmentFilter) {
                    const employee = allEmployees.find(e => e.id === schedule.employeeId);
                    if (!employee || employee.departmentId !== departmentFilter) return false;
                }
                
                return true;
            });
        }
        
        // Calculate work hours data
        function calculateWorkHoursData(schedules) {
            const employeeData = {};
            
            // Initialize employee data
            allEmployees.forEach(employee => {
                employeeData[employee.id] = {
                    ...employee,
                    regularHours: 0,
                    overtimeHours: 0,
                    nightHours: 0,
                    holidayHours: 0,
                    totalHours: 0,
                    workDays: new Set(),
                    scheduleCount: 0
                };
            });
            
            // Calculate hours for each schedule
            schedules.forEach(schedule => {
                if (!employeeData[schedule.employeeId]) return;
                
                const employee = employeeData[schedule.employeeId];
                const workHours = calculateDetailedWorkHours(schedule);
                
                employee.regularHours += workHours.regular;
                employee.overtimeHours += workHours.overtime;
                employee.nightHours += workHours.night;
                employee.holidayHours += workHours.holiday;
                employee.totalHours += workHours.total;
                employee.workDays.add(schedule.date);
                employee.scheduleCount++;
            });
            
            // Calculate derived metrics
            Object.values(employeeData).forEach(employee => {
                employee.avgHoursPerDay = employee.workDays.size > 0 ? 
                    employee.totalHours / employee.workDays.size : 0;
                employee.complianceStatus = calculateComplianceStatus(employee);
                employee.efficiencyScore = calculateEfficiencyScore(employee);
            });
            
            return employeeData;
        }
        
        // Calculate detailed work hours
        function calculateDetailedWorkHours(schedule) {
            const startTime = parseTime(schedule.startTime);
            const endTime = parseTime(schedule.endTime);
            let totalMinutes = endTime - startTime;
            
            // Handle overnight shifts
            if (totalMinutes < 0) {
                totalMinutes += 24 * 60;
            }
            
            const totalHours = totalMinutes / 60;
            const isHoliday = isHolidayDate(schedule.date);
            const nightHours = calculateNightHours(schedule.startTime, schedule.endTime);
            
            let regularHours = 0;
            let overtimeHours = 0;
            let holidayHours = 0;
            
            if (isHoliday) {
                holidayHours = totalHours;
            } else {
                regularHours = Math.min(totalHours, STANDARD_WORK_HOURS_PER_DAY);
                overtimeHours = Math.max(0, totalHours - STANDARD_WORK_HOURS_PER_DAY);
            }
            
            return {
                total: totalHours,
                regular: regularHours,
                overtime: overtimeHours,
                night: nightHours,
                holiday: holidayHours
            };
        }
        
        // Parse time string to minutes
        function parseTime(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }
        
        // Check if date is holiday
        function isHolidayDate(dateStr) {
            const date = new Date(dateStr);
            const dayOfWeek = date.getDay();
            return dayOfWeek === 0 || dayOfWeek === 6; // Sunday or Saturday
        }
        
        // Calculate night shift hours
        function calculateNightHours(startTime, endTime) {
            const start = parseTime(startTime);
            const end = parseTime(endTime);
            
            let nightMinutes = 0;
            let currentTime = start;
            const endTime24 = end < start ? end + 24 * 60 : end;
            
            while (currentTime < endTime24) {
                const hour = Math.floor((currentTime % (24 * 60)) / 60);
                if (hour >= NIGHT_SHIFT_START || hour < NIGHT_SHIFT_END) {
                    nightMinutes++;
                }
                currentTime++;
            }
            
            return nightMinutes / 60;
        }
        
        // Calculate compliance status
        function calculateComplianceStatus(employee) {
            const weeklyHours = employee.totalHours;
            const monthlyOvertime = employee.overtimeHours;
            
            if (monthlyOvertime > MAX_OVERTIME_PER_MONTH) {
                return { status: 'violation', message: '残業時間上限超過' };
            } else if (weeklyHours > STANDARD_WORK_HOURS_PER_WEEK * 1.5) {
                return { status: 'warning', message: '週労働時間過多' };
            } else {
                return { status: 'compliant', message: '法令遵守' };
            }
        }
        
        // Calculate efficiency score
        function calculateEfficiencyScore(employee) {
            const optimalHours = employee.workDays.size * STANDARD_WORK_HOURS_PER_DAY;
            const actualHours = employee.totalHours;
            
            if (optimalHours === 0) return 0;
            
            const efficiency = Math.min(100, (optimalHours / actualHours) * 100);
            return Math.round(efficiency);
        }
        
        // Update summary statistics
        function updateSummaryStats(workHoursData) {
            const employees = Object.values(workHoursData).filter(emp => emp.totalHours > 0);
            
            const totalHours = employees.reduce((sum, emp) => sum + emp.totalHours, 0);
            const avgOvertime = employees.length > 0 ? 
                employees.reduce((sum, emp) => sum + emp.overtimeHours, 0) / employees.length : 0;
            const complianceRate = employees.length > 0 ? 
                (employees.filter(emp => emp.complianceStatus.status === 'compliant').length / employees.length) * 100 : 100;
            const avgEfficiency = employees.length > 0 ? 
                employees.reduce((sum, emp) => sum + emp.efficiencyScore, 0) / employees.length : 0;
            
            document.getElementById('totalWorkHours').textContent = `${totalHours.toFixed(1)}時間`;
            document.getElementById('avgOvertimeHours').textContent = `${avgOvertime.toFixed(1)}時間`;
            document.getElementById('complianceRate').textContent = `${complianceRate.toFixed(1)}%`;
            document.getElementById('efficiencyScore').textContent = `${avgEfficiency.toFixed(0)}点`;
        }
        
        // Update employee cards
        function updateEmployeeCards(workHoursData, analysisView) {
            const container = document.getElementById('employeeCards');
            container.innerHTML = '';
            
            const employees = Object.values(workHoursData)
                .filter(emp => emp.totalHours > 0)
                .sort((a, b) => b.totalHours - a.totalHours);
            
            employees.forEach(employee => {
                const cardClass = employee.complianceStatus.status === 'violation' ? 'excessive' :
                                 employee.complianceStatus.status === 'warning' ? 'overtime' : 'normal';
                
                const card = document.createElement('div');
                card.className = `employee-card bg-white rounded-lg shadow-lg p-6 ${cardClass}`;
                card.innerHTML = `
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-lg font-semibold text-gray-900">${employee.name}</h4>
                        <span class="compliance-indicator ${employee.complianceStatus.status}">
                            ${employee.complianceStatus.message}
                        </span>
                    </div>
                    
                    <div class="hours-gauge mb-4">
                        <div class="gauge-circle">
                            <div class="gauge-inner">
                                <span class="${employee.totalHours > STANDARD_WORK_HOURS_PER_WEEK ? 'text-red-600' : 'text-green-600'}">
                                    ${employee.totalHours.toFixed(1)}h
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="time-breakdown">
                        <div class="time-item time-regular">
                            <div class="text-sm font-medium">通常</div>
                            <div class="text-lg font-bold">${employee.regularHours.toFixed(1)}h</div>
                        </div>
                        <div class="time-item time-overtime">
                            <div class="text-sm font-medium">残業</div>
                            <div class="text-lg font-bold">${employee.overtimeHours.toFixed(1)}h</div>
                        </div>
                        <div class="time-item time-night">
                            <div class="text-sm font-medium">深夜</div>
                            <div class="text-lg font-bold">${employee.nightHours.toFixed(1)}h</div>
                        </div>
                        <div class="time-item time-holiday">
                            <div class="text-sm font-medium">休日</div>
                            <div class="text-lg font-bold">${employee.holidayHours.toFixed(1)}h</div>
                        </div>
                    </div>
                    
                    <div class="mt-4 space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">効率性スコア</span>
                            <span class="font-medium">${employee.efficiencyScore}点</span>
                        </div>
                        <div class="efficiency-bar">
                            <div class="efficiency-fill ${employee.efficiencyScore >= 80 ? 'efficiency-excellent' : 
                                                         employee.efficiencyScore >= 60 ? 'efficiency-good' : 'efficiency-poor'}" 
                                 style="width: ${employee.efficiencyScore}%"></div>
                        </div>
                        <div class="text-xs text-gray-500">
                            ${employee.workDays.size}日勤務 / 平均${employee.avgHoursPerDay.toFixed(1)}時間/日
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        // Update all charts
        function updateAllCharts(workHoursData, schedules) {
            updateHoursDistributionChart(workHoursData);
            updateDailyTrendChart(schedules);
            updateDepartmentComparisonChart(workHoursData);
            updateOvertimeChart(workHoursData);
            updateWeeklyPatternChart(schedules);
        }
        
        // Update hours distribution chart
        function updateHoursDistributionChart(workHoursData) {
            const employees = Object.values(workHoursData).filter(emp => emp.totalHours > 0);
            
            const totals = {
                regular: employees.reduce((sum, emp) => sum + emp.regularHours, 0),
                overtime: employees.reduce((sum, emp) => sum + emp.overtimeHours, 0),
                night: employees.reduce((sum, emp) => sum + emp.nightHours, 0),
                holiday: employees.reduce((sum, emp) => sum + emp.holidayHours, 0)
            };
            
            hoursDistributionChart.data.datasets[0].data = [
                totals.regular, totals.overtime, totals.night, totals.holiday
            ];
            hoursDistributionChart.update();
        }
        
        // Update daily trend chart
        function updateDailyTrendChart(schedules) {
            const dailyData = {};
            
            schedules.forEach(schedule => {
                const date = schedule.date;
                if (!dailyData[date]) {
                    dailyData[date] = { total: 0, overtime: 0 };
                }
                
                const workHours = calculateDetailedWorkHours(schedule);
                dailyData[date].total += workHours.total;
                dailyData[date].overtime += workHours.overtime;
            });
            
            const dates = Object.keys(dailyData).sort();
            const totalHours = dates.map(date => dailyData[date].total);
            const overtimeHours = dates.map(date => dailyData[date].overtime);
            
            dailyTrendChart.data.labels = dates;
            dailyTrendChart.data.datasets[0].data = totalHours;
            dailyTrendChart.data.datasets[1].data = overtimeHours;
            dailyTrendChart.update();
        }
        
        // Update department comparison chart
        function updateDepartmentComparisonChart(workHoursData) {
            const deptData = {};
            
            Object.values(workHoursData).forEach(employee => {
                if (employee.totalHours === 0) return;
                
                const dept = allDepartments.find(d => d.id === employee.departmentId);
                const deptName = dept?.name || '不明';
                
                if (!deptData[deptName]) {
                    deptData[deptName] = { regular: 0, overtime: 0, night: 0 };
                }
                
                deptData[deptName].regular += employee.regularHours;
                deptData[deptName].overtime += employee.overtimeHours;
                deptData[deptName].night += employee.nightHours;
            });
            
            const labels = Object.keys(deptData);
            const regularData = labels.map(dept => deptData[dept].regular);
            const overtimeData = labels.map(dept => deptData[dept].overtime);
            const nightData = labels.map(dept => deptData[dept].night);
            
            departmentComparisonChart.data.labels = labels;
            departmentComparisonChart.data.datasets[0].data = regularData;
            departmentComparisonChart.data.datasets[1].data = overtimeData;
            departmentComparisonChart.data.datasets[2].data = nightData;
            departmentComparisonChart.update();
        }
        
        // Update overtime chart
        function updateOvertimeChart(workHoursData) {
            const employees = Object.values(workHoursData)
                .filter(emp => emp.overtimeHours > 0)
                .sort((a, b) => b.overtimeHours - a.overtimeHours)
                .slice(0, 10); // Top 10
            
            const labels = employees.map(emp => emp.name);
            const overtimeData = employees.map(emp => emp.overtimeHours);
            
            overtimeChart.data.labels = labels;
            overtimeChart.data.datasets[0].data = overtimeData;
            overtimeChart.update();
        }
        
        // Update weekly pattern chart
        function updateWeeklyPatternChart(schedules) {
            const weeklyData = new Array(7).fill(0);
            const weeklyCounts = new Array(7).fill(0);
            
            schedules.forEach(schedule => {
                const date = new Date(schedule.date);
                const dayOfWeek = date.getDay();
                const mondayIndex = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Convert to Monday=0
                
                const workHours = calculateDetailedWorkHours(schedule);
                weeklyData[mondayIndex] += workHours.total;
                weeklyCounts[mondayIndex]++;
            });
            
            // Calculate averages
            const avgWeeklyData = weeklyData.map((total, index) => 
                weeklyCounts[index] > 0 ? total / weeklyCounts[index] : 0
            );
            
            weeklyPatternChart.data.datasets[0].data = avgWeeklyData;
            weeklyPatternChart.update();
        }
        
        // Update compliance analysis
        function updateComplianceAnalysis(workHoursData) {
            const container = document.getElementById('complianceAnalysis');
            container.innerHTML = '';
            
            const employees = Object.values(workHoursData).filter(emp => emp.totalHours > 0);
            const violations = employees.filter(emp => emp.complianceStatus.status === 'violation');
            const warnings = employees.filter(emp => emp.complianceStatus.status === 'warning');
            const compliant = employees.filter(emp => emp.complianceStatus.status === 'compliant');
            
            const complianceCards = [
                {
                    title: '法令違反',
                    count: violations.length,
                    color: 'red',
                    icon: 'fa-exclamation-triangle',
                    description: '残業時間上限を超過している従業員'
                },
                {
                    title: '要注意',
                    count: warnings.length,
                    color: 'yellow',
                    icon: 'fa-exclamation-circle',
                    description: '労働時間が過多な従業員'
                },
                {
                    title: '遵守',
                    count: compliant.length,
                    color: 'green',
                    icon: 'fa-check-circle',
                    description: '適正な労働時間の従業員'
                }
            ];
            
            complianceCards.forEach(card => {
                const cardElement = document.createElement('div');
                cardElement.className = `bg-${card.color}-50 border border-${card.color}-200 rounded-lg p-4`;
                cardElement.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="bg-${card.color}-100 p-2 rounded-full mr-3">
                                <i class="fas ${card.icon} text-${card.color}-600"></i>
                            </div>
                            <div>
                                <h4 class="font-semibold text-${card.color}-800">${card.title}</h4>
                                <p class="text-sm text-${card.color}-600">${card.description}</p>
                            </div>
                        </div>
                        <span class="text-2xl font-bold text-${card.color}-600">${card.count}</span>
                    </div>
                `;
                container.appendChild(cardElement);
            });
        }
        
        // Update work hours table
        function updateWorkHoursTable(workHoursData) {
            const tbody = document.getElementById('workHoursTableBody');
            tbody.innerHTML = '';
            
            const employees = Object.values(workHoursData)
                .filter(emp => emp.totalHours > 0)
                .sort((a, b) => b.totalHours - a.totalHours);
            
            employees.forEach(employee => {
                const dept = allDepartments.find(d => d.id === employee.departmentId);
                const complianceClass = employee.complianceStatus.status === 'violation' ? 'text-red-600' :
                                      employee.complianceStatus.status === 'warning' ? 'text-yellow-600' : 'text-green-600';
                const efficiencyClass = employee.efficiencyScore >= 80 ? 'text-green-600' :
                                       employee.efficiencyScore >= 60 ? 'text-yellow-600' : 'text-red-600';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${employee.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${dept?.name || '不明'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${employee.regularHours.toFixed(1)}時間</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${employee.overtimeHours.toFixed(1)}時間</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">${employee.totalHours.toFixed(1)}時間</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${complianceClass}">${employee.complianceStatus.message}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${efficiencyClass}">${employee.efficiencyScore}点</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Update recommendations
        function updateWorkHoursRecommendations(workHoursData) {
            const container = document.getElementById('workHoursRecommendations');
            container.innerHTML = '';
            
            const employees = Object.values(workHoursData).filter(emp => emp.totalHours > 0);
            const recommendations = [];
            
            // Check for violations
            const violations = employees.filter(emp => emp.complianceStatus.status === 'violation');
            if (violations.length > 0) {
                recommendations.push({
                    type: 'error',
                    icon: 'fas fa-exclamation-triangle text-red-600',
                    title: '緊急対応必要',
                    message: `${violations.length}名の従業員が法定残業時間を超過しています。直ちに労働時間の見直しが必要です。`
                });
            }
            
            // Check for high overtime
            const highOvertime = employees.filter(emp => emp.overtimeHours > MAX_OVERTIME_PER_MONTH * 0.8);
            if (highOvertime.length > 0) {
                recommendations.push({
                    type: 'warning',
                    icon: 'fas fa-clock text-yellow-600',
                    title: '労働時間管理の改善',
                    message: `${highOvertime.length}名の従業員の残業時間が上限に近づいています。業務配分の見直しを推奨します。`
                });
            }
            
            // Check for low efficiency
            const lowEfficiency = employees.filter(emp => emp.efficiencyScore < 60);
            if (lowEfficiency.length > 0) {
                recommendations.push({
                    type: 'info',
                    icon: 'fas fa-chart-line text-blue-600',
                    title: '効率性向上の機会',
                    message: `${lowEfficiency.length}名の従業員の労働効率に改善の余地があります。業務プロセスの見直しを検討してください。`
                });
            }
            
            if (recommendations.length === 0) {
                recommendations.push({
                    type: 'success',
                    icon: 'fas fa-check-circle text-green-600',
                    title: '良好な労働時間管理',
                    message: 'すべての従業員が適正な労働時間で業務を行っています。'
                });
            }
            
            recommendations.forEach(rec => {
                const item = document.createElement('div');
                item.className = `flex items-start space-x-3 p-4 rounded-lg ${
                    rec.type === 'error' ? 'bg-red-50' :
                    rec.type === 'warning' ? 'bg-yellow-50' :
                    rec.type === 'info' ? 'bg-blue-50' : 'bg-green-50'
                }`;
                item.innerHTML = `
                    <i class="${rec.icon} mt-1"></i>
                    <div>
                        <h4 class="font-medium text-gray-900">${rec.title}</h4>
                        <p class="text-sm text-gray-600 mt-1">${rec.message}</p>
                    </div>
                `;
                container.appendChild(item);
            });
        }
        
        // Check compliance alerts
        function checkComplianceAlerts(workHoursData) {
            const violations = Object.values(workHoursData).filter(emp => 
                emp.complianceStatus.status === 'violation'
            );
            
            if (violations.length > 0) {
                const alertBanner = document.getElementById('complianceAlert');
                const alertMessage = document.getElementById('complianceMessage');
                
                alertMessage.textContent = `${violations.length}名の従業員が労働基準法に違反しています`;
                alertBanner.classList.remove('hidden');
            }
        }
        
        // Hide compliance alert
        function hideComplianceAlert() {
            document.getElementById('complianceAlert').classList.add('hidden');
        }
        
        // Reset analysis
        function resetAnalysis() {
            document.getElementById('departmentFilter').value = '';
            document.getElementById('analysisView').value = 'individual';
            setupDateInputs();
            
            // Clear statistics
            document.getElementById('totalWorkHours').textContent = '0時間';
            document.getElementById('avgOvertimeHours').textContent = '0時間';
            document.getElementById('complianceRate').textContent = '0%';
            document.getElementById('efficiencyScore').textContent = '0点';
            
            // Clear charts
            if (hoursDistributionChart) {
                hoursDistributionChart.data.datasets[0].data = [0, 0, 0, 0];
                hoursDistributionChart.update();
            }
            
            if (dailyTrendChart) {
                dailyTrendChart.data.labels = [];
                dailyTrendChart.data.datasets[0].data = [];
                dailyTrendChart.data.datasets[1].data = [];
                dailyTrendChart.update();
            }
            
            if (departmentComparisonChart) {
                departmentComparisonChart.data.labels = [];
                departmentComparisonChart.data.datasets.forEach(dataset => {
                    dataset.data = [];
                });
                departmentComparisonChart.update();
            }
            
            if (overtimeChart) {
                overtimeChart.data.labels = [];
                overtimeChart.data.datasets[0].data = [];
                overtimeChart.update();
            }
            
            if (weeklyPatternChart) {
                weeklyPatternChart.data.datasets[0].data = new Array(7).fill(0);
                weeklyPatternChart.update();
            }
            
            // Clear other displays
            document.getElementById('employeeCards').innerHTML = '';
            document.getElementById('complianceAnalysis').innerHTML = '';
            document.getElementById('workHoursTableBody').innerHTML = '';
            document.getElementById('workHoursRecommendations').innerHTML = '';
            hideComplianceAlert();
        }
        
        // Export work hours report
        function exportWorkHoursReport() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                alert('期間を指定してから出力してください。');
                return;
            }
            
            const departmentFilter = document.getElementById('departmentFilter').value;
            const filteredSchedules = filterSchedules(startDate, endDate, departmentFilter);
            const workHoursData = calculateWorkHoursData(filteredSchedules);
            
            // Create CSV content
            let csvContent = '\uFEFF'; // BOM for UTF-8
            csvContent += '業務時間分析レポート\n';
            csvContent += `分析期間: ${startDate} - ${endDate}\n`;
            csvContent += `部門フィルター: ${departmentFilter ? allDepartments.find(d => d.id === departmentFilter)?.name || '不明' : 'すべて'}\n`;
            csvContent += `生成日時: ${new Date().toLocaleString('ja-JP')}\n\n`;
            
            // Summary statistics
            const employees = Object.values(workHoursData).filter(emp => emp.totalHours > 0);
            const totalHours = employees.reduce((sum, emp) => sum + emp.totalHours, 0);
            const avgOvertime = employees.length > 0 ? 
                employees.reduce((sum, emp) => sum + emp.overtimeHours, 0) / employees.length : 0;
            const complianceRate = employees.length > 0 ? 
                (employees.filter(emp => emp.complianceStatus.status === 'compliant').length / employees.length) * 100 : 100;
            
            csvContent += '概要統計\n';
            csvContent += `総労働時間,${totalHours.toFixed(1)}時間\n`;
            csvContent += `平均残業時間,${avgOvertime.toFixed(1)}時間\n`;
            csvContent += `法令遵守率,${complianceRate.toFixed(1)}%\n\n`;
            
            // Individual data
            csvContent += '個人別詳細\n';
            csvContent += '従業員名,部門,通常勤務時間,残業時間,深夜勤務時間,休日出勤時間,総労働時間,遵守状況,効率性スコア\n';
            
            employees.forEach(employee => {
                const dept = allDepartments.find(d => d.id === employee.departmentId);
                csvContent += `${employee.name},${dept?.name || '不明'},${employee.regularHours.toFixed(1)},${employee.overtimeHours.toFixed(1)},${employee.nightHours.toFixed(1)},${employee.holidayHours.toFixed(1)},${employee.totalHours.toFixed(1)},${employee.complianceStatus.message},${employee.efficiencyScore}\n`;
            });
            
            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `業務時間分析_${startDate}_${endDate}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
