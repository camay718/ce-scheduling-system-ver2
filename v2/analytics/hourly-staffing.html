<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>時間帯別配置人数分析 - CEスケジュール管理システムV2</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyCRUvvs0OSz_9L9bXtqteVFIIze1OaZObE",
            authDomain: "ce-scheduling-system-v2.firebaseapp.com",
            databaseURL: "https://ce-scheduling-system-v2-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ce-scheduling-system-v2",
            storageBucket: "ce-scheduling-system-v2.firebasestorage.app",
            messagingSenderId: "288279598010",
            appId: "1:288279598010:web:d545ee1d4d854513084383",
            measurementId: "G-LSEEMJE2R0"
        };
        
        const app = initializeApp(firebaseConfig);
        window.database = getDatabase(app);
        window.auth = getAuth(app);
        
        // Anonymous authentication
        signInAnonymously(window.auth).catch(console.error);
    </script>
    
    <style>
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; }
            .bg-gradient-to-br { background: white !important; }
            .shadow-lg { box-shadow: none !important; }
            .page-break { page-break-after: always; }
        }
        
        .staffing-chart {
            background: white;
            border-radius: 0.5rem;
            padding: 1rem;
        }
        
        .stats-card {
            transition: transform 0.2s;
        }
        
        .stats-card:hover {
            transform: translateY(-2px);
        }
        
        .hour-slot {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            margin: 0.25rem 0;
            border-radius: 0.5rem;
            border-left: 4px solid transparent;
            transition: all 0.3s ease;
        }
        
        .hour-slot.peak {
            background: linear-gradient(135deg, #fef3c7 0%, #fed7aa 100%);
            border-left-color: #f59e0b;
        }
        
        .hour-slot.normal {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-left-color: #10b981;
        }
        
        .hour-slot.low {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border-left-color: #ef4444;
        }
        
        .heatmap-grid {
            display: grid;
            grid-template-columns: auto repeat(24, 1fr);
            gap: 2px;
            margin-top: 1rem;
        }
        
        .heatmap-cell {
            aspect-ratio: 1;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            color: white;
            min-width: 25px;
            min-height: 25px;
        }
        
        .heatmap-header {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            background: #f3f4f6;
            color: #374151;
            border-radius: 4px;
        }
        
        .heatmap-label {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 500;
            color: #374151;
            padding: 0 0.5rem;
            min-height: 25px;
        }
        
        .staffing-0 { background: #f3f4f6; color: #6b7280; }
        .staffing-1 { background: #dbeafe; color: #1e40af; }
        .staffing-2 { background: #93c5fd; color: #1e40af; }
        .staffing-3 { background: #60a5fa; color: white; }
        .staffing-4 { background: #3b82f6; color: white; }
        .staffing-5 { background: #2563eb; color: white; }
        .staffing-6 { background: #1d4ed8; color: white; }
        .staffing-7 { background: #1e40af; color: white; }
        .staffing-8 { background: #1e3a8a; color: white; }
        
        .peak-indicator {
            animation: pulse-glow 2s infinite;
        }
        
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 5px rgba(245, 158, 11, 0.5); }
            50% { box-shadow: 0 0 15px rgba(245, 158, 11, 0.8); }
        }
        
        .filter-tab {
            padding: 0.5rem 1rem;
            margin: 0 0.25rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .filter-tab.active {
            background: #0891b2;
            color: white;
            border-color: #0e7490;
        }
        
        .filter-tab:hover:not(.active) {
            background: #f0f9ff;
            border-color: #0891b2;
        }
        
        .weekday-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
            margin: 1rem 0;
        }
        
        .weekday-card {
            text-align: center;
            padding: 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .weekday-card.selected {
            background: #0891b2;
            color: white;
            transform: scale(1.05);
        }
        
        .weekday-card:hover:not(.selected) {
            background: #e0f2fe;
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-teal-50 to-cyan-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b no-print">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <i class="fas fa-chart-bar text-2xl text-teal-600"></i>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">時間帯別配置人数分析</h1>
                        <p class="text-sm text-gray-600">CEスケジュール管理システムV2</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2 text-sm text-gray-600">
                        <i class="fas fa-user-circle"></i>
                        <span id="currentUser">読み込み中...</span>
                    </div>
                    <button onclick="window.location.href='../dashboard.html'" 
        class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg text-gray-700 transition-colors">
    <i class="fas fa-arrow-left mr-2"></i>ダッシュボードに戻る
</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Filter Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6 no-print">
            <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-filter mr-2 text-teal-600"></i>分析設定
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                <!-- Date Range -->
                <div>
                    <label for="startDate" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-calendar-alt mr-1"></i>開始日
                    </label>
                    <input type="date" id="startDate" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500">
                </div>
                
                <div>
                    <label for="endDate" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-calendar-alt mr-1"></i>終了日
                    </label>
                    <input type="date" id="endDate" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500">
                </div>
                
                <!-- Department Filter -->
                <div>
                    <label for="departmentFilter" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-building mr-1"></i>部門フィルター
                    </label>
                    <select id="departmentFilter" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500">
                        <option value="">すべての部門</option>
                    </select>
                </div>
                
                <!-- Aggregation Type -->
                <div>
                    <label for="aggregationType" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-chart-line mr-1"></i>集計タイプ
                    </label>
                    <select id="aggregationType" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500">
                        <option value="total">全体集計</option>
                        <option value="weekday">曜日別集計</option>
                        <option value="department">部門別集計</option>
                        <option value="comparison">比較分析</option>
                    </select>
                </div>
            </div>
            
            <!-- Weekday Selection (Hidden by default) -->
            <div id="weekdaySelection" class="mb-4 hidden">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-calendar-week mr-1"></i>曜日選択（複数選択可能）
                </label>
                <div class="weekday-grid">
                    <div class="weekday-card" data-weekday="1">
                        <div class="text-sm font-medium">月</div>
                        <div class="text-xs text-gray-600">Monday</div>
                    </div>
                    <div class="weekday-card" data-weekday="2">
                        <div class="text-sm font-medium">火</div>
                        <div class="text-xs text-gray-600">Tuesday</div>
                    </div>
                    <div class="weekday-card" data-weekday="3">
                        <div class="text-sm font-medium">水</div>
                        <div class="text-xs text-gray-600">Wednesday</div>
                    </div>
                    <div class="weekday-card" data-weekday="4">
                        <div class="text-sm font-medium">木</div>
                        <div class="text-xs text-gray-600">Thursday</div>
                    </div>
                    <div class="weekday-card" data-weekday="5">
                        <div class="text-sm font-medium">金</div>
                        <div class="text-xs text-gray-600">Friday</div>
                    </div>
                    <div class="weekday-card" data-weekday="6">
                        <div class="text-sm font-medium">土</div>
                        <div class="text-xs text-gray-600">Saturday</div>
                    </div>
                    <div class="weekday-card" data-weekday="0">
                        <div class="text-sm font-medium">日</div>
                        <div class="text-xs text-gray-600">Sunday</div>
                    </div>
                </div>
            </div>
            
            <div class="flex flex-wrap gap-2">
                <button onclick="analyzeHourlyStaffing()" 
                        class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg transition-colors">
                    <i class="fas fa-chart-bar mr-2"></i>配置分析実行
                </button>
                <button onclick="resetAnalysis()" 
                        class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                    <i class="fas fa-undo mr-2"></i>リセット
                </button>
                <button onclick="exportStaffingReport()" 
                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                    <i class="fas fa-file-excel mr-2"></i>データ出力
                </button>
                <button onclick="window.print()" 
                        class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors">
                    <i class="fas fa-print mr-2"></i>印刷
                </button>
            </div>
        </div>

        <!-- Summary Statistics -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
            <div class="stats-card bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">ピーク時人数</p>
                        <p class="text-2xl font-bold text-teal-600" id="peakStaffing">0人</p>
                        <p class="text-xs text-gray-500 mt-1" id="peakTime">--:--</p>
                    </div>
                    <div class="bg-teal-100 p-3 rounded-full">
                        <i class="fas fa-arrow-up text-teal-600 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="stats-card bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">最少時人数</p>
                        <p class="text-2xl font-bold text-orange-600" id="minStaffing">0人</p>
                        <p class="text-xs text-gray-500 mt-1" id="minTime">--:--</p>
                    </div>
                    <div class="bg-orange-100 p-3 rounded-full">
                        <i class="fas fa-arrow-down text-orange-600 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="stats-card bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">平均配置人数</p>
                        <p class="text-2xl font-bold text-blue-600" id="avgStaffing">0人</p>
                    </div>
                    <div class="bg-blue-100 p-3 rounded-full">
                        <i class="fas fa-users text-blue-600 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="stats-card bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">カバー時間</p>
                        <p class="text-2xl font-bold text-green-600" id="coverageHours">0時間</p>
                    </div>
                    <div class="bg-green-100 p-3 rounded-full">
                        <i class="fas fa-clock text-green-600 text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Chart Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                    <i class="fas fa-chart-bar mr-2 text-teal-600"></i>時間帯別配置人数
                </h3>
                <div class="text-sm text-gray-600" id="chartSubtitle">24時間概要</div>
            </div>
            <canvas id="hourlyStaffingChart" style="height: 400px;"></canvas>
        </div>

        <!-- Detailed Analysis Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Weekday Comparison -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-calendar-week mr-2 text-teal-600"></i>曜日別比較
                </h3>
                <canvas id="weekdayComparisonChart" style="height: 300px;"></canvas>
            </div>
            
            <!-- Department Breakdown -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-building mr-2 text-teal-600"></i>部門別配置分布
                </h3>
                <canvas id="departmentBreakdownChart" style="height: 300px;"></canvas>
            </div>
        </div>

        <!-- Hourly Details List -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-list mr-2 text-teal-600"></i>時間帯詳細一覧
            </h3>
            <div id="hourlyDetailsList" class="space-y-2">
                <!-- Dynamic hourly details will be inserted here -->
            </div>
        </div>

        <!-- Staffing Heatmap -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6 page-break">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-th mr-2 text-teal-600"></i>配置密度ヒートマップ
            </h3>
            <div class="mb-4">
                <div class="flex items-center space-x-4 text-sm">
                    <span class="flex items-center">
                        <div class="w-4 h-4 staffing-0 rounded mr-2"></div>
                        0人
                    </span>
                    <span class="flex items-center">
                        <div class="w-4 h-4 staffing-2 rounded mr-2"></div>
                        1-2人
                    </span>
                    <span class="flex items-center">
                        <div class="w-4 h-4 staffing-4 rounded mr-2"></div>
                        3-5人
                    </span>
                    <span class="flex items-center">
                        <div class="w-4 h-4 staffing-6 rounded mr-2"></div>
                        6-8人
                    </span>
                    <span class="flex items-center">
                        <div class="w-4 h-4 staffing-8 rounded mr-2"></div>
                        9人以上
                    </span>
                </div>
            </div>
            <div id="staffingHeatmap">
                <!-- Heatmap will be generated here -->
            </div>
        </div>

        <!-- Peak Analysis -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-mountain mr-2 text-teal-600"></i>ピーク・ボトム分析
            </h3>
            <div id="peakBottomAnalysis" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Dynamic peak/bottom analysis will be inserted here -->
            </div>
        </div>

        <!-- Optimization Recommendations -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-lightbulb mr-2 text-teal-600"></i>配置最適化提案
            </h3>
            <div id="optimizationRecommendations" class="space-y-3">
                <!-- Dynamic recommendations will be inserted here -->
            </div>
        </div>
    </main>

    <!-- Loading Modal -->
    <div id="loadingModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4">
            <div class="flex items-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-teal-600 mr-4"></div>
                <span class="text-gray-700">配置データを分析中...</span>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let hourlyStaffingChart = null;
        let weekdayComparisonChart = null;
        let departmentBreakdownChart = null;
        let allSchedules = [];
        let allEmployees = [];
        let allDepartments = [];
        let selectedWeekdays = [];
        
        // Authentication check
        function checkAuth() {
            let user = sessionStorage.getItem('currentUser') || sessionStorage.getItem('currentUsername');

            // URLパラメータから取得
            if (!user) {
                const params = new URLSearchParams(location.search);
                const qpUser = params.get('user') || params.get('username');
                const qpUid = params.get('uid');
                const qpRole = params.get('role');
                if (qpUser) {
                    user = qpUser;
                    try {
                        sessionStorage.setItem('currentUser', qpUser);
                        sessionStorage.setItem('currentUsername', qpUser);
                        if (qpUid) sessionStorage.setItem('targetUID', qpUid);
                        if (qpRole) sessionStorage.setItem('userRole', qpRole);
                    } catch (e) {
                        console.warn('sessionStorage保存エラー:', e);
                    }
                }
            }

            // localStorageから取得
            if (!user) {
                try {
                    const authData = localStorage.getItem('analyticsAuth');
                    if (authData) {
                        const parsed = JSON.parse(authData);
                        if (Date.now() - parsed.timestamp < 5 * 60 * 1000) {
                            user = parsed.displayName;
                            sessionStorage.setItem('currentUser', parsed.displayName);
                            sessionStorage.setItem('currentUsername', parsed.username);
                            sessionStorage.setItem('targetUID', parsed.uid);
                            sessionStorage.setItem('userRole', parsed.role);
                        }
                    }
                } catch (e) {
                    console.warn('localStorage読み込みエラー:', e);
                }
            }

            if (!user) {
                alert('認証が必要です。ダッシュボードからアクセスしてください。');
                window.location.href = '../dashboard.html';
                return false;
            }

            const headerUserEl = document.getElementById('currentUser');
            if (headerUserEl) headerUserEl.textContent = user;
            return true;
        }
        
        // Initialize application
        async function init() {
            if (!checkAuth()) return;
            
            showLoading(true);
            
            try {
                await Promise.all([
                    loadEmployees(),
                    loadDepartments(),
                    loadSchedules()
                ]);
                
                setupDateInputs();
                populateDepartmentFilter();
                setupWeekdaySelection();
                setupAggregationTypeListener();
                initializeCharts();
            } catch (error) {
                console.error('初期化エラー:', error);
                alert('データの読み込みに失敗しました。ページをリロードしてください。');
            } finally {
                showLoading(false);
            }
        }
        
        // Load data functions
        async function loadEmployees() {
            try {
                const { ref, get } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js');
                const snapshot = await get(ref(window.database, 'employees'));
                
                if (snapshot.exists()) {
                    allEmployees = Object.entries(snapshot.val()).map(([id, data]) => ({
                        id,
                        ...data
                    }));
                }
            } catch (error) {
                console.error('従業員データの読み込みエラー:', error);
            }
        }
        
        async function loadDepartments() {
            try {
                const { ref, get } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js');
                const snapshot = await get(ref(window.database, 'departments'));
                
                if (snapshot.exists()) {
                    allDepartments = Object.entries(snapshot.val()).map(([id, data]) => ({
                        id,
                        ...data
                    }));
                }
            } catch (error) {
                console.error('部門データの読み込みエラー:', error);
            }
        }
        
        async function loadSchedules() {
            try {
                const { ref, get } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js');
                const snapshot = await get(ref(window.database, 'schedules'));
                
                if (snapshot.exists()) {
                    allSchedules = Object.entries(snapshot.val()).map(([id, data]) => ({
                        id,
                        ...data
                    }));
                }
            } catch (error) {
                console.error('スケジュールデータの読み込みエラー:', error);
            }
        }
        
        // Setup functions
        function setupDateInputs() {
            const startDate = document.getElementById('startDate');
            const endDate = document.getElementById('endDate');
            const today = new Date();
            const oneWeekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            startDate.value = oneWeekAgo.toISOString().split('T')[0];
            endDate.value = today.toISOString().split('T')[0];
        }
        
        function populateDepartmentFilter() {
            const select = document.getElementById('departmentFilter');
            select.innerHTML = '<option value="">すべての部門</option>';
            
            allDepartments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept.id;
                option.textContent = dept.name;
                select.appendChild(option);
            });
        }
        
        function setupWeekdaySelection() {
            const cards = document.querySelectorAll('.weekday-card');
            cards.forEach(card => {
                card.addEventListener('click', function() {
                    const weekday = parseInt(this.dataset.weekday);
                    
                    if (this.classList.contains('selected')) {
                        this.classList.remove('selected');
                        selectedWeekdays = selectedWeekdays.filter(w => w !== weekday);
                    } else {
                        this.classList.add('selected');
                        selectedWeekdays.push(weekday);
                    }
                });
            });
        }
        
        function setupAggregationTypeListener() {
            const select = document.getElementById('aggregationType');
            select.addEventListener('change', function() {
                const weekdaySelection = document.getElementById('weekdaySelection');
                
                if (this.value === 'weekday') {
                    weekdaySelection.classList.remove('hidden');
                } else {
                    weekdaySelection.classList.add('hidden');
                    // Clear selections
                    document.querySelectorAll('.weekday-card').forEach(card => {
                        card.classList.remove('selected');
                    });
                    selectedWeekdays = [];
                }
            });
        }
        
        function showLoading(show) {
            const modal = document.getElementById('loadingModal');
            if (show) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            } else {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }
        
        // Initialize charts
        function initializeCharts() {
            initializeHourlyStaffingChart();
            initializeWeekdayComparisonChart();
            initializeDepartmentBreakdownChart();
        }
        
        function initializeHourlyStaffingChart() {
            const ctx = document.getElementById('hourlyStaffingChart').getContext('2d');
            
            hourlyStaffingChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Array.from({length: 24}, (_, i) => `${i.toString().padStart(2, '0')}:00`),
                    datasets: [{
                        label: '配置人数',
                        data: new Array(24).fill(0),
                        backgroundColor: function(context) {
                            const value = context.parsed.y;
                            if (value === 0) return '#E5E7EB';
                            if (value <= 2) return '#FEE2E2';
                            if (value <= 4) return '#FEF3C7';
                            if (value <= 6) return '#D1FAE5';
                            return '#DBEAFE';
                        },
                        borderColor: '#0891B2',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '配置人数'
                            },
                            ticks: {
                                stepSize: 1
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '時間帯'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.parsed.y}人`;
                                }
                            }
                        },
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        function initializeWeekdayComparisonChart() {
            const ctx = document.getElementById('weekdayComparisonChart').getContext('2d');
            
            weekdayComparisonChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 24}, (_, i) => `${i.toString().padStart(2, '0')}:00`),
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '配置人数'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '時間帯'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });
        }
        
        function initializeDepartmentBreakdownChart() {
            const ctx = document.getElementById('departmentBreakdownChart').getContext('2d');
            
            departmentBreakdownChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Array.from({length: 24}, (_, i) => `${i.toString().padStart(2, '0')}:00`),
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                            title: {
                                display: true,
                                text: '時間帯'
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '配置人数'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });
        }
        
        // Analyze hourly staffing
        function analyzeHourlyStaffing() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const departmentFilter = document.getElementById('departmentFilter').value;
            const aggregationType = document.getElementById('aggregationType').value;
            
            if (!startDate || !endDate) {
                alert('期間を指定してください。');
                return;
            }
            
            if (aggregationType === 'weekday' && selectedWeekdays.length === 0) {
                alert('曜日別集計では少なくとも1つの曜日を選択してください。');
                return;
            }
            
            showLoading(true);
            
            try {
                const filteredSchedules = filterSchedules(startDate, endDate, departmentFilter);
                const hourlyData = calculateHourlyStaffing(filteredSchedules, aggregationType);
                
                updateSummaryStats(hourlyData);
                updateMainChart(hourlyData, aggregationType);
                updateWeekdayComparisonChart(filteredSchedules);
                updateDepartmentBreakdownChart(filteredSchedules);
                updateHourlyDetailsList(hourlyData);
                updateStaffingHeatmap(filteredSchedules);
                updatePeakBottomAnalysis(hourlyData);
                updateOptimizationRecommendations(hourlyData, filteredSchedules);
            } catch (error) {
                console.error('配置分析エラー:', error);
                alert('分析中にエラーが発生しました。');
            } finally {
                showLoading(false);
            }
        }
        
        // Filter schedules
        function filterSchedules(startDate, endDate, departmentFilter) {
            return allSchedules.filter(schedule => {
                if (schedule.date < startDate || schedule.date > endDate) return false;
                
                if (departmentFilter) {
                    const employee = allEmployees.find(e => e.id === schedule.employeeId);
                    if (!employee || employee.departmentId !== departmentFilter) return false;
                }
                
                return true;
            });
        }
        
        // Calculate hourly staffing
        function calculateHourlyStaffing(schedules, aggregationType) {
            const hourlyData = new Array(24).fill(0);
            const hourlyDetails = Array.from({length: 24}, () => ({ employees: [], departments: new Set() }));
            
            schedules.forEach(schedule => {
                // Check weekday filter for weekday aggregation
                if (aggregationType === 'weekday' && selectedWeekdays.length > 0) {
                    const date = new Date(schedule.date);
                    const weekday = date.getDay();
                    if (!selectedWeekdays.includes(weekday)) return;
                }
                
                const startHour = parseInt(schedule.startTime.split(':')[0]);
                const endHour = parseInt(schedule.endTime.split(':')[0]);
                const employee = allEmployees.find(e => e.id === schedule.employeeId);
                
                for (let hour = startHour; hour <= endHour; hour++) {
                    if (hour < 24) {
                        hourlyData[hour]++;
                        
                        if (employee) {
                            hourlyDetails[hour].employees.push(employee);
                            if (employee.departmentId) {
                                const dept = allDepartments.find(d => d.id === employee.departmentId);
                                if (dept) {
                                    hourlyDetails[hour].departments.add(dept.name);
                                }
                            }
                        }
                    }
                }
            });
            
            return { counts: hourlyData, details: hourlyDetails };
        }
        
        // Update summary statistics
        function updateSummaryStats(hourlyData) {
            const counts = hourlyData.counts;
            const maxStaffing = Math.max(...counts);
            const minStaffing = Math.min(...counts.filter(c => c > 0));
            const avgStaffing = counts.reduce((a, b) => a + b, 0) / counts.length;
            const coverageHours = counts.filter(c => c > 0).length;
            
            const peakHour = counts.indexOf(maxStaffing);
            const minHour = counts.indexOf(minStaffing);
            
            document.getElementById('peakStaffing').textContent = `${maxStaffing}人`;
            document.getElementById('peakTime').textContent = `${peakHour.toString().padStart(2, '0')}:00`;
            document.getElementById('minStaffing').textContent = `${minStaffing || 0}人`;
            document.getElementById('minTime').textContent = minHour >= 0 ? `${minHour.toString().padStart(2, '0')}:00` : '--:--';
            document.getElementById('avgStaffing').textContent = `${avgStaffing.toFixed(1)}人`;
            document.getElementById('coverageHours').textContent = `${coverageHours}時間`;
        }
        
        // Update main chart
        function updateMainChart(hourlyData, aggregationType) {
            const counts = hourlyData.counts;
            
            // Update chart subtitle
            let subtitle = '';
            switch (aggregationType) {
                case 'weekday':
                    const weekdayNames = ['日', '月', '火', '水', '木', '金', '土'];
                    const selectedNames = selectedWeekdays.map(w => weekdayNames[w]);
                    subtitle = `曜日別集計: ${selectedNames.join('、')}`;
                    break;
                case 'department':
                    const deptFilter = document.getElementById('departmentFilter').value;
                    const dept = allDepartments.find(d => d.id === deptFilter);
                    subtitle = deptFilter ? `部門別集計: ${dept?.name || '不明'}` : '部門別集計: 全部門';
                    break;
                case 'comparison':
                    subtitle = '比較分析';
                    break;
                default:
                    subtitle = '24時間概要';
            }
            document.getElementById('chartSubtitle').textContent = subtitle;
            
            // Color bars based on staffing levels
            const backgroundColors = counts.map(count => {
                if (count === 0) return '#E5E7EB';
                if (count <= 2) return '#FEE2E2';
                if (count <= 4) return '#FEF3C7';
                if (count <= 6) return '#D1FAE5';
                return '#DBEAFE';
            });
            
            hourlyStaffingChart.data.datasets[0].data = counts;
            hourlyStaffingChart.data.datasets[0].backgroundColor = backgroundColors;
            hourlyStaffingChart.update();
        }
        
        // Update weekday comparison chart
        function updateWeekdayComparisonChart(schedules) {
            const weekdayNames = ['日曜日', '月曜日', '火曜日', '水曜日', '木曜日', '金曜日', '土曜日'];
            const colors = ['#EF4444', '#F97316', '#EAB308', '#22C55E', '#3B82F6', '#8B5CF6', '#EC4899'];
            
            const weekdayData = {};
            
            // Initialize data for each weekday
            for (let i = 0; i < 7; i++) {
                weekdayData[i] = new Array(24).fill(0);
            }
            
            // Calculate hourly staffing for each weekday
            schedules.forEach(schedule => {
                const date = new Date(schedule.date);
                const weekday = date.getDay();
                const startHour = parseInt(schedule.startTime.split(':')[0]);
                const endHour = parseInt(schedule.endTime.split(':')[0]);
                
                for (let hour = startHour; hour <= endHour; hour++) {
                    if (hour < 24) {
                        weekdayData[weekday][hour]++;
                    }
                }
            });
            
            // Create datasets for each weekday
            const datasets = [];
            for (let i = 0; i < 7; i++) {
                datasets.push({
                    label: weekdayNames[i],
                    data: weekdayData[i],
                    borderColor: colors[i],
                    backgroundColor: colors[i] + '20',
                    fill: false,
                    tension: 0.4
                });
            }
            
            weekdayComparisonChart.data.datasets = datasets;
            weekdayComparisonChart.update();
        }
        
        // Update department breakdown chart
        function updateDepartmentBreakdownChart(schedules) {
            const deptColors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899', '#06B6D4'];
            const deptData = {};
            
            // Initialize data for each department
            allDepartments.forEach((dept, index) => {
                deptData[dept.id] = {
                    name: dept.name,
                    hours: new Array(24).fill(0),
                    color: deptColors[index % deptColors.length]
                };
            });
            
            // Calculate hourly staffing for each department
            schedules.forEach(schedule => {
                const employee = allEmployees.find(e => e.id === schedule.employeeId);
                if (!employee || !employee.departmentId) return;
                
                const startHour = parseInt(schedule.startTime.split(':')[0]);
                const endHour = parseInt(schedule.endTime.split(':')[0]);
                
                for (let hour = startHour; hour <= endHour; hour++) {
                    if (hour < 24 && deptData[employee.departmentId]) {
                        deptData[employee.departmentId].hours[hour]++;
                    }
                }
            });
            
            // Create datasets for each department
            const datasets = Object.values(deptData)
                .filter(dept => dept.hours.some(h => h > 0))
                .map(dept => ({
                    label: dept.name,
                    data: dept.hours,
                    backgroundColor: dept.color,
                    borderColor: dept.color,
                    borderWidth: 1
                }));
            
            departmentBreakdownChart.data.datasets = datasets;
            departmentBreakdownChart.update();
        }
        
        // Update hourly details list
        function updateHourlyDetailsList(hourlyData) {
            const container = document.getElementById('hourlyDetailsList');
            container.innerHTML = '';
            
            const counts = hourlyData.counts;
            const details = hourlyData.details;
            
            for (let hour = 0; hour < 24; hour++) {
                const count = counts[hour];
                const detail = details[hour];
                
                let levelClass = 'normal';
                if (count === 0) levelClass = 'low';
                else if (count >= Math.max(...counts) * 0.8) levelClass = 'peak';
                
                const hourSlot = document.createElement('div');
                hourSlot.className = `hour-slot ${levelClass}`;
                
                const deptList = Array.from(detail.departments).slice(0, 3).join('、');
                const moreText = detail.departments.size > 3 ? ` 他${detail.departments.size - 3}部門` : '';
                
                hourSlot.innerHTML = `
                    <div class="flex items-center justify-between w-full">
                        <div class="flex items-center space-x-4">
                            <div class="text-lg font-bold min-w-0 w-16">
                                ${hour.toString().padStart(2, '0')}:00
                            </div>
                            <div class="text-2xl font-bold min-w-0 w-12 text-center">
                                ${count}人
                            </div>
                            <div class="text-sm text-gray-600 flex-1">
                                ${deptList}${moreText}
                            </div>
                        </div>
                        <div class="text-xs text-gray-500">
                            ${count > 0 ? `${detail.employees.length}名` : '配置なし'}
                        </div>
                    </div>
                `;
                
                container.appendChild(hourSlot);
            }
        }
        
        // Update staffing heatmap
        function updateStaffingHeatmap(schedules) {
            const container = document.getElementById('staffingHeatmap');
            container.innerHTML = '';
            
            // Get unique dates from schedules
            const dates = [...new Set(schedules.map(s => s.date))].sort();
            
            if (dates.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">分析期間内にデータがありません</p>';
                return;
            }
            
            // Create heatmap grid
            const heatmapGrid = document.createElement('div');
            heatmapGrid.className = 'heatmap-grid';
            
            // Header row
            heatmapGrid.appendChild(createHeatmapElement('div', 'heatmap-label', '日付'));
            for (let hour = 0; hour < 24; hour++) {
                heatmapGrid.appendChild(createHeatmapElement('div', 'heatmap-header', hour.toString()));
            }
            
            // Data rows
            dates.forEach(date => {
                const dateLabel = document.createElement('div');
                dateLabel.className = 'heatmap-label';
                dateLabel.textContent = new Date(date).toLocaleDateString('ja-JP', {month: '2-digit', day: '2-digit'});
                heatmapGrid.appendChild(dateLabel);
                
                for (let hour = 0; hour < 24; hour++) {
                    const count = schedules.filter(schedule => {
                        if (schedule.date !== date) return false;
                        const startHour = parseInt(schedule.startTime.split(':')[0]);
                        const endHour = parseInt(schedule.endTime.split(':')[0]);
                        return hour >= startHour && hour <= endHour;
                    }).length;
                    
                    const intensity = Math.min(Math.floor(count), 8);
                    const cell = createHeatmapElement('div', `heatmap-cell staffing-${intensity}`, count.toString());
                    cell.title = `${date} ${hour.toString().padStart(2, '0')}:00 - ${count}人`;
                    heatmapGrid.appendChild(cell);
                }
            });
            
            container.appendChild(heatmapGrid);
        }
        
        function createHeatmapElement(tag, className, content) {
            const element = document.createElement(tag);
            element.className = className;
            element.textContent = content;
            return element;
        }
        
        // Update peak bottom analysis
        function updatePeakBottomAnalysis(hourlyData) {
            const container = document.getElementById('peakBottomAnalysis');
            container.innerHTML = '';
            
            const counts = hourlyData.counts;
            const maxCount = Math.max(...counts);
            const minCount = Math.min(...counts.filter(c => c > 0));
            
            const peakHours = counts.map((count, hour) => ({ hour, count }))
                .filter(item => item.count === maxCount);
            
            const bottomHours = counts.map((count, hour) => ({ hour, count }))
                .filter(item => item.count === minCount && item.count > 0);
            
            // Peak analysis card
            const peakCard = document.createElement('div');
            peakCard.className = 'bg-orange-50 border border-orange-200 rounded-lg p-4';
            peakCard.innerHTML = `
                <div class="flex items-center mb-3">
                    <div class="bg-orange-100 p-2 rounded-full mr-3">
                        <i class="fas fa-mountain text-orange-600"></i>
                    </div>
                    <h4 class="font-semibold text-orange-800">ピーク時間帯</h4>
                </div>
                <div class="space-y-2">
                    <p class="text-orange-700">最大配置人数: <strong>${maxCount}人</strong></p>
                    <p class="text-orange-600 text-sm">
                        ピーク時間: ${peakHours.map(p => `${p.hour.toString().padStart(2, '0')}:00`).join('、')}
                    </p>
                    <p class="text-orange-600 text-xs">
                        この時間帯は最も多くの人員が配置されています
                    </p>
                </div>
            `;
            
            // Bottom analysis card
            const bottomCard = document.createElement('div');
            bottomCard.className = 'bg-blue-50 border border-blue-200 rounded-lg p-4';
            bottomCard.innerHTML = `
                <div class="flex items-center mb-3">
                    <div class="bg-blue-100 p-2 rounded-full mr-3">
                        <i class="fas fa-valley text-blue-600"></i>
                    </div>
                    <h4 class="font-semibold text-blue-800">ボトム時間帯</h4>
                </div>
                <div class="space-y-2">
                    <p class="text-blue-700">最少配置人数: <strong>${minCount || 0}人</strong></p>
                    <p class="text-blue-600 text-sm">
                        ${bottomHours.length > 0 ? 
                            `ボトム時間: ${bottomHours.map(b => `${b.hour.toString().padStart(2, '0')}:00`).join('、')}` :
                            '配置のない時間があります'
                        }
                    </p>
                    <p class="text-blue-600 text-xs">
                        ${minCount > 0 ? 'この時間帯は人員配置が最少です' : '人員配置の改善を検討してください'}
                    </p>
                </div>
            `;
            
            container.appendChild(peakCard);
            container.appendChild(bottomCard);
        }
        
        // Update optimization recommendations
        function updateOptimizationRecommendations(hourlyData, schedules) {
            const container = document.getElementById('optimizationRecommendations');
            container.innerHTML = '';
            
            const counts = hourlyData.counts;
            const avgStaffing = counts.reduce((a, b) => a + b, 0) / counts.length;
            const maxCount = Math.max(...counts);
            const minCount = Math.min(...counts.filter(c => c > 0));
            const recommendations = [];
            
            // Check for zero staffing hours
            const zeroHours = counts.map((count, hour) => ({ hour, count }))
                .filter(item => item.count === 0);
            
            if (zeroHours.length > 0) {
                recommendations.push({
                    type: 'warning',
                    icon: 'fas fa-exclamation-triangle text-yellow-600',
                    title: '配置空白時間の改善',
                    message: `${zeroHours.length}時間で人員配置がありません。業務継続性を確保するため配置の検討が必要です。`
                });
            }
            
            // Check for peak vs average disparity
            if (maxCount > avgStaffing * 2) {
                recommendations.push({
                    type: 'info',
                    icon: 'fas fa-balance-scale text-blue-600',
                    title: '配置バランスの最適化',
                    message: `ピーク時間帯の配置が平均の2倍を超えています。より均等な配置を検討してください。`
                });
            }
            
            // Check department distribution
            const deptDistribution = {};
            schedules.forEach(schedule => {
                const employee = allEmployees.find(e => e.id === schedule.employeeId);
                if (employee && employee.departmentId) {
                    const dept = allDepartments.find(d => d.id === employee.departmentId);
                    if (dept) {
                        deptDistribution[dept.name] = (deptDistribution[dept.name] || 0) + 1;
                    }
                }
            });
            
            const deptCount = Object.keys(deptDistribution).length;
            if (deptCount < allDepartments.length / 2) {
                recommendations.push({
                    type: 'suggestion',
                    icon: 'fas fa-users text-green-600',
                    title: '部門間連携の強化',
                    message: `現在${deptCount}部門が配置に参加しています。他部門との連携により配置の柔軟性を向上できる可能性があります。`
                });
            }
            
            if (recommendations.length === 0) {
                recommendations.push({
                    type: 'success',
                    icon: 'fas fa-check-circle text-green-600',
                    title: '良好な配置バランス',
                    message: '現在の配置パターンは適切です。継続的な監視により品質を維持してください。'
                });
            }
            
            recommendations.forEach(rec => {
                const item = document.createElement('div');
                item.className = `flex items-start space-x-3 p-4 rounded-lg ${
                    rec.type === 'warning' ? 'bg-yellow-50' :
                    rec.type === 'info' ? 'bg-blue-50' :
                    rec.type === 'suggestion' ? 'bg-green-50' : 'bg-green-50'
                }`;
                item.innerHTML = `
                    <i class="${rec.icon} mt-1"></i>
                    <div>
                        <h4 class="font-medium text-gray-900">${rec.title}</h4>
                        <p class="text-sm text-gray-600 mt-1">${rec.message}</p>
                    </div>
                `;
                container.appendChild(item);
            });
        }
        
        // Reset analysis
        function resetAnalysis() {
            document.getElementById('departmentFilter').value = '';
            document.getElementById('aggregationType').value = 'total';
            setupDateInputs();
            
            // Hide weekday selection
            document.getElementById('weekdaySelection').classList.add('hidden');
            document.querySelectorAll('.weekday-card').forEach(card => {
                card.classList.remove('selected');
            });
            selectedWeekdays = [];
            
            // Clear statistics
            document.getElementById('peakStaffing').textContent = '0人';
            document.getElementById('peakTime').textContent = '--:--';
            document.getElementById('minStaffing').textContent = '0人';
            document.getElementById('minTime').textContent = '--:--';
            document.getElementById('avgStaffing').textContent = '0人';
            document.getElementById('coverageHours').textContent = '0時間';
            document.getElementById('chartSubtitle').textContent = '24時間概要';
            
            // Clear charts
            if (hourlyStaffingChart) {
                hourlyStaffingChart.data.datasets[0].data = new Array(24).fill(0);
                hourlyStaffingChart.data.datasets[0].backgroundColor = '#E5E7EB';
                hourlyStaffingChart.update();
            }
            
            if (weekdayComparisonChart) {
                weekdayComparisonChart.data.datasets = [];
                weekdayComparisonChart.update();
            }
            
            if (departmentBreakdownChart) {
                departmentBreakdownChart.data.datasets = [];
                departmentBreakdownChart.update();
            }
            
            // Clear other displays
            document.getElementById('hourlyDetailsList').innerHTML = '';
            document.getElementById('staffingHeatmap').innerHTML = '';
            document.getElementById('peakBottomAnalysis').innerHTML = '';
            document.getElementById('optimizationRecommendations').innerHTML = '';
        }
        
        // Export staffing report
        function exportStaffingReport() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                alert('期間を指定してから出力してください。');
                return;
            }
            
            const departmentFilter = document.getElementById('departmentFilter').value;
            const aggregationType = document.getElementById('aggregationType').value;
            const filteredSchedules = filterSchedules(startDate, endDate, departmentFilter);
            const hourlyData = calculateHourlyStaffing(filteredSchedules, aggregationType);
            
            // Create CSV content
            let csvContent = '\uFEFF'; // BOM for UTF-8
            csvContent += '時間帯別配置人数分析レポート\n';
            csvContent += `分析期間: ${startDate} - ${endDate}\n`;
            csvContent += `部門フィルター: ${departmentFilter ? allDepartments.find(d => d.id === departmentFilter)?.name || '不明' : 'すべて'}\n`;
            csvContent += `集計タイプ: ${aggregationType}\n`;
            csvContent += `生成日時: ${new Date().toLocaleString('ja-JP')}\n\n`;
            
            // Summary statistics
            const counts = hourlyData.counts;
            const maxStaffing = Math.max(...counts);
            const minStaffing = Math.min(...counts.filter(c => c > 0));
            const avgStaffing = counts.reduce((a, b) => a + b, 0) / counts.length;
            
            csvContent += '概要統計\n';
            csvContent += `ピーク時人数,${maxStaffing}人\n`;
            csvContent += `最少時人数,${minStaffing || 0}人\n`;
            csvContent += `平均配置人数,${avgStaffing.toFixed(1)}人\n\n`;
            
            // Hourly details
            csvContent += '時間帯別詳細\n';
            csvContent += '時間,配置人数,配置従業員数,関係部門数\n';
            
            for (let hour = 0; hour < 24; hour++) {
                const count = counts[hour];
                const detail = hourlyData.details[hour];
                csvContent += `${hour.toString().padStart(2, '0')}:00,${count},${detail.employees.length},${detail.departments.size}\n`;
            }
            
            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `時間帯別配置人数_${startDate}_${endDate}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
