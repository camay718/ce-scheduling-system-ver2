Copy<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>部門別充足率分析 - CEスケジュール管理システムV2</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyCRUvvs0OSz_9L9bXtqteVFIIze1OaZObE",
            authDomain: "ce-scheduling-system-v2.firebaseapp.com",
            databaseURL: "https://ce-scheduling-system-v2-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ce-scheduling-system-v2",
            storageBucket: "ce-scheduling-system-v2.firebasestorage.app",
            messagingSenderId: "288279598010",
            appId: "1:288279598010:web:d545ee1d4d854513084383",
            measurementId: "G-LSEEMJE2R0"
        };
        
        const app = initializeApp(firebaseConfig);
        window.database = getDatabase(app);
        window.auth = getAuth(app);
        
        // Anonymous authentication
        signInAnonymously(window.auth).catch(console.error);
    </script>
    
    <style>
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; }
            .bg-gradient-to-br { background: white !important; }
            .shadow-lg { box-shadow: none !important; }
            .page-break { page-break-after: always; }
        }
        
        .coverage-chart {
            background: white;
            border-radius: 0.5rem;
            padding: 1rem;
        }
        
        .stats-card {
            transition: transform 0.2s;
        }
        
        .stats-card:hover {
            transform: translateY(-2px);
        }
        
        .department-card {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        
        .department-card.excellent {
            border-left-color: #10b981;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        }
        
        .department-card.good {
            border-left-color: #f59e0b;
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        }
        
        .department-card.warning {
            border-left-color: #ef4444;
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
        }
        
        .coverage-gauge {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto;
        }
        
        .gauge-bg {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(from 180deg, #fee2e2 0deg, #fef3c7 120deg, #dcfce7 240deg, #dcfce7 360deg);
            position: relative;
        }
        
        .gauge-fill {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .alert-badge {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .trend-indicator {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .trend-up {
            background: #dcfce7;
            color: #166534;
        }
        
        .trend-down {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .trend-stable {
            background: #f3f4f6;
            color: #374151;
        }
        
        .coverage-matrix {
            display: grid;
            grid-template-columns: repeat(24, 1fr);
            gap: 2px;
            margin-top: 1rem;
        }
        
        .matrix-cell {
            aspect-ratio: 1;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            color: white;
        }
        
        .coverage-0-30 { background: #dc2626; }
        .coverage-31-60 { background: #ea580c; }
        .coverage-61-80 { background: #ca8a04; }
        .coverage-81-100 { background: #16a34a; }
        .coverage-over-100 { background: #0ea5e9; }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 to-purple-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b no-print">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <i class="fas fa-chart-line text-2xl text-indigo-600"></i>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">部門別充足率分析</h1>
                        <p class="text-sm text-gray-600">CEスケジュール管理システムV2</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2 text-sm text-gray-600">
                        <i class="fas fa-user-circle"></i>
                        <span id="currentUser">読み込み中...</span>
                    </div>
                    <button onclick="window.location.href='../dashboard.html'" 
        class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg text-gray-700 transition-colors">
    <i class="fas fa-arrow-left mr-2"></i>ダッシュボードに戻る
</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Alert Banner -->
    <div id="alertBanner" class="bg-red-500 text-white px-4 py-2 no-print hidden">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                <span id="alertMessage">充足率が低い部門があります</span>
            </div>
            <button onclick="hideAlert()" class="text-white hover:text-red-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Filter Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6 no-print">
            <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-filter mr-2 text-indigo-600"></i>分析設定
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Date Range -->
                <div>
                    <label for="startDate" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-calendar-alt mr-1"></i>開始日
                    </label>
                    <input type="date" id="startDate" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                
                <div>
                    <label for="endDate" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-calendar-alt mr-1"></i>終了日
                    </label>
                    <input type="date" id="endDate" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                
                <!-- Coverage Threshold -->
                <div>
                    <label for="coverageThreshold" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-percentage mr-1"></i>アラート閾値
                    </label>
                    <select id="coverageThreshold" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="50">50%未満</option>
                        <option value="60">60%未満</option>
                        <option value="70" selected>70%未満</option>
                        <option value="80">80%未満</option>
                    </select>
                </div>
                
                <!-- Analysis Type -->
                <div>
                    <label for="analysisType" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-chart-bar mr-1"></i>分析タイプ
                    </label>
                    <select id="analysisType" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="overall">全体分析</option>
                        <option value="hourly">時間帯別</option>
                        <option value="daily">日別推移</option>
                        <option value="weekly">週別比較</option>
                    </select>
                </div>
            </div>
            
            <div class="flex flex-wrap gap-2 mt-4">
                <button onclick="analyzeCoverage()" 
                        class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition-colors">
                    <i class="fas fa-search-plus mr-2"></i>充足率分析
                </button>
                <button onclick="resetAnalysis()" 
                        class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                    <i class="fas fa-undo mr-2"></i>リセット
                </button>
                <button onclick="exportCoverageReport()" 
                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                    <i class="fas fa-file-excel mr-2"></i>レポート出力
                </button>
                <button onclick="window.print()" 
                        class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors">
                    <i class="fas fa-print mr-2"></i>印刷
                </button>
            </div>
        </div>

        <!-- Overview Statistics -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
            <div class="stats-card bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">平均充足率</p>
                        <p class="text-2xl font-bold text-indigo-600" id="avgCoverageRate">0%</p>
                    </div>
                    <div class="bg-indigo-100 p-3 rounded-full">
                        <i class="fas fa-percentage text-indigo-600 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="stats-card bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">充足部門数</p>
                        <p class="text-2xl font-bold text-green-600" id="sufficientDepts">0</p>
                    </div>
                    <div class="bg-green-100 p-3 rounded-full">
                        <i class="fas fa-check-circle text-green-600 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="stats-card bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">不足部門数</p>
                        <p class="text-2xl font-bold text-red-600" id="insufficientDepts">0</p>
                    </div>
                    <div class="bg-red-100 p-3 rounded-full">
                        <i class="fas fa-exclamation-circle text-red-600 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="stats-card bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">総不足人数</p>
                        <p class="text-2xl font-bold text-yellow-600" id="totalShortage">0人</p>
                    </div>
                    <div class="bg-yellow-100 p-3 rounded-full">
                        <i class="fas fa-user-minus text-yellow-600 text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Department Coverage Cards -->
        <div class="mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-building mr-2 text-indigo-600"></i>部門別充足率詳細
            </h3>
            <div id="departmentCards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Dynamic department cards will be inserted here -->
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Coverage Comparison Chart -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-chart-bar mr-2 text-indigo-600"></i>部門別充足率比較
                </h3>
                <canvas id="coverageComparisonChart" style="height: 300px;"></canvas>
            </div>
            
            <!-- Trend Analysis Chart -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-chart-line mr-2 text-indigo-600"></i>充足率推移分析
                </h3>
                <canvas id="trendChart" style="height: 300px;"></canvas>
            </div>
        </div>

        <!-- Hourly Coverage Matrix -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6 page-break">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-th mr-2 text-indigo-600"></i>時間帯別充足率マトリックス
            </h3>
            <div class="mb-4">
                <div class="flex items-center space-x-4 text-sm">
                    <span class="flex items-center">
                        <div class="w-4 h-4 bg-red-600 rounded mr-2"></div>
                        0-30% (不足)
                    </span>
                    <span class="flex items-center">
                        <div class="w-4 h-4 bg-orange-600 rounded mr-2"></div>
                        31-60% (注意)
                    </span>
                    <span class="flex items-center">
                        <div class="w-4 h-4 bg-yellow-600 rounded mr-2"></div>
                        61-80% (普通)
                    </span>
                    <span class="flex items-center">
                        <div class="w-4 h-4 bg-green-600 rounded mr-2"></div>
                        81-100% (良好)
                    </span>
                    <span class="flex items-center">
                        <div class="w-4 h-4 bg-blue-500 rounded mr-2"></div>
                        100%+ (過剰)
                    </span>
                </div>
            </div>
            <div id="coverageMatrix">
                <!-- Matrix will be generated here -->
            </div>
        </div>

        <!-- Detailed Analysis Table -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-table mr-2 text-indigo-600"></i>詳細分析テーブル
            </h3>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">部門名</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">必要人数</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">配置人数</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">充足率</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">過不足</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ステータス</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">推移</th>
                        </tr>
                    </thead>
                    <tbody id="analysisTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Dynamic table rows will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Recommendations -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-lightbulb mr-2 text-indigo-600"></i>改善提案
            </h3>
            <div id="recommendations" class="space-y-3">
                <!-- Dynamic recommendations will be inserted here -->
            </div>
        </div>
    </main>

    <!-- Loading Modal -->
    <div id="loadingModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4">
            <div class="flex items-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mr-4"></div>
                <span class="text-gray-700">充足率を分析中...</span>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let coverageComparisonChart = null;
        let trendChart = null;
        let allSchedules = [];
        let allEmployees = [];
        let allDepartments = [];
        let departmentRequirements = {};
        
        // Department requirements (これは通常はDBから取得)
        const defaultRequirements = {
            'dept1': { name: '営業部', required: 8, minCoverage: 70 },
            'dept2': { name: '技術部', required: 12, minCoverage: 80 },
            'dept3': { name: '管理部', required: 5, minCoverage: 60 },
            'dept4': { name: '製造部', required: 15, minCoverage: 85 },
            'dept5': { name: 'サポート部', required: 6, minCoverage: 65 }
        };
        
        // Authentication check
        function checkAuth() {
            let user = sessionStorage.getItem('currentUser') || sessionStorage.getItem('currentUsername');

            // URLパラメータから取得
            if (!user) {
                const params = new URLSearchParams(location.search);
                const qpUser = params.get('user') || params.get('username');
                const qpUid = params.get('uid');
                const qpRole = params.get('role');
                if (qpUser) {
                    user = qpUser;
                    try {
                        sessionStorage.setItem('currentUser', qpUser);
                        sessionStorage.setItem('currentUsername', qpUser);
                        if (qpUid) sessionStorage.setItem('targetUID', qpUid);
                        if (qpRole) sessionStorage.setItem('userRole', qpRole);
                    } catch (e) {
                        console.warn('sessionStorage保存エラー:', e);
                    }
                }
            }

            // localStorageから取得
            if (!user) {
                try {
                    const authData = localStorage.getItem('analyticsAuth');
                    if (authData) {
                        const parsed = JSON.parse(authData);
                        if (Date.now() - parsed.timestamp < 5 * 60 * 1000) {
                            user = parsed.displayName;
                            sessionStorage.setItem('currentUser', parsed.displayName);
                            sessionStorage.setItem('currentUsername', parsed.username);
                            sessionStorage.setItem('targetUID', parsed.uid);
                            sessionStorage.setItem('userRole', parsed.role);
                        }
                    }
                } catch (e) {
                    console.warn('localStorage読み込みエラー:', e);
                }
            }

            if (!user) {
                alert('認証が必要です。ダッシュボードからアクセスしてください。');
                window.location.href = '../dashboard.html';
                return false;
            }

            const headerUserEl = document.getElementById('currentUser');
            if (headerUserEl) headerUserEl.textContent = user;
            return true;
        }
        
        // Initialize application
        async function init() {
            if (!checkAuth()) return;
            
            showLoading(true);
            
            try {
                await Promise.all([
                    loadEmployees(),
                    loadDepartments(),
                    loadSchedules()
                ]);
                
                setupDateInputs();
                initializeDepartmentRequirements();
                initializeCharts();
            } catch (error) {
                console.error('初期化エラー:', error);
                alert('データの読み込みに失敗しました。ページをリロードしてください。');
            } finally {
                showLoading(false);
            }
        }
        
        // Load data functions
        async function loadEmployees() {
            try {
                const { ref, get } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js');
                const snapshot = await get(ref(window.database, 'employees'));
                
                if (snapshot.exists()) {
                    allEmployees = Object.entries(snapshot.val()).map(([id, data]) => ({
                        id,
                        ...data
                    }));
                }
            } catch (error) {
                console.error('従業員データの読み込みエラー:', error);
            }
        }
        
        async function loadDepartments() {
            try {
                const { ref, get } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js');
                const snapshot = await get(ref(window.database, 'departments'));
                
                if (snapshot.exists()) {
                    allDepartments = Object.entries(snapshot.val()).map(([id, data]) => ({
                        id,
                        ...data
                    }));
                }
            } catch (error) {
                console.error('部門データの読み込みエラー:', error);
            }
        }
        
        async function loadSchedules() {
            try {
                const { ref, get } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js');
                const snapshot = await get(ref(window.database, 'schedules'));
                
                if (snapshot.exists()) {
                    allSchedules = Object.entries(snapshot.val()).map(([id, data]) => ({
                        id,
                        ...data
                    }));
                }
            } catch (error) {
                console.error('スケジュールデータの読み込みエラー:', error);
            }
        }
        
        // Setup functions
        function setupDateInputs() {
            const startDate = document.getElementById('startDate');
            const endDate = document.getElementById('endDate');
            const today = new Date();
            const oneWeekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            startDate.value = oneWeekAgo.toISOString().split('T')[0];
            endDate.value = today.toISOString().split('T')[0];
        }
        
        function initializeDepartmentRequirements() {
            // 実際のシステムではFirebaseから取得するが、デモ用にデフォルト値を使用
            departmentRequirements = { ...defaultRequirements };
            
            // 実際の部門データと統合
            allDepartments.forEach(dept => {
                if (!departmentRequirements[dept.id]) {
                    departmentRequirements[dept.id] = {
                        name: dept.name,
                        required: Math.floor(Math.random() * 10) + 5, // デモ用ランダム値
                        minCoverage: 70
                    };
                }
            });
        }
        
        function showLoading(show) {
            const modal = document.getElementById('loadingModal');
            if (show) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            } else {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }
        
        // Initialize charts
        function initializeCharts() {
            initializeCoverageComparisonChart();
            initializeTrendChart();
        }
        
        function initializeCoverageComparisonChart() {
            const ctx = document.getElementById('coverageComparisonChart').getContext('2d');
            
            coverageComparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: '必要人数',
                            data: [],
                            backgroundColor: '#E5E7EB',
                            borderColor: '#9CA3AF',
                            borderWidth: 1
                        },
                        {
                            label: '配置人数',
                            data: [],
                            backgroundColor: '#3B82F6',
                            borderColor: '#1E40AF',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '人数'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    if (context.datasetIndex === 1) {
                                        const required = context.chart.data.datasets[0].data[context.dataIndex];
                                        const assigned = context.parsed.y;
                                        const coverage = required > 0 ? ((assigned / required) * 100).toFixed(1) : 0;
                                        return `充足率: ${coverage}%`;
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function initializeTrendChart() {
            const ctx = document.getElementById('trendChart').getContext('2d');
            
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 120,
                            title: {
                                display: true,
                                text: '充足率 (%)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });
        }
        
        // Analyze coverage
        function analyzeCoverage() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const threshold = parseInt(document.getElementById('coverageThreshold').value);
            const analysisType = document.getElementById('analysisType').value;
            
            if (!startDate || !endDate) {
                alert('期間を指定してください。');
                return;
            }
            
            showLoading(true);
            
            try {
                const filteredSchedules = filterSchedules(startDate, endDate);
                const coverageData = calculateCoverageData(filteredSchedules, analysisType);
                
                updateOverviewStats(coverageData, threshold);
                updateDepartmentCards(coverageData, threshold);
                updateCoverageComparisonChart(coverageData);
                updateTrendChart(filteredSchedules, analysisType);
                updateCoverageMatrix(filteredSchedules);
                updateAnalysisTable(coverageData, threshold);
                updateRecommendations(coverageData, threshold);
                checkAndShowAlerts(coverageData, threshold);
            } catch (error) {
                console.error('充足率分析エラー:', error);
                alert('分析中にエラーが発生しました。');
            } finally {
                showLoading(false);
            }
        }
        
        // Filter schedules
        function filterSchedules(startDate, endDate) {
            return allSchedules.filter(schedule => {
                return schedule.date >= startDate && schedule.date <= endDate;
            });
        }
        
        // Calculate coverage data
        function calculateCoverageData(schedules, analysisType) {
            const coverageData = {};
            
            // Initialize department data
            Object.keys(departmentRequirements).forEach(deptId => {
                coverageData[deptId] = {
                    ...departmentRequirements[deptId],
                    assigned: 0,
                    coverage: 0,
                    shortage: 0,
                    trend: 'stable'
                };
            });
            
            // Count assigned personnel
            const assignmentCounts = {};
            schedules.forEach(schedule => {
                const employee = allEmployees.find(e => e.id === schedule.employeeId);
                if (employee && employee.departmentId) {
                    const key = `${employee.departmentId}`;
                    assignmentCounts[key] = (assignmentCounts[key] || new Set()).add(schedule.employeeId);
                }
            });
            
            // Calculate coverage for each department
            Object.keys(coverageData).forEach(deptId => {
                const assigned = assignmentCounts[deptId] ? assignmentCounts[deptId].size : 0;
                const required = coverageData[deptId].required;
                
                coverageData[deptId].assigned = assigned;
                coverageData[deptId].coverage = required > 0 ? (assigned / required) * 100 : 0;
                coverageData[deptId].shortage = Math.max(0, required - assigned);
                
                // 簡単なトレンド計算（実際はより複雑な計算が必要）
                const coverageRate = coverageData[deptId].coverage;
                if (coverageRate > 90) coverageData[deptId].trend = 'up';
                else if (coverageRate < 70) coverageData[deptId].trend = 'down';
                else coverageData[deptId].trend = 'stable';
            });
            
            return coverageData;
        }
        
        // Update overview statistics
        function updateOverviewStats(coverageData, threshold) {
            const departments = Object.values(coverageData);
            const avgCoverage = departments.reduce((sum, dept) => sum + dept.coverage, 0) / departments.length;
            const sufficientDepts = departments.filter(dept => dept.coverage >= threshold).length;
            const insufficientDepts = departments.length - sufficientDepts;
            const totalShortage = departments.reduce((sum, dept) => sum + dept.shortage, 0);
            
            document.getElementById('avgCoverageRate').textContent = `${avgCoverage.toFixed(1)}%`;
            document.getElementById('sufficientDepts').textContent = sufficientDepts;
            document.getElementById('insufficientDepts').textContent = insufficientDepts;
            document.getElementById('totalShortage').textContent = `${totalShortage}人`;
        }
        
        // Update department cards
        function updateDepartmentCards(coverageData, threshold) {
            const container = document.getElementById('departmentCards');
            container.innerHTML = '';
            
            Object.entries(coverageData).forEach(([deptId, data]) => {
                const coverageClass = data.coverage >= 80 ? 'excellent' : 
                                    data.coverage >= threshold ? 'good' : 'warning';
                
                const trendIcon = data.trend === 'up' ? 'fa-arrow-up' : 
                               data.trend === 'down' ? 'fa-arrow-down' : 'fa-minus';
                
                const trendClass = data.trend === 'up' ? 'trend-up' : 
                                 data.trend === 'down' ? 'trend-down' : 'trend-stable';
                
                const card = document.createElement('div');
                card.className = `department-card bg-white rounded-lg shadow-lg p-6 ${coverageClass}`;
                card.innerHTML = `
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-lg font-semibold text-gray-900">${data.name}</h4>
                        <span class="trend-indicator ${trendClass}">
                            <i class="fas ${trendIcon} mr-1"></i>
                            ${data.trend === 'up' ? '上昇' : data.trend === 'down' ? '下降' : '安定'}
                        </span>
                    </div>
                    
                    <div class="coverage-gauge mb-4">
                        <div class="gauge-bg">
                            <div class="gauge-fill">
                                <span class="text-lg font-bold ${data.coverage >= threshold ? 'text-green-600' : 'text-red-600'}">
                                    ${data.coverage.toFixed(0)}%
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div class="text-center">
                            <p class="text-gray-600">必要人数</p>
                            <p class="font-bold text-lg">${data.required}人</p>
                        </div>
                        <div class="text-center">
                            <p class="text-gray-600">配置人数</p>
                            <p class="font-bold text-lg ${data.assigned >= data.required ? 'text-green-600' : 'text-red-600'}">
                                ${data.assigned}人
                            </p>
                        </div>
                    </div>
                    
                    ${data.shortage > 0 ? `
                        <div class="mt-4 p-3 bg-red-50 rounded-lg">
                            <p class="text-red-700 text-sm font-medium">
                                <i class="fas fa-exclamation-triangle mr-1"></i>
                                ${data.shortage}人不足
                            </p>
                        </div>
                    ` : ''}
                    
                    ${data.coverage > 100 ? `
                        <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                            <p class="text-blue-700 text-sm font-medium">
                                <i class="fas fa-info-circle mr-1"></i>
                                ${data.assigned - data.required}人過剰
                            </p>
                        </div>
                    ` : ''}
                `;
                container.appendChild(card);
            });
        }
        
        // Update coverage comparison chart
        function updateCoverageComparisonChart(coverageData) {
            const labels = Object.values(coverageData).map(dept => dept.name);
            const requiredData = Object.values(coverageData).map(dept => dept.required);
            const assignedData = Object.values(coverageData).map(dept => dept.assigned);
            
            coverageComparisonChart.data.labels = labels;
            coverageComparisonChart.data.datasets[0].data = requiredData;
            coverageComparisonChart.data.datasets[1].data = assignedData;
            coverageComparisonChart.update();
        }
        
        // Update trend chart
        function updateTrendChart(schedules, analysisType) {
            // 簡化されたトレンド分析 - 実際はより詳細な時系列分析が必要
            const datasets = [];
            const colors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6'];
            
            Object.entries(departmentRequirements).forEach(([deptId, req], index) => {
                const deptSchedules = schedules.filter(s => {
                    const employee = allEmployees.find(e => e.id === s.employeeId);
                    return employee && employee.departmentId === deptId;
                });
                
                // 日別の充足率を計算（簡化版）
                const dailyData = {};
                deptSchedules.forEach(schedule => {
                    const date = schedule.date;
                    if (!dailyData[date]) dailyData[date] = new Set();
                    dailyData[date].add(schedule.employeeId);
                });
                
                const dates = Object.keys(dailyData).sort();
                const coverageRates = dates.map(date => {
                    const assigned = dailyData[date].size;
                    return (assigned / req.required) * 100;
                });
                
                if (dates.length > 0) {
                    datasets.push({
                        label: req.name,
                        data: coverageRates,
                        borderColor: colors[index % colors.length],
                        backgroundColor: colors[index % colors.length] + '20',
                        fill: false,
                        tension: 0.4
                    });
                }
            });
            
            trendChart.data.labels = Object.keys(schedules.reduce((acc, s) => {
                acc[s.date] = true;
                return acc;
            }, {})).sort();
            trendChart.data.datasets = datasets;
            trendChart.update();
        }
        
        // Update coverage matrix
        function updateCoverageMatrix(schedules) {
            const container = document.getElementById('coverageMatrix');
            container.innerHTML = '';
            
            // 日付範囲を取得
            const dates = [...new Set(schedules.map(s => s.date))].sort();
            const hours = Array.from({length: 24}, (_, i) => i);
            
            if (dates.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">分析期間内にデータがありません</p>';
                return;
            }
            
            // 時間ヘッダー
            const headerRow = document.createElement('div');
            headerRow.className = 'flex mb-2';
            headerRow.innerHTML = `
                <div class="w-20 text-right pr-2 text-sm font-medium">日付</div>
                ${hours.map(h => `<div class="flex-1 text-center text-xs">${h}</div>`).join('')}
            `;
            container.appendChild(headerRow);
            
            // 各日付の行
            dates.forEach(date => {
                const row = document.createElement('div');
                row.className = 'flex items-center mb-1';
                
                const dateLabel = document.createElement('div');
                dateLabel.className = 'w-20 text-right pr-2 text-sm';
                dateLabel.textContent = new Date(date).toLocaleDateString('ja-JP', {month: '2-digit', day: '2-digit'});
                row.appendChild(dateLabel);
                
                const matrixRow = document.createElement('div');
                matrixRow.className = 'coverage-matrix flex-1';
                
                hours.forEach(hour => {
                    // その時間帯の配置人数を計算
                    const hourlyCount = schedules.filter(schedule => {
                        if (schedule.date !== date) return false;
                        const startHour = parseInt(schedule.startTime.split(':')[0]);
                        const endHour = parseInt(schedule.endTime.split(':')[0]);
                        return hour >= startHour && hour <= endHour;
                    }).length;
                    
                    // 充足率を計算（簡化版 - 全部門の平均必要人数を基準）
                    const avgRequired = Object.values(departmentRequirements).reduce((sum, req) => sum + req.required, 0) / Object.keys(departmentRequirements).length;
                    const coverage = avgRequired > 0 ? (hourlyCount / avgRequired) * 100 : 0;
                    
                    const cell = document.createElement('div');
                    cell.className = 'matrix-cell';
                    
                    if (coverage >= 100) cell.classList.add('coverage-over-100');
                    else if (coverage >= 81) cell.classList.add('coverage-81-100');
                    else if (coverage >= 61) cell.classList.add('coverage-61-80');
                    else if (coverage >= 31) cell.classList.add('coverage-31-60');
                    else cell.classList.add('coverage-0-30');
                    
                    cell.textContent = hourlyCount;
                    cell.title = `${date} ${hour}:00 - 配置人数: ${hourlyCount}人, 充足率: ${coverage.toFixed(1)}%`;
                    
                    matrixRow.appendChild(cell);
                });
                
                row.appendChild(matrixRow);
                container.appendChild(row);
            });
        }
        
        // Update analysis table
        function updateAnalysisTable(coverageData, threshold) {
            const tbody = document.getElementById('analysisTableBody');
            tbody.innerHTML = '';
            
            Object.entries(coverageData).forEach(([deptId, data]) => {
                const statusClass = data.coverage >= 80 ? 'text-green-600' : 
                                  data.coverage >= threshold ? 'text-yellow-600' : 'text-red-600';
                const statusText = data.coverage >= 80 ? '良好' : 
                                 data.coverage >= threshold ? '注意' : '不足';
                
                const trendIcon = data.trend === 'up' ? 'fa-arrow-up text-green-600' : 
                               data.trend === 'down' ? 'fa-arrow-down text-red-600' : 
                               'fa-minus text-gray-600';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${data.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${data.required}人</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${data.assigned}人</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold ${statusClass}">${data.coverage.toFixed(1)}%</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${data.shortage > 0 ? `${data.shortage}人不足` : 
                          data.assigned > data.required ? `${data.assigned - data.required}人過剰` : '適正'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${statusClass}">${statusText}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <i class="fas ${trendIcon}"></i>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Update recommendations
        function updateRecommendations(coverageData, threshold) {
            const container = document.getElementById('recommendations');
            container.innerHTML = '';
            
            const recommendations = [];
            
            Object.values(coverageData).forEach(dept => {
                if (dept.coverage < threshold) {
                    recommendations.push({
                        type: 'warning',
                        icon: 'fas fa-exclamation-triangle text-red-600',
                        title: `${dept.name}の人員不足`,
                        message: `${dept.shortage}人の追加配置が必要です。現在の充足率: ${dept.coverage.toFixed(1)}%`
                    });
                } else if (dept.coverage > 120) {
                    recommendations.push({
                        type: 'info',
                        icon: 'fas fa-info-circle text-blue-600',
                        title: `${dept.name}の人員過剰`,
                        message: `${dept.assigned - dept.required}人の再配置を検討してください。現在の充足率: ${dept.coverage.toFixed(1)}%`
                    });
                }
            });
            
            if (recommendations.length === 0) {
                recommendations.push({
                    type: 'success',
                    icon: 'fas fa-check-circle text-green-600',
                    title: '配置状況良好',
                    message: '全部門の充足率が適正範囲内です。'
                });
            }
            
            recommendations.forEach(rec => {
                const item = document.createElement('div');
                item.className = `flex items-start space-x-3 p-4 rounded-lg ${
                    rec.type === 'warning' ? 'bg-red-50' : 
                    rec.type === 'info' ? 'bg-blue-50' : 'bg-green-50'
                }`;
                item.innerHTML = `
                    <i class="${rec.icon} mt-1"></i>
                    <div>
                        <h4 class="font-medium text-gray-900">${rec.title}</h4>
                        <p class="text-sm text-gray-600 mt-1">${rec.message}</p>
                    </div>
                `;
                container.appendChild(item);
            });
        }
        
        // Check and show alerts
        function checkAndShowAlerts(coverageData, threshold) {
            const insufficientDepts = Object.values(coverageData).filter(dept => dept.coverage < threshold);
            
            if (insufficientDepts.length > 0) {
                const alertBanner = document.getElementById('alertBanner');
                const alertMessage = document.getElementById('alertMessage');
                
                alertMessage.textContent = `${insufficientDepts.length}の部門で人員不足が発生しています`;
                alertBanner.classList.remove('hidden');
                
                // アラートバッジをアニメーション
                setTimeout(() => {
                    const badges = document.querySelectorAll('.alert-badge');
                    badges.forEach(badge => badge.classList.add('animate-pulse'));
                }, 100);
            }
        }
        
        // Hide alert
        function hideAlert() {
            document.getElementById('alertBanner').classList.add('hidden');
        }
        
        // Reset analysis
        function resetAnalysis() {
            document.getElementById('analysisType').value = 'overall';
            document.getElementById('coverageThreshold').value = '70';
            setupDateInputs();
            
            // Clear all displays
            document.getElementById('avgCoverageRate').textContent = '0%';
            document.getElementById('sufficientDepts').textContent = '0';
            document.getElementById('insufficientDepts').textContent = '0';
            document.getElementById('totalShortage').textContent = '0人';
            
            // Clear charts
            if (coverageComparisonChart) {
                coverageComparisonChart.data.labels = [];
                coverageComparisonChart.data.datasets[0].data = [];
                coverageComparisonChart.data.datasets[1].data = [];
                coverageComparisonChart.update();
            }
            
            if (trendChart) {
                trendChart.data.labels = [];
                trendChart.data.datasets = [];
                trendChart.update();
            }
            
            // Clear other displays
            document.getElementById('departmentCards').innerHTML = '';
            document.getElementById('coverageMatrix').innerHTML = '';
            document.getElementById('analysisTableBody').innerHTML = '';
            document.getElementById('recommendations').innerHTML = '';
            hideAlert();
        }
        
        // Export coverage report
        function exportCoverageReport() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                alert('期間を指定してから出力してください。');
                return;
            }
            
            const threshold = parseInt(document.getElementById('coverageThreshold').value);
            const filteredSchedules = filterSchedules(startDate, endDate);
            const coverageData = calculateCoverageData(filteredSchedules, 'overall');
            
            // Create CSV content
            let csvContent = '\uFEFF'; // BOM for UTF-8
            csvContent += '部門別充足率分析レポート\n';
            csvContent += `分析期間: ${startDate} - ${endDate}\n`;
            csvContent += `アラート閾値: ${threshold}%\n`;
            csvContent += `生成日時: ${new Date().toLocaleString('ja-JP')}\n\n`;
            
            // Overview statistics
            const departments = Object.values(coverageData);
            const avgCoverage = departments.reduce((sum, dept) => sum + dept.coverage, 0) / departments.length;
            const sufficientDepts = departments.filter(dept => dept.coverage >= threshold).length;
            const totalShortage = departments.reduce((sum, dept) => sum + dept.shortage, 0);
            
            csvContent += '概要統計\n';
            csvContent += `平均充足率,${avgCoverage.toFixed(1)}%\n`;
            csvContent += `充足部門数,${sufficientDepts}部門\n`;
            csvContent += `不足部門数,${departments.length - sufficientDepts}部門\n`;
            csvContent += `総不足人数,${totalShortage}人\n\n`;
            
            // Department details
            csvContent += '部門別詳細\n';
            csvContent += '部門名,必要人数,配置人数,充足率,過不足,ステータス\n';
            
            Object.values(coverageData).forEach(dept => {
                const statusText = dept.coverage >= 80 ? '良好' : 
                                 dept.coverage >= threshold ? '注意' : '不足';
                const shortage = dept.shortage > 0 ? `${dept.shortage}人不足` : 
                               dept.assigned > dept.required ? `${dept.assigned - dept.required}人過剰` : '適正';
                
                csvContent += `${dept.name},${dept.required}人,${dept.assigned}人,${dept.coverage.toFixed(1)}%,${shortage},${statusText}\n`;
            });
            
            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `部門別充足率分析_${startDate}_${endDate}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
