<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>個人別タイムライン - CEスケジュール管理システム V2</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/theme-unified.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #E8F5E8 0%, #D4F1D4 100%);
            --accent-color: #B8E6B8;
            --text-color: #2C3E50;
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        body {
            background: var(--primary-gradient);
            font-family: 'Segoe UI', 'Hiragino Sans', 'Yu Gothic UI', sans-serif;
            color: var(--text-color);
            min-height: 100vh;
        }

        .glassmorphism {
            background: rgba(255,255,255,0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-primary {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 20px;
            font-weight: 600;
            box-shadow: var(--shadow);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .btn-primary:hover { 
            transform: translateY(-1px); 
            box-shadow: 0 6px 18px rgba(0,0,0,0.15); 
        }

        .filter-section {
            background: rgba(255,255,255,0.9);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .auth-error {
            background: #fee2e2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 16px;
            margin: 20px;
            color: #991b1b;
        }

        @media print {
            body { 
                background: white !important; 
                color: #000 !important; 
            }
            .no-print { 
                display: none !important; 
            }
            .glassmorphism { 
                background: white !important; 
                border: 1px solid #ccc !important; 
            }
        }

        @media (max-width: 768px) {
            .filter-section {
                padding: 12px;
            }
            .ce-filter-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div id="authWarning" class="auth-error" style="display: none;">
        <h3><i class="fas fa-exclamation-triangle mr-2"></i>認証エラー</h3>
        <p>このページにアクセスするには、まず<a href="../dashboard.html" class="underline font-bold">ダッシュボード</a>からログインしてください。</p>
    </div>

    <div class="container mx-auto p-4 max-w-7xl">
        <!-- ヘッダー -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 no-print">
            <div>
                <h1 class="text-3xl font-bold mb-2">
                    <i class="fas fa-user-clock mr-3 text-blue-600"></i>個人別タイムライン
                </h1>
                <p class="text-gray-600">CE個人ごとの業務時間分析（V1版準拠・重複除外）</p>
            </div>
            <div class="flex gap-3 mt-4 md:mt-0">
                <button onclick="window.print()" class="btn-primary">
                    <i class="fas fa-print mr-2"></i>印刷
                </button>
                <button onclick="history.back()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                    <i class="fas fa-arrow-left mr-2"></i>戻る
                </button>
            </div>
        </div>

        <!-- フィルター・設定セクション -->
        <div class="filter-section no-print">
            <h3 class="text-lg font-bold mb-4">
                <i class="fas fa-filter mr-2"></i>表示設定
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium mb-2">開始日</label>
                    <input type="date" id="startDate" class="w-full p-3 border border-gray-300 rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">終了日</label>
                    <input type="date" id="endDate" class="w-full p-3 border border-gray-300 rounded-lg">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium mb-2">表示CE</label>
                    <div class="flex flex-wrap gap-2 mb-2">
                        <label class="flex items-center">
                            <input type="checkbox" id="selectAllCEs" checked>
                            <span class="ml-2 font-bold">全CE選択</span>
                        </label>
                    </div>
                    <div id="ceFilterContainer" class="max-h-32 overflow-y-auto grid grid-cols-2 md:grid-cols-3 gap-1 ce-filter-grid">
                        <!-- CEリストは動的生成 -->
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2">表示部門</label>
                    <div class="flex flex-wrap gap-2">
                        <label class="flex items-center">
                            <input type="checkbox" class="department-filter" value="all" checked>
                            <span class="ml-2 font-bold">全部門</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" class="department-filter" value="血液浄化" checked>
                            <span class="ml-2">血液浄化</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" class="department-filter" value="人工心肺・補助循環" checked>
                            <span class="ml-2">人工心肺・補助循環</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" class="department-filter" value="心・カテーテル" checked>
                            <span class="ml-2">心・カテーテル</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" class="department-filter" value="手術・麻酔" checked>
                            <span class="ml-2">手術・麻酔</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" class="department-filter" value="不整脈" checked>
                            <span class="ml-2">不整脈</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" class="department-filter" value="機器管理・人工呼吸" checked>
                            <span class="ml-2">機器管理・人工呼吸</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" class="department-filter" value="会議・ミーティング・勉強会・打ち合わせ" checked>
                            <span class="ml-2">会議・勉強会</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="flex gap-3">
                <button id="applyFiltersBtn" class="btn-primary">
                    <i class="fas fa-search mr-2"></i>表示更新
                </button>
                <button id="resetFiltersBtn" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                    <i class="fas fa-undo mr-2"></i>リセット
                </button>
                <button id="currentWeekBtn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                    <i class="fas fa-calendar-week mr-2"></i>今週表示
                </button>
            </div>
        </div>

        <!-- V1版準拠の個人別業務時間グラフ -->
        <div class="glassmorphism rounded-2xl p-6 mb-6">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-lg font-bold">
                    <i class="fas fa-chart-bar mr-2"></i>個人別業務時間（時間）- V1版準拠
                </h3>
                <button class="btn-primary text-sm" onclick="printCanvas('individualChart')">
                    <i class="fas fa-print mr-1"></i>印刷
                </button>
            </div>
            <div class="h-96">
                <canvas id="individualChart"></canvas>
            </div>
        </div>

        <!-- サマリー情報 -->
        <div id="summarySection" class="glassmorphism rounded-2xl p-4 mb-6">
            <h3 class="text-lg font-bold mb-3">
                <i class="fas fa-info-circle mr-2"></i>集計サマリー
            </h3>
            <div id="summaryContent" class="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm">
                <!-- JavaScriptで動的生成 -->
            </div>
        </div>

        <!-- ローディング表示 -->
        <div id="loadingIndicator" class="text-center py-8" style="display: none;">
            <i class="fas fa-spinner fa-spin text-2xl text-blue-600"></i>
            <p class="mt-2 text-gray-600">データを読み込み中...</p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
        // 認証チェック機能
        function checkAuthenticationStatus() {
            let targetUID = sessionStorage.getItem('targetUID');
            let currentUsername = sessionStorage.getItem('currentUsername');

            if (!targetUID || !currentUsername) {
                const params = new URLSearchParams(location.search);
                const qpUid = params.get('uid');
                const qpUsername = params.get('username') || params.get('user');
                const qpRole = params.get('role');

                if (qpUid && qpUsername) {
                    targetUID = qpUid;
                    currentUsername = qpUsername;
                    try {
                        sessionStorage.setItem('targetUID', qpUid);
                        sessionStorage.setItem('currentUsername', qpUsername);
                        sessionStorage.setItem('currentUser', qpUsername);
                        if (qpRole) sessionStorage.setItem('userRole', qpRole);
                        console.log('✅ URLパラメータから認証情報を復元');
                    } catch (e) {
                        console.warn('sessionStorage保存エラー:', e);
                    }
                }
            }

            if (!targetUID || !currentUsername) {
                console.warn('⚠️ 認証情報が見つかりません。ダッシュボードからアクセスしてください。');
                document.getElementById('authWarning').style.display = 'block';
                return false;
            }

            console.log('✅ 認証情報確認完了');
            document.getElementById('authWarning').style.display = 'none';
            return true;
        }

        // Firebase設定
        const firebaseConfig = {
            apiKey: "AIzaSyCRUvvs0OSz_9L9bXtqteVFIIze1OaZObE",
            authDomain: "ce-scheduling-system-v2.firebaseapp.com",
            databaseURL: "https://ce-scheduling-system-v2-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ce-scheduling-system-v2",
            storageBucket: "ce-scheduling-system-v2.firebasestorage.app",
            messagingSenderId: "288279598010",
            appId: "1:288279598010:web:d545ee1d4d854513084383",
            measurementId: "G-LSEEMJE2R0"
        };

        // グローバル変数
        let database = null;
        let authReadyPromise = null;
        let globalCEList = [];
        let currentDateRange = [];
        let chartInstance = null;
        let CE_UNIFIED_MAP = new Map();

        const DATA_ROOT = 'ceScheduleV2';

        // 部門設定（拡張版）
        const DEPARTMENTS = [
            '血液浄化', '人工心肺・補助循環', '心・カテーテル', 
            '手術・麻酔', '不整脈', '機器管理・人工呼吸',
            '会議・ミーティング・勉強会・打ち合わせ'
        ];

        // V1版準拠の重複除外計算（分単位タイムスロット方式）
        function collectMinuteMapV1Style(filteredCEs, selectedDepartments, eventsByDate) {
            const ceKeys = new Set(filteredCEs.map(c => c.key));
            const minuteMap = new Map();

            currentDateRange.forEach(date => {
                const dateKey = formatDateAsISO(date);
                const dayEvents = eventsByDate[dateKey] || {};

                Object.values(dayEvents).forEach(event => {
                    // 部門絞り込み
                    if (selectedDepartments.length && !selectedDepartments.includes(event.department)) return;

                    // 時刻未設定は集計対象外
                    if (!event.startTime || !event.endTime) return;

                    const startMinutes = timeToMinutes(event.startTime);
                    const endMinutes = timeToMinutes(event.endTime);
                    if (!(Number.isFinite(startMinutes) && Number.isFinite(endMinutes)) || endMinutes <= startMinutes) return;

                    const assignedCEs = event.assignedCEs || [];
                    if (!assignedCEs.length) return;

                    assignedCEs.forEach(assignedCE => {
                        let ceKey = '';
                        if (typeof assignedCE === 'string') {
                            ceKey = normalizeCEKey({ name: assignedCE });
                        } else if (assignedCE && typeof assignedCE === 'object') {
                            ceKey = assignedCE.key || normalizeCEKey(assignedCE);
                        }

                        if (!ceKey || !ceKeys.has(ceKey)) return;

                        if (!minuteMap.has(ceKey)) minuteMap.set(ceKey, new Map());
                        const dayMap = minuteMap.get(ceKey);
                        if (!dayMap.has(dateKey)) dayMap.set(dateKey, new Map());
                        const minuteSet = dayMap.get(dateKey);

                        // V1版準拠：分単位で重複除外
                        for (let minute = startMinutes; minute < endMinutes; minute++) {
                            if (!minuteSet.has(minute)) minuteSet.set(minute, new Set());
                            minuteSet.get(minute).add(event.department);
                        }
                    });
                });
            });

            return minuteMap;
        }

        // V1版準拠の総実労働時間計算
        function computeTotalHoursV1Style(minuteMap, filteredCEs) {
            const totalHoursByCE = [];
            const dayWiseData = {};

            filteredCEs.forEach(ce => {
                const ceKey = ce.key;
                const dayMap = minuteMap.get(ceKey) || new Map();

                let uniqueMinutes = 0;
                const daySchedules = {};

                // 日別業務数の集計（V1版ツールチップ用）
                currentDateRange.forEach(date => {
                    const dateKey = formatDateAsISO(date);
                    const minuteSet = dayMap.get(dateKey) || new Map();
                    
                    daySchedules[dateKey] = minuteSet.size > 0 ? Array.from(minuteSet.keys()).length : 0;
                    uniqueMinutes += minuteSet.size;
                });

                const totalHours = Math.round((uniqueMinutes / 60) * 10) / 10;
                totalHoursByCE.push({ 
                    key: ceKey, 
                    name: ce.name, 
                    hours: totalHours,
                    daySchedules: daySchedules
                });
            });

            // V1版準拠：時間降順ソート
            totalHoursByCE.sort((a, b) => b.hours - a.hours);

            return totalHoursByCE;
        }

        // V1版準拠のChart.js個人別業務時間グラフ生成
        function generateIndividualChartV1Style(filteredCEs, selectedDepartments, eventsByDate) {
            const ctx = document.getElementById('individualChart');
            if (!ctx) return;

            // 既存チャートを破棄
            if (chartInstance) {
                chartInstance.destroy();
            }

            const minuteMap = collectMinuteMapV1Style(filteredCEs, selectedDepartments, eventsByDate);
            const totalHoursByCE = computeTotalHoursV1Style(minuteMap, filteredCEs);

            const labels = totalHoursByCE.map(item => item.name);
            const data = totalHoursByCE.map(item => item.hours);

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '実労働時間(時間)',
                        data: data,
                        backgroundColor: 'rgba(76, 175, 80, 0.6)',
                        borderColor: 'rgba(76, 175, 80, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y', // V1版準拠：横棒グラフ
                    scales: {
                        x: { 
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '時間（重複除外済み）'
                            }
                        },
                        y: {
                            ticks: {
                                autoSkip: false,
                                maxRotation: 0,
                                minRotation: 0,
                                font: { size: 11 }
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const ceName = context.label;
                                    const hours = context.parsed.x;
                                    const ceInfo = totalHoursByCE.find(item => item.name === ceName);
                                    
                                    let tooltip = `実労働時間: ${hours}時間`;
                                    
                                    if (ceInfo && ceInfo.daySchedules) {
                                        const dayLabels = ['日', '月', '火', '水', '木', '金', '土'];
                                        const dayTaskCounts = [];
                                        let totalTasks = 0;
                                        
                                        currentDateRange.forEach(date => {
                                            const dateKey = formatDateAsISO(date);
                                            const tasksOnDay = ceInfo.daySchedules[dateKey] || 0;
                                            dayTaskCounts.push(tasksOnDay);
                                            totalTasks += tasksOnDay;
                                        });
                                        
                                        if (totalTasks > 0) {
                                            tooltip += `\n総業務数: ${totalTasks}件`;
                                            const dayTaskSummary = currentDateRange.map((date, idx) => {
                                                const dayShortName = dayLabels[date.getDay()];
                                                return `${dayShortName}${dayTaskCounts[idx]}`;
                                            }).join(' ');
                                            tooltip += `\n曜日別: ${dayTaskSummary}`;
                                        }
                                    }
                                    
                                    return tooltip;
                                }
                            }
                        }
                    }
                }
            });

            console.log('✅ V1版準拠個人別業務時間チャート生成完了');
        }

        // 統合CEリスト構築
        function buildUnifiedCEList(eventsByDate, ceListRaw) {
            CE_UNIFIED_MAP.clear();
            const ceMap = new Map();

            // 1) ceListから基本情報を取得
            if (ceListRaw && typeof ceListRaw === 'object') {
                Object.entries(ceListRaw).forEach(([key, ce]) => {
                    const normalizedKey = normalizeCEKey({ id: ce.id || key, name: ce.iconName || ce.displayName || ce.name });
                    if (!normalizedKey) return;
                    
                    const ceData = {
                        key: normalizedKey,
                        id: ce.id || key,
                        name: ce.iconName || ce.displayName || ce.name || key,
                        fullName: ce.fullName || ce.name || ce.iconName || ce.displayName || key,
                        workType: ce.workType || 'ME'
                    };
                    
                    ceMap.set(normalizedKey, ceData);
                    CE_UNIFIED_MAP.set(normalizedKey, ceData.name);
                });
            }

            // 2) events.assignedCEsから配置情報を取得
            Object.values(eventsByDate || {}).forEach(dayEvents => {
                Object.values(dayEvents || {}).forEach(ev => {
                    (ev.assignedCEs || []).forEach(assigned => {
                        let id = '', name = '', workType = 'ME';
                        if (typeof assigned === 'string') {
                            id = assigned; name = assigned;
                        } else if (assigned && typeof assigned === 'object') {
                            id = assigned.id || assigned.name || '';
                            name = assigned.name || assigned.id || '';
                            workType = assigned.workType || 'ME';
                        }
                        
                        const key = normalizeCEKey({ id, name });
                        if (!key) return;
                        
                        if (!ceMap.has(key)) {
                            const ceData = {
                                key: key,
                                id: id || name,
                                name: name || id,
                                fullName: name || id,
                                workType: workType
                            };
                            ceMap.set(key, ceData);
                            CE_UNIFIED_MAP.set(key, ceData.name);
                        }
                    });
                });
            });

            return Array.from(ceMap.values()).sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        }

        // CEキー正規化
        function normalizeCEKey(ceData) {
            if (!ceData) return '';
            const raw = (ceData.id || ceData.name || ceData.fullName || ceData.iconName || ceData.displayName || '').toString();
            return raw.trim();
        }

        function initializeFirebase() {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                database = firebase.database();

                authReadyPromise = new Promise((resolve, reject) => {
                    firebase.auth().onAuthStateChanged(user => {
                        if (user) {
                            console.log('✅ Firebase認証完了:', user.uid);
                            resolve(user);
                        }
                    }, err => {
                        console.error('❌ Firebase認証エラー:', err);
                        reject(err);
                    });
                });

                firebase.auth().signInAnonymously().catch((error) => {
                    console.error('❌ Firebase匿名認証エラー:', error);
                    document.getElementById('authWarning').style.display = 'block';
                });
                    
            } catch (error) {
                console.error('❌ Firebase初期化エラー:', error);
                document.getElementById('authWarning').style.display = 'block';
            }
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🔄 個人別タイムライン初期化開始（V1版準拠）');
            
            if (!checkAuthenticationStatus()) return;
            
            initializeFirebase();
            setupEventListeners();
            setCurrentWeekRange();
            
            try {
                if (authReadyPromise) {
                    await authReadyPromise;
                } else {
                    let authUser = firebase.auth().currentUser;
                    let attempts = 0;
                    
                    while (!authUser && attempts < 30) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                        authUser = firebase.auth().currentUser;
                        attempts++;
                    }
                    
                    if (!authUser) {
                        throw new Error('Firebase認証がタイムアウトしました');
                    }
                }
                
                await loadTimelineData();
                
            } catch (error) {
                console.error('❌ 初期読み込みエラー:', error);
                showMessage(`データの読み込みに失敗しました: ${error.message}`, 'error');
            }
        });

        function setupEventListeners() {
            document.getElementById('applyFiltersBtn').addEventListener('click', loadTimelineData);
            document.getElementById('resetFiltersBtn').addEventListener('click', resetFilters);
            document.getElementById('currentWeekBtn').addEventListener('click', setCurrentWeekAndLoad);
            
            // 部門フィルターのイベントリスナー
            setTimeout(() => {
                const allDeptCheckbox = document.querySelector('.department-filter[value="all"]');
                if (allDeptCheckbox) {
                    allDeptCheckbox.addEventListener('change', function() {
                        const isChecked = this.checked;
                        document.querySelectorAll('.department-filter:not([value="all"])').forEach(cb => {
                            cb.checked = isChecked;
                        });
                    });
                }
                
                document.querySelectorAll('.department-filter:not([value="all"])').forEach(cb => {
                    cb.addEventListener('change', updateAllDepartmentCheckbox);
                });
            }, 100);
        }

        function setCurrentWeekRange() {
            const today = new Date();
            const dayFromMonday = (today.getDay() + 6) % 7;

            const startDate = new Date(today);
            startDate.setHours(0, 0, 0, 0);
            startDate.setDate(today.getDate() - dayFromMonday);

            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6);

            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
        }

        function setCurrentWeekAndLoad() {
            setCurrentWeekRange();
            loadTimelineData();
        }

        async function loadTimelineData() {
            showLoading(true);
            console.log('🔄 個人別タイムライン読み込み開始（V1版準拠）');
            
            try {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                if (!startDate || !endDate) {
                    showMessage('開始日と終了日を選択してください', 'warning');
                    return;
                }
                
                currentDateRange = generateDateRange(startDate, endDate);
                
                await loadDataFromFirebase();
                generateCEFilterList();
                
                console.log('✅ 個人別タイムライン読み込み完了（V1版準拠）');
                
            } catch (error) {
                console.error('❌ タイムライン読み込みエラー:', error);
                showMessage('データの読み込みに失敗しました', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function loadDataFromFirebase() {
            if (!database) {
                throw new Error('Firebase未接続');
            }
            
            try {
                const [eventsByDateSnapshot, ceListSnapshot] = await Promise.all([
                    database.ref(`${DATA_ROOT}/events/byDate`).once('value'),
                    database.ref(`${DATA_ROOT}/ceList`).once('value')
                ]);
                
                const eventsByDate = eventsByDateSnapshot.val() || {};
                const ceListRaw = ceListSnapshot.val() || {};

                // 統合CEリスト構築
                globalCEList = buildUnifiedCEList(eventsByDate, ceListRaw);
                console.log('📊 統合CEリスト:', globalCEList.length, '件');
                
                // 初期表示
                const selectedCEs = getSelectedCEs();
                const selectedDepartments = getSelectedDepartments();
                const filteredCEs = globalCEList.filter(ce => selectedCEs.includes(ce.key));
                
                generateIndividualChartV1Style(filteredCEs, selectedDepartments, eventsByDate);
                updateSummary(filteredCEs, selectedDepartments, eventsByDate);
                
            } catch (error) {
                console.error('❌ Firebase読み込みエラー:', error);
                throw error;
            }
        }

        function generateCEFilterList() {
            const container = document.getElementById('ceFilterContainer');
            if (!container || !globalCEList) return;
            
            container.innerHTML = '';
            
            globalCEList.forEach(ce => {
                const label = document.createElement('label');
                label.className = 'flex items-center text-sm';
                label.title = `${ce.fullName} (${ce.workType})`;
                label.innerHTML = `
                    <input type="checkbox" class="ce-filter" value="${ce.key}" checked>
                    <span class="ml-1 truncate">${ce.name}</span>
                `;
                container.appendChild(label);
            });

            // イベントリスナー設定
            const selectAllCEs = document.getElementById('selectAllCEs');
            if (selectAllCEs) {
                selectAllCEs.addEventListener('change', function() {
                    const isChecked = this.checked;
                    container.querySelectorAll('.ce-filter').forEach(cb => cb.checked = isChecked);
                });
            }
            
            container.querySelectorAll('.ce-filter').forEach(cb => {
                cb.addEventListener('change', updateAllCECheckbox);
            });
        }

        function updateAllCECheckbox() {
            const allCheckbox = document.getElementById('selectAllCEs');
            const ceCheckboxes = document.querySelectorAll('.ce-filter');
            const checkedCount = document.querySelectorAll('.ce-filter:checked').length;
            
            if (allCheckbox) {
                allCheckbox.checked = checkedCount === ceCheckboxes.length;
            }
        }

        function updateAllDepartmentCheckbox() {
            const allCheckbox = document.querySelector('.department-filter[value="all"]');
            const deptCheckboxes = document.querySelectorAll('.department-filter:not([value="all"])');
            const checkedCount = document.querySelectorAll('.department-filter:not([value="all"]):checked').length;
            
            if (allCheckbox) {
                allCheckbox.checked = checkedCount === deptCheckboxes.length;
            }
        }

        function generateDateRange(startDateStr, endDateStr) {
            const dates = [];
            const startDate = new Date(startDateStr + 'T00:00:00');
            const endDate = new Date(endDateStr + 'T00:00:00');
            
            const current = new Date(startDate);
            
            while (current <= endDate) {
                dates.push(new Date(current));
                current.setDate(current.getDate() + 1);
            }
            
            return dates;
        }

        function getSelectedCEs() {
            return Array.from(document.querySelectorAll('.ce-filter:checked')).map(cb => cb.value);
        }

        function getSelectedDepartments() {
            const list = Array.from(document.querySelectorAll('.department-filter:not([value="all"]):checked')).map(cb => cb.value);
            return list.length > 0 ? list : DEPARTMENTS;
        }

        function timeToMinutes(timeString) {
            if (!timeString || !/^\d{1,2}:\d{2}$/.test(timeString)) return 0;
            const [hours, minutes] = timeString.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function formatDateAsISO(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function showLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
        }

        function showMessage(message, type = 'info') {
            console.log(`${type.toUpperCase()}: ${message}`);
            alert(message);
        }

        function resetFilters() {
            setCurrentWeekRange();
            document.querySelectorAll('.ce-filter, .department-filter').forEach(cb => cb.checked = true);
            document.getElementById('selectAllCEs').checked = true;
            loadTimelineData();
        }

        function updateSummary(filteredCEs, selectedDepartments, eventsByDate) {
            const summaryContent = document.getElementById('summaryContent');
            
            const minuteMap = collectMinuteMapV1Style(filteredCEs, selectedDepartments, eventsByDate);
            const totalHoursByCE = computeTotalHoursV1Style(minuteMap, filteredCEs);

            let totalTasks = 0;
            let totalWorkHours = 0;
            let activeCEs = 0;

            totalHoursByCE.forEach(item => {
                if (item.hours > 0) {
                    activeCEs++;
                    totalWorkHours += item.hours;
                    
                    Object.values(item.daySchedules).forEach(dayTasks => {
                        totalTasks += dayTasks;
                    });
                }
            });

            summaryContent.innerHTML = `
                <div class="bg-white bg-opacity-70 p-3 rounded-lg text-center">
                    <div class="font-bold text-lg text-blue-600">${filteredCEs.length}</div>
                    <div class="text-xs text-gray-600">表示CE数</div>
                </div>
                <div class="bg-white bg-opacity-70 p-3 rounded-lg text-center">
                    <div class="font-bold text-lg text-green-600">${activeCEs}</div>
                    <div class="text-xs text-gray-600">配置ありCE</div>
                </div>
                <div class="bg-white bg-opacity-70 p-3 rounded-lg text-center">
                    <div class="font-bold text-lg text-purple-600">${totalTasks}</div>
                    <div class="text-xs text-gray-600">総業務配置数</div>
                </div>
                <div class="bg-white bg-opacity-70 p-3 rounded-lg text-center">
                    <div class="font-bold text-lg text-orange-600">${Math.round(totalWorkHours*10)/10}h</div>
                    <div class="text-xs text-gray-600">総実労働時間（重複除外）</div>
                </div>
            `;
        }

        // キャンバス印刷機能
        function printCanvas(canvasId) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            const printWindow = window.open('', 'printCanvas');
            if (!printWindow) return;
            
            printWindow.document.write(`
                <html>
                    <head><title>個人別業務時間グラフ</title></head>
                    <body style="margin: 20px; text-align: center;">
                        <h2>個人別業務時間（V1版準拠・重複除外）</h2>
                        <img src="${canvas.toDataURL('image/png')}" style="max-width: 100%; height: auto;"/>
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        }

        console.log('✅ 個人別タイムライン V2（V1版準拠） 読み込み完了');
    </script>
</body>
</html>
