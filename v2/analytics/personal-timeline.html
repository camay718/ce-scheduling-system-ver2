<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>個人別タイムライン - CEスケジュール管理システムV2</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyCsSiWe1wfeY2Q63Nbda9gYhBzRm8c7OQ8",
            authDomain: "ce-schedule-system.firebaseapp.com",
            databaseURL: "https://ce-schedule-system-default-rtdb.firebaseio.com",
            projectId: "ce-schedule-system",
            storageBucket: "ce-schedule-system.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };
        
        const app = initializeApp(firebaseConfig);
        window.database = getDatabase(app);
        window.auth = getAuth(app);
        
        // Anonymous authentication
        signInAnonymously(window.auth).catch(console.error);
    </script>
    
    <style>
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; }
            .bg-gradient-to-br { background: white !important; }
            .shadow-lg { box-shadow: none !important; }
        }
        
        .timeline-chart {
            background: white;
            border-radius: 0.5rem;
            padding: 1rem;
        }
        
        .stats-card {
            transition: transform 0.2s;
        }
        
        .stats-card:hover {
            transform: translateY(-2px);
        }
        
        .employee-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b no-print">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <i class="fas fa-user-clock text-2xl text-blue-600"></i>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">個人別タイムライン</h1>
                        <p class="text-sm text-gray-600">CEスケジュール管理システムV2</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2 text-sm text-gray-600">
                        <i class="fas fa-user-circle"></i>
                        <span id="currentUser">読み込み中...</span>
                    </div>
                    <button onclick="window.location.href='dashboard.html'" 
                            class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg text-gray-700 transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>ダッシュボードに戻る
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Filter Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6 no-print">
            <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-filter mr-2 text-blue-600"></i>フィルター設定
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Employee Selection -->
                <div>
                    <label for="employeeSelect" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-user mr-1"></i>従業員選択
                    </label>
                    <select id="employeeSelect" 
                            class="employee-select w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">従業員を選択してください</option>
                    </select>
                </div>
                
                <!-- Date Range -->
                <div>
                    <label for="startDate" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-calendar-alt mr-1"></i>開始日
                    </label>
                    <input type="date" id="startDate" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div>
                    <label for="endDate" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-calendar-alt mr-1"></i>終了日
                    </label>
                    <input type="date" id="endDate" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <!-- Work Type Filter -->
                <div>
                    <label for="workTypeFilter" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-briefcase mr-1"></i>業務タイプ
                    </label>
                    <select id="workTypeFilter" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">すべての業務</option>
                        <option value="通常勤務">通常勤務</option>
                        <option value="残業">残業</option>
                        <option value="夜勤">夜勤</option>
                        <option value="休日出勤">休日出勤</option>
                    </select>
                </div>
            </div>
            
            <div class="flex flex-wrap gap-2 mt-4">
                <button onclick="applyFilters()" 
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                    <i class="fas fa-search mr-2"></i>分析実行
                </button>
                <button onclick="resetFilters()" 
                        class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                    <i class="fas fa-undo mr-2"></i>リセット
                </button>
                <button onclick="exportData()" 
                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                    <i class="fas fa-download mr-2"></i>データ出力
                </button>
                <button onclick="window.print()" 
                        class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors">
                    <i class="fas fa-print mr-2"></i>印刷
                </button>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
            <div class="stats-card bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">総勤務時間</p>
                        <p class="text-2xl font-bold text-blue-600" id="totalWorkHours">0時間</p>
                    </div>
                    <div class="bg-blue-100 p-3 rounded-full">
                        <i class="fas fa-clock text-blue-600 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="stats-card bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">シフト数</p>
                        <p class="text-2xl font-bold text-green-600" id="totalShifts">0</p>
                    </div>
                    <div class="bg-green-100 p-3 rounded-full">
                        <i class="fas fa-calendar-check text-green-600 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="stats-card bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">平均勤務時間</p>
                        <p class="text-2xl font-bold text-yellow-600" id="avgWorkHours">0時間</p>
                    </div>
                    <div class="bg-yellow-100 p-3 rounded-full">
                        <i class="fas fa-chart-line text-yellow-600 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="stats-card bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">所属部門</p>
                        <p class="text-lg font-bold text-purple-600" id="employeeDepartment">-</p>
                    </div>
                    <div class="bg-purple-100 p-3 rounded-full">
                        <i class="fas fa-building text-purple-600 text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Timeline Chart -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                    <i class="fas fa-chart-gantt mr-2 text-blue-600"></i>個人別勤務タイムライン
                </h2>
                <div class="text-sm text-gray-600" id="selectedEmployee">従業員を選択してください</div>
            </div>
            
            <div class="timeline-chart" style="height: 400px;">
                <canvas id="timelineChart"></canvas>
            </div>
        </div>

        <!-- Work Pattern Analysis -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-pie-chart mr-2 text-blue-600"></i>業務タイプ分布
                </h3>
                <canvas id="workTypeChart" style="height: 300px;"></canvas>
            </div>
            
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-chart-bar mr-2 text-blue-600"></i>時間帯別勤務頻度
                </h3>
                <canvas id="hourlyChart" style="height: 300px;"></canvas>
            </div>
        </div>

        <!-- Weekly Pattern -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-calendar-week mr-2 text-blue-600"></i>週間勤務パターン
            </h3>
            <canvas id="weeklyChart" style="height: 250px;"></canvas>
        </div>
    </main>

    <!-- Loading Modal -->
    <div id="loadingModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4">
            <div class="flex items-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mr-4"></div>
                <span class="text-gray-700">データを読み込み中...</span>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let timelineChart = null;
        let workTypeChart = null;
        let hourlyChart = null;
        let weeklyChart = null;
        let allSchedules = [];
        let allEmployees = [];
        let allDepartments = [];
        
        // Authentication check
        function checkAuth() {
            const user = sessionStorage.getItem('currentUser');
            if (!user) {
                alert('認証が必要です。ログインページにリダイレクトします。');
                window.location.href = 'login.html';
                return false;
            }
            
            document.getElementById('currentUser').textContent = user;
            return true;
        }
        
        // Initialize application
        async function init() {
            if (!checkAuth()) return;
            
            showLoading(true);
            
            try {
                await Promise.all([
                    loadEmployees(),
                    loadDepartments(),
                    loadSchedules()
                ]);
                
                setupDateInputs();
                initializeCharts();
            } catch (error) {
                console.error('初期化エラー:', error);
                alert('データの読み込みに失敗しました。ページをリロードしてください。');
            } finally {
                showLoading(false);
            }
        }
        
        // Load employees
        async function loadEmployees() {
            try {
                const { ref, get } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js');
                const snapshot = await get(ref(window.database, 'employees'));
                
                if (snapshot.exists()) {
                    allEmployees = Object.entries(snapshot.val()).map(([id, data]) => ({
                        id,
                        ...data
                    }));
                    
                    populateEmployeeSelect();
                }
            } catch (error) {
                console.error('従業員データの読み込みエラー:', error);
            }
        }
        
        // Load departments
        async function loadDepartments() {
            try {
                const { ref, get } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js');
                const snapshot = await get(ref(window.database, 'departments'));
                
                if (snapshot.exists()) {
                    allDepartments = Object.entries(snapshot.val()).map(([id, data]) => ({
                        id,
                        ...data
                    }));
                }
            } catch (error) {
                console.error('部門データの読み込みエラー:', error);
            }
        }
        
        // Load schedules
        async function loadSchedules() {
            try {
                const { ref, get } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js');
                const snapshot = await get(ref(window.database, 'schedules'));
                
                if (snapshot.exists()) {
                    allSchedules = Object.entries(snapshot.val()).map(([id, data]) => ({
                        id,
                        ...data
                    }));
                }
            } catch (error) {
                console.error('スケジュールデータの読み込みエラー:', error);
            }
        }
        
        // Populate employee select
        function populateEmployeeSelect() {
            const select = document.getElementById('employeeSelect');
            select.innerHTML = '<option value="">従業員を選択してください</option>';
            
            allEmployees.forEach(employee => {
                const option = document.createElement('option');
                option.value = employee.id;
                option.textContent = `${employee.name} (${employee.employeeId})`;
                select.appendChild(option);
            });
        }
        
        // Setup date inputs
        function setupDateInputs() {
            const startDate = document.getElementById('startDate');
            const endDate = document.getElementById('endDate');
            const today = new Date();
            const oneWeekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            startDate.value = oneWeekAgo.toISOString().split('T')[0];
            endDate.value = today.toISOString().split('T')[0];
        }
        
        // Show/hide loading
        function showLoading(show) {
            const modal = document.getElementById('loadingModal');
            if (show) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            } else {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }
        
        // Initialize charts
        function initializeCharts() {
            initializeTimelineChart();
            initializeWorkTypeChart();
            initializeHourlyChart();
            initializeWeeklyChart();
        }
        
        // Initialize timeline chart
        function initializeTimelineChart() {
            const ctx = document.getElementById('timelineChart').getContext('2d');
            
            timelineChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'hour',
                                displayFormats: {
                                    hour: 'HH:mm'
                                }
                            },
                            title: {
                                display: true,
                                text: '時間'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '日付'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const point = context[0];
                                    return point.label;
                                },
                                label: function(context) {
                                    const start = new Date(context.parsed.x);
                                    const end = new Date(start.getTime() + context.raw._custom.barEnd - context.raw._custom.barStart);
                                    return `${context.dataset.label}: ${start.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'})} - ${end.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'})}`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Initialize work type chart
        function initializeWorkTypeChart() {
            const ctx = document.getElementById('workTypeChart').getContext('2d');
            
            workTypeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#3B82F6',
                            '#10B981',
                            '#F59E0B',
                            '#EF4444',
                            '#8B5CF6'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // Initialize hourly chart
        function initializeHourlyChart() {
            const ctx = document.getElementById('hourlyChart').getContext('2d');
            
            hourlyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                    datasets: [{
                        label: '勤務頻度',
                        data: new Array(24).fill(0),
                        backgroundColor: '#3B82F6',
                        borderColor: '#1E40AF',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '勤務回数'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '時間帯'
                            }
                        }
                    }
                }
            });
        }
        
        // Initialize weekly chart
        function initializeWeeklyChart() {
            const ctx = document.getElementById('weeklyChart').getContext('2d');
            
            weeklyChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['月曜日', '火曜日', '水曜日', '木曜日', '金曜日', '土曜日', '日曜日'],
                    datasets: [{
                        label: '勤務時間 (時間)',
                        data: new Array(7).fill(0),
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderColor: '#3B82F6',
                        pointBackgroundColor: '#3B82F6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '勤務時間 (時間)'
                            }
                        }
                    }
                }
            });
        }
        
        // Apply filters
        function applyFilters() {
            const employeeId = document.getElementById('employeeSelect').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const workType = document.getElementById('workTypeFilter').value;
            
            if (!employeeId) {
                alert('従業員を選択してください。');
                return;
            }
            
            showLoading(true);
            
            try {
                const filteredSchedules = filterSchedules(employeeId, startDate, endDate, workType);
                updateCharts(filteredSchedules, employeeId);
                updateStatistics(filteredSchedules, employeeId);
            } catch (error) {
                console.error('フィルタ適用エラー:', error);
                alert('データの処理中にエラーが発生しました。');
            } finally {
                showLoading(false);
            }
        }
        
        // Filter schedules
        function filterSchedules(employeeId, startDate, endDate, workType) {
            return allSchedules.filter(schedule => {
                // Employee filter
                if (schedule.employeeId !== employeeId) return false;
                
                // Date range filter
                if (startDate && schedule.date < startDate) return false;
                if (endDate && schedule.date > endDate) return false;
                
                // Work type filter
                if (workType && schedule.workType !== workType) return false;
                
                return true;
            });
        }
        
        // Update charts
        function updateCharts(schedules, employeeId) {
            updateTimelineChart(schedules);
            updateWorkTypeChart(schedules);
            updateHourlyChart(schedules);
            updateWeeklyChart(schedules);
            
            // Update selected employee display
            const employee = allEmployees.find(e => e.id === employeeId);
            document.getElementById('selectedEmployee').textContent = 
                employee ? `${employee.name} (${employee.employeeId})` : '';
        }
        
        // Update timeline chart
        function updateTimelineChart(schedules) {
            const datasets = [];
            const workTypeColors = {
                '通常勤務': '#3B82F6',
                '残業': '#F59E0B',
                '夜勤': '#6366F1',
                '休日出勤': '#EF4444'
            };
            
            schedules.forEach(schedule => {
                const startTime = new Date(`${schedule.date}T${schedule.startTime}`);
                const endTime = new Date(`${schedule.date}T${schedule.endTime}`);
                
                datasets.push({
                    label: schedule.workType || '通常勤務',
                    data: [{
                        x: startTime,
                        y: schedule.date,
                        _custom: {
                            barStart: startTime.getTime(),
                            barEnd: endTime.getTime()
                        }
                    }],
                    backgroundColor: workTypeColors[schedule.workType] || '#3B82F6',
                    borderColor: workTypeColors[schedule.workType] || '#1E40AF',
                    borderWidth: 1,
                    barThickness: 20
                });
            });
            
            timelineChart.data.datasets = datasets;
            timelineChart.update();
        }
        
        // Update work type chart
        function updateWorkTypeChart(schedules) {
            const workTypeCounts = {};
            
            schedules.forEach(schedule => {
                const workType = schedule.workType || '通常勤務';
                workTypeCounts[workType] = (workTypeCounts[workType] || 0) + 1;
            });
            
            workTypeChart.data.labels = Object.keys(workTypeCounts);
            workTypeChart.data.datasets[0].data = Object.values(workTypeCounts);
            workTypeChart.update();
        }
        
        // Update hourly chart
        function updateHourlyChart(schedules) {
            const hourlyCounts = new Array(24).fill(0);
            
            schedules.forEach(schedule => {
                const startHour = parseInt(schedule.startTime.split(':')[0]);
                const endHour = parseInt(schedule.endTime.split(':')[0]);
                
                for (let hour = startHour; hour <= endHour; hour++) {
                    if (hour < 24) hourlyCounts[hour]++;
                }
            });
            
            hourlyChart.data.datasets[0].data = hourlyCounts;
            hourlyChart.update();
        }
        
        // Update weekly chart
        function updateWeeklyChart(schedules) {
            const weeklyHours = new Array(7).fill(0);
            
            schedules.forEach(schedule => {
                const date = new Date(schedule.date);
                const dayOfWeek = date.getDay();
                const mondayIndex = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
                
                const workHours = calculateWorkHours(schedule.startTime, schedule.endTime);
                weeklyHours[mondayIndex] += workHours;
            });
            
            weeklyChart.data.datasets[0].data = weeklyHours;
            weeklyChart.update();
        }
        
        // Update statistics
        function updateStatistics(schedules, employeeId) {
            const totalHours = schedules.reduce((sum, schedule) => {
                return sum + calculateWorkHours(schedule.startTime, schedule.endTime);
            }, 0);
            
            const totalShifts = schedules.length;
            const avgHours = totalShifts > 0 ? (totalHours / totalShifts).toFixed(1) : 0;
            
            // Get employee department
            const employee = allEmployees.find(e => e.id === employeeId);
            const department = employee ? 
                (allDepartments.find(d => d.id === employee.departmentId)?.name || '不明') : 
                '-';
            
            document.getElementById('totalWorkHours').textContent = `${totalHours.toFixed(1)}時間`;
            document.getElementById('totalShifts').textContent = totalShifts;
            document.getElementById('avgWorkHours').textContent = `${avgHours}時間`;
            document.getElementById('employeeDepartment').textContent = department;
        }
        
        // Calculate work hours
        function calculateWorkHours(startTime, endTime) {
            const [startHour, startMin] = startTime.split(':').map(Number);
            const [endHour, endMin] = endTime.split(':').map(Number);
            
            const startMinutes = startHour * 60 + startMin;
            const endMinutes = endHour * 60 + endMin;
            
            let diffMinutes = endMinutes - startMinutes;
            if (diffMinutes < 0) {
                diffMinutes += 24 * 60; // Handle next day
            }
            
            return diffMinutes / 60;
        }
        
        // Reset filters
        function resetFilters() {
            document.getElementById('employeeSelect').value = '';
            document.getElementById('workTypeFilter').value = '';
            setupDateInputs();
            
            // Clear charts
            if (timelineChart) {
                timelineChart.data.datasets = [];
                timelineChart.update();
            }
            
            if (workTypeChart) {
                workTypeChart.data.labels = [];
                workTypeChart.data.datasets[0].data = [];
                workTypeChart.update();
            }
            
            if (hourlyChart) {
                hourlyChart.data.datasets[0].data = new Array(24).fill(0);
                hourlyChart.update();
            }
            
            if (weeklyChart) {
                weeklyChart.data.datasets[0].data = new Array(7).fill(0);
                weeklyChart.update();
            }
            
            // Reset statistics
            document.getElementById('totalWorkHours').textContent = '0時間';
            document.getElementById('totalShifts').textContent = '0';
            document.getElementById('avgWorkHours').textContent = '0時間';
            document.getElementById('employeeDepartment').textContent = '-';
            document.getElementById('selectedEmployee').textContent = '従業員を選択してください';
        }
        
        // Export data
        function exportData() {
            const employeeId = document.getElementById('employeeSelect').value;
            if (!employeeId) {
                alert('従業員を選択してから出力してください。');
                return;
            }
            
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const workType = document.getElementById('workTypeFilter').value;
            
            const filteredSchedules = filterSchedules(employeeId, startDate, endDate, workType);
            const employee = allEmployees.find(e => e.id === employeeId);
            
            // Create CSV content
            let csvContent = '\uFEFF'; // BOM for UTF-8
            csvContent += '個人別タイムライン分析結果\n';
            csvContent += `従業員: ${employee ? employee.name : '不明'}\n`;
            csvContent += `期間: ${startDate} - ${endDate}\n`;
            csvContent += `業務タイプフィルター: ${workType || 'すべて'}\n\n`;
            csvContent += '日付,開始時間,終了時間,業務タイプ,勤務時間\n';
            
            filteredSchedules.forEach(schedule => {
                const workHours = calculateWorkHours(schedule.startTime, schedule.endTime);
                csvContent += `${schedule.date},${schedule.startTime},${schedule.endTime},${schedule.workType || '通常勤務'},${workHours.toFixed(1)}\n`;
            });
            
            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `個人別タイムライン_${employee ? employee.name : 'unknown'}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
