<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å€‹äººåˆ¥ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ - CEã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  V2</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/theme-unified.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #E8F5E8 0%, #D4F1D4 100%);
            --accent-color: #B8E6B8;
            --text-color: #2C3E50;
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        body {
            background: var(--primary-gradient);
            font-family: 'Segoe UI', 'Hiragino Sans', 'Yu Gothic UI', sans-serif;
            color: var(--text-color);
            min-height: 100vh;
        }

        .glassmorphism {
            background: rgba(255,255,255,0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-primary {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 20px;
            font-weight: 600;
            box-shadow: var(--shadow);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .btn-primary:hover { 
            transform: translateY(-1px); 
            box-shadow: 0 6px 18px rgba(0,0,0,0.15); 
        }

        .ce-card {
            background: rgba(255,255,255,0.85);
            border-radius: 14px;
            padding: 16px;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--ce-color);
            margin-bottom: 20px;
            transition: all 0.2s ease;
        }

        .ce-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .ce-ope { --ce-color: #87CEEB; }
        .ce-me { --ce-color: #90EE90; }
        .ce-hd { --ce-color: #FFB6C1; }
        .ce-flex { --ce-color: #FFFF99; }

        .worktype-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .worktype-ope { background: #87CEEB; color: #1E3A8A; }
        .worktype-me { background: #90EE90; color: #006400; }
        .worktype-hd { background: #FFB6C1; color: #8B008B; }
        .worktype-flex { background: #FFFF99; color: #B8860B; }

        .status-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            color: white;
            margin-left: 8px;
        }

        .status-A { background: #4CAF50; }
        .status-A1 { background: #FF9800; }
        .status-B { background: #9C27B0; }
        .status-é { background: #607D8B; }
        .status-Ã— { background: #F44336; }
        .status-å¹´ { background: #2196F3; }
        .status-å‡º { background: #2196F3; }
        .status-ç ” { background: #795548; }

        .timeline-day-row {
            padding: 12px;
            margin-bottom: 8px;
            background: rgba(255,255,255,0.9);
            border-radius: 8px;
            border: 1px solid rgba(0,0,0,0.06);
        }

        .timeline-track {
            position: relative;
            width: 100%;
            background: #f0f0f0;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #ddd;
            min-height: 30px;
        }

        .task-bar {
            position: absolute;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .task-bar:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .time-scale {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            padding: 0 4px;
            font-size: 10px;
            color: #666;
        }

        .filter-section {
            background: rgba(255,255,255,0.9);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .workload-summary {
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(248,255,248,0.8));
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .task-chip {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
            margin: 2px 4px 2px 0;
            border-left: 4px solid var(--dept-color);
            background: rgba(255,255,255,0.8);
        }

        .no-tasks-message {
            text-align: center;
            padding: 40px 20px;
            color: #999;
            background: rgba(255,255,255,0.5);
            border-radius: 8px;
            border: 2px dashed #ddd;
        }

        .auth-error {
            background: #fee2e2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 16px;
            margin: 20px;
            color: #991b1b;
        }

        /* å°åˆ·ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        @media print {
            body { 
                background: white !important; 
                color: #000 !important; 
            }
            .no-print { 
                display: none !important; 
            }
            .glassmorphism { 
                background: white !important; 
                border: 1px solid #ccc !important; 
            }
            .ce-card {
                break-inside: avoid;
                margin-bottom: 15px;
            }
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 768px) {
            .filter-section {
                padding: 12px;
            }
            
            .ce-card {
                padding: 12px;
            }
            
            .timeline-day-row {
                padding: 8px;
            }
            
            .task-bar {
                font-size: 10px;
                height: 20px;
            }
            
            .time-scale {
                font-size: 9px;
            }

            .ce-filter-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="authWarning" class="auth-error" style="display: none;">
        <h3><i class="fas fa-exclamation-triangle mr-2"></i>èªè¨¼ã‚¨ãƒ©ãƒ¼</h3>
        <p>ã“ã®ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã«ã¯ã€ã¾ãš<a href="../dashboard.html" class="underline font-bold">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>ã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚</p>
        <p class="text-sm mt-2">ã¾ãŸã¯ã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®ã€Œé›†è¨ˆãƒ»åˆ†æã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚</p>
    </div>

    <div class="container mx-auto p-4 max-w-7xl">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 no-print">
            <div>
                <h1 class="text-3xl font-bold mb-2">
                    <i class="fas fa-user-clock mr-3 text-blue-600"></i>å€‹äººåˆ¥ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³
                </h1>
                <p class="text-gray-600">CEå€‹äººã”ã¨ã®æ¥­å‹™ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨å‹¤å‹™ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ™‚é–“è»¸ã§å¯è¦–åŒ–</p>
            </div>
            <div class="flex gap-3 mt-4 md:mt-0">
                <button onclick="window.print()" class="btn-primary">
                    <i class="fas fa-print mr-2"></i>å°åˆ·
                </button>
                <button onclick="history.back()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                    <i class="fas fa-arrow-left mr-2"></i>æˆ»ã‚‹
                </button>
            </div>
        </div>

        <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ»è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="filter-section no-print">
            <h3 class="text-lg font-bold mb-4">
                <i class="fas fa-filter mr-2"></i>è¡¨ç¤ºè¨­å®š
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                <!-- æœŸé–“è¨­å®š -->
                <div>
                    <label class="block text-sm font-medium mb-2">é–‹å§‹æ—¥</label>
                    <input type="date" id="startDate" class="w-full p-3 border border-gray-300 rounded-lg">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">çµ‚äº†æ—¥</label>
                    <input type="date" id="endDate" class="w-full p-3 border border-gray-300 rounded-lg">
                </div>

                <!-- æ™‚é–“ç¯„å›²è¨­å®š -->
                <div>
                    <label class="block text-sm font-medium mb-2">è¡¨ç¤ºé–‹å§‹æ™‚åˆ»</label>
                    <input type="time" id="displayStartTime" value="07:00" class="w-full p-3 border border-gray-300 rounded-lg">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">è¡¨ç¤ºçµ‚äº†æ™‚åˆ»</label>
                    <input type="time" id="displayEndTime" value="19:00" class="w-full p-3 border border-gray-300 rounded-lg">
                </div>
            </div>

            <!-- CEãƒ»éƒ¨é–€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium mb-2">è¡¨ç¤ºCE</label>
                    <div class="flex flex-wrap gap-2 mb-2">
                        <label class="flex items-center">
                            <input type="checkbox" id="selectAllCEs" checked>
                            <span class="ml-2 font-bold">å…¨CEé¸æŠ</span>
                        </label>
                    </div>
                    <div id="ceFilterContainer" class="max-h-32 overflow-y-auto grid grid-cols-2 md:grid-cols-3 gap-1 ce-filter-grid">
                        <!-- CEãƒªã‚¹ãƒˆã¯å‹•çš„ç”Ÿæˆ -->
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2">è¡¨ç¤ºéƒ¨é–€</label>
                    <div class="flex flex-wrap gap-2">
                        <label class="flex items-center">
                            <input type="checkbox" class="department-filter" value="all" checked>
                            <span class="ml-2 font-bold">å…¨éƒ¨é–€</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" class="department-filter" value="è¡€æ¶²æµ„åŒ–" checked>
                            <span class="ml-2">è¡€æ¶²æµ„åŒ–</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" class="department-filter" value="äººå·¥å¿ƒè‚ºãƒ»è£œåŠ©å¾ªç’°" checked>
                            <span class="ml-2">äººå·¥å¿ƒè‚ºãƒ»è£œåŠ©å¾ªç’°</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" class="department-filter" value="å¿ƒãƒ»ã‚«ãƒ†ãƒ¼ãƒ†ãƒ«" checked>
                            <span class="ml-2">å¿ƒãƒ»ã‚«ãƒ†ãƒ¼ãƒ†ãƒ«</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" class="department-filter" value="æ‰‹è¡“ãƒ»éº»é…”" checked>
                            <span class="ml-2">æ‰‹è¡“ãƒ»éº»é…”</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" class="department-filter" value="ä¸æ•´è„ˆ" checked>
                            <span class="ml-2">ä¸æ•´è„ˆ</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" class="department-filter" value="æ©Ÿå™¨ç®¡ç†ãƒ»äººå·¥å‘¼å¸" checked>
                            <span class="ml-2">æ©Ÿå™¨ç®¡ç†ãƒ»äººå·¥å‘¼å¸</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" class="department-filter" value="ä¼šè­°ãƒ»ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ»å‹‰å¼·ä¼šãƒ»æ‰“ã¡åˆã‚ã›" checked>
                            <span class="ml-2">ä¼šè­°ãƒ»å‹‰å¼·ä¼š</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="flex gap-3">
                <button id="applyFiltersBtn" class="btn-primary">
                    <i class="fas fa-search mr-2"></i>è¡¨ç¤ºæ›´æ–°
                </button>
                <button id="resetFiltersBtn" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                    <i class="fas fa-undo mr-2"></i>ãƒªã‚»ãƒƒãƒˆ
                </button>
                <button id="currentWeekBtn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                    <i class="fas fa-calendar-week mr-2"></i>ä»Šé€±è¡¨ç¤º
                </button>
            </div>
        </div>

        <!-- ã‚µãƒãƒªãƒ¼æƒ…å ± -->
        <div id="summarySection" class="glassmorphism rounded-2xl p-4 mb-6">
            <h3 class="text-lg font-bold mb-3">
                <i class="fas fa-info-circle mr-2"></i>è¡¨ç¤ºã‚µãƒãƒªãƒ¼
            </h3>
            <div id="summaryContent" class="grid grid-cols-1 md:grid-cols-5 gap-4 text-sm">
                <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
            </div>
        </div>

        <!-- ã‚°ãƒ©ãƒ•è¡¨ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="chartsSection" class="glassmorphism rounded-2xl p-4 mb-6">
            <h3 class="text-lg font-bold mb-3">
                <i class="fas fa-chart-pie mr-2"></i>å¯è¦–åŒ–åˆ†æ
            </h3>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 charts-grid">
                <div class="bg-white bg-opacity-50 rounded-lg p-3">
                    <h4 class="font-bold text-sm mb-2 text-center">CEÃ—éƒ¨é–€åˆ¥æ¥­å‹™æ™‚é–“</h4>
                    <div class="h-64"><canvas id="byCEDeptChart"></canvas></div>
                </div>
                <div class="bg-white bg-opacity-50 rounded-lg p-3">
                    <h4 class="font-bold text-sm mb-2 text-center">å‹¤å‹™çŠ¶æ…‹åˆ†å¸ƒ</h4>
                    <div class="h-64"><canvas id="statusDonutChart"></canvas></div>
                </div>
                <div class="bg-white bg-opacity-50 rounded-lg p-3">
                    <h4 class="font-bold text-sm mb-2 text-center">CEåˆ¥ç·å®ŸåŠ´åƒæ™‚é–“</h4>
                    <div class="h-64"><canvas id="totalHoursBarChart"></canvas></div>
                </div>
            </div>
        </div>

        <!-- ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="timelineContainer" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4">
            <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
        </div>

        <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
        <div id="loadingIndicator" class="text-center py-8" style="display: none;">
            <i class="fas fa-spinner fa-spin text-2xl text-blue-600"></i>
            <p class="mt-2 text-gray-600">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
        // èªè¨¼ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½
        function checkAuthenticationStatus() {
            let targetUID = sessionStorage.getItem('targetUID');
            let currentUsername = sessionStorage.getItem('currentUsername');

            if (!targetUID || !currentUsername) {
                const params = new URLSearchParams(location.search);
                const qpUid = params.get('uid');
                const qpUsername = params.get('username') || params.get('user');
                const qpRole = params.get('role');

                if (qpUid && qpUsername) {
                    targetUID = qpUid;
                    currentUsername = qpUsername;
                    try {
                        sessionStorage.setItem('targetUID', qpUid);
                        sessionStorage.setItem('currentUsername', qpUsername);
                        sessionStorage.setItem('currentUser', qpUsername);
                        if (qpRole) sessionStorage.setItem('userRole', qpRole);
                        console.log('âœ… URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰èªè¨¼æƒ…å ±ã‚’å¾©å…ƒ');
                    } catch (e) {
                        console.warn('sessionStorageä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
                    }
                }
            }

            if (!targetUID || !currentUsername) {
                try {
                    const authData = localStorage.getItem('analyticsAuth');
                    if (authData) {
                        const parsed = JSON.parse(authData);
                        if (Date.now() - parsed.timestamp < 5 * 60 * 1000) {
                            targetUID = parsed.uid;
                            currentUsername = parsed.username;
                            sessionStorage.setItem('targetUID', parsed.uid);
                            sessionStorage.setItem('currentUsername', parsed.username);
                            sessionStorage.setItem('currentUser', parsed.displayName);
                            sessionStorage.setItem('userRole', parsed.role);
                            console.log('âœ… localStorageã‹ã‚‰èªè¨¼æƒ…å ±ã‚’å¾©å…ƒ');
                        }
                    }
                } catch (e) {
                    console.warn('localStorageèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
                }
            }

            if (!targetUID || !currentUsername) {
                console.warn('âš ï¸ èªè¨¼æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚');
                document.getElementById('authWarning').style.display = 'block';
                return false;
            }

            console.log('âœ… èªè¨¼æƒ…å ±ç¢ºèªå®Œäº†:', { targetUID: 'å­˜åœ¨', currentUsername: 'å­˜åœ¨' });
            document.getElementById('authWarning').style.display = 'none';
            return true;
        }

        // Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyCRUvvs0OSz_9L9bXtqteVFIIze1OaZObE",
            authDomain: "ce-scheduling-system-v2.firebaseapp.com",
            databaseURL: "https://ce-scheduling-system-v2-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ce-scheduling-system-v2",
            storageBucket: "ce-scheduling-system-v2.firebasestorage.app",
            messagingSenderId: "288279598010",
            appId: "1:288279598010:web:d545ee1d4d854513084383",
            measurementId: "G-LSEEMJE2R0"
        };

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let database = null;
        let authReadyPromise = null;
        let globalTasksData = {};
        let globalAssignmentsData = {};
        let globalCEList = [];
        let globalDayStatus = {};
        let currentDateRange = [];
        let displayStartHour = 7;
        let displayEndHour = 19;
        let chartInstances = {};

        // CEåå‰è§£æ±ºãƒãƒƒãƒ—ï¼ˆçµ±åˆç‰ˆï¼‰
        let CE_UNIFIED_MAP = new Map();

        const DATA_ROOT = 'ceScheduleV2';

        // éƒ¨é–€è¨­å®šï¼ˆæ‹¡å¼µç‰ˆï¼‰
        const DEPARTMENTS = [
            'è¡€æ¶²æµ„åŒ–', 'äººå·¥å¿ƒè‚ºãƒ»è£œåŠ©å¾ªç’°', 'å¿ƒãƒ»ã‚«ãƒ†ãƒ¼ãƒ†ãƒ«', 
            'æ‰‹è¡“ãƒ»éº»é…”', 'ä¸æ•´è„ˆ', 'æ©Ÿå™¨ç®¡ç†ãƒ»äººå·¥å‘¼å¸',
            'ä¼šè­°ãƒ»ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ»å‹‰å¼·ä¼šãƒ»æ‰“ã¡åˆã‚ã›'
        ];

        const DEPARTMENT_COLORS = {
            'è¡€æ¶²æµ„åŒ–': '#FFB6C1',
            'äººå·¥å¿ƒè‚ºãƒ»è£œåŠ©å¾ªç’°': '#4169E1',
            'å¿ƒãƒ»ã‚«ãƒ†ãƒ¼ãƒ†ãƒ«': '#32CD32',
            'æ‰‹è¡“ãƒ»éº»é…”': '#87CEEB',
            'ä¸æ•´è„ˆ': '#9370DB',
            'æ©Ÿå™¨ç®¡ç†ãƒ»äººå·¥å‘¼å¸': '#90EE90',
            'ä¼šè­°ãƒ»ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ»å‹‰å¼·ä¼šãƒ»æ‰“ã¡åˆã‚ã›': '#9E9E9E'
        };

        const DEPARTMENT_ICONS = {
            'è¡€æ¶²æµ„åŒ–': 'tint',
            'äººå·¥å¿ƒè‚ºãƒ»è£œåŠ©å¾ªç’°': 'procedures',
            'å¿ƒãƒ»ã‚«ãƒ†ãƒ¼ãƒ†ãƒ«': 'heart',
            'æ‰‹è¡“ãƒ»éº»é…”': 'user-md',
            'ä¸æ•´è„ˆ': 'heartbeat',
            'æ©Ÿå™¨ç®¡ç†ãƒ»äººå·¥å‘¼å¸': 'lungs',
            'ä¼šè­°ãƒ»ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ»å‹‰å¼·ä¼šãƒ»æ‰“ã¡åˆã‚ã›': 'handshake'
        };

        // å‹¤å‹™æ™‚é–“å®šç¾©
        const WORK_TIME_DEFINITIONS = {
            'A': { workHours: 7.75, breakMinutes: 45, isDuty: false },
            'A1': { workHours: 7.75, breakMinutes: 45, isDuty: false },
            'B': { workHours: 22, breakMinutes: 120, isDuty: true },
            'é': { workHours: 0, breakMinutes: 0, isDuty: false },
            'Ã—': { workHours: 0, breakMinutes: 0, isDuty: false },
            'å¹´': { workHours: 0, breakMinutes: 0, isDuty: false },
            'å‡º': { workHours: 0, breakMinutes: 0, isDuty: false },
            'ç ”': { workHours: 0, breakMinutes: 0, isDuty: false }
        };

        // CEã‚­ãƒ¼æ­£è¦åŒ–ï¼ˆæ”¹è‰¯ç‰ˆï¼‰
        function normalizeCEKey(ceData) {
            if (!ceData) return '';
            const raw = (ceData.id || ceData.name || ceData.fullName || ceData.iconName || ceData.displayName || '').toString();
            return raw.trim(); // å¤§æ–‡å­—å°æ–‡å­—ã¯åŒºåˆ¥ã™ã‚‹ï¼ˆæ—¥æœ¬èªåã®ãŸã‚ï¼‰
        }

        // çµ±åˆCEãƒªã‚¹ãƒˆæ§‹ç¯‰
        function buildUnifiedCEList(eventsByDate, workSchedulesRaw, ceListRaw) {
            CE_UNIFIED_MAP.clear();
            const ceMap = new Map();

            // 1) ceListã‹ã‚‰ï¼ˆåŸºæœ¬æƒ…å ±ï¼‰
            if (ceListRaw && typeof ceListRaw === 'object') {
                Object.entries(ceListRaw).forEach(([key, ce]) => {
                    const normalizedKey = normalizeCEKey({ id: ce.id || key, name: ce.iconName || ce.displayName || ce.name });
                    if (!normalizedKey) return;
                    
                    const ceData = {
                        key: normalizedKey,
                        id: ce.id || key,
                        name: ce.iconName || ce.displayName || ce.name || key,
                        fullName: ce.fullName || ce.name || ce.iconName || ce.displayName || key,
                        workType: ce.workType || 'ME'
                    };
                    
                    ceMap.set(normalizedKey, ceData);
                    CE_UNIFIED_MAP.set(normalizedKey, ceData.name);
                });
            }

            // 2) events.assignedCEsã‹ã‚‰ï¼ˆé…ç½®æƒ…å ±ï¼‰
            Object.values(eventsByDate || {}).forEach(dayEvents => {
                Object.values(dayEvents || {}).forEach(ev => {
                    (ev.assignedCEs || []).forEach(a => {
                        let id = '', name = '', workType = 'ME';
                        if (typeof a === 'string') {
                            id = a; name = a;
                        } else if (a && typeof a === 'object') {
                            id = a.id || a.name || '';
                            name = a.name || a.id || '';
                            workType = a.workType || 'ME';
                        }
                        
                        const key = normalizeCEKey({ id, name });
                        if (!key) return;
                        
                        if (!ceMap.has(key)) {
                            const ceData = {
                                key: key,
                                id: id || name,
                                name: name || id,
                                fullName: name || id,
                                workType: workType
                            };
                            ceMap.set(key, ceData);
                            CE_UNIFIED_MAP.set(key, ceData.name);
                        }
                    });
                });
            });

            // 3) å‹¤å‹™è¡¨scheduleDataã‹ã‚‰ï¼ˆå‹¤å‹™æƒ…å ±ï¼‰
            const schedules = Object.values(workSchedulesRaw || {}).filter(s => s.metadata && s.metadata.isVisible !== false);
            schedules.forEach(s => {
                const scheduleData = s.scheduleData || {};
                Object.keys(scheduleData).forEach(rawId => {
                    const key = normalizeCEKey({ id: rawId });
                    if (!key) return;
                    
                    if (!ceMap.has(key)) {
                        const ceData = {
                            key: key,
                            id: rawId,
                            name: rawId,
                            fullName: rawId,
                            workType: 'ME'
                        };
                        ceMap.set(key, ceData);
                        CE_UNIFIED_MAP.set(key, ceData.name);
                    }
                });
            });

            return Array.from(ceMap.values()).sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        }

        // CEé…ç½®åˆ¤å®šï¼ˆçµ±åˆç‰ˆï¼‰
        function isAssignedToCE(assignedEntry, ce) {
            if (!assignedEntry || !ce) return false;
            
            const ceNormalizedKey = ce.key || normalizeCEKey(ce);
            
            if (typeof assignedEntry === 'object' && assignedEntry !== null) {
                const assignedKey = assignedEntry.key || normalizeCEKey(assignedEntry);
                return assignedKey === ceNormalizedKey;
            } else if (typeof assignedEntry === 'string') {
                // æ–‡å­—åˆ—ã®å ´åˆã€è¤‡æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ç…§åˆ
                const assignedName = assignedEntry.toString();
                return assignedName === ceNormalizedKey || 
                       assignedName === ce.name || 
                       assignedName === ce.fullName ||
                       assignedName === ce.id;
            }
            
            return false;
        }

        function initializeFirebase() {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                database = firebase.database();

                authReadyPromise = new Promise((resolve, reject) => {
                    firebase.auth().onAuthStateChanged(user => {
                        if (user) {
                            console.log('âœ… Firebaseèªè¨¼å®Œäº†:', user.uid);
                            resolve(user);
                        }
                    }, err => {
                        console.error('âŒ Firebaseèªè¨¼ã‚¨ãƒ©ãƒ¼:', err);
                        reject(err);
                    });
                });

                firebase.auth().signInAnonymously().catch((error) => {
                    console.error('âŒ FirebaseåŒ¿åèªè¨¼ã‚¨ãƒ©ãƒ¼:', error);
                    const authWarning = document.getElementById('authWarning');
                    if (authWarning) authWarning.style.display = 'block';
                });
                    
            } catch (error) {
                console.error('âŒ FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                const authWarning = document.getElementById('authWarning');
                if (authWarning) authWarning.style.display = 'block';
            }
        }

        // ========== åˆæœŸåŒ– ==========
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸ”„ å€‹äººåˆ¥ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³åˆæœŸåŒ–é–‹å§‹');
            
            if (!checkAuthenticationStatus()) return;
            
            initializeFirebase();
            setupEventListeners();
            setCurrentWeekRange();
            
            try {
                console.log('â³ Firebaseèªè¨¼å®Œäº†å¾…æ©Ÿä¸­...');
                
                if (authReadyPromise) {
                    await authReadyPromise;
                    console.log('ğŸ” PromiseçµŒç”±ã§Firebaseèªè¨¼ç¢ºèªå®Œäº†');
                } else {
                    let authUser = firebase.auth().currentUser;
                    let attempts = 0;
                    
                    while (!authUser && attempts < 30) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                        authUser = firebase.auth().currentUser;
                        attempts++;
                    }
                    
                    if (!authUser) {
                        throw new Error('Firebaseèªè¨¼ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸï¼ˆ15ç§’ï¼‰');
                    }
                    console.log('ğŸ” ãƒãƒ¼ãƒªãƒ³ã‚°çµŒç”±ã§Firebaseèªè¨¼ç¢ºèªå®Œäº†:', authUser.uid);
                }
                
                await loadTimelineData();
                
            } catch (error) {
                console.error('âŒ åˆæœŸèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                const errorMessage = error.message || error.toString();
                
                if (errorMessage.includes('permission_denied')) {
                    showMessage('ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚Firebaseè¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'error');
                } else if (errorMessage.includes('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ')) {
                    showMessage('èªè¨¼å‡¦ç†ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'error');
                } else {
                    showMessage(`ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${errorMessage}`, 'error');
                }
            }
        });

        function setupEventListeners() {
            document.getElementById('applyFiltersBtn').addEventListener('click', loadTimelineData);
            document.getElementById('resetFiltersBtn').addEventListener('click', resetFilters);
            document.getElementById('currentWeekBtn').addEventListener('click', setCurrentWeekAndLoad);
            
            // éƒ¨é–€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            setTimeout(() => {
                const allDeptCheckbox = document.querySelector('.department-filter[value="all"]');
                if (allDeptCheckbox) {
                    allDeptCheckbox.addEventListener('change', function() {
                        const isChecked = this.checked;
                        document.querySelectorAll('.department-filter:not([value="all"])').forEach(cb => {
                            cb.checked = isChecked;
                        });
                    });
                }
                
                document.querySelectorAll('.department-filter:not([value="all"])').forEach(cb => {
                    cb.addEventListener('change', updateAllDepartmentCheckbox);
                });
            }, 100);
        }

        function setCurrentWeekRange() {
            const today = new Date();
            const dayFromMonday = (today.getDay() + 6) % 7;

            const startDate = new Date(today);
            startDate.setHours(0, 0, 0, 0);
            startDate.setDate(today.getDate() - dayFromMonday);

            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6);
            endDate.setHours(0, 0, 0, 0);

            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('endDate').value = endDate.toISOString().split('T')[0];

            console.log(`ğŸ“… å½“è©²é€±è¨­å®šï¼ˆæœˆæ›œã€œæ—¥æ›œï¼‰: ${startDate.toISOString().split('T')[0]} ï½ ${endDate.toISOString().split('T')[0]}`);
        }

        function setCurrentWeekAndLoad() {
            setCurrentWeekRange();
            loadTimelineData();
        }

        // ========== ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ ==========
        async function loadTimelineData() {
            showLoading(true);
            console.log('ğŸ”„ å€‹äººåˆ¥ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³èª­ã¿è¾¼ã¿é–‹å§‹');
            
            try {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                if (!startDate || !endDate) {
                    showMessage('é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„', 'warning');
                    return;
                }
                
                if (new Date(startDate) > new Date(endDate)) {
                    showMessage('é–‹å§‹æ—¥ã¯çµ‚äº†æ—¥ã‚ˆã‚Šå‰ã«è¨­å®šã—ã¦ãã ã•ã„', 'warning');
                    return;
                }
                
                console.log(`ğŸ“… æœŸé–“è¨­å®š: ${startDate} ï½ ${endDate}`);
                
                currentDateRange = generateDateRange(startDate, endDate);
                console.log('ğŸ“… ç”Ÿæˆã•ã‚ŒãŸæ—¥ä»˜ç¯„å›²:', currentDateRange.map(d => d.toISOString().split('T')[0]));
                
                await loadDataFromFirebase();
                updateDisplayTimeRange();
                generateCEFilterList();
                generateTimeline();
                updateSummary();
                
                console.log('âœ… å€‹äººåˆ¥ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³èª­ã¿è¾¼ã¿å®Œäº†');
                
            } catch (error) {
                console.error('âŒ ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function loadDataFromFirebase() {
            if (!database) {
                throw new Error('Firebaseæœªæ¥ç¶š');
            }
            
            try {
                console.log('ğŸ”„ Firebaseã‹ã‚‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­ï¼ˆçµ±åˆCEç‰ˆï¼‰...');
                
                const currentUser = firebase.auth().currentUser;
                if (!currentUser) {
                    throw new Error('Firebaseèªè¨¼ãŒæœªå®Œäº†ã§ã™');
                }
                console.log('ğŸ” èªè¨¼ç¢ºèªå®Œäº†:', currentUser.uid);
                
                const [eventsByDateSnapshot, ceListSnapshot, workSchedulesSnapshot] = await Promise.all([
                    database.ref(`${DATA_ROOT}/events/byDate`).once('value'),
                    database.ref(`${DATA_ROOT}/ceList`).once('value'),
                    database.ref(`${DATA_ROOT}/workSchedules`).once('value')
                ]);
                
                const eventsByDate = eventsByDateSnapshot.val() || {};
                const ceListRaw = ceListSnapshot.val() || {};
                const workSchedulesRaw = workSchedulesSnapshot.val() || {};

                console.log('ğŸ“Š å–å¾—ãƒ‡ãƒ¼ã‚¿ç¢ºèª:');
                console.log('  - events/byDate ã‚­ãƒ¼:', Object.keys(eventsByDate));
                console.log('  - ceList RAW:', ceListRaw);
                console.log('  - workSchedules ä»¶æ•°:', Object.keys(workSchedulesRaw).length);

                // çµ±åˆCEãƒªã‚¹ãƒˆæ§‹ç¯‰
                globalCEList = buildUnifiedCEList(eventsByDate, workSchedulesRaw, ceListRaw);
                console.log('ğŸ“Š çµ±åˆCEãƒªã‚¹ãƒˆ:', globalCEList.length, 'ä»¶');
                console.log('ğŸ“Š çµ±åˆCEãƒªã‚¹ãƒˆè©³ç´°:', globalCEList);
                
                // å‹¤å‹™è¡¨ãƒ‡ãƒ¼ã‚¿ã®çµ±åˆ
                globalDayStatus = {};
                const publishedSchedules = Object.values(workSchedulesRaw)
                    .filter(s => s.metadata && s.metadata.isVisible !== false)
                    .sort((a, b) => (b.metadata?.publishedAt || 0) - (a.metadata?.publishedAt || 0));

                if (publishedSchedules.length > 0) {
                    const latestSchedule = publishedSchedules[0];
                    const scheduleData = latestSchedule.scheduleData || {};
                    
                    currentDateRange.forEach(date => {
                        const dateKey = formatDateAsISO(date);
                        globalCEList.forEach(ce => {
                            const workData = scheduleData[ce.id]?.[dateKey] || scheduleData[ce.key]?.[dateKey];
                            const status = workData ? (workData.customText?.trim() || workData.status || '') : '';
                            
                            if (!globalDayStatus[ce.key]) globalDayStatus[ce.key] = {};
                            globalDayStatus[ce.key][dateKey] = status;
                        });
                    });
                    console.log('âœ… å‹¤å‹™è¡¨ãƒ‡ãƒ¼ã‚¿çµ±åˆå®Œäº†');
                }
                
                // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ç”¨ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã«å¤‰æ›
                globalTasksData = {};
                globalAssignmentsData = {};
                
                Object.entries(eventsByDate).forEach(([dateKey, dayEvents]) => {
                    if (dayEvents && typeof dayEvents === 'object') {
                        const tasksForDay = [];
                        const assignmentsForDay = {};
                        
                        Object.entries(dayEvents).forEach(([eventKey, event]) => {
                            const taskId = event.id || eventKey;
                            
                            const taskData = {
                                id: taskId,
                                name: event.name || 'åç§°ä¸æ˜',
                                department: event.department || 'éƒ¨é–€ä¸æ˜',
                                startTime: event.startTime || '09:00',
                                endTime: event.endTime || '17:00',
                                count: event.count || 1,
                                requiredPeople: event.requiredPeople || 1
                            };
                            
                            tasksForDay.push(taskData);
                            
                            // çµ±åˆã‚­ãƒ¼ãƒ™ãƒ¼ã‚¹ã§é…ç½®æƒ…å ±ã‚’æ ¼ç´
                            if (event.assignedCEs && Array.isArray(event.assignedCEs)) {
                                assignmentsForDay[taskId] = event.assignedCEs.map(assignedCE => {
                                    let id = '', name = '', workType = 'ME';
                                    
                                    if (typeof assignedCE === 'string') {
                                        id = assignedCE; name = assignedCE;
                                        const foundCE = globalCEList.find(c => c.key === normalizeCEKey({name: assignedCE}) || c.name === assignedCE);
                                        if (foundCE) {
                                            workType = foundCE.workType;
                                            name = foundCE.name;
                                        }
                                    } else if (assignedCE && typeof assignedCE === 'object') {
                                        id = assignedCE.id || assignedCE.name || '';
                                        name = assignedCE.name || assignedCE.id || '';
                                        workType = assignedCE.workType || 'ME';
                                    }
                                    
                                    const key = normalizeCEKey({ id, name });
                                    const displayName = CE_UNIFIED_MAP.get(key) || name || id || 'ä¸æ˜CE';
                                    
                                    return { key, id, name: displayName, workType };
                                });
                            } else {
                                assignmentsForDay[taskId] = [];
                            }
                            
                            console.log(`ğŸ”— ${dateKey} - ${taskData.name} (${taskData.department}): ${assignmentsForDay[taskId].length}åé…ç½®`);
                        });
                        
                        tasksForDay.sort((a, b) => a.startTime.localeCompare(b.startTime));
                        
                        globalTasksData[dateKey] = tasksForDay;
                        globalAssignmentsData[dateKey] = assignmentsForDay;
                        
                        console.log(`ğŸ“Š ${dateKey}: ${tasksForDay.length}ä»¶ã®æ¥­å‹™ã‚’å¤‰æ›å®Œäº†ï¼ˆçµ±åˆCEç‰ˆï¼‰`);
                    }
                });
                
                console.log('âœ… Firebaseãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†ï¼ˆçµ±åˆCEç‰ˆï¼‰');
                
            } catch (error) {
                console.error('âŒ Firebaseèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                throw error;
            }
        }

        function generateCEFilterList() {
            const container = document.getElementById('ceFilterContainer');
            if (!container || !globalCEList) return;
            
            container.innerHTML = '';
            
            globalCEList.forEach(ce => {
                const label = document.createElement('label');
                label.className = 'flex items-center text-sm';
                label.title = `${ce.fullName} (${ce.workType})`;
                label.innerHTML = `
                    <input type="checkbox" class="ce-filter" value="${ce.key}" checked>
                    <span class="ml-1 truncate">${ce.name}</span>
                `;
                container.appendChild(label);
            });

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
            const selectAllCEs = document.getElementById('selectAllCEs');
            if (selectAllCEs) {
                selectAllCEs.addEventListener('change', function() {
                    const isChecked = this.checked;
                    container.querySelectorAll('.ce-filter').forEach(cb => cb.checked = isChecked);
                });
            }
            
            container.querySelectorAll('.ce-filter').forEach(cb => {
                cb.addEventListener('change', updateAllCECheckbox);
            });
        }

        function updateAllCECheckbox() {
            const allCheckbox = document.getElementById('selectAllCEs');
            const ceCheckboxes = document.querySelectorAll('.ce-filter');
            const checkedCount = document.querySelectorAll('.ce-filter:checked').length;
            
            if (allCheckbox) {
                allCheckbox.checked = checkedCount === ceCheckboxes.length;
            }
        }

        function updateAllDepartmentCheckbox() {
            const allCheckbox = document.querySelector('.department-filter[value="all"]');
            const deptCheckboxes = document.querySelectorAll('.department-filter:not([value="all"])');
            const checkedCount = document.querySelectorAll('.department-filter:not([value="all"]):checked').length;
            
            if (allCheckbox) {
                allCheckbox.checked = checkedCount === deptCheckboxes.length;
            }
        }

        function generateDateRange(startDateStr, endDateStr) {
            const dates = [];
            const startDate = new Date(startDateStr + 'T00:00:00');
            const endDate = new Date(endDateStr + 'T00:00:00');
            
            const current = new Date(startDate);
            
            while (current <= endDate) {
                dates.push(new Date(current));
                current.setDate(current.getDate() + 1);
            }
            
            return dates;
        }

        function updateDisplayTimeRange() {
            const startTime = document.getElementById('displayStartTime').value;
            const endTime = document.getElementById('displayEndTime').value;
            
            displayStartHour = parseInt(startTime.split(':')[0]);
            displayEndHour = parseInt(endTime.split(':')[0]);
            
            console.log(`â° è¡¨ç¤ºæ™‚é–“ç¯„å›²: ${displayStartHour}:00 ï½ ${displayEndHour}:00`);
        }

        // ========== ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ç”Ÿæˆ ==========
        function generateTimeline() {
            console.log('ğŸ”„ å€‹äººåˆ¥ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ç”Ÿæˆé–‹å§‹');
            const container = document.getElementById('timelineContainer');
            container.innerHTML = '';
            
            const selectedCEs = getSelectedCEs();
            const selectedDepartments = getSelectedDepartments();
            
            console.log('ğŸ‘¤ é¸æŠã•ã‚ŒãŸCE:', selectedCEs.length);
            console.log('ğŸ¥ é¸æŠã•ã‚ŒãŸéƒ¨é–€:', selectedDepartments);
            
            const filteredCEs = globalCEList.filter(ce => selectedCEs.includes(ce.key));
            
            if (filteredCEs.length === 0) {
                container.innerHTML = `
                    <div class="no-tasks-message col-span-full">
                        <i class="fas fa-user-times text-3xl mb-4 block"></i>
                        <p class="text-lg font-bold mb-2">è¡¨ç¤ºã™ã‚‹CEã‚’é¸æŠã—ã¦ãã ã•ã„</p>
                        <p>ä¸Šéƒ¨ã®ã€Œå…¨CEé¸æŠã€ã¾ãŸã¯å€‹åˆ¥CEã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚</p>
                        <p class="text-sm mt-2">çµ±åˆCEæ•°: ${globalCEList.length}å</p>
                    </div>
                `;
                return;
            }

            let hasAnyData = false;

            filteredCEs.forEach(ce => {
                const ceData = collectCEData(ce, selectedDepartments);
                if (Object.keys(ceData).length > 0) {
                    generateCETimeline(ce, container, ceData);
                    hasAnyData = true;
                }
            });

            if (!hasAnyData) {
                container.innerHTML = `
                    <div class="no-tasks-message col-span-full">
                        <i class="fas fa-calendar-times text-3xl mb-4 block"></i>
                        <p class="text-lg font-bold mb-2">æŒ‡å®šæ¡ä»¶ã«è©²å½“ã™ã‚‹é…ç½®ãŒã‚ã‚Šã¾ã›ã‚“</p>
                        <p>æœŸé–“ãƒ»éƒ¨é–€ãƒ»CEé¸æŠã‚’è¦‹ç›´ã—ã¦ãã ã•ã„ã€‚</p>
                    </div>
                `;
            } else {
                // ã‚°ãƒ©ãƒ•ç”Ÿæˆ
                buildCharts(filteredCEs, selectedDepartments);
            }

            console.log('âœ… å€‹äººåˆ¥ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ç”Ÿæˆå®Œäº†');
        }

        function generateCETimeline(ce, container, ceData) {
            const ceCard = document.createElement('div');
            ceCard.className = `ce-card ce-${(ce.workType || '').toLowerCase()}`;
            ceCard.style.setProperty('--ce-color', getCEColor(ce.workType));

            const totalTasks = Object.values(ceData).reduce((sum, d) => sum + d.tasks.length, 0);
            const totalWorkHours = calculateTotalWorkHours(ceData);
            const statusSummary = computeStatusSummary(ce, ceData);

            const header = document.createElement('div');
            header.className = 'flex items-center justify-between mb-4';
            header.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-user mr-3 text-2xl" style="color: ${getCEColor(ce.workType)};"></i>
                    <div>
                        <h3 class="font-bold text-lg">${ce.name}</h3>
                        <span class="worktype-badge worktype-${(ce.workType||'').toLowerCase()}">${ce.workType}</span>
                    </div>
                </div>
                <div class="text-right text-sm text-gray-600">
                    <div class="bg-white bg-opacity-70 px-3 py-1 rounded-full mb-1">ç·æ¥­å‹™: ${totalTasks}ä»¶</div>
                    <div class="bg-white bg-opacity-70 px-3 py-1 rounded-full">å®ŸåŠ´åƒ: ${totalWorkHours}æ™‚é–“</div>
                    <div class="text-xs text-gray-500 mt-1">
                        å½“ç›´:${statusSummary.counts.B} éç•ª:${statusSummary.counts.é} ä¼‘:${statusSummary.counts.Ã—} å‡º:${statusSummary.counts.å‡º}
                    </div>
                </div>
            `;
            ceCard.appendChild(header);

            // å‹¤å‹™è² è·ã‚µãƒãƒªãƒ¼ï¼ˆéƒ¨é–€åˆ¥ï¼‰
            ceCard.appendChild(createWorkloadSummary(ceData));

            // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³æœ¬ä½“
            ceCard.appendChild(createTimelineBody(ceData, ce));

            container.appendChild(ceCard);
            return ceCard;
        }

        function collectCEData(ce, selectedDepartments = []) {
            const ceData = {};

            currentDateRange.forEach(date => {
                const dateKey = formatDateAsISO(date);
                const allTasks = globalTasksData[dateKey] || [];
                const allAssignments = globalAssignmentsData[dateKey] || {};

                const dayTasks = [];
                allTasks.forEach(task => {
                    if (selectedDepartments.length && !selectedDepartments.includes(task.department)) return;
                    
                    const assignedCEs = allAssignments[task.id] || [];
                    const isAssigned = assignedCEs.some(a => isAssignedToCE(a, ce));
                    if (isAssigned) {
                        dayTasks.push(task);
                        console.log(`ğŸ¯ ${ce.name} â†’ ${task.name} (${task.department}) ãƒãƒƒãƒæˆåŠŸ`);
                    }
                });

                if (dayTasks.length) {
                    ceData[dateKey] = { date, tasks: dayTasks };
                }
            });

            return ceData;
        }

        function computeStatusSummary(ce, ceData) {
            const counts = { A:0, A1:0, B:0, é:0, Ã—:0, å¹´:0, å‡º:0, ç ”:0, ç¨¼åƒæ—¥:0 };
            let totalBreakMin = 0;

            currentDateRange.forEach(d => {
                const dateKey = formatDateAsISO(d);
                const status = (globalDayStatus[ce.key] && globalDayStatus[ce.key][dateKey]) || '';

                const hasTasks = !!(ceData[dateKey] && ceData[dateKey].tasks && ceData[dateKey].tasks.length);
                if (hasTasks) counts.ç¨¼åƒæ—¥++;

                // çŠ¶æ…‹ã‚«ã‚¦ãƒ³ãƒˆ
                Object.keys(counts).forEach(s => {
                    if (status === s) counts[s]++;
                });

                // ä¼‘æ†©æ™‚é–“è¨ˆç®—
                const workDef = WORK_TIME_DEFINITIONS[status];
                if (workDef) {
                    totalBreakMin += workDef.breakMinutes || 0;
                }
            });

            return { counts, totalBreakMin };
        }

        function createWorkloadSummary(ceData) {
            const summary = document.createElement('div');
            summary.className = 'workload-summary';
            
            const deptStats = {};
            let totalHours = 0;
            
            Object.values(ceData).forEach(dayData => {
                dayData.tasks.forEach(task => {
                    if (!deptStats[task.department]) {
                        deptStats[task.department] = { count: 0, hours: 0 };
                    }
                    deptStats[task.department].count++;
                    
                    const startMinutes = timeToMinutes(task.startTime);
                    const endMinutes = timeToMinutes(task.endTime);
                    const taskHours = (endMinutes - startMinutes) / 60;
                    deptStats[task.department].hours += taskHours;
                    totalHours += taskHours;
                });
            });
            
            const deptStatsHtml = Object.entries(deptStats)
                .sort(([,a], [,b]) => b.count - a.count)
                .map(([dept, stats]) => `
                    <span class="task-chip" style="--dept-color: ${DEPARTMENT_COLORS[dept]}">
                        ${dept}: ${stats.count}ä»¶ (${Math.round(stats.hours * 10) / 10}h)
                    </span>
                `).join('');
            
            summary.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <h4 class="font-bold text-sm">æ¥­å‹™åˆ¥å‹¤å‹™è² è·</h4>
                    <span class="text-sm font-bold">åˆè¨ˆ: ${Math.round(totalHours * 10) / 10}æ™‚é–“</span>
                </div>
                <div class="flex flex-wrap">
                    ${deptStatsHtml || '<span class="text-gray-500 text-xs">æœŸé–“å†…ã«é…ç½®ã•ã‚ŒãŸæ¥­å‹™ãŒã‚ã‚Šã¾ã›ã‚“</span>'}
                </div>
            `;
            
            return summary;
        }

        function createTimelineBody(ceData, ce) {
            const body = document.createElement('div');
            body.className = 'space-y-3';
            
            const timeScale = createTimeScale();
            body.appendChild(timeScale);
            
            const sortedEntries = Object.entries(ceData).sort((a, b) => {
                return a[1].date.getTime() - b[1].date.getTime();
            });
            
            sortedEntries.forEach(([dateKey, dayData]) => {
                const dayRow = createDayRow(dayData, ce);
                body.appendChild(dayRow);
            });
            
            return body;
        }

        function createTimeScale() {
            const timeScale = document.createElement('div');
            timeScale.className = 'time-scale';
            
            for (let hour = displayStartHour; hour <= displayEndHour; hour += 2) {
                const timeLabel = document.createElement('div');
                timeLabel.textContent = `${hour.toString().padStart(2, '0')}:00`;
                timeLabel.style.flex = '1';
                timeLabel.style.textAlign = 'center';
                timeScale.appendChild(timeLabel);
            }
            
            return timeScale;
        }

        function createDayRow(dayData, ce) {
            const dayRow = document.createElement('div');
            dayRow.className = 'timeline-day-row';

            const dateKey = formatDateAsISO(dayData.date);
            const status = (globalDayStatus[ce.key] && globalDayStatus[ce.key][dateKey]) || '';
            const statusBadgeHtml = status ? `<span class="status-badge status-${status}">${status}</span>` : '';

            const dayHeader = document.createElement('div');
            dayHeader.className = 'flex justify-between items-center mb-2';
            dayHeader.innerHTML = `
                <div class="font-bold text-sm">
                    ${formatDisplayDate(dayData.date)} (${getJapaneseDayName(dayData.date)}) ${statusBadgeHtml}
                </div>
                <div class="text-xs text-gray-600">
                    ${dayData.tasks.length}ä»¶ã®æ¥­å‹™
                </div>
            `;
            dayRow.appendChild(dayHeader);

            const track = createTimelineTrack(dayData);
            dayRow.appendChild(track);
            return dayRow;
        }

        function createTimelineTrack(dayData) {
            const track = document.createElement('div');
            track.className = 'timeline-track';
            track.style.height = Math.max(30, dayData.tasks.length * 26 + 6) + 'px';
            
            const totalMinutes = (displayEndHour - displayStartHour) * 60;
            
            dayData.tasks.forEach((task, taskIdx) => {
                const taskBar = createTaskBar(task, taskIdx, totalMinutes);
                if (taskBar) {
                    track.appendChild(taskBar);
                }
            });
            
            return track;
        }

        function createTaskBar(task, taskIdx, totalMinutes) {
            const startMinutes = timeToMinutes(task.startTime);
            const endMinutes = timeToMinutes(task.endTime);
            const displayStartMinutes = displayStartHour * 60;
            const displayEndMinutes = displayEndHour * 60;
            
            if (endMinutes <= displayStartMinutes || startMinutes >= displayEndMinutes) {
                return null;
            }
            
            const adjustedStart = Math.max(startMinutes, displayStartMinutes);
            const adjustedEnd = Math.min(endMinutes, displayEndMinutes);
            
            const left = ((adjustedStart - displayStartMinutes) / totalMinutes) * 100;
            const width = Math.max(2, ((adjustedEnd - adjustedStart) / totalMinutes) * 100);
            
            const taskBar = document.createElement('div');
            taskBar.className = 'task-bar';
            taskBar.style.left = left + '%';
            taskBar.style.width = width + '%';
            taskBar.style.top = (taskIdx * 26 + 3) + 'px';
            taskBar.style.backgroundColor = DEPARTMENT_COLORS[task.department];
            taskBar.style.opacity = '0.9';
            
            taskBar.title = [
                `æ¥­å‹™: ${task.name}`,
                `éƒ¨é–€: ${task.department}`,
                `æ™‚é–“: ${task.startTime}-${task.endTime}`,
                `ä»¶æ•°: ${task.count || 1}ä»¶`,
                `å¿…è¦äººæ•°: ${task.requiredPeople || 1}å`
            ].join('\n');
            
            let displayText = '';
            if (width > 25) {
                displayText = `${task.name} (${task.department})`;
            } else if (width > 15) {
                displayText = task.name;
            } else if (width > 8) {
                displayText = task.name.substring(0, 3) + '...';
            } else {
                displayText = 'â—';
            }
            
            taskBar.innerHTML = `
                <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding: 0 4px;">
                    ${displayText}
                </span>
            `;
            
            return taskBar;
        }

        // ========== Chart.jså¯è¦–åŒ– ==========
        function destroyChart(id) {
            if (chartInstances[id]) {
                chartInstances[id].destroy();
                chartInstances[id] = null;
            }
        }

        function buildCharts(filteredCEs, selectedDepartments) {
            // 1) CEÃ—éƒ¨é–€ã®æ¥­å‹™æ™‚é–“ï¼ˆç©ã¿ä¸Šã’æ£’ã‚°ãƒ©ãƒ•ï¼‰
            const labels = filteredCEs.map(ce => ce.name);
            const deptList = selectedDepartments.length ? selectedDepartments : DEPARTMENTS;
            
            const hoursByCEDept = filteredCEs.map(ce => {
                const ceData = collectCEData(ce, selectedDepartments);
                const hours = Object.fromEntries(deptList.map(d => [d, 0]));
                
                Object.values(ceData).forEach(dayData => {
                    dayData.tasks.forEach(task => {
                        const taskHours = (timeToMinutes(task.endTime) - timeToMinutes(task.startTime)) / 60;
                        hours[task.department] = (hours[task.department] || 0) + Math.max(0, taskHours);
                    });
                });
                
                return hours;
            });

            const datasetsStacked = deptList.map(dept => ({
                label: dept,
                data: hoursByCEDept.map(h => Math.round((h[dept] || 0) * 10) / 10),
                backgroundColor: (DEPARTMENT_COLORS[dept] || '#999') + 'CC',
                borderColor: DEPARTMENT_COLORS[dept] || '#999',
                borderWidth: 1
            }));

            const byCEDeptCtx = document.getElementById('byCEDeptChart');
            if (byCEDeptCtx) {
                destroyChart('byCEDeptChart');
                chartInstances.byCEDeptChart = new Chart(byCEDeptCtx, {
                    type: 'bar',
                    data: { labels, datasets: datasetsStacked },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { stacked: true },
                            y: { stacked: true, beginAtZero: true }
                        },
                        plugins: {
                            legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } }
                        }
                    }
                });
            }

            // 2) å‹¤å‹™çŠ¶æ…‹ãƒ‰ãƒ¼ãƒŠãƒ„ã‚°ãƒ©ãƒ•
            const STATUS_LIST = ['A','A1','B','é','Ã—','å¹´','å‡º','ç ”'];
            const STATUS_COLORS = {
                'A':'#4CAF50','A1':'#FF9800','B':'#9C27B0','é':'#607D8B',
                'Ã—':'#F44336','å¹´':'#2196F3','å‡º':'#2196F3','ç ”':'#795548'
            };
            const statusCounts = Object.fromEntries(STATUS_LIST.map(s => [s, 0]));

            currentDateRange.forEach(date => {
                const dateKey = formatDateAsISO(date);
                filteredCEs.forEach(ce => {
                    const status = (globalDayStatus[ce.key] && globalDayStatus[ce.key][dateKey]) || '';
                    if (STATUS_LIST.includes(status)) {
                        statusCounts[status]++;
                    }
                });
            });

            const statusCtx = document.getElementById('statusDonutChart');
            if (statusCtx) {
                destroyChart('statusDonutChart');
                chartInstances.statusDonutChart = new Chart(statusCtx, {
                    type: 'doughnut',
                    data: {
                        labels: STATUS_LIST,
                        datasets: [{
                            data: STATUS_LIST.map(s => statusCounts[s]),
                            backgroundColor: STATUS_LIST.map(s => (STATUS_COLORS[s] || '#bbb') + 'CC'),
                            borderColor: STATUS_LIST.map(s => STATUS_COLORS[s] || '#bbb'),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } }
                        }
                    }
                });
            }

            // 3) CEåˆ¥ç·å®ŸåŠ´åƒæ™‚é–“
            const totalHours = filteredCEs.map(ce => {
                const ceData = collectCEData(ce, selectedDepartments);
                return calculateTotalWorkHours(ceData);
            });

            const totalHoursCtx = document.getElementById('totalHoursBarChart');
            if (totalHoursCtx) {
                destroyChart('totalHoursBarChart');
                chartInstances.totalHoursBarChart = new Chart(totalHoursCtx, {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [{
                            label: 'å®ŸåŠ´åƒæ™‚é–“(h)',
                            data: totalHours,
                            backgroundColor: '#10B981CC',
                            borderColor: '#10B981',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true } },
                        plugins: { legend: { display: false } }
                    }
                });
            }
        }

        // ========== ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ==========
        function timeToMinutes(timeString) {
            if (!timeString || !/^\d{1,2}:\d{2}$/.test(timeString)) return 0;
            const [hours, minutes] = timeString.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function formatDateAsISO(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDisplayDate(date) {
            const month = date.getMonth() + 1;
            const day = date.getDate();
            return `${month}/${day}`;
        }

        function getJapaneseDayName(date) {
            const days = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            return days[date.getDay()];
        }

        function getSelectedCEs() {
            return Array.from(document.querySelectorAll('.ce-filter:checked')).map(cb => cb.value);
        }

        function getSelectedDepartments() {
            const list = Array.from(document.querySelectorAll('.department-filter:not([value="all"]):checked')).map(cb => cb.value);
            return list.length > 0 ? list : DEPARTMENTS;
        }

        function getCEColor(workType) {
            const colors = {
                'OPE': '#87CEEB',
                'ME': '#90EE90',
                'HD': '#FFB6C1',
                'FLEX': '#FFFF99'
            };
            return colors[workType] || '#cccccc';
        }

        function calculateTotalWorkHours(ceData) {
            const timeSlots = new Set();
            
            Object.values(ceData).forEach(dayData => {
                const daySlots = new Set();
                
                dayData.tasks.forEach(task => {
                    const startMinutes = timeToMinutes(task.startTime);
                    const endMinutes = timeToMinutes(task.endTime);
                    
                    for (let minute = startMinutes; minute < endMinutes; minute++) {
                        daySlots.add(`${formatDateAsISO(dayData.date)}_${minute}`);
                    }
                });
                
                daySlots.forEach(slot => timeSlots.add(slot));
            });
            
            return Math.round((timeSlots.size / 60) * 10) / 10;
        }

        function showLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
        }

        function showMessage(message, type = 'info') {
            console.log(`${type.toUpperCase()}: ${message}`);
            alert(message);
        }

        // ========== ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ»æ“ä½œé–¢æ•° ==========
        function resetFilters() {
            setCurrentWeekRange();
            document.getElementById('displayStartTime').value = '07:00';
            document.getElementById('displayEndTime').value = '19:00';
            
            document.querySelectorAll('.ce-filter, .department-filter').forEach(cb => cb.checked = true);
            document.getElementById('selectAllCEs').checked = true;
            
            loadTimelineData();
        }

        function updateSummary() {
            const summaryContent = document.getElementById('summaryContent');
            const selectedCEs = getSelectedCEs();
            const selectedDepartments = getSelectedDepartments();

            const filteredCEs = globalCEList.filter(ce => selectedCEs.includes(ce.key));

            let totalTasks = 0;
            let totalWorkHours = 0;
            let activeCEs = 0;
            let totalB = 0, totalNon = 0, totalRest = 0;

            filteredCEs.forEach(ce => {
                const ceData = collectCEData(ce, selectedDepartments);
                if (Object.keys(ceData).length) {
                    activeCEs++;
                    totalTasks += Object.values(ceData).reduce((s,d) => s + d.tasks.length, 0);
                    totalWorkHours += calculateTotalWorkHours(ceData);
                    const statusSummary = computeStatusSummary(ce, ceData);
                    totalB += statusSummary.counts.B;
                    totalNon += statusSummary.counts.é;
                    totalRest += statusSummary.totalBreakMin;
                }
            });

            summaryContent.innerHTML = `
                <div class="bg-white bg-opacity-70 p-3 rounded-lg text-center">
                    <div class="font-bold text-lg text-blue-600">${filteredCEs.length}</div>
                    <div class="text-xs text-gray-600">è¡¨ç¤ºCEæ•°</div>
                </div>
                <div class="bg-white bg-opacity-70 p-3 rounded-lg text-center">
                    <div class="font-bold text-lg text-green-600">${activeCEs}</div>
                    <div class="text-xs text-gray-600">é…ç½®ã‚ã‚ŠCE</div>
                </div>
                <div class="bg-white bg-opacity-70 p-3 rounded-lg text-center">
                    <div class="font-bold text-lg text-purple-600">${totalTasks}</div>
                    <div class="text-xs text-gray-600">ç·æ¥­å‹™é…ç½®æ•°</div>
                </div>
                <div class="bg-white bg-opacity-70 p-3 rounded-lg text-center">
                    <div class="font-bold text-lg text-orange-600">${Math.round(totalWorkHours*10)/10}h</div>
                    <div class="text-xs text-gray-600">ç·å®ŸåŠ´åƒæ™‚é–“</div>
                </div>
                <div class="bg-white bg-opacity-70 p-3 rounded-lg text-center">
                    <div class="font-bold text-lg text-pink-600">å½“ç›´:${totalB} éç•ª:${totalNon}</div>
                    <div class="text-xs text-gray-600">ä¼‘æ†©:${Math.round(totalRest/60*10)/10}h</div>
                </div>
            `;

            console.log(`ğŸ“Š ã‚µãƒãƒªãƒ¼æ›´æ–°ï¼ˆçµ±åˆCEç‰ˆï¼‰: ${filteredCEs.length}åè¡¨ç¤º, ${activeCEs}åé…ç½®æ¸ˆã¿, ${totalTasks}ä»¶æ¥­å‹™, ${Math.round(totalWorkHours*10)/10}æ™‚é–“`);
        }

        console.log('âœ… å€‹äººåˆ¥ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ V2 èª­ã¿è¾¼ã¿å®Œäº†');
    </script>
</body>
</html>
