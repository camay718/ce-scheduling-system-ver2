<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ­ã‚°ã‚¤ãƒ³ - CEã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  V2</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        .loading-spinner {
            border: 3px solid #f3f3f4;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="gradient-bg min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-md">
        <!-- ãƒ­ã‚°ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰ -->
        <div class="glass-effect rounded-2xl shadow-xl p-8 mb-6">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                    <i class="fas fa-calendar-alt text-2xl text-blue-600"></i>
                </div>
                <h1 class="text-2xl font-bold text-white mb-2">CEã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
                <p class="text-blue-100">Version 2.0</p>
            </div>

            <!-- ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ  -->
            <form id="loginForm" class="space-y-6">
                <div>
                    <label for="loginInput" class="block text-sm font-medium text-white mb-2">
                        <i class="fas fa-user mr-2"></i>ãƒ¦ãƒ¼ã‚¶ãƒ¼å ã¾ãŸã¯ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
                    </label>
                    <input 
                        type="text" 
                        id="loginInput" 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200" 
                        placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼å ã¾ãŸã¯ email@example.com"
                        required
                    >
                </div>

                <div>
                    <label for="password" class="block text-sm font-medium text-white mb-2">
                        <i class="fas fa-lock mr-2"></i>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
                    </label>
                    <input 
                        type="password" 
                        id="password" 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200" 
                        placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                        required
                    >
                </div>

                <button 
                    type="submit" 
                    id="loginBtn"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 flex items-center justify-center"
                >
                    <span id="loginBtnText">ãƒ­ã‚°ã‚¤ãƒ³</span>
                    <div id="loginBtnSpinner" class="loading-spinner ml-2 hidden"></div>
                </button>
            </form>

            <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
            <div id="statusMessage" class="hidden mt-4 p-4 rounded-lg"></div>
        </div>

        <!-- ç®¡ç†è€…ã‚¢ã‚¯ã‚»ã‚¹ -->
        <div class="glass-effect rounded-xl p-4 text-center">
            <p class="text-blue-100 text-sm mb-2">ç®¡ç†è€…ã®æ–¹ã¯ã“ã¡ã‚‰</p>
            <a href="admin-debug.html" class="text-white hover:text-blue-200 text-sm underline">
                <i class="fas fa-cog mr-1"></i>ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
            </a>
        </div>
    </div>

    <!-- ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ« -->
    <div id="debugPanel" class="fixed bottom-4 right-4 bg-black bg-opacity-80 text-white text-xs p-3 rounded-lg max-w-sm hidden">
        <div class="flex justify-between items-center mb-2">
            <span class="font-bold">ğŸ” ãƒ‡ãƒãƒƒã‚°æƒ…å ±</span>
            <button onclick="toggleDebug()" class="text-red-400 hover:text-red-300">âœ•</button>
        </div>
        <div id="debugContent"></div>
    </div>

    <script>
        // Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyCRUvvs0OSz_9L9bXtqteVFIIze1OaZObE",
            authDomain: "ce-scheduling-system-v2.firebaseapp.com",
            databaseURL: "https://ce-scheduling-system-v2-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ce-scheduling-system-v2",
            storageBucket: "ce-scheduling-system-v2.firebasestorage.app",
            messagingSenderId: "288279598010",
            appId: "1:288279598010:web:d545ee1d4d854513084383",
            measurementId: "G-LSEEMJE2R0"
        };

        // FirebaseåˆæœŸåŒ–
        let app, auth, database;
        let isDebugMode = localStorage.getItem('debugMode') === 'true';

        function debugLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const icons = { info: 'â„¹ï¸', success: 'âœ…', error: 'âŒ', warn: 'âš ï¸' };
            const logMessage = `[${timestamp}] ${icons[type]} ${message}`;
            
            console.log(`[DEBUG ${type.toUpperCase()}] ${message}`);
            
            if (isDebugMode) {
                const debugContent = document.getElementById('debugContent');
                if (debugContent) {
                    debugContent.innerHTML += `<div class="mb-1 ${type === 'error' ? 'text-red-400' : type === 'success' ? 'text-green-400' : type === 'warn' ? 'text-yellow-400' : 'text-blue-400'}">${logMessage}</div>`;
                    debugContent.scrollTop = debugContent.scrollHeight;
                }
            }
        }

        function showDebugPanel() {
            document.getElementById('debugPanel').classList.remove('hidden');
            isDebugMode = true;
            localStorage.setItem('debugMode', 'true');
        }

        function toggleDebug() {
            const panel = document.getElementById('debugPanel');
            if (panel.classList.contains('hidden')) {
                showDebugPanel();
            } else {
                panel.classList.add('hidden');
                isDebugMode = false;
                localStorage.setItem('debugMode', 'false');
            }
        }

        // Ctrl+D ã§ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'd') {
                e.preventDefault();
                toggleDebug();
            }
        });

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessage');
            const typeClasses = {
                success: 'bg-green-100 border-green-400 text-green-700',
                error: 'bg-red-100 border-red-400 text-red-700',
                info: 'bg-blue-100 border-blue-400 text-blue-700',
                warn: 'bg-yellow-100 border-yellow-400 text-yellow-700'
            };
            
            statusDiv.className = `border-l-4 p-4 rounded-lg ${typeClasses[type]}`;
            statusDiv.innerHTML = message;
            statusDiv.classList.remove('hidden');
            
            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.classList.add('hidden');
                }, 5000);
            }
        }

        function setLoginButtonState(loading = false) {
            const btn = document.getElementById('loginBtn');
            const text = document.getElementById('loginBtnText');
            const spinner = document.getElementById('loginBtnSpinner');
            
            if (loading) {
                btn.disabled = true;
                text.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­...';
                spinner.classList.remove('hidden');
                btn.classList.add('opacity-75');
            } else {
                btn.disabled = false;
                text.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³';
                spinner.classList.add('hidden');
                btn.classList.remove('opacity-75');
            }
        }

        async function initializeFirebase() {
            try {
                debugLog('ğŸ”¥ FirebaseåˆæœŸåŒ–é–‹å§‹...');
                app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                database = firebase.database();
                debugLog('âœ… FirebaseåˆæœŸåŒ–å®Œäº†', 'success');
                
                // èªè¨¼çŠ¶æ…‹ã®ç›£è¦–
                auth.onAuthStateChanged(user => {
                    if (user) {
                        debugLog(`ğŸ” èªè¨¼çŠ¶æ…‹: ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ (${user.email})`, 'success');
                    } else {
                        debugLog('ğŸ”“ èªè¨¼çŠ¶æ…‹: æœªãƒ­ã‚°ã‚¤ãƒ³', 'info');
                    }
                });
                
                return true;
            } catch (error) {
                debugLog(`âŒ FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                showStatus('ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                return false;
            }
        }

        async function findUserByUsername(username) {
            try {
                debugLog(`ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼åæ¤œç´¢: ${username}`);
                const usernameRef = database.ref(`ceScheduleV2/usernames/${username}`);
                const snapshot = await usernameRef.once('value');
                
                if (snapshot.exists()) {
                    const uid = snapshot.val();
                    debugLog(`âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼åâ†’UIDå¤‰æ›æˆåŠŸ: ${uid}`, 'success');
                    return uid;
                } else {
                    debugLog(`âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${username}`, 'warn');
                    return null;
                }
            } catch (error) {
                debugLog(`âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼åæ¤œç´¢ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                return null;
            }
        }

        async function getUserData(uid) {
            try {
                debugLog(`ğŸ“‹ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—: ${uid}`);
                const userRef = database.ref(`ceScheduleV2/users/${uid}`);
                const snapshot = await userRef.once('value');
                
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    debugLog(`âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ: ${userData.username} (${userData.role})`, 'success');
                    return userData;
                } else {
                    debugLog(`âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${uid}`, 'error');
                    return null;
                }
            } catch (error) {
                debugLog(`âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                return null;
            }
        }

        function isEmailFormat(input) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(input);
        }

        async function handleLogin(event) {
            event.preventDefault();
            setLoginButtonState(true);
            
            const loginInput = document.getElementById('loginInput').value.trim();
            const password = document.getElementById('password').value;
            
            if (!loginInput || !password) {
                showStatus('ãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼ˆã¾ãŸã¯ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼‰ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                setLoginButtonState(false);
                return;
            }
            
            debugLog(`ğŸ” ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œé–‹å§‹: ${loginInput}`);
            
            try {
                let email = loginInput;
                let userData = null;
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼åå½¢å¼ã®å ´åˆã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«å¤‰æ›
                if (!isEmailFormat(loginInput)) {
                    debugLog('ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼åå½¢å¼ã‚’æ¤œå‡ºã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å¤‰æ›ä¸­...');
                    const uid = await findUserByUsername(loginInput);
                    
                    if (!uid) {
                        showStatus('ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                        setLoginButtonState(false);
                        return;
                    }
                    
                    userData = await getUserData(uid);
                    if (!userData || !userData.email) {
                        showStatus('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                        setLoginButtonState(false);
                        return;
                    }
                    
                    email = userData.email;
                    debugLog(`âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼åâ†’ãƒ¡ãƒ¼ãƒ«å¤‰æ›: ${email}`, 'success');
                }
                
                // Firebase Authentication ã§ãƒ­ã‚°ã‚¤ãƒ³
                debugLog(`ğŸ”‘ Firebaseèªè¨¼å®Ÿè¡Œ: ${email}`);
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                debugLog(`âœ… Firebaseèªè¨¼æˆåŠŸ: ${user.email}`, 'success');
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆã¾ã å–å¾—ã—ã¦ã„ãªã„å ´åˆï¼‰
                if (!userData) {
                    userData = await getUserData(user.uid);
                }
                
                if (!userData) {
                    showStatus('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                    setLoginButtonState(false);
                    return;
                }
                
                // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ
                showStatus(`ã‚ˆã†ã“ãã€${userData.username}ã•ã‚“ï¼`, 'success');
                
                // åˆæœŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã©ã†ã‹ã§åˆ†å²
                if (userData.isInitialUser && !userData.hasCompletedSetup) {
                    debugLog('ğŸ”„ åˆæœŸãƒ¦ãƒ¼ã‚¶ãƒ¼: å€‹äººè¨­å®šç”»é¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ', 'info');
                    setTimeout(() => {
                        window.location.href = 'pages/user-setup.html';
                    }, 1500);
                } else {
                    // å½¹å‰²ã«å¿œã˜ã¦ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                    if (userData.role === 'admin') {
                        debugLog('ğŸ‘‘ ç®¡ç†è€…: ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ', 'info');
                        setTimeout(() => {
                            window.location.href = 'admin-debug.html';
                        }, 1500);
                    } else {
                        debugLog('ğŸ‘¤ ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼: ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç”»é¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ', 'info');
                        setTimeout(() => {
                            window.location.href = 'pages/schedule-dashboard.html';
                        }, 1500);
                    }
                }
                
            } catch (error) {
                debugLog(`âŒ ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                
                let errorMessage = 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ';
                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œå›æ•°ãŒä¸Šé™ã«é”ã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„';
                }
                
                showStatus(errorMessage, 'error');
                setLoginButtonState(false);
            }
        }

        // ãƒšãƒ¼ã‚¸åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            debugLog('ğŸš€ ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
            
            // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ãŒæœ‰åŠ¹ãªå ´åˆã€ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º
            if (isDebugMode) {
                showDebugPanel();
            }
            
            // FirebaseåˆæœŸåŒ–
            const firebaseReady = await initializeFirebase();
            if (!firebaseReady) {
                showStatus('ã‚·ã‚¹ãƒ†ãƒ ã®æº–å‚™ãŒã§ãã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }
            
            // ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // æ—¢ã«ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    debugLog(`ğŸ” æ—¢å­˜ãƒ­ã‚°ã‚¤ãƒ³æ¤œå‡º: ${user.email}`);
                    const userData = await getUserData(user.uid);
                    
                    if (userData) {
                        if (userData.isInitialUser && !userData.hasCompletedSetup) {
                            debugLog('ğŸ”„ åˆæœŸãƒ¦ãƒ¼ã‚¶ãƒ¼: å€‹äººè¨­å®šãŒå¿…è¦', 'warn');
                            // åˆæœŸè¨­å®šãŒå¿…è¦ãªå ´åˆã¯ãã®ã¾ã¾ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«ç•™ã¾ã‚‹
                        } else {
                            debugLog('ğŸ”„ è¨­å®šæ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼: è‡ªå‹•ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆæº–å‚™', 'info');
                            // è¨­å®šæ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯é©åˆ‡ãªç”»é¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå¯èƒ½
                        }
                    }
                }
            });
            
            debugLog('âœ… ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†', 'success');
        });
    </script>
</body>
</html>
