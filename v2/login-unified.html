<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ログイン - CEスケジュール管理システム V2</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        .loading-spinner {
            border: 3px solid #f3f3f4;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="gradient-bg min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-md">
        <!-- ログインカード -->
        <div class="glass-effect rounded-2xl shadow-xl p-8 mb-6">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                    <i class="fas fa-calendar-alt text-2xl text-blue-600"></i>
                </div>
                <h1 class="text-2xl font-bold text-white mb-2">CEスケジュール管理システム</h1>
                <p class="text-blue-100">Version 2.0</p>
            </div>

            <!-- ログインフォーム -->
            <form id="loginForm" class="space-y-6">
                <div>
                    <label for="loginInput" class="block text-sm font-medium text-white mb-2">
                        <i class="fas fa-user mr-2"></i>ユーザー名 または メールアドレス
                    </label>
                    <input 
                        type="text" 
                        id="loginInput" 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200" 
                        placeholder="ユーザー名 または email@example.com"
                        required
                    >
                </div>

                <div>
                    <label for="password" class="block text-sm font-medium text-white mb-2">
                        <i class="fas fa-lock mr-2"></i>パスワード
                    </label>
                    <input 
                        type="password" 
                        id="password" 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200" 
                        placeholder="••••••••"
                        required
                    >
                </div>

                <button 
                    type="submit" 
                    id="loginBtn"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 flex items-center justify-center"
                >
                    <span id="loginBtnText">ログイン</span>
                    <div id="loginBtnSpinner" class="loading-spinner ml-2 hidden"></div>
                </button>
            </form>

            <!-- ステータスメッセージ -->
            <div id="statusMessage" class="hidden mt-4 p-4 rounded-lg"></div>
        </div>

        <!-- 管理者アクセス -->
        <div class="glass-effect rounded-xl p-4 text-center">
            <p class="text-blue-100 text-sm mb-2">管理者の方はこちら</p>
            <a href="admin-debug.html" class="text-white hover:text-blue-200 text-sm underline">
                <i class="fas fa-cog mr-1"></i>管理者ダッシュボード
            </a>
        </div>
    </div>

    <!-- デバッグパネル -->
    <div id="debugPanel" class="fixed bottom-4 right-4 bg-black bg-opacity-80 text-white text-xs p-3 rounded-lg max-w-sm hidden">
        <div class="flex justify-between items-center mb-2">
            <span class="font-bold">🔍 デバッグ情報</span>
            <button onclick="toggleDebug()" class="text-red-400 hover:text-red-300">✕</button>
        </div>
        <div id="debugContent"></div>
    </div>

    <script>
        // Firebase設定
        const firebaseConfig = {
            apiKey: "AIzaSyCRUvvs0OSz_9L9bXtqteVFIIze1OaZObE",
            authDomain: "ce-scheduling-system-v2.firebaseapp.com",
            databaseURL: "https://ce-scheduling-system-v2-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ce-scheduling-system-v2",
            storageBucket: "ce-scheduling-system-v2.firebasestorage.app",
            messagingSenderId: "288279598010",
            appId: "1:288279598010:web:d545ee1d4d854513084383",
            measurementId: "G-LSEEMJE2R0"
        };

        // Firebase初期化
        let app, auth, database;
        let isDebugMode = localStorage.getItem('debugMode') === 'true';

        function debugLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const icons = { info: 'ℹ️', success: '✅', error: '❌', warn: '⚠️' };
            const logMessage = `[${timestamp}] ${icons[type]} ${message}`;
            
            console.log(`[DEBUG ${type.toUpperCase()}] ${message}`);
            
            if (isDebugMode) {
                const debugContent = document.getElementById('debugContent');
                if (debugContent) {
                    debugContent.innerHTML += `<div class="mb-1 ${type === 'error' ? 'text-red-400' : type === 'success' ? 'text-green-400' : type === 'warn' ? 'text-yellow-400' : 'text-blue-400'}">${logMessage}</div>`;
                    debugContent.scrollTop = debugContent.scrollHeight;
                }
            }
        }

        function showDebugPanel() {
            document.getElementById('debugPanel').classList.remove('hidden');
            isDebugMode = true;
            localStorage.setItem('debugMode', 'true');
        }

        function toggleDebug() {
            const panel = document.getElementById('debugPanel');
            if (panel.classList.contains('hidden')) {
                showDebugPanel();
            } else {
                panel.classList.add('hidden');
                isDebugMode = false;
                localStorage.setItem('debugMode', 'false');
            }
        }

        // Ctrl+D でデバッグモード切り替え
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'd') {
                e.preventDefault();
                toggleDebug();
            }
        });

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessage');
            const typeClasses = {
                success: 'bg-green-100 border-green-400 text-green-700',
                error: 'bg-red-100 border-red-400 text-red-700',
                info: 'bg-blue-100 border-blue-400 text-blue-700',
                warn: 'bg-yellow-100 border-yellow-400 text-yellow-700'
            };
            
            statusDiv.className = `border-l-4 p-4 rounded-lg ${typeClasses[type]}`;
            statusDiv.innerHTML = message;
            statusDiv.classList.remove('hidden');
            
            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.classList.add('hidden');
                }, 5000);
            }
        }

        function setLoginButtonState(loading = false) {
            const btn = document.getElementById('loginBtn');
            const text = document.getElementById('loginBtnText');
            const spinner = document.getElementById('loginBtnSpinner');
            
            if (loading) {
                btn.disabled = true;
                text.textContent = 'ログイン中...';
                spinner.classList.remove('hidden');
                btn.classList.add('opacity-75');
            } else {
                btn.disabled = false;
                text.textContent = 'ログイン';
                spinner.classList.add('hidden');
                btn.classList.remove('opacity-75');
            }
        }

        async function initializeFirebase() {
            try {
                debugLog('🔥 Firebase初期化開始...');
                app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                database = firebase.database();
                debugLog('✅ Firebase初期化完了', 'success');
                
                // 認証状態の監視
                auth.onAuthStateChanged(user => {
                    if (user) {
                        debugLog(`🔐 認証状態: ログイン済み (${user.email})`, 'success');
                    } else {
                        debugLog('🔓 認証状態: 未ログイン', 'info');
                    }
                });
                
                return true;
            } catch (error) {
                debugLog(`❌ Firebase初期化エラー: ${error.message}`, 'error');
                showStatus('システムの初期化に失敗しました', 'error');
                return false;
            }
        }

        async function findUserByUsername(username) {
            try {
                debugLog(`👤 ユーザー名検索: ${username}`);
                const usernameRef = database.ref(`ceScheduleV2/usernames/${username}`);
                const snapshot = await usernameRef.once('value');
                
                if (snapshot.exists()) {
                    const uid = snapshot.val();
                    debugLog(`✅ ユーザー名→UID変換成功: ${uid}`, 'success');
                    return uid;
                } else {
                    debugLog(`❌ ユーザー名が見つかりません: ${username}`, 'warn');
                    return null;
                }
            } catch (error) {
                debugLog(`❌ ユーザー名検索エラー: ${error.message}`, 'error');
                return null;
            }
        }

        async function getUserData(uid) {
            try {
                debugLog(`📋 ユーザーデータ取得: ${uid}`);
                const userRef = database.ref(`ceScheduleV2/users/${uid}`);
                const snapshot = await userRef.once('value');
                
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    debugLog(`✅ ユーザーデータ取得成功: ${userData.username} (${userData.role})`, 'success');
                    return userData;
                } else {
                    debugLog(`❌ ユーザーデータが見つかりません: ${uid}`, 'error');
                    return null;
                }
            } catch (error) {
                debugLog(`❌ ユーザーデータ取得エラー: ${error.message}`, 'error');
                return null;
            }
        }

        function isEmailFormat(input) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(input);
        }

        async function handleLogin(event) {
            event.preventDefault();
            setLoginButtonState(true);
            
            const loginInput = document.getElementById('loginInput').value.trim();
            const password = document.getElementById('password').value;
            
            if (!loginInput || !password) {
                showStatus('ユーザー名（またはメールアドレス）とパスワードを入力してください', 'error');
                setLoginButtonState(false);
                return;
            }
            
            debugLog(`🔐 ログイン試行開始: ${loginInput}`);
            
            try {
                let email = loginInput;
                let userData = null;
                
                // ユーザー名形式の場合、メールアドレスに変換
                if (!isEmailFormat(loginInput)) {
                    debugLog('👤 ユーザー名形式を検出、メールアドレス変換中...');
                    const uid = await findUserByUsername(loginInput);
                    
                    if (!uid) {
                        showStatus('ユーザー名が見つかりません', 'error');
                        setLoginButtonState(false);
                        return;
                    }
                    
                    userData = await getUserData(uid);
                    if (!userData || !userData.email) {
                        showStatus('ユーザーデータの取得に失敗しました', 'error');
                        setLoginButtonState(false);
                        return;
                    }
                    
                    email = userData.email;
                    debugLog(`✅ ユーザー名→メール変換: ${email}`, 'success');
                }
                
                // Firebase Authentication でログイン
                debugLog(`🔑 Firebase認証実行: ${email}`);
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                debugLog(`✅ Firebase認証成功: ${user.email}`, 'success');
                
                // ユーザーデータを取得（まだ取得していない場合）
                if (!userData) {
                    userData = await getUserData(user.uid);
                }
                
                if (!userData) {
                    showStatus('ユーザーデータが見つかりません', 'error');
                    setLoginButtonState(false);
                    return;
                }
                
                // ログイン成功
                showStatus(`ようこそ、${userData.username}さん！`, 'success');
                
                // 初期ユーザーかどうかで分岐
                if (userData.isInitialUser && !userData.hasCompletedSetup) {
                    debugLog('🔄 初期ユーザー: 個人設定画面にリダイレクト', 'info');
                    setTimeout(() => {
                        window.location.href = 'pages/user-setup.html';
                    }, 1500);
                } else {
                    // 役割に応じてリダイレクト
                    if (userData.role === 'admin') {
                        debugLog('👑 管理者: 管理者ダッシュボードにリダイレクト', 'info');
                        setTimeout(() => {
                            window.location.href = 'admin-debug.html';
                        }, 1500);
                    } else {
                        debugLog('👤 一般ユーザー: スケジュール画面にリダイレクト', 'info');
                        setTimeout(() => {
                            window.location.href = 'pages/schedule-dashboard.html';
                        }, 1500);
                    }
                }
                
            } catch (error) {
                debugLog(`❌ ログインエラー: ${error.message}`, 'error');
                
                let errorMessage = 'ログインに失敗しました';
                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'ユーザーが見つかりません';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = 'パスワードが間違っています';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'メールアドレスの形式が正しくありません';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'ログイン試行回数が上限に達しました。しばらく待ってから再試行してください';
                }
                
                showStatus(errorMessage, 'error');
                setLoginButtonState(false);
            }
        }

        // ページ初期化
        document.addEventListener('DOMContentLoaded', async function() {
            debugLog('🚀 ページ読み込み完了');
            
            // デバッグモードが有効な場合、パネルを表示
            if (isDebugMode) {
                showDebugPanel();
            }
            
            // Firebase初期化
            const firebaseReady = await initializeFirebase();
            if (!firebaseReady) {
                showStatus('システムの準備ができていません', 'error');
                return;
            }
            
            // ログインフォームのイベントリスナー
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // 既にログイン済みかチェック
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    debugLog(`🔍 既存ログイン検出: ${user.email}`);
                    const userData = await getUserData(user.uid);
                    
                    if (userData) {
                        if (userData.isInitialUser && !userData.hasCompletedSetup) {
                            debugLog('🔄 初期ユーザー: 個人設定が必要', 'warn');
                            // 初期設定が必要な場合はそのままログイン画面に留まる
                        } else {
                            debugLog('🔄 設定済みユーザー: 自動リダイレクト準備', 'info');
                            // 設定済みユーザーは適切な画面にリダイレクト可能
                        }
                    }
                }
            });
            
            debugLog('✅ システム初期化完了', 'success');
        });
    </script>
</body>
</html>
