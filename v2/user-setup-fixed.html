<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEスケジュール管理システム V2 - 個人設定</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- 外部ライブラリ -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- 統合CSS -->
    <link rel="stylesheet" href="styles/main.css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <!-- Firebase設定 -->
    <script src="js/config/firebase-config.js?v=20241212"></script>
</head>
<body class="theme-unified bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- ローディング画面 -->
    <div id="loading" class="fixed inset-0 bg-white flex items-center justify-center z-50">
        <div class="text-center">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-gray-600">個人設定を読み込んでいます...</p>
        </div>
    </div>

    <!-- メインインターフェース -->
    <div id="mainInterface" class="min-h-screen flex items-center justify-center p-4" style="display:none;">
        <div class="w-full max-w-md">
            <!-- ヘッダー -->
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-600 rounded-full mb-4">
                    <i class="fas fa-user-cog text-2xl text-white"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">個人設定</h1>
                <p class="text-gray-600">初回設定を完了してください</p>
                <div class="mt-2 text-sm text-blue-600">
                    ユーザー名: <span id="currentUsername" class="font-semibold">--</span>
                </div>
            </div>

            <!-- 設定フォーム -->
            <div class="glass-card p-8">
                <!-- 進捗表示 -->
                <div class="mb-6">
                    <div class="flex items-center justify-between text-sm text-gray-500 mb-2">
                        <span>設定進捗</span>
                        <span id="progressText">0/4 完了</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>

                <form id="userSetupForm" class="space-y-6">
                    <!-- 表示名設定 -->
                    <div>
                        <label for="displayName" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-user mr-2 text-blue-600"></i>氏名（全角） *
                        </label>
                        <input type="text" id="displayName" name="displayName" 
                               class="input-unified" 
                               placeholder="例: 山田 太郎"
                               required>
                        <p class="mt-1 text-xs text-gray-500">システム内で表示される正式な氏名です</p>
                    </div>

                    <!-- パスワード設定 -->
                    <div>
                        <label for="newPassword" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-lock mr-2 text-green-600"></i>新しいパスワード *
                        </label>
                        <div class="relative">
                            <input type="password" id="newPassword" name="newPassword" 
                                   class="input-unified pr-10" 
                                   placeholder="4文字以上で入力"
                                   required>
                            <button type="button" id="toggleNewPassword" 
                                    class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 hover:text-gray-600">
                                <i class="fas fa-eye" id="toggleNewPasswordIcon"></i>
                            </button>
                        </div>
                        <p class="mt-1 text-xs text-gray-500">今後ログインで使用するパスワードを設定してください</p>
                    </div>

                    <!-- パスワード確認 -->
                    <div>
                        <label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-lock mr-2 text-green-600"></i>パスワード確認 *
                        </label>
                        <div class="relative">
                            <input type="password" id="confirmPassword" name="confirmPassword" 
                                   class="input-unified pr-10" 
                                   placeholder="パスワードを再入力"
                                   required>
                            <button type="button" id="toggleConfirmPassword" 
                                    class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 hover:text-gray-600">
                                <i class="fas fa-eye" id="toggleConfirmPasswordIcon"></i>
                            </button>
                        </div>
                        <div id="passwordMatchError" class="mt-1 text-xs text-red-600" style="display: none;">
                            パスワードが一致しません
                        </div>
                    </div>

                    <!-- 部門選択（表示のみ） -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-building mr-2 text-purple-600"></i>役割・権限
                        </label>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <div class="text-sm text-gray-700">
                                <div>役割: <span id="userRole" class="font-semibold text-blue-600">--</span></div>
                                <div class="mt-1 text-xs text-gray-500">役割は管理者が設定しています</div>
                            </div>
                        </div>
                    </div>

                    <!-- 通知設定 -->
                    <div class="space-y-3">
                        <label class="block text-sm font-medium text-gray-700">
                            <i class="fas fa-bell mr-2 text-yellow-600"></i>通知設定
                        </label>
                        
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" id="notifyScheduleChange" 
                                       class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                                <span class="ml-2 text-sm text-gray-700">スケジュール変更時に通知</span>
                            </label>
                            
                            <label class="flex items-center">
                                <input type="checkbox" id="notifySystemUpdate" 
                                       class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                                <span class="ml-2 text-sm text-gray-700">システム更新情報を受信</span>
                            </label>
                            
                            <label class="flex items-center">
                                <input type="checkbox" id="notifyMaintenance" 
                                       class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                                <span class="ml-2 text-sm text-gray-700">メンテナンス情報を受信</span>
                            </label>
                        </div>
                    </div>

                    <!-- プライバシー同意 -->
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <i class="fas fa-info-circle text-blue-600 mt-1"></i>
                            </div>
                            <div class="ml-3">
                                <h4 class="text-sm font-medium text-blue-900 mb-2">設定完了の確認</h4>
                                <p class="text-xs text-blue-700 mb-3">
                                    設定完了後は、新しいパスワードでログインしてください。
                                    一時パスワードは無効になります。
                                </p>
                                <label class="flex items-center">
                                    <input type="checkbox" id="setupConfirmation" 
                                           class="rounded border-blue-300 text-blue-600 focus:ring-blue-500" required>
                                    <span class="ml-2 text-xs text-blue-900">
                                        上記内容を理解し、設定を完了します *
                                    </span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- エラーメッセージ表示エリア -->
                    <div id="errorContainer" style="display: none;" 
                         class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <div class="flex items-center">
                            <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>
                            <span id="errorMessage" class="text-red-700 text-sm"></span>
                        </div>
                    </div>

                    <!-- 送信ボタン -->
                    <div class="pt-4">
                        <button type="submit" id="setupSubmitBtn" 
                                class="w-full btn-unified btn-primary-unified">
                            <span id="submitBtnText">
                                <i class="fas fa-check mr-2"></i>設定を完了
                            </span>
                            <span id="submitBtnLoading" style="display: none;">
                                <i class="fas fa-spinner fa-spin mr-2"></i>設定中...
                            </span>
                        </button>
                    </div>
                </form>

                <!-- ログアウト -->
                <div class="mt-6 text-center">
                    <button id="logoutButton" class="text-sm text-gray-500 hover:text-gray-700">
                        <i class="fas fa-sign-out-alt mr-1"></i>
                        ログアウト
                    </button>
                </div>
            </div>

            <!-- フッター -->
            <div class="text-center mt-8 text-xs text-gray-500">
                <p>CEスケジュール管理システム V2.0</p>
                <p>&copy; 2024 Hospital Systems. All rights reserved.</p>
            </div>
        </div>
    </div>

    <!-- 最適化されたJavaScript -->
    <script type="module">
        // 統合ユーティリティをインポート
        import { Utils } from './js/utils.js';
        import { DataManager } from './js/data-manager.js';
        
        // グローバルに公開
        window.Utils = Utils;
        window.DataManager = DataManager;
        window.dataManager = new DataManager();
        
        console.log('✅ 個人設定画面：モジュール読み込み完了');
    </script>

    <script>
    // 最適化されたUserSetup
    class UserSetup {
        constructor() {
            this.currentUser = null;
            this.validationRules = {
                displayName: { required: true, minLength: 2, maxLength: 50 },
                newPassword: { required: true, minLength: 4 },
                confirmPassword: { required: true },
                setupConfirmation: { required: true }
            };
            this.init();
        }

        async init() {
            try {
                await window.waitForFirebase();
                await this.checkAuth();
                this.setupEventListeners();
                this.showInterface();
                console.log('✅ 個人設定初期化完了');
            } catch (error) {
                console.error('❌ 個人設定初期化エラー:', error);
                this.redirectToLogin();
            }
        }

        async checkAuth() {
            const targetUID = sessionStorage.getItem('targetUID');
            const currentUsername = sessionStorage.getItem('currentUsername');
            
            if (!targetUID || !currentUsername) {
                throw new Error('認証情報がありません');
            }

            // 匿名認証を確保
            if (!window.auth.currentUser) {
                await window.auth.signInAnonymously();
            }

            // dataManagerを使用してユーザーデータ取得
            let userData;
            if (window.dataManager) {
                const users = await window.dataManager.getUsersByRole(null, true);
                userData = users[targetUID];
            } else {
                const snapshot = await window.database.ref(`${window.DATA_ROOT}/users/${targetUID}`).once('value');
                userData = snapshot.val();
            }

            if (!userData) {
                throw new Error('ユーザーデータが見つかりません');
            }

            // すでに設定完了している場合はダッシュボードにリダイレクト
            if (userData.setupCompleted) {
                window.location.href = 'dashboard.html';
                return;
            }

            this.currentUser = { uid: targetUID, username: currentUsername, ...userData };
            this.populateExistingData();
        }

        populateExistingData() {
            // ユーザー名表示
            document.getElementById('currentUsername').textContent = this.currentUser.username;
            
            // 役割表示
            const roleNames = {
                admin: '管理者',
                editor: '編集者', 
                viewer: '閲覧者'
            };
            document.getElementById('userRole').textContent = roleNames[this.currentUser.role] || this.currentUser.role;

            // 既存の表示名があれば設定
            if (this.currentUser.displayName) {
                document.getElementById('displayName').value = this.currentUser.displayName;
            }
            
            // 通知設定の復元
            if (this.currentUser.notifications) {
                const notifications = this.currentUser.notifications;
                document.getElementById('notifyScheduleChange').checked = notifications.scheduleChange !== false;
                document.getElementById('notifySystemUpdate').checked = notifications.systemUpdate !== false;
                document.getElementById('notifyMaintenance').checked = notifications.maintenance !== false;
            }
            
            this.updateProgress();
        }

        setupEventListeners() {
            // フォーム送信
            document.getElementById('userSetupForm').addEventListener('submit', (e) => {
                e.preventDefault();
                this.handleSubmit();
            });

            // リアルタイム進捗更新
            ['displayName', 'newPassword', 'confirmPassword', 'setupConfirmation'].forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element) {
                    element.addEventListener('change', () => this.updateProgress());
                    element.addEventListener('input', () => this.updateProgress());
                }
            });

            // パスワード表示切り替え
            document.getElementById('toggleNewPassword').addEventListener('click', () => {
                this.togglePasswordVisibility('newPassword', 'toggleNewPasswordIcon');
            });
            document.getElementById('toggleConfirmPassword').addEventListener('click', () => {
                this.togglePasswordVisibility('confirmPassword', 'toggleConfirmPasswordIcon');
            });

            // パスワード一致確認
            document.getElementById('confirmPassword').addEventListener('input', () => {
                this.checkPasswordMatch();
            });
            document.getElementById('newPassword').addEventListener('input', () => {
                this.checkPasswordMatch();
            });

            // フォームバリデーション
            document.getElementById('displayName').addEventListener('blur', () => this.validateField('displayName'));
            document.getElementById('newPassword').addEventListener('blur', () => this.validateField('newPassword'));
            document.getElementById('confirmPassword').addEventListener('blur', () => this.validateField('confirmPassword'));

            // ログアウト
            document.getElementById('logoutButton').addEventListener('click', () => this.logout());
        }

        togglePasswordVisibility(fieldId, iconId) {
            const field = document.getElementById(fieldId);
            const icon = document.getElementById(iconId);
            
            if (field.type === 'password') {
                field.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                field.type = 'password';
                icon.className = 'fas fa-eye';
            }
        }

        checkPasswordMatch() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const errorEl = document.getElementById('passwordMatchError');
            
            if (confirmPassword && newPassword !== confirmPassword) {
                errorEl.style.display = 'block';
                document.getElementById('confirmPassword').classList.add('border-red-300');
                return false;
            } else {
                errorEl.style.display = 'none';
                document.getElementById('confirmPassword').classList.remove('border-red-300');
                return true;
            }
        }

        updateProgress() {
            const fields = ['displayName', 'newPassword', 'confirmPassword', 'setupConfirmation'];
            let completedCount = 0;

            fields.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element && this.isFieldValid(fieldId)) {
                    completedCount++;
                }
            });

            const progressPercent = (completedCount / fields.length) * 100;
            document.getElementById('progressBar').style.width = `${progressPercent}%`;
            document.getElementById('progressText').textContent = `${completedCount}/${fields.length} 完了`;

            // 送信ボタンの状態更新
            const submitBtn = document.getElementById('setupSubmitBtn');
            if (completedCount === fields.length && this.checkPasswordMatch()) {
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                submitBtn.disabled = true;
                submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        validateField(fieldId) {
            const element = document.getElementById(fieldId);
            const rules = this.validationRules[fieldId];
            let isValid = true;
            let errorMessage = '';

            if (rules.required && !element.value.trim()) {
                isValid = false;
                errorMessage = 'この項目は必須です';
            } else if (rules.minLength && element.value.trim().length < rules.minLength) {
                isValid = false;
                errorMessage = `${rules.minLength}文字以上で入力してください`;
            } else if (rules.maxLength && element.value.trim().length > rules.maxLength) {
                isValid = false;
                errorMessage = `${rules.maxLength}文字以内で入力してください`;
            }

            // チェックボックスの場合
            if (element.type === 'checkbox' && rules.required && !element.checked) {
                isValid = false;
                errorMessage = '同意が必要です';
            }

            // エラー表示の制御
            this.showFieldError(fieldId, isValid ? '' : errorMessage);
            return isValid;
        }

        isFieldValid(fieldId) {
            const element = document.getElementById(fieldId);
            const rules = this.validationRules[fieldId];

            if (!rules) return true;

            if (rules.required) {
                if (element.type === 'checkbox') {
                    return element.checked;
                } else {
                    return element.value.trim() !== '';
                }
            }

            return true;
        }

        showFieldError(fieldId, message) {
            const element = document.getElementById(fieldId);
            if (message) {
                element.classList.add('border-red-300');
                element.classList.remove('border-gray-300');
            } else {
                element.classList.remove('border-red-300');
                element.classList.add('border-gray-300');
            }
        }

        showError(message) {
            const container = document.getElementById('errorContainer');
            const messageEl = document.getElementById('errorMessage');
            
            if (container && messageEl) {
                messageEl.textContent = message;
                container.style.display = 'block';
                
                setTimeout(() => {
                    container.style.display = 'none';
                }, 5000);
            }
        }

        // バッチ更新を使用したデータ保存
        async handleSubmit() {
            try {
                // バリデーション
                const requiredFields = ['displayName', 'newPassword', 'confirmPassword', 'setupConfirmation'];
                const isValid = requiredFields.every(fieldId => this.validateField(fieldId));
                
                if (!isValid || !this.checkPasswordMatch()) {
                    this.showError('入力内容に誤りがあります');
                    return;
                }

                // ローディング状態に変更
                this.setSubmitLoading(true);

                // フォームデータを収集
                const formData = this.collectFormData();
                
                // バッチ更新でデータ保存
                const updates = {};
                updates[`${window.DATA_ROOT}/users/${this.currentUser.uid}`] = {
                    ...this.currentUser,
                    ...formData,
                    password: formData.newPassword, // 新しいパスワード
                    tempPassword: null, // 一時パスワード削除
                    setupCompleted: true,
                    setupCompletedAt: Date.now(),
                    lastUpdated: Date.now()
                };

                // 監査ログも同時に追加
                const auditEntry = {
                    action: 'complete_user_setup',
                    details: {
                        displayName: formData.displayName,
                        role: this.currentUser.role,
                        passwordChanged: true
                    },
                    uid: this.currentUser.uid,
                    username: this.currentUser.username,
                    displayName: formData.displayName,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    userAgent: navigator.userAgent.substring(0, 100)
                };
                updates[`${window.DATA_ROOT}/auditLogs/${Date.now()}`] = auditEntry;

                if (window.dataManager) {
                    await window.dataManager.batchUpdate(updates);
                } else {
                    await window.database.ref().update(updates);
                }

                // 成功メッセージとセッションクリア
                if (window.Utils) {
                    window.Utils.showMessage('設定が完了しました！新しいパスワードでログインしてください。', 'success');
                }

                // セッションクリア
                sessionStorage.clear();

                // 2秒後にログイン画面にリダイレクト
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);

            } catch (error) {
                console.error('❌ 個人設定保存エラー:', error);
                this.showError('設定の保存中にエラーが発生しました');
                
                if (window.Utils) {
                    window.Utils.showMessage('設定の保存に失敗しました', 'error');
                }
            } finally {
                this.setSubmitLoading(false);
            }
        }

        collectFormData() {
            return {
                displayName: document.getElementById('displayName').value.trim(),
                newPassword: document.getElementById('newPassword').value,
                notifications: {
                    scheduleChange: document.getElementById('notifyScheduleChange').checked,
                    systemUpdate: document.getElementById('notifySystemUpdate').checked,
                    maintenance: document.getElementById('notifyMaintenance').checked
                },
                setupDevice: {
                    userAgent: navigator.userAgent,
                    timestamp: Date.now(),
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
                }
            };
        }

        setSubmitLoading(loading) {
            const submitBtn = document.getElementById('setupSubmitBtn');
            const submitText = document.getElementById('submitBtnText');
            const submitLoading = document.getElementById('submitBtnLoading');
            
            if (loading) {
                submitBtn.disabled = true;
                submitText.style.display = 'none';
                submitLoading.style.display = 'inline-flex';
            } else {
                submitBtn.disabled = false;
                submitText.style.display = 'inline-flex';
                submitLoading.style.display = 'none';
            }
        }

        logout() {
            if (confirm('設定を破棄してログアウトしますか？')) {
                sessionStorage.clear();
                window.location.href = 'index.html';
            }
        }

        redirectToLogin() {
            sessionStorage.clear();
            window.location.href = 'index.html';
        }

        showInterface() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('mainInterface').style.display = 'flex';
            
            // 初期進捗更新
            this.updateProgress();
        }
    }

    // 初期化
    if (!window.userSetupInitialized) {
        window.userSetupInitialized = true;
        document.addEventListener('DOMContentLoaded', () => {
            window.userSetup = new UserSetup();
        });
    }
    </script>
</body>
</html>
