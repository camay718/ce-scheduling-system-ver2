<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  V2</title>
    
    <!-- å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <!-- ã‚«ã‚¹ã‚¿ãƒ CSS -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/auth.css">
    <link rel="stylesheet" href="css/registration.css">
</head>
<body>
    <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div id="messageContainer" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 w-96"></div>

    <!-- ========= ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ï¼ˆå®Œæˆç‰ˆï¼‰========= -->
    <div id="loginScreen" class="auth-container">
        <div class="auth-card">
            <div class="text-center mb-8">
                <h1 class="text-2xl font-bold text-gray-800 mb-2">
                    <i class="fas fa-calendar-alt mr-2 text-green-600"></i>
                    CEã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
                </h1>
                <p class="text-sm text-gray-600">Version 2.0 - èªè¨¼ã‚·ã‚¹ãƒ†ãƒ å¼·åŒ–ç‰ˆ</p>
            </div>

<!-- ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ  -->
<form onsubmit="event.preventDefault(); handleHybridLogin();" class="space-y-4">
    <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ID/ãƒ¦ãƒ¼ã‚¶ãƒ¼å -->
    <div>
        <label for="loginId" class="block text-sm font-medium text-gray-700 mb-2">
            <i class="fas fa-user mr-1"></i>ãƒ¦ãƒ¼ã‚¶ãƒ¼ID ã¾ãŸã¯ ãƒ¦ãƒ¼ã‚¶ãƒ¼å
        </label>
        <input type="text" id="loginId" class="auth-input" 
               placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆuser_xxxxxï¼‰ã¾ãŸã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼å" 
               autocomplete="username" required>
        <div class="text-xs text-gray-500 mt-1">
            åˆå›ãƒ­ã‚°ã‚¤ãƒ³: ç®¡ç†è€…ã‹ã‚‰å—ã‘å–ã£ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ID<br>
            ï¼’å›ç›®ä»¥é™: è¨­å®šã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼å
        </div>
    </div>

    <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ -->
    <div>
        <label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-2">
            <i class="fas fa-lock mr-1"></i>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
        </label>
        <input type="password" id="loginPassword" class="auth-input" 
               placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" 
               autocomplete="current-password"
               onkeypress="if(event.key==='Enter') handleHybridLogin()" required>
        <div class="text-xs text-gray-500 mt-1">
            åˆå›ãƒ­ã‚°ã‚¤ãƒ³: åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰<br>
            ï¼’å›ç›®ä»¥é™: è¨­å®šã—ãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
        </div>
    </div>

    <!-- ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ -->
    <button type="submit" id="hybridLoginButton" class="btn-primary w-full py-3 text-center">
        <i class="fas fa-sign-in-alt mr-2"></i>ãƒ­ã‚°ã‚¤ãƒ³
    </button>
</form>

            <!-- ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ± -->
          <!-- èªè¨¼ã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
<div class="auth-mode-switch">
    <p class="text-sm text-gray-600 mb-2">
        ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã§ãªã„æ–¹ã¯
        <a href="#" onclick="showRegistrationMode()" class="auth-link">
            <i class="fas fa-user-plus mr-1"></i>æ–°è¦ç™»éŒ²
        </a>
    </p>
    <p class="text-sm text-gray-600">
        Emailèªè¨¼ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚ŒãŸæ–¹ã¯
        <a href="#" onclick="showPasswordReset()" class="auth-link">
            <i class="fas fa-key mr-1"></i>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ
        </a>
    </p>
</div>
            <div class="mt-6 text-center text-xs text-gray-500">
                <p>ğŸ”’ V2èªè¨¼ã‚·ã‚¹ãƒ†ãƒ  | ğŸ”„ Firebaseé€£æºå¯¾å¿œ</p>
                <div id="firebaseStatus" class="mt-2 px-2 py-1 rounded bg-gray-100 text-xs">
                    ğŸ”„ FirebaseåˆæœŸåŒ–ä¸­...
                </div>
            </div>
        </div>
    </div>

    <!-- ========= ãƒ¡ã‚¤ãƒ³ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼ˆV1ãƒ™ãƒ¼ã‚¹å®Œæˆç‰ˆï¼‰========= -->
    <div id="mainInterface" style="display:none;" class="flex min-h-screen bg-gray-50">
        <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
        <div class="w-64 bg-white shadow-lg">
            <div class="p-4 bg-gradient-to-r from-green-500 to-green-600 text-white">
                <h2 class="text-lg font-bold">
                    <i class="fas fa-calendar-alt mr-2"></i>
                    CEã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
                </h2>
                <p class="text-sm opacity-90">V2ã‚·ã‚¹ãƒ†ãƒ </p>
            </div>

            <nav class="p-4 space-y-2">
                <button class="w-full text-left px-3 py-2 rounded hover:bg-green-50 transition-colors">
                    <i class="fas fa-home mr-2 text-green-600"></i>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
                </button>
                <button class="w-full text-left px-3 py-2 rounded hover:bg-green-50 transition-colors">
                    <i class="fas fa-calendar mr-2 text-green-600"></i>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†
                </button>
                <button class="w-full text-left px-3 py-2 rounded hover:bg-green-50 transition-colors">
                    <i class="fas fa-users mr-2 text-green-600"></i>ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†
                </button>
                <button class="w-full text-left px-3 py-2 rounded hover:bg-green-50 transition-colors">
                    <i class="fas fa-chart-bar mr-2 text-green-600"></i>çµ±è¨ˆãƒ»åˆ†æ
                </button>
                    <div id="adminMenuSection" style="display: none;">
        <hr class="my-2 border-gray-200">
        <button onclick="openAdminDashboard()" class="w-full text-left px-3 py-2 rounded hover:bg-blue-50 transition-colors">
            <i class="fas fa-shield-alt mr-2 text-blue-600"></i>ç®¡ç†è€…æ©Ÿèƒ½
        </button>
    </div>
</nav>
            </nav>

            <div class="absolute bottom-4 left-4 right-4">
                <div class="text-xs text-gray-600 mb-2">
                    ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼: <span id="currentUserDisplay" class="font-semibold"></span>
                </div>
                <button id="logoutButtonMain" class="w-full btn-primary py-2 text-sm">
                    <i class="fas fa-sign-out-alt mr-2"></i>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                </button>
            </div>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div class="flex-1 p-6">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-tachometer-alt mr-2 text-green-600"></i>
                        ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
                    </h1>
                    <div class="flex space-x-2">
                        <button class="btn-primary">
                            <i class="fas fa-plus mr-2"></i>æ–°è¦ä½œæˆ
                        </button>
                    </div>
                </div>

                <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-gradient-to-r from-blue-400 to-blue-600 text-white p-6 rounded-lg">
                        <h3 class="text-lg font-semibold mb-2">
                            <i class="fas fa-calendar-check mr-2"></i>
                            ä»Šæ—¥ã®äºˆå®š
                        </h3>
                        <p class="text-2xl font-bold">5ä»¶</p>
                    </div>

                    <div class="bg-gradient-to-r from-green-400 to-green-600 text-white p-6 rounded-lg">
                        <h3 class="text-lg font-semibold mb-2">
                            <i class="fas fa-users mr-2"></i>
                            ç¨¼åƒã‚¹ã‚¿ãƒƒãƒ•
                        </h3>
                        <p class="text-2xl font-bold">12å</p>
                    </div>

                    <div class="bg-gradient-to-r from-yellow-400 to-yellow-600 text-white p-6 rounded-lg">
                        <h3 class="text-lg font-semibold mb-2">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            è¦æ³¨æ„äº‹é …
                        </h3>
                        <p class="text-2xl font-bold">2ä»¶</p>
                    </div>
                </div>

                <!-- ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
                <div class="mt-8">
                    <h2 class="text-xl font-semibold mb-4">ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹</h2>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="text-gray-600">
                            <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                            Phase 1å®Œæˆï¼èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ã€‚
                        </p>
                        <p class="text-gray-600 mt-2">
                            <i class="fas fa-rocket mr-2 text-green-500"></i>
                            Phase 2ã¸ã®ç§»è¡Œæº–å‚™ãŒæ•´ã„ã¾ã—ãŸã€‚
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

   <!-- JavaScriptèª­ã¿è¾¼ã¿ï¼ˆæ—¢å­˜ï¼‰ -->
<script src="js/core/firebase-config.js?v=20241205-4"></script>
<script src="js/auth/auth-core.js?v=20241205-4"></script>
<script src="js/auth/login-ui.js?v=20241205-4"></script>
<script src="js/auth/email-auth.js?v=20241205-4"></script>
<script src="js/auth/initial-login.js?v=20241205-4"></script>

<!-- ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ– -->
<script>
    // æ–°è¦ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
    function showRegistrationMode() {
        window.location.href = 'pages/register.html';
    }

    // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆè¡¨ç¤º
    function showPasswordReset() {
        const email = prompt('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆç”¨ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
        if (email && window.emailAuthSystem) {
            window.emailAuthSystem.resetPassword(email).then(result => {
                alert(result.message);
            });
        }
    }

    // ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ç¢ºèª & ç®¡ç†è€…æ©Ÿèƒ½åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', function() {
        console.log('âœ… V2ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•å®Œäº†');
        console.log('ğŸ” èªè¨¼ã‚·ã‚¹ãƒ†ãƒ æº–å‚™:', window.authSystem ? 'å®Œäº†' : 'æº–å‚™ä¸­');
        console.log('ğŸ”¥ FirebaseçŠ¶æ…‹:', window.isFirebaseReady ? 'æ¥ç¶šä¸­' : 'æº–å‚™ä¸­');
        
        // ç®¡ç†è€…ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤ºåˆ¶å¾¡
        setTimeout(() => {
            if (window.authSystem && window.authSystem.isAdmin()) {
                document.getElementById('adminMenuSection').style.display = 'block';
                console.log('ğŸ‘¨â€ğŸ’¼ ç®¡ç†è€…ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤º');
            }
        }, 2000);
    });

    // ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰é–‹ã
    function openAdminDashboard() {
        if (window.authSystem && window.authSystem.isAdmin()) {
            window.open('pages/admin-dashboard.html?admin=true', '_blank');
        } else {
            alert('ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™');
        }
    }

    // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–
    window.addEventListener('error', function(event) {
        console.error('âŒ ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼:', event.error);
    });

    window.addEventListener('unhandledrejection', function(event) {
        console.error('âŒ Promiseæ‹’å¦:', event.reason);
    });
  // ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ï¼ˆè¿½åŠ ï¼‰
    async function handleHybridLogin() {
        const button = document.getElementById('hybridLoginButton');
        const loginId = document.getElementById('loginId')?.value?.trim();
        const password = document.getElementById('loginPassword')?.value;

        if (!loginId || !password) {
            showMessage('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¾ãŸã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
            return;
        }

        // ãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ–
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ãƒ­ã‚°ã‚¤ãƒ³ä¸­...';

        try {
            if (window.initialLoginDetector && window.initialLoginDetector.isInitialized) {
                const result = await window.initialLoginDetector.attemptLogin(loginId, password);
                
                if (result.success) {
                    if (result.requiresSetup) {
                        // åˆæœŸãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ - å€‹äººè¨­å®šç”»é¢ã¸
                        showMessage('åˆæœŸãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼å€‹äººè¨­å®šã‚’å®Œäº†ã—ã¦ãã ã•ã„', 'success');
                        
                        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§æ¸¡ã™
                        const userDataParam = encodeURIComponent(JSON.stringify(result.userData));
                        setTimeout(() => {
                            window.location.href = `pages/user-setup.html?userData=${userDataParam}`;
                        }, 1000);
                    } else {
                        // é€šå¸¸ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ - ãƒ¡ã‚¤ãƒ³ç”»é¢ã¸
                        showMessage('ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼', 'success');
                        
                        // èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã«é€šçŸ¥
                        if (window.authSystem) {
                            window.authSystem.currentUser = result.userData.auth?.username || result.userId;
                            window.authSystem.userProfile = result.userData;
                            window.authSystem.userRole = result.userData.permissions?.level || 'viewer';
                            window.authSystem.userDepartment = result.userData.profile?.department || null;
                            window.authSystem.showMainInterface();
                        }
                    }
                }
            } else {
                showMessage('ãƒ­ã‚°ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ ãŒæº–å‚™ã§ãã¦ã„ã¾ã›ã‚“', 'error');
            }
        } catch (error) {
            console.error('âŒ ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
            showMessage(error.message, 'error');
        } finally {
            // ãƒœã‚¿ãƒ³å¾©å…ƒ
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i>ãƒ­ã‚°ã‚¤ãƒ³';
        }
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºé–¢æ•°ï¼ˆè¿½åŠ ï¼‰
    function showMessage(text, type = 'info') {
        const container = document.getElementById('messageContainer');
        if (!container) {
            console.log(`[${type.toUpperCase()}] ${text}`);
            return;
        }
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type} px-4 py-2 mb-2 rounded-lg`;
        const icons = { success: 'check', error: 'times', warning: 'exclamation', info: 'info' };
        messageDiv.innerHTML = `<i class="fas fa-${icons[type]}-circle mr-2"></i>${text}`;
        
        const colors = {
            success: 'bg-green-100 text-green-800',
            error: 'bg-red-100 text-red-800',
            warning: 'bg-yellow-100 text-yellow-800',
            info: 'bg-blue-100 text-blue-800'
        };
        messageDiv.className += ` ${colors[type]}`;
        
        container.appendChild(messageDiv);
        setTimeout(() => messageDiv.remove(), 5000);
    }
</script>
</body>
</html>
