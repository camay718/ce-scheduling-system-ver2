<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEスケジュール管理システム V2 - ログイン</title>
    <link href="styles/main.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
</head>
<body class="login-body">
    <div class="login-container">
        <div class="login-header">
            <h1>CEスケジュール管理システム V2</h1>
            <p>Clinical Engineer Schedule Management System</p>
        </div>
        
        <div class="login-form-container">
            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label for="email">メールアドレス</label>
                    <input type="email" id="email" name="email" required>
                </div>
                
                <div class="form-group">
                    <label for="password">パスワード</label>
                    <input type="password" id="password" name="password" required>
                </div>
                
                <button type="submit" class="login-btn">ログイン</button>
            </form>
            
            <div class="login-options">
                <button id="anonymousLoginBtn" class="anonymous-btn">匿名ログイン</button>
                <p class="login-help">
                    初回利用時は匿名ログインでアカウント設定を行ってください
                </p>
            </div>
        </div>
        
        <div id="loginMessage" class="message-container"></div>
        
        <div id="loading" class="loading" style="display: none;">
            <div class="loading-spinner"></div>
            <p>認証中...</p>
        </div>
    </div>

    <script>
        // Firebase設定
        const firebaseConfig = {
            apiKey: "AIzaSyBkf4T8ZQ9dF5LhXlEf2R3xJ4uP7hV1nM9",
            authDomain: "ce-schedule-management.firebaseapp.com",
            databaseURL: "https://ce-schedule-management-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "ce-schedule-management",
            storageBucket: "ce-schedule-management.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef123456789"
        };

        // Firebase初期化
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        // 認証状態監視
        auth.onAuthStateChanged((user) => {
            if (user) {
                console.log('ユーザーがログインしました:', user.uid);
                window.location.href = 'dashboard.html';
            }
        });

        // ログインフォーム処理
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                showMessage('メールアドレスとパスワードを入力してください', 'error');
                return;
            }
            
            try {
                showLoading();
                await auth.signInWithEmailAndPassword(email, password);
                showMessage('ログインしました', 'success');
            } catch (error) {
                hideLoading();
                console.error('ログインエラー:', error);
                showMessage(getErrorMessage(error.code), 'error');
            }
        });

        // 匿名ログイン処理
        document.getElementById('anonymousLoginBtn').addEventListener('click', async () => {
            try {
                showLoading();
                await auth.signInAnonymously();
                showMessage('匿名ログインしました', 'success');
            } catch (error) {
                hideLoading();
                console.error('匿名ログインエラー:', error);
                showMessage('匿名ログインに失敗しました', 'error');
            }
        });

        // エラーメッセージ取得
        function getErrorMessage(errorCode) {
            switch (errorCode) {
                case 'auth/user-not-found':
                    return 'ユーザーが見つかりません';
                case 'auth/wrong-password':
                    return 'パスワードが正しくありません';
                case 'auth/invalid-email':
                    return 'メールアドレスの形式が正しくありません';
                case 'auth/too-many-requests':
                    return 'ログイン試行回数が制限されています。しばらく待ってから再試行してください';
                default:
                    return 'ログインに失敗しました';
            }
        }

        // メッセージ表示
        function showMessage(message, type = 'info') {
            const messageContainer = document.getElementById('loginMessage');
            messageContainer.innerHTML = `<div class="message ${type}">${message}</div>`;
            
            setTimeout(() => {
                messageContainer.innerHTML = '';
            }, 3000);
        }

        // ローディング表示制御
        function showLoading() {
            document.getElementById('loading').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
    </script>
</body>
</html>
