<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEスケジュール管理システム V2 - ログイン</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- 外部ライブラリ -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- ✅ 統合CSS -->
    <link rel="stylesheet" href="styles/main.css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <!-- Firebase設定 -->
    <script src="js/config/firebase-config.js?v=20241212"></script>
</head>
<body class="theme-unified bg-gradient-to-br from-blue-50 via-white to-indigo-50 min-h-screen">
    <!-- ローディング画面 -->
    <div id="globalLoading" class="fixed inset-0 bg-white flex items-center justify-center z-50" style="display:none;">
        <div class="text-center">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-gray-600" id="loadingMessage">システムを初期化しています...</p>
        </div>
    </div>

    <!-- メインインターフェース -->
    <div id="mainInterface" class="min-h-screen flex">
        <!-- 左側：ブランディング -->
        <div class="hidden lg:flex lg:w-1/2 bg-gradient-to-br from-blue-600 via-blue-700 to-indigo-800 relative overflow-hidden">
            <!-- 背景パターン -->
            <div class="absolute inset-0 opacity-10">
                <svg class="w-full h-full" viewBox="0 0 100 100" preserveAspectRatio="none">
                    <defs>
                        <pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse">
                            <path d="M 10 0 L 0 0 0 10" fill="none" stroke="white" stroke-width="0.5"/>
                        </pattern>
                    </defs>
                    <rect width="100" height="100" fill="url(#grid)"/>
                </svg>
            </div>
            
            <!-- コンテンツ -->
            <div class="relative z-10 flex flex-col justify-center px-12 text-white">
                <div class="mb-8">
                    <div class="inline-flex items-center justify-center w-20 h-20 bg-white bg-opacity-20 rounded-full mb-6">
                        <i class="fas fa-calendar-alt text-3xl"></i>
                    </div>
                    <h1 class="text-4xl font-bold mb-4">
                        CEスケジュール管理システム
                    </h1>
                    <p class="text-xl text-blue-100 mb-8">
                        効率的で直感的な医療現場のスケジュール管理
                    </p>
                </div>
                
                <!-- 特徴一覧 -->
                <div class="space-y-4">
                    <div class="flex items-center">
                        <i class="fas fa-check-circle text-green-400 mr-3"></i>
                        <span>リアルタイム同期による最新情報の共有</span>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-check-circle text-green-400 mr-3"></i>
                        <span>直感的な操作で簡単スケジュール作成</span>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-check-circle text-green-400 mr-3"></i>
                        <span>部門別・個人別の詳細な勤務管理</span>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-check-circle text-green-400 mr-3"></i>
                        <span>セキュアなクラウドベースシステム</span>
                    </div>
                </div>

                <!-- バージョン情報 -->
                <div class="mt-12 pt-8 border-t border-blue-500 border-opacity-30">
                    <div class="text-sm text-blue-200">
                        <div class="flex items-center justify-between">
                            <span>Version 2.0</span>
                            <span id="currentTime"></span>
                        </div>
                        <div class="mt-2 text-xs">
                            &copy; 2024 Hospital Systems. All rights reserved.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 右側：ログインフォーム -->
        <div class="w-full lg:w-1/2 flex items-center justify-center p-8">
            <div class="w-full max-w-md">
                <!-- ヘッダー -->
                <div class="text-center mb-8">
                    <div class="lg:hidden mb-4">
                        <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-600 rounded-full mb-4">
                            <i class="fas fa-calendar-alt text-2xl text-white"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-900">CEスケジュール管理</h2>
                    </div>
                    <h3 class="text-2xl lg:text-3xl font-bold text-gray-900 mb-2">ログイン</h3>
                    <p class="text-gray-600">アカウント情報を入力してください</p>
                </div>

                <!-- ログインフォーム -->
                <div class="glass-card p-8">
                    <form id="loginForm" class="space-y-6">
                        <!-- ユーザー名入力 -->
                        <div>
                            <label for="username" class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-user mr-2 text-blue-600"></i>ユーザー名
                            </label>
                            <input type="text" id="username" name="username" 
                                   class="input-unified" 
                                   placeholder="ユーザー名を入力"
                                   autocomplete="username"
                                   required>
                            <div id="usernameError" class="mt-1 text-xs text-red-600" style="display: none;"></div>
                        </div>

                        <!-- パスワード入力 -->
                        <div>
                            <label for="password" class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-lock mr-2 text-green-600"></i>パスワード
                            </label>
                            <div class="relative">
                                <input type="password" id="password" name="password" 
                                       class="input-unified pr-10" 
                                       placeholder="パスワードを入力"
                                       autocomplete="current-password"
                                       required>
                                <button type="button" id="togglePassword" 
                                        class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 hover:text-gray-600">
                                    <i class="fas fa-eye" id="togglePasswordIcon"></i>
                                </button>
                            </div>
                            <div id="passwordError" class="mt-1 text-xs text-red-600" style="display: none;"></div>
                        </div>

                        <!-- オプション -->
                        <div class="flex items-center justify-between">
                            <label class="flex items-center">
                                <input type="checkbox" id="rememberMe" 
                                       class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-700">ログイン状態を保持</span>
                            </label>
                            
                            <button type="button" id="forgotPassword" 
                                    class="text-sm text-blue-600 hover:text-blue-800">
                                パスワードを忘れた方
                            </button>
                        </div>

                        <!-- エラーメッセージ表示エリア -->
                        <div id="loginErrorContainer" style="display: none;" 
                             class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>
                                <span id="loginErrorMessage" class="text-red-700 text-sm"></span>
                            </div>
                        </div>

                        <!-- ログインボタン -->
                        <div>
                            <button type="submit" id="loginSubmitBtn" 
                                    class="w-full btn-unified btn-primary-unified">
                                <span id="loginBtnText">
                                    <i class="fas fa-sign-in-alt mr-2"></i>ログイン
                                </span>
                                <span id="loginBtnLoading" style="display: none;">
                                    <i class="fas fa-spinner fa-spin mr-2"></i>認証中...
                                </span>
                            </button>
                        </div>
                    </form>

                    <!-- 新規登録リンク -->
                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <div class="text-center">
                            <p class="text-sm text-gray-600 mb-3">初回利用の方</p>
                            <button id="newUserBtn" class="btn-unified btn-outline-unified w-full">
                                <i class="fas fa-user-plus mr-2"></i>新規ユーザー登録
                            </button>
                        </div>
                    </div>

                    <!-- システム情報 -->
                    <div class="mt-6 pt-4 border-t border-gray-100">
                        <div class="flex items-center justify-between text-xs text-gray-500">
                            <span id="connectionStatus">
                                <i class="fas fa-circle text-green-500 mr-1"></i>
                                接続良好
                            </span>
                            <span>最終更新: <span id="lastUpdate">--</span></span>
                        </div>
                    </div>
                </div>

                <!-- ヘルプ・サポート -->
                <div class="mt-6 text-center space-y-2">
                    <button id="systemInfoBtn" class="text-sm text-gray-500 hover:text-gray-700">
                        <i class="fas fa-info-circle mr-1"></i>
                        システム情報
                    </button>
                    <div class="text-xs text-gray-400">
                        お困りの際は管理者にお問い合わせください
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- パスワードリセットモーダル -->
    <div id="passwordResetModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display:none;">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="flex justify-between items-center p-6 border-b">
                <h3 class="text-lg font-bold text-gray-900">
                    <i class="fas fa-key mr-2 text-blue-600"></i>
                    パスワードリセット
                </h3>
                <button id="closePasswordResetModal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="p-6">
                <p class="text-sm text-gray-700 mb-4">
                    パスワードをリセットするには、管理者に連絡してください。
                    セキュリティ上の理由により、パスワードリセットは管理者が手動で行います。
                </p>
                
                <div class="bg-blue-50 p-4 rounded-lg mb-4">
                    <h4 class="text-sm font-semibold text-blue-900 mb-2">連絡先情報</h4>
                    <div class="text-sm text-blue-800 space-y-1">
                        <div><i class="fas fa-envelope mr-2"></i>admin@hospital.com</div>
                        <div><i class="fas fa-phone mr-2"></i>内線: 1234</div>
                        <div><i class="fas fa-clock mr-2"></i>受付時間: 平日 9:00-17:00</div>
                    </div>
                </div>

                <div class="text-xs text-gray-500">
                    ユーザー名とリセット理由を明記の上、ご連絡ください。
                </div>
            </div>
        </div>
    </div>

    <!-- システム情報モーダル -->
    <div id="systemInfoModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display:none;">
        <div class="bg-white rounded-lg shadow-xl max-w-lg w-full mx-4 max-h-96 overflow-y-auto">
            <div class="flex justify-between items-center p-6 border-b">
                <h3 class="text-lg font-bold text-gray-900">
                    <i class="fas fa-info-circle mr-2 text-blue-600"></i>
                    システム情報
                </h3>
                <button id="closeSystemInfoModal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="p-6 space-y-4">
                <div>
                    <h4 class="font-semibold text-gray-900 mb-2">システム概要</h4>
                    <div class="text-sm text-gray-700 space-y-1">
                        <div>システム名: CEスケジュール管理システム</div>
                        <div>バージョン: 2.0</div>
                        <div>リリース日: 2024年12月</div>
                        <div>開発: Hospital Systems Team</div>
                    </div>
                </div>
                
                <div>
                    <h4 class="font-semibold text-gray-900 mb-2">サポートブラウザ</h4>
                    <div class="text-sm text-gray-700 space-y-1">
                        <div><i class="fab fa-chrome mr-2"></i>Google Chrome (推奨)</div>
                        <div><i class="fab fa-firefox mr-2"></i>Mozilla Firefox</div>
                        <div><i class="fab fa-safari mr-2"></i>Safari (macOS/iOS)</div>
                        <div><i class="fab fa-edge mr-2"></i>Microsoft Edge</div>
                    </div>
                </div>
                
                <div>
                    <h4 class="font-semibold text-gray-900 mb-2">セキュリティ</h4>
                    <div class="text-sm text-gray-700">
                        <div class="flex items-center mb-1">
                            <i class="fas fa-shield-alt text-green-600 mr-2"></i>
                            <span>SSL/TLS 暗号化通信</span>
                        </div>
                        <div class="flex items-center mb-1">
                            <i class="fas fa-database text-blue-600 mr-2"></i>
                            <span>リアルタイムデータ同期</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-user-shield text-purple-600 mr-2"></i>
                            <span>役割ベースアクセス制御</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ✅ 最適化されたJavaScript -->
    <script type="module">
        // ✅ 統合ユーティリティをインポート
        import { Utils } from './js/utils.js';
        import { DataManager } from './js/data-manager.js';
        
        // グローバルに公開
        window.Utils = Utils;
        window.DataManager = DataManager;
        window.dataManager = new DataManager();
        
        console.log('✅ ログイン画面：モジュール読み込み完了');
    </script>

    <script>
    // ✅ 最適化されたLoginSystem
    class LoginSystem {
        constructor() {
            this.maxLoginAttempts = 5;
            this.lockoutDuration = 15 * 60 * 1000; // 15分
            this.init();
        }

        async init() {
            try {
                await window.waitForFirebase();
                this.setupEventListeners();
                this.updateCurrentTime();
                this.checkExistingSession();
                console.log('✅ ログインシステム初期化完了');
            } catch (error) {
                console.error('❌ ログインシステム初期化エラー:', error);
                this.showConnectionError();
            }
        }

        setupEventListeners() {
            // フォーム送信
            document.getElementById('loginForm').addEventListener('submit', (e) => {
                e.preventDefault();
                this.handleLogin();
            });

            // パスワード表示切り替え
            document.getElementById('togglePassword').addEventListener('click', () => {
                this.togglePasswordVisibility();
            });

            // 新規ユーザー登録
            document.getElementById('newUserBtn').addEventListener('click', () => {
                this.handleNewUserRegistration();
            });

            // モーダル制御
            document.getElementById('forgotPassword').addEventListener('click', () => {
                this.showPasswordResetModal();
            });
            document.getElementById('closePasswordResetModal').addEventListener('click', () => {
                this.hidePasswordResetModal();
            });

            document.getElementById('systemInfoBtn').addEventListener('click', () => {
                this.showSystemInfoModal();
            });
            document.getElementById('closeSystemInfoModal').addEventListener('click', () => {
                this.hideSystemInfoModal();
            });

            // フィールドバリデーション
            document.getElementById('username').addEventListener('input', () => {
                this.validateField('username');
            });
            document.getElementById('password').addEventListener('input', () => {
                this.validateField('password');
            });

            // Enterキーでのフォーカス移動
            document.getElementById('username').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    document.getElementById('password').focus();
                }
            });
        }

        updateCurrentTime() {
            const updateTime = () => {
                const now = new Date();
                const timeString = now.toLocaleString('ja-JP', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const currentTimeEl = document.getElementById('currentTime');
                const lastUpdateEl = document.getElementById('lastUpdate');
                
                if (currentTimeEl) currentTimeEl.textContent = timeString;
                if (lastUpdateEl) lastUpdateEl.textContent = now.toLocaleTimeString('ja-JP');
            };

            updateTime();
            setInterval(updateTime, 60000); // 1分毎に更新
        }

        // ✅ 最適化：セッション確認
        async checkExistingSession() {
            try {
                const targetUID = sessionStorage.getItem('targetUID');
                const currentUsername = sessionStorage.getItem('currentUsername');
                
                if (targetUID && currentUsername) {
                    // ✅ dataManagerを使用してユーザーデータ確認
                    if (window.dataManager) {
                        const users = await window.dataManager.getUsersByRole(null, true);
                        const userData = users[targetUID];
                        
                        if (userData) {
                            // 既存セッションが有効
                            if (userData.setupCompleted) {
                                window.location.href = 'dashboard.html';
                            } else {
                                window.location.href = 'user-setup-fixed.html';
                            }
                            return;
                        }
                    }
                }
                
                // セッションクリア
                sessionStorage.clear();
            } catch (error) {
                console.error('❌ セッション確認エラー:', error);
                sessionStorage.clear();
            }
        }

        validateField(fieldName) {
            const field = document.getElementById(fieldName);
            const errorEl = document.getElementById(fieldName + 'Error');
            let isValid = true;
            let errorMessage = '';

            if (!field.value.trim()) {
                isValid = false;
                errorMessage = `${fieldName === 'username' ? 'ユーザー名' : 'パスワード'}を入力してください`;
            } else if (fieldName === 'username' && field.value.trim().length < 3) {
                isValid = false;
                errorMessage = 'ユーザー名は3文字以上で入力してください';
            } else if (fieldName === 'password' && field.value.length < 4) {
                isValid = false;
                errorMessage = 'パスワードは4文字以上で入力してください';
            }

            if (errorEl) {
                if (errorMessage) {
                    errorEl.textContent = errorMessage;
                    errorEl.style.display = 'block';
                    field.classList.add('border-red-300');
                } else {
                    errorEl.style.display = 'none';
                    field.classList.remove('border-red-300');
                }
            }

            return isValid;
        }

        togglePasswordVisibility() {
            const passwordField = document.getElementById('password');
            const toggleIcon = document.getElementById('togglePasswordIcon');
            
            if (passwordField.type === 'password') {
                passwordField.type = 'text';
                toggleIcon.className = 'fas fa-eye-slash';
            } else {
                passwordField.type = 'password';
                toggleIcon.className = 'fas fa-eye';
            }
        }

        // ✅ 最適化：ログイン処理
        async handleLogin() {
            try {
                // バリデーション
                const usernameValid = this.validateField('username');
                const passwordValid = this.validateField('password');
                
                if (!usernameValid || !passwordValid) {
                    return;
                }

                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value;

                // ログイン試行回数チェック
                if (this.isAccountLocked(username)) {
                    this.showLoginError('アカウントが一時的にロックされています。しばらく待ってから再試行してください。');
                    return;
                }

                // ✅ ローディング状態開始
                this.setLoginLoading(true);

                // 匿名認証を確保
                if (!window.auth.currentUser) {
                    await window.auth.signInAnonymously();
                }

                // ✅ 最適化：dataManagerを使用してユーザー検索
                let userData = null;
                let userUID = null;

                if (window.dataManager) {
                    const users = await window.dataManager.getUsersByRole(null, true);
                    
                    // ユーザー名でユーザー検索
                    for (const [uid, user] of Object.entries(users)) {
                        if (user.username === username) {
                            userData = user;
                            userUID = uid;
                            break;
                        }
                    }
                } else {
                    // フォールバック：直接Firebase検索
                    const usersSnapshot = await window.database.ref(`${window.DATA_ROOT}/users`)
                        .orderByChild('username')
                        .equalTo(username)
                        .once('value');
                    
                    const usersData = usersSnapshot.val();
                    if (usersData) {
                        userUID = Object.keys(usersData)[0];
                        userData = usersData[userUID];
                    }
                }

                if (!userData) {
                    this.recordFailedAttempt(username);
                    this.showLoginError('ユーザー名またはパスワードが正しくありません');
                    return;
                }

                // パスワード検証（簡易実装 - 実際のシステムではハッシュ化必須）
                if (userData.password !== password) {
                    this.recordFailedAttempt(username);
                    this.showLoginError('ユーザー名またはパスワードが正しくありません');
                    return;
                }

                // ✅ ログイン成功処理
                await this.handleSuccessfulLogin(userUID, username, userData);

            } catch (error) {
                console.error('❌ ログイン処理エラー:', error);
                this.showLoginError('ログイン処理中にエラーが発生しました');
            } finally {
                this.setLoginLoading(false);
            }
        }

        // ✅ 最適化：ログイン成功処理
        async handleSuccessfulLogin(userUID, username, userData) {
            try {
                // セッション情報保存
                sessionStorage.setItem('targetUID', userUID);
                sessionStorage.setItem('currentUsername', username);
                
                // Remember me 処理
                if (document.getElementById('rememberMe').checked) {
                    localStorage.setItem('rememberedUsername', username);
                } else {
                    localStorage.removeItem('rememberedUsername');
                }

                // ログイン試行回数リセット
                this.clearFailedAttempts(username);

                // ✅ 監査ログ記録（バッチ更新で最適化）
                const auditEntry = {
                    action: 'login',
                    details: { 
                        loginMethod: 'username_password',
                        rememberMe: document.getElementById('rememberMe').checked
                    },
                    uid: userUID,
                    username: username,
                    displayName: userData.displayName || username,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    userAgent: navigator.userAgent.substring(0, 100),
                    ipAddress: 'unknown' // 実装時にIPアドレス取得
                };

                if (window.dataManager) {
                    const updates = {};
                    updates[`${window.DATA_ROOT}/auditLogs/${Date.now()}`] = auditEntry;
                    // 最終ログイン時刻も更新
                    updates[`${window.DATA_ROOT}/users/${userUID}/lastLoginAt`] = firebase.database.ServerValue.TIMESTAMP;
                    
                    await window.dataManager.batchUpdate(updates);
                } else {
                    // フォールバック
                    await Promise.all([
                        window.database.ref(`${window.DATA_ROOT}/auditLogs`).push(auditEntry),
                        window.database.ref(`${window.DATA_ROOT}/users/${userUID}/lastLoginAt`).set(firebase.database.ServerValue.TIMESTAMP)
                    ]);
                }

                // ✅ 成功メッセージ
                if (window.Utils) {
                    window.Utils.showMessage('ログインしました', 'success');
                }

                // リダイレクト
                setTimeout(() => {
                    if (userData.setupCompleted) {
                        window.location.href = 'dashboard.html';
                    } else {
                        window.location.href = 'user-setup-fixed.html';
                    }
                }, 1000);

            } catch (error) {
                console.error('❌ ログイン成功処理エラー:', error);
                this.showLoginError('ログイン後の処理でエラーが発生しました');
            }
        }

        // ログイン試行回数管理
        isAccountLocked(username) {
            const attempts = JSON.parse(localStorage.getItem('loginAttempts') || '{}');
            const userAttempts = attempts[username];
            
            if (!userAttempts) return false;
            
            const now = Date.now();
            if (userAttempts.count >= this.maxLoginAttempts) {
                if (now - userAttempts.lastAttempt < this.lockoutDuration) {
                    return true;
                } else {
                    // ロックアウト期間終了、リセット
                    delete attempts[username];
                    localStorage.setItem('loginAttempts', JSON.stringify(attempts));
                    return false;
                }
            }
            
            return false;
        }

        recordFailedAttempt(username) {
            const attempts = JSON.parse(localStorage.getItem('loginAttempts') || '{}');
            const now = Date.now();
            
            if (!attempts[username]) {
                attempts[username] = { count: 0, lastAttempt: 0 };
            }
            
            attempts[username].count++;
            attempts[username].lastAttempt = now;
            
            localStorage.setItem('loginAttempts', JSON.stringify(attempts));
            
            if (attempts[username].count >= this.maxLoginAttempts) {
                this.showLoginError(`アカウントが${this.maxLoginAttempts}回の失敗によりロックされました。${this.lockoutDuration / 60000}分後に再試行してください。`);
            }
        }

        clearFailedAttempts(username) {
            const attempts = JSON.parse(localStorage.getItem('loginAttempts') || '{}');
            delete attempts[username];
            localStorage.setItem('loginAttempts', JSON.stringify(attempts));
        }

        handleNewUserRegistration() {
            // 新規ユーザー登録ダイアログ
            const username = prompt('新規ユーザー名を入力してください（3文字以上）:');
            if (!username || username.trim().length < 3) {
                if (window.Utils) {
                    window.Utils.showMessage('ユーザー名は3文字以上で入力してください', 'warning');
                }
                return;
            }

            const password = prompt('パスワードを入力してください（4文字以上）:');
            if (!password || password.length < 4) {
                if (window.Utils) {
                    window.Utils.showMessage('パスワードは4文字以上で入力してください', 'warning');
                }
                return;
            }

            this.createNewUser(username.trim(), password);
        }

        // ✅ 最適化：新規ユーザー作成
        async createNewUser(username, password) {
            try {
                // ✅ ローディング表示
                if (window.Utils) {
                    window.Utils.showLoading(true, '新規ユーザーを作成中...');
                }

                // 匿名認証を確保
                if (!window.auth.currentUser) {
                    await window.auth.signInAnonymously();
                }

                // ユーザー名重複チェック
                if (window.dataManager) {
                    const users = await window.dataManager.getUsersByRole(null, true);
                    const existingUser = Object.values(users).find(user => user.username === username);
                    
                    if (existingUser) {
                        if (window.Utils) {
                            window.Utils.showMessage('このユーザー名は既に使用されています', 'warning');
                        }
                        return;
                    }
                } else {
                    // フォールバック
                    const snapshot = await window.database.ref(`${window.DATA_ROOT}/users`)
                        .orderByChild('username')
                        .equalTo(username)
                        .once('value');
                    
                    if (snapshot.exists()) {
                        if (window.Utils) {
                            window.Utils.showMessage('このユーザー名は既に使用されています', 'warning');
                        }
                        return;
                    }
                }

                // 新規ユーザー作成
                const newUserUID = window.database.ref().child('users').push().key;
                const userData = {
                    username: username,
                    password: password, // 実際のシステムではハッシュ化必須
                    setupCompleted: false,
                    createdAt: Date.now(),
                    role: 'viewer' // デフォルト役割
                };

                // ✅ バッチ更新で新規ユーザー作成
                if (window.dataManager) {
                    const updates = {};
                    updates[`${window.DATA_ROOT}/users/${newUserUID}`] = userData;
                    
                    // 監査ログも追加
                    const auditEntry = {
                        action: 'create_user',
                        details: { username: username, method: 'self_registration' },
                        uid: newUserUID,
                        username: username,
                        displayName: username,
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        userAgent: navigator.userAgent.substring(0, 100)
                    };
                    updates[`${window.DATA_ROOT}/auditLogs/${Date.now()}`] = auditEntry;
                    
                    await window.dataManager.batchUpdate(updates);
                } else {
                    await window.database.ref(`${window.DATA_ROOT}/users/${newUserUID}`).set(userData);
                }

                // セッション設定
                sessionStorage.setItem('targetUID', newUserUID);
                sessionStorage.setItem('currentUsername', username);

                if (window.Utils) {
                    window.Utils.showMessage('新規ユーザーを作成しました。設定画面に移動します...', 'success');
                }

                setTimeout(() => {
                    window.location.href = 'user-setup-fixed.html';
                }, 2000);

            } catch (error) {
                console.error('❌ 新規ユーザー作成エラー:', error);
                if (window.Utils) {
                    window.Utils.showMessage('ユーザー作成に失敗しました', 'error');
                }
            } finally {
                if (window.Utils) {
                    window.Utils.showLoading(false);
                }
            }
        }

        setLoginLoading(loading) {
            const submitBtn = document.getElementById('loginSubmitBtn');
            const loginText = document.getElementById('loginBtnText');
            const loginLoading = document.getElementById('loginBtnLoading');
            
            if (loading) {
                submitBtn.disabled = true;
                loginText.style.display = 'none';
                loginLoading.style.display = 'inline-flex';
            } else {
                submitBtn.disabled = false;
                loginText.style.display = 'inline-flex';
                loginLoading.style.display = 'none';
            }
        }

        showLoginError(message) {
            const container = document.getElementById('loginErrorContainer');
            const messageEl = document.getElementById('loginErrorMessage');
            
            if (container && messageEl) {
                messageEl.textContent = message;
                container.style.display = 'block';
                
                // 5秒後に自動非表示
                setTimeout(() => {
                    container.style.display = 'none';
                }, 5000);
            }
        }

        showConnectionError() {
            const statusEl = document.getElementById('connectionStatus');
            if (statusEl) {
                statusEl.innerHTML = '<i class="fas fa-circle text-red-500 mr-1"></i>接続エラー';
            }
        }

        showPasswordResetModal() {
            document.getElementById('passwordResetModal').style.display = 'flex';
        }

        hidePasswordResetModal() {
            document.getElementById('passwordResetModal').style.display = 'none';
        }

        showSystemInfoModal() {
            document.getElementById('systemInfoModal').style.display = 'flex';
        }

        hideSystemInfoModal() {
            document.getElementById('systemInfoModal').style.display = 'none';
        }
    }

    // ✅ 初期化
    if (!window.loginSystemInitialized) {
        window.loginSystemInitialized = true;
        document.addEventListener('DOMContentLoaded', () => {
            window.loginSystem = new LoginSystem();
        });
    }
    </script>
</body>
</html>
