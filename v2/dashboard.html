<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEスケジュール管理システム V2 - ダッシュボード</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- 外部ライブラリ -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- 統一テーマ -->
    <link rel="stylesheet" href="css/theme-unified.css?v=20241217">
    
    <!-- 追加スタイル -->
    <style>
/* 月次業務強化スタイル（完全修正版） */
.monthly-task-badge {
    position: absolute;
    top: 8px;
    left: 8px;
    background: linear-gradient(135deg, #f97316, #ea580c);
    color: white;
    font-size: 10px;
    padding: 3px 8px;
    border-radius: 12px;
    font-weight: bold;
    line-height: 1;
    box-shadow: 0 2px 4px rgba(249, 115, 22, 0.3);
    z-index: 10;
    letter-spacing: 0.3px;
}

/* 月次業務カード（バッジ対応版） */
.monthly-task-card {
    margin-top: 8px;
    padding: 16px 12px 12px 12px; /* 上部パディング増加（バッジ分） */
    border-radius: 8px;
    font-size: 12px;
    position: relative;
    transition: all 0.2s ease;
    border: 2px solid transparent;
}

/* 実施入力セクション（時間対応版） */
.monthly-input-section {
    background: rgba(255, 255, 255, 0.7);
    border-radius: 6px;
    padding: 8px;
    margin-top: 8px;
    border: 1px solid rgba(0, 0, 0, 0.1);
}

.monthly-input-row {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 6px;
    font-size: 11px;
    flex-wrap: wrap;
}

.monthly-input-row input[type="date"] {
    width: 110px;
}

.monthly-input-row input[type="time"] {
    width: 70px;
}

/* 実施履歴表示 */
.execution-history {
    background: rgba(248, 250, 252, 0.8);
    border-radius: 4px;
    padding: 6px;
    margin-top: 6px;
    max-height: 80px;
    overflow-y: auto;
    font-size: 10px;
}

.execution-record {
    color: #64748b;
    margin-bottom: 2px;
    padding: 2px 4px;
    background: white;
    border-radius: 3px;
    border-left: 3px solid #10b981;
    font-size: 10px;
    line-height: 1.3;
}

/* CEチップスタイル */
.assigned-ces {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    margin-top: 8px;
}

.ce-chip {
    display: inline-flex;
    align-items: center;
    padding: 2px 6px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 500;
    white-space: nowrap;
    position: relative;
}

/* 勤務区分別色分け */
.ce-chip.worktype-ope { background: #dbeafe; color: #1e40af; }
.ce-chip.worktype-me { background: #dcfce7; color: #166534; }
.ce-chip.worktype-hd { background: #fce7f3; color: #be185d; }
.ce-chip.worktype-flex { background: #fef3c7; color: #a16207; }
.ce-chip.worktype-error { background: #fee2e2; color: #dc2626; }

/* その他のスタイル */
.event-card {
    position: relative;
    transition: all 0.2s ease;
}

.monthly-progress-bar {
    width: 100%;
    height: 4px;
    background: rgba(0,0,0,0.1);
    border-radius: 2px;
    margin: 8px 0;
    overflow: hidden;
}

.monthly-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #10b981, #059669);
    transition: width 0.3s ease;
    border-radius: 2px;
}

/* レスポンシブデザイン */
@media (max-width: 768px) {
    .sidebar {
        position: fixed !important;
        left: -280px !important;
        width: 280px !important;
        transition: left 0.3s ease !important;
        z-index: 1000;
    }
    
    .sidebar.expanded {
        left: 0 !important;
    }
    
    #toggleSidebar {
        position: fixed !important;
        bottom: 20px;
        right: 20px;
        z-index: 1001;
    }
    
    .main-content {
        margin-left: 0 !important;
        padding: 12px !important;
    }
    
    #departmentGrid {
        grid-template-columns: 1fr !important;
    }
}
    </style>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <!-- ★重要修正★ JavaScript読み込み順序修正: constants.jsをFirebase設定の前に移動 -->
    <script src="js/data/constants.js?v=20241213"></script>
    
    <!-- Firebase設定 -->
    <script src="js/config/firebase-config.js?v=20241213"></script>
</head>
<body class="theme-unified">
    <!-- ローディング画面 -->
    <div id="loading">
        <div class="spinner"></div>
        <p class="text-gray-600">ダッシュボードを読み込んでいます...</p>
    </div>

    <!-- メインインターフェース -->
    <div id="mainInterface" style="display:none;">
        <!-- サイドバー -->
        <div id="sidebar" class="sidebar p-4">
            <div class="mb-3 flex justify-between items-center">
                <button id="toggleSidebar" class="p-2 rounded-lg hover:bg-gray-200" title="サイドバー表示/非表示">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="text-xs text-gray-600 sidebar-text">
                    <span id="currentUserDisplay">ユーザー</span>
                </div>
            </div>

            <!-- ナビゲーション -->
            <nav class="space-y-2 mb-6">
                <button id="dailyScheduleTab" class="nav-tab w-full text-left p-3 rounded-lg hover:bg-green-100 font-medium active">
                    <i class="fas fa-calendar-day mr-2"></i><span class="sidebar-text">日別スケジュール</span>
                </button>
                <button id="weeklyScheduleTab" class="nav-tab w-full text-left p-3 rounded-lg hover:bg-green-100 font-medium">
                    <i class="fas fa-calendar-week mr-2"></i><span class="sidebar-text">週間スケジュール</span>
                </button>
                <button id="ceWorkScheduleTab" class="nav-tab w-full text-left p-3 rounded-lg hover:bg-green-100 font-medium">
                    <i class="fas fa-table mr-2"></i><span class="sidebar-text">CE勤務表</span>
                </button>
                <button id="analysisTab" class="nav-tab w-full text-left p-3 rounded-lg hover:bg-green-100 font-medium">
                    <i class="fas fa-chart-bar mr-2"></i><span class="sidebar-text">集計・分析</span>
                </button>
                <button id="settingsTab" class="nav-tab w-full text-left p-3 rounded-lg hover:bg-green-100 font-medium">
                    <i class="fas fa-cog mr-2"></i><span class="sidebar-text">設定</span>
                </button>
            </nav>

            <!-- ログアウトボタン -->
            <div class="mt-auto pt-4 border-t border-gray-200 sidebar-text">
                <button id="logoutButton" onclick="window.handleLogout()" 
                        class="w-full bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 text-sm font-medium transition-colors">
                    <i class="fas fa-sign-out-alt mr-2"></i>ログアウト
                </button>
            </div>
        </div>

        <!-- メインコンテンツ -->
        <div class="main-content p-4">
            <!-- 日別スケジュール -->
            <div id="dailyScheduleContent" class="screen-content">
                <div class="mb-4 flex justify-between items-start flex-wrap">
                    <div class="flex items-center">
                        <h2 id="dailyScheduleTitle" class="text-2xl font-bold">日別スケジュール</h2>
                    </div>
                    
                    <!-- 右上ボタン配置 -->
                    <div class="action-buttons-row" style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
                        <button id="prevDayBtn" class="btn-unified btn-outline-unified">
                            <i class="fas fa-chevron-left mr-1"></i>前日
                        </button>
                        <input type="date" id="scheduleDatePicker" class="input-unified" style="width: auto;">
                        <button id="nextDayBtn" class="btn-unified btn-outline-unified">
                            翌日<i class="fas fa-chevron-right ml-1"></i>
                        </button>
                        <button id="todayBtn" class="btn-unified btn-primary-unified">
                            <i class="fas fa-calendar-day mr-1"></i>今日
                        </button>
                        <button id="addEventButtonDaily" class="btn-unified btn-primary-unified">
                            <i class="fas fa-plus mr-2"></i>業務追加
                        </button>
                        <button id="addMonthlyTaskBtn" class="btn-unified btn-primary-unified">
                            <i class="fas fa-calendar-alt mr-1"></i>月次業務追加
                        </button>
                    </div>
                </div>
                
                <div id="departmentGrid" class="grid grid-cols-3 gap-4 mb-6"></div>
                
                <div class="glass-card p-4">
                    <h3 class="font-bold mb-3"><i class="fas fa-users mr-2"></i>CEリスト（<span id="ceListCount">--</span>名）</h3>
                    <div id="ceListContainer" class="ce-grid"></div>
                </div>
            </div>

            <!-- 他のコンテンツ -->
            <div id="weeklyScheduleContent" class="screen-content" style="display:none;">
                <h2 class="text-2xl font-bold mb-4">週間スケジュール</h2>
                <div class="glass-card p-6 text-center">
                    <p class="text-gray-500">週間スケジュール機能は開発中です。</p>
                </div>
            </div>

            <div id="ceWorkScheduleContent" class="screen-content" style="display:none;">
                <h2 class="text-2xl font-bold mb-4">CE勤務表</h2>
                <div class="glass-card p-6 text-center">
                    <p class="text-gray-500">CE勤務表機能です。</p>
                </div>
            </div>

            <div id="analysisContent" class="screen-content" style="display:none;">
                <h2 class="text-2xl font-bold mb-4">集計・分析</h2>
                <div class="glass-card p-6 text-center">
                    <p class="text-gray-500">集計・分析機能です。</p>
                </div>
            </div>

            <div id="settingsContent" class="screen-content" style="display:none;">
                <h2 class="text-2xl font-bold mb-4">設定</h2>
                <div class="glass-card p-6 text-center">
                    <p class="text-gray-500">設定機能です。</p>
                </div>
            </div>
        </div>
    </div>

    <!-- その他のJavaScript読み込み -->
    <script src="js/utils/ui-utils.js?v=20241213"></script>
    <script src="js/utils/date-utils.js?v=20241213"></script>
    <script src="js/schedule/schedule-core.js?v=20241213"></script>
    <script src="js/schedule/calendar-view.js?v=20241213"></script>
    <script src="js/schedule/event-manager.js?v=20241213"></script>
    <script src="js/ui/ce-manager.js?v=20241213"></script>
    <script src="js/ui/ce-daily-status.js?v=20241213"></script>

    <!-- Dashboard専用JavaScript -->
    <script>
    // 祝日判定関数
    window.isJapaneseHoliday = function(date) {
        const month = date.getMonth() + 1;
        const day = date.getDate();
        const fixedHolidays = [
            {month: 1, day: 1}, {month: 2, day: 11}, {month: 4, day: 29},
            {month: 5, day: 3}, {month: 5, day: 4}, {month: 5, day: 5},
            {month: 8, day: 11}, {month: 11, day: 3}, {month: 11, day: 23},
        ];
        return fixedHolidays.some(h => h.month === month && h.day === day);
    };

    // ログアウト処理
    window.handleLogout = async () => {
        try {
            if (window.auth && window.auth.currentUser) {
                await window.auth.signOut();
            }
        } catch (error) {
            console.error('ログアウトエラー:', error);
        } finally {
            sessionStorage.clear();
            localStorage.clear();
            window.location.href = 'index.html';
        }
    };

    // ダッシュボード認証・メイン制御
    class DashboardAuth {
        constructor() {
            this.isInitialized = false;
            this.selectedDate = new Date();
            this.monthlyTasks = {};
        }

        async init() {
            if (this.isInitialized) return;
            this.isInitialized = true;

            try {
                await window.waitForFirebase();
                await this.checkAuthWithRetry();
            } catch (error) {
                console.error('初期化エラー:', error);
                this.redirectToLogin();
            }
        }

        async checkAuthWithRetry(maxRetries = 3) {
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    const targetUID = sessionStorage.getItem('targetUID');
                    const currentUsername = sessionStorage.getItem('currentUsername');
                    if (!targetUID || !currentUsername) {
                        this.redirectToLogin();
                        return;
                    }
                    
                    await this.ensureAnonymousAuth();
                    
                    const userSnapshot = await window.database.ref(`${window.DATA_ROOT}/users/${targetUID}`).once('value');
                    const userData = userSnapshot.val();
                    
                    if (userData && userData.setupCompleted) {
                        window.userRole = userData.role || 'viewer';
                        window.currentUserData = userData;
                        this.showDashboard();
                        return;
                    } else {
                        this.redirectToLogin();
                        return;
                    }
                } catch (error) {
                    console.error(`認証チェック試行 ${attempt} 失敗:`, error);
                    if (attempt === maxRetries) {
                        this.redirectToLogin();
                        return;
                    }
                    await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                }
            }
        }

        async ensureAnonymousAuth() {
            let user = window.auth.currentUser;
            if (!user) {
                const result = await window.auth.signInAnonymously();
                user = result.user;
            }
            return user;
        }

        redirectToLogin() {
            sessionStorage.clear();
            localStorage.clear();
            window.location.href = 'index.html';
        }

        showDashboard() {
            const loadingEl = document.getElementById('loading');
            const mainEl = document.getElementById('mainInterface');
            if (loadingEl) loadingEl.style.display = 'none';
            if (mainEl) mainEl.style.display = 'block';
            
            this.updateUserDisplay();
            this.setupNavigation();
            this.setupDailySchedule();
        }

        updateUserDisplay() {
            const userData = window.currentUserData;
            if (!userData) return;
            
            const displayName = userData.displayName || userData.username || 'ユーザー';
            document.querySelectorAll('#currentUserDisplay').forEach(el => {
                el.textContent = displayName;
            });
        }

        setupNavigation() {
            const navTabs = [
                { id: 'dailyScheduleTab', content: 'dailyScheduleContent' },
                { id: 'weeklyScheduleTab', content: 'weeklyScheduleContent' },
                { id: 'ceWorkScheduleTab', content: 'ceWorkScheduleContent' },
                { id: 'analysisTab', content: 'analysisContent' },
                { id: 'settingsTab', content: 'settingsContent' }
            ];

            navTabs.forEach(tab => {
                const element = document.getElementById(tab.id);
                if (element) {
                    element.onclick = () => this.showScreen(tab.content, tab.id);
                }
            });

            const toggleBtn = document.getElementById('toggleSidebar');
            const sidebar = document.getElementById('sidebar');
            if (toggleBtn && sidebar) {
                toggleBtn.onclick = () => sidebar.classList.toggle('expanded');
            }
        }

        showScreen(contentId, tabId) {
            document.querySelectorAll('.screen-content').forEach(screen => {
                screen.style.display = 'none';
            });
            
            const contentEl = document.getElementById(contentId);
            if (contentEl) {
                contentEl.style.display = 'block';
            }
            
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            const tabEl = document.getElementById(tabId);
            if (tabEl) {
                tabEl.classList.add('active');
            }
        }

        setupDailySchedule() {
            const datePicker = document.getElementById('scheduleDatePicker');
            if (datePicker) {
                datePicker.value = this.formatDate(this.selectedDate);
                datePicker.onchange = (e) => {
                    this.selectedDate = new Date(e.target.value + 'T00:00:00');
                    this.renderDailySchedule();
                };
            }

            const prev = document.getElementById('prevDayBtn');
            const next = document.getElementById('nextDayBtn');
            const today = document.getElementById('todayBtn');
            
            if (prev) prev.onclick = () => { 
                this.selectedDate.setDate(this.selectedDate.getDate() - 1); 
                if (datePicker) datePicker.value = this.formatDate(this.selectedDate); 
                this.renderDailySchedule(); 
            };
            
            if (next) next.onclick = () => { 
                this.selectedDate.setDate(this.selectedDate.getDate() + 1); 
                if (datePicker) datePicker.value = this.formatDate(this.selectedDate); 
                this.renderDailySchedule(); 
            };
            
            if (today) today.onclick = () => { 
                this.selectedDate = new Date(); 
                if (datePicker) datePicker.value = this.formatDate(this.selectedDate); 
                this.renderDailySchedule(); 
            };

            // 月次業務追加ボタン
            const monthlyBtn = document.getElementById('addMonthlyTaskBtn');
            if (monthlyBtn) {
                monthlyBtn.onclick = () => this.openMonthlyTaskModal();
            }

            this.renderDailySchedule();
        }

        renderDailySchedule() {
            const title = document.getElementById('dailyScheduleTitle');
            const grid = document.getElementById('departmentGrid');
            
            if (title) {
                const dateStr = this.selectedDate.toLocaleDateString('ja-JP', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric', 
                    weekday: 'short' 
                });
                title.textContent = `日別スケジュール（${dateStr}）`;
            }

            if (!grid) return;

            grid.innerHTML = '';
            grid.className = 'grid grid-cols-3 gap-4 mb-6';

            // 部門セクションの作成
            const departments = ['放射線科', '検査科', '透析科'];
            departments.forEach(dept => {
                const section = this.createDepartmentSection(dept);
                grid.appendChild(section);
            });

            this.renderMonthlyTasks();
        }

        createDepartmentSection(dept) {
            const section = document.createElement('div');
            section.className = 'department-section p-4 glass-card';
            section.dataset.department = dept;
            
            section.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <h3 class="font-bold text-sm">${dept}</h3>
                    <button class="btn-unified btn-primary-unified btn-small" onclick="window.dashboardAuth.openMonthlyTaskModal('${dept}')">
                        <i class="fas fa-calendar-alt mr-1"></i>月次
                    </button>
                </div>
                <div class="task-list min-h-[120px] space-y-2 mt-3" data-department="${dept}">
                    <!-- 通常業務がここに表示されます -->
                </div>
                <div class="monthly-plans mt-2" data-department="${dept}">
                    <!-- 月次業務がここに表示されます -->
                </div>
            `;

            return section;
        }

        // 月次業務表示（日付連携・累積件数対応版）
        async renderMonthlyTasks() {
            const grid = document.getElementById('departmentGrid');
            if (!grid) return;

            const dateKey = this.formatDate(this.selectedDate);
            const yearMonth = dateKey.substring(0, 7);
            const monthlyData = this.monthlyTasks[yearMonth] || {};

            // 既存の月次業務カードをクリア
            grid.querySelectorAll('.monthly-plans').forEach(el => {
                el.innerHTML = '';
            });

            const taskList = Object.values(monthlyData);
            if (taskList.length === 0) return;

            for (const task of taskList) {
                if (!task || !task.department || !task.name) continue;
                
                const section = grid.querySelector(`.monthly-plans[data-department="${task.department}"]`);
                if (!section) continue;

                // 累積実施件数の計算
                const executionRecords = task.executionRecords || {};
                const currentDate = this.formatDate(this.selectedDate);
                let cumulativeCount = 0;
                let todayRecord = null;

                Object.keys(executionRecords).forEach(recordDate => {
                    if (recordDate <= currentDate) {
                        const record = executionRecords[recordDate];
                        cumulativeCount += record.count || 0;
                        if (recordDate === currentDate) {
                            todayRecord = record;
                        }
                    }
                });

                const goalCount = task.goalCount || 0;
                const progressPercent = goalCount > 0 ? Math.min((cumulativeCount / goalCount) * 100, 100) : 0;
                const remaining = Math.max(0, goalCount - cumulativeCount);

                const monthlyCard = document.createElement('div');
                monthlyCard.className = 'monthly-task-card';
                monthlyCard.dataset.taskId = task.id;
                monthlyCard.dataset.yearMonth = yearMonth;
                monthlyCard.dataset.department = task.department;

                monthlyCard.innerHTML = `
                    <!-- 月次バッジ（左上配置） -->
                    <span class="monthly-task-badge">月次</span>
                    
                    <div class="flex justify-between items-center mb-2">
                        <div class="font-semibold text-sm">
                            <i class="fas fa-calendar-alt mr-1"></i>${task.name}
                        </div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-600 mb-2">
                        <span>目標: ${goalCount}件</span>
                        <span>実施: ${cumulativeCount}件</span>
                        <span>残: ${remaining}件</span>
                    </div>
                    <div class="monthly-progress-bar">
                        <div class="monthly-progress-fill" style="width: ${progressPercent}%"></div>
                    </div>
                    
                    <!-- 実施入力セクション（日付・時間対応） -->
                    <div class="monthly-input-section">
                        <div class="monthly-input-row">
                            <span>実施日:</span>
                            <input type="date" class="execution-date" value="${currentDate}" min="${yearMonth}-01" max="${yearMonth}-31">
                            <span>件数:</span>
                            <input type="number" class="execution-count" value="${todayRecord?.count || 0}" min="0" max="99">
                        </div>
                        <div class="monthly-input-row">
                            <span>開始:</span>
                            <input type="time" class="execution-start-time" value="${todayRecord?.startTime || ''}">
                            <span>終了:</span>
                            <input type="time" class="execution-end-time" value="${todayRecord?.endTime || ''}">
                            <button class="btn-unified btn-primary-unified record-execution-btn">記録</button>
                        </div>
                    </div>
                `;

                // 実施記録ボタンのイベント
                const recordBtn = monthlyCard.querySelector('.record-execution-btn');
                if (recordBtn) {
                    recordBtn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const dateInput = monthlyCard.querySelector('.execution-date');
                        const countInput = monthlyCard.querySelector('.execution-count');
                        const startTimeInput = monthlyCard.querySelector('.execution-start-time');
                        const endTimeInput = monthlyCard.querySelector('.execution-end-time');
                        
                        const executionDate = dateInput.value;
                        const executionCount = parseInt(countInput.value) || 0;
                        const startTime = startTimeInput.value;
                        const endTime = endTimeInput.value;
                        
                        if (!executionDate) {
                            alert('実施日を入力してください');
                            return;
                        }
                        
                        await this.recordMonthlyTaskExecution(yearMonth, task.id, executionDate, executionCount, startTime, endTime);
                    });
                }

                section.appendChild(monthlyCard);
            }
        }

        // 月次業務実施記録
        async recordMonthlyTaskExecution(yearMonth, taskId, executionDate, count, startTime = '', endTime = '') {
            if (!executionDate || count < 0) {
                alert('実施日と件数を正しく入力してください');
                return;
            }

            if (!executionDate.startsWith(yearMonth)) {
                alert('実施日は対象月内で入力してください');
                return;
            }

            try {
                const executionRecord = {
                    count: count,
                    startTime: startTime || null,
                    endTime: endTime || null,
                    recordedAt: firebase.database.ServerValue.TIMESTAMP,
                    recordedBy: window.currentUserData?.displayName || 'user'
                };

                await window.database.ref(`${window.DATA_ROOT}/monthlyTasks/${yearMonth}/${taskId}/executionRecords/${executionDate}`).set(executionRecord);

                const timeText = startTime && endTime ? ` (${startTime}-${endTime})` : '';
                alert(`${executionDate}の実施記録を保存しました: ${count}件${timeText}`);
                
                // ローカルデータ更新
                if (this.monthlyTasks[yearMonth] && this.monthlyTasks[yearMonth][taskId]) {
                    this.monthlyTasks[yearMonth][taskId].executionRecords = this.monthlyTasks[yearMonth][taskId].executionRecords || {};
                    this.monthlyTasks[yearMonth][taskId].executionRecords[executionDate] = executionRecord;
                }
                
                await this.renderMonthlyTasks();

            } catch (error) {
                console.error('❌ 月次業務実施記録エラー:', error);
                alert('実施記録の保存に失敗しました');
            }
        }

        // 月次業務追加モーダル
        openMonthlyTaskModal(defaultDepartment = '') {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            
            const currentYearMonth = this.formatDate(this.selectedDate).substring(0, 7);
            
            modal.innerHTML = `
                <div class="glass-card p-6 max-w-lg w-full mx-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold">月次業務追加</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <form id="monthlyTaskForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-bold mb-2">業務名 *</label>
                            <input type="text" id="monthlyTaskName" class="input-unified" required>
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-2">部門 *</label>
                            <select id="monthlyTaskDepartment" class="input-unified" required>
                                <option value="">選択してください</option>
                                <option value="放射線科" ${defaultDepartment === '放射線科' ? 'selected' : ''}>放射線科</option>
                                <option value="検査科" ${defaultDepartment === '検査科' ? 'selected' : ''}>検査科</option>
                                <option value="透析科" ${defaultDepartment === '透析科' ? 'selected' : ''}>透析科</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-2">実施月 *</label>
                            <input type="month" id="monthlyTaskMonth" class="input-unified" value="${currentYearMonth}" required>
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-2">目標件数</label>
                            <input type="number" id="monthlyGoalCount" class="input-unified" min="0" max="999" value="1">
                        </div>
                        <div class="flex space-x-3">
                            <button type="button" onclick="this.closest('.fixed').remove()" class="btn-unified btn-outline-unified flex-1">キャンセル</button>
                            <button type="submit" class="btn-unified btn-primary-unified flex-1">追加</button>
                        </div>
                    </form>
                </div>
            `;

            document.body.appendChild(modal);

            document.getElementById('monthlyTaskForm').onsubmit = (e) => {
                e.preventDefault();
                this.addMonthlyTask(modal);
            };
        }

        async addMonthlyTask(modal) {
            const name = document.getElementById('monthlyTaskName')?.value?.trim();
            const department = document.getElementById('monthlyTaskDepartment')?.value;
            const yearMonth = document.getElementById('monthlyTaskMonth')?.value;
            const goalCount = parseInt(document.getElementById('monthlyGoalCount')?.value) || 1;

            if (!name || !department || !yearMonth) {
                alert('必須項目を入力してください');
                return;
            }

            try {
                const taskRef = window.database.ref(`${window.DATA_ROOT}/monthlyTasks/${yearMonth}`).push();

                const taskData = {
                    id: taskRef.key,
                    name: name,
                    department: department,
                    yearMonth: yearMonth,
                    goalCount: goalCount,
                    executionRecords: {},
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    createdBy: window.currentUserData?.displayName || 'user'
                };

                await taskRef.set(taskData);

                // ローカルデータに即座に反映
                this.monthlyTasks[yearMonth] = this.monthlyTasks[yearMonth] || {};
                this.monthlyTasks[yearMonth][taskRef.key] = taskData;

                modal.remove();
                alert(`月次業務「${name}」を${department}に追加しました`);

                // 現在表示中の月と一致する場合は即座に再描画
                const currentYearMonth = this.formatDate(this.selectedDate).substring(0, 7);
                if (currentYearMonth === yearMonth) {
                    await this.renderMonthlyTasks();
                }

            } catch (error) {
                console.error('❌ 月次業務追加エラー:', error);
                alert('月次業務の追加に失敗しました');
            }
        }

        formatDate(date) {
            return date.toISOString().slice(0, 10);
        }
    }

    // 初期化
    document.addEventListener('DOMContentLoaded', async () => {
        window.dashboardAuth = new DashboardAuth();
        await window.dashboardAuth.init();
    });

    // 分析ページを開く関数
    function openAnalyticsPage(pageName) {
        console.log(`分析ページを開いています: ${pageName}`);
        const user = sessionStorage.getItem('currentUser');
        if (!user) {
            alert('分析機能を使用するには認証が必要です。');
            return;
        }
        
        try {
            const url = `analytics/${pageName}.html`;
            const newWindow = window.open(url, '_blank', 'noopener,noreferrer');
            
            if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
                if (confirm('ポップアップがブロックされています。同じタブで分析ページを開きますか？')) {
                    window.location.href = url;
                }
            }
        } catch (error) {
            console.error('分析ページを開くときにエラーが発生しました:', error);
            alert('分析ページを開くことができませんでした。');
        }
    }
    </script>
</body>
</html>
