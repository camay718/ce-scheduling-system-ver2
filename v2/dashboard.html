Copy<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEスケジュール管理システム V2 - ダッシュボード</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- 外部ライブラリ -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- 統一テーマ -->
    <link rel="stylesheet" href="css/theme-unified.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <!-- Firebase設定 -->
    <script src="js/config/firebase-config.js?v=20241212"></script>
</head>
<body class="theme-unified">
    <!-- ローディング画面 -->
    <div id="loading">
        <div class="spinner"></div>
        <p class="text-gray-600">ダッシュボードを読み込んでいます...</p>
    </div>

    <!-- メインインターフェース -->
    <div id="mainInterface" style="display:none;">
        <!-- サイドバー -->
        <div id="sidebar" class="sidebar p-4">
            <div class="mb-3 flex justify-between items-center">
                <button id="toggleSidebar" class="p-2 rounded-lg hover:bg-gray-200" title="サイドバー表示/非表示">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="text-xs text-gray-600 sidebar-text">
                    <span id="currentUserDisplay">ユーザー</span>
                </div>
            </div>

            <div class="mb-3">
                <div id="mainSyncStatus" class="sync-indicator connected">
                    <div class="sync-dot pulse"></div>
                    <span class="sidebar-text">リアルタイム同期中</span>
                </div>
            </div>

            <!-- ナビゲーション -->
            <nav class="space-y-2 mb-6">
                <button id="dailyScheduleTab" class="nav-tab w-full text-left p-3 rounded-lg hover:bg-green-100 font-medium active">
                    <i class="fas fa-calendar-day mr-2"></i><span class="sidebar-text">日別スケジュール</span>
                </button>
                <button id="ceManagementTab" class="nav-tab w-full text-left p-3 rounded-lg hover:bg-green-100 font-medium">
                    <i class="fas fa-table mr-2"></i><span class="sidebar-text">CE勤務区分表</span>
                </button>
                <button id="calendarTab" class="nav-tab w-full text-left p-3 rounded-lg hover:bg-green-100 font-medium">
                    <i class="fas fa-calendar-week mr-2"></i><span class="sidebar-text">週間カレンダー</span>
                </button>
                <button id="departmentTimelineTab" class="nav-tab w-full text-left p-3 rounded-lg hover:bg-green-100 font-medium">
                    <i class="fas fa-chart-gantt mr-2"></i><span class="sidebar-text">業務別タイムライン</span>
                </button>
                <button id="personalTimelineTab" class="nav-tab w-full text-left p-3 rounded-lg hover:bg-green-100 font-medium">
                    <i class="fas fa-chart-line mr-2"></i><span class="sidebar-text">個人別タイムライン</span>
                </button>
                <button id="analysisTab" class="nav-tab w-full text-left p-3 rounded-lg hover:bg-green-100 font-medium">
                    <i class="fas fa-chart-bar mr-2"></i><span class="sidebar-text">集計・分析</span>
                </button>
                <button id="settingsTab" class="nav-tab w-full text-left p-3 rounded-lg hover:bg-green-100 font-medium">
                    <i class="fas fa-cog mr-2"></i><span class="sidebar-text">設定</span>
                </button>
            </nav>

<!-- テンプレート（縦配置版） -->
<div class="sidebar-text mb-4">
    <h3 class="text-sm font-medium text-gray-700 mb-2">テンプレート</h3>
    <div class="flex flex-col space-y-2">
        <button id="templateSaveButton" class="w-full p-2 bg-green-500 text-white rounded-lg text-sm hover:bg-green-600">
            <i class="fas fa-save mr-1"></i>保存
        </button>
        <button id="templateLoadButton" class="w-full p-2 bg-blue-500 text-white rounded-lg text-sm hover:bg-blue-600">
            <i class="fas fa-folder-open mr-1"></i>読込
        </button>
    </div>
</div>

            <!-- 自動同期ステータス -->
            <div class="mt-6 p-2 bg-yellow-50 rounded-lg sidebar-text">
                <h4 class="text-xs font-bold text-yellow-700 mb-1">自動同期</h4>
                <div class="text-xs text-gray-600">
                    <div class="flex items-center">
                        <div class="w-2 h-2 bg-green-500 rounded-full mr-1 animate-pulse"></div>
                        <span id="syncStatusText">同期中</span>
                    </div>
                    <div id="lastSyncTime" class="text-xs">最終: --:--</div>
                </div>
            </div>
            
            <!-- ログアウトボタン -->
            <div class="mt-auto pt-4 border-t border-gray-200 sidebar-text">
                <button id="logoutButton" onclick="window.handleLogout()" 
                        class="w-full bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 text-sm font-medium transition-colors">
                    <i class="fas fa-sign-out-alt mr-2"></i>ログアウト
                </button>
            </div>
        </div>

        <!-- メインコンテンツ -->
        <div class="main-content p-4">
            <!-- 日別スケジュール -->
            <div id="dailyScheduleContent" class="screen-content">
                <div class="mb-4 flex justify-between items-center">
                    <h2 id="dailyScheduleTitle" class="text-2xl font-bold">日別スケジュール</h2>
                    <div class="flex items-center gap-3">
                        <button id="prevDayBtn" class="btn-unified btn-outline-unified">
                            <i class="fas fa-chevron-left mr-1"></i>前日
                        </button>
                        <input type="date" id="scheduleDatePicker" class="input-unified" style="width: auto;">
                        <button id="nextDayBtn" class="btn-unified btn-outline-unified">
                            翌日<i class="fas fa-chevron-right ml-1"></i>
                        </button>
                        <button id="todayBtn" class="btn-unified btn-primary-unified">
                            <i class="fas fa-calendar-day mr-1"></i>今日
                        </button>
                        <button id="addEventButtonDaily" class="btn-unified btn-primary-unified">
                            <i class="fas fa-plus mr-2"></i>業務追加
                        </button>
                    </div>
                </div>

                <div class="mb-4 flex gap-3">
                    <button id="addBulkEventBtn" class="btn-unified btn-primary-unified">
                        <i class="fas fa-calendar-plus mr-1"></i>期間一括業務追加
                    </button>
                    <button id="addMonthlyTaskBtn" class="btn-unified btn-primary-unified">
                        <i class="fas fa-calendar-alt mr-1"></i>月次業務追加
                    </button>
                </div>
                
                <div id="departmentGrid" class="grid grid-cols-3 gap-4 mb-6"></div>
                
                <div class="glass-card p-4">
                    <h3 class="font-bold mb-3"><i class="fas fa-users mr-2"></i>CEリスト（<span id="ceListCount">--</span>名）</h3>
                    <div id="ceListContainer" class="ce-grid"></div>
                </div>
            </div>

            <!-- CE勤務区分表（表示専用・改善版） -->
    <div id="ceManagementContent" class="screen-content" style="display:none; position: relative;">
    <!-- 勤務時間帯説明（右上極小配置） -->
    <div class="work-time-compact" style="position: absolute; top: 15px; right: 15px; background: rgba(248, 249, 250, 0.95); border: 1px dashed #e0e0e0; border-radius: 4px; padding: 3px 5px; font-size: 7px; z-index: 100; max-width: 180px; line-height: 1.1;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr><th style="padding: 1px 2px; font-size: 7px; background: #f2f5f7; font-weight: 600;">区分</th><th style="padding: 1px 2px; font-size: 7px; background: #f2f5f7; font-weight: 600;">時間</th></tr>
            </thead>
            <tbody>
                <tr><td style="padding: 1px 2px; font-size: 7px;">A</td><td style="padding: 1px 2px; font-size: 7px;">8:00-16:30</td></tr>
                <tr><td style="padding: 1px 2px; font-size: 7px;">A1</td><td style="padding: 1px 2px; font-size: 7px;">7:00-15:30</td></tr>
                <tr><td style="padding: 1px 2px; font-size: 7px;">B</td><td style="padding: 1px 2px; font-size: 7px;">8:00-翌8:00</td></tr>
                <tr><td style="padding: 1px 2px; font-size: 7px;">×</td><td style="padding: 1px 2px; font-size: 7px;">休日</td></tr>
            </tbody>
        </table>
    </div>

    <div class="schedule-display-container">
        <!-- 既存のコンテンツ -->
    </div>
</div>

                    <!-- 勤務区分表表示エリア -->
                    <div id="workScheduleDisplayArea" class="text-center py-8 text-gray-500">
                        <i class="fas fa-table text-4xl mb-4"></i>
                        <h3 class="text-lg font-semibold mb-2">勤務区分表</h3>
                        <p class="mb-4">作成済みの勤務表がここに表示されます</p>
                        <button onclick="document.getElementById('openScheduleEditorBtn').click()" 
                                class="btn-unified btn-primary-unified">
                            <i class="fas fa-plus mr-2"></i>勤務表を作成
                        </button>
                    </div>
                </div>
            </div>

            <!-- その他のタブコンテンツ -->
            <div id="calendarContent" class="screen-content" style="display:none;">
                <h2 class="text-2xl font-bold mb-4">週間カレンダー</h2>
                <p class="text-gray-600">週間カレンダー機能（開発予定）</p>
            </div>

            <div id="departmentTimelineContent" class="screen-content" style="display:none;">
                <h2 class="text-2xl font-bold mb-4">業務別タイムライン</h2>
                <p class="text-gray-600">業務別タイムライン機能（開発予定）</p>
            </div>

            <div id="personalTimelineContent" class="screen-content" style="display:none;">
                <h2 class="text-2xl font-bold mb-4">個人別タイムライン</h2>
                <p class="text-gray-600">個人別タイムライン機能（開発予定）</p>
            </div>

            <div id="analysisContent" class="screen-content" style="display:none;">
                <h2 class="text-2xl font-bold mb-4">集計・分析</h2>
                <p class="text-gray-600">集計・分析機能（開発予定）</p>
            </div>

            <div id="settingsContent" class="screen-content" style="display:none;">
                <!-- 設定コンテンツは動的生成 -->
            </div>
        </div>
    </div>

    <!-- JavaScript読み込み -->
    <script defer src="js/data/constants.js?v=20241212"></script>
    <script defer src="js/utils/ui-utils.js?v=20241212"></script>
    <script defer src="js/utils/date-utils.js?v=20241212"></script>
    <script defer src="js/schedule/schedule-core.js?v=20241212"></script>
    <script defer src="js/schedule/calendar-view.js?v=20241212"></script>
    <script defer src="js/schedule/event-manager.js?v=20241212"></script>
    <script defer src="js/ui/ce-manager.js?v=20241212"></script>
    <script defer src="js/ui/ce-daily-status.js?v=20241212"></script>

    <!-- Dashboard専用JavaScript（エラー修正版） -->
    <script>
    // ログアウト（監査ログ付き）
    window.handleLogout = async () => {
        try {
            try {
                const entry = {
                    action: 'logout',
                    details: {},
                    uid: window.currentUserData?.uid || null,
                    username: window.currentUserData?.username || 'unknown',
                    displayName: window.currentUserData?.displayName || 'unknown',
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    userAgent: navigator.userAgent.substring(0, 100)
                };
                await window.database.ref(`${window.DATA_ROOT}/auditLogs`).push(entry);
            } catch (logError) {
                console.warn('監査ログ記録失敗:', logError);
            }
            if (window.auth && window.auth.currentUser) {
                await window.auth.signOut();
            }
        } catch (error) {
            console.error('ログアウトエラー:', error);
        } finally {
            sessionStorage.clear();
            localStorage.clear();
            window.location.href = 'index.html';
        }
    };

    class WorkScheduleViewer {
        constructor() {
            this.currentPeriodIndex = 0;
            this.availablePeriods = [];
            this.init();
        }

        async init() {
            try {
                await window.waitForFirebase();
                await this.loadAvailablePeriods();
                this.setupEventListeners();
                console.log('✅ 勤務区分表ビューアー初期化完了');
            } catch (error) {
                console.error('❌ 勤務区分表ビューアー初期化エラー:', error);
            }
        }

        async loadAvailablePeriods() {
            try {
                const snapshot = await window.database.ref(`${window.DATA_ROOT}/workSchedules`).once('value');
                const data = snapshot.val() || {};
                
                this.availablePeriods = Object.keys(data).map(periodKey => ({
                    key: periodKey,
                    ...data[periodKey].metadata
                })).sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                
                if (this.availablePeriods.length > 0) {
                    this.currentPeriodIndex = 0;
                    this.displayCurrentPeriod();
                }
            } catch (error) {
                console.error('❌ 期間データ読み込みエラー:', error);
            }
        }

        setupEventListeners() {
            const prevBtn = document.getElementById('prevPeriodBtn');
            const nextBtn = document.getElementById('nextPeriodBtn');
            const editorBtn = document.getElementById('openScheduleEditorBtn');

            if (prevBtn) prevBtn.onclick = () => this.navigatePeriod(-1);
            if (nextBtn) nextBtn.onclick = () => this.navigatePeriod(1);
            if (editorBtn) editorBtn.onclick = () => this.openScheduleEditor();
        }

        navigatePeriod(direction) {
            const newIndex = this.currentPeriodIndex + direction;
            
            if (newIndex < 0 || newIndex >= this.availablePeriods.length) {
                window.showMessage('これ以上の期間はありません', 'info');
                return;
            }
            
            this.currentPeriodIndex = newIndex;
            this.displayCurrentPeriod();
        }

        async displayCurrentPeriod() {
            const displayEl = document.getElementById('currentPeriodDisplay');
            const areaEl = document.getElementById('workScheduleDisplayArea');
            
            if (this.availablePeriods.length === 0) {
                if (displayEl) displayEl.textContent = '作成済みの期間なし';
                if (areaEl) {
                    areaEl.innerHTML = `
                        <div class="text-center py-12">
                            <i class="fas fa-calendar-plus text-4xl text-gray-400 mb-4"></i>
                            <h3 class="text-lg font-semibold text-gray-600 mb-2">勤務区分表</h3>
                            <p class="text-gray-500 mb-4">まだ勤務表が作成されていません</p>
                            <button onclick="document.getElementById('openScheduleEditorBtn').click()" 
                                    class="btn-unified btn-primary-unified">
                                <i class="fas fa-plus mr-2"></i>最初の勤務表を作成
                            </button>
                        </div>
                    `;
                }
                return;
            }

            const currentPeriod = this.availablePeriods[this.currentPeriodIndex];
            if (displayEl) {
                displayEl.innerHTML = `
                    <div>${currentPeriod.startDate} ～ ${currentPeriod.endDate}</div>
                    <div class="text-sm text-gray-500">(${this.currentPeriodIndex + 1}/${this.availablePeriods.length})</div>
                `;
            }

            // 勤務表データを読み込んで表示
            await this.renderWorkScheduleTable(currentPeriod.key);
        }

        async renderWorkScheduleTable(periodKey) {
            const areaEl = document.getElementById('workScheduleDisplayArea');
            if (!areaEl) return;

            try {
                const snapshot = await window.database.ref(`${window.DATA_ROOT}/workSchedules/${periodKey}`).once('value');
                const periodData = snapshot.val();
                
                if (!periodData || !window.ceManager?.ceList) {
                    areaEl.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-exclamation-triangle text-4xl text-yellow-500 mb-4"></i>
                            <p class="text-gray-600">勤務表データを読み込めませんでした</p>
                        </div>
                    `;
                    return;
                }

                const scheduleData = periodData.scheduleData || {};
                const metadata = periodData.metadata || {};
                const dates = this.generateDateRange(new Date(metadata.startDate), new Date(metadata.endDate));

                areaEl.innerHTML = `
                    <div class="work-schedule-table-wrapper">
                        <table class="work-schedule-table">
                            ${this.generateTableHTML(dates, scheduleData)}
                        </table>
                    </div>
                `;

            } catch (error) {
                console.error('❌ 勤務表表示エラー:', error);
                areaEl.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                        <p class="text-gray-600">勤務表の読み込みでエラーが発生しました</p>
                    </div>
                `;
            }
        }

        generateDateRange(startDate, endDate) {
            const dates = [];
            const current = new Date(startDate);
            
            while (current <= endDate) {
                dates.push(new Date(current));
                current.setDate(current.getDate() + 1);
            }
            
            return dates;
        }

        generateTableHTML(dates, scheduleData) {
            // ヘッダー生成
            let html = '<thead><tr><th class="name-header">氏名</th>';
            
            dates.forEach(date => {
                const dayOfWeek = ['日', '月', '火', '水', '木', '金', '土'][date.getDay()];
                const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                const headerClass = isWeekend ? 'date-header weekend-header' : 'date-header';
                
                html += `
                    <th class="${headerClass}">
                        <div>${date.getDate()}</div>
                        <div class="text-xs">${dayOfWeek}</div>
                    </th>
                `;
            });
            
            // サマリー列
            const summaryHeaders = ['A', 'A1', 'B', '非', '×', '年', '出', '研', '休日数', '実勤務', '当直回数'];
            summaryHeaders.forEach(header => {
                html += `<th class="summary-header">${header}</th>`;
            });
            html += '</tr></thead>';
            
            // ボディ生成
            html += '<tbody>';
            window.ceManager.ceList.forEach(ce => {
                const fullName = ce.fullName || ce.name || '';
                html += `<tr><td class="name-cell">
                    <div class="font-medium">${fullName}</div>
                    <div class="text-xs text-gray-500">${ce.workType}</div>
                </td>`;
                
                const summary = { A: 0, A1: 0, B: 0, non: 0, off: 0, year: 0, trip: 0, training: 0, holidays: 0, actual: 0, night: 0 };
                
                dates.forEach(date => {
                    const dateKey = this.formatDate(date);
                    const workData = scheduleData[ce.id]?.[dateKey] || {};
                    const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                    const status = workData.status || (isWeekend ? '×' : 'A');
                    const desired = workData.desired || false;
                    
                    // サマリー計算
                    if (isWeekend) summary.holidays++;
                    switch (status) {
                        case 'A': summary.A++; summary.actual++; break;
                        case 'A1': summary.A1++; summary.actual++; break;
                        case 'B': summary.B++; summary.actual++; summary.night++; break;
                        case '非': summary.non++; summary.actual++; break;
                        case '×': summary.off++; break;
                        case '年': summary.year++; summary.actual++; break;
                        case '出': summary.trip++; summary.actual++; break;
                        case '研': summary.training++; summary.actual++; break;
                    }
                    
                    let cellClass = `work-cell type-${ce.workType.toLowerCase()}`;
                    if (status) cellClass += ` status-${status}`;
                    if (desired) cellClass += ' desired';
                    if (isWeekend) cellClass += ' holiday';
                    
                    html += `<td class="${cellClass}">${status}</td>`;
                });
                
                // サマリーセル
                const summaryValues = [summary.A, summary.A1, summary.B, summary.non, summary.off, summary.year, summary.trip, summary.training, summary.holidays, summary.actual, summary.night];
                summaryValues.forEach(value => {
                    html += `<td class="summary-cell">${value}</td>`;
                });
                
                html += '</tr>';
            });
            html += '</tbody>';

            // フッター（勤務区分別集計、当直・非番集計）
            html += '<tfoot>';
            
            // OPE(A), OPE(A1), ME, HD, FLEX の集計行を追加
            const footerTypes = [
                { label: 'OPE(A)', filter: (ce, status) => ce.workType === 'OPE' && status === 'A' },
                { label: 'OPE(A1)', filter: (ce, status) => ce.workType === 'OPE' && status === 'A1' },
                { label: 'ME', filter: (ce, status) => ce.workType === 'ME' && ['A', 'A1', 'B', '非', '年', '出', '研'].includes(status) },
                { label: 'HD', filter: (ce, status) => ce.workType === 'HD' && ['A', 'A1', 'B', '非', '年', '出', '研'].includes(status) },
                { label: 'FLEX', filter: (ce, status) => ce.workType === 'FLEX' && ['A', 'A1', 'B', '非', '年', '出', '研'].includes(status) },
                { label: '当直', filter: (ce, status) => status === 'B' },
                { label: '非番', filter: (ce, status) => status === '非' }
            ];

            footerTypes.forEach(type => {
                html += `<tr class="footer-summary-row"><th class="type-label">${type.label}</th>`;
                
                dates.forEach(date => {
                    const dateKey = this.formatDate(date);
                    let count = 0;
                    window.ceManager.ceList.forEach(ce => {
                        const workData = scheduleData[ce.id]?.[dateKey] || {};
                        const status = workData.status || (date.getDay() === 0 || date.getDay() === 6 ? '×' : 'A');
                        if (type.filter(ce, status)) {
                            count++;
                        }
                    });
                    
                    // 当直・非番は0人または2人以上で警告
                    const cellClass = (type.label === '当直' || type.label === '非番') && (count === 0 || count >= 2) ? 'warning-count' : '';
                    html += `<td class="${cellClass}">${count}</td>`;
                });
                
                // 空のサマリーセル
                for (let i = 0; i < summaryHeaders.length; i++) {
                    html += '<td></td>';
                }
                html += '</tr>';
            });
            
            html += '</tfoot>';
            
            return html;
        }

        openScheduleEditor() {
            if (window.userRole === 'viewer') {
                window.showMessage('編集権限がありません', 'warning');
                return;
            }
            window.open('pages/work-schedule-editor.html', '_blank', 'width=1400,height=900');
        }

        formatDate(date) {
            return date.toISOString().slice(0, 10);
        }
    }

    class DashboardAuth {
        constructor() {
            this.isInitialized = false;
            this.selectedDate = new Date();
            this.monthlyTasks = {};
            this.init();
        }

        async init() {
            if (this.isInitialized) return;
            this.isInitialized = true;

            try {
                await window.waitForFirebase();
                await this.checkAuthWithRetry();
            } catch (error) {
                console.error('初期化エラー:', error);
                this.redirectToLogin();
            }
        }

        async checkAuthWithRetry(maxRetries = 3) {
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    const targetUID = sessionStorage.getItem('targetUID');
                    const currentUsername = sessionStorage.getItem('currentUsername');
                    if (!targetUID || !currentUsername) {
                        this.redirectToLogin();
                        return;
                    }
                    await this.ensureAnonymousAuth();
                    
                    const userSnapshot = await window.database.ref(`${window.DATA_ROOT}/users/${targetUID}`).once('value');
                    const userData = userSnapshot.val();
                    
                    if (userData && userData.setupCompleted) {
                        window.userRole = userData.role || 'viewer';
                        window.currentUserData = userData;
                        this.showDashboard();
                        return;
                    } else {
                        this.redirectToLogin();
                        return;
                    }
                } catch (error) {
                    if (attempt === maxRetries) {
                        this.redirectToLogin();
                        return;
                    }
                    await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                }
            }
        }

        async ensureAnonymousAuth() {
            let user = window.auth.currentUser;
            if (!user) {
                const result = await window.auth.signInAnonymously();
                user = result.user;
            }
            return user;
        }

        redirectToLogin() {
            sessionStorage.clear();
            window.location.href = 'index.html';
        }

        showDashboard() {
            const loadingEl = document.getElementById('loading');
            const mainEl = document.getElementById('mainInterface');
            if (loadingEl) loadingEl.style.display = 'none';
            if (mainEl) mainEl.style.display = 'block';
            
            this.updateUserDisplay();
            this.setupNavigation();
            this.setupSidebar();
            this.setupDailySchedule();
            this.initializeV2System();
        }

        updateUserDisplay() {
            const userData = window.currentUserData;
            if (!userData) return;
            document.querySelectorAll('#currentUserDisplay').forEach(el => {
                el.textContent = userData.displayName || userData.username || 'ユーザー';
            });
        }

        setupNavigation() {
            const navTabs = [
                { id: 'dailyScheduleTab', content: 'dailyScheduleContent' },
                { id: 'ceManagementTab', content: 'ceManagementContent' },
                { id: 'calendarTab', content: 'calendarContent' },
                { id: 'departmentTimelineTab', content: 'departmentTimelineContent' },
                { id: 'personalTimelineTab', content: 'personalTimelineContent' },
                { id: 'analysisTab', content: 'analysisContent' },
                { id: 'settingsTab', content: 'settingsContent' }
            ];

            navTabs.forEach(tab => {
                const element = document.getElementById(tab.id);
                if (element) {
                    element.onclick = () => {
                        this.showScreen(tab.content, tab.id);
                        if (tab.id === 'ceManagementTab') {
                            setTimeout(() => {
                                if (window.workScheduleViewer) {
                                    window.workScheduleViewer.displayCurrentPeriod();
                                }
                            }, 100);
                        }
                        if (tab.id === 'settingsTab') {
                            setTimeout(() => this.setupAdminSettings(), 100);
                        }
                    };
                }
            });

            // サイドバートグル
            const toggleBtn = document.getElementById('toggleSidebar');
            const sidebar = document.getElementById('sidebar');
            if (toggleBtn && sidebar) {
                toggleBtn.onclick = () => sidebar.classList.toggle('expanded');
            }
        }

        showScreen(contentId, tabId) {
            document.querySelectorAll('.screen-content').forEach(screen => screen.style.display = 'none');
            const contentEl = document.getElementById(contentId);
            if (contentEl) contentEl.style.display = 'block';
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            const tabEl = document.getElementById(tabId);
            if (tabEl) tabEl.classList.add('active');
        }

        setupSidebar() {
            const saveBtn = document.getElementById('templateSaveButton');
            const loadBtn = document.getElementById('templateLoadButton');
            if (saveBtn) saveBtn.onclick = () => window.showMessage('テンプレート保存機能（実装予定）', 'info');
            if (loadBtn) loadBtn.onclick = () => window.showMessage('テンプレート読込機能（実装予定）', 'info');
        }

        setupDailySchedule() {
            const datePicker = document.getElementById('scheduleDatePicker');
            if (datePicker) {
                datePicker.value = this.formatDate(this.selectedDate);
                datePicker.onchange = (e) => {
                    this.selectedDate = new Date(e.target.value + 'T00:00:00');
                    this.renderDailySchedule();
                };
            }

            const prev = document.getElementById('prevDayBtn');
            const next = document.getElementById('nextDayBtn');
            const today = document.getElementById('todayBtn');
            if (prev) prev.onclick = () => { this.selectedDate.setDate(this.selectedDate.getDate() - 1); datePicker.value = this.formatDate(this.selectedDate); this.renderDailySchedule(); };
            if (next) next.onclick = () => { this.selectedDate.setDate(this.selectedDate.getDate() + 1); datePicker.value = this.formatDate(this.selectedDate); this.renderDailySchedule(); };
            if (today) today.onclick = () => { this.selectedDate = new Date(); datePicker.value = this.formatDate(this.selectedDate); this.renderDailySchedule(); };

            const quickBtn = document.getElementById('addEventButtonDaily');
            if (quickBtn) quickBtn.onclick = () => this.openQuickAddEvent();

            this.renderDailySchedule();
        }

        renderDailySchedule() {
            const title = document.getElementById('dailyScheduleTitle');
            const grid = document.getElementById('departmentGrid');
            if (title) {
                const dateStr = this.selectedDate.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'short' });
                title.textContent = `日別スケジュール（${dateStr}）`;
            }
            if (window.ceManager) {
                window.ceManager.currentDisplayDate = this.selectedDate;
                window.ceManager.displayCEList();
            }
            if (!grid) return;

            grid.innerHTML = '';
            grid.className = 'grid grid-cols-3 gap-4 mb-6';

            if (window.DEPARTMENTS) {
                window.DEPARTMENTS.forEach(dept => {
                    const section = this.createDepartmentSection(dept);
                    grid.appendChild(section);
                });
            }

            this.updateCEListCount();
        }

        createDepartmentSection(dept) {
            const section = document.createElement('div');
            section.className = 'department-section p-4';
            section.style.setProperty('--dept-color', window.DEPARTMENT_COLORS?.[dept] || '#e5e7eb');
            
            section.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-bold text-sm flex items-center">
                        <i class="fas fa-${window.DEPARTMENT_ICONS?.[dept] || 'cog'} mr-2" style="color: ${window.DEPARTMENT_COLORS?.[dept] || '#2563eb'}"></i>
                        <span>${dept}</span>
                    </h3>
                    ${window.userRole !== 'viewer' ? `
                    <button class="btn-unified btn-primary-unified btn-small" onclick="window.dashboardAuth.openQuickAddEvent('${dept}')">
                        <i class="fas fa-plus mr-1"></i>業務追加
                    </button>` : ''}
                </div>
                <div class="task-list min-h-[120px] space-y-2" data-department="${dept}">
                    <!-- 通常業務がここに表示されます -->
                </div>
                <div class="monthly-plans" data-department="${dept}">
                    <!-- 月次業務がここに省スペース表示されます -->
                </div>
            `;

            return section;
        }

        openQuickAddEvent(department) {
    if (window.userRole === 'viewer') {
        window.showMessage('編集権限がありません', 'warning');
        return;
    }
    if (!window.eventManager) {
        window.showMessage('イベント管理の初期化を待機中です', 'info');
        return;
    }
    window.eventManager.openAddEventModal(department);
}
        setupAdminSettings() {
            const settingsContent = document.getElementById('settingsContent');
            if (!settingsContent) return;

            if (window.userRole === 'admin') {
                settingsContent.innerHTML = `
                    <h2 class="text-2xl font-bold mb-6">設定</h2>
                    <div class="glass-card p-6 mb-6">
                        <h3 class="text-lg font-semibold mb-4 text-red-600">
                            <i class="fas fa-shield-alt mr-2"></i>管理者機能
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button onclick="window.open('pages/admin-dashboard.html', '_blank')" class="btn-unified btn-primary-unified">
                                <i class="fas fa-users-cog mr-2"></i>ユーザー管理ダッシュボード
                            </button>
                        </div>
                    </div>
                    <div class="glass-card p-6 mb-6">
                        <h3 class="text-lg font-semibold mb-4">
                            <i class="fas fa-cog mr-2"></i>一般設定
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">表示名</label>
                                <input type="text" id="displayNameSetting" class="input-unified" value="${window.currentUserData?.displayName || ''}">
                            </div>
                            <button id="saveSettingsBtn" class="btn-unified btn-primary-unified">
                                <i class="fas fa-save mr-2"></i>設定保存
                            </button>
                        </div>
                    </div>
                `;
            } else {
                settingsContent.innerHTML = `
                    <h2 class="text-2xl font-bold mb-6">設定</h2>
                    <div class="glass-card p-6 mb-6">
                        <h3 class="text-lg font-semibold mb-4">個人設定</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">表示名</label>
                                <input type="text" id="displayNameSetting" class="input-unified" value="${window.currentUserData?.displayName || ''}">
                            </div>
                            <button id="saveSettingsBtn" class="btn-unified btn-primary-unified">
                                <i class="fas fa-save mr-2"></i>設定保存
                            </button>
                        </div>
                    </div>
                `;
            }
            
            const saveBtn = document.getElementById('saveSettingsBtn');
            if (saveBtn) {
                saveBtn.onclick = async () => {
                    const displayName = document.getElementById('displayNameSetting')?.value.trim();
                    if (!displayName) {
                        window.showMessage('表示名を入力してください', 'warning');
                        return;
                    }
                    try {
                        const targetUID = sessionStorage.getItem('targetUID');
                        await window.database.ref(`${window.DATA_ROOT}/users/${targetUID}`).update({
                            displayName: displayName,
                            lastUpdated: Date.now()
                        });
                        window.currentUserData.displayName = displayName;
                        this.updateUserDisplay();
                        window.showMessage('設定を保存しました', 'success');
                    } catch (error) {
                        console.error('設定保存エラー:', error);
                        window.showMessage('設定の保存に失敗しました', 'error');
                    }
                };
            }
        }

        formatDate(date) {
            return date.toISOString().slice(0, 10);
        }

        updateCEListCount() {
            const el = document.getElementById('ceListCount');
            if (el) {
                const count = window.ceManager?.ceList?.length || 0;
                el.textContent = String(count);
            }
        }

        initializeV2System() {
            setTimeout(async () => {
                try {
                    let attempts = 0;
                    while (attempts < 50) {
                        if (window.CalendarView && window.EventManager && window.CEManager && window.DEPARTMENTS && window.showMessage && window.CEDailyStatusManager) {
                            break;
                        }
                        await new Promise(resolve => setTimeout(resolve, 100));
                        attempts++;
                    }
                    if (!window.calendarView) window.calendarView = new window.CalendarView();
                    if (!window.eventManager) window.eventManager = new window.EventManager();
                    if (!window.ceManager) window.ceManager = new window.CEManager();
                    if (!window.ceDailyStatus) window.ceDailyStatus = new window.CEDailyStatusManager();
                    if (!window.workScheduleViewer) window.workScheduleViewer = new WorkScheduleViewer();
                } catch (error) {
                    console.error('V2システム初期化エラー:', error);
                }
            }, 1500);
        }
    }

    // 初期化
    if (!window.dashboardAuthInitialized) {
        window.dashboardAuthInitialized = true;
        document.addEventListener('DOMContentLoaded', () => {
            window.dashboardAuth = new DashboardAuth();
        });
    }
    </script>
</body>
</html>
