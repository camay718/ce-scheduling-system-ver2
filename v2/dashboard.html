<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEスケジュール管理システム V2 - ダッシュボード</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- 外部ライブラリ -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- 統一テーマ -->
    <link rel="stylesheet" href="css/theme-unified.css?v=20241217">

    <!-- 追加スタイル -->
    <style>
    /* 月次業務強化スタイル */
    .monthly-task-badge {
        position: absolute;
        top: -8px;
        left: -8px;
        background: linear-gradient(135deg, #f97316, #ea580c);
        color: white;
        font-size: 9px;
        padding: 3px 6px;
        border-radius: 6px;
        font-weight: bold;
        line-height: 1;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.25);
        z-index: 10;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .assignment-dropzone {
        min-height: 20px;
        padding: 4px;
        margin-top: 4px;
    }

    .assignment-dropzone.drag-over {
        background: #fef3c7 !important;
        border-color: #f59e0b !important;
    }

    .monthly-event-item {
        font-size: 11px;
        line-height: 1.2;
    }

    /* 業務カード改良 - 予定件数表示 */
    .event-card {
        position: relative;
        transition: all 0.2s ease;
    }

    .event-card.drag-over {
        background: #fff7ed !important;
        border: 2px dashed #f59e0b !important;
        transform: scale(1.02);
    }

    .event-count-display {
        font-size: 11px;
        color: #6b7280;
        margin-top: 4px;
        font-weight: 500;
    }

    /* CEチップスタイル */
    .assigned-ces {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        margin-top: 8px;
    }

    .ce-chip {
        display: inline-flex;
        align-items: center;
        padding: 2px 6px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 500;
        white-space: nowrap;
        position: relative;
    }

    .ce-chip .remove-ce {
        margin-left: 4px;
        cursor: pointer;
        opacity: 0.7;
        font-size: 8px;
    }

    .ce-chip .remove-ce:hover {
        opacity: 1;
        color: #ef4444;
    }

    /* 勤務区分別色分け */
    .ce-chip.worktype-ope { background: #dbeafe; color: #1e40af; }
    .ce-chip.worktype-me { background: #dcfce7; color: #166534; }
    .ce-chip.worktype-hd { background: #fce7f3; color: #be185d; }
    .ce-chip.worktype-flex { background: #fef3c7; color: #a16207; }
    .ce-chip.worktype-error { background: #fee2e2; color: #dc2626; }

    /* 部門別集計バー */
    .dept-summary-container {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 8px;
        font-size: 11px;
    }

    .dept-ratio-bar {
        flex: 1;
        height: 6px;
        background: rgba(0,0,0,0.1);
        border-radius: 3px;
        overflow: hidden;
        position: relative;
    }

    .dept-ratio-fill {
        height: 100%;
        transition: width 0.3s ease;
        border-radius: 3px;
    }

    /* 日別集計表示 */
    .daily-summary-stats {
        display: flex;
        align-items: center;
        gap: 16px;
        font-size: 14px;
        color: #4b5563;
        margin-left: 16px;
    }

    .daily-summary-item {
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .progress-bar-mini {
        width: 80px;
        height: 8px;
        background: rgba(0,0,0,0.1);
        border-radius: 4px;
        overflow: hidden;
    }

    .progress-fill-mini {
        height: 100%;
        background: linear-gradient(90deg, #10b981, #059669);
        transition: width 0.3s ease;
        border-radius: 4px;
    }

    /* 月次業務カード */
    .monthly-task-card {
        position: relative !important;
        margin-top: 8px;
        padding: 12px;
        border-radius: 8px;
        font-size: 12px;
        transition: all 0.2s ease;
    }

    .monthly-task-card.drag-over {
        transform: scale(1.02);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .monthly-progress-bar {
        width: 100%;
        height: 4px;
        background: rgba(0,0,0,0.1);
        border-radius: 2px;
        margin: 8px 0;
        overflow: hidden;
    }

    .monthly-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #10b981, #059669);
        transition: width 0.3s ease;
        border-radius: 2px;
    }

    .monthly-input-section {
        background: rgba(255, 255, 255, 0.6);
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        padding: 10px;
        margin-top: 8px;
        font-size: 11px;
    }

    .monthly-input-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 6px;
        flex-wrap: wrap;
    }

    .monthly-input-row:last-child {
        margin-bottom: 0;
    }

    .monthly-time-inputs {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 10px;
    }

    .monthly-time-inputs input {
        width: 70px;
        padding: 3px 6px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        text-align: center;
        font-size: 10px;
    }

    .monthly-count-input {
        width: 60px;
        padding: 3px 6px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        text-align: center;
        font-size: 11px;
    }

    .monthly-task-title {
        position: relative;
        display: flex;
        align-items: center;
        gap: 4px;
        padding-left: 8px;
    }

    /* 変更履歴ウィンドウ */
    .activity-log {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        max-height: 400px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
    }

    .activity-item {
        padding: 8px 12px;
        margin-bottom: 6px;
        background: white;
        border-radius: 6px;
        border-left: 4px solid #007bff;
        font-size: 12px;
        line-height: 1.4;
        transition: all 0.2s ease;
    }

    .activity-item:hover {
        background: #f0f8ff;
        transform: translateX(2px);
    }

    .activity-item.login { border-left-color: #28a745; }
    .activity-item.event-add { border-left-color: #17a2b8; }
    .activity-item.ce-assign { border-left-color: #ffc107; }
    .activity-item.schedule-edit { border-left-color: #dc3545; }

    .activity-timestamp {
        color: #6c757d;
        font-size: 10px;
        margin-top: 4px;
    }

    /* 集計・分析ボタングリッド */
    .analysis-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .analysis-btn {
        padding: 25px;
        background: linear-gradient(135deg, var(--glass-bg), rgba(255,255,255,0.9));
        border: 2px solid var(--glass-border);
        border-radius: 16px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        color: #495057;
        backdrop-filter: blur(5px);
    }

    .analysis-btn:hover {
        background: linear-gradient(135deg, rgba(76,175,80,0.1), rgba(76,175,80,0.05));
        border-color: var(--brand-primary);
        color: var(--brand-primary);
        transform: translateY(-3px);
        box-shadow: var(--shadow-hover);
    }

    .analysis-btn i {
        font-size: 28px;
        margin-bottom: 12px;
        display: block;
        color: var(--brand-primary);
    }

    .analysis-btn-title {
        font-weight: 600;
        font-size: 16px;
        margin-bottom: 8px;
    }

    .analysis-btn-desc {
        font-size: 12px;
        color: #6c757d;
        line-height: 1.3;
    }

    /* ボタン配置調整 */
    .action-buttons-row {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
    }

    @media (max-width: 768px) {
        .daily-summary-stats {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
            margin-left: 0;
            margin-top: 8px;
        }
        
        .action-buttons-row {
            display: grid;
            grid-template-columns: auto 1fr auto auto;
            gap: 4px;
            width: 100%;
            margin-bottom: 8px;
        }

        #prevDayBtn { grid-column: 1; }
        #scheduleDatePicker { grid-column: 2; min-width: 120px; }
        #nextDayBtn { grid-column: 3; }
        #todayBtn { grid-column: 4; }

        #addEventButtonDaily, #addBulkEventBtn {
            grid-column: 1 / -1;
            margin-top: 4px;
        }
    }
    </style>

    <!-- スマホ専用レスポンシブデザイン -->
    <style>
    @media (max-width: 768px) {
        body {
            font-size: 14px;
            line-height: 1.4;
        }
        
        /* サイドバーを左側スライドイン方式に変更 */
        .sidebar {
            position: fixed !important;
            top: 0 !important;
            bottom: 0 !important;
            left: -280px !important;
            width: 280px !important;
            height: 100vh !important;
            transform: translateX(0) !important;
            transition: left 0.3s ease !important;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-radius: 0 8px 8px 0;
            border-right: 2px solid #e5e7eb;
            overflow-y: auto;
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.15);
        }
        
        .sidebar.expanded {
            left: 0 !important;
        }
        
        /* ハンバーガーメニューボタン */
        #toggleSidebar {
            position: fixed !important;
            bottom: 20px;
            right: 20px;
            background: var(--brand-primary);
            color: white;
            border-radius: 50%;
            width: 56px;
            height: 56px;
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1001;
            font-size: 18px;
            display: flex !important;
            align-items: center;
            justify-content: center;
        }
        
        /* メインコンテンツ調整 */
        .main-content {
            margin-left: 0 !important;
            padding: 12px !important;
            padding-bottom: 80px;
            width: 100%;
        }
        
        /* 部門グリッドを1カラムに */
        #departmentGrid {
            grid-template-columns: 1fr !important;
            gap: 12px !important;
        }
        
        /* 部門セクションの調整 */
        .department-section {
            padding: 12px !important;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        /* 業務カードの調整 */
        .event-card {
            padding: 10px !important;
            margin-bottom: 8px;
            border-radius: 8px;
            font-size: 12px;
        }
        
        /* 月次業務カードの調整 */
        .monthly-task-card {
            padding: 8px !important;
            font-size: 11px;
            border-radius: 8px;
        }
        
        /* CEリストの調整 */
        .ce-grid {
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)) !important;
            gap: 6px !important;
        }
        
        .ce-item {
            padding: 6px 4px !important;
            font-size: 10px !important;
            min-height: 50px;
            border-radius: 8px;
        }
        
        /* CEチップの調整 */
        .ce-chip {
            font-size: 9px !important;
            padding: 2px 4px !important;
            border-radius: 6px;
            line-height: 1.2;
        }
        
        /* モーダルの調整 */
        .fixed.inset-0 .glass-card {
            margin: 8px !important;
            padding: 16px !important;
            max-width: none !important;
            width: calc(100% - 16px) !important;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        /* ナビゲーションタブの調整 */
        .nav-tab {
            padding: 10px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 4px;
            font-size: 12px;
        }
        
        .sidebar-text {
            font-size: 11px;
        }
        
        /* グラスカードの調整 */
        .glass-card {
            padding: 12px !important;
            margin-bottom: 12px;
            border-radius: 10px;
        }
    }
    </style>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <!-- Firebase設定 -->
    <script src="js/config/firebase-config.js?v=20241213"></script>
    
</head>
<body class="theme-unified">
    <!-- ローディング画面 -->
    <div id="loading">
        <div class="spinner"></div>
        <p class="text-gray-600">ダッシュボードを読み込んでいます...</p>
    </div>

    <!-- メインインターフェース -->
    <div id="mainInterface" style="display:none;">
        <!-- サイドバー -->
        <div id="sidebar" class="sidebar p-4">
            <div class="mb-3 flex justify-between items-center">
                <button id="toggleSidebar" class="p-2 rounded-lg hover:bg-gray-200" title="サイドバー表示/非表示">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="text-xs text-gray-600 sidebar-text">
                    <span id="currentUserDisplay">ユーザー</span>
                </div>
            </div>

            <div class="mb-3">
                <div id="mainSyncStatus" class="sync-indicator connected">
                    <div class="sync-dot pulse"></div>
                    <span class="sidebar-text">リアルタイム同期中</span>
                </div>
            </div>

            <!-- ナビゲーション -->
            <nav class="space-y-2 mb-6">
                <button id="dailyScheduleTab" class="nav-tab w-full text-left p-3 rounded-lg hover:bg-green-100 font-medium active">
                    <i class="fas fa-calendar-day mr-2"></i><span class="sidebar-text">日別スケジュール</span>
                </button>
                <button id="weeklyScheduleTab" class="nav-tab w-full text-left p-3 rounded-lg hover:bg-green-100 font-medium">
                    <i class="fas fa-calendar-week mr-2"></i><span class="sidebar-text">週間スケジュール</span>
                </button>
                <button id="ceWorkScheduleTab" class="nav-tab w-full text-left p-3 rounded-lg hover:bg-green-100 font-medium">
                    <i class="fas fa-table mr-2"></i><span class="sidebar-text">CE勤務表</span>
                </button>
                <button id="analysisTab" class="nav-tab w-full text-left p-3 rounded-lg hover:bg-green-100 font-medium">
                    <i class="fas fa-chart-bar mr-2"></i><span class="sidebar-text">集計・分析</span>
                </button>
                <button id="settingsTab" class="nav-tab w-full text-left p-3 rounded-lg hover:bg-green-100 font-medium">
                    <i class="fas fa-cog mr-2"></i><span class="sidebar-text">設定</span>
                </button>
            </nav>

            <!-- テンプレート -->
            <div class="sidebar-text mb-4">
                <h3 class="text-sm font-medium text-gray-700 mb-2">テンプレート</h3>
                <div class="flex flex-col space-y-2">
                    <button id="templateSaveButton" class="w-full p-2 bg-green-500 text-white rounded-lg text-sm hover:bg-green-600">
                        <i class="fas fa-save mr-1"></i>保存
                    </button>
                    <button id="templateAddLoadButton" class="w-full p-2 bg-blue-500 text-white rounded-lg text-sm hover:bg-blue-600">
                        <i class="fas fa-folder-plus mr-1"></i>追加読込
                    </button>
                </div>
            </div>

            <!-- 自動同期ステータス -->
            <div class="mt-6 p-2 bg-yellow-50 rounded-lg sidebar-text">
                <h4 class="text-xs font-bold text-yellow-700 mb-1">自動同期</h4>
                <div class="text-xs text-gray-600">
                    <div class="flex items-center">
                        <div class="w-2 h-2 bg-green-500 rounded-full mr-1 animate-pulse"></div>
                        <span id="syncStatusText">同期中</span>
                    </div>
                    <div id="lastSyncTime" class="text-xs">最終: --:--</div>
                </div>
            </div>
            
            <!-- ログアウトボタン -->
            <div class="mt-auto pt-4 border-t border-gray-200 sidebar-text">
                <button id="logoutButton" onclick="window.handleLogout()" 
                        class="w-full bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 text-sm font-medium transition-colors">
                    <i class="fas fa-sign-out-alt mr-2"></i>ログアウト
                </button>
            </div>
        </div>

        <!-- メインコンテンツ -->
        <div class="main-content p-4">
            <!-- 日別スケジュール -->
            <div id="dailyScheduleContent" class="screen-content">
                <div class="mb-4 flex justify-between items-start flex-wrap">
                    <div class="flex items-center">
                        <h2 id="dailyScheduleTitle" class="text-2xl font-bold">日別スケジュール</h2>
                        <!-- 日別集計表示 -->
                        <div id="dailySummaryStats" class="daily-summary-stats">
                            <div class="daily-summary-item">
                                <i class="fas fa-list text-blue-500"></i>
                                <span>業務数: <span id="totalEventCount">0</span>件</span>
                            </div>
                            <div class="daily-summary-item">
                                <i class="fas fa-user-check text-green-500"></i>
                                <span>配置: <span id="totalAssignedCount">0</span>/<span id="totalAvailableCount">0</span>人</span>
                            </div>
                            <div class="daily-summary-item">
                                <span class="text-xs">必要/配置:</span>
                                <div class="progress-bar-mini">
                                    <div id="overallProgressFill" class="progress-fill-mini" style="width: 0%"></div>
                                </div>
                                <span class="text-xs"><span id="totalRequiredCount">0</span>/<span id="totalAssignedCount2">0</span></span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 右上ボタン配置 -->
                    <div class="action-buttons-row">
                        <button id="prevDayBtn" class="btn-unified btn-outline-unified">
                            <i class="fas fa-chevron-left mr-1"></i>前日
                        </button>
                        <input type="date" id="scheduleDatePicker" class="input-unified" style="width: auto;">
                        <button id="nextDayBtn" class="btn-unified btn-outline-unified">
                            翌日<i class="fas fa-chevron-right ml-1"></i>
                        </button>
                        <button id="todayBtn" class="btn-unified btn-primary-unified">
                            <i class="fas fa-calendar-day mr-1"></i>今日
                        </button>
                        <button id="addEventButtonDaily" class="btn-unified btn-primary-unified">
                            <i class="fas fa-plus mr-2"></i>業務追加
                        </button>
                        <button id="addBulkEventBtn" class="btn-unified btn-primary-unified">
                            <i class="fas fa-calendar-plus mr-1"></i>期間一括追加
                        </button>
                    </div>
                </div>
                
                <div id="departmentGrid" class="grid grid-cols-3 gap-4 mb-6"></div>
                
                <div class="glass-card p-4">
                    <h3 class="font-bold mb-3"><i class="fas fa-users mr-2"></i>CEリスト（<span id="ceListCount">--</span>名）</h3>
                    <div id="ceListContainer" class="ce-grid"></div>
                </div>
            </div>

            <!-- 週間スケジュール -->
            <div id="weeklyScheduleContent" class="screen-content" style="display:none;">
                <h2 class="text-2xl font-bold mb-4">週間スケジュール</h2>
                <div class="glass-card p-6 text-center">
                    <i class="fas fa-calendar-week text-4xl text-gray-400 mb-4"></i>
                    <h3 class="text-lg font-semibold text-gray-600 mb-2">週間スケジュール機能</h3>
                    <p class="text-gray-500 mb-4">週単位での業務配置とCE勤務状況を表示する機能です。</p>
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <p class="text-yellow-800 text-sm">
                            <i class="fas fa-tools mr-2"></i>現在開発中です。近日中にリリース予定です。
                        </p>
                    </div>
                </div>
            </div>

            <!-- CE勤務表 -->
            <div id="ceWorkScheduleContent" class="screen-content" style="display:none; position: relative;">
                <!-- 勤務時間帯説明（右上極小配置） -->
                <div class="work-time-compact" style="position: absolute; top: 15px; right: 15px; background: rgba(248, 249, 250, 0.95); border: 1px dashed #e0e0e0; border-radius: 4px; padding: 4px 6px; font-size: 8px; z-index: 50; max-width: 300px; line-height: 1.2; white-space: nowrap; pointer-events: none;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr>
                                <th style="padding: 2px 4px; font-size: 8px; background: #f2f5f7; font-weight: 600; text-align: left;">区分</th>
                                <th style="padding: 2px 4px; font-size: 8px; background: #f2f5f7; font-weight: 600; text-align: left;">勤務時間</th>
                                <th style="padding: 2px 4px; font-size: 8px; background: #f2f5f7; font-weight: 600; text-align: left;">休憩時間</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td style="padding: 2px 4px; font-size: 8px;">A</td><td style="padding: 2px 4px; font-size: 8px;">8:00〜16:30</td><td style="padding: 2px 4px; font-size: 8px;">11:45～12:30</td></tr>
                            <tr><td style="padding: 2px 4px; font-size: 8px;">A1</td><td style="padding: 2px 4px; font-size: 8px;">7:00〜15:30</td><td style="padding: 2px 4px; font-size: 8px;">11:45～12:30</td></tr>
                            <tr><td style="padding: 2px 4px; font-size: 8px;">B</td><td style="padding: 2px 4px; font-size: 8px;">8:00〜翌8:00（0:00～6:30宿直相当勤務）</td><td style="padding: 2px 4px; font-size: 8px;">11:45～12:45及び16:45～17:45</td></tr>
                            <tr><td style="padding: 2px 4px; font-size: 8px;">×</td><td style="padding: 2px 4px; font-size: 8px;">休日</td><td style="padding: 2px 4px; font-size: 8px;">-</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="schedule-display-container">
                    <!-- 上部：期間表示のみ -->
                    <div class="period-display-header">
                        <div id="currentPeriodDisplay" class="text-lg font-bold">期間を読み込み中...</div>
                        <div class="text-sm text-gray-500">28日間の勤務表</div>
                    </div>
                    
                    <div class="text-center mb-4">
                        <button id="openScheduleEditorBtn" class="btn-unified btn-primary-unified">
                            <i class="fas fa-edit mr-2"></i>勤務表を作成・編集
                        </button>
                    </div>

                    <!-- 勤務表表示エリア -->
                    <div id="workScheduleDisplayArea" class="text-center py-8 text-gray-500">
                        <i class="fas fa-table text-4xl mb-4"></i>
                        <h3 class="text-lg font-semibold mb-2">CE勤務表</h3>
                        <p class="mb-4">作成済みの勤務表がここに表示されます</p>
                        <button onclick="document.getElementById('openScheduleEditorBtn').click()" 
                                class="btn-unified btn-primary-unified">
                            <i class="fas fa-plus mr-2"></i>最初の勤務表を作成
                        </button>
                    </div>

                    <!-- 下部：期間ナビゲーションと管理者コントロール -->
                    <div id="scheduleControlsFooter" class="schedule-controls-footer">
                        <!-- JavaScriptで動的に生成 -->
                    </div>
                </div>
            </div>

            <!-- 集計・分析 -->
            <div id="analysisContent" class="screen-content" style="display:none;">
                <h2 class="text-2xl font-bold mb-6">集計・分析</h2>
                <div class="glass-card p-6">
                    <p class="text-gray-600 mb-4">業務配置とCE勤務状況の各種分析機能にアクセスできます。</p>
                    
                    <div class="analysis-grid">
                        <!-- 業務別タイムライン -->
                        <button class="analysis-btn" onclick="openAnalyticsPage('department-timeline')">
                            <i class="fas fa-chart-bar"></i>
                            <div class="analysis-btn-title">業務別タイムライン</div>
                            <div class="analysis-btn-desc">部門・業務ごとの時系列分析と配置状況の可視化</div>
                        </button>

                        <!-- 個人別タイムライン -->
                        <button class="analysis-btn" onclick="openAnalyticsPage('personal-timeline')">
                            <i class="fas fa-chart-line"></i>
                            <div class="analysis-btn-title">個人別タイムライン</div>
                            <div class="analysis-btn-desc">CE個人の勤務パターンと業務配置履歴の分析</div>
                        </button>

                        <!-- 配置サマリー -->
                        <button class="analysis-btn" onclick="openAnalyticsPage('assignment-summary')">
                            <i class="fas fa-clipboard-list"></i>
                            <div class="analysis-btn-title">配置サマリ</div>
                            <div class="analysis-btn-desc">業務配置状況の要約表示と効率性分析</div>
                        </button>

                        <!-- 部門別充足率 -->
                        <button class="analysis-btn" onclick="openAnalyticsPage('department-coverage')">
                            <i class="fas fa-percentage"></i>
                            <div class="analysis-btn-title">部門別充足率</div>
                            <div class="analysis-btn-desc">必要人数に対する充足状況と不足分析</div>
                        </button>

                        <!-- 業務時間分析 -->
                        <button class="analysis-btn" onclick="openAnalyticsPage('work-hours')">
                            <i class="fas fa-clock"></i>
                            <div class="analysis-btn-title">業務時間</div>
                            <div class="analysis-btn-desc">業務時間の集計と勤務負荷の分析</div>
                        </button>

                        <!-- 時間帯別配置人数 -->
                        <button class="analysis-btn" onclick="openAnalyticsPage('hourly-staffing')">
                            <i class="fas fa-users"></i>
                            <div class="analysis-btn-title">時間帯別配置人数</div>
                            <div class="analysis-btn-desc">時間帯ごとの人員配置状況と最適化提案</div>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 設定 -->
            <div id="settingsContent" class="screen-content" style="display:none;">
                <!-- 動的生成 -->
            </div>
        </div>
    </div>

    <!-- JavaScript読み込み -->
    <script src="js/data/constants.js?v=20241213"></script>
    <script src="js/utils/ui-utils.js?v=20241213"></script>
    <script src="js/utils/date-utils.js?v=20241213"></script>
    <script src="js/schedule/schedule-core.js?v=20241213"></script>
    <script src="js/schedule/calendar-view.js?v=20241213"></script>
    <script src="js/schedule/event-manager.js?v=20241213"></script>
    <script src="js/ui/ce-manager.js?v=20241213"></script>
    <script src="js/ui/ce-daily-status.js?v=20241213"></script>

    <!-- Dashboard専用JavaScript -->
    <script>
    // 祝日判定関数（簡易実装）
    window.isJapaneseHoliday = function(date) {
        const month = date.getMonth() + 1;
        const day = date.getDate();
        
        const fixedHolidays = [
            {month: 1, day: 1},   // 元日
            {month: 2, day: 11},  // 建国記念の日
            {month: 4, day: 29},  // 昭和の日
            {month: 5, day: 3},   // 憲法記念日
            {month: 5, day: 4},   // みどりの日
            {month: 5, day: 5},   // こどもの日
            {month: 8, day: 11},  // 山の日
            {month: 11, day: 3},  // 文化の日
            {month: 11, day: 23}, // 勤労感謝の日
        ];
        
        return fixedHolidays.some(h => h.month === month && h.day === day);
    };

    // ログアウト（監査ログ付き）
    window.handleLogout = async () => {
        try {
            try {
                const entry = {
                    action: 'logout',
                    details: {},
                    uid: window.currentUserData?.uid || null,
                    username: window.currentUserData?.username || 'unknown',
                    displayName: window.currentUserData?.displayName || 'unknown',
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    userAgent: navigator.userAgent.substring(0, 100)
                };
                await window.database.ref(`${window.DATA_ROOT}/auditLogs`).push(entry);
            } catch (logError) {
                console.warn('監査ログ記録失敗:', logError);
            }
            if (window.auth && window.auth.currentUser) {
                await window.auth.signOut();
            }
        } catch (error) {
            console.error('ログアウトエラー:', error);
        } finally {
            sessionStorage.clear();
            localStorage.clear();
            window.location.href = 'index.html';
        }
    };

    // 統一された分析ページ開く関数（認証情報確実受け渡し版）
    function openAnalyticsPage(pageName) {
        console.log(`分析ページを開いています: ${pageName}`);

        // 認証情報の取得
        const userData = window.currentUserData || {};
        const displayName = userData.displayName || userData.username || sessionStorage.getItem('currentUser') || 'user';
        const username = userData.username || sessionStorage.getItem('currentUsername') || displayName;
        const uid = sessionStorage.getItem('targetUID') || userData.uid || '';
        const role = window.userRole || userData.role || sessionStorage.getItem('userRole') || 'viewer';

        if (!uid || !username) {
            window.showMessage('認証情報が不完全です。ページを再読み込みしてください。', 'warning');
            return;
        }

        // URLパラメータに認証情報を付与
        const params = new URLSearchParams({
            uid: uid,
            username: username,
            user: displayName,
            role: role,
            timestamp: Date.now()
        });

        const url = `analytics/${pageName}.html?${params.toString()}`;

        // localStorage にもミラー保存（タブ間共有用）
        try {
            localStorage.setItem('analyticsAuth', JSON.stringify({
                uid: uid,
                username: username,
                displayName: displayName,
                role: role,
                timestamp: Date.now()
            }));
            console.log('認証情報をlocalStorageに保存:', { username, role });
        } catch (e) {
            console.warn('localStorage保存エラー:', e);
        }

        try {
            // 新しいタブで開く
            const newWindow = window.open(url, '_blank', 'width=1400,height=900,scrollbars=yes,resizable=yes');
            
            // ポップアップブロック検知を遅延実行（誤検知防止）
            setTimeout(() => {
                try {
                    if (!newWindow || newWindow.closed) {
                        console.warn('ポップアップがブロックされました');
                        if (confirm('ポップアップがブロックされています。同じタブで分析ページを開きますか？')) {
                            window.location.href = url;
                        }
                    } else {
                        console.log('分析ページが正常に開かれました');
                    }
                } catch (checkError) {
                    // クロスオリジンエラーは正常動作とみなす
                    console.log('分析ページが正常に開かれました（詳細確認不可）');
                }
            }, 1000);

        } catch (error) {
            console.error('分析ページを開くときにエラーが発生しました:', error);
            window.showMessage('分析ページを開くことができませんでした', 'error');
        }
    }

    // レガシー対応：既存のコードとの互換性
    window.openAnalysisPage = function(pageName) {
        console.log('レガシー関数経由での呼び出し:', pageName);
        openAnalyticsPage(pageName);
    };

    // 分析機能の利用可能性チェック
    function checkAnalyticsAccess() {
        const user = 
            sessionStorage.getItem('currentUser') ||
            sessionStorage.getItem('currentUsername') ||
            (window.currentUserData && (window.currentUserData.displayName || window.currentUserData.username)) ||
            null;

        const role = 
            sessionStorage.getItem('userRole') ||
            window.userRole ||
            (window.currentUserData && window.currentUserData.role) ||
            'viewer';

        console.log('分析機能アクセス状況チェック - User:', user, 'Role:', role);

        if (!user || user === 'null') {
            console.log('認証されていないためアクセス拒否');
            return false;
        }
        
        console.log('分析機能へのアクセスが許可されました');
        return true;
    }

    // 分析ボタンの状態を更新
    function updateAnalyticsButtons() {
        console.log('分析ボタンの状態を更新しています');
        
        const analyticsButtons = document.querySelectorAll('.analysis-btn');
        const hasAccess = checkAnalyticsAccess();
        
        console.log(`分析ボタン数: ${analyticsButtons.length}, アクセス権限: ${hasAccess}`);
        
        analyticsButtons.forEach((button, index) => {
            if (hasAccess) {
                button.style.opacity = '1';
                button.style.pointerEvents = 'auto';
                button.removeAttribute('disabled');
                button.title = '';
            } else {
                button.style.opacity = '0.5';
                button.style.pointerEvents = 'none';
                button.setAttribute('disabled', 'true');
                button.title = 'ログインが必要です';
            }
            console.log(`ボタン${index + 1}の状態更新完了`);
        });
    }

    // ログイン管理機能（将来の開発用）
    window.openLoginManagement = function() {
        window.showMessage('ログイン管理機能は開発中です', 'info');
    };

    // ダッシュボード認証・メイン制御
    class DashboardAuth {
        constructor() {
            this.isInitialized = false;
            this.selectedDate = new Date();
            this.monthlyTasks = {};
            this.eventsRef = null;
            this.eventsCallback = null;
            this.monthlyRef = null;
            this.monthlyCallback = null;
        }

        async init() {
            if (this.isInitialized) return;
            this.isInitialized = true;

            try {
                await window.waitForFirebase();
                await this.checkAuthWithRetry();
            } catch (error) {
                console.error('初期化エラー:', error);
                this.redirectToLogin();
            }
        }

        async checkAuthWithRetry(maxRetries = 3) {
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    const targetUID = sessionStorage.getItem('targetUID');
                    const currentUsername = sessionStorage.getItem('currentUsername');
                    if (!targetUID || !currentUsername) {
                        this.redirectToLogin();
                        return;
                    }
                    await this.ensureAnonymousAuth();
                    
                    const userSnapshot = await window.database.ref(`${window.DATA_ROOT}/users/${targetUID}`).once('value');
                    const userData = userSnapshot.val();
                    
                    if (userData && userData.setupCompleted) {
                        window.userRole = userData.role || 'viewer';
                        window.currentUserData = userData;
                        this.showDashboard();
                        return;
                    } else {
                        this.redirectToLogin();
                        return;
                    }
                } catch (error) {
                    if (attempt === maxRetries) {
                        this.redirectToLogin();
                        return;
                    }
                    await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                }
            }
        }

        async ensureAnonymousAuth() {
            let user = window.auth.currentUser;
            if (!user) {
                const result = await window.auth.signInAnonymously();
                user = result.user;
            }
            return user;
        }

        redirectToLogin() {
            sessionStorage.clear();
            window.location.href = 'index.html';
        }

        showDashboard() {
            const loadingEl = document.getElementById('loading');
            const mainEl = document.getElementById('mainInterface');
            if (loadingEl) loadingEl.style.display = 'none';
            if (mainEl) mainEl.style.display = 'block';
            
            this.updateUserDisplay();
            this.setupNavigation();
            this.setupSidebar();
            this.setupDailySchedule();
            this.initializeV2System();
        }

        updateUserDisplay() {
            const userData = window.currentUserData;
            if (!userData) return;
            
            const displayName = userData.displayName || userData.username || 'ユーザー';
            document.querySelectorAll('#currentUserDisplay').forEach(el => {
                el.textContent = displayName;
            });
            
            // analytics/配下のページの認証チェック用にsessionStorageに保存
            try {
                sessionStorage.setItem('currentUser', displayName);
                sessionStorage.setItem('currentUsername', userData.username || displayName);
                sessionStorage.setItem('userRole', window.userRole || userData.role || 'viewer');
                
                console.log('認証情報をsessionStorageに保存:', {
                    user: displayName,
                    role: window.userRole || userData.role || 'viewer'
                });
            } catch (error) {
                console.warn('sessionStorage保存エラー:', error);
            }

            // 認証情報設定完了後に分析ボタンの状態を即座に更新
            setTimeout(() => {
                updateAnalyticsButtons();
            }, 100);
        }

        setupNavigation() {
            const navTabs = [
                { id: 'dailyScheduleTab', content: 'dailyScheduleContent' },
                { id: 'weeklyScheduleTab', content: 'weeklyScheduleContent' },
                { id: 'ceWorkScheduleTab', content: 'ceWorkScheduleContent' },
                { id: 'analysisTab', content: 'analysisContent' },
                { id: 'settingsTab', content: 'settingsContent' }
            ];

            navTabs.forEach(tab => {
                const element = document.getElementById(tab.id);
                if (element) {
                    element.onclick = () => {
                        this.showScreen(tab.content, tab.id);
                        if (tab.id === 'settingsTab') {
                            setTimeout(() => this.setupSettingsScreen(), 100);
                        }
                    };
                }
            });

            const toggleBtn = document.getElementById('toggleSidebar');
            const sidebar = document.getElementById('sidebar');
            if (toggleBtn && sidebar) {
                toggleBtn.onclick = () => sidebar.classList.toggle('expanded');
            }
        }

        showScreen(contentId, tabId) {
            document.querySelectorAll('.screen-content').forEach(screen => {
                screen.style.display = 'none';
            });
            
            const contentEl = document.getElementById(contentId);
            if (contentEl) {
                contentEl.style.display = 'block';
            }
            
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            const tabEl = document.getElementById(tabId);
            if (tabEl) {
                tabEl.classList.add('active');
            }
        }

        setupSidebar() {
            const saveBtn = document.getElementById('templateSaveButton');
            const addLoadBtn = document.getElementById('templateAddLoadButton');
            if (saveBtn) saveBtn.onclick = () => window.showMessage('テンプレート保存機能（実装予定）', 'info');
            if (addLoadBtn) addLoadBtn.onclick = () => window.showMessage('テンプレート追加読込機能（実装予定）', 'info');
        }

        setupDailySchedule() {
            const datePicker = document.getElementById('scheduleDatePicker');
            if (datePicker) {
                datePicker.value = this.formatDate(this.selectedDate);
                datePicker.onchange = (e) => {
                    this.selectedDate = new Date(e.target.value + 'T00:00:00');
                    this.renderDailySchedule();
                };
            }

            const prev = document.getElementById('prevDayBtn');
            const next = document.getElementById('nextDayBtn');
            const today = document.getElementById('todayBtn');
            if (prev) prev.onclick = () => { 
                this.selectedDate.setDate(this.selectedDate.getDate() - 1); 
                if (datePicker) datePicker.value = this.formatDate(this.selectedDate); 
                this.renderDailySchedule(); 
            };
            if (next) next.onclick = () => { 
                this.selectedDate.setDate(this.selectedDate.getDate() + 1); 
                if (datePicker) datePicker.value = this.formatDate(this.selectedDate); 
                this.renderDailySchedule(); 
            };
            if (today) today.onclick = () => { 
                this.selectedDate = new Date(); 
                if (datePicker) datePicker.value = this.formatDate(this.selectedDate); 
                this.renderDailySchedule(); 
            };

            this.renderDailySchedule();
        }

        renderDailySchedule() {
            const title = document.getElementById('dailyScheduleTitle');
            const grid = document.getElementById('departmentGrid');
            if (title) {
                const dateStr = this.selectedDate.toLocaleDateString('ja-JP', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric', 
                    weekday: 'short' 
                });
                title.textContent = `日別スケジュール（${dateStr}）`;
            }
            if (window.ceManager) {
                window.ceManager.currentDisplayDate = this.selectedDate;
                window.ceManager.displayCEList();
            }
            if (!grid) return;

            grid.innerHTML = '';
            grid.className = 'grid grid-cols-3 gap-4 mb-6';

            if (window.DEPARTMENTS) {
                window.DEPARTMENTS.forEach(dept => {
                    const section = this.createDepartmentSection(dept);
                    grid.appendChild(section);
                });
            }

            this.updateCEListCount();
        }

        createDepartmentSection(dept) {
            const section = document.createElement('div');
            section.className = 'department-section p-4';
            section.dataset.department = dept;
            const deptColor = window.DEPARTMENT_COLORS?.[dept] || '#6b7280';
            
            section.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-${window.DEPARTMENT_ICONS?.[dept] || 'cog'}" style="color: ${deptColor}"></i>
                        <h3 class="font-bold text-sm">${dept}</h3>
                    </div>
                </div>
                <div class="dept-summary-container">
                    <span class="text-xs dept-summary-text">0/0名</span>
                    <div class="dept-ratio-bar">
                        <div class="dept-ratio-fill" style="background: ${deptColor}; width: 0%"></div>
                    </div>
                </div>
                <div class="task-list min-h-[120px] space-y-2 mt-3" data-department="${dept}">
                    <!-- 通常業務がここに表示されます -->
                </div>
                <div class="monthly-plans mt-2" data-department="${dept}">
                    <!-- 月次業務がここに表示されます -->
                </div>
            `;

            return section;
        }

        // 設定画面（権限別）
        setupSettingsScreen() {
            const settingsContent = document.getElementById('settingsContent');
            if (!settingsContent) return;

            const isAdmin = (window.userRole === 'admin' && window.currentUserData?.role === 'admin');

            if (isAdmin) {
                settingsContent.innerHTML = `
                    <h2 class="text-2xl font-bold mb-6">設定</h2>
                    <div class="glass-card p-6 mb-6">
                        <h3 class="text-lg font-semibold mb-4 text-red-600">
                            <i class="fas fa-shield-alt mr-2"></i>管理者機能
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button onclick="window.open('pages/admin-dashboard.html', '_blank')" class="btn-unified btn-primary-unified">
                                <i class="fas fa-users-cog mr-2"></i>ユーザー管理ダッシュボード
                            </button>
                            <button onclick="window.openLoginManagement()" class="btn-unified btn-outline-unified">
                                <i class="fas fa-sign-in-alt mr-2"></i>ログイン管理
                            </button>
                        </div>
                    </div>
                    <div class="glass-card p-6">
                        <h3 class="text-lg font-semibold mb-4">
                            <i class="fas fa-history mr-2"></i>変更履歴（リアルタイム）
                        </h3>
                        <div id="activityLogContainer" class="activity-log">
                            <div class="text-center py-4 text-gray-500">
                                <i class="fas fa-spinner fa-spin text-xl mb-2"></i>
                                <p>履歴を読み込み中...</p>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                settingsContent.innerHTML = `
                    <h2 class="text-2xl font-bold mb-6">設定</h2>
                    <div class="glass-card p-6">
                        <h3 class="text-lg font-semibold mb-4">
                            <i class="fas fa-history mr-2"></i>変更履歴（リアルタイム）
                        </h3>
                        <div id="activityLogContainer" class="activity-log">
                            <div class="text-center py-4 text-gray-500">
                                <i class="fas fa-spinner fa-spin text-xl mb-2"></i>
                                <p>履歴を読み込み中...</p>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        formatDate(date) {
            return date.toISOString().slice(0, 10);
        }

        updateCEListCount() {
            const el = document.getElementById('ceListCount');
            if (el) {
                const count = window.ceManager?.ceList?.length || 0;
                el.textContent = String(count);
            }
        }

        // V2システム初期化
        initializeV2System() {
            setTimeout(async () => {
                try {
                    let attempts = 0;
                    while (attempts < 50) {
                        const allReady = (
                            typeof window.CalendarView !== 'undefined' &&
                            typeof window.EventManager !== 'undefined' &&
                            typeof window.CEManager !== 'undefined' &&
                            typeof window.showMessage !== 'undefined' &&
                            typeof window.CEDailyStatusManager !== 'undefined'
                        );
                        if (allReady) break;
                        await new Promise(resolve => setTimeout(resolve, 100));
                        attempts++;
                    }

                    // インスタンス生成（エラー耐性あり）
                    try {
                        if (!window.calendarView && window.CalendarView) {
                            window.calendarView = new window.CalendarView();
                        }
                    } catch (e) { console.warn('CalendarView初期化失敗:', e); }

                    try {
                        if (!window.eventManager && window.EventManager) {
                            window.eventManager = new window.EventManager();
                        }
                    } catch (e) { console.warn('EventManager初期化失敗:', e); }

                    try {
                        if (!window.ceManager && window.CEManager) {
                            window.ceManager = new window.CEManager();
                        }
                    } catch (e) { console.warn('CEManager初期化失敗:', e); }

                    try {
                        if (!window.ceDailyStatus && window.CEDailyStatusManager) {
                            window.ceDailyStatus = new window.CEDailyStatusManager();
                        }
                    } catch (e) { console.warn('CEDailyStatusManager初期化失敗:', e); }

                    console.log('✅ V2システム初期化完了（全機能対応）');
                } catch (error) {
                    console.error('❌ V2システム初期化エラー:', error);
                }
            }, 1500);
        }
    }

    // 初期化処理
    if (!window.dashboardAuthInitialized) {
        window.dashboardAuthInitialized = true;
        document.addEventListener('DOMContentLoaded', async () => {
            window.dashboardAuth = new DashboardAuth();
            await window.dashboardAuth.init();
        });
    }
    </script>
</body>
</html>
