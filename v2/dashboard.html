// Dashboard専用認証チェック（修正版）
class DashboardAuth {
    constructor() {
        this.isInitialized = false;
        this.init();
    }

    async init() {
        if (this.isInitialized) return;
        this.isInitialized = true;

        console.log('📊 ダッシュボード認証チェック開始');
        
        try {
            await this.waitForFirebase();
            await this.checkAuthWithRetry();
        } catch (error) {
            console.error('❌ ダッシュボード初期化エラー:', error);
            this.redirectToLogin();
        }
    }

    async waitForFirebase() {
        let attempts = 0;
        while (attempts < 30) {
            if (window.auth && window.database) {
                console.log('✅ Firebase準備完了');
                return;
            }
            await new Promise(resolve => setTimeout(resolve, 200));
            attempts++;
        }
        throw new Error('Firebase初期化失敗');
    }

    async checkAuthWithRetry(maxRetries = 3) {
        for (let attempt = 1; attempt <= maxRetries; attempt++) {
            try {
                console.log(`🔍 認証チェック試行 ${attempt}/${maxRetries}`);
                
                const targetUID = sessionStorage.getItem('targetUID');
                const currentUsername = sessionStorage.getItem('currentUsername');
                
                if (!targetUID || !currentUsername) {
                    console.log('❌ セッション情報なし → ログイン画面へ');
                    this.redirectToLogin();
                    return;
                }
                
                // 匿名認証を確実に実行
                await this.ensureAnonymousAuth();
                
                // ユーザーデータ確認
                const userSnapshot = await window.database.ref(`${window.DATA_ROOT}/users/${targetUID}`).once('value');
                const userData = userSnapshot.val();
                
                if (userData && userData.setupCompleted) {
                    console.log('✅ ダッシュボード表示許可');
                    window.userRole = userData.role || 'viewer';
                    window.currentUserData = userData;
                    
                    this.showDashboard();
                    return; // 成功時は即座に終了
                } else {
                    console.log('❌ ユーザー設定未完了 → ログイン画面へ');
                    this.redirectToLogin();
                    return;
                }
                
            } catch (error) {
                console.error(`❌ 認証チェック試行 ${attempt} エラー:`, error);
                
                if (attempt === maxRetries) {
                    console.error('❌ 全ての認証チェック試行が失敗');
                    this.redirectToLogin();
                    return;
                }
                
                // 次の試行まで待機
                await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
            }
        }
    }

    async ensureAnonymousAuth() {
        let user = window.auth.currentUser;
        
        if (!user) {
            console.log('🔄 匿名認証実行中...');
            const result = await window.auth.signInAnonymously();
            user = result.user;
            console.log('✅ 匿名認証成功:', user.uid);
        } else {
            console.log('✅ 既存認証ユーザー確認:', user.uid);
        }
        
        return user;
    }

    redirectToLogin() {
        console.log('🔄 ログイン画面にリダイレクト');
        sessionStorage.clear();
        window.location.href = 'index.html';
    }

    showDashboard() {
        const loading = document.getElementById('loading');
        if (loading) {
            loading.style.display = 'none';
        }
        
        console.log('📊 ダッシュボード表示開始');
        this.updateUserDisplay();
        this.initializeScheduleTable();
        this.setupEventListeners();
    }

    updateUserDisplay() {
        const userData = window.currentUserData;
        if (!userData) return;
        
        const userElements = document.querySelectorAll('.user-name, #userName, [data-user="name"]');
        userElements.forEach(element => {
            element.textContent = userData.displayName || userData.username || 'ユーザー';
        });
        
        const roleElements = document.querySelectorAll('.user-role, #userRole, [data-user="role"]');
        roleElements.forEach(element => {
            element.textContent = this.getRoleDisplayName(userData.role);
        });
    }

    getRoleDisplayName(role) {
        const roles = {
            'admin': '管理者',
            'editor': '編集者', 
            'viewer': '閲覧者'
        };
        return roles[role] || '一般ユーザー';
    }

    // 既存のメソッドはそのまま維持
    initializeScheduleTable() {
        console.log('📅 スケジュールテーブル初期化');
        
        const tableBody = document.getElementById('scheduleTableBody');
        if (!tableBody) return;
        
        const timeSlots = ['09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00'];
        const weekDays = ['月', '火', '水', '木', '金', '土', '日'];
        
        tableBody.innerHTML = timeSlots.map(time => `
            <tr>
                <td class="font-medium bg-gray-100">${time}</td>
                ${weekDays.map((day, index) => `
                    <td class="schedule-cell" data-time="${time}" data-day="${index}" onclick="openAssignmentModal('${time}', ${index})">
                        <div class="h-full w-full min-h-[60px] p-1">
                            <!-- スケジュール内容 -->
                        </div>
                    </td>
                `).join('')}
            </tr>
        `).join('');
    }

    setupEventListeners() {
        // 既存のイベントリスナー設定をそのまま維持
        const addCEBtn = document.getElementById('addCEBtn');
        if (addCEBtn) {
            addCEBtn.addEventListener('click', () => {
                const ceName = document.getElementById('ceNameInput').value.trim();
                const ceSkill = document.getElementById('ceSkillInput').value.trim();
                
                if (ceName) {
                    this.addCE(ceName, ceSkill);
                    document.getElementById('ceNameInput').value = '';
                    document.getElementById('ceSkillInput').value = '';
                }
            });
        }

        const addJobBtn = document.getElementById('addJobBtn');
        if (addJobBtn) {
            addJobBtn.addEventListener('click', () => {
                const jobName = document.getElementById('jobNameInput').value.trim();
                const jobDesc = document.getElementById('jobDescInput').value.trim();
                
                if (jobName) {
                    this.addJob(jobName, jobDesc);
                    document.getElementById('jobNameInput').value = '';
                    document.getElementById('jobDescInput').value = '';
                }
            });
        }

        document.getElementById('prevWeekBtn')?.addEventListener('click', () => this.changeWeek(-1));
        document.getElementById('nextWeekBtn')?.addEventListener('click', () => this.changeWeek(1));
    }

    addCE(name, skill) {
        const ceList = document.getElementById('ceList');
        const ceItem = document.createElement('div');
        ceItem.className = 'bg-blue-100 border border-blue-300 rounded p-2 text-sm';
        ceItem.innerHTML = `
            <div class="font-medium">${name}</div>
            ${skill ? `<div class="text-xs text-gray-600">${skill}</div>` : ''}
        `;
        ceList.appendChild(ceItem);
    }

    addJob(name, description) {
        const jobsList = document.getElementById('jobsList');
        const jobItem = document.createElement('div');
        jobItem.className = 'bg-green-100 border border-green-300 rounded p-2 text-sm';
        jobItem.innerHTML = `
            <div class="font-medium">${name}</div>
            ${description ? `<div class="text-xs text-gray-600">${description}</div>` : ''}
        `;
        jobsList.appendChild(jobItem);
    }

    changeWeek(direction) {
        const currentWeekElement = document.getElementById('currentWeek');
        if (currentWeekElement) {
            const now = new Date();
            const weekText = `${now.getFullYear()}年${now.getMonth() + 1}月第${Math.ceil(now.getDate() / 7)}週`;
            currentWeekElement.textContent = weekText;
        }
    }
}

// グローバル関数設定
window.logout = async () => {
    try {
        sessionStorage.clear();
        window.location.href = 'index.html';
    } catch (error) {
        console.error('ログアウトエラー:', error);
    }
};

window.openAssignmentModal = (time, day) => {
    const modal = document.getElementById('assignmentModal');
    if (modal) {
        modal.classList.remove('hidden');
    }
};

// モーダル制御
document.addEventListener('click', (e) => {
    const modal = document.getElementById('assignmentModal');
    
    if (e.target.id === 'cancelAssignmentBtn' || e.target.classList.contains('bg-black')) {
        modal?.classList.add('hidden');
    }
    
    if (e.target.id === 'saveAssignmentBtn') {
        modal?.classList.add('hidden');
    }
    
    if (e.target.id === 'deleteAssignmentBtn') {
        modal?.classList.add('hidden');
    }
});

// 初期化（重複防止）
if (!window.dashboardAuthInitialized) {
    window.dashboardAuthInitialized = true;
    document.addEventListener('DOMContentLoaded', () => {
        new DashboardAuth();
    });
}

console.log('📊 ダッシュボード認証システム読み込み完了（修正版）');
