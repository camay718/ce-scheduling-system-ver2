<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEスケジュール管理システム V2 - ダッシュボード</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- 外部ライブラリ -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- 統一テーマ -->
    <link rel="stylesheet" href="css/theme-unified.css">
    
    <!-- 月次業務専用スタイル -->
    <style>
    /* 月次業務（ダッシュボード強化スタイル） */
    .monthly-task-badge {
        position: absolute;
        top: -4px;
        right: 4px;
        background: #f97316;
        color: white;
        font-size: 8px;
        padding: 1px 4px;
        border-radius: 3px;
        font-weight: bold;
    }

    .assignment-dropzone {
        min-height: 20px;
        padding: 4px;
        margin-top: 4px;
    }

    .assignment-dropzone.drag-over {
        background: #fef3c7 !important;
        border-color: #f59e0b !important;
    }

    .btn-small {
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 3px;
        border: none;
        cursor: pointer;
    }

    .monthly-event-item {
        font-size: 11px;
        line-height: 1.2;
    }
    </style>

    <!-- Firebase SDK（重複削除済み） -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <!-- Firebase設定 -->
    <script src="js/config/firebase-config.js?v=20241213"></script>
</head>
<body class="theme-unified">
    <!-- ローディング画面 -->
    <div id="loading">
        <div class="spinner"></div>
        <p class="text-gray-600">ダッシュボードを読み込んでいます...</p>
    </div>

    <!-- メインインターフェース -->
    <div id="mainInterface" style="display:none;">
        <!-- サイドバー -->
        <div id="sidebar" class="sidebar p-4">
            <div class="mb-3 flex justify-between items-center">
                <button id="toggleSidebar" class="p-2 rounded-lg hover:bg-gray-200" title="サイドバー表示/非表示">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="text-xs text-gray-600 sidebar-text">
                    <span id="currentUserDisplay">ユーザー</span>
                </div>
            </div>

            <div class="mb-3">
                <div id="mainSyncStatus" class="sync-indicator connected">
                    <div class="sync-dot pulse"></div>
                    <span class="sidebar-text">リアルタイム同期中</span>
                </div>
            </div>

            <!-- ナビゲーション -->
            <nav class="space-y-2 mb-6">
                <button id="dailyScheduleTab" class="nav-tab w-full text-left p-3 rounded-lg hover:bg-green-100 font-medium active">
                    <i class="fas fa-calendar-day mr-2"></i><span class="sidebar-text">日別スケジュール</span>
                </button>
                <button id="ceManagementTab" class="nav-tab w-full text-left p-3 rounded-lg hover:bg-green-100 font-medium">
                    <i class="fas fa-table mr-2"></i><span class="sidebar-text">CE勤務区分表</span>
                </button>
                <button id="calendarTab" class="nav-tab w-full text-left p-3 rounded-lg hover:bg-green-100 font-medium">
                    <i class="fas fa-calendar-week mr-2"></i><span class="sidebar-text">週間カレンダー</span>
                </button>
                <button id="departmentTimelineTab" class="nav-tab w-full text-left p-3 rounded-lg hover:bg-green-100 font-medium">
                    <i class="fas fa-chart-gantt mr-2"></i><span class="sidebar-text">業務別タイムライン</span>
                </button>
                <button id="personalTimelineTab" class="nav-tab w-full text-left p-3 rounded-lg hover:bg-green-100 font-medium">
                    <i class="fas fa-chart-line mr-2"></i><span class="sidebar-text">個人別タイムライン</span>
                </button>
                <button id="analysisTab" class="nav-tab w-full text-left p-3 rounded-lg hover:bg-green-100 font-medium">
                    <i class="fas fa-chart-bar mr-2"></i><span class="sidebar-text">集計・分析</span>
                </button>
                <button id="settingsTab" class="nav-tab w-full text-left p-3 rounded-lg hover:bg-green-100 font-medium">
                    <i class="fas fa-cog mr-2"></i><span class="sidebar-text">設定</span>
                </button>
            </nav>

            <!-- テンプレート（縦配置版） -->
            <div class="sidebar-text mb-4">
                <h3 class="text-sm font-medium text-gray-700 mb-2">テンプレート</h3>
                <div class="flex flex-col space-y-2">
                    <button id="templateSaveButton" class="w-full p-2 bg-green-500 text-white rounded-lg text-sm hover:bg-green-600">
                        <i class="fas fa-save mr-1"></i>保存
                    </button>
                    <button id="templateLoadButton" class="w-full p-2 bg-blue-500 text-white rounded-lg text-sm hover:bg-blue-600">
                        <i class="fas fa-folder-open mr-1"></i>読込
                    </button>
                </div>
            </div>

            <!-- 自動同期ステータス -->
            <div class="mt-6 p-2 bg-yellow-50 rounded-lg sidebar-text">
                <h4 class="text-xs font-bold text-yellow-700 mb-1">自動同期</h4>
                <div class="text-xs text-gray-600">
                    <div class="flex items-center">
                        <div class="w-2 h-2 bg-green-500 rounded-full mr-1 animate-pulse"></div>
                        <span id="syncStatusText">同期中</span>
                    </div>
                    <div id="lastSyncTime" class="text-xs">最終: --:--</div>
                </div>
            </div>
            
            <!-- ログアウトボタン -->
            <div class="mt-auto pt-4 border-t border-gray-200 sidebar-text">
                <button id="logoutButton" onclick="window.handleLogout()" 
                        class="w-full bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 text-sm font-medium transition-colors">
                    <i class="fas fa-sign-out-alt mr-2"></i>ログアウト
                </button>
            </div>
        </div>

        <!-- メインコンテンツ -->
        <div class="main-content p-4">
            <!-- 日別スケジュール -->
            <div id="dailyScheduleContent" class="screen-content">
                <div class="mb-4 flex justify-between items-center">
                    <h2 id="dailyScheduleTitle" class="text-2xl font-bold">日別スケジュール</h2>
                    <div class="flex items-center gap-3">
                        <button id="prevDayBtn" class="btn-unified btn-outline-unified">
                            <i class="fas fa-chevron-left mr-1"></i>前日
                        </button>
                        <input type="date" id="scheduleDatePicker" class="input-unified" style="width: auto;">
                        <button id="nextDayBtn" class="btn-unified btn-outline-unified">
                            翌日<i class="fas fa-chevron-right ml-1"></i>
                        </button>
                        <button id="todayBtn" class="btn-unified btn-primary-unified">
                            <i class="fas fa-calendar-day mr-1"></i>今日
                        </button>
                        <button id="addEventButtonDaily" class="btn-unified btn-primary-unified">
                            <i class="fas fa-plus mr-2"></i>業務追加
                        </button>
                    </div>
                </div>

                <div class="mb-4 flex gap-3">
                    <button id="addBulkEventBtn" class="btn-unified btn-primary-unified">
                        <i class="fas fa-calendar-plus mr-1"></i>期間一括業務追加
                    </button>
                    <button id="addMonthlyTaskBtn" class="btn-unified btn-primary-unified">
                        <i class="fas fa-calendar-alt mr-1"></i>月次業務追加
                    </button>
                </div>
                
                <div id="departmentGrid" class="grid grid-cols-3 gap-4 mb-6"></div>
                
                <div class="glass-card p-4">
                    <h3 class="font-bold mb-3"><i class="fas fa-users mr-2"></i>CEリスト（<span id="ceListCount">--</span>名）</h3>
                    <div id="ceListContainer" class="ce-grid"></div>
                </div>
            </div>

            <!-- CE勤務区分表（表示専用・改善版） -->
            <div id="ceManagementContent" class="screen-content" style="display:none; position: relative;">
                <!-- 勤務時間帯説明（右上極小配置） -->
         <div class="work-time-compact" style="position: absolute; top: 15px; right: 15px; background: rgba(248, 249, 250, 0.95); border: 1px dashed #e0e0e0; border-radius: 4px; padding: 4px 6px; font-size: 8px; z-index: 100; max-width: 300px; line-height: 1.2; white-space: nowrap;">
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr>
                <th style="padding: 2px 4px; font-size: 8px; background: #f2f5f7; font-weight: 600; text-align: left;">区分</th>
                <th style="padding: 2px 4px; font-size: 8px; background: #f2f5f7; font-weight: 600; text-align: left;">勤務時間</th>
                <th style="padding: 2px 4px; font-size: 8px; background: #f2f5f7; font-weight: 600; text-align: left;">休憩時間</th>
            </tr>
        </thead>
        <tbody>
            <tr><td style="padding: 2px 4px; font-size: 8px;">A</td><td style="padding: 2px 4px; font-size: 8px;">8:00〜16:30</td><td style="padding: 2px 4px; font-size: 8px;">11:45～12:30</td></tr>
            <tr><td style="padding: 2px 4px; font-size: 8px;">A1</td><td style="padding: 2px 4px; font-size: 8px;">7:00〜15:30</td><td style="padding: 2px 4px; font-size: 8px;">11:45～12:30</td></tr>
            <tr><td style="padding: 2px 4px; font-size: 8px;">B</td><td style="padding: 2px 4px; font-size: 8px;">8:00〜翌8:00（0:00～6:30宿直相当勤務）</td><td style="padding: 2px 4px; font-size: 8px;">11:45～12:45及び16:45～17:45</td></tr>
            <tr><td style="padding: 2px 4px; font-size: 8px;">×</td><td style="padding: 2px 4px; font-size: 8px;">休日</td><td style="padding: 2px 4px; font-size: 8px;">-</td></tr>
        </tbody>
    </table>
</div>

                <div class="schedule-display-container">
                    <div class="period-navigation">
                        <button id="prevPeriodBtn" class="btn-unified btn-outline-unified">
                            <i class="fas fa-chevron-left mr-1"></i>前の期間
                        </button>
                        <div class="period-display">
                            <div id="currentPeriodDisplay" class="text-lg font-bold">期間を読み込み中...</div>
                            <div class="text-sm text-gray-500">28日間の勤務表</div>
                        </div>
                        <button id="nextPeriodBtn" class="btn-unified btn-outline-unified">
                            次の期間<i class="fas fa-chevron-right ml-1"></i>
                        </button>
                    </div>
                    
                    <div class="text-center mb-4">
                        <button id="openScheduleEditorBtn" class="btn-unified btn-primary-unified">
                            <i class="fas fa-edit mr-2"></i>勤務表を作成・編集
                        </button>
                    </div>

                    <!-- 勤務区分表表示エリア -->
                    <div id="workScheduleDisplayArea" class="text-center py-8 text-gray-500">
                        <i class="fas fa-table text-4xl mb-4"></i>
                        <h3 class="text-lg font-semibold mb-2">勤務区分表</h3>
                        <p class="mb-4">作成済みの勤務表がここに表示されます</p>
                        <button onclick="document.getElementById('openScheduleEditorBtn').click()" 
                                class="btn-unified btn-primary-unified">
                            <i class="fas fa-plus mr-2"></i>最初の勤務表を作成
                        </button>
                    </div>
                </div>
            </div>

            <!-- その他のタブコンテンツ -->
            <div id="calendarContent" class="screen-content" style="display:none;">
                <h2 class="text-2xl font-bold mb-4">週間カレンダー</h2>
                <p class="text-gray-600">週間カレンダー機能（開発予定）</p>
            </div>

            <div id="departmentTimelineContent" class="screen-content" style="display:none;">
                <h2 class="text-2xl font-bold mb-4">業務別タイムライン</h2>
                <p class="text-gray-600">業務別タイムライン機能（開発予定）</p>
            </div>

            <div id="personalTimelineContent" class="screen-content" style="display:none;">
                <h2 class="text-2xl font-bold mb-4">個人別タイムライン</h2>
                <p class="text-gray-600">個人別タイムライン機能（開発予定）</p>
            </div>

            <div id="analysisContent" class="screen-content" style="display:none;">
                <h2 class="text-2xl font-bold mb-4">集計・分析</h2>
                <p class="text-gray-600">集計・分析機能（開発予定）</p>
            </div>

            <div id="settingsContent" class="screen-content" style="display:none;">
                <!-- 設定コンテンツは動的生成 -->
            </div>
        </div>
    </div>

    <!-- JavaScript読み込み（順次同期読み込み） -->
    <script src="js/data/constants.js?v=20241213"></script>
    <script src="js/utils/ui-utils.js?v=20241213"></script>
    <script src="js/utils/date-utils.js?v=20241213"></script>
    <script src="js/schedule/schedule-core.js?v=20241213"></script>
    <script src="js/schedule/calendar-view.js?v=20241213"></script>
    <script src="js/schedule/event-manager.js?v=20241213"></script>
    <script src="js/ui/ce-manager.js?v=20241213"></script>
    <script src="js/ui/ce-daily-status.js?v=20241213"></script>

    <!-- Dashboard専用JavaScript（完全修正版） -->
    <script>
    // ログアウト（監査ログ付き）
    window.handleLogout = async () => {
        try {
            try {
                const entry = {
                    action: 'logout',
                    details: {},
                    uid: window.currentUserData?.uid || null,
                    username: window.currentUserData?.username || 'unknown',
                    displayName: window.currentUserData?.displayName || 'unknown',
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    userAgent: navigator.userAgent.substring(0, 100)
                };
                await window.database.ref(`${window.DATA_ROOT}/auditLogs`).push(entry);
            } catch (logError) {
                console.warn('監査ログ記録失敗:', logError);
            }
            if (window.auth && window.auth.currentUser) {
                await window.auth.signOut();
            }
        } catch (error) {
            console.error('ログアウトエラー:', error);
        } finally {
            sessionStorage.clear();
            localStorage.clear();
            window.location.href = 'index.html';
        }
    };

// WorkScheduleViewerクラスの完全改良版
class WorkScheduleViewer {
    constructor() {
        this.currentPeriodIndex = 0;
        this.availablePeriods = [];
        this.realtimeListener = null;
        this.init();
    }

    async init() {
        try {
            await window.waitForFirebase();
            this.setupRealtimeListener();
            this.setupEventListeners();
            console.log('✅ 勤務区分表ビューアー初期化完了');
        } catch (error) {
            console.error('❌ 勤務区分表ビューアー初期化エラー:', error);
        }
    }

    // リアルタイム更新リスナーの設定
    setupRealtimeListener() {
        if (this.realtimeListener) {
            this.realtimeListener.off();
        }
        
        this.realtimeListener = window.database.ref(`${window.DATA_ROOT}/workSchedules`);
        this.realtimeListener.on('value', async (snapshot) => {
            console.log('🔄 公開勤務表データ更新検知');
            await this.loadAvailablePeriods();
            this.displayCurrentPeriod();
        });
    }

    async loadAvailablePeriods() {
        try {
            const snapshot = await window.database.ref(`${window.DATA_ROOT}/workSchedules`).once('value');
            const data = snapshot.val() || {};
            
            this.availablePeriods = Object.keys(data)
                .map(periodKey => ({
                    key: periodKey,
                    ...data[periodKey].metadata
                }))
                .filter(period => {
                    // 管理者は全て表示、一般ユーザーは表示可能なもののみ
                    return window.userRole === 'admin' || (period.isVisible !== false);
                })
                .sort((a, b) => (b.publishedAt || b.createdAt || 0) - (a.publishedAt || a.createdAt || 0));
            
            if (this.availablePeriods.length > 0) {
                // 現在のインデックスが範囲外の場合は調整
                if (this.currentPeriodIndex >= this.availablePeriods.length) {
                    this.currentPeriodIndex = 0;
                }
                this.displayCurrentPeriod();
            } else {
                this.displayNoPeriods();
            }
        } catch (error) {
            console.error('❌ 期間データ読み込みエラー:', error);
        }
    }

    setupEventListeners() {
        const prevBtn = document.getElementById('prevPeriodBtn');
        const nextBtn = document.getElementById('nextPeriodBtn');
        const editorBtn = document.getElementById('openScheduleEditorBtn');

        if (prevBtn) prevBtn.onclick = () => this.navigatePeriod(-1);
        if (nextBtn) nextBtn.onclick = () => this.navigatePeriod(1);
        if (editorBtn) editorBtn.onclick = () => this.openScheduleEditor();
    }

    async displayCurrentPeriod() {
        const displayEl = document.getElementById('currentPeriodDisplay');
        const areaEl = document.getElementById('workScheduleDisplayArea');
        
        if (this.availablePeriods.length === 0) {
            this.displayNoPeriods();
            return;
        }

        const currentPeriod = this.availablePeriods[this.currentPeriodIndex];
        if (displayEl) {
            const visibilityStatus = currentPeriod.isVisible === false ? ' (非公開)' : '';
            displayEl.innerHTML = `
                <div>${currentPeriod.startDate} ～ ${currentPeriod.endDate}${visibilityStatus}</div>
                <div class="text-sm text-gray-500">
                    (${this.currentPeriodIndex + 1}/${this.availablePeriods.length})
                    ${window.userRole === 'admin' ? this.renderAdminControls(currentPeriod) : ''}
                </div>
            `;
        }

        await this.renderWorkScheduleTable(currentPeriod.key);
    }

    renderAdminControls(period) {
        return `
            <div class="inline-flex gap-2 ml-4">
                <button onclick="window.workScheduleViewer.toggleVisibility('${period.key}')" 
                        class="btn-small ${period.isVisible === false ? 'bg-green-500' : 'bg-yellow-500'} text-white" 
                        title="表示/非表示切替">
                    <i class="fas fa-eye${period.isVisible === false ? '' : '-slash'}"></i>
                </button>
                <button onclick="window.workScheduleViewer.deleteSchedule('${period.key}')" 
                        class="btn-small bg-red-500 text-white" title="削除">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
    }

    displayNoPeriods() {
        const displayEl = document.getElementById('currentPeriodDisplay');
        const areaEl = document.getElementById('workScheduleDisplayArea');
        
        if (displayEl) displayEl.textContent = '作成済みの期間なし';
        if (areaEl) {
            areaEl.innerHTML = `
                <div class="text-center py-12">
                    <i class="fas fa-calendar-plus text-4xl text-gray-400 mb-4"></i>
                    <h3 class="text-lg font-semibold text-gray-600 mb-2">勤務区分表</h3>
                    <p class="text-gray-500 mb-4">まだ勤務表が作成されていません</p>
                    <button onclick="document.getElementById('openScheduleEditorBtn').click()" 
                            class="btn-unified btn-primary-unified">
                        <i class="fas fa-plus mr-2"></i>最初の勤務表を作成
                    </button>
                </div>
            `;
        }
    }

    async renderWorkScheduleTable(periodKey) {
        const areaEl = document.getElementById('workScheduleDisplayArea');
        if (!areaEl) return;

        try {
            const snapshot = await window.database.ref(`${window.DATA_ROOT}/workSchedules/${periodKey}`).once('value');
            const periodData = snapshot.val();
            
            if (!periodData || !periodData.ceList) {
                areaEl.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-exclamation-triangle text-4xl text-yellow-500 mb-4"></i>
                        <p class="text-gray-600">勤務表データまたはCEリストが見つかりません</p>
                    </div>
                `;
                return;
            }

            const scheduleData = periodData.scheduleData || {};
            const ceList = periodData.ceList;
            const workTypeOverrides = periodData.workTypeOverrides || {};
            const metadata = periodData.metadata || {};
            const dates = this.generateDateRange(new Date(metadata.startDate), new Date(metadata.endDate));

            areaEl.innerHTML = `
                <div class="work-schedule-table-wrapper">
                    <table class="work-schedule-table">
                        ${this.generateTableHTML(dates, scheduleData, ceList, workTypeOverrides)}
                    </table>
                </div>
            `;

        } catch (error) {
            console.error('❌ 勤務表表示エラー:', error);
            areaEl.innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                    <p class="text-gray-600">勤務表の読み込みでエラーが発生しました</p>
                </div>
            `;
        }
    }

    // 実効勤務区分取得（オーバーライド適用）
    getEffectiveWorkType(ceId, dateKey, ceList, workTypeOverrides) {
        const ce = ceList.find(c => c.id === ceId);
        if (!ce) return 'ME';

        const overrides = workTypeOverrides[ceId];
        if (Array.isArray(overrides)) {
            const validOverrides = overrides.filter(override => 
                dateKey >= override.startDate && dateKey <= override.endDate
            );
            if (validOverrides.length > 0) {
                const latest = validOverrides.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0))[0];
                return latest.workType;
            }
        } else if (overrides && overrides.startDate && dateKey >= overrides.startDate && dateKey <= overrides.endDate) {
            return overrides.workType;
        }
        
        return ce.workType || 'ME';
    }

    generateTableHTML(dates, scheduleData, ceList, workTypeOverrides) {
        let html = '<thead><tr><th class="name-header">氏名</th>';
        
        // ヘッダー行
        dates.forEach(date => {
            const dayOfWeek = ['日', '月', '火', '水', '木', '金', '土'][date.getDay()];
            const isWeekend = date.getDay() === 0 || date.getDay() === 6;
            const headerClass = isWeekend ? 'date-header weekend-header' : 'date-header';
            
            html += `
                <th class="${headerClass}">
                    <div>${date.getDate()}</div>
                    <div class="text-xs">${dayOfWeek}</div>
                </th>
            `;
        });
        
        const summaryHeaders = ['A', 'A1', 'B', '非', '×', '年', '出', '研', '休日数', '実勤務', '当直回数'];
        summaryHeaders.forEach(header => {
            html += `<th class="summary-header">${header}</th>`;
        });
        html += '</tr></thead>';
        
        // ボディ行
        html += '<tbody>';
        ceList.forEach(ce => {
            const fullName = ce.fullName || ce.name || '';
            html += `<tr><td class="name-cell">
                <div class="font-medium">${fullName}</div>
                <div class="text-xs text-gray-500">${ce.workType}</div>
            </td>`;
            
            const summary = { A: 0, A1: 0, B: 0, non: 0, off: 0, year: 0, trip: 0, training: 0, holidays: 0, actual: 0, night: 0 };
            
            dates.forEach(date => {
                const dateKey = this.formatDate(date);
                const workData = scheduleData[ce.id]?.[dateKey] || {};
                const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                const status = workData.customText?.trim() || workData.status || (isWeekend ? '×' : 'A');
                const desired = workData.desired || false;
                
                // 実効勤務区分を取得（オーバーライド反映）
                const effectiveWorkType = this.getEffectiveWorkType(ce.id, dateKey, ceList, workTypeOverrides);
                
                if (isWeekend) summary.holidays++;
                switch (workData.status || (isWeekend ? '×' : 'A')) {
                    case 'A': summary.A++; summary.actual++; break;
                    case 'A1': summary.A1++; summary.actual++; break;
                    case 'B': summary.B++; summary.actual++; summary.night++; break;
                    case '非': summary.non++; summary.actual++; break;
                    case '×': summary.off++; break;
                    case '年': summary.year++; summary.actual++; break;
                    case '出': summary.trip++; summary.actual++; break;
                    case '研': summary.training++; summary.actual++; break;
                }
                
                let cellClass = `work-cell type-${effectiveWorkType.toLowerCase()}`;
                if (workData.status) cellClass += ` status-${workData.status}`;
                if (desired) cellClass += ' desired';
                if (isWeekend) cellClass += ' holiday';
                
                html += `<td class="${cellClass}">${status}</td>`;
            });
            
            const summaryValues = [summary.A, summary.A1, summary.B, summary.non, summary.off, summary.year, summary.trip, summary.training, summary.holidays, summary.actual, summary.night];
            summaryValues.forEach(value => {
                html += `<td class="summary-cell">${value}</td>`;
            });
            
            html += '</tr>';
        });
        html += '</tbody>';

        // フッター（集計行）
        html += '<tfoot>';
        const footerTypes = [
            { label: 'OPE(A)', filter: (effectiveType, status) => effectiveType === 'OPE' && status === 'A' },
            { label: 'OPE(A1)', filter: (effectiveType, status) => effectiveType === 'OPE' && status === 'A1' },
            { label: 'ME', filter: (effectiveType, status) => effectiveType === 'ME' && ['A', 'A1', 'B', '非', '年', '出', '研'].includes(status) },
            { label: 'HD', filter: (effectiveType, status) => effectiveType === 'HD' && ['A', 'A1', 'B', '非', '年', '出', '研'].includes(status) },
            { label: 'FLEX', filter: (effectiveType, status) => effectiveType === 'FLEX' && ['A', 'A1', 'B', '非', '年', '出', '研'].includes(status) },
            { label: '当直', filter: (effectiveType, status) => status === 'B', target: 1 },
            { label: '非番', filter: (effectiveType, status) => status === '非', target: 1 }
        ];

        footerTypes.forEach(type => {
            html += `<tr class="footer-summary-row"><th class="type-label">${type.label}</th>`;
            
            dates.forEach(date => {
                const dateKey = this.formatDate(date);
                let count = 0;
                ceList.forEach(ce => {
                    const workData = scheduleData[ce.id]?.[dateKey] || {};
                    const status = workData.status || (date.getDay() === 0 || date.getDay() === 6 ? '×' : 'A');
                    const effectiveType = this.getEffectiveWorkType(ce.id, dateKey, ceList, workTypeOverrides);
                    
                    if (type.filter(effectiveType, status)) {
                        count++;
                    }
                });
                
                const cellClass = type.target && count !== type.target ? 'warning-count' : '';
                html += `<td class="${cellClass}">${count}</td>`;
            });
            
            for (let i = 0; i < summaryHeaders.length; i++) {
                html += '<td></td>';
            }
            html += '</tr>';
        });
        
        html += '</tfoot>';
        return html;
    }

    // 管理者機能：表示/非表示切替
    async toggleVisibility(periodKey) {
        if (window.userRole !== 'admin') {
            window.showMessage('管理者権限が必要です', 'warning');
            return;
        }

        try {
            const snapshot = await window.database.ref(`${window.DATA_ROOT}/workSchedules/${periodKey}/metadata`).once('value');
            const metadata = snapshot.val();
            
            const newVisibility = !(metadata?.isVisible !== false);
            await window.database.ref(`${window.DATA_ROOT}/workSchedules/${periodKey}/metadata/isVisible`).set(newVisibility);
            
            window.showMessage(`勤務表を${newVisibility ? '表示' : '非表示'}に設定しました`, 'success');
            
        } catch (error) {
            console.error('❌ 表示切替エラー:', error);
            window.showMessage('表示設定の変更に失敗しました', 'error');
        }
    }

    // 管理者機能：勤務表削除
    async deleteSchedule(periodKey) {
        if (window.userRole !== 'admin') {
            window.showMessage('管理者権限が必要です', 'warning');
            return;
        }

        const period = this.availablePeriods.find(p => p.key === periodKey);
        if (!period) return;

        if (!confirm(`勤務表「${period.startDate} ～ ${period.endDate}」を完全に削除しますか？\n\nこの操作は元に戻せません。`)) {
            return;
        }

        try {
            await window.database.ref(`${window.DATA_ROOT}/workSchedules/${periodKey}`).remove();
            window.showMessage('勤務表を削除しました', 'success');
            
        } catch (error) {
            console.error('❌ 勤務表削除エラー:', error);
            window.showMessage('勤務表の削除に失敗しました', 'error');
        }
    }

    generateDateRange(startDate, endDate) {
        const dates = [];
        const current = new Date(startDate);
        
        while (current <= endDate) {
            dates.push(new Date(current));
            current.setDate(current.getDate() + 1);
        }
        
        return dates;
    }

    formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    openScheduleEditor() {
        if (window.userRole === 'viewer') {
            window.showMessage('編集権限がありません', 'warning');
            return;
        }
        
        const targetUID = sessionStorage.getItem('targetUID');
        const currentUsername = sessionStorage.getItem('currentUsername');
        
        if (!targetUID || !currentUsername) {
            window.showMessage('セッション情報が不足しています。再度ログインしてください。', 'error');
            return;
        }
        
        const params = new URLSearchParams({
            uid: targetUID,
            username: currentUsername,
            role: window.userRole,
            timestamp: Date.now()
        });
        
        const url = `pages/work-schedule-editor.html?${params.toString()}`;
        
        const win = window.open(url, 'workScheduleEditor', 'width=1400,height=900,scrollbars=yes,resizable=yes');
        
        if (!win || win.closed || typeof win.closed === 'undefined') {
            if (confirm('新しいタブで開けませんでした。同じタブで勤務表エディタを開きますか？')) {
                window.location.href = url;
            } else {
                window.showMessage('勤務表エディタを開くには、ポップアップを許可してください', 'warning');
            }
        } else {
            console.log('✅ 勤務表エディタを新しいタブで開きました');
        }
    }
}

        formatDate(date) {
            return date.toISOString().slice(0, 10);
        }
    }

    class DashboardAuth {
        constructor() {
            this.isInitialized = false;
            this.selectedDate = new Date();
            this.monthlyTasks = {};
            this.eventsListener = null;
            this.init();
        }

        async init() {
            if (this.isInitialized) return;
            this.isInitialized = true;

            try {
                await window.waitForFirebase();
                await this.checkAuthWithRetry();
            } catch (error) {
                console.error('初期化エラー:', error);
                this.redirectToLogin();
            }
        }

        async checkAuthWithRetry(maxRetries = 3) {
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    const targetUID = sessionStorage.getItem('targetUID');
                    const currentUsername = sessionStorage.getItem('currentUsername');
                    if (!targetUID || !currentUsername) {
                        this.redirectToLogin();
                        return;
                    }
                    await this.ensureAnonymousAuth();
                    
                    const userSnapshot = await window.database.ref(`${window.DATA_ROOT}/users/${targetUID}`).once('value');
                    const userData = userSnapshot.val();
                    
                    if (userData && userData.setupCompleted) {
                        window.userRole = userData.role || 'viewer';
                        window.currentUserData = userData;
                        this.showDashboard();
                        return;
                    } else {
                        this.redirectToLogin();
                        return;
                    }
                } catch (error) {
                    if (attempt === maxRetries) {
                        this.redirectToLogin();
                        return;
                    }
                    await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                }
            }
        }

        async ensureAnonymousAuth() {
            let user = window.auth.currentUser;
            if (!user) {
                const result = await window.auth.signInAnonymously();
                user = result.user;
            }
            return user;
        }
async loadAndRenderEventsForSelectedDate() {
    const grid = document.getElementById('departmentGrid');
    if (!grid) return;

    const dateKey = this.formatDate(this.selectedDate);
    try {
        const snap = await window.database.ref(`${window.DATA_ROOT}/events/byDate/${dateKey}`).once('value');
        const eventsById = snap.val() || {};
        const events = Object.values(eventsById);

        // 既存のイベントカードをクリア
        grid.querySelectorAll('.task-list').forEach(el => {
            el.querySelectorAll('.glass-card.event-card').forEach(card => card.remove());
        });

        // イベントを部門ごとに表示
        events.forEach(ev => {
            const section = grid.querySelector(`.task-list[data-department="${ev.department}"]`);
            if (!section) return;

            const item = document.createElement('div');
            item.className = 'glass-card p-2 mb-2 rounded-lg shadow-sm event-card event-drop-target';
            item.dataset.eventId = ev.id;
            item.dataset.dateKey = dateKey;
            item.dataset.department = ev.department;

            // ドロップイベントリスナー
            item.addEventListener('dragover', (e) => this.handleEventDragOver(e));
            item.addEventListener('dragleave', (e) => this.handleEventDragLeave(e));
            item.addEventListener('drop', (e) => this.handleEventDrop(e));

            const timeText = (ev.startTime && ev.endTime) ? ` ${ev.startTime}-${ev.endTime}` : '';

            // assignedCEsの互換処理（ID配列とオブジェクト配列両対応）
            const assignedList = Array.isArray(ev.assignedCEs) ? ev.assignedCEs : [];
            const normalizedAssigned = assignedList.map(entry => {
                if (typeof entry === 'string') {
                    // ID文字列の場合、CEManagerから情報を取得
                    const ce = window.ceManager?.ceList?.find(c => c.id === entry);
                    return ce ? { 
                        id: ce.id, 
                        name: ce.iconName || ce.displayName || ce.name, 
                        workType: ce.workType || 'ME' 
                    } : { id: entry, name: entry, workType: 'ME' };
                } else if (entry && typeof entry === 'object') {
                    // オブジェクトの場合はそのまま使用
                    return { 
                        id: entry.id, 
                        name: entry.name, 
                        workType: entry.workType || 'ME' 
                    };
                }
                return null;
            }).filter(Boolean);

            const assignedCount = normalizedAssigned.length;
            const need = Number.isFinite(ev.requiredPeople) ? ev.requiredPeople : 0;

            // 配置済みCEチップの生成
            const assignedCEChips = normalizedAssigned.map(assigned => `
                <span class="chip worktype-${(assigned.workType || 'ME').toLowerCase()}" data-ce-id="${assigned.id}" title="${assigned.name}">
                    ${assigned.name}
                    ${window.userRole !== 'viewer' ? `<i class="fas fa-times remove" title="配置解除"></i>` : ''}
                </span>
            `).join('');

            item.innerHTML = `
                <div class="flex justify-between items-center">
                    <div class="font-semibold text-sm">
                        <i class="fas fa-briefcase mr-1"></i>${ev.name}${timeText}
                    </div>
                    <div class="text-xs text-gray-500">${assignedCount}/${need}名</div>
                </div>
                ${ev.description ? `<div class="text-xs text-gray-600 mt-1">${ev.description}</div>` : ''}
                ${assignedCEChips ? `<div class="assigned-ces mt-2">${assignedCEChips}</div>` : ''}
                <div class="drop-hint text-xs text-gray-400 mt-1 italic">CEをドラッグ&ドロップで配置</div>
                ${window.userRole !== 'viewer' ? `<button class="edit-event-btn text-blue-600 hover:text-blue-800 text-xs mt-1">
                    <i class="fas fa-edit mr-1"></i>編集
                </button>` : ''}
            `;

            // 編集ボタンのイベント（inline onclick回避）
            const editBtn = item.querySelector('.edit-event-btn');
            if (editBtn) {
                editBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.openEditEventModal(dateKey, ev.id, ev);
                });
            }

            // 配置解除ボタンのイベント（inline onclick回避）
            const removeButtons = item.querySelectorAll('.chip .remove');
            removeButtons.forEach(removeBtn => {
                removeBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const chip = e.currentTarget.closest('.chip');
                    const ceId = chip?.dataset?.ceId;
                    if (ceId) {
                        await this.unassignCE(dateKey, ev.id, ceId);
                    }
                });
            });

            section.appendChild(item);
        });

        // CEアイテムにドラッグ機能を有効化
        setTimeout(() => {
            this.enableCEDragging();
        }, 100);

        console.log(`✅ ${dateKey} のイベント表示完了: ${events.length}件`);

    } catch (error) {
        console.error('❌ 日別イベント読み込みエラー:', error);
        window.showMessage('イベントの読み込みに失敗しました', 'error');
    }
}

        redirectToLogin() {
            sessionStorage.clear();
            window.location.href = 'index.html';
        }

        setupRealtimeUpdates() {
    const updateEvents = () => {
        const dateKey = this.formatDate(this.selectedDate);
        
        // 既存のリスナーがあれば削除
        if (this.eventsListener) {
            this.eventsListener.off();
        }
        
        // 新しいリスナー設定
        this.eventsListener = window.database.ref(`${window.DATA_ROOT}/events/byDate/${dateKey}`)
            .on('value', (snapshot) => {
                console.log('🔄 イベントデータ更新検知');
                setTimeout(() => {
                    this.loadAndRenderEventsForSelectedDate();
                }, 300);
            });
    };
    
    // 初回設定
    updateEvents();
    
    // 日付変更時に再設定
    const originalRenderSchedule = this.renderDailySchedule.bind(this);
    this.renderDailySchedule = function() {
        originalRenderSchedule();
        updateEvents();
    };
}

// CEドラッグ機能の有効化
enableCEDragging() {
    const ceItems = document.querySelectorAll('.ce-item:not([draggable])');
    const ceList = window.ceManager?.ceList || [];

    ceItems.forEach((item, index) => {
        item.draggable = true;

        // CEデータの設定
        const ce = ceList[index];
        if (ce) {
            item.dataset.ceId = ce.id;
            item.dataset.ceName = ce.iconName || ce.displayName || ce.name;
            item.dataset.workType = ce.workType;
        } else {
            // フォールバック：表示名からCEを検索
            const displayName = item.textContent.trim();
            const matchedCE = ceList.find(c => 
                c.iconName === displayName || 
                c.displayName === displayName || 
                c.name === displayName
            );
            if (matchedCE) {
                item.dataset.ceId = matchedCE.id;
                item.dataset.ceName = matchedCE.iconName || matchedCE.displayName || matchedCE.name;
                item.dataset.workType = matchedCE.workType;
            }
        }

        // ドラッグイベント
        item.addEventListener('dragstart', (e) => {
            const ceData = {
                ceId: item.dataset.ceId,
                ceName: item.dataset.ceName,
                workType: item.dataset.workType || 'ME'
            };

            e.dataTransfer.setData('application/json', JSON.stringify(ceData));
            e.dataTransfer.effectAllowed = 'copy';
            item.classList.add('dragging');
            console.log('🎯 CEドラッグ開始:', ceData);
        });

        item.addEventListener('dragend', () => {
            item.classList.remove('dragging');
        });
    });

    console.log('✅ CEドラッグ機能有効化完了');
}

// ドラッグオーバー処理
handleEventDragOver(e) {
    if (window.userRole === 'viewer') return;
    
    e.preventDefault();
    e.dataTransfer.dropEffect = 'copy';
    e.currentTarget.classList.add('drag-over');
}

// ドラッグリーブ処理
handleEventDragLeave(e) {
    if (!e.currentTarget.contains(e.relatedTarget)) {
        e.currentTarget.classList.remove('drag-over');
    }
}

// ドロップ処理
async handleEventDrop(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('drag-over');

    if (window.userRole === 'viewer') {
        window.showMessage('編集権限がありません', 'warning');
        return;
    }

    try {
        const ceDataStr = e.dataTransfer.getData('application/json');
        if (!ceDataStr) return;

        const ceData = JSON.parse(ceDataStr);
        const eventId = e.currentTarget.dataset.eventId;
        const dateKey = e.currentTarget.dataset.dateKey;

        console.log('📥 ドロップ処理:', { ceData, eventId, dateKey });
        await this.assignCEToEvent(dateKey, eventId, ceData);

    } catch (error) {
        console.error('❌ ドロップ処理エラー:', error);
        window.showMessage('CE配置に失敗しました', 'error');
    }
}

// CEを業務に配置（オブジェクト配列対応）
async assignCEToEvent(dateKey, eventId, ceData) {
    try {
        const eventRef = window.database.ref(`${window.DATA_ROOT}/events/byDate/${dateKey}/${eventId}`);
        const snapshot = await eventRef.once('value');
        const eventData = snapshot.val();

        if (!eventData) {
            window.showMessage('業務データが見つかりません', 'error');
            return;
        }

        const currentAssigned = Array.isArray(eventData.assignedCEs) ? eventData.assignedCEs : [];
        
        // 重複チェック（ID文字列とオブジェクト両対応）
        const exists = currentAssigned.some(x => 
            (typeof x === 'string' ? x === ceData.ceId : x?.id === ceData.ceId)
        );
        
        if (exists) {
            window.showMessage(`${ceData.ceName}は既に配置済みです`, 'warning');
            return;
        }

        // オブジェクト形式でCE情報を保存
        const ceEntry = {
            id: ceData.ceId,
            name: ceData.ceName,
            workType: ceData.workType || 'ME'
        };

        // 既存のID文字列をオブジェクト形式に変換（後方互換性）
        const upgradedAssigned = currentAssigned.map(x => {
            if (typeof x === 'string') {
                const ce = window.ceManager?.ceList?.find(c => c.id === x);
                return {
                    id: x,
                    name: ce?.iconName || ce?.displayName || x,
                    workType: ce?.workType || 'ME'
                };
            }
            return x;
        });

        upgradedAssigned.push(ceEntry);

        await eventRef.update({
            assignedCEs: upgradedAssigned,
            updatedAt: firebase.database.ServerValue.TIMESTAMP,
            updatedBy: window.currentUserData?.displayName || 'user'
        });

        window.showMessage(`${ceData.ceName}を配置しました`, 'success');
        console.log('✅ CE配置完了:', ceData.ceName);

        // 画面を再描画
        setTimeout(() => {
            this.loadAndRenderEventsForSelectedDate();
        }, 500);

    } catch (error) {
        console.error('❌ CE配置エラー:', error);
        window.showMessage('CE配置処理でエラーが発生しました', 'error');
    }
}

// CE配置解除
async unassignCE(dateKey, eventId, ceId) {
    if (!confirm('このCEの配置を解除しますか？')) return;

    try {
        const eventRef = window.database.ref(`${window.DATA_ROOT}/events/byDate/${dateKey}/${eventId}`);
        const snapshot = await eventRef.once('value');
        const eventData = snapshot.val();

        if (!eventData) {
            window.showMessage('業務データが見つかりません', 'error');
            return;
        }

        const currentAssigned = Array.isArray(eventData.assignedCEs) ? eventData.assignedCEs : [];
        const updatedAssigned = currentAssigned.filter(x => 
            (typeof x === 'string' ? x !== ceId : x?.id !== ceId)
        );

        if (updatedAssigned.length !== currentAssigned.length) {
            await eventRef.update({
                assignedCEs: updatedAssigned,
                updatedAt: firebase.database.ServerValue.TIMESTAMP,
                updatedBy: window.currentUserData?.displayName || 'user'
            });

            window.showMessage('CEの配置を解除しました', 'success');
            
            // 画面を再描画
            setTimeout(() => {
                this.loadAndRenderEventsForSelectedDate();
            }, 500);
        }

    } catch (error) {
        console.error('❌ CE配置解除エラー:', error);
        window.showMessage('CE配置解除に失敗しました', 'error');
    }
}

// 業務編集モーダル（統一版）
openEditEventModal(dateKey, eventId, eventData) {
    const modal = document.createElement('div');
    modal.id = 'editEventModal';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="glass-card p-6 max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">業務編集</h3>
                <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="editEventForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-bold mb-2">業務名 *</label>
                    <input type="text" id="editEventName" class="input-unified" value="${eventData.name || ''}" required>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold mb-2">開始時間</label>
                        <input type="time" id="editStartTime" class="input-unified" value="${eventData.startTime || ''}">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2">終了時間</label>
                        <input type="time" id="editEndTime" class="input-unified" value="${eventData.endTime || ''}">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold mb-2">予定件数</label>
                        <input type="number" id="editEventCount" class="input-unified" min="0" max="99" value="${eventData.count || 0}">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2">必要人数</label>
                        <input type="number" id="editRequiredPeople" class="input-unified" min="0" max="20" value="${eventData.requiredPeople || 0}">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-bold mb-2">詳細</label>
                    <textarea id="editDescription" class="input-unified" rows="3">${eventData.description || ''}</textarea>
                </div>
                
                <div class="flex space-x-3">
                    <button type="button" onclick="window.dashboardAuth.deleteEvent('${dateKey}', '${eventId}')" 
                            class="btn-unified btn-outline-unified flex-1 text-red-600 border-red-600">
                        <i class="fas fa-trash mr-2"></i>削除
                    </button>
                    <button type="submit" class="btn-unified btn-primary-unified flex-1">
                        <i class="fas fa-save mr-2"></i>更新
                    </button>
                </div>
            </form>
        </div>
    `;

    document.body.appendChild(modal);

    document.getElementById('editEventForm').onsubmit = (e) => {
        e.preventDefault();
        this.updateEvent(dateKey, eventId, modal);
    };
}

// 業務更新処理
async updateEvent(dateKey, eventId, modal) {
    const name = document.getElementById('editEventName')?.value?.trim();
    const startTime = document.getElementById('editStartTime')?.value;
    const endTime = document.getElementById('editEndTime')?.value;
    const count = parseInt(document.getElementById('editEventCount')?.value) || 0;
    const requiredPeople = parseInt(document.getElementById('editRequiredPeople')?.value) || 0;
    const description = document.getElementById('editDescription')?.value?.trim();

    if (!name) {
        window.showMessage('業務名を入力してください', 'warning');
        return;
    }

    try {
        const updateData = {
            name: name,
            startTime: startTime || null,
            endTime: endTime || null,
            count: count,
            requiredPeople: requiredPeople,
            description: description || null,
            updatedAt: firebase.database.ServerValue.TIMESTAMP,
            updatedBy: window.currentUserData?.displayName || 'unknown'
        };

        await window.database.ref(`${window.DATA_ROOT}/events/byDate/${dateKey}/${eventId}`).update(updateData);
        modal.remove();
        window.showMessage('業務を更新しました', 'success');
        
        // 画面を再描画
        setTimeout(() => {
            this.loadAndRenderEventsForSelectedDate();
        }, 500);

    } catch (error) {
        console.error('業務更新エラー:', error);
        window.showMessage('業務の更新に失敗しました', 'error');
    }
}

// 業務削除処理
async deleteEvent(dateKey, eventId) {
    if (!confirm('この業務を削除しますか？')) return;

    try {
        await window.database.ref(`${window.DATA_ROOT}/events/byDate/${dateKey}/${eventId}`).remove();
        document.getElementById('editEventModal')?.remove();
        window.showMessage('業務を削除しました', 'success');
        
        // 画面を再描画
        setTimeout(() => {
            this.loadAndRenderEventsForSelectedDate();
        }, 500);
    } catch (error) {
        console.error('業務削除エラー:', error);
        window.showMessage('業務の削除に失敗しました', 'error');
    }
}

// 業務追加機能の修正
openQuickAddEvent(department) {
    if (window.userRole === 'viewer') {
        window.showMessage('編集権限がありません', 'warning');
        return;
    }
    
    // EventManagerの初期化確認
    if (!window.eventManager) {
        if (window.EventManager) {
            try { 
                window.eventManager = new window.EventManager(); 
                console.log('✅ EventManager初期化完了');
            } catch (e) { 
                console.error('EventManager初期化失敗:', e);
                window.showMessage('イベント管理システムの初期化に失敗しました', 'error');
                return;
            }
        } else {
            window.showMessage('イベント管理システムが読み込まれていません', 'error');
            return;
        }
    }
    
    // 初期化完了を待ってから実行
    setTimeout(() => {
        if (window.eventManager && typeof window.eventManager.openAddEventModal === 'function') {
            window.eventManager.openAddEventModal(department);
        } else {
            window.showMessage('業務追加機能が利用できません', 'error');
        }
    }, 100);
}

        showDashboard() {
            const loadingEl = document.getElementById('loading');
            const mainEl = document.getElementById('mainInterface');
            if (loadingEl) loadingEl.style.display = 'none';
            if (mainEl) mainEl.style.display = 'block';
            
            this.updateUserDisplay();
            this.setupNavigation();
            this.setupSidebar();
            this.setupDailySchedule();
            this.initializeV2System();
        }

        updateUserDisplay() {
            const userData = window.currentUserData;
            if (!userData) return;
            document.querySelectorAll('#currentUserDisplay').forEach(el => {
                el.textContent = userData.displayName || userData.username || 'ユーザー';
            });
        }

        setupNavigation() {
            const navTabs = [
                { id: 'dailyScheduleTab', content: 'dailyScheduleContent' },
                { id: 'ceManagementTab', content: 'ceManagementContent' },
                { id: 'calendarTab', content: 'calendarContent' },
                { id: 'departmentTimelineTab', content: 'departmentTimelineContent' },
                { id: 'personalTimelineTab', content: 'personalTimelineContent' },
                { id: 'analysisTab', content: 'analysisContent' },
                { id: 'settingsTab', content: 'settingsContent' }
            ];

            navTabs.forEach(tab => {
                const element = document.getElementById(tab.id);
                if (element) {
                    element.onclick = () => {
                        this.showScreen(tab.content, tab.id);
                        if (tab.id === 'ceManagementTab') {
                            setTimeout(() => {
                                if (window.workScheduleViewer) {
                                    window.workScheduleViewer.displayCurrentPeriod();
                                }
                            }, 100);
                        }
                        if (tab.id === 'settingsTab') {
                            setTimeout(() => this.setupAdminSettings(), 100);
                        }
                    };
                }
            });

            const toggleBtn = document.getElementById('toggleSidebar');
            const sidebar = document.getElementById('sidebar');
            if (toggleBtn && sidebar) {
                toggleBtn.onclick = () => sidebar.classList.toggle('expanded');
            }
        }

        showScreen(contentId, tabId) {
            document.querySelectorAll('.screen-content').forEach(screen => {
                screen.style.display = 'none';
            });
            
            const contentEl = document.getElementById(contentId);
            if (contentEl) {
                contentEl.style.display = 'block';
            }
            
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            const tabEl = document.getElementById(tabId);
            if (tabEl) {
                tabEl.classList.add('active');
            }
            
            if (contentId === 'ceManagementContent' && window.workScheduleViewer) {
                setTimeout(() => {
                    window.workScheduleViewer.displayCurrentPeriod();
                }, 100);
            } else if (contentId === 'settingsContent') {
                setTimeout(() => this.setupAdminSettings(), 100);
            }
        }

        setupSidebar() {
            const saveBtn = document.getElementById('templateSaveButton');
            const loadBtn = document.getElementById('templateLoadButton');
            if (saveBtn) saveBtn.onclick = () => window.showMessage('テンプレート保存機能（実装予定）', 'info');
            if (loadBtn) loadBtn.onclick = () => window.showMessage('テンプレート読込機能（実装予定）', 'info');
        }

        setupDailySchedule() {
            const datePicker = document.getElementById('scheduleDatePicker');
            if (datePicker) {
                datePicker.value = this.formatDate(this.selectedDate);
                datePicker.onchange = (e) => {
                    this.selectedDate = new Date(e.target.value + 'T00:00:00');
                    this.renderDailySchedule();
                };
            }

            const prev = document.getElementById('prevDayBtn');
            const next = document.getElementById('nextDayBtn');
            const today = document.getElementById('todayBtn');
            if (prev) prev.onclick = () => { 
                this.selectedDate.setDate(this.selectedDate.getDate() - 1); 
                if (datePicker) datePicker.value = this.formatDate(this.selectedDate); 
                this.renderDailySchedule(); 
            };
            if (next) next.onclick = () => { 
                this.selectedDate.setDate(this.selectedDate.getDate() + 1); 
                if (datePicker) datePicker.value = this.formatDate(this.selectedDate); 
                this.renderDailySchedule(); 
            };
            if (today) today.onclick = () => { 
                this.selectedDate = new Date(); 
                if (datePicker) datePicker.value = this.formatDate(this.selectedDate); 
                this.renderDailySchedule(); 
            };

            // 通常の業務追加ボタン
            const quickBtn = document.getElementById('addEventButtonDaily');
            if (quickBtn) quickBtn.onclick = () => this.openQuickAddEvent();

            // 期間一括業務追加ボタン
            const bulkBtn = document.getElementById('addBulkEventBtn');
            if (bulkBtn) {
                bulkBtn.onclick = () => {
                    if (window.userRole === 'viewer') {
                        window.showMessage('編集権限がありません', 'warning');
                        return;
                    }
                    if (!window.eventManager && window.EventManager) {
                        try { 
                            window.eventManager = new window.EventManager(); 
                        } catch (e) { 
                            console.warn('EventManager初期化失敗:', e); 
                        }
                    }
                    if (!window.eventManager) {
                        window.showMessage('イベント管理の初期化を待機中です', 'info');
                        return;
                    }
                    if (typeof window.eventManager.openBulkAddModal === 'function') {
                        window.eventManager.openBulkAddModal();
                    } else {
                        window.showMessage('期間一括業務追加機能が見つかりません', 'error');
                    }
                };
            }

            // 月次業務追加ボタン
            const monthlyBtn = document.getElementById('addMonthlyTaskBtn');
            if (monthlyBtn) {
                monthlyBtn.onclick = () => {
                    if (window.userRole === 'viewer') {
                        window.showMessage('編集権限がありません', 'warning');
                        return;
                    }
                    if (!window.eventManager && window.EventManager) {
                        try { 
                            window.eventManager = new window.EventManager(); 
                        } catch (e) { 
                            console.warn('EventManager初期化失敗:', e); 
                        }
                    }
                    if (!window.eventManager) {
                        window.showMessage('イベント管理の初期化を待機中です', 'info');
                        return;
                    }
                    if (typeof window.eventManager.openMonthlyTaskModal === 'function') {
                        window.eventManager.openMonthlyTaskModal();
                    } else {
                        window.showMessage('月次業務追加機能が見つかりません', 'error');
                    }
                };
            }

            this.renderDailySchedule();
        }

        renderDailySchedule() {
            const title = document.getElementById('dailyScheduleTitle');
            const grid = document.getElementById('departmentGrid');
            if (title) {
                const dateStr = this.selectedDate.toLocaleDateString('ja-JP', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric', 
                    weekday: 'short' 
                });
                title.textContent = `日別スケジュール（${dateStr}）`;
            }
            if (window.ceManager) {
                window.ceManager.currentDisplayDate = this.selectedDate;
                window.ceManager.displayCEList();
            }
            if (!grid) return;

            grid.innerHTML = '';
            grid.className = 'grid grid-cols-3 gap-4 mb-6';

            if (window.DEPARTMENTS) {
                window.DEPARTMENTS.forEach(dept => {
                    const section = this.createDepartmentSection(dept);
                    grid.appendChild(section);
                });
            }

            this.updateCEListCount();
            
            this.loadAndRenderEventsForSelectedDate();

        }

        createDepartmentSection(dept) {
            const section = document.createElement('div');
            section.className = 'department-section p-4';
            section.style.setProperty('--dept-color', window.DEPARTMENT_COLORS?.[dept] || '#e5e7eb');
            
            section.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-bold text-sm flex items-center">
                        <i class="fas fa-${window.DEPARTMENT_ICONS?.[dept] || 'cog'} mr-2" style="color: ${window.DEPARTMENT_COLORS?.[dept] || '#2563eb'}"></i>
                        <span>${dept}</span>
                    </h3>
                    ${window.userRole !== 'viewer' ? `
                    <button class="btn-unified btn-primary-unified btn-small" onclick="window.dashboardAuth.openQuickAddEvent('${dept}')">
                        <i class="fas fa-plus mr-1"></i>業務追加
                    </button>` : ''}
                </div>
                <div class="task-list min-h-[120px] space-y-2" data-department="${dept}">
                    <!-- 通常業務がここに表示されます -->
                </div>
                <div class="monthly-plans" data-department="${dept}">
                    <!-- 月次業務がここに省スペース表示されます -->
                </div>
            `;

            return section;
        }

        openQuickAddEvent(department) {
            if (window.userRole === 'viewer') {
                window.showMessage('編集権限がありません', 'warning');
                return;
            }
            if (!window.eventManager && window.EventManager) {
                try { 
                    window.eventManager = new window.EventManager(); 
                } catch (e) { 
                    console.warn('EventManager初期化失敗:', e); 
                }
            }
            if (!window.eventManager) {
                window.showMessage('イベント管理の初期化を待機中です', 'info');
                return;
            }
            if (typeof window.eventManager.openAddEventModal === 'function') {
                window.eventManager.openAddEventModal(department);
            } else {
                window.showMessage('業務追加のUIが見つかりません', 'error');
            }
        }

        setupAdminSettings() {
            const settingsContent = document.getElementById('settingsContent');
            if (!settingsContent) return;

            if (window.userRole === 'admin') {
                settingsContent.innerHTML = `
                    <h2 class="text-2xl font-bold mb-6">設定</h2>
                    <div class="glass-card p-6 mb-6">
                        <h3 class="text-lg font-semibold mb-4 text-red-600">
                            <i class="fas fa-shield-alt mr-2"></i>管理者機能
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button onclick="window.open('pages/admin-dashboard.html', '_blank')" class="btn-unified btn-primary-unified">
                                <i class="fas fa-users-cog mr-2"></i>ユーザー管理ダッシュボード
                            </button>
                        </div>
                    </div>
                    <div class="glass-card p-6 mb-6">
                        <h3 class="text-lg font-semibold mb-4">
                            <i class="fas fa-cog mr-2"></i>一般設定
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">表示名</label>
                                <input type="text" id="displayNameSetting" class="input-unified" value="${window.currentUserData?.displayName || ''}">
                            </div>
                            <button id="saveSettingsBtn" class="btn-unified btn-primary-unified">
                                <i class="fas fa-save mr-2"></i>設定保存
                            </button>
                        </div>
                    </div>
                `;
            } else {
                settingsContent.innerHTML = `
                    <h2 class="text-2xl font-bold mb-6">設定</h2>
                    <div class="glass-card p-6 mb-6">
                        <h3 class="text-lg font-semibold mb-4">個人設定</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">表示名</label>
                                <input type="text" id="displayNameSetting" class="input-unified" value="${window.currentUserData?.displayName || ''}">
                            </div>
                            <button id="saveSettingsBtn" class="btn-unified btn-primary-unified">
                                <i class="fas fa-save mr-2"></i>設定保存
                            </button>
                        </div>
                    </div>
                `;
            }
            
            const saveBtn = document.getElementById('saveSettingsBtn');
            if (saveBtn) {
                saveBtn.onclick = async () => {
                    const displayName = document.getElementById('displayNameSetting')?.value.trim();
                    if (!displayName) {
                        window.showMessage('表示名を入力してください', 'warning');
                        return;
                    }
                    try {
                        const targetUID = sessionStorage.getItem('targetUID');
                        await window.database.ref(`${window.DATA_ROOT}/users/${targetUID}`).update({
                            displayName: displayName,
                            lastUpdated: Date.now()
                        });
                        window.currentUserData.displayName = displayName;
                        this.updateUserDisplay();
                        window.showMessage('設定を保存しました', 'success');
                    } catch (error) {
                        console.error('設定保存エラー:', error);
                        window.showMessage('設定の保存に失敗しました', 'error');
                    }
                };
            }
        }

        formatDate(date) {
            return date.toISOString().slice(0, 10);
        }

        updateCEListCount() {
            const el = document.getElementById('ceListCount');
            if (el) {
                const count = window.ceManager?.ceList?.length || 0;
                el.textContent = String(count);
            }
        }

        // V2システム初期化（完全修正版）
        initializeV2System() {
            setTimeout(async () => {
                try {
                    let attempts = 0;
                    while (attempts < 50) {
                        const allReady = (
                            typeof window.CalendarView !== 'undefined' &&
                            typeof window.EventManager !== 'undefined' &&
                            typeof window.CEManager !== 'undefined' &&
                            typeof window.showMessage !== 'undefined' &&
                            typeof window.CEDailyStatusManager !== 'undefined'
                        );
                        if (allReady) break;
                        await new Promise(resolve => setTimeout(resolve, 100));
                        attempts++;
                    }

                    // インスタンス生成（エラー耐性あり）
                    try {
                        if (!window.calendarView && window.CalendarView) {
                            window.calendarView = new window.CalendarView();
                        }
                    } catch (e) { console.warn('CalendarView初期化失敗:', e); }

                    try {
                        if (!window.eventManager && window.EventManager) {
                            window.eventManager = new window.EventManager();
                        }
                    } catch (e) { console.warn('EventManager初期化失敗:', e); }

                    try {
                        if (!window.ceManager && window.CEManager) {
                            window.ceManager = new window.CEManager();
                        }
                    } catch (e) { console.warn('CEManager初期化失敗:', e); }

                    try {
                        if (!window.ceDailyStatus && window.CEDailyStatusManager) {
                            window.ceDailyStatus = new window.CEDailyStatusManager();
                        }
                    } catch (e) { console.warn('CEDailyStatusManager初期化失敗:', e); }

                    try {
                        if (!window.workScheduleViewer) {
                            window.workScheduleViewer = new WorkScheduleViewer();
                        }
                    } catch (e) { console.warn('WorkScheduleViewer初期化失敗:', e); }

                    this.setupRealtimeUpdates();

                    console.log('✅ V2システム初期化完了');
                } catch (error) {
                    console.error('❌ V2システム初期化エラー:', error);
                }
            }, 1500);
        }
    }

    // 初期化
    if (!window.dashboardAuthInitialized) {
        window.dashboardAuthInitialized = true;
        document.addEventListener('DOMContentLoaded', () => {
            window.dashboardAuth = new DashboardAuth();
        });
    }
        // イベント編集機能
window.editEvent = function(dateKey, eventId) {
    if (window.userRole === 'viewer') {
        window.showMessage('編集権限がありません', 'warning');
        return;
    }

    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="glass-card p-6 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">業務編集</h3>
                <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="text-center">
                <i class="fas fa-spinner fa-spin text-2xl text-blue-600 mb-4"></i>
                <p>業務データを読み込み中...</p>
            </div>
        </div>
    `;
    document.body.appendChild(modal);

    // イベントデータを読み込んで編集フォームを表示
    window.database.ref(`${window.DATA_ROOT}/events/byDate/${dateKey}/${eventId}`).once('value')
        .then(snapshot => {
            const eventData = snapshot.val();
            if (!eventData) {
                modal.remove();
                window.showMessage('業務データが見つかりません', 'error');
                return;
            }

            modal.querySelector('.glass-card').innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">業務編集</h3>
                    <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <form id="editEventForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold mb-2">業務名</label>
                        <input type="text" id="editEventName" class="input-unified" value="${eventData.name || ''}" required>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-bold mb-2">開始時間</label>
                            <input type="time" id="editStartTime" class="input-unified" value="${eventData.startTime || ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-2">終了時間</label>
                            <input type="time" id="editEndTime" class="input-unified" value="${eventData.endTime || ''}">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2">詳細</label>
                        <textarea id="editDescription" class="input-unified" rows="3">${eventData.description || ''}</textarea>
                    </div>
                    <div class="flex space-x-3">
                        <button type="button" onclick="window.deleteEvent('${dateKey}', '${eventId}')" 
                                class="btn-unified btn-outline-unified flex-1 text-red-600 border-red-600">
                            <i class="fas fa-trash mr-2"></i>削除
                        </button>
                        <button type="submit" class="btn-unified btn-primary-unified flex-1">
                            <i class="fas fa-save mr-2"></i>更新
                        </button>
                    </div>
                </form>
            `;

            document.getElementById('editEventForm').onsubmit = (e) => {
                e.preventDefault();
                window.updateEvent(dateKey, eventId, modal);
            };
        })
        .catch(error => {
            console.error('イベントデータ読み込みエラー:', error);
            modal.remove();
            window.showMessage('業務データの読み込みに失敗しました', 'error');
        });
};

window.updateEvent = async function(dateKey, eventId, modal) {
    const name = document.getElementById('editEventName').value.trim();
    const startTime = document.getElementById('editStartTime').value;
    const endTime = document.getElementById('editEndTime').value;
    const description = document.getElementById('editDescription').value.trim();

    if (!name) {
        window.showMessage('業務名を入力してください', 'warning');
        return;
    }

    try {
        const updateData = {
            name: name,
            startTime: startTime || null,
            endTime: endTime || null,
            description: description || null,
            updatedAt: firebase.database.ServerValue.TIMESTAMP,
            updatedBy: window.currentUserData?.displayName || 'unknown'
        };

        await window.database.ref(`${window.DATA_ROOT}/events/byDate/${dateKey}/${eventId}`).update(updateData);
        modal.remove();
        window.showMessage('業務を更新しました', 'success');
    } catch (error) {
        console.error('業務更新エラー:', error);
        window.showMessage('業務の更新に失敗しました', 'error');
    }
};

window.deleteEvent = async function(dateKey, eventId) {
    if (!confirm('この業務を削除しますか？')) return;

    try {
        await window.database.ref(`${window.DATA_ROOT}/events/byDate/${dateKey}/${eventId}`).remove();
        document.querySelector('.fixed.inset-0').remove();
        window.showMessage('業務を削除しました', 'success');
    } catch (error) {
        console.error('業務削除エラー:', error);
        window.showMessage('業務の削除に失敗しました', 'error');
    }
};
    </script>
</body>
</html>
