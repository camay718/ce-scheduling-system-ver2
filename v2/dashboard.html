<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JavaScript実行テスト</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 50px; background: #f0f0f0; }
        .test-box { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .warning { color: orange; font-weight: bold; }
        .button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 10px 5px; }
        .log-area { background: #f8f9fa; border: 1px solid #ddd; padding: 15px; margin-top: 20px; border-radius: 5px; font-family: monospace; font-size: 12px; max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="test-box">
        <h1>JavaScript段階実行テスト</h1>
        <div id="status">テスト待機中...</div>
        
        <button class="button" onclick="testStep1()">Step1: 基本ファイル読み込み</button>
        <button class="button" onclick="testStep2()">Step2: Core実行テスト</button>
        <button class="button" onclick="testStep3()">Step3: Main実行テスト</button>
        <button class="button" onclick="clearLog()">ログクリア</button>
        
        <div id="results" style="margin-top: 20px;"></div>
        <div id="log-area" class="log-area"></div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('log-area');
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}]`, message);
        }
        
        function clearLog() {
            document.getElementById('log-area').innerHTML = '';
            document.getElementById('results').innerHTML = '';
            document.getElementById('status').textContent = 'ログクリア完了';
        }
        
        // グローバルエラーハンドラー
        window.onerror = function(msg, url, line, col, error) {
            log(`グローバルエラー: ${msg} at ${url}:${line}`, 'error');
            return false;
        };
        
        window.addEventListener('unhandledrejection', function(event) {
            log(`未処理Promise: ${event.reason}`, 'error');
        });
        
        // Firebase初期化
        if (!firebase.apps.length) {
            const firebaseConfig = {
                apiKey: "AIzaSyC7VLauLy9vkEcBZHrQ3wKJYm_A6DbJHQ8",
                authDomain: "ce-schedule-system.firebaseapp.com",
                databaseURL: "https://ce-schedule-system-default-rtdb.firebaseio.com",
                projectId: "ce-schedule-system",
                storageBucket: "ce-schedule-system.appspot.com",
                messagingSenderId: "461684979105",
                appId: "1:461684979105:web:1234567890abcdef"
            };
            firebase.initializeApp(firebaseConfig);
            log('Firebase初期化完了', 'success');
        }
        
        async function testStep1() {
            log('=== Step1: 基本ファイル読み込みテスト開始 ===');
            document.getElementById('status').innerHTML = '<span class="success">Step1実行中...</span>';
            
            const basicFiles = [
                'js/data/constants.js',
                'js/utils/ui-utils.js', 
                'js/schedule/event-manager.js'
            ];
            
            for (const file of basicFiles) {
                try {
                    log(`${file} 読み込み開始`);
                    await loadScript(file);
                    log(`${file} 読み込み完了`, 'success');
                } catch (error) {
                    log(`${file} 読み込みエラー: ${error.message}`, 'error');
                    return;
                }
            }
            
            // 基本ファイルのクラス・関数確認
            const expectedGlobals = ['HOSPITAL_ID', 'DEPARTMENTS', 'showLoading', 'hideLoading', 'EventManager'];
            const missing = [];
            
            for (const item of expectedGlobals) {
                if (typeof window[item] === 'undefined') {
                    missing.push(item);
                }
            }
            
            if (missing.length > 0) {
                log(`不足要素: ${missing.join(', ')}`, 'warning');
            } else {
                log('全基本要素確認済み', 'success');
            }
            
            document.getElementById('status').innerHTML = '<span class="success">Step1完了</span>';
            log('=== Step1完了 ===', 'success');
        }
        
        async function testStep2() {
            log('=== Step2: Core実行テスト開始 ===');
            document.getElementById('status').innerHTML = '<span class="success">Step2実行中...</span>';
            
            try {
                log('dashboard-core.js 読み込み開始');
                await loadScript('js/dashboard-core.js');
                log('dashboard-core.js 読み込み完了', 'success');
                
                // Coreクラス確認
                const coreClasses = ['DashboardAuth', 'WorkScheduleViewer', 'PublishedScheduleResolver', 'ActivityLogger'];
                const missingClasses = [];
                
                for (const className of coreClasses) {
                    if (typeof window[className] === 'undefined') {
                        missingClasses.push(className);
                    } else {
                        log(`${className} クラス確認済み`, 'success');
                    }
                }
                
                if (missingClasses.length > 0) {
                    log(`不足Coreクラス: ${missingClasses.join(', ')}`, 'error');
                } else {
                    log('全Coreクラス確認済み', 'success');
                    
                    // DashboardAuth インスタンス作成テスト
                    try {
                        const testAuth = new DashboardAuth();
                        log('DashboardAuth インスタンス作成成功', 'success');
                    } catch (error) {
                        log(`DashboardAuth インスタンス作成エラー: ${error.message}`, 'error');
                    }
                }
                
            } catch (error) {
                log(`dashboard-core.js エラー: ${error.message}`, 'error');
            }
            
            document.getElementById('status').innerHTML = '<span class="success">Step2完了</span>';
            log('=== Step2完了 ===', 'success');
        }
        
        async function testStep3() {
            log('=== Step3: Main実行テスト開始 ===');
            document.getElementById('status').innerHTML = '<span class="success">Step3実行中...</span>';
            
            try {
                log('dashboard-main.js 読み込み開始');
                await loadScript('js/dashboard-main.js');
                log('dashboard-main.js 読み込み完了', 'success');
                
                // Main実行後の状態確認
                setTimeout(() => {
                    log('Main実行後状態確認');
                    
                    // DOMエレメント確認
                    const loginContainer = document.getElementById('login-container');
                    const dashboardContainer = document.getElementById('dashboard-container');
                    
                    if (loginContainer) {
                        log('login-container 要素が見つかりました', 'success');
                    } else {
                        log('login-container 要素が見つかりません', 'warning');
                    }
                    
                    if (dashboardContainer) {
                        log('dashboard-container 要素が見つかりました', 'success');
                    } else {
                        log('dashboard-container 要素が見つかりません', 'warning');
                    }
                    
                    log('=== Step3完了 ===', 'success');
                }, 1000);
                
            } catch (error) {
                log(`dashboard-main.js エラー: ${error.message}`, 'error');
            }
            
            document.getElementById('status').innerHTML = '<span class="success">Step3完了</span>';
        }
        
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = () => reject(new Error(`スクリプト読み込み失敗: ${src}`));
                document.head.appendChild(script);
            });
        }
        
        // 初期化
        window.addEventListener('load', function() {
            log('JavaScript実行テストページ準備完了');
        });
    </script>
</body>
</html>
