<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  V2 - ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- çµ±ä¸€ãƒ†ãƒ¼ãƒ -->
    <link rel="stylesheet" href="css/theme-unified.css">
    
    <!-- æœˆæ¬¡æ¥­å‹™å°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« -->
    <style>
    /* æœˆæ¬¡æ¥­å‹™ï¼ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰å¼·åŒ–ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰ */
    .monthly-task-badge {
        position: absolute;
        top: -4px;
        right: 4px;
        background: #f97316;
        color: white;
        font-size: 8px;
        padding: 1px 4px;
        border-radius: 3px;
        font-weight: bold;
    }

    .assignment-dropzone {
        min-height: 20px;
        padding: 4px;
        margin-top: 4px;
    }

    .assignment-dropzone.drag-over {
        background: #fef3c7 !important;
        border-color: #f59e0b !important;
    }

    .btn-small {
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 3px;
        border: none;
        cursor: pointer;
    }

    .monthly-event-item {
        font-size: 11px;
        line-height: 1.2;
    }
    </style>

    <!-- Firebase SDKï¼ˆé‡è¤‡å‰Šé™¤æ¸ˆã¿ï¼‰ -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <!-- Firebaseè¨­å®š -->
    <script src="js/config/firebase-config.js?v=20241213"></script>
</head>
<body class="theme-unified">
    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ -->
    <div id="loading">
        <div class="spinner"></div>
        <p class="text-gray-600">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ -->
    <div id="mainInterface" style="display:none;">
        <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
        <div id="sidebar" class="sidebar p-4">
            <div class="mb-3 flex justify-between items-center">
                <button id="toggleSidebar" class="p-2 rounded-lg hover:bg-gray-200" title="ã‚µã‚¤ãƒ‰ãƒãƒ¼è¡¨ç¤º/éè¡¨ç¤º">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="text-xs text-gray-600 sidebar-text">
                    <span id="currentUserDisplay">ãƒ¦ãƒ¼ã‚¶ãƒ¼</span>
                </div>
            </div>

            <div class="mb-3">
                <div id="mainSyncStatus" class="sync-indicator connected">
                    <div class="sync-dot pulse"></div>
                    <span class="sidebar-text">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸä¸­</span>
                </div>
            </div>

            <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <nav class="space-y-2 mb-6">
                <button id="dailyScheduleTab" class="nav-tab w-full text-left p-3 rounded-lg hover:bg-green-100 font-medium active">
                    <i class="fas fa-calendar-day mr-2"></i><span class="sidebar-text">æ—¥åˆ¥ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</span>
                </button>
                <button id="ceManagementTab" class="nav-tab w-full text-left p-3 rounded-lg hover:bg-green-100 font-medium">
                    <i class="fas fa-table mr-2"></i><span class="sidebar-text">CEå‹¤å‹™åŒºåˆ†è¡¨</span>
                </button>
                <button id="calendarTab" class="nav-tab w-full text-left p-3 rounded-lg hover:bg-green-100 font-medium">
                    <i class="fas fa-calendar-week mr-2"></i><span class="sidebar-text">é€±é–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</span>
                </button>
                <button id="departmentTimelineTab" class="nav-tab w-full text-left p-3 rounded-lg hover:bg-green-100 font-medium">
                    <i class="fas fa-chart-gantt mr-2"></i><span class="sidebar-text">æ¥­å‹™åˆ¥ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</span>
                </button>
                <button id="personalTimelineTab" class="nav-tab w-full text-left p-3 rounded-lg hover:bg-green-100 font-medium">
                    <i class="fas fa-chart-line mr-2"></i><span class="sidebar-text">å€‹äººåˆ¥ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</span>
                </button>
                <button id="analysisTab" class="nav-tab w-full text-left p-3 rounded-lg hover:bg-green-100 font-medium">
                    <i class="fas fa-chart-bar mr-2"></i><span class="sidebar-text">é›†è¨ˆãƒ»åˆ†æ</span>
                </button>
                <button id="settingsTab" class="nav-tab w-full text-left p-3 rounded-lg hover:bg-green-100 font-medium">
                    <i class="fas fa-cog mr-2"></i><span class="sidebar-text">è¨­å®š</span>
                </button>
            </nav>

            <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆç¸¦é…ç½®ç‰ˆï¼‰ -->
            <div class="sidebar-text mb-4">
                <h3 class="text-sm font-medium text-gray-700 mb-2">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</h3>
                <div class="flex flex-col space-y-2">
                    <button id="templateSaveButton" class="w-full p-2 bg-green-500 text-white rounded-lg text-sm hover:bg-green-600">
                        <i class="fas fa-save mr-1"></i>ä¿å­˜
                    </button>
                    <button id="templateLoadButton" class="w-full p-2 bg-blue-500 text-white rounded-lg text-sm hover:bg-blue-600">
                        <i class="fas fa-folder-open mr-1"></i>èª­è¾¼
                    </button>
                </div>
            </div>

            <!-- è‡ªå‹•åŒæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
            <div class="mt-6 p-2 bg-yellow-50 rounded-lg sidebar-text">
                <h4 class="text-xs font-bold text-yellow-700 mb-1">è‡ªå‹•åŒæœŸ</h4>
                <div class="text-xs text-gray-600">
                    <div class="flex items-center">
                        <div class="w-2 h-2 bg-green-500 rounded-full mr-1 animate-pulse"></div>
                        <span id="syncStatusText">åŒæœŸä¸­</span>
                    </div>
                    <div id="lastSyncTime" class="text-xs">æœ€çµ‚: --:--</div>
                </div>
            </div>
            
            <!-- ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ -->
            <div class="mt-auto pt-4 border-t border-gray-200 sidebar-text">
                <button id="logoutButton" onclick="window.handleLogout()" 
                        class="w-full bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 text-sm font-medium transition-colors">
                    <i class="fas fa-sign-out-alt mr-2"></i>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                </button>
            </div>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div class="main-content p-4">
            <!-- æ—¥åˆ¥ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« -->
            <div id="dailyScheduleContent" class="screen-content">
                <div class="mb-4 flex justify-between items-center">
                    <h2 id="dailyScheduleTitle" class="text-2xl font-bold">æ—¥åˆ¥ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h2>
                    <div class="flex items-center gap-3">
                        <button id="prevDayBtn" class="btn-unified btn-outline-unified">
                            <i class="fas fa-chevron-left mr-1"></i>å‰æ—¥
                        </button>
                        <input type="date" id="scheduleDatePicker" class="input-unified" style="width: auto;">
                        <button id="nextDayBtn" class="btn-unified btn-outline-unified">
                            ç¿Œæ—¥<i class="fas fa-chevron-right ml-1"></i>
                        </button>
                        <button id="todayBtn" class="btn-unified btn-primary-unified">
                            <i class="fas fa-calendar-day mr-1"></i>ä»Šæ—¥
                        </button>
                        <button id="addEventButtonDaily" class="btn-unified btn-primary-unified">
                            <i class="fas fa-plus mr-2"></i>æ¥­å‹™è¿½åŠ 
                        </button>
                    </div>
                </div>

                <div class="mb-4 flex gap-3">
                    <button id="addBulkEventBtn" class="btn-unified btn-primary-unified">
                        <i class="fas fa-calendar-plus mr-1"></i>æœŸé–“ä¸€æ‹¬æ¥­å‹™è¿½åŠ 
                    </button>
                    <button id="addMonthlyTaskBtn" class="btn-unified btn-primary-unified">
                        <i class="fas fa-calendar-alt mr-1"></i>æœˆæ¬¡æ¥­å‹™è¿½åŠ 
                    </button>
                </div>
                
                <div id="departmentGrid" class="grid grid-cols-3 gap-4 mb-6"></div>
                
                <div class="glass-card p-4">
                    <h3 class="font-bold mb-3"><i class="fas fa-users mr-2"></i>CEãƒªã‚¹ãƒˆï¼ˆ<span id="ceListCount">--</span>åï¼‰</h3>
                    <div id="ceListContainer" class="ce-grid"></div>
                </div>
            </div>

            <!-- CEå‹¤å‹™åŒºåˆ†è¡¨ï¼ˆè¡¨ç¤ºå°‚ç”¨ãƒ»æ”¹å–„ç‰ˆï¼‰ -->
            <div id="ceManagementContent" class="screen-content" style="display:none; position: relative;">
                <!-- å‹¤å‹™æ™‚é–“å¸¯èª¬æ˜ï¼ˆå³ä¸Šæ¥µå°é…ç½®ï¼‰ -->
         <div class="work-time-compact" style="position: absolute; top: 15px; right: 15px; background: rgba(248, 249, 250, 0.95); border: 1px dashed #e0e0e0; border-radius: 4px; padding: 4px 6px; font-size: 8px; z-index: 100; max-width: 300px; line-height: 1.2; white-space: nowrap;">
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr>
                <th style="padding: 2px 4px; font-size: 8px; background: #f2f5f7; font-weight: 600; text-align: left;">åŒºåˆ†</th>
                <th style="padding: 2px 4px; font-size: 8px; background: #f2f5f7; font-weight: 600; text-align: left;">å‹¤å‹™æ™‚é–“</th>
                <th style="padding: 2px 4px; font-size: 8px; background: #f2f5f7; font-weight: 600; text-align: left;">ä¼‘æ†©æ™‚é–“</th>
            </tr>
        </thead>
        <tbody>
            <tr><td style="padding: 2px 4px; font-size: 8px;">A</td><td style="padding: 2px 4px; font-size: 8px;">8:00ã€œ16:30</td><td style="padding: 2px 4px; font-size: 8px;">11:45ï½12:30</td></tr>
            <tr><td style="padding: 2px 4px; font-size: 8px;">A1</td><td style="padding: 2px 4px; font-size: 8px;">7:00ã€œ15:30</td><td style="padding: 2px 4px; font-size: 8px;">11:45ï½12:30</td></tr>
            <tr><td style="padding: 2px 4px; font-size: 8px;">B</td><td style="padding: 2px 4px; font-size: 8px;">8:00ã€œç¿Œ8:00ï¼ˆ0:00ï½6:30å®¿ç›´ç›¸å½“å‹¤å‹™ï¼‰</td><td style="padding: 2px 4px; font-size: 8px;">11:45ï½12:45åŠã³16:45ï½17:45</td></tr>
            <tr><td style="padding: 2px 4px; font-size: 8px;">Ã—</td><td style="padding: 2px 4px; font-size: 8px;">ä¼‘æ—¥</td><td style="padding: 2px 4px; font-size: 8px;">-</td></tr>
        </tbody>
    </table>
</div>

                <div class="schedule-display-container">
                    <div class="period-navigation">
                        <button id="prevPeriodBtn" class="btn-unified btn-outline-unified">
                            <i class="fas fa-chevron-left mr-1"></i>å‰ã®æœŸé–“
                        </button>
                        <div class="period-display">
                            <div id="currentPeriodDisplay" class="text-lg font-bold">æœŸé–“ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                            <div class="text-sm text-gray-500">28æ—¥é–“ã®å‹¤å‹™è¡¨</div>
                        </div>
                        <button id="nextPeriodBtn" class="btn-unified btn-outline-unified">
                            æ¬¡ã®æœŸé–“<i class="fas fa-chevron-right ml-1"></i>
                        </button>
                    </div>
                    
                    <div class="text-center mb-4">
                        <button id="openScheduleEditorBtn" class="btn-unified btn-primary-unified">
                            <i class="fas fa-edit mr-2"></i>å‹¤å‹™è¡¨ã‚’ä½œæˆãƒ»ç·¨é›†
                        </button>
                    </div>

                    <!-- å‹¤å‹™åŒºåˆ†è¡¨è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                    <div id="workScheduleDisplayArea" class="text-center py-8 text-gray-500">
                        <i class="fas fa-table text-4xl mb-4"></i>
                        <h3 class="text-lg font-semibold mb-2">å‹¤å‹™åŒºåˆ†è¡¨</h3>
                        <p class="mb-4">ä½œæˆæ¸ˆã¿ã®å‹¤å‹™è¡¨ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
                        <button onclick="document.getElementById('openScheduleEditorBtn').click()" 
                                class="btn-unified btn-primary-unified">
                            <i class="fas fa-plus mr-2"></i>æœ€åˆã®å‹¤å‹™è¡¨ã‚’ä½œæˆ
                        </button>
                    </div>
                </div>
            </div>

            <!-- ãã®ä»–ã®ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <div id="calendarContent" class="screen-content" style="display:none;">
                <h2 class="text-2xl font-bold mb-4">é€±é–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h2>
                <p class="text-gray-600">é€±é–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ©Ÿèƒ½ï¼ˆé–‹ç™ºäºˆå®šï¼‰</p>
            </div>

            <div id="departmentTimelineContent" class="screen-content" style="display:none;">
                <h2 class="text-2xl font-bold mb-4">æ¥­å‹™åˆ¥ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</h2>
                <p class="text-gray-600">æ¥­å‹™åˆ¥ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³æ©Ÿèƒ½ï¼ˆé–‹ç™ºäºˆå®šï¼‰</p>
            </div>

            <div id="personalTimelineContent" class="screen-content" style="display:none;">
                <h2 class="text-2xl font-bold mb-4">å€‹äººåˆ¥ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</h2>
                <p class="text-gray-600">å€‹äººåˆ¥ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³æ©Ÿèƒ½ï¼ˆé–‹ç™ºäºˆå®šï¼‰</p>
            </div>

            <div id="analysisContent" class="screen-content" style="display:none;">
                <h2 class="text-2xl font-bold mb-4">é›†è¨ˆãƒ»åˆ†æ</h2>
                <p class="text-gray-600">é›†è¨ˆãƒ»åˆ†ææ©Ÿèƒ½ï¼ˆé–‹ç™ºäºˆå®šï¼‰</p>
            </div>

            <div id="settingsContent" class="screen-content" style="display:none;">
                <!-- è¨­å®šã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯å‹•çš„ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- JavaScriptèª­ã¿è¾¼ã¿ï¼ˆé †æ¬¡åŒæœŸèª­ã¿è¾¼ã¿ï¼‰ -->
    <script src="js/data/constants.js?v=20241213"></script>
    <script src="js/utils/ui-utils.js?v=20241213"></script>
    <script src="js/utils/date-utils.js?v=20241213"></script>
    <script src="js/schedule/schedule-core.js?v=20241213"></script>
    <script src="js/schedule/calendar-view.js?v=20241213"></script>
    <script src="js/schedule/event-manager.js?v=20241213"></script>
    <script src="js/ui/ce-manager.js?v=20241213"></script>
    <script src="js/ui/ce-daily-status.js?v=20241213"></script>

    <!-- Dashboardå°‚ç”¨JavaScriptï¼ˆå®Œå…¨ä¿®æ­£ç‰ˆï¼‰ -->
    <script>
    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆï¼ˆç›£æŸ»ãƒ­ã‚°ä»˜ãï¼‰
    window.handleLogout = async () => {
        try {
            try {
                const entry = {
                    action: 'logout',
                    details: {},
                    uid: window.currentUserData?.uid || null,
                    username: window.currentUserData?.username || 'unknown',
                    displayName: window.currentUserData?.displayName || 'unknown',
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    userAgent: navigator.userAgent.substring(0, 100)
                };
                await window.database.ref(`${window.DATA_ROOT}/auditLogs`).push(entry);
            } catch (logError) {
                console.warn('ç›£æŸ»ãƒ­ã‚°è¨˜éŒ²å¤±æ•—:', logError);
            }
            if (window.auth && window.auth.currentUser) {
                await window.auth.signOut();
            }
        } catch (error) {
            console.error('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', error);
        } finally {
            sessionStorage.clear();
            localStorage.clear();
            window.location.href = 'index.html';
        }
    };

// WorkScheduleViewerã‚¯ãƒ©ã‚¹ã®å®Œå…¨æ”¹è‰¯ç‰ˆ
class WorkScheduleViewer {
    constructor() {
        this.currentPeriodIndex = 0;
        this.availablePeriods = [];
        this.realtimeListener = null;
        this.init();
    }

    async init() {
        try {
            await window.waitForFirebase();
            this.setupRealtimeListener();
            this.setupEventListeners();
            console.log('âœ… å‹¤å‹™åŒºåˆ†è¡¨ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼åˆæœŸåŒ–å®Œäº†');
        } catch (error) {
            console.error('âŒ å‹¤å‹™åŒºåˆ†è¡¨ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
        }
    }

    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
    setupRealtimeListener() {
        if (this.realtimeListener) {
            this.realtimeListener.off();
        }
        
        this.realtimeListener = window.database.ref(`${window.DATA_ROOT}/workSchedules`);
        this.realtimeListener.on('value', async (snapshot) => {
            console.log('ğŸ”„ å…¬é–‹å‹¤å‹™è¡¨ãƒ‡ãƒ¼ã‚¿æ›´æ–°æ¤œçŸ¥');
            await this.loadAvailablePeriods();
            this.displayCurrentPeriod();
        });
    }

    async loadAvailablePeriods() {
        try {
            const snapshot = await window.database.ref(`${window.DATA_ROOT}/workSchedules`).once('value');
            const data = snapshot.val() || {};
            
            this.availablePeriods = Object.keys(data)
                .map(periodKey => ({
                    key: periodKey,
                    ...data[periodKey].metadata
                }))
                .filter(period => {
                    // ç®¡ç†è€…ã¯å…¨ã¦è¡¨ç¤ºã€ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è¡¨ç¤ºå¯èƒ½ãªã‚‚ã®ã®ã¿
                    return window.userRole === 'admin' || (period.isVisible !== false);
                })
                .sort((a, b) => (b.publishedAt || b.createdAt || 0) - (a.publishedAt || a.createdAt || 0));
            
            if (this.availablePeriods.length > 0) {
                // ç¾åœ¨ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒç¯„å›²å¤–ã®å ´åˆã¯èª¿æ•´
                if (this.currentPeriodIndex >= this.availablePeriods.length) {
                    this.currentPeriodIndex = 0;
                }
                this.displayCurrentPeriod();
            } else {
                this.displayNoPeriods();
            }
        } catch (error) {
            console.error('âŒ æœŸé–“ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        }
    }

    setupEventListeners() {
        const prevBtn = document.getElementById('prevPeriodBtn');
        const nextBtn = document.getElementById('nextPeriodBtn');
        const editorBtn = document.getElementById('openScheduleEditorBtn');

        if (prevBtn) prevBtn.onclick = () => this.navigatePeriod(-1);
        if (nextBtn) nextBtn.onclick = () => this.navigatePeriod(1);
        if (editorBtn) editorBtn.onclick = () => this.openScheduleEditor();
    }

    async displayCurrentPeriod() {
        const displayEl = document.getElementById('currentPeriodDisplay');
        const areaEl = document.getElementById('workScheduleDisplayArea');
        
        if (this.availablePeriods.length === 0) {
            this.displayNoPeriods();
            return;
        }

        const currentPeriod = this.availablePeriods[this.currentPeriodIndex];
        if (displayEl) {
            const visibilityStatus = currentPeriod.isVisible === false ? ' (éå…¬é–‹)' : '';
            displayEl.innerHTML = `
                <div>${currentPeriod.startDate} ï½ ${currentPeriod.endDate}${visibilityStatus}</div>
                <div class="text-sm text-gray-500">
                    (${this.currentPeriodIndex + 1}/${this.availablePeriods.length})
                    ${window.userRole === 'admin' ? this.renderAdminControls(currentPeriod) : ''}
                </div>
            `;
        }

        await this.renderWorkScheduleTable(currentPeriod.key);
    }

    renderAdminControls(period) {
        return `
            <div class="inline-flex gap-2 ml-4">
                <button onclick="window.workScheduleViewer.toggleVisibility('${period.key}')" 
                        class="btn-small ${period.isVisible === false ? 'bg-green-500' : 'bg-yellow-500'} text-white" 
                        title="è¡¨ç¤º/éè¡¨ç¤ºåˆ‡æ›¿">
                    <i class="fas fa-eye${period.isVisible === false ? '' : '-slash'}"></i>
                </button>
                <button onclick="window.workScheduleViewer.deleteSchedule('${period.key}')" 
                        class="btn-small bg-red-500 text-white" title="å‰Šé™¤">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
    }

    displayNoPeriods() {
        const displayEl = document.getElementById('currentPeriodDisplay');
        const areaEl = document.getElementById('workScheduleDisplayArea');
        
        if (displayEl) displayEl.textContent = 'ä½œæˆæ¸ˆã¿ã®æœŸé–“ãªã—';
        if (areaEl) {
            areaEl.innerHTML = `
                <div class="text-center py-12">
                    <i class="fas fa-calendar-plus text-4xl text-gray-400 mb-4"></i>
                    <h3 class="text-lg font-semibold text-gray-600 mb-2">å‹¤å‹™åŒºåˆ†è¡¨</h3>
                    <p class="text-gray-500 mb-4">ã¾ã å‹¤å‹™è¡¨ãŒä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
                    <button onclick="document.getElementById('openScheduleEditorBtn').click()" 
                            class="btn-unified btn-primary-unified">
                        <i class="fas fa-plus mr-2"></i>æœ€åˆã®å‹¤å‹™è¡¨ã‚’ä½œæˆ
                    </button>
                </div>
            `;
        }
    }

    async renderWorkScheduleTable(periodKey) {
        const areaEl = document.getElementById('workScheduleDisplayArea');
        if (!areaEl) return;

        try {
            const snapshot = await window.database.ref(`${window.DATA_ROOT}/workSchedules/${periodKey}`).once('value');
            const periodData = snapshot.val();
            
            if (!periodData || !periodData.ceList) {
                areaEl.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-exclamation-triangle text-4xl text-yellow-500 mb-4"></i>
                        <p class="text-gray-600">å‹¤å‹™è¡¨ãƒ‡ãƒ¼ã‚¿ã¾ãŸã¯CEãƒªã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>
                    </div>
                `;
                return;
            }

            const scheduleData = periodData.scheduleData || {};
            const ceList = periodData.ceList;
            const workTypeOverrides = periodData.workTypeOverrides || {};
            const metadata = periodData.metadata || {};
            const dates = this.generateDateRange(new Date(metadata.startDate), new Date(metadata.endDate));

            areaEl.innerHTML = `
                <div class="work-schedule-table-wrapper">
                    <table class="work-schedule-table">
                        ${this.generateTableHTML(dates, scheduleData, ceList, workTypeOverrides)}
                    </table>
                </div>
            `;

        } catch (error) {
            console.error('âŒ å‹¤å‹™è¡¨è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
            areaEl.innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                    <p class="text-gray-600">å‹¤å‹™è¡¨ã®èª­ã¿è¾¼ã¿ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>
                </div>
            `;
        }
    }

    // å®ŸåŠ¹å‹¤å‹™åŒºåˆ†å–å¾—ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰é©ç”¨ï¼‰
    getEffectiveWorkType(ceId, dateKey, ceList, workTypeOverrides) {
        const ce = ceList.find(c => c.id === ceId);
        if (!ce) return 'ME';

        const overrides = workTypeOverrides[ceId];
        if (Array.isArray(overrides)) {
            const validOverrides = overrides.filter(override => 
                dateKey >= override.startDate && dateKey <= override.endDate
            );
            if (validOverrides.length > 0) {
                const latest = validOverrides.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0))[0];
                return latest.workType;
            }
        } else if (overrides && overrides.startDate && dateKey >= overrides.startDate && dateKey <= overrides.endDate) {
            return overrides.workType;
        }
        
        return ce.workType || 'ME';
    }

    generateTableHTML(dates, scheduleData, ceList, workTypeOverrides) {
        let html = '<thead><tr><th class="name-header">æ°å</th>';
        
        // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
        dates.forEach(date => {
            const dayOfWeek = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][date.getDay()];
            const isWeekend = date.getDay() === 0 || date.getDay() === 6;
            const headerClass = isWeekend ? 'date-header weekend-header' : 'date-header';
            
            html += `
                <th class="${headerClass}">
                    <div>${date.getDate()}</div>
                    <div class="text-xs">${dayOfWeek}</div>
                </th>
            `;
        });
        
        const summaryHeaders = ['A', 'A1', 'B', 'é', 'Ã—', 'å¹´', 'å‡º', 'ç ”', 'ä¼‘æ—¥æ•°', 'å®Ÿå‹¤å‹™', 'å½“ç›´å›æ•°'];
        summaryHeaders.forEach(header => {
            html += `<th class="summary-header">${header}</th>`;
        });
        html += '</tr></thead>';
        
        // ãƒœãƒ‡ã‚£è¡Œ
        html += '<tbody>';
        ceList.forEach(ce => {
            const fullName = ce.fullName || ce.name || '';
            html += `<tr><td class="name-cell">
                <div class="font-medium">${fullName}</div>
                <div class="text-xs text-gray-500">${ce.workType}</div>
            </td>`;
            
            const summary = { A: 0, A1: 0, B: 0, non: 0, off: 0, year: 0, trip: 0, training: 0, holidays: 0, actual: 0, night: 0 };
            
            dates.forEach(date => {
                const dateKey = this.formatDate(date);
                const workData = scheduleData[ce.id]?.[dateKey] || {};
                const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                const status = workData.customText?.trim() || workData.status || (isWeekend ? 'Ã—' : 'A');
                const desired = workData.desired || false;
                
                // å®ŸåŠ¹å‹¤å‹™åŒºåˆ†ã‚’å–å¾—ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰åæ˜ ï¼‰
                const effectiveWorkType = this.getEffectiveWorkType(ce.id, dateKey, ceList, workTypeOverrides);
                
                if (isWeekend) summary.holidays++;
                switch (workData.status || (isWeekend ? 'Ã—' : 'A')) {
                    case 'A': summary.A++; summary.actual++; break;
                    case 'A1': summary.A1++; summary.actual++; break;
                    case 'B': summary.B++; summary.actual++; summary.night++; break;
                    case 'é': summary.non++; summary.actual++; break;
                    case 'Ã—': summary.off++; break;
                    case 'å¹´': summary.year++; summary.actual++; break;
                    case 'å‡º': summary.trip++; summary.actual++; break;
                    case 'ç ”': summary.training++; summary.actual++; break;
                }
                
                let cellClass = `work-cell type-${effectiveWorkType.toLowerCase()}`;
                if (workData.status) cellClass += ` status-${workData.status}`;
                if (desired) cellClass += ' desired';
                if (isWeekend) cellClass += ' holiday';
                
                html += `<td class="${cellClass}">${status}</td>`;
            });
            
            const summaryValues = [summary.A, summary.A1, summary.B, summary.non, summary.off, summary.year, summary.trip, summary.training, summary.holidays, summary.actual, summary.night];
            summaryValues.forEach(value => {
                html += `<td class="summary-cell">${value}</td>`;
            });
            
            html += '</tr>';
        });
        html += '</tbody>';

        // ãƒ•ãƒƒã‚¿ãƒ¼ï¼ˆé›†è¨ˆè¡Œï¼‰
        html += '<tfoot>';
        const footerTypes = [
            { label: 'OPE(A)', filter: (effectiveType, status) => effectiveType === 'OPE' && status === 'A' },
            { label: 'OPE(A1)', filter: (effectiveType, status) => effectiveType === 'OPE' && status === 'A1' },
            { label: 'ME', filter: (effectiveType, status) => effectiveType === 'ME' && ['A', 'A1', 'B', 'é', 'å¹´', 'å‡º', 'ç ”'].includes(status) },
            { label: 'HD', filter: (effectiveType, status) => effectiveType === 'HD' && ['A', 'A1', 'B', 'é', 'å¹´', 'å‡º', 'ç ”'].includes(status) },
            { label: 'FLEX', filter: (effectiveType, status) => effectiveType === 'FLEX' && ['A', 'A1', 'B', 'é', 'å¹´', 'å‡º', 'ç ”'].includes(status) },
            { label: 'å½“ç›´', filter: (effectiveType, status) => status === 'B', target: 1 },
            { label: 'éç•ª', filter: (effectiveType, status) => status === 'é', target: 1 }
        ];

        footerTypes.forEach(type => {
            html += `<tr class="footer-summary-row"><th class="type-label">${type.label}</th>`;
            
            dates.forEach(date => {
                const dateKey = this.formatDate(date);
                let count = 0;
                ceList.forEach(ce => {
                    const workData = scheduleData[ce.id]?.[dateKey] || {};
                    const status = workData.status || (date.getDay() === 0 || date.getDay() === 6 ? 'Ã—' : 'A');
                    const effectiveType = this.getEffectiveWorkType(ce.id, dateKey, ceList, workTypeOverrides);
                    
                    if (type.filter(effectiveType, status)) {
                        count++;
                    }
                });
                
                const cellClass = type.target && count !== type.target ? 'warning-count' : '';
                html += `<td class="${cellClass}">${count}</td>`;
            });
            
            for (let i = 0; i < summaryHeaders.length; i++) {
                html += '<td></td>';
            }
            html += '</tr>';
        });
        
        html += '</tfoot>';
        return html;
    }

    // ç®¡ç†è€…æ©Ÿèƒ½ï¼šè¡¨ç¤º/éè¡¨ç¤ºåˆ‡æ›¿
    async toggleVisibility(periodKey) {
        if (window.userRole !== 'admin') {
            window.showMessage('ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™', 'warning');
            return;
        }

        try {
            const snapshot = await window.database.ref(`${window.DATA_ROOT}/workSchedules/${periodKey}/metadata`).once('value');
            const metadata = snapshot.val();
            
            const newVisibility = !(metadata?.isVisible !== false);
            await window.database.ref(`${window.DATA_ROOT}/workSchedules/${periodKey}/metadata/isVisible`).set(newVisibility);
            
            window.showMessage(`å‹¤å‹™è¡¨ã‚’${newVisibility ? 'è¡¨ç¤º' : 'éè¡¨ç¤º'}ã«è¨­å®šã—ã¾ã—ãŸ`, 'success');
            
        } catch (error) {
            console.error('âŒ è¡¨ç¤ºåˆ‡æ›¿ã‚¨ãƒ©ãƒ¼:', error);
            window.showMessage('è¡¨ç¤ºè¨­å®šã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        }
    }

    // ç®¡ç†è€…æ©Ÿèƒ½ï¼šå‹¤å‹™è¡¨å‰Šé™¤
    async deleteSchedule(periodKey) {
        if (window.userRole !== 'admin') {
            window.showMessage('ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™', 'warning');
            return;
        }

        const period = this.availablePeriods.find(p => p.key === periodKey);
        if (!period) return;

        if (!confirm(`å‹¤å‹™è¡¨ã€Œ${period.startDate} ï½ ${period.endDate}ã€ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚`)) {
            return;
        }

        try {
            await window.database.ref(`${window.DATA_ROOT}/workSchedules/${periodKey}`).remove();
            window.showMessage('å‹¤å‹™è¡¨ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
            
        } catch (error) {
            console.error('âŒ å‹¤å‹™è¡¨å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
            window.showMessage('å‹¤å‹™è¡¨ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        }
    }

    generateDateRange(startDate, endDate) {
        const dates = [];
        const current = new Date(startDate);
        
        while (current <= endDate) {
            dates.push(new Date(current));
            current.setDate(current.getDate() + 1);
        }
        
        return dates;
    }

    formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    openScheduleEditor() {
        if (window.userRole === 'viewer') {
            window.showMessage('ç·¨é›†æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“', 'warning');
            return;
        }
        
        const targetUID = sessionStorage.getItem('targetUID');
        const currentUsername = sessionStorage.getItem('currentUsername');
        
        if (!targetUID || !currentUsername) {
            window.showMessage('ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚', 'error');
            return;
        }
        
        const params = new URLSearchParams({
            uid: targetUID,
            username: currentUsername,
            role: window.userRole,
            timestamp: Date.now()
        });
        
        const url = `pages/work-schedule-editor.html?${params.toString()}`;
        
        const win = window.open(url, 'workScheduleEditor', 'width=1400,height=900,scrollbars=yes,resizable=yes');
        
        if (!win || win.closed || typeof win.closed === 'undefined') {
            if (confirm('æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸã€‚åŒã˜ã‚¿ãƒ–ã§å‹¤å‹™è¡¨ã‚¨ãƒ‡ã‚£ã‚¿ã‚’é–‹ãã¾ã™ã‹ï¼Ÿ')) {
                window.location.href = url;
            } else {
                window.showMessage('å‹¤å‹™è¡¨ã‚¨ãƒ‡ã‚£ã‚¿ã‚’é–‹ãã«ã¯ã€ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¨±å¯ã—ã¦ãã ã•ã„', 'warning');
            }
        } else {
            console.log('âœ… å‹¤å‹™è¡¨ã‚¨ãƒ‡ã‚£ã‚¿ã‚’æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ãã¾ã—ãŸ');
        }
    }
}

        formatDate(date) {
            return date.toISOString().slice(0, 10);
        }
    }

    class DashboardAuth {
        constructor() {
            this.isInitialized = false;
            this.selectedDate = new Date();
            this.monthlyTasks = {};
            this.eventsListener = null;
            this.init();
        }

        async init() {
            if (this.isInitialized) return;
            this.isInitialized = true;

            try {
                await window.waitForFirebase();
                await this.checkAuthWithRetry();
            } catch (error) {
                console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                this.redirectToLogin();
            }
        }

        async checkAuthWithRetry(maxRetries = 3) {
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    const targetUID = sessionStorage.getItem('targetUID');
                    const currentUsername = sessionStorage.getItem('currentUsername');
                    if (!targetUID || !currentUsername) {
                        this.redirectToLogin();
                        return;
                    }
                    await this.ensureAnonymousAuth();
                    
                    const userSnapshot = await window.database.ref(`${window.DATA_ROOT}/users/${targetUID}`).once('value');
                    const userData = userSnapshot.val();
                    
                    if (userData && userData.setupCompleted) {
                        window.userRole = userData.role || 'viewer';
                        window.currentUserData = userData;
                        this.showDashboard();
                        return;
                    } else {
                        this.redirectToLogin();
                        return;
                    }
                } catch (error) {
                    if (attempt === maxRetries) {
                        this.redirectToLogin();
                        return;
                    }
                    await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                }
            }
        }

        async ensureAnonymousAuth() {
            let user = window.auth.currentUser;
            if (!user) {
                const result = await window.auth.signInAnonymously();
                user = result.user;
            }
            return user;
        }
async loadAndRenderEventsForSelectedDate() {
    const grid = document.getElementById('departmentGrid');
    if (!grid) return;

    const dateKey = this.formatDate(this.selectedDate);
    try {
        const snap = await window.database.ref(`${window.DATA_ROOT}/events/byDate/${dateKey}`).once('value');
        const eventsById = snap.val() || {};
        const events = Object.values(eventsById);

        // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªã‚¢
        grid.querySelectorAll('.task-list').forEach(el => {
            el.querySelectorAll('.glass-card.event-card').forEach(card => card.remove());
        });

        // ã‚¤ãƒ™ãƒ³ãƒˆã‚’éƒ¨é–€ã”ã¨ã«è¡¨ç¤º
        events.forEach(ev => {
            const section = grid.querySelector(`.task-list[data-department="${ev.department}"]`);
            if (!section) return;

            const item = document.createElement('div');
            item.className = 'glass-card p-2 mb-2 rounded-lg shadow-sm event-card event-drop-target';
            item.dataset.eventId = ev.id;
            item.dataset.dateKey = dateKey;
            item.dataset.department = ev.department;

            // ãƒ‰ãƒ­ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            item.addEventListener('dragover', (e) => this.handleEventDragOver(e));
            item.addEventListener('dragleave', (e) => this.handleEventDragLeave(e));
            item.addEventListener('drop', (e) => this.handleEventDrop(e));

            const timeText = (ev.startTime && ev.endTime) ? ` ${ev.startTime}-${ev.endTime}` : '';

            // assignedCEsã®äº’æ›å‡¦ç†ï¼ˆIDé…åˆ—ã¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé…åˆ—ä¸¡å¯¾å¿œï¼‰
            const assignedList = Array.isArray(ev.assignedCEs) ? ev.assignedCEs : [];
            const normalizedAssigned = assignedList.map(entry => {
                if (typeof entry === 'string') {
                    // IDæ–‡å­—åˆ—ã®å ´åˆã€CEManagerã‹ã‚‰æƒ…å ±ã‚’å–å¾—
                    const ce = window.ceManager?.ceList?.find(c => c.id === entry);
                    return ce ? { 
                        id: ce.id, 
                        name: ce.iconName || ce.displayName || ce.name, 
                        workType: ce.workType || 'ME' 
                    } : { id: entry, name: entry, workType: 'ME' };
                } else if (entry && typeof entry === 'object') {
                    // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã¯ãã®ã¾ã¾ä½¿ç”¨
                    return { 
                        id: entry.id, 
                        name: entry.name, 
                        workType: entry.workType || 'ME' 
                    };
                }
                return null;
            }).filter(Boolean);

            const assignedCount = normalizedAssigned.length;
            const need = Number.isFinite(ev.requiredPeople) ? ev.requiredPeople : 0;

            // é…ç½®æ¸ˆã¿CEãƒãƒƒãƒ—ã®ç”Ÿæˆ
            const assignedCEChips = normalizedAssigned.map(assigned => `
                <span class="chip worktype-${(assigned.workType || 'ME').toLowerCase()}" data-ce-id="${assigned.id}" title="${assigned.name}">
                    ${assigned.name}
                    ${window.userRole !== 'viewer' ? `<i class="fas fa-times remove" title="é…ç½®è§£é™¤"></i>` : ''}
                </span>
            `).join('');

            item.innerHTML = `
                <div class="flex justify-between items-center">
                    <div class="font-semibold text-sm">
                        <i class="fas fa-briefcase mr-1"></i>${ev.name}${timeText}
                    </div>
                    <div class="text-xs text-gray-500">${assignedCount}/${need}å</div>
                </div>
                ${ev.description ? `<div class="text-xs text-gray-600 mt-1">${ev.description}</div>` : ''}
                ${assignedCEChips ? `<div class="assigned-ces mt-2">${assignedCEChips}</div>` : ''}
                <div class="drop-hint text-xs text-gray-400 mt-1 italic">CEã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§é…ç½®</div>
                ${window.userRole !== 'viewer' ? `<button class="edit-event-btn text-blue-600 hover:text-blue-800 text-xs mt-1">
                    <i class="fas fa-edit mr-1"></i>ç·¨é›†
                </button>` : ''}
            `;

            // ç·¨é›†ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆinline onclickå›é¿ï¼‰
            const editBtn = item.querySelector('.edit-event-btn');
            if (editBtn) {
                editBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.openEditEventModal(dateKey, ev.id, ev);
                });
            }

            // é…ç½®è§£é™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆinline onclickå›é¿ï¼‰
            const removeButtons = item.querySelectorAll('.chip .remove');
            removeButtons.forEach(removeBtn => {
                removeBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const chip = e.currentTarget.closest('.chip');
                    const ceId = chip?.dataset?.ceId;
                    if (ceId) {
                        await this.unassignCE(dateKey, ev.id, ceId);
                    }
                });
            });

            section.appendChild(item);
        });

        // CEã‚¢ã‚¤ãƒ†ãƒ ã«ãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–
        setTimeout(() => {
            this.enableCEDragging();
        }, 100);

        console.log(`âœ… ${dateKey} ã®ã‚¤ãƒ™ãƒ³ãƒˆè¡¨ç¤ºå®Œäº†: ${events.length}ä»¶`);

    } catch (error) {
        console.error('âŒ æ—¥åˆ¥ã‚¤ãƒ™ãƒ³ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        window.showMessage('ã‚¤ãƒ™ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }
}

        redirectToLogin() {
            sessionStorage.clear();
            window.location.href = 'index.html';
        }

        setupRealtimeUpdates() {
    const updateEvents = () => {
        const dateKey = this.formatDate(this.selectedDate);
        
        // æ—¢å­˜ã®ãƒªã‚¹ãƒŠãƒ¼ãŒã‚ã‚Œã°å‰Šé™¤
        if (this.eventsListener) {
            this.eventsListener.off();
        }
        
        // æ–°ã—ã„ãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        this.eventsListener = window.database.ref(`${window.DATA_ROOT}/events/byDate/${dateKey}`)
            .on('value', (snapshot) => {
                console.log('ğŸ”„ ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿æ›´æ–°æ¤œçŸ¥');
                setTimeout(() => {
                    this.loadAndRenderEventsForSelectedDate();
                }, 300);
            });
    };
    
    // åˆå›è¨­å®š
    updateEvents();
    
    // æ—¥ä»˜å¤‰æ›´æ™‚ã«å†è¨­å®š
    const originalRenderSchedule = this.renderDailySchedule.bind(this);
    this.renderDailySchedule = function() {
        originalRenderSchedule();
        updateEvents();
    };
}

// CEãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½ã®æœ‰åŠ¹åŒ–
enableCEDragging() {
    const ceItems = document.querySelectorAll('.ce-item:not([draggable])');
    const ceList = window.ceManager?.ceList || [];

    ceItems.forEach((item, index) => {
        item.draggable = true;

        // CEãƒ‡ãƒ¼ã‚¿ã®è¨­å®š
        const ce = ceList[index];
        if (ce) {
            item.dataset.ceId = ce.id;
            item.dataset.ceName = ce.iconName || ce.displayName || ce.name;
            item.dataset.workType = ce.workType;
        } else {
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šè¡¨ç¤ºåã‹ã‚‰CEã‚’æ¤œç´¢
            const displayName = item.textContent.trim();
            const matchedCE = ceList.find(c => 
                c.iconName === displayName || 
                c.displayName === displayName || 
                c.name === displayName
            );
            if (matchedCE) {
                item.dataset.ceId = matchedCE.id;
                item.dataset.ceName = matchedCE.iconName || matchedCE.displayName || matchedCE.name;
                item.dataset.workType = matchedCE.workType;
            }
        }

        // ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆ
        item.addEventListener('dragstart', (e) => {
            const ceData = {
                ceId: item.dataset.ceId,
                ceName: item.dataset.ceName,
                workType: item.dataset.workType || 'ME'
            };

            e.dataTransfer.setData('application/json', JSON.stringify(ceData));
            e.dataTransfer.effectAllowed = 'copy';
            item.classList.add('dragging');
            console.log('ğŸ¯ CEãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹:', ceData);
        });

        item.addEventListener('dragend', () => {
            item.classList.remove('dragging');
        });
    });

    console.log('âœ… CEãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½æœ‰åŠ¹åŒ–å®Œäº†');
}

// ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼å‡¦ç†
handleEventDragOver(e) {
    if (window.userRole === 'viewer') return;
    
    e.preventDefault();
    e.dataTransfer.dropEffect = 'copy';
    e.currentTarget.classList.add('drag-over');
}

// ãƒ‰ãƒ©ãƒƒã‚°ãƒªãƒ¼ãƒ–å‡¦ç†
handleEventDragLeave(e) {
    if (!e.currentTarget.contains(e.relatedTarget)) {
        e.currentTarget.classList.remove('drag-over');
    }
}

// ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†
async handleEventDrop(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('drag-over');

    if (window.userRole === 'viewer') {
        window.showMessage('ç·¨é›†æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“', 'warning');
        return;
    }

    try {
        const ceDataStr = e.dataTransfer.getData('application/json');
        if (!ceDataStr) return;

        const ceData = JSON.parse(ceDataStr);
        const eventId = e.currentTarget.dataset.eventId;
        const dateKey = e.currentTarget.dataset.dateKey;

        console.log('ğŸ“¥ ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†:', { ceData, eventId, dateKey });
        await this.assignCEToEvent(dateKey, eventId, ceData);

    } catch (error) {
        console.error('âŒ ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
        window.showMessage('CEé…ç½®ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }
}

// CEã‚’æ¥­å‹™ã«é…ç½®ï¼ˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé…åˆ—å¯¾å¿œï¼‰
async assignCEToEvent(dateKey, eventId, ceData) {
    try {
        const eventRef = window.database.ref(`${window.DATA_ROOT}/events/byDate/${dateKey}/${eventId}`);
        const snapshot = await eventRef.once('value');
        const eventData = snapshot.val();

        if (!eventData) {
            window.showMessage('æ¥­å‹™ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
            return;
        }

        const currentAssigned = Array.isArray(eventData.assignedCEs) ? eventData.assignedCEs : [];
        
        // é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆIDæ–‡å­—åˆ—ã¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä¸¡å¯¾å¿œï¼‰
        const exists = currentAssigned.some(x => 
            (typeof x === 'string' ? x === ceData.ceId : x?.id === ceData.ceId)
        );
        
        if (exists) {
            window.showMessage(`${ceData.ceName}ã¯æ—¢ã«é…ç½®æ¸ˆã¿ã§ã™`, 'warning');
            return;
        }

        // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå½¢å¼ã§CEæƒ…å ±ã‚’ä¿å­˜
        const ceEntry = {
            id: ceData.ceId,
            name: ceData.ceName,
            workType: ceData.workType || 'ME'
        };

        // æ—¢å­˜ã®IDæ–‡å­—åˆ—ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå½¢å¼ã«å¤‰æ›ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
        const upgradedAssigned = currentAssigned.map(x => {
            if (typeof x === 'string') {
                const ce = window.ceManager?.ceList?.find(c => c.id === x);
                return {
                    id: x,
                    name: ce?.iconName || ce?.displayName || x,
                    workType: ce?.workType || 'ME'
                };
            }
            return x;
        });

        upgradedAssigned.push(ceEntry);

        await eventRef.update({
            assignedCEs: upgradedAssigned,
            updatedAt: firebase.database.ServerValue.TIMESTAMP,
            updatedBy: window.currentUserData?.displayName || 'user'
        });

        window.showMessage(`${ceData.ceName}ã‚’é…ç½®ã—ã¾ã—ãŸ`, 'success');
        console.log('âœ… CEé…ç½®å®Œäº†:', ceData.ceName);

        // ç”»é¢ã‚’å†æç”»
        setTimeout(() => {
            this.loadAndRenderEventsForSelectedDate();
        }, 500);

    } catch (error) {
        console.error('âŒ CEé…ç½®ã‚¨ãƒ©ãƒ¼:', error);
        window.showMessage('CEé…ç½®å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
    }
}

// CEé…ç½®è§£é™¤
async unassignCE(dateKey, eventId, ceId) {
    if (!confirm('ã“ã®CEã®é…ç½®ã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

    try {
        const eventRef = window.database.ref(`${window.DATA_ROOT}/events/byDate/${dateKey}/${eventId}`);
        const snapshot = await eventRef.once('value');
        const eventData = snapshot.val();

        if (!eventData) {
            window.showMessage('æ¥­å‹™ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
            return;
        }

        const currentAssigned = Array.isArray(eventData.assignedCEs) ? eventData.assignedCEs : [];
        const updatedAssigned = currentAssigned.filter(x => 
            (typeof x === 'string' ? x !== ceId : x?.id !== ceId)
        );

        if (updatedAssigned.length !== currentAssigned.length) {
            await eventRef.update({
                assignedCEs: updatedAssigned,
                updatedAt: firebase.database.ServerValue.TIMESTAMP,
                updatedBy: window.currentUserData?.displayName || 'user'
            });

            window.showMessage('CEã®é…ç½®ã‚’è§£é™¤ã—ã¾ã—ãŸ', 'success');
            
            // ç”»é¢ã‚’å†æç”»
            setTimeout(() => {
                this.loadAndRenderEventsForSelectedDate();
            }, 500);
        }

    } catch (error) {
        console.error('âŒ CEé…ç½®è§£é™¤ã‚¨ãƒ©ãƒ¼:', error);
        window.showMessage('CEé…ç½®è§£é™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }
}

// æ¥­å‹™ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆçµ±ä¸€ç‰ˆï¼‰
openEditEventModal(dateKey, eventId, eventData) {
    const modal = document.createElement('div');
    modal.id = 'editEventModal';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="glass-card p-6 max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">æ¥­å‹™ç·¨é›†</h3>
                <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="editEventForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-bold mb-2">æ¥­å‹™å *</label>
                    <input type="text" id="editEventName" class="input-unified" value="${eventData.name || ''}" required>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold mb-2">é–‹å§‹æ™‚é–“</label>
                        <input type="time" id="editStartTime" class="input-unified" value="${eventData.startTime || ''}">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2">çµ‚äº†æ™‚é–“</label>
                        <input type="time" id="editEndTime" class="input-unified" value="${eventData.endTime || ''}">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold mb-2">äºˆå®šä»¶æ•°</label>
                        <input type="number" id="editEventCount" class="input-unified" min="0" max="99" value="${eventData.count || 0}">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2">å¿…è¦äººæ•°</label>
                        <input type="number" id="editRequiredPeople" class="input-unified" min="0" max="20" value="${eventData.requiredPeople || 0}">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-bold mb-2">è©³ç´°</label>
                    <textarea id="editDescription" class="input-unified" rows="3">${eventData.description || ''}</textarea>
                </div>
                
                <div class="flex space-x-3">
                    <button type="button" onclick="window.dashboardAuth.deleteEvent('${dateKey}', '${eventId}')" 
                            class="btn-unified btn-outline-unified flex-1 text-red-600 border-red-600">
                        <i class="fas fa-trash mr-2"></i>å‰Šé™¤
                    </button>
                    <button type="submit" class="btn-unified btn-primary-unified flex-1">
                        <i class="fas fa-save mr-2"></i>æ›´æ–°
                    </button>
                </div>
            </form>
        </div>
    `;

    document.body.appendChild(modal);

    document.getElementById('editEventForm').onsubmit = (e) => {
        e.preventDefault();
        this.updateEvent(dateKey, eventId, modal);
    };
}

// æ¥­å‹™æ›´æ–°å‡¦ç†
async updateEvent(dateKey, eventId, modal) {
    const name = document.getElementById('editEventName')?.value?.trim();
    const startTime = document.getElementById('editStartTime')?.value;
    const endTime = document.getElementById('editEndTime')?.value;
    const count = parseInt(document.getElementById('editEventCount')?.value) || 0;
    const requiredPeople = parseInt(document.getElementById('editRequiredPeople')?.value) || 0;
    const description = document.getElementById('editDescription')?.value?.trim();

    if (!name) {
        window.showMessage('æ¥­å‹™åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
        return;
    }

    try {
        const updateData = {
            name: name,
            startTime: startTime || null,
            endTime: endTime || null,
            count: count,
            requiredPeople: requiredPeople,
            description: description || null,
            updatedAt: firebase.database.ServerValue.TIMESTAMP,
            updatedBy: window.currentUserData?.displayName || 'unknown'
        };

        await window.database.ref(`${window.DATA_ROOT}/events/byDate/${dateKey}/${eventId}`).update(updateData);
        modal.remove();
        window.showMessage('æ¥­å‹™ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
        
        // ç”»é¢ã‚’å†æç”»
        setTimeout(() => {
            this.loadAndRenderEventsForSelectedDate();
        }, 500);

    } catch (error) {
        console.error('æ¥­å‹™æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
        window.showMessage('æ¥­å‹™ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }
}

// æ¥­å‹™å‰Šé™¤å‡¦ç†
async deleteEvent(dateKey, eventId) {
    if (!confirm('ã“ã®æ¥­å‹™ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

    try {
        await window.database.ref(`${window.DATA_ROOT}/events/byDate/${dateKey}/${eventId}`).remove();
        document.getElementById('editEventModal')?.remove();
        window.showMessage('æ¥­å‹™ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
        
        // ç”»é¢ã‚’å†æç”»
        setTimeout(() => {
            this.loadAndRenderEventsForSelectedDate();
        }, 500);
    } catch (error) {
        console.error('æ¥­å‹™å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
        window.showMessage('æ¥­å‹™ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }
}

// æ¥­å‹™è¿½åŠ æ©Ÿèƒ½ã®ä¿®æ­£
openQuickAddEvent(department) {
    if (window.userRole === 'viewer') {
        window.showMessage('ç·¨é›†æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“', 'warning');
        return;
    }
    
    // EventManagerã®åˆæœŸåŒ–ç¢ºèª
    if (!window.eventManager) {
        if (window.EventManager) {
            try { 
                window.eventManager = new window.EventManager(); 
                console.log('âœ… EventManageråˆæœŸåŒ–å®Œäº†');
            } catch (e) { 
                console.error('EventManageråˆæœŸåŒ–å¤±æ•—:', e);
                window.showMessage('ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                return;
            }
        } else {
            window.showMessage('ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
            return;
        }
    }
    
    // åˆæœŸåŒ–å®Œäº†ã‚’å¾…ã£ã¦ã‹ã‚‰å®Ÿè¡Œ
    setTimeout(() => {
        if (window.eventManager && typeof window.eventManager.openAddEventModal === 'function') {
            window.eventManager.openAddEventModal(department);
        } else {
            window.showMessage('æ¥­å‹™è¿½åŠ æ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“', 'error');
        }
    }, 100);
}

        showDashboard() {
            const loadingEl = document.getElementById('loading');
            const mainEl = document.getElementById('mainInterface');
            if (loadingEl) loadingEl.style.display = 'none';
            if (mainEl) mainEl.style.display = 'block';
            
            this.updateUserDisplay();
            this.setupNavigation();
            this.setupSidebar();
            this.setupDailySchedule();
            this.initializeV2System();
        }

        updateUserDisplay() {
            const userData = window.currentUserData;
            if (!userData) return;
            document.querySelectorAll('#currentUserDisplay').forEach(el => {
                el.textContent = userData.displayName || userData.username || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
            });
        }

        setupNavigation() {
            const navTabs = [
                { id: 'dailyScheduleTab', content: 'dailyScheduleContent' },
                { id: 'ceManagementTab', content: 'ceManagementContent' },
                { id: 'calendarTab', content: 'calendarContent' },
                { id: 'departmentTimelineTab', content: 'departmentTimelineContent' },
                { id: 'personalTimelineTab', content: 'personalTimelineContent' },
                { id: 'analysisTab', content: 'analysisContent' },
                { id: 'settingsTab', content: 'settingsContent' }
            ];

            navTabs.forEach(tab => {
                const element = document.getElementById(tab.id);
                if (element) {
                    element.onclick = () => {
                        this.showScreen(tab.content, tab.id);
                        if (tab.id === 'ceManagementTab') {
                            setTimeout(() => {
                                if (window.workScheduleViewer) {
                                    window.workScheduleViewer.displayCurrentPeriod();
                                }
                            }, 100);
                        }
                        if (tab.id === 'settingsTab') {
                            setTimeout(() => this.setupAdminSettings(), 100);
                        }
                    };
                }
            });

            const toggleBtn = document.getElementById('toggleSidebar');
            const sidebar = document.getElementById('sidebar');
            if (toggleBtn && sidebar) {
                toggleBtn.onclick = () => sidebar.classList.toggle('expanded');
            }
        }

        showScreen(contentId, tabId) {
            document.querySelectorAll('.screen-content').forEach(screen => {
                screen.style.display = 'none';
            });
            
            const contentEl = document.getElementById(contentId);
            if (contentEl) {
                contentEl.style.display = 'block';
            }
            
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            const tabEl = document.getElementById(tabId);
            if (tabEl) {
                tabEl.classList.add('active');
            }
            
            if (contentId === 'ceManagementContent' && window.workScheduleViewer) {
                setTimeout(() => {
                    window.workScheduleViewer.displayCurrentPeriod();
                }, 100);
            } else if (contentId === 'settingsContent') {
                setTimeout(() => this.setupAdminSettings(), 100);
            }
        }

        setupSidebar() {
            const saveBtn = document.getElementById('templateSaveButton');
            const loadBtn = document.getElementById('templateLoadButton');
            if (saveBtn) saveBtn.onclick = () => window.showMessage('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¿å­˜æ©Ÿèƒ½ï¼ˆå®Ÿè£…äºˆå®šï¼‰', 'info');
            if (loadBtn) loadBtn.onclick = () => window.showMessage('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­è¾¼æ©Ÿèƒ½ï¼ˆå®Ÿè£…äºˆå®šï¼‰', 'info');
        }

        setupDailySchedule() {
            const datePicker = document.getElementById('scheduleDatePicker');
            if (datePicker) {
                datePicker.value = this.formatDate(this.selectedDate);
                datePicker.onchange = (e) => {
                    this.selectedDate = new Date(e.target.value + 'T00:00:00');
                    this.renderDailySchedule();
                };
            }

            const prev = document.getElementById('prevDayBtn');
            const next = document.getElementById('nextDayBtn');
            const today = document.getElementById('todayBtn');
            if (prev) prev.onclick = () => { 
                this.selectedDate.setDate(this.selectedDate.getDate() - 1); 
                if (datePicker) datePicker.value = this.formatDate(this.selectedDate); 
                this.renderDailySchedule(); 
            };
            if (next) next.onclick = () => { 
                this.selectedDate.setDate(this.selectedDate.getDate() + 1); 
                if (datePicker) datePicker.value = this.formatDate(this.selectedDate); 
                this.renderDailySchedule(); 
            };
            if (today) today.onclick = () => { 
                this.selectedDate = new Date(); 
                if (datePicker) datePicker.value = this.formatDate(this.selectedDate); 
                this.renderDailySchedule(); 
            };

            // é€šå¸¸ã®æ¥­å‹™è¿½åŠ ãƒœã‚¿ãƒ³
            const quickBtn = document.getElementById('addEventButtonDaily');
            if (quickBtn) quickBtn.onclick = () => this.openQuickAddEvent();

            // æœŸé–“ä¸€æ‹¬æ¥­å‹™è¿½åŠ ãƒœã‚¿ãƒ³
            const bulkBtn = document.getElementById('addBulkEventBtn');
            if (bulkBtn) {
                bulkBtn.onclick = () => {
                    if (window.userRole === 'viewer') {
                        window.showMessage('ç·¨é›†æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“', 'warning');
                        return;
                    }
                    if (!window.eventManager && window.EventManager) {
                        try { 
                            window.eventManager = new window.EventManager(); 
                        } catch (e) { 
                            console.warn('EventManageråˆæœŸåŒ–å¤±æ•—:', e); 
                        }
                    }
                    if (!window.eventManager) {
                        window.showMessage('ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†ã®åˆæœŸåŒ–ã‚’å¾…æ©Ÿä¸­ã§ã™', 'info');
                        return;
                    }
                    if (typeof window.eventManager.openBulkAddModal === 'function') {
                        window.eventManager.openBulkAddModal();
                    } else {
                        window.showMessage('æœŸé–“ä¸€æ‹¬æ¥­å‹™è¿½åŠ æ©Ÿèƒ½ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                    }
                };
            }

            // æœˆæ¬¡æ¥­å‹™è¿½åŠ ãƒœã‚¿ãƒ³
            const monthlyBtn = document.getElementById('addMonthlyTaskBtn');
            if (monthlyBtn) {
                monthlyBtn.onclick = () => {
                    if (window.userRole === 'viewer') {
                        window.showMessage('ç·¨é›†æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“', 'warning');
                        return;
                    }
                    if (!window.eventManager && window.EventManager) {
                        try { 
                            window.eventManager = new window.EventManager(); 
                        } catch (e) { 
                            console.warn('EventManageråˆæœŸåŒ–å¤±æ•—:', e); 
                        }
                    }
                    if (!window.eventManager) {
                        window.showMessage('ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†ã®åˆæœŸåŒ–ã‚’å¾…æ©Ÿä¸­ã§ã™', 'info');
                        return;
                    }
                    if (typeof window.eventManager.openMonthlyTaskModal === 'function') {
                        window.eventManager.openMonthlyTaskModal();
                    } else {
                        window.showMessage('æœˆæ¬¡æ¥­å‹™è¿½åŠ æ©Ÿèƒ½ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                    }
                };
            }

            this.renderDailySchedule();
        }

        renderDailySchedule() {
            const title = document.getElementById('dailyScheduleTitle');
            const grid = document.getElementById('departmentGrid');
            if (title) {
                const dateStr = this.selectedDate.toLocaleDateString('ja-JP', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric', 
                    weekday: 'short' 
                });
                title.textContent = `æ—¥åˆ¥ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆ${dateStr}ï¼‰`;
            }
            if (window.ceManager) {
                window.ceManager.currentDisplayDate = this.selectedDate;
                window.ceManager.displayCEList();
            }
            if (!grid) return;

            grid.innerHTML = '';
            grid.className = 'grid grid-cols-3 gap-4 mb-6';

            if (window.DEPARTMENTS) {
                window.DEPARTMENTS.forEach(dept => {
                    const section = this.createDepartmentSection(dept);
                    grid.appendChild(section);
                });
            }

            this.updateCEListCount();
            
            this.loadAndRenderEventsForSelectedDate();

        }

        createDepartmentSection(dept) {
            const section = document.createElement('div');
            section.className = 'department-section p-4';
            section.style.setProperty('--dept-color', window.DEPARTMENT_COLORS?.[dept] || '#e5e7eb');
            
            section.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-bold text-sm flex items-center">
                        <i class="fas fa-${window.DEPARTMENT_ICONS?.[dept] || 'cog'} mr-2" style="color: ${window.DEPARTMENT_COLORS?.[dept] || '#2563eb'}"></i>
                        <span>${dept}</span>
                    </h3>
                    ${window.userRole !== 'viewer' ? `
                    <button class="btn-unified btn-primary-unified btn-small" onclick="window.dashboardAuth.openQuickAddEvent('${dept}')">
                        <i class="fas fa-plus mr-1"></i>æ¥­å‹™è¿½åŠ 
                    </button>` : ''}
                </div>
                <div class="task-list min-h-[120px] space-y-2" data-department="${dept}">
                    <!-- é€šå¸¸æ¥­å‹™ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
                <div class="monthly-plans" data-department="${dept}">
                    <!-- æœˆæ¬¡æ¥­å‹™ãŒã“ã“ã«çœã‚¹ãƒšãƒ¼ã‚¹è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
            `;

            return section;
        }

        openQuickAddEvent(department) {
            if (window.userRole === 'viewer') {
                window.showMessage('ç·¨é›†æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“', 'warning');
                return;
            }
            if (!window.eventManager && window.EventManager) {
                try { 
                    window.eventManager = new window.EventManager(); 
                } catch (e) { 
                    console.warn('EventManageråˆæœŸåŒ–å¤±æ•—:', e); 
                }
            }
            if (!window.eventManager) {
                window.showMessage('ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†ã®åˆæœŸåŒ–ã‚’å¾…æ©Ÿä¸­ã§ã™', 'info');
                return;
            }
            if (typeof window.eventManager.openAddEventModal === 'function') {
                window.eventManager.openAddEventModal(department);
            } else {
                window.showMessage('æ¥­å‹™è¿½åŠ ã®UIãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
            }
        }

        setupAdminSettings() {
            const settingsContent = document.getElementById('settingsContent');
            if (!settingsContent) return;

            if (window.userRole === 'admin') {
                settingsContent.innerHTML = `
                    <h2 class="text-2xl font-bold mb-6">è¨­å®š</h2>
                    <div class="glass-card p-6 mb-6">
                        <h3 class="text-lg font-semibold mb-4 text-red-600">
                            <i class="fas fa-shield-alt mr-2"></i>ç®¡ç†è€…æ©Ÿèƒ½
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button onclick="window.open('pages/admin-dashboard.html', '_blank')" class="btn-unified btn-primary-unified">
                                <i class="fas fa-users-cog mr-2"></i>ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
                            </button>
                        </div>
                    </div>
                    <div class="glass-card p-6 mb-6">
                        <h3 class="text-lg font-semibold mb-4">
                            <i class="fas fa-cog mr-2"></i>ä¸€èˆ¬è¨­å®š
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">è¡¨ç¤ºå</label>
                                <input type="text" id="displayNameSetting" class="input-unified" value="${window.currentUserData?.displayName || ''}">
                            </div>
                            <button id="saveSettingsBtn" class="btn-unified btn-primary-unified">
                                <i class="fas fa-save mr-2"></i>è¨­å®šä¿å­˜
                            </button>
                        </div>
                    </div>
                `;
            } else {
                settingsContent.innerHTML = `
                    <h2 class="text-2xl font-bold mb-6">è¨­å®š</h2>
                    <div class="glass-card p-6 mb-6">
                        <h3 class="text-lg font-semibold mb-4">å€‹äººè¨­å®š</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">è¡¨ç¤ºå</label>
                                <input type="text" id="displayNameSetting" class="input-unified" value="${window.currentUserData?.displayName || ''}">
                            </div>
                            <button id="saveSettingsBtn" class="btn-unified btn-primary-unified">
                                <i class="fas fa-save mr-2"></i>è¨­å®šä¿å­˜
                            </button>
                        </div>
                    </div>
                `;
            }
            
            const saveBtn = document.getElementById('saveSettingsBtn');
            if (saveBtn) {
                saveBtn.onclick = async () => {
                    const displayName = document.getElementById('displayNameSetting')?.value.trim();
                    if (!displayName) {
                        window.showMessage('è¡¨ç¤ºåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
                        return;
                    }
                    try {
                        const targetUID = sessionStorage.getItem('targetUID');
                        await window.database.ref(`${window.DATA_ROOT}/users/${targetUID}`).update({
                            displayName: displayName,
                            lastUpdated: Date.now()
                        });
                        window.currentUserData.displayName = displayName;
                        this.updateUserDisplay();
                        window.showMessage('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
                    } catch (error) {
                        console.error('è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                        window.showMessage('è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                    }
                };
            }
        }

        formatDate(date) {
            return date.toISOString().slice(0, 10);
        }

        updateCEListCount() {
            const el = document.getElementById('ceListCount');
            if (el) {
                const count = window.ceManager?.ceList?.length || 0;
                el.textContent = String(count);
            }
        }

        // V2ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ï¼ˆå®Œå…¨ä¿®æ­£ç‰ˆï¼‰
        initializeV2System() {
            setTimeout(async () => {
                try {
                    let attempts = 0;
                    while (attempts < 50) {
                        const allReady = (
                            typeof window.CalendarView !== 'undefined' &&
                            typeof window.EventManager !== 'undefined' &&
                            typeof window.CEManager !== 'undefined' &&
                            typeof window.showMessage !== 'undefined' &&
                            typeof window.CEDailyStatusManager !== 'undefined'
                        );
                        if (allReady) break;
                        await new Promise(resolve => setTimeout(resolve, 100));
                        attempts++;
                    }

                    // ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆï¼ˆã‚¨ãƒ©ãƒ¼è€æ€§ã‚ã‚Šï¼‰
                    try {
                        if (!window.calendarView && window.CalendarView) {
                            window.calendarView = new window.CalendarView();
                        }
                    } catch (e) { console.warn('CalendarViewåˆæœŸåŒ–å¤±æ•—:', e); }

                    try {
                        if (!window.eventManager && window.EventManager) {
                            window.eventManager = new window.EventManager();
                        }
                    } catch (e) { console.warn('EventManageråˆæœŸåŒ–å¤±æ•—:', e); }

                    try {
                        if (!window.ceManager && window.CEManager) {
                            window.ceManager = new window.CEManager();
                        }
                    } catch (e) { console.warn('CEManageråˆæœŸåŒ–å¤±æ•—:', e); }

                    try {
                        if (!window.ceDailyStatus && window.CEDailyStatusManager) {
                            window.ceDailyStatus = new window.CEDailyStatusManager();
                        }
                    } catch (e) { console.warn('CEDailyStatusManageråˆæœŸåŒ–å¤±æ•—:', e); }

                    try {
                        if (!window.workScheduleViewer) {
                            window.workScheduleViewer = new WorkScheduleViewer();
                        }
                    } catch (e) { console.warn('WorkScheduleVieweråˆæœŸåŒ–å¤±æ•—:', e); }

                    this.setupRealtimeUpdates();

                    console.log('âœ… V2ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
                } catch (error) {
                    console.error('âŒ V2ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                }
            }, 1500);
        }
    }

    // åˆæœŸåŒ–
    if (!window.dashboardAuthInitialized) {
        window.dashboardAuthInitialized = true;
        document.addEventListener('DOMContentLoaded', () => {
            window.dashboardAuth = new DashboardAuth();
        });
    }
        // ã‚¤ãƒ™ãƒ³ãƒˆç·¨é›†æ©Ÿèƒ½
window.editEvent = function(dateKey, eventId) {
    if (window.userRole === 'viewer') {
        window.showMessage('ç·¨é›†æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“', 'warning');
        return;
    }

    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="glass-card p-6 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">æ¥­å‹™ç·¨é›†</h3>
                <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="text-center">
                <i class="fas fa-spinner fa-spin text-2xl text-blue-600 mb-4"></i>
                <p>æ¥­å‹™ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
        </div>
    `;
    document.body.appendChild(modal);

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
    window.database.ref(`${window.DATA_ROOT}/events/byDate/${dateKey}/${eventId}`).once('value')
        .then(snapshot => {
            const eventData = snapshot.val();
            if (!eventData) {
                modal.remove();
                window.showMessage('æ¥­å‹™ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                return;
            }

            modal.querySelector('.glass-card').innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">æ¥­å‹™ç·¨é›†</h3>
                    <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <form id="editEventForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold mb-2">æ¥­å‹™å</label>
                        <input type="text" id="editEventName" class="input-unified" value="${eventData.name || ''}" required>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-bold mb-2">é–‹å§‹æ™‚é–“</label>
                            <input type="time" id="editStartTime" class="input-unified" value="${eventData.startTime || ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-2">çµ‚äº†æ™‚é–“</label>
                            <input type="time" id="editEndTime" class="input-unified" value="${eventData.endTime || ''}">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2">è©³ç´°</label>
                        <textarea id="editDescription" class="input-unified" rows="3">${eventData.description || ''}</textarea>
                    </div>
                    <div class="flex space-x-3">
                        <button type="button" onclick="window.deleteEvent('${dateKey}', '${eventId}')" 
                                class="btn-unified btn-outline-unified flex-1 text-red-600 border-red-600">
                            <i class="fas fa-trash mr-2"></i>å‰Šé™¤
                        </button>
                        <button type="submit" class="btn-unified btn-primary-unified flex-1">
                            <i class="fas fa-save mr-2"></i>æ›´æ–°
                        </button>
                    </div>
                </form>
            `;

            document.getElementById('editEventForm').onsubmit = (e) => {
                e.preventDefault();
                window.updateEvent(dateKey, eventId, modal);
            };
        })
        .catch(error => {
            console.error('ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            modal.remove();
            window.showMessage('æ¥­å‹™ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        });
};

window.updateEvent = async function(dateKey, eventId, modal) {
    const name = document.getElementById('editEventName').value.trim();
    const startTime = document.getElementById('editStartTime').value;
    const endTime = document.getElementById('editEndTime').value;
    const description = document.getElementById('editDescription').value.trim();

    if (!name) {
        window.showMessage('æ¥­å‹™åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
        return;
    }

    try {
        const updateData = {
            name: name,
            startTime: startTime || null,
            endTime: endTime || null,
            description: description || null,
            updatedAt: firebase.database.ServerValue.TIMESTAMP,
            updatedBy: window.currentUserData?.displayName || 'unknown'
        };

        await window.database.ref(`${window.DATA_ROOT}/events/byDate/${dateKey}/${eventId}`).update(updateData);
        modal.remove();
        window.showMessage('æ¥­å‹™ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
    } catch (error) {
        console.error('æ¥­å‹™æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
        window.showMessage('æ¥­å‹™ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }
};

window.deleteEvent = async function(dateKey, eventId) {
    if (!confirm('ã“ã®æ¥­å‹™ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

    try {
        await window.database.ref(`${window.DATA_ROOT}/events/byDate/${dateKey}/${eventId}`).remove();
        document.querySelector('.fixed.inset-0').remove();
        window.showMessage('æ¥­å‹™ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
    } catch (error) {
        console.error('æ¥­å‹™å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
        window.showMessage('æ¥­å‹™ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }
};
    </script>
</body>
</html>
