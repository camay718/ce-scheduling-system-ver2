<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  V2 - ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-semibold text-gray-900">CEã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  V2</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="userNameDisplay" class="text-sm text-gray-600"></span>
                    <button id="logoutBtn" class="text-sm text-red-600 hover:text-red-800">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                </div>
            </div>
        </div>
    </header>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
        <div id="loadingIndicator" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6">
                <div class="flex items-center">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                    <span class="ml-3">èª­ã¿è¾¼ã¿ä¸­...</span>
                </div>
            </div>
        </div>

        <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div class="px-4 py-6 sm:px-0">
            <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚¿ãƒ– -->
            <div class="border-b border-gray-200 mb-6">
                <nav class="-mb-px flex space-x-8">
                    <button id="scheduleTab" class="tab-button py-2 px-1 border-b-2 border-blue-500 text-blue-600 font-medium text-sm">
                        ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
                    </button>
                    <button id="tasksTab" class="tab-button py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">
                        ã‚¿ã‚¹ã‚¯
                    </button>
                    <button id="adminTab" class="tab-button py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm" style="display: none;">
                        ç®¡ç†è€…
                    </button>
                </nav>
            </div>

            <!-- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <div id="scheduleContent" class="tab-content">
                <!-- æ—¥ä»˜é¸æŠ -->
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¡¨ç¤º</h2>
                    <div class="flex items-center space-x-4">
                        <div>
                            <label for="dateInput" class="block text-sm font-medium text-gray-700">æ—¥ä»˜é¸æŠ</label>
                            <input type="date" id="dateInput" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="viewModeSelect" class="block text-sm font-medium text-gray-700">è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰</label>
                            <select id="viewModeSelect" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="daily">æ—¥è¡¨ç¤º</option>
                                <option value="weekly">é€±è¡¨ç¤º</option>
                                <option value="monthly">æœˆè¡¨ç¤º</option>
                            </select>
                        </div>
                        <button id="todayBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">ä»Šæ—¥</button>
                    </div>
                </div>

                <!-- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                <div id="scheduleDisplay" class="bg-white rounded-lg shadow">
                    <div class="p-6">
                        <div id="scheduleContent" class="space-y-4">
                            <!-- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¢ã‚¤ãƒ†ãƒ ãŒã“ã“ã«å‹•çš„ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- ã‚¿ã‚¹ã‚¯ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <div id="tasksContent" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯ -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯</h3>
                        <div id="todayTasks" class="space-y-3">
                            <!-- ã‚¿ã‚¹ã‚¯ã‚¢ã‚¤ãƒ†ãƒ ãŒã“ã“ã«å‹•çš„ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                        </div>
                    </div>

                    <!-- ä»Šé€±ã®ã‚¿ã‚¹ã‚¯ -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">ä»Šé€±ã®ã‚¿ã‚¹ã‚¯</h3>
                        <div id="weekTasks" class="space-y-3">
                            <!-- ã‚¿ã‚¹ã‚¯ã‚¢ã‚¤ãƒ†ãƒ ãŒã“ã“ã«å‹•çš„ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç®¡ç†è€…ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <div id="adminContent" class="tab-content hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç† -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</h3>
                        <button id="userManagementBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                            ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ç”»é¢ã¸
                        </button>
                    </div>

                    <!-- ã‚·ã‚¹ãƒ†ãƒ è¨­å®š -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</h3>
                        <button id="systemSettingsBtn" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                            è¨­å®šç”»é¢ã¸
                        </button>
                    </div>

                    <!-- ç›£æŸ»ãƒ­ã‚° -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">ç›£æŸ»ãƒ­ã‚°</h3>
                        <button id="auditLogBtn" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                            ãƒ­ã‚°ç¢ºèª
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="messageArea" class="fixed top-4 right-4 z-50"></div>

    <script>
        // Firebaseè¨­å®š
        const firebaseConfig = {
            databaseURL: "https://ce-schedule-management-default-rtdb.asia-southeast1.firebasedatabase.app/"
        };

        // FirebaseåˆæœŸåŒ–
        console.log('ğŸ”„ FirebaseåˆæœŸåŒ–é–‹å§‹...');
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentUser = null;
        let userRole = null;

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        const Utils = {
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
            showMessage: function(message, type = 'info', duration = 3000) {
                const messageArea = document.getElementById('messageArea');
                const messageEl = document.createElement('div');
                
                const bgColor = {
                    'success': 'bg-green-500',
                    'error': 'bg-red-500',
                    'warning': 'bg-yellow-500',
                    'info': 'bg-blue-500'
                }[type] || 'bg-blue-500';

                messageEl.className = `${bgColor} text-white px-4 py-2 rounded-lg shadow-lg mb-2`;
                messageEl.textContent = message;
                
                messageArea.appendChild(messageEl);
                
                setTimeout(() => {
                    if (messageEl.parentNode) {
                        messageEl.parentNode.removeChild(messageEl);
                    }
                }, duration);
            },

            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºåˆ¶å¾¡
            showLoading: function() {
                document.getElementById('loadingIndicator').style.display = 'flex';
            },

            hideLoading: function() {
                document.getElementById('loadingIndicator').style.display = 'none';
            },

            // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            formatDate: function(date) {
                if (!(date instanceof Date)) {
                    date = new Date(date);
                }
                return date.toLocaleDateString('ja-JP');
            },

            // æ™‚åˆ»ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            formatTime: function(date) {
                if (!(date instanceof Date)) {
                    date = new Date(date);
                }
                return date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            }
        };

        // ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚¯ãƒ©ã‚¹
        class DataManager {
            constructor() {
                this.cache = new Map();
                this.cacheExpiry = 5 * 60 * 1000; // 5åˆ†
            }

            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä»˜ããƒ‡ãƒ¼ã‚¿å–å¾—
            async getData(path) {
                const cacheKey = path;
                const cached = this.cache.get(cacheKey);
                
                if (cached && Date.now() - cached.timestamp < this.cacheExpiry) {
                    return cached.data;
                }

                try {
                    const snapshot = await db.ref(path).once('value');
                    const data = snapshot.val();
                    
                    this.cache.set(cacheKey, {
                        data: data,
                        timestamp: Date.now()
                    });
                    
                    return data;
                } catch (error) {
                    console.error('ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                    throw error;
                }
            }

            // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
            async saveData(path, data) {
                try {
                    await db.ref(path).set(data);
                    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–
                    this.cache.delete(path);
                    return true;
                } catch (error) {
                    console.error('ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                    throw error;
                }
            }

            // ãƒãƒƒãƒæ›´æ–°
            async batchUpdate(updates) {
                try {
                    await db.ref().update(updates);
                    // é–¢é€£ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–
                    for (const path in updates) {
                        this.cache.delete(path);
                    }
                    return true;
                } catch (error) {
                    console.error('ãƒãƒƒãƒæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                    throw error;
                }
            }

            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
            clearCache() {
                this.cache.clear();
            }
        }

        // ãƒ‡ãƒ¼ã‚¿ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
        const dataManager = new DataManager();

        // èªè¨¼çŠ¶æ…‹ç›£è¦–
        auth.onAuthStateChanged(async (user) => {
            console.log('ğŸ”„ èªè¨¼çŠ¶æ…‹å¤‰æ›´:', user ? 'ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿' : 'æœªãƒ­ã‚°ã‚¤ãƒ³');
            
            if (user) {
                currentUser = user;
                console.log('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼æˆåŠŸ:', user.uid);
                
                try {
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—
                    const userData = await dataManager.getData(`users/${user.uid}`);
                    
                    if (userData) {
                        userRole = userData.role || 'viewer';
                        console.log('ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼å½¹å‰²:', userRole);
                        
                        // UIåˆæœŸåŒ–
                        initializeDashboard(userData);
                    } else {
                        console.warn('âš ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                        // åˆæœŸè¨­å®šç”»é¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                        window.location.href = 'user-setup-fixed.html';
                    }
                } catch (error) {
                    console.error('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                    Utils.showMessage('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            } else {
                console.log('ğŸ”„ æœªèªè¨¼ã®ãŸã‚ã€ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ');
                window.location.href = 'index.html';
            }
        });

        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰åˆæœŸåŒ–
        function initializeDashboard(userData) {
            try {
                console.log('ğŸ”„ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰åˆæœŸåŒ–é–‹å§‹');
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼åè¡¨ç¤º
                document.getElementById('userNameDisplay').textContent = userData.name || 'ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼';
                
                // ç®¡ç†è€…ã‚¿ãƒ–ã®è¡¨ç¤ºåˆ¶å¾¡
                const adminTab = document.getElementById('adminTab');
                if (userRole === 'admin') {
                    adminTab.style.display = 'block';
                }
                
                // ã‚¿ãƒ–ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
                setupTabEvents();
                
                // åˆæœŸã‚¿ãƒ–è¡¨ç¤º
                showTab('schedule');
                
                // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
                loadDashboardData();
                
                Utils.hideLoading();
                console.log('âœ… ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰åˆæœŸåŒ–å®Œäº†');
                
            } catch (error) {
                console.error('âŒ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                Utils.showMessage('ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // ã‚¿ãƒ–ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
        function setupTabEvents() {
            // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
            document.getElementById('scheduleTab').addEventListener('click', () => showTab('schedule'));
            document.getElementById('tasksTab').addEventListener('click', () => showTab('tasks'));
            document.getElementById('adminTab').addEventListener('click', () => showTab('admin'));
            
            // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // ä»Šæ—¥ãƒœã‚¿ãƒ³
            document.getElementById('todayBtn').addEventListener('click', goToToday);
            
            // æ—¥ä»˜å…¥åŠ›å¤‰æ›´
            document.getElementById('dateInput').addEventListener('change', onDateChange);
            
            // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰å¤‰æ›´
            document.getElementById('viewModeSelect').addEventListener('change', onViewModeChange);
            
            // ç®¡ç†è€…ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
            if (userRole === 'admin') {
                document.getElementById('userManagementBtn').addEventListener('click', () => {
                    window.location.href = 'admin-dashboard.html';
                });
            }
        }

        // ã‚¿ãƒ–è¡¨ç¤ºåˆ‡æ›¿
        function showTab(tabName) {
            // å…¨ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éè¡¨ç¤º
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // å…¨ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('border-blue-500', 'text-blue-600');
                button.classList.add('border-transparent', 'text-gray-500');
            });
            
            // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ã‚’è¡¨ç¤º
            const contentId = tabName + 'Content';
            const tabId = tabName + 'Tab';
            
            document.getElementById(contentId).classList.remove('hidden');
            
            const activeTab = document.getElementById(tabId);
            activeTab.classList.remove('border-transparent', 'text-gray-500');
            activeTab.classList.add('border-blue-500', 'text-blue-600');
            
            // ã‚¿ãƒ–åˆ¥ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            switch (tabName) {
                case 'schedule':
                    loadScheduleData();
                    break;
                case 'tasks':
                    loadTasksData();
                    break;
                case 'admin':
                    loadAdminData();
                    break;
            }
        }

        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadDashboardData() {
            try {
                console.log('ğŸ”„ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹');
                
                // ä»Šæ—¥ã®æ—¥ä»˜ã‚’è¨­å®š
                const today = new Date();
                document.getElementById('dateInput').value = today.toISOString().split('T')[0];
                
                console.log('âœ… ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†');
                
            } catch (error) {
                console.error('âŒ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                Utils.showMessage('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadScheduleData() {
            try {
                const selectedDate = document.getElementById('dateInput').value;
                const viewMode = document.getElementById('viewModeSelect').value;
                
                console.log('ğŸ”„ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿:', { selectedDate, viewMode });
                
                // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆå®Ÿè£…ã«å¿œã˜ã¦èª¿æ•´ï¼‰
                const scheduleData = await dataManager.getData(`schedules/${currentUser.uid}`);
                
                // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¡¨ç¤ºæ›´æ–°
                updateScheduleDisplay(scheduleData, selectedDate, viewMode);
                
            } catch (error) {
                console.error('âŒ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                Utils.showMessage('ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadTasksData() {
            try {
                console.log('ğŸ”„ ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿');
                
                // ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿å–å¾—
                const tasksData = await dataManager.getData(`tasks/${currentUser.uid}`);
                
                // ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯ã¨ä»Šé€±ã®ã‚¿ã‚¹ã‚¯ã‚’åˆ†é¡
                const today = new Date();
                const startOfWeek = new Date(today);
                startOfWeek.setDate(today.getDate() - today.getDay());
                
                updateTasksDisplay(tasksData, today, startOfWeek);
                
            } catch (error) {
                console.error('âŒ ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                Utils.showMessage('ã‚¿ã‚¹ã‚¯ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // ç®¡ç†è€…ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadAdminData() {
            if (userRole !== 'admin') {
                Utils.showMessage('ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™', 'error');
                return;
            }
            
            try {
                console.log('ğŸ”„ ç®¡ç†è€…ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿');
                
                // ç®¡ç†è€…ç”¨ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å‡¦ç†
                // å®Ÿè£…ã«å¿œã˜ã¦è¿½åŠ 
                
            } catch (error) {
                console.error('âŒ ç®¡ç†è€…ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                Utils.showMessage('ç®¡ç†è€…ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¡¨ç¤ºæ›´æ–°
        function updateScheduleDisplay(scheduleData, selectedDate, viewMode) {
            const scheduleContent = document.querySelector('#scheduleDisplay #scheduleContent');
            
            if (!scheduleData) {
                scheduleContent.innerHTML = '<p class="text-gray-500">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’è¡¨ç¤º
            let displayHTML = '';
            
            switch (viewMode) {
                case 'daily':
                    displayHTML = generateDailyView(scheduleData, selectedDate);
                    break;
                case 'weekly':
                    displayHTML = generateWeeklyView(scheduleData, selectedDate);
                    break;
                case 'monthly':
                    displayHTML = generateMonthlyView(scheduleData, selectedDate);
                    break;
            }
            
            scheduleContent.innerHTML = displayHTML;
        }

        // æ—¥è¡¨ç¤ºç”Ÿæˆ
        function generateDailyView(scheduleData, selectedDate) {
            // å®Ÿè£…è©³ç´°ã¯è¦ä»¶ã«å¿œã˜ã¦èª¿æ•´
            return `<div class="text-center py-8">
                <p class="text-gray-500">æ—¥è¡¨ç¤º: ${selectedDate}</p>
                <p class="text-sm text-gray-400">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºäºˆå®š</p>
            </div>`;
        }

        // é€±è¡¨ç¤ºç”Ÿæˆ
        function generateWeeklyView(scheduleData, selectedDate) {
            return `<div class="text-center py-8">
                <p class="text-gray-500">é€±è¡¨ç¤º</p>
                <p class="text-sm text-gray-400">é€±é–“ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’è¡¨ç¤ºäºˆå®š</p>
            </div>`;
        }

        // æœˆè¡¨ç¤ºç”Ÿæˆ
        function generateMonthlyView(scheduleData, selectedDate) {
            return `<div class="text-center py-8">
                <p class="text-gray-500">æœˆè¡¨ç¤º</p>
                <p class="text-sm text-gray-400">æœˆé–“ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’è¡¨ç¤ºäºˆå®š</p>
            </div>`;
        }

        // ã‚¿ã‚¹ã‚¯è¡¨ç¤ºæ›´æ–°
        function updateTasksDisplay(tasksData, today, startOfWeek) {
            const todayTasksEl = document.getElementById('todayTasks');
            const weekTasksEl = document.getElementById('weekTasks');
            
            if (!tasksData) {
                todayTasksEl.innerHTML = '<p class="text-gray-500">ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                weekTasksEl.innerHTML = '<p class="text-gray-500">ä»Šé€±ã®ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            // ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã®è¡¨ç¤ºå‡¦ç†ï¼ˆå®Ÿè£…ã«å¿œã˜ã¦èª¿æ•´ï¼‰
            todayTasksEl.innerHTML = '<p class="text-gray-500">ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>';
            weekTasksEl.innerHTML = '<p class="text-gray-500">ä»Šé€±ã®ã‚¿ã‚¹ã‚¯ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>';
        }

        // ä»Šæ—¥ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
        function goToToday() {
            const today = new Date();
            document.getElementById('dateInput').value = today.toISOString().split('T')[0];
            loadScheduleData();
        }

        // æ—¥ä»˜å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
        function onDateChange() {
            loadScheduleData();
        }

        // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
        function onViewModeChange() {
            loadScheduleData();
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
        function logout() {
            auth.signOut().then(() => {
                console.log('âœ… ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæˆåŠŸ');
                window.location.href = 'index.html';
            }).catch((error) => {
                console.error('âŒ ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                Utils.showMessage('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            });
        }

        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        window.addEventListener('error', (event) => {
            console.error('âŒ JavaScript ã‚¨ãƒ©ãƒ¼:', event.error);
            Utils.showMessage('äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
        });

        // åˆæœŸåŒ–å®Œäº†ãƒ­ã‚°
        document.addEventListener('DOMContentLoaded', () => {
            console.log('âœ… Dashboard.html åˆæœŸåŒ–å®Œäº†');
        });
    </script>
</body>
</html>
