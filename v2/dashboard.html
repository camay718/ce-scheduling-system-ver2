// Dashboardå°‚ç”¨èªè¨¼ãƒã‚§ãƒƒã‚¯ï¼ˆä¿®æ­£ç‰ˆï¼‰
class DashboardAuth {
    constructor() {
        this.isInitialized = false;
        this.init();
    }

    async init() {
        if (this.isInitialized) return;
        this.isInitialized = true;

        console.log('ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰èªè¨¼ãƒã‚§ãƒƒã‚¯é–‹å§‹');
        
        try {
            await this.waitForFirebase();
            await this.checkAuthWithRetry();
        } catch (error) {
            console.error('âŒ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
            this.redirectToLogin();
        }
    }

    async waitForFirebase() {
        let attempts = 0;
        while (attempts < 30) {
            if (window.auth && window.database) {
                console.log('âœ… Firebaseæº–å‚™å®Œäº†');
                return;
            }
            await new Promise(resolve => setTimeout(resolve, 200));
            attempts++;
        }
        throw new Error('FirebaseåˆæœŸåŒ–å¤±æ•—');
    }

    async checkAuthWithRetry(maxRetries = 3) {
        for (let attempt = 1; attempt <= maxRetries; attempt++) {
            try {
                console.log(`ğŸ” èªè¨¼ãƒã‚§ãƒƒã‚¯è©¦è¡Œ ${attempt}/${maxRetries}`);
                
                const targetUID = sessionStorage.getItem('targetUID');
                const currentUsername = sessionStorage.getItem('currentUsername');
                
                if (!targetUID || !currentUsername) {
                    console.log('âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ãªã— â†’ ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸');
                    this.redirectToLogin();
                    return;
                }
                
                // åŒ¿åèªè¨¼ã‚’ç¢ºå®Ÿã«å®Ÿè¡Œ
                await this.ensureAnonymousAuth();
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ç¢ºèª
                const userSnapshot = await window.database.ref(`${window.DATA_ROOT}/users/${targetUID}`).once('value');
                const userData = userSnapshot.val();
                
                if (userData && userData.setupCompleted) {
                    console.log('âœ… ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¡¨ç¤ºè¨±å¯');
                    window.userRole = userData.role || 'viewer';
                    window.currentUserData = userData;
                    
                    this.showDashboard();
                    return; // æˆåŠŸæ™‚ã¯å³åº§ã«çµ‚äº†
                } else {
                    console.log('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šæœªå®Œäº† â†’ ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸');
                    this.redirectToLogin();
                    return;
                }
                
            } catch (error) {
                console.error(`âŒ èªè¨¼ãƒã‚§ãƒƒã‚¯è©¦è¡Œ ${attempt} ã‚¨ãƒ©ãƒ¼:`, error);
                
                if (attempt === maxRetries) {
                    console.error('âŒ å…¨ã¦ã®èªè¨¼ãƒã‚§ãƒƒã‚¯è©¦è¡ŒãŒå¤±æ•—');
                    this.redirectToLogin();
                    return;
                }
                
                // æ¬¡ã®è©¦è¡Œã¾ã§å¾…æ©Ÿ
                await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
            }
        }
    }

    async ensureAnonymousAuth() {
        let user = window.auth.currentUser;
        
        if (!user) {
            console.log('ğŸ”„ åŒ¿åèªè¨¼å®Ÿè¡Œä¸­...');
            const result = await window.auth.signInAnonymously();
            user = result.user;
            console.log('âœ… åŒ¿åèªè¨¼æˆåŠŸ:', user.uid);
        } else {
            console.log('âœ… æ—¢å­˜èªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèª:', user.uid);
        }
        
        return user;
    }

    redirectToLogin() {
        console.log('ğŸ”„ ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ');
        sessionStorage.clear();
        window.location.href = 'index.html';
    }

    showDashboard() {
        const loading = document.getElementById('loading');
        if (loading) {
            loading.style.display = 'none';
        }
        
        console.log('ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¡¨ç¤ºé–‹å§‹');
        this.updateUserDisplay();
        this.initializeScheduleTable();
        this.setupEventListeners();
    }

    updateUserDisplay() {
        const userData = window.currentUserData;
        if (!userData) return;
        
        const userElements = document.querySelectorAll('.user-name, #userName, [data-user="name"]');
        userElements.forEach(element => {
            element.textContent = userData.displayName || userData.username || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
        });
        
        const roleElements = document.querySelectorAll('.user-role, #userRole, [data-user="role"]');
        roleElements.forEach(element => {
            element.textContent = this.getRoleDisplayName(userData.role);
        });
    }

    getRoleDisplayName(role) {
        const roles = {
            'admin': 'ç®¡ç†è€…',
            'editor': 'ç·¨é›†è€…', 
            'viewer': 'é–²è¦§è€…'
        };
        return roles[role] || 'ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼';
    }

    // æ—¢å­˜ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯ãã®ã¾ã¾ç¶­æŒ
    initializeScheduleTable() {
        console.log('ğŸ“… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ†ãƒ¼ãƒ–ãƒ«åˆæœŸåŒ–');
        
        const tableBody = document.getElementById('scheduleTableBody');
        if (!tableBody) return;
        
        const timeSlots = ['09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00'];
        const weekDays = ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'];
        
        tableBody.innerHTML = timeSlots.map(time => `
            <tr>
                <td class="font-medium bg-gray-100">${time}</td>
                ${weekDays.map((day, index) => `
                    <td class="schedule-cell" data-time="${time}" data-day="${index}" onclick="openAssignmentModal('${time}', ${index})">
                        <div class="h-full w-full min-h-[60px] p-1">
                            <!-- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å†…å®¹ -->
                        </div>
                    </td>
                `).join('')}
            </tr>
        `).join('');
    }

    setupEventListeners() {
        // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šã‚’ãã®ã¾ã¾ç¶­æŒ
        const addCEBtn = document.getElementById('addCEBtn');
        if (addCEBtn) {
            addCEBtn.addEventListener('click', () => {
                const ceName = document.getElementById('ceNameInput').value.trim();
                const ceSkill = document.getElementById('ceSkillInput').value.trim();
                
                if (ceName) {
                    this.addCE(ceName, ceSkill);
                    document.getElementById('ceNameInput').value = '';
                    document.getElementById('ceSkillInput').value = '';
                }
            });
        }

        const addJobBtn = document.getElementById('addJobBtn');
        if (addJobBtn) {
            addJobBtn.addEventListener('click', () => {
                const jobName = document.getElementById('jobNameInput').value.trim();
                const jobDesc = document.getElementById('jobDescInput').value.trim();
                
                if (jobName) {
                    this.addJob(jobName, jobDesc);
                    document.getElementById('jobNameInput').value = '';
                    document.getElementById('jobDescInput').value = '';
                }
            });
        }

        document.getElementById('prevWeekBtn')?.addEventListener('click', () => this.changeWeek(-1));
        document.getElementById('nextWeekBtn')?.addEventListener('click', () => this.changeWeek(1));
    }

    addCE(name, skill) {
        const ceList = document.getElementById('ceList');
        const ceItem = document.createElement('div');
        ceItem.className = 'bg-blue-100 border border-blue-300 rounded p-2 text-sm';
        ceItem.innerHTML = `
            <div class="font-medium">${name}</div>
            ${skill ? `<div class="text-xs text-gray-600">${skill}</div>` : ''}
        `;
        ceList.appendChild(ceItem);
    }

    addJob(name, description) {
        const jobsList = document.getElementById('jobsList');
        const jobItem = document.createElement('div');
        jobItem.className = 'bg-green-100 border border-green-300 rounded p-2 text-sm';
        jobItem.innerHTML = `
            <div class="font-medium">${name}</div>
            ${description ? `<div class="text-xs text-gray-600">${description}</div>` : ''}
        `;
        jobsList.appendChild(jobItem);
    }

    changeWeek(direction) {
        const currentWeekElement = document.getElementById('currentWeek');
        if (currentWeekElement) {
            const now = new Date();
            const weekText = `${now.getFullYear()}å¹´${now.getMonth() + 1}æœˆç¬¬${Math.ceil(now.getDate() / 7)}é€±`;
            currentWeekElement.textContent = weekText;
        }
    }
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°è¨­å®š
window.logout = async () => {
    try {
        sessionStorage.clear();
        window.location.href = 'index.html';
    } catch (error) {
        console.error('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', error);
    }
};

window.openAssignmentModal = (time, day) => {
    const modal = document.getElementById('assignmentModal');
    if (modal) {
        modal.classList.remove('hidden');
    }
};

// ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡
document.addEventListener('click', (e) => {
    const modal = document.getElementById('assignmentModal');
    
    if (e.target.id === 'cancelAssignmentBtn' || e.target.classList.contains('bg-black')) {
        modal?.classList.add('hidden');
    }
    
    if (e.target.id === 'saveAssignmentBtn') {
        modal?.classList.add('hidden');
    }
    
    if (e.target.id === 'deleteAssignmentBtn') {
        modal?.classList.add('hidden');
    }
});

// åˆæœŸåŒ–ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
if (!window.dashboardAuthInitialized) {
    window.dashboardAuthInitialized = true;
    document.addEventListener('DOMContentLoaded', () => {
        new DashboardAuth();
    });
}

console.log('ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰èªè¨¼ã‚·ã‚¹ãƒ†ãƒ èª­ã¿è¾¼ã¿å®Œäº†ï¼ˆä¿®æ­£ç‰ˆï¼‰');
