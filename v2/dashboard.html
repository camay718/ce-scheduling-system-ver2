<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEスケジュール管理システム V2 - ダッシュボード</title>
    <link href="styles/main.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
</head>
<body>
    <div class="container">
        <!-- ヘッダー -->
        <header>
            <div class="header-content">
                <h1>CEスケジュール管理システム V2</h1>
                <div class="header-controls">
                    <span id="userNameDisplay"></span>
                    <select id="viewSelect">
                        <option value="calendar">カレンダー表示</option>
                        <option value="schedule">スケジュール表示</option>
                        <option value="workschedule">勤務表表示</option>
                    </select>
                    <button id="logoutBtn" class="btn-secondary">ログアウト</button>
                </div>
            </div>
        </header>

        <!-- メインコンテンツエリア -->
        <main>
            <!-- カレンダー表示 -->
            <section id="calendarView" class="view-section active">
                <div class="view-header">
                    <h2>カレンダー</h2>
                    <div class="calendar-controls">
                        <button id="prevMonth" class="btn-icon">&lt;</button>
                        <span id="currentMonth"></span>
                        <button id="nextMonth" class="btn-icon">&gt;</button>
                        <button id="todayBtn" class="btn-primary">今日</button>
                    </div>
                </div>
                <div id="calendarContainer">
                    <div class="calendar-grid" id="calendarGrid">
                        <!-- カレンダーがここに生成される -->
                    </div>
                </div>
            </section>

            <!-- スケジュール表示 -->
            <section id="scheduleView" class="view-section">
                <div class="view-header">
                    <h2>スケジュール管理</h2>
                    <div class="schedule-controls">
                        <input type="date" id="scheduleDate">
                        <button id="addScheduleBtn" class="btn-primary">予定追加</button>
                        <button id="exportScheduleBtn" class="btn-secondary">エクスポート</button>
                    </div>
                </div>
                <div id="scheduleContainer">
                    <div class="time-slots" id="timeSlots">
                        <!-- タイムスロットがここに生成される -->
                    </div>
                    <div class="schedule-items" id="scheduleItems">
                        <!-- スケジュールアイテムがここに表示される -->
                    </div>
                </div>
            </section>

            <!-- 勤務表表示 -->
            <section id="workscheduleView" class="view-section">
                <div class="view-header">
                    <h2>勤務表管理</h2>
                    <div class="workschedule-controls">
                        <select id="workPeriodSelect">
                            <option value="">期間を選択</option>
                        </select>
                        <button id="createWorkScheduleBtn" class="btn-primary">新規勤務表作成</button>
                        <button id="editWorkScheduleBtn" class="btn-secondary">編集</button>
                        <button id="exportWorkScheduleBtn" class="btn-secondary">エクスポート</button>
                    </div>
                </div>
                <div id="workScheduleContainer">
                    <div class="work-schedule-grid" id="workScheduleGrid">
                        <!-- 勤務表がここに表示される -->
                    </div>
                </div>
            </section>
        </main>

        <!-- モーダルダイアログ -->
        <!-- 予定追加モーダル -->
        <div id="scheduleModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>予定追加</h3>
                    <button class="modal-close">&times;</button>
                </div>
                <form id="scheduleForm">
                    <div class="form-group">
                        <label>タイトル:</label>
                        <input type="text" id="scheduleTitle" required>
                    </div>
                    <div class="form-group">
                        <label>日付:</label>
                        <input type="date" id="scheduleModalDate" required>
                    </div>
                    <div class="form-group">
                        <label>開始時刻:</label>
                        <input type="time" id="scheduleStartTime" required>
                    </div>
                    <div class="form-group">
                        <label>終了時刻:</label>
                        <input type="time" id="scheduleEndTime" required>
                    </div>
                    <div class="form-group">
                        <label>説明:</label>
                        <textarea id="scheduleDescription"></textarea>
                    </div>
                    <div class="form-group">
                        <label>カテゴリ:</label>
                        <select id="scheduleCategory">
                            <option value="work">業務</option>
                            <option value="meeting">会議</option>
                            <option value="training">研修</option>
                            <option value="other">その他</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn-secondary modal-close">キャンセル</button>
                        <button type="submit" class="btn-primary">保存</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 勤務表作成モーダル -->
        <div id="workScheduleModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>勤務表作成</h3>
                    <button class="modal-close">&times;</button>
                </div>
                <form id="workScheduleForm">
                    <div class="form-group">
                        <label>開始日:</label>
                        <input type="date" id="workStartDate" required>
                    </div>
                    <div class="form-group">
                        <label>終了日:</label>
                        <input type="date" id="workEndDate" required>
                    </div>
                    <div class="form-group">
                        <label>基本勤務パターン:</label>
                        <select id="workPattern">
                            <option value="day">日勤</option>
                            <option value="night">夜勤</option>
                            <option value="swing">準夜勤</option>
                            <option value="off">休み</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn-secondary modal-close">キャンセル</button>
                        <button type="submit" class="btn-primary">作成</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ローディング表示 -->
        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <p>読み込み中...</p>
        </div>

        <!-- メッセージ表示 -->
        <div id="messageContainer"></div>
    </div>

    <script>
        // Firebase設定（完全版）
        const firebaseConfig = {
            apiKey: "AIzaSyBkf4T8ZQ9dF5LhXlEf2R3xJ4uP7hV1nM9",
            authDomain: "ce-schedule-management.firebaseapp.com",
            databaseURL: "https://ce-schedule-management-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "ce-schedule-management",
            storageBucket: "ce-schedule-management.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef123456789"
        };

        // Firebase初期化
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // グローバル変数
        let currentUser = null;
        let currentView = 'calendar';
        let currentDate = new Date();
        let schedules = {};
        let workSchedules = {};
        let userRole = null;

        // 認証状態の監視
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                console.log('ユーザーログイン済み:', user.uid);
                
                // ユーザー情報を取得
                try {
                    const userSnapshot = await database.ref(`users/${user.uid}`).once('value');
                    const userData = userSnapshot.val();
                    
                    if (userData) {
                        userRole = userData.role;
                        document.getElementById('userNameDisplay').textContent = userData.name || 'ユーザー';
                        
                        // データ読み込み
                        await loadUserData();
                        hideLoading();
                        
                        // 初期表示
                        updateCalendarView();
                        generateTimeSlots();
                        loadWorkPeriods();
                        
                    } else {
                        // ユーザー設定画面にリダイレクト
                        window.location.href = 'user-setup.html';
                    }
                } catch (error) {
                    console.error('ユーザーデータ読み込みエラー:', error);
                    showMessage('データの読み込みに失敗しました', 'error');
                }
            } else {
                // ログイン画面にリダイレクト
                window.location.href = 'index.html';
            }
        });

        // ユーザーデータ読み込み
        async function loadUserData() {
            try {
                showLoading();
                
                // スケジュールデータ読み込み
                const schedulesSnapshot = await database.ref(`schedules/${currentUser.uid}`).once('value');
                schedules = schedulesSnapshot.val() || {};
                
                // 勤務表データ読み込み
                const workSchedulesSnapshot = await database.ref(`workSchedules/${currentUser.uid}`).once('value');
                workSchedules = workSchedulesSnapshot.val() || {};
                
                console.log('データ読み込み完了');
                
            } catch (error) {
                console.error('データ読み込みエラー:', error);
                showMessage('データの読み込みに失敗しました', 'error');
            }
        }

        // カレンダー表示更新
        function updateCalendarView() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // 月表示更新
            document.getElementById('currentMonth').textContent = 
                `${year}年${month + 1}月`;
            
            // カレンダーグリッド生成
            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.innerHTML = '';
            
            // ヘッダー（曜日）追加
            const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
            weekdays.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });
            
            // 月初日と月末日を取得
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            // カレンダー日付生成（42日分 = 6週間）
            for (let i = 0; i < 42; i++) {
                const currentDay = new Date(startDate);
                currentDay.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                // 月外の日付は薄く表示
                if (currentDay.getMonth() !== month) {
                    dayElement.classList.add('other-month');
                }
                
                // 今日の日付をハイライト
                if (isToday(currentDay)) {
                    dayElement.classList.add('today');
                }
                
                // 日付表示
                const dateNumber = document.createElement('span');
                dateNumber.className = 'date-number';
                dateNumber.textContent = currentDay.getDate();
                dayElement.appendChild(dateNumber);
                
                // その日のスケジュール表示
                const dayKey = formatDateKey(currentDay);
                if (schedules[dayKey]) {
                    const schedulesForDay = Object.values(schedules[dayKey]);
                    schedulesForDay.slice(0, 3).forEach(schedule => {
                        const scheduleItem = document.createElement('div');
                        scheduleItem.className = `schedule-item ${schedule.category}`;
                        scheduleItem.textContent = schedule.title;
                        dayElement.appendChild(scheduleItem);
                    });
                    
                    if (schedulesForDay.length > 3) {
                        const moreItem = document.createElement('div');
                        moreItem.className = 'schedule-more';
                        moreItem.textContent = `他${schedulesForDay.length - 3}件`;
                        dayElement.appendChild(moreItem);
                    }
                }
                
                // クリックイベント
                dayElement.addEventListener('click', () => {
                    selectDate(currentDay);
                });
                
                calendarGrid.appendChild(dayElement);
            }
        }

        // タイムスロット生成
        function generateTimeSlots() {
            const timeSlotsContainer = document.getElementById('timeSlots');
            timeSlotsContainer.innerHTML = '';
            
            for (let hour = 0; hour < 24; hour++) {
                const timeSlot = document.createElement('div');
                timeSlot.className = 'time-slot';
                timeSlot.textContent = `${String(hour).padStart(2, '0')}:00`;
                timeSlotsContainer.appendChild(timeSlot);
            }
        }

        // スケジュール表示更新
        function updateScheduleView(date) {
            const scheduleItemsContainer = document.getElementById('scheduleItems');
            scheduleItemsContainer.innerHTML = '';
            
            const dateKey = formatDateKey(date);
            const daySchedules = schedules[dateKey] || {};
            
            Object.values(daySchedules).forEach(schedule => {
                const scheduleElement = document.createElement('div');
                scheduleElement.className = `schedule-block ${schedule.category}`;
                
                // 時間位置計算
                const startTime = new Date(`1970-01-01T${schedule.startTime}`);
                const endTime = new Date(`1970-01-01T${schedule.endTime}`);
                const startHour = startTime.getHours() + startTime.getMinutes() / 60;
                const duration = (endTime - startTime) / (1000 * 60 * 60);
                
                scheduleElement.style.top = `${startHour * 60}px`;
                scheduleElement.style.height = `${duration * 60}px`;
                
                scheduleElement.innerHTML = `
                    <div class="schedule-title">${schedule.title}</div>
                    <div class="schedule-time">${schedule.startTime} - ${schedule.endTime}</div>
                    <div class="schedule-description">${schedule.description || ''}</div>
                `;
                
                scheduleItemsContainer.appendChild(scheduleElement);
            });
        }

        // 勤務表期間読み込み
        function loadWorkPeriods() {
            const workPeriodSelect = document.getElementById('workPeriodSelect');
            workPeriodSelect.innerHTML = '<option value="">期間を選択</option>';
            
            Object.keys(workSchedules).forEach(periodKey => {
                const option = document.createElement('option');
                option.value = periodKey;
                option.textContent = formatPeriodDisplay(periodKey);
                workPeriodSelect.appendChild(option);
            });
        }

        // 勤務表表示更新
        function updateWorkScheduleView(periodKey) {
            const workScheduleGrid = document.getElementById('workScheduleGrid');
            workScheduleGrid.innerHTML = '';
            
            if (!periodKey || !workSchedules[periodKey]) {
                workScheduleGrid.innerHTML = '<p>勤務表データがありません</p>';
                return;
            }
            
            const workData = workSchedules[periodKey];
            const startDate = new Date(workData.startDate);
            const endDate = new Date(workData.endDate);
            
            // ヘッダー作成
            const headerRow = document.createElement('div');
            headerRow.className = 'work-schedule-header';
            
            const dateHeader = document.createElement('div');
            dateHeader.textContent = '日付';
            headerRow.appendChild(dateHeader);
            
            const shiftHeader = document.createElement('div');
            shiftHeader.textContent = '勤務区分';
            headerRow.appendChild(shiftHeader);
            
            const remarkHeader = document.createElement('div');
            remarkHeader.textContent = '備考';
            headerRow.appendChild(remarkHeader);
            
            workScheduleGrid.appendChild(headerRow);
            
            // 日付別勤務データ表示
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dateKey = formatDateKey(d);
                const dayData = workData.days[dateKey] || { shift: 'off', remark: '' };
                
                const row = document.createElement('div');
                row.className = 'work-schedule-row';
                
                const dateCell = document.createElement('div');
                dateCell.className = 'work-date';
                dateCell.textContent = formatDateDisplay(d);
                row.appendChild(dateCell);
                
                const shiftCell = document.createElement('div');
                shiftCell.className = `work-shift ${dayData.shift}`;
                shiftCell.textContent = getShiftDisplay(dayData.shift);
                row.appendChild(shiftCell);
                
                const remarkCell = document.createElement('div');
                remarkCell.className = 'work-remark';
                remarkCell.textContent = dayData.remark || '';
                row.appendChild(remarkCell);
                
                workScheduleGrid.appendChild(row);
            }
        }

        // 表示切替
        function switchView(viewName) {
            // 全ビューを非表示
            document.querySelectorAll('.view-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // 選択されたビューを表示
            document.getElementById(`${viewName}View`).classList.add('active');
            currentView = viewName;
            
            // ビュー別初期化処理
            switch (viewName) {
                case 'calendar':
                    updateCalendarView();
                    break;
                case 'schedule':
                    const selectedDate = document.getElementById('scheduleDate').value;
                    if (selectedDate) {
                        updateScheduleView(new Date(selectedDate));
                    }
                    break;
                case 'workschedule':
                    const selectedPeriod = document.getElementById('workPeriodSelect').value;
                    if (selectedPeriod) {
                        updateWorkScheduleView(selectedPeriod);
                    }
                    break;
            }
        }

        // イベントリスナー設定
        document.addEventListener('DOMContentLoaded', () => {
            // ビュー切替
            document.getElementById('viewSelect').addEventListener('change', (e) => {
                switchView(e.target.value);
            });
            
            // カレンダー操作
            document.getElementById('prevMonth').addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                updateCalendarView();
            });
            
            document.getElementById('nextMonth').addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                updateCalendarView();
            });
            
            document.getElementById('todayBtn').addEventListener('click', () => {
                currentDate = new Date();
                updateCalendarView();
            });
            
            // スケジュール操作
            document.getElementById('scheduleDate').addEventListener('change', (e) => {
                if (e.target.value) {
                    updateScheduleView(new Date(e.target.value));
                }
            });
            
            document.getElementById('addScheduleBtn').addEventListener('click', () => {
                openScheduleModal();
            });
            
            // 勤務表操作
            document.getElementById('workPeriodSelect').addEventListener('change', (e) => {
                if (e.target.value) {
                    updateWorkScheduleView(e.target.value);
                }
            });
            
            document.getElementById('createWorkScheduleBtn').addEventListener('click', () => {
                openWorkScheduleModal();
            });
            
            // ログアウト
            document.getElementById('logoutBtn').addEventListener('click', () => {
                auth.signOut();
            });
            
            // モーダル操作
            setupModalEvents();
        });

        // ユーティリティ関数
        function formatDateKey(date) {
            return date.toISOString().split('T')[0];
        }
        
        function formatDateDisplay(date) {
            return date.toLocaleDateString('ja-JP');
        }
        
        function formatPeriodDisplay(periodKey) {
            const [start, end] = periodKey.split('_');
            return `${start} 〜 ${end}`;
        }
        
        function getShiftDisplay(shift) {
            const shiftMap = {
                'day': '日勤',
                'night': '夜勤',
                'swing': '準夜勤',
                'off': '休み'
            };
            return shiftMap[shift] || shift;
        }
        
        function isToday(date) {
            const today = new Date();
            return date.toDateString() === today.toDateString();
        }
        
        function selectDate(date) {
            document.getElementById('scheduleDate').value = formatDateKey(date);
            switchView('schedule');
            document.getElementById('viewSelect').value = 'schedule';
            updateScheduleView(date);
        }
        
        function showLoading() {
            document.getElementById('loading').style.display = 'flex';
        }
        
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
        
        function showMessage(message, type = 'info') {
            const messageContainer = document.getElementById('messageContainer');
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type}`;
            messageEl.textContent = message;
            messageContainer.appendChild(messageEl);
            
            setTimeout(() => {
                messageContainer.removeChild(messageEl);
            }, 3000);
        }

        // モーダル関数（簡略版）
        function setupModalEvents() {
            // モーダル閉じる処理
            document.querySelectorAll('.modal-close').forEach(closeBtn => {
                closeBtn.addEventListener('click', closeModal);
            });
            
            // モーダル外クリックで閉じる
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal();
                    }
                });
            });
        }
        
        function openScheduleModal() {
            document.getElementById('scheduleModal').style.display = 'block';
        }
        
        function openWorkScheduleModal() {
            document.getElementById('workScheduleModal').style.display = 'block';
        }
        
        function closeModal() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
        }
    </script>
</body>
</html>
