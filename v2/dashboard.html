<!DOCTYPE html>
<html lang="ja" data-theme="light" style=""><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEスケジュール管理システム V2 - ダッシュボード</title>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">

    <!-- 外部ライブラリ -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
      :root {
        --brand-primary: #4caf50;
        --brand-secondary: #2196f3;
        --glass-bg: rgba(255, 255, 255, 0.1);
        --glass-border: rgba(255, 255, 255, 0.2);
        --shadow-soft: 0 4px 6px rgba(0, 0, 0, 0.1);
        --shadow-hover: 0 8px 16px rgba(0, 0, 0, 0.15);
      }

      body {
        font-family: 'Noto Sans JP', sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        margin: 0;
      }

      /* 同期インジケータ強化 */
      .sync-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      .sync-indicator.connected {
        background: #d1fae5;
        color: #065f46;
        border: 1px solid #34d399;
      }

      .sync-indicator.connecting {
        background: #fef3c7;
        color: #92400e;
        border: 1px solid #f59e0b;
      }

      .sync-indicator.disconnected {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #ef4444;
      }

      .sync-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        transition: all 0.3s ease;
      }

      .sync-dot.connected {
        background: #10b981;
      }

      .sync-dot.connecting {
        background: #f59e0b;
      }

      .sync-dot.disconnected {
        background: #ef4444;
      }

      .sync-dot.pulse {
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      /* 月次業務強化スタイル */
      .monthly-task-badge {
        position: absolute;
        top: -4px;
        right: 4px;
        background: #f97316;
        color: white;
        font-size: 8px;
        padding: 1px 4px;
        border-radius: 3px;
        font-weight: bold;
      }

      .assignment-dropzone {
        min-height: 20px;
        padding: 4px;
        margin-top: 4px;
      }

      .assignment-dropzone.drag-over {
        background: #fef3c7 !important;
        border-color: #f59e0b !important;
      }

      .monthly-event-item {
        font-size: 11px;
        line-height: 1.2;
      }

      /* 業務カード改良 */
      .event-card {
        position: relative;
        transition: all 0.2s ease;
      }

      .event-card.drag-over {
        background: #fff7ed !important;
        border: 2px dashed #f59e0b !important;
        transform: scale(1.02);
      }

      .event-count-display {
        font-size: 11px;
        color: #6b7280;
        margin-top: 4px;
        font-weight: 500;
      }

      /* CEチップスタイル */
      .assigned-ces {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        margin-top: 8px;
      }

      .ce-chip {
        display: inline-flex;
        align-items: center;
        padding: 2px 6px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 500;
        white-space: nowrap;
        position: relative;
      }

      .ce-chip .remove-ce {
        margin-left: 4px;
        cursor: pointer;
        opacity: 0.7;
        font-size: 8px;
      }

      .ce-chip .remove-ce:hover {
        opacity: 1;
        color: #ef4444;
      }

      /* 勤務区分別色分け */
      .ce-chip.worktype-ope {
        background: #dbeafe;
        color: #1e40af;
      }
      .ce-chip.worktype-me {
        background: #dcfce7;
        color: #166534;
      }
      .ce-chip.worktype-hd {
        background: #fce7f3;
        color: #be185d;
      }
      .ce-chip.worktype-flex {
        background: #fef3c7;
        color: #a16207;
      }
      .ce-chip.worktype-error {
        background: #fee2e2;
        color: #dc2626;
      }

      /* 統一テーマスタイル */
      .glass-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        padding: 24px;
        margin-bottom: 24px;
        transition: all 0.3s ease;
      }

      .btn-unified {
        display: inline-flex;
        align-items: center;
        padding: 12px 20px;
        border-radius: 12px;
        font-weight: 500;
        font-size: 14px;
        text-decoration: none;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .btn-primary-unified {
        background: var(--brand-primary);
        color: white;
      }

      .btn-primary-unified:hover {
        background: #45a049;
        transform: translateY(-2px);
        box-shadow: var(--shadow-hover);
      }

      .btn-outline-unified {
        background: transparent;
        color: var(--brand-primary);
        border: 2px solid var(--brand-primary);
      }

      .btn-outline-unified:hover {
        background: var(--brand-primary);
        color: white;
        transform: translateY(-2px);
      }

      .input-unified {
        padding: 12px 16px;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        font-size: 14px;
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.9);
      }

      .input-unified:focus {
        outline: none;
        border-color: var(--brand-primary);
        box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
      }

      /* サイドバー */
      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        width: 280px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-right: 1px solid rgba(255, 255, 255, 0.2);
        padding: 24px;
        overflow-y: auto;
        z-index: 1000;
      }

      .main-content {
        margin-left: 280px;
        padding: 24px;
        min-height: 100vh;
      }

      .nav-tab {
        display: flex;
        align-items: center;
        width: 100%;
        padding: 12px 16px;
        border-radius: 12px;
        border: none;
        background: transparent;
        color: #6b7280;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 8px;
      }

      .nav-tab:hover {
        background: rgba(76, 175, 80, 0.1);
        color: var(--brand-primary);
      }

      .nav-tab.active {
        background: var(--brand-primary);
        color: white;
      }

      .screen-content {
        display: none;
      }

      .screen-content.active {
        display: block;
      }

      /* スピナー */
      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--brand-primary);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 16px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      #loading {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        background: rgba(255, 255, 255, 0.9);
      }

      /* レスポンシブ */
      @media (max-width: 768px) {
        .sidebar {
          transform: translateX(-100%);
          transition: transform 0.3s ease;
        }

        .sidebar.open {
          transform: translateX(0);
        }

        .main-content {
          margin-left: 0;
        }

        #toggleSidebar {
          display: block;
          position: fixed;
          top: 20px;
          left: 20px;
          z-index: 1001;
          background: var(--brand-primary);
          color: white;
          border: none;
          padding: 12px;
          border-radius: 8px;
        }
      }

      /* 同期ステータス通知 */
      .sync-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        z-index: 9999;
        transform: translateY(-100px);
        transition: all 0.3s ease;
      }

      .sync-notification.show {
        transform: translateY(0);
      }

      .sync-notification.success {
        background: #d1fae5;
        color: #065f46;
        border: 1px solid #34d399;
      }

      .sync-notification.error {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #ef4444;
      }

      .sync-notification.warning {
        background: #fef3c7;
        color: #92400e;
        border: 1px solid #f59e0b;
      }

      /* 部門グリッド */
      .department-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
      }

      .department-section {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 12px;
        padding: 16px;
        border: 1px solid rgba(0, 0, 0, 0.1);
      }

      .ce-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 8px;
      }

      .ce-item {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 8px;
        text-align: center;
        font-size: 12px;
        cursor: grab;
        transition: all 0.2s ease;
      }

      .ce-item:hover {
        background: #e9ecef;
        transform: translateY(-2px);
      }

      .ce-item.dragging {
        opacity: 0.5;
      }
    </style>
  </head>
  <body style="">
    <!-- 同期ステータス通知 -->
    <div id="syncNotification" class="sync-notification show warning">
      <span id="syncNotificationText">Firebase初期化を再試行中... (2/5)</span>
    </div>

    <!-- ローディング画面 -->
    <div id="loading">
                <div class="text-center">
                    <i class="fas fa-exclamation-triangle text-6xl text-red-500 mb-4"></i>
                    <h2 class="text-xl font-bold mb-4 text-red-600">初期化エラー</h2>
                    <p class="text-gray-600 mb-4">Firebase: Error (auth/api-key-not-valid.-please-pass-a-valid-api-key.).</p>
                    <button onclick="location.reload()" class="btn-unified btn-primary-unified">
                        <i class="fas fa-refresh mr-2"></i>再読み込み
                    </button>
                </div>
            </div>

    <!-- メインインターフェース -->
    <div id="mainInterface" style="display: none">
      <!-- サイドバー -->
      <div id="sidebar" class="sidebar">
        <!-- ハンバーガーメニューボタン（モバイル用） -->
        <button id="toggleSidebar" style="display: none" onclick="toggleSidebar()">
          <i class="fas fa-bars"></i>
        </button>

        <div class="mb-4">
          <div class="text-sm font-semibold text-gray-700 mb-2">
            <i class="fas fa-user mr-2"></i>
            <span id="currentUserDisplay">ユーザー</span>
          </div>
        </div>

        <!-- 同期ステータス -->
        <div class="mb-6">
          <div id="mainSyncStatus" class="sync-indicator connecting">
            <div id="syncDot" class="sync-dot connecting pulse"></div>
            <span id="syncStatusText">接続中...</span>
          </div>
          <div class="text-xs text-gray-500 mt-2">最終同期: <span id="lastSyncTime">--:--</span></div>
        </div>

        <!-- ナビゲーション -->
        <nav class="mb-6">
          <button id="dailyScheduleTab" class="nav-tab active" onclick="showContent('dailySchedule')">
            <i class="fas fa-calendar-day mr-2"></i>日別スケジュール
          </button>
          <button id="weeklyScheduleTab" class="nav-tab" onclick="showContent('weeklySchedule')">
            <i class="fas fa-calendar-week mr-2"></i>週間スケジュール
          </button>
          <button id="ceWorkScheduleTab" class="nav-tab" onclick="showContent('ceWorkSchedule')">
            <i class="fas fa-table mr-2"></i>CE勤務表
          </button>
          <button id="analysisTab" class="nav-tab" onclick="showContent('analysis')">
            <i class="fas fa-chart-bar mr-2"></i>集計・分析
          </button>
          <button id="settingsTab" class="nav-tab" onclick="showContent('settings')">
            <i class="fas fa-cog mr-2"></i>設定
          </button>
        </nav>

        <!-- 自動同期設定 -->
        <div class="glass-card p-4 mb-4">
          <h4 class="font-semibold mb-2">自動同期設定</h4>
          <label class="flex items-center">
            <input type="checkbox" id="autoSyncEnabled" checked="" class="mr-2">
            リアルタイム同期を有効にする
          </label>
        </div>

        <!-- ログアウトボタン -->
        <div class="mt-auto">
          <button onclick="handleLogout()" class="btn-unified w-full bg-gray-500 text-white hover:bg-gray-600">
            <i class="fas fa-sign-out-alt mr-2"></i>ログアウト
          </button>
        </div>
      </div>

      <!-- メインコンテンツ -->
      <div class="main-content">
        <!-- 日別スケジュール -->
        <div id="dailyScheduleContent" class="screen-content active">
          <div class="glass-card">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-2xl font-bold">日別スケジュール</h2>
              <div class="flex gap-2">
                <button onclick="prevDay()" class="btn-unified btn-outline-unified">
                  <i class="fas fa-chevron-left mr-1"></i>前日
                </button>
                <input type="date" id="scheduleDatePicker" class="input-unified" onchange="dateChanged()">
                <button onclick="nextDay()" class="btn-unified btn-outline-unified">
                  翌日<i class="fas fa-chevron-right ml-1"></i>
                </button>
                <button onclick="goToToday()" class="btn-unified btn-primary-unified">
                  <i class="fas fa-calendar-day mr-1"></i>今日
                </button>
              </div>
            </div>

            <!-- 統計表示 -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
              <div class="text-center p-4 bg-blue-50 rounded-lg">
                <div class="text-2xl font-bold text-blue-600" id="totalEvents">0</div>
                <div class="text-sm text-blue-500">総業務数</div>
              </div>
              <div class="text-center p-4 bg-green-50 rounded-lg">
                <div class="text-2xl font-bold text-green-600" id="assignedCEs">0</div>
                <div class="text-sm text-green-500">配置済みCE</div>
              </div>
              <div class="text-center p-4 bg-orange-50 rounded-lg">
                <div class="text-2xl font-bold text-orange-600" id="requiredCEs">0</div>
                <div class="text-sm text-orange-500">必要CE数</div>
              </div>
              <div class="text-center p-4 bg-purple-50 rounded-lg">
                <div class="text-2xl font-bold text-purple-600" id="coverageRate">0%</div>
                <div class="text-sm text-purple-500">充足率</div>
              </div>
            </div>

            <button onclick="addEvent()" class="btn-unified btn-primary-unified mb-4">
              <i class="fas fa-plus mr-2"></i>業務追加
            </button>

            <!-- 部門グリッド -->
            <div id="departmentGrid" class="department-grid">
              <!-- 動的生成 -->
            </div>
          </div>

          <!-- CEリスト -->
          <div class="glass-card">
            <h3 class="text-lg font-semibold mb-4">
              <i class="fas fa-users mr-2"></i>CEリスト（<span id="ceCount">0</span>名）
            </h3>
            <div id="ceGrid" class="ce-grid">
              <!-- 動的生成 -->
            </div>
          </div>
        </div>

        <!-- 週間スケジュール -->
        <div id="weeklyScheduleContent" class="screen-content">
          <div class="glass-card text-center">
            <h2 class="text-2xl font-bold mb-4">週間スケジュール</h2>
            <i class="fas fa-calendar-week text-6xl text-gray-300 mb-4"></i>
            <p class="text-gray-500">この機能は現在開発中です。</p>
          </div>
        </div>

        <!-- CE勤務表 -->
        <div id="ceWorkScheduleContent" class="screen-content">
          <div class="glass-card text-center">
            <h2 class="text-2xl font-bold mb-4">CE勤務表</h2>
            <i class="fas fa-table text-6xl text-gray-300 mb-4"></i>
            <p class="text-gray-500">この機能は現在開発中です。</p>
          </div>
        </div>

        <!-- 集計・分析 -->
        <div id="analysisContent" class="screen-content">
          <div class="glass-card">
            <h2 class="text-2xl font-bold mb-6">集計・分析</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              <div class="text-center p-6 border border-gray-200 rounded-lg hover:shadow-lg transition-all cursor-pointer">
                <i class="fas fa-chart-bar text-4xl text-blue-500 mb-3"></i>
                <h3 class="font-semibold mb-2">業務別タイムライン</h3>
                <p class="text-sm text-gray-500">部門・業務ごとの時系列分析</p>
              </div>
              <div class="text-center p-6 border border-gray-200 rounded-lg hover:shadow-lg transition-all cursor-pointer">
                <i class="fas fa-chart-line text-4xl text-green-500 mb-3"></i>
                <h3 class="font-semibold mb-2">個人別タイムライン</h3>
                <p class="text-sm text-gray-500">CE個人の勤務パターン分析</p>
              </div>
              <div class="text-center p-6 border border-gray-200 rounded-lg hover:shadow-lg transition-all cursor-pointer">
                <i class="fas fa-clipboard-list text-4xl text-purple-500 mb-3"></i>
                <h3 class="font-semibold mb-2">配置サマリ</h3>
                <p class="text-sm text-gray-500">業務配置状況の要約</p>
              </div>
              <div class="text-center p-6 border border-gray-200 rounded-lg hover:shadow-lg transition-all cursor-pointer">
                <i class="fas fa-percentage text-4xl text-red-500 mb-3"></i>
                <h3 class="font-semibold mb-2">部門別充足率</h3>
                <p class="text-sm text-gray-500">必要人数に対する充足状況</p>
              </div>
              <div class="text-center p-6 border border-gray-200 rounded-lg hover:shadow-lg transition-all cursor-pointer">
                <i class="fas fa-clock text-4xl text-yellow-500 mb-3"></i>
                <h3 class="font-semibold mb-2">業務時間分析</h3>
                <p class="text-sm text-gray-500">業務時間の集計と分析</p>
              </div>
              <div class="text-center p-6 border border-gray-200 rounded-lg hover:shadow-lg transition-all cursor-pointer">
                <i class="fas fa-users text-4xl text-indigo-500 mb-3"></i>
                <h3 class="font-semibold mb-2">時間帯別配置</h3>
                <p class="text-sm text-gray-500">時間帯ごとの人員配置状況</p>
              </div>
            </div>
          </div>
        </div>

        <!-- 設定 -->
        <div id="settingsContent" class="screen-content">
          <div class="glass-card">
            <h2 class="text-2xl font-bold mb-6">設定</h2>

            <!-- 同期設定 -->
            <div class="mb-6">
              <h3 class="text-lg font-semibold mb-3">同期設定</h3>
              <div class="space-y-3">
                <label class="flex items-center">
                  <input type="checkbox" id="realtimeSyncSetting" checked="" class="mr-2">
                  リアルタイム同期を有効にする
                </label>
                <label class="flex items-center">
                  <input type="checkbox" id="offlineModeEnabled" class="mr-2">
                  オフラインモードを有効にする
                </label>
                <label class="flex items-center">
                  <input type="checkbox" id="autoRetryEnabled" checked="" class="mr-2">
                  接続エラー時の自動リトライを有効にする
                </label>
              </div>
            </div>

            <!-- 接続状態詳細 -->
            <div class="mb-6">
              <h3 class="text-lg font-semibold mb-3">接続状態</h3>
              <div class="bg-gray-50 p-4 rounded-lg">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <div class="text-sm text-gray-600">データベース接続:</div>
                    <div id="dbConnectionStatus" class="font-semibold">確認中...</div>
                  </div>
                  <div>
                    <div class="text-sm text-gray-600">認証状態:</div>
                    <div id="authStatus" class="font-semibold">確認中...</div>
                  </div>
                  <div>
                    <div class="text-sm text-gray-600">最終同期:</div>
                    <div id="lastSyncTimeDetail" class="font-semibold">--:--:--</div>
                  </div>
                  <div>
                    <div class="text-sm text-gray-600">アクティブリスナー数:</div>
                    <div id="activeListenerCount" class="font-semibold">0</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 手動同期 -->
            <div class="mb-6">
              <h3 class="text-lg font-semibold mb-3">手動操作</h3>
              <div class="flex gap-3">
                <button onclick="forceSyncNow()" class="btn-unified btn-primary-unified">
                  <i class="fas fa-sync mr-2"></i>今すぐ同期
                </button>
                <button onclick="reconnectFirebase()" class="btn-unified btn-outline-unified">
                  <i class="fas fa-plug mr-2"></i>再接続
                </button>
                <button onclick="clearCache()" class="btn-unified btn-outline-unified">
                  <i class="fas fa-trash mr-2"></i>キャッシュクリア
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // グローバル変数
      let firebaseApp = null;
      let database = null;
      let auth = null;
      let currentUser = null;
      let isConnected = false;
      let listeners = new Map();
      let retryAttempts = 0;
      let maxRetryAttempts = 5;
      let currentDate = new Date();
      let autoSyncEnabled = true;
      let offlineQueue = [];

      // Firebase設定（実際の設定に置き換えてください）
      const firebaseConfig = {
        apiKey: 'your-api-key',
        authDomain: 'your-project.firebaseapp.com',
        databaseURL: 'https://your-project-default-rtdb.firebaseio.com/',
        projectId: 'your-project-id',
        storageBucket: 'your-project.appspot.com',
        messagingSenderId: '123456789',
        appId: 'your-app-id',
      };

      const DATA_ROOT = 'ce_schedule_system_v2';

      // 初期化
      document.addEventListener('DOMContentLoaded', async () => {
        try {
          await initializeFirebase();
          await initializeAuth();
          await setupRealtimeSync();
          initializeUI();
          hideLoading();
          showNotification('システムが正常に初期化されました', 'success');
        } catch (error) {
          console.error('初期化エラー:', error);
          showNotification('初期化に失敗しました: ' + error.message, 'error');
          handleInitializationFailure(error);
        }
      });

      // Firebase初期化（強化版）
      async function initializeFirebase() {
        try {
          console.log('Firebase初期化開始...');

          if (!firebaseApp) {
            firebaseApp = firebase.initializeApp(firebaseConfig);
          }

          database = firebase.database();
          auth = firebase.auth();

          // 接続状態監視の設定
          setupConnectionMonitoring();

          console.log('Firebase初期化完了');
          return true;
        } catch (error) {
          console.error('Firebase初期化エラー:', error);

          if (retryAttempts < maxRetryAttempts) {
            retryAttempts++;
            showNotification(`Firebase初期化を再試行中... (${retryAttempts}/${maxRetryAttempts})`, 'warning');
            await new Promise((resolve) => setTimeout(resolve, 2000 * retryAttempts));
            return await initializeFirebase();
          }

          throw error;
        }
      }

      // 接続状態監視（新機能）
      function setupConnectionMonitoring() {
        const connectedRef = database.ref('.info/connected');

        // リスナーを適切に管理
        if (listeners.has('connection')) {
          connectedRef.off('value', listeners.get('connection'));
        }

        const connectionListener = (snapshot) => {
          const connected = snapshot.val();
          isConnected = connected;
          updateSyncStatus(connected);

          if (connected) {
            console.log('Firebase接続確立');
            showNotification('データベースに接続されました', 'success');
            retryAttempts = 0;

            // 接続復旧時のリスナー再設定
            if (autoSyncEnabled) {
              setupDataListeners();
            }

            // オフラインキューの処理
            processOfflineQueue();
          } else {
            console.log('Firebase接続切断');
            showNotification('データベース接続が切断されました', 'error');

            // 自動再接続の試行
            if (document.getElementById('autoRetryEnabled')?.checked !== false) {
              setTimeout(attemptReconnection, 3000);
            }
          }

          updateConnectionUI(connected);
        };

        listeners.set('connection', connectionListener);
        connectedRef.on('value', connectionListener);
      }

      // 認証初期化（強化版）
      async function initializeAuth() {
        return new Promise((resolve, reject) => {
          let resolved = false;

          const authStateListener = (user) => {
            if (resolved) return;

            if (user) {
              currentUser = user;
              console.log('認証済みユーザー:', user.uid);
              updateUserDisplay(user);
              resolved = true;
              resolve(user);
            } else {
              console.log('未認証ユーザー - 匿名認証を実行');
              signInAnonymously();
            }
          };

          // 認証状態の監視
          auth.onAuthStateChanged(authStateListener);

          // 匿名認証関数
          const signInAnonymously = async () => {
            try {
              const result = await auth.signInAnonymously();
              currentUser = result.user;
              console.log('匿名認証成功:', result.user.uid);
              updateUserDisplay(result.user);

              if (!resolved) {
                resolved = true;
                resolve(result.user);
              }
            } catch (error) {
              console.error('匿名認証エラー:', error);
              if (!resolved) {
                resolved = true;
                reject(error);
              }
            }
          };

          // タイムアウト設定
          setTimeout(() => {
            if (!resolved) {
              resolved = true;
              reject(new Error('認証タイムアウト'));
            }
          }, 10000);
        });
      }

      // リアルタイム同期設定（強化版）
      async function setupRealtimeSync() {
        if (!autoSyncEnabled) {
          console.log('自動同期が無効です');
          return;
        }

        try {
          // 既存のリスナーをクリーンアップ
          cleanupListeners();

          // データリスナーの設定
          await setupDataListeners();

          console.log('リアルタイム同期設定完了');
        } catch (error) {
          console.error('リアルタイム同期設定エラー:', error);
          showNotification('リアルタイム同期の設定に失敗しました', 'error');
          throw error;
        }
      }

      // データリスナー設定（新機能）
      async function setupDataListeners() {
        if (!database || !isConnected) {
          console.log('データベース未接続のためリスナー設定をスキップ');
          return;
        }

        try {
          // イベントリスナー
          setupEventListener();

          // 月次タスクリスナー
          setupMonthlyTaskListener();

          // CEリスナー
          setupCEListener();

          // ユーザーリスナー
          setupUserListener();

          console.log('全データリスナー設定完了');
          updateActiveListenerCount();
        } catch (error) {
          console.error('データリスナー設定エラー:', error);
          throw error;
        }
      }

      // イベントリスナー設定
      function setupEventListener() {
        const dateKey = formatDateKey(currentDate);
        const eventRef = database.ref(`${DATA_ROOT}/events/byDate/${dateKey}`);

        // 既存リスナーの削除
        if (listeners.has('events')) {
          const oldListener = listeners.get('events');
          oldListener.ref.off('value', oldListener.callback);
        }

        const eventListener = (snapshot) => {
          try {
            const events = snapshot.val() || {};
            console.log(`イベントデータ更新: ${Object.keys(events).length}件`);
            renderEvents(events);
            updateStatistics();
            updateLastSyncTime();
          } catch (error) {
            console.error('イベントデータ処理エラー:', error);
            showNotification('イベントデータの更新に失敗しました', 'error');
          }
        };

        listeners.set('events', { ref: eventRef, callback: eventListener });
        eventRef.on('value', eventListener);
      }

      // 月次タスクリスナー設定
      function setupMonthlyTaskListener() {
        const monthKey = formatMonthKey(currentDate);
        const monthlyRef = database.ref(`${DATA_ROOT}/monthlyTasks/${monthKey}`);

        if (listeners.has('monthlyTasks')) {
          const oldListener = listeners.get('monthlyTasks');
          oldListener.ref.off('value', oldListener.callback);
        }

        const monthlyListener = (snapshot) => {
          try {
            const tasks = snapshot.val() || {};
            console.log(`月次タスクデータ更新: ${Object.keys(tasks).length}件`);
            renderMonthlyTasks(tasks);
            updateLastSyncTime();
          } catch (error) {
            console.error('月次タスクデータ処理エラー:', error);
            showNotification('月次タスクデータの更新に失敗しました', 'error');
          }
        };

        listeners.set('monthlyTasks', { ref: monthlyRef, callback: monthlyListener });
        monthlyRef.on('value', monthlyListener);
      }

      // CEリスナー設定
      function setupCEListener() {
        const ceRef = database.ref(`${DATA_ROOT}/ces`);

        if (listeners.has('ces')) {
          const oldListener = listeners.get('ces');
          oldListener.ref.off('value', oldListener.callback);
        }

        const ceListener = (snapshot) => {
          try {
            const ces = snapshot.val() || {};
            console.log(`CEデータ更新: ${Object.keys(ces).length}名`);
            renderCEList(ces);
            updateLastSyncTime();
          } catch (error) {
            console.error('CEデータ処理エラー:', error);
            showNotification('CEデータの更新に失敗しました', 'error');
          }
        };

        listeners.set('ces', { ref: ceRef, callback: ceListener });
        ceRef.on('value', ceListener);
      }

      // ユーザーリスナー設定
      function setupUserListener() {
        const userRef = database.ref(`${DATA_ROOT}/users`);

        if (listeners.has('users')) {
          const oldListener = listeners.get('users');
          oldListener.ref.off('value', oldListener.callback);
        }

        const userListener = (snapshot) => {
          try {
            const users = snapshot.val() || {};
            console.log(`ユーザーデータ更新: ${Object.keys(users).length}名`);
            updateLastSyncTime();
          } catch (error) {
            console.error('ユーザーデータ処理エラー:', error);
          }
        };

        listeners.set('users', { ref: userRef, callback: userListener });
        userRef.on('value', userListener);
      }

      // リスナークリーンアップ（重要な機能）
      function cleanupListeners() {
        console.log('既存リスナーのクリーンアップを開始...');

        listeners.forEach((listener, key) => {
          try {
            if (listener.ref && listener.callback) {
              listener.ref.off('value', listener.callback);
              console.log(`リスナー削除: ${key}`);
            }
          } catch (error) {
            console.error(`リスナー削除エラー (${key}):`, error);
          }
        });

        listeners.clear();
        updateActiveListenerCount();
        console.log('リスナークリーンアップ完了');
      }

      // 同期ステータス更新
      function updateSyncStatus(connected) {
        const statusElement = document.getElementById('mainSyncStatus');
        const dotElement = document.getElementById('syncDot');
        const textElement = document.getElementById('syncStatusText');

        if (connected) {
          statusElement.className = 'sync-indicator connected';
          dotElement.className = 'sync-dot connected pulse';
          textElement.textContent = 'リアルタイム同期中';
        } else {
          statusElement.className = 'sync-indicator disconnected';
          dotElement.className = 'sync-dot disconnected';
          textElement.textContent = '接続切断';
        }

        // 設定画面の詳細ステータスも更新
        updateConnectionUI(connected);
      }

      // 接続状態UI更新
      function updateConnectionUI(connected) {
        const dbStatus = document.getElementById('dbConnectionStatus');
        const authStatus = document.getElementById('authStatus');

        if (dbStatus) {
          dbStatus.textContent = connected ? '接続済み' : '切断';
          dbStatus.className = connected ? 'font-semibold text-green-600' : 'font-semibold text-red-600';
        }

        if (authStatus) {
          const authText = currentUser ? '認証済み' : '未認証';
          authStatus.textContent = authText;
          authStatus.className = currentUser ? 'font-semibold text-green-600' : 'font-semibold text-yellow-600';
        }
      }

      // 最終同期時刻更新
      function updateLastSyncTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('ja-JP');

        document.getElementById('lastSyncTime').textContent = timeString;
        document.getElementById('lastSyncTimeDetail').textContent = timeString;
      }

      // アクティブリスナー数更新
      function updateActiveListenerCount() {
        const count = listeners.size;
        const element = document.getElementById('activeListenerCount');
        if (element) {
          element.textContent = count.toString();
        }
      }

      // 通知表示（改良版）
      function showNotification(message, type = 'info') {
        const notification = document.getElementById('syncNotification');
        const text = document.getElementById('syncNotificationText');

        text.textContent = message;
        notification.className = `sync-notification show ${type}`;

        // 自動非表示
        setTimeout(() => {
          notification.classList.remove('show');
        }, 5000);

        console.log(`[${type.toUpperCase()}] ${message}`);
      }

      // 再接続試行
      async function attemptReconnection() {
        if (isConnected || retryAttempts >= maxRetryAttempts) {
          return;
        }

        retryAttempts++;
        showNotification(`再接続を試行中... (${retryAttempts}/${maxRetryAttempts})`, 'warning');

        try {
          // Firebase再初期化
          await initializeFirebase();

          if (isConnected) {
            showNotification('再接続に成功しました', 'success');
            retryAttempts = 0;
          } else {
            throw new Error('接続確認失敗');
          }
        } catch (error) {
          console.error(`再接続試行 ${retryAttempts} 失敗:`, error);

          if (retryAttempts < maxRetryAttempts) {
            setTimeout(attemptReconnection, 5000 * retryAttempts);
          } else {
            showNotification('再接続に失敗しました。ページを再読み込みしてください。', 'error');
          }
        }
      }

      // オフラインキュー処理
      function processOfflineQueue() {
        if (offlineQueue.length === 0) return;

        console.log(`オフラインキューを処理中: ${offlineQueue.length}件`);

        const promises = offlineQueue.map(async (operation) => {
          try {
            await operation();
            return true;
          } catch (error) {
            console.error('オフライン操作エラー:', error);
            return false;
          }
        });

        Promise.all(promises).then((results) => {
          const successCount = results.filter((r) => r).length;
          console.log(`オフライン操作完了: ${successCount}/${results.length}`);
          offlineQueue = [];

          if (successCount > 0) {
            showNotification(`${successCount}件のオフライン操作を同期しました`, 'success');
          }
        });
      }

      // UI初期化
      function initializeUI() {
        // 日付ピッカーの初期化
        const datePicker = document.getElementById('scheduleDatePicker');
        datePicker.value = formatDateInput(currentDate);

        // 自動同期チェックボックスのイベントリスナー
        document.getElementById('autoSyncEnabled')?.addEventListener('change', (e) => {
          autoSyncEnabled = e.target.checked;
          if (autoSyncEnabled && isConnected) {
            setupDataListeners();
          } else {
            cleanupListeners();
          }
          showNotification(autoSyncEnabled ? '自動同期を有効にしました' : '自動同期を無効にしました', 'info');
        });

        // 設定画面の同期設定
        document.getElementById('realtimeSyncSetting')?.addEventListener('change', (e) => {
          document.getElementById('autoSyncEnabled').checked = e.target.checked;
          document.getElementById('autoSyncEnabled').dispatchEvent(new Event('change'));
        });

        // 初期データロード
        loadInitialData();
      }

      // 初期データロード
      async function loadInitialData() {
        try {
          showNotification('初期データを読み込み中...', 'info');

          // 部門データの初期化
          renderDepartments();

          // CEリストの初期化
          const cesSnapshot = await database.ref(`${DATA_ROOT}/ces`).once('value');
          const ces = cesSnapshot.val() || {};
          renderCEList(ces);

          // 統計情報の更新
          updateStatistics();

          showNotification('初期データの読み込みが完了しました', 'success');
        } catch (error) {
          console.error('初期データロードエラー:', error);
          showNotification('初期データの読み込みに失敗しました', 'error');
        }
      }

      // ユーザー表示更新
      function updateUserDisplay(user) {
        const displayElement = document.getElementById('currentUserDisplay');
        if (displayElement) {
          displayElement.textContent = user.displayName || user.email || `ユーザー ${user.uid.substring(0, 8)}`;
        }
      }

      // ローディング非表示
      function hideLoading() {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('mainInterface').style.display = 'block';
      }

      // 初期化失敗時の処理
      function handleInitializationFailure(error) {
        const loading = document.getElementById('loading');
        loading.innerHTML = `
                <div class="text-center">
                    <i class="fas fa-exclamation-triangle text-6xl text-red-500 mb-4"></i>
                    <h2 class="text-xl font-bold mb-4 text-red-600">初期化エラー</h2>
                    <p class="text-gray-600 mb-4">${error.message}</p>
                    <button onclick="location.reload()" class="btn-unified btn-primary-unified">
                        <i class="fas fa-refresh mr-2"></i>再読み込み
                    </button>
                </div>
            `;
      }

      // タブ切り替え
      function showContent(contentType) {
        // すべてのタブとコンテンツを非アクティブに
        document.querySelectorAll('.nav-tab').forEach((tab) => tab.classList.remove('active'));
        document.querySelectorAll('.screen-content').forEach((content) => content.classList.remove('active'));

        // 選択されたタブとコンテンツをアクティブに
        document.getElementById(`${contentType}Tab`).classList.add('active');
        document.getElementById(`${contentType}Content`).classList.add('active');

        // コンテンツ固有の処理
        switch (contentType) {
          case 'dailySchedule':
            setupEventListener();
            break;
          case 'settings':
            updateConnectionUI(isConnected);
            updateActiveListenerCount();
            break;
        }
      }

      // 日付操作関数
      function prevDay() {
        currentDate.setDate(currentDate.getDate() - 1);
        updateDatePicker();
        dateChanged();
      }

      function nextDay() {
        currentDate.setDate(currentDate.getDate() + 1);
        updateDatePicker();
        dateChanged();
      }

      function goToToday() {
        currentDate = new Date();
        updateDatePicker();
        dateChanged();
      }

      function updateDatePicker() {
        document.getElementById('scheduleDatePicker').value = formatDateInput(currentDate);
      }

      function dateChanged() {
        const datePicker = document.getElementById('scheduleDatePicker');
        currentDate = new Date(datePicker.value);

        // イベントリスナーの再設定
        if (autoSyncEnabled && isConnected) {
          setupEventListener();
          setupMonthlyTaskListener();
        }

        showNotification(`日付を変更しました: ${formatDateDisplay(currentDate)}`, 'info');
      }

      // 手動同期関数
      async function forceSyncNow() {
        showNotification('手動同期を開始します...', 'info');

        try {
          await setupDataListeners();
          showNotification('手動同期が完了しました', 'success');
        } catch (error) {
          console.error('手動同期エラー:', error);
          showNotification('手動同期に失敗しました', 'error');
        }
      }

      async function reconnectFirebase() {
        showNotification('Firebase再接続を開始します...', 'info');

        try {
          cleanupListeners();
          await initializeFirebase();
          await setupRealtimeSync();
          showNotification('Firebase再接続が完了しました', 'success');
        } catch (error) {
          console.error('Firebase再接続エラー:', error);
          showNotification('Firebase再接続に失敗しました', 'error');
        }
      }

      function clearCache() {
        localStorage.clear();
        sessionStorage.clear();
        showNotification('キャッシュをクリアしました', 'success');
      }

      // データレンダリング関数（簡易実装）
      function renderDepartments() {
        const departments = ['循環器', '呼吸器', '消化器', '神経科', '手術室', 'ICU'];
        const grid = document.getElementById('departmentGrid');

        grid.innerHTML = departments
          .map(
            (dept) => `
                <div class="department-section">
                    <h3 class="text-lg font-semibold mb-3">${dept}</h3>
                    <div id="${dept}Events" class="min-h-20 border-2 border-dashed border-gray-300 rounded p-2">
                        <div class="text-sm text-gray-500 text-center">業務はありません</div>
                    </div>
                </div>
            `,
          )
          .join('');
      }

      function renderEvents(events) {
        // イベントレンダリング実装（サンプル）
        updateStatistics();
      }

      function renderMonthlyTasks(tasks) {
        // 月次タスクレンダリング実装（サンプル）
      }

      function renderCEList(ces) {
        const grid = document.getElementById('ceGrid');
        const count = Object.keys(ces).length;

        document.getElementById('ceCount').textContent = count;

        grid.innerHTML = Object.entries(ces)
          .map(
            ([id, ce]) => `
                <div class="ce-item" draggable="true">
                    <div class="font-semibold">${ce.name}</div>
                    <div class="text-xs text-gray-500">${ce.department}</div>
                </div>
            `,
          )
          .join('');
      }

      function updateStatistics() {
        // 統計更新（サンプル）
        document.getElementById('totalEvents').textContent = '0';
        document.getElementById('assignedCEs').textContent = '0';
        document.getElementById('requiredCEs').textContent = '0';
        document.getElementById('coverageRate').textContent = '0%';
      }

      // ヘルパー関数
      function formatDateKey(date) {
        return date.toISOString().split('T')[0].replace(/-/g, '');
      }

      function formatMonthKey(date) {
        return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
      }

      function formatDateInput(date) {
        return date.toISOString().split('T')[0];
      }

      function formatDateDisplay(date) {
        return date.toLocaleDateString('ja-JP', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          weekday: 'short',
        });
      }

      // ログアウト
      async function handleLogout() {
        try {
          cleanupListeners();
          await auth.signOut();
          sessionStorage.clear();
          localStorage.clear();
          window.location.href = 'index.html';
        } catch (error) {
          console.error('ログアウトエラー:', error);
          showNotification('ログアウトに失敗しました', 'error');
        }
      }

      // サイドバートグル（モバイル用）
      function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('open');
      }

      // 業務追加（サンプル）
      function addEvent() {
        showNotification('業務追加機能は開発中です', 'info');
      }

      // ページ離脱時のクリーンアップ
      window.addEventListener('beforeunload', () => {
        cleanupListeners();
      });

      // エラーハンドリング
      window.addEventListener('error', (event) => {
        console.error('グローバルエラー:', event.error);
        showNotification('予期しないエラーが発生しました', 'error');
      });

      window.addEventListener('unhandledrejection', (event) => {
        console.error('未処理のPromise拒否:', event.reason);
        showNotification('システムエラーが発生しました', 'error');
      });
    </script>
  

</body></html>