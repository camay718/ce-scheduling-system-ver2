<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  V2 - ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- çµ±ä¸€ãƒ†ãƒ¼ãƒ -->
    <link rel="stylesheet" href="css/theme-unified.css">
    
    <!-- æœˆæ¬¡æ¥­å‹™å°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« -->
    <style>
    /* æœˆæ¬¡æ¥­å‹™ï¼ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰å¼·åŒ–ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰ */
    .monthly-task-badge {
        position: absolute;
        top: -4px;
        right: 4px;
        background: #f97316;
        color: white;
        font-size: 8px;
        padding: 1px 4px;
        border-radius: 3px;
        font-weight: bold;
    }

    .assignment-dropzone {
        min-height: 20px;
        padding: 4px;
        margin-top: 4px;
    }

    .assignment-dropzone.drag-over {
        background: #fef3c7 !important;
        border-color: #f59e0b !important;
    }

    .btn-small {
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 3px;
        border: none;
        cursor: pointer;
    }

    .monthly-event-item {
        font-size: 11px;
        line-height: 1.2;
    }
    </style>

    <!-- Firebase SDKï¼ˆé‡è¤‡å‰Šé™¤æ¸ˆã¿ï¼‰ -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <!-- Firebaseè¨­å®š -->
    <script src="js/config/firebase-config.js?v=20241213"></script>
</head>
<body class="theme-unified">
    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ -->
    <div id="loading">
        <div class="spinner"></div>
        <p class="text-gray-600">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ -->
    <div id="mainInterface" style="display:none;">
        <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
        <div id="sidebar" class="sidebar p-4">
            <div class="mb-3 flex justify-between items-center">
                <button id="toggleSidebar" class="p-2 rounded-lg hover:bg-gray-200" title="ã‚µã‚¤ãƒ‰ãƒãƒ¼è¡¨ç¤º/éè¡¨ç¤º">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="text-xs text-gray-600 sidebar-text">
                    <span id="currentUserDisplay">ãƒ¦ãƒ¼ã‚¶ãƒ¼</span>
                </div>
            </div>

            <div class="mb-3">
                <div id="mainSyncStatus" class="sync-indicator connected">
                    <div class="sync-dot pulse"></div>
                    <span class="sidebar-text">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸä¸­</span>
                </div>
            </div>

            <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <nav class="space-y-2 mb-6">
                <button id="dailyScheduleTab" class="nav-tab w-full text-left p-3 rounded-lg hover:bg-green-100 font-medium active">
                    <i class="fas fa-calendar-day mr-2"></i><span class="sidebar-text">æ—¥åˆ¥ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</span>
                </button>
                <button id="ceManagementTab" class="nav-tab w-full text-left p-3 rounded-lg hover:bg-green-100 font-medium">
                    <i class="fas fa-table mr-2"></i><span class="sidebar-text">CEå‹¤å‹™åŒºåˆ†è¡¨</span>
                </button>
                <button id="calendarTab" class="nav-tab w-full text-left p-3 rounded-lg hover:bg-green-100 font-medium">
                    <i class="fas fa-calendar-week mr-2"></i><span class="sidebar-text">é€±é–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</span>
                </button>
                <button id="departmentTimelineTab" class="nav-tab w-full text-left p-3 rounded-lg hover:bg-green-100 font-medium">
                    <i class="fas fa-chart-gantt mr-2"></i><span class="sidebar-text">æ¥­å‹™åˆ¥ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</span>
                </button>
                <button id="personalTimelineTab" class="nav-tab w-full text-left p-3 rounded-lg hover:bg-green-100 font-medium">
                    <i class="fas fa-chart-line mr-2"></i><span class="sidebar-text">å€‹äººåˆ¥ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</span>
                </button>
                <button id="analysisTab" class="nav-tab w-full text-left p-3 rounded-lg hover:bg-green-100 font-medium">
                    <i class="fas fa-chart-bar mr-2"></i><span class="sidebar-text">é›†è¨ˆãƒ»åˆ†æ</span>
                </button>
                <button id="settingsTab" class="nav-tab w-full text-left p-3 rounded-lg hover:bg-green-100 font-medium">
                    <i class="fas fa-cog mr-2"></i><span class="sidebar-text">è¨­å®š</span>
                </button>
            </nav>

            <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆç¸¦é…ç½®ç‰ˆï¼‰ -->
            <div class="sidebar-text mb-4">
                <h3 class="text-sm font-medium text-gray-700 mb-2">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</h3>
                <div class="flex flex-col space-y-2">
                    <button id="templateSaveButton" class="w-full p-2 bg-green-500 text-white rounded-lg text-sm hover:bg-green-600">
                        <i class="fas fa-save mr-1"></i>ä¿å­˜
                    </button>
                    <button id="templateLoadButton" class="w-full p-2 bg-blue-500 text-white rounded-lg text-sm hover:bg-blue-600">
                        <i class="fas fa-folder-open mr-1"></i>èª­è¾¼
                    </button>
                </div>
            </div>

            <!-- è‡ªå‹•åŒæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
            <div class="mt-6 p-2 bg-yellow-50 rounded-lg sidebar-text">
                <h4 class="text-xs font-bold text-yellow-700 mb-1">è‡ªå‹•åŒæœŸ</h4>
                <div class="text-xs text-gray-600">
                    <div class="flex items-center">
                        <div class="w-2 h-2 bg-green-500 rounded-full mr-1 animate-pulse"></div>
                        <span id="syncStatusText">åŒæœŸä¸­</span>
                    </div>
                    <div id="lastSyncTime" class="text-xs">æœ€çµ‚: --:--</div>
                </div>
            </div>
            
            <!-- ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ -->
            <div class="mt-auto pt-4 border-t border-gray-200 sidebar-text">
                <button id="logoutButton" onclick="window.handleLogout()" 
                        class="w-full bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 text-sm font-medium transition-colors">
                    <i class="fas fa-sign-out-alt mr-2"></i>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                </button>
            </div>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div class="main-content p-4">
            <!-- æ—¥åˆ¥ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« -->
            <div id="dailyScheduleContent" class="screen-content">
                <div class="mb-4 flex justify-between items-center">
                    <h2 id="dailyScheduleTitle" class="text-2xl font-bold">æ—¥åˆ¥ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h2>
                    <div class="flex items-center gap-3">
                        <button id="prevDayBtn" class="btn-unified btn-outline-unified">
                            <i class="fas fa-chevron-left mr-1"></i>å‰æ—¥
                        </button>
                        <input type="date" id="scheduleDatePicker" class="input-unified" style="width: auto;">
                        <button id="nextDayBtn" class="btn-unified btn-outline-unified">
                            ç¿Œæ—¥<i class="fas fa-chevron-right ml-1"></i>
                        </button>
                        <button id="todayBtn" class="btn-unified btn-primary-unified">
                            <i class="fas fa-calendar-day mr-1"></i>ä»Šæ—¥
                        </button>
                        <button id="addEventButtonDaily" class="btn-unified btn-primary-unified">
                            <i class="fas fa-plus mr-2"></i>æ¥­å‹™è¿½åŠ 
                        </button>
                    </div>
                </div>

                <div class="mb-4 flex gap-3">
                    <button id="addBulkEventBtn" class="btn-unified btn-primary-unified">
                        <i class="fas fa-calendar-plus mr-1"></i>æœŸé–“ä¸€æ‹¬æ¥­å‹™è¿½åŠ 
                    </button>
                    <button id="addMonthlyTaskBtn" class="btn-unified btn-primary-unified">
                        <i class="fas fa-calendar-alt mr-1"></i>æœˆæ¬¡æ¥­å‹™è¿½åŠ 
                    </button>
                </div>
                
                <div id="departmentGrid" class="grid grid-cols-3 gap-4 mb-6"></div>
                
                <div class="glass-card p-4">
                    <h3 class="font-bold mb-3"><i class="fas fa-users mr-2"></i>CEãƒªã‚¹ãƒˆï¼ˆ<span id="ceListCount">--</span>åï¼‰</h3>
                    <div id="ceListContainer" class="ce-grid"></div>
                </div>
            </div>

            <!-- CEå‹¤å‹™åŒºåˆ†è¡¨ï¼ˆè¡¨ç¤ºå°‚ç”¨ãƒ»æ”¹å–„ç‰ˆï¼‰ -->
            <div id="ceManagementContent" class="screen-content" style="display:none; position: relative;">
                <!-- å‹¤å‹™æ™‚é–“å¸¯èª¬æ˜ï¼ˆå³ä¸Šæ¥µå°é…ç½®ï¼‰ -->
                <div class="work-time-compact" style="position: absolute; top: 15px; right: 15px; background: rgba(248, 249, 250, 0.95); border: 1px dashed #e0e0e0; border-radius: 4px; padding: 3px 5px; font-size: 7px; z-index: 100; max-width: 180px; line-height: 1.1;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr><th style="padding: 1px 2px; font-size: 7px; background: #f2f5f7; font-weight: 600;">åŒºåˆ†</th><th style="padding: 1px 2px; font-size: 7px; background: #f2f5f7; font-weight: 600;">æ™‚é–“</th></tr>
                        </thead>
                        <tbody>
                            <tr><td style="padding: 1px 2px; font-size: 7px;">A</td><td style="padding: 1px 2px; font-size: 7px;">8:00-16:30</td></tr>
                            <tr><td style="padding: 1px 2px; font-size: 7px;">A1</td><td style="padding: 1px 2px; font-size: 7px;">7:00-15:30</td></tr>
                            <tr><td style="padding: 1px 2px; font-size: 7px;">B</td><td style="padding: 1px 2px; font-size: 7px;">8:00-ç¿Œ8:00</td></tr>
                            <tr><td style="padding: 1px 2px; font-size: 7px;">Ã—</td><td style="padding: 1px 2px; font-size: 7px;">ä¼‘æ—¥</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="schedule-display-container">
                    <div class="period-navigation">
                        <button id="prevPeriodBtn" class="btn-unified btn-outline-unified">
                            <i class="fas fa-chevron-left mr-1"></i>å‰ã®æœŸé–“
                        </button>
                        <div class="period-display">
                            <div id="currentPeriodDisplay" class="text-lg font-bold">æœŸé–“ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                            <div class="text-sm text-gray-500">28æ—¥é–“ã®å‹¤å‹™è¡¨</div>
                        </div>
                        <button id="nextPeriodBtn" class="btn-unified btn-outline-unified">
                            æ¬¡ã®æœŸé–“<i class="fas fa-chevron-right ml-1"></i>
                        </button>
                    </div>
                    
                    <div class="text-center mb-4">
                        <button id="openScheduleEditorBtn" class="btn-unified btn-primary-unified">
                            <i class="fas fa-edit mr-2"></i>å‹¤å‹™è¡¨ã‚’ä½œæˆãƒ»ç·¨é›†
                        </button>
                    </div>

                    <!-- å‹¤å‹™åŒºåˆ†è¡¨è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                    <div id="workScheduleDisplayArea" class="text-center py-8 text-gray-500">
                        <i class="fas fa-table text-4xl mb-4"></i>
                        <h3 class="text-lg font-semibold mb-2">å‹¤å‹™åŒºåˆ†è¡¨</h3>
                        <p class="mb-4">ä½œæˆæ¸ˆã¿ã®å‹¤å‹™è¡¨ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
                        <button onclick="document.getElementById('openScheduleEditorBtn').click()" 
                                class="btn-unified btn-primary-unified">
                            <i class="fas fa-plus mr-2"></i>æœ€åˆã®å‹¤å‹™è¡¨ã‚’ä½œæˆ
                        </button>
                    </div>
                </div>
            </div>

            <!-- ãã®ä»–ã®ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <div id="calendarContent" class="screen-content" style="display:none;">
                <h2 class="text-2xl font-bold mb-4">é€±é–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h2>
                <p class="text-gray-600">é€±é–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ©Ÿèƒ½ï¼ˆé–‹ç™ºäºˆå®šï¼‰</p>
            </div>

            <div id="departmentTimelineContent" class="screen-content" style="display:none;">
                <h2 class="text-2xl font-bold mb-4">æ¥­å‹™åˆ¥ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</h2>
                <p class="text-gray-600">æ¥­å‹™åˆ¥ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³æ©Ÿèƒ½ï¼ˆé–‹ç™ºäºˆå®šï¼‰</p>
            </div>

            <div id="personalTimelineContent" class="screen-content" style="display:none;">
                <h2 class="text-2xl font-bold mb-4">å€‹äººåˆ¥ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</h2>
                <p class="text-gray-600">å€‹äººåˆ¥ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³æ©Ÿèƒ½ï¼ˆé–‹ç™ºäºˆå®šï¼‰</p>
            </div>

            <div id="analysisContent" class="screen-content" style="display:none;">
                <h2 class="text-2xl font-bold mb-4">é›†è¨ˆãƒ»åˆ†æ</h2>
                <p class="text-gray-600">é›†è¨ˆãƒ»åˆ†ææ©Ÿèƒ½ï¼ˆé–‹ç™ºäºˆå®šï¼‰</p>
            </div>

            <div id="settingsContent" class="screen-content" style="display:none;">
                <!-- è¨­å®šã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯å‹•çš„ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- JavaScriptèª­ã¿è¾¼ã¿ï¼ˆé †æ¬¡åŒæœŸèª­ã¿è¾¼ã¿ï¼‰ -->
    <script src="js/data/constants.js?v=20241213"></script>
    <script src="js/utils/ui-utils.js?v=20241213"></script>
    <script src="js/utils/date-utils.js?v=20241213"></script>
    <script src="js/schedule/schedule-core.js?v=20241213"></script>
    <script src="js/schedule/calendar-view.js?v=20241213"></script>
    <script src="js/schedule/event-manager.js?v=20241213"></script>
    <script src="js/ui/ce-manager.js?v=20241213"></script>
    <script src="js/ui/ce-daily-status.js?v=20241213"></script>

    <!-- Dashboardå°‚ç”¨JavaScriptï¼ˆå®Œå…¨ä¿®æ­£ç‰ˆï¼‰ -->
    <script>
    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆï¼ˆç›£æŸ»ãƒ­ã‚°ä»˜ãï¼‰
    window.handleLogout = async () => {
        try {
            try {
                const entry = {
                    action: 'logout',
                    details: {},
                    uid: window.currentUserData?.uid || null,
                    username: window.currentUserData?.username || 'unknown',
                    displayName: window.currentUserData?.displayName || 'unknown',
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    userAgent: navigator.userAgent.substring(0, 100)
                };
                await window.database.ref(`${window.DATA_ROOT}/auditLogs`).push(entry);
            } catch (logError) {
                console.warn('ç›£æŸ»ãƒ­ã‚°è¨˜éŒ²å¤±æ•—:', logError);
            }
            if (window.auth && window.auth.currentUser) {
                await window.auth.signOut();
            }
        } catch (error) {
            console.error('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', error);
        } finally {
            sessionStorage.clear();
            localStorage.clear();
            window.location.href = 'index.html';
        }
    };

    class WorkScheduleViewer {
        constructor() {
            this.currentPeriodIndex = 0;
            this.availablePeriods = [];
            this.init();
        }

        async init() {
            try {
                await window.waitForFirebase();
                await this.loadAvailablePeriods();
                this.setupEventListeners();
                console.log('âœ… å‹¤å‹™åŒºåˆ†è¡¨ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼åˆæœŸåŒ–å®Œäº†');
            } catch (error) {
                console.error('âŒ å‹¤å‹™åŒºåˆ†è¡¨ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        async loadAvailablePeriods() {
            try {
                const snapshot = await window.database.ref(`${window.DATA_ROOT}/workSchedules`).once('value');
                const data = snapshot.val() || {};
                
                this.availablePeriods = Object.keys(data).map(periodKey => ({
                    key: periodKey,
                    ...data[periodKey].metadata
                })).sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                
                if (this.availablePeriods.length > 0) {
                    this.currentPeriodIndex = 0;
                    this.displayCurrentPeriod();
                }
            } catch (error) {
                console.error('âŒ æœŸé–“ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        setupEventListeners() {
            const prevBtn = document.getElementById('prevPeriodBtn');
            const nextBtn = document.getElementById('nextPeriodBtn');
            const editorBtn = document.getElementById('openScheduleEditorBtn');

            if (prevBtn) prevBtn.onclick = () => this.navigatePeriod(-1);
            if (nextBtn) nextBtn.onclick = () => this.navigatePeriod(1);
            if (editorBtn) editorBtn.onclick = () => this.openScheduleEditor();
        }

        navigatePeriod(direction) {
            const newIndex = this.currentPeriodIndex + direction;
            
            if (newIndex < 0 || newIndex >= this.availablePeriods.length) {
                window.showMessage('ã“ã‚Œä»¥ä¸Šã®æœŸé–“ã¯ã‚ã‚Šã¾ã›ã‚“', 'info');
                return;
            }
            
            this.currentPeriodIndex = newIndex;
            this.displayCurrentPeriod();
        }

        async displayCurrentPeriod() {
            const displayEl = document.getElementById('currentPeriodDisplay');
            const areaEl = document.getElementById('workScheduleDisplayArea');
            
            if (this.availablePeriods.length === 0) {
                if (displayEl) displayEl.textContent = 'ä½œæˆæ¸ˆã¿ã®æœŸé–“ãªã—';
                if (areaEl) {
                    areaEl.innerHTML = `
                        <div class="text-center py-12">
                            <i class="fas fa-calendar-plus text-4xl text-gray-400 mb-4"></i>
                            <h3 class="text-lg font-semibold text-gray-600 mb-2">å‹¤å‹™åŒºåˆ†è¡¨</h3>
                            <p class="text-gray-500 mb-4">ã¾ã å‹¤å‹™è¡¨ãŒä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
                            <button onclick="document.getElementById('openScheduleEditorBtn').click()" 
                                    class="btn-unified btn-primary-unified">
                                <i class="fas fa-plus mr-2"></i>æœ€åˆã®å‹¤å‹™è¡¨ã‚’ä½œæˆ
                            </button>
                        </div>
                    `;
                }
                return;
            }

            const currentPeriod = this.availablePeriods[this.currentPeriodIndex];
            if (displayEl) {
                displayEl.innerHTML = `
                    <div>${currentPeriod.startDate} ï½ ${currentPeriod.endDate}</div>
                    <div class="text-sm text-gray-500">(${this.currentPeriodIndex + 1}/${this.availablePeriods.length})</div>
                `;
            }

            await this.renderWorkScheduleTable(currentPeriod.key);
        }

        async renderWorkScheduleTable(periodKey) {
            const areaEl = document.getElementById('workScheduleDisplayArea');
            if (!areaEl) return;

            try {
                const snapshot = await window.database.ref(`${window.DATA_ROOT}/workSchedules/${periodKey}`).once('value');
                const periodData = snapshot.val();
                
                if (!periodData || !window.ceManager?.ceList) {
                    areaEl.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-exclamation-triangle text-4xl text-yellow-500 mb-4"></i>
                            <p class="text-gray-600">å‹¤å‹™è¡¨ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ</p>
                        </div>
                    `;
                    return;
                }

                const scheduleData = periodData.scheduleData || {};
                const metadata = periodData.metadata || {};
                const dates = this.generateDateRange(new Date(metadata.startDate), new Date(metadata.endDate));

                areaEl.innerHTML = `
                    <div class="work-schedule-table-wrapper">
                        <table class="work-schedule-table">
                            ${this.generateTableHTML(dates, scheduleData)}
                        </table>
                    </div>
                `;

            } catch (error) {
                console.error('âŒ å‹¤å‹™è¡¨è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
                areaEl.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                        <p class="text-gray-600">å‹¤å‹™è¡¨ã®èª­ã¿è¾¼ã¿ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>
                    </div>
                `;
            }
        }

        generateDateRange(startDate, endDate) {
            const dates = [];
            const current = new Date(startDate);
            
            while (current <= endDate) {
                dates.push(new Date(current));
                current.setDate(current.getDate() + 1);
            }
            
            return dates;
        }

        generateTableHTML(dates, scheduleData) {
            let html = '<thead><tr><th class="name-header">æ°å</th>';
            
            dates.forEach(date => {
                const dayOfWeek = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][date.getDay()];
                const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                const headerClass = isWeekend ? 'date-header weekend-header' : 'date-header';
                
                html += `
                    <th class="${headerClass}">
                        <div>${date.getDate()}</div>
                        <div class="text-xs">${dayOfWeek}</div>
                    </th>
                `;
            });
            
            const summaryHeaders = ['A', 'A1', 'B', 'é', 'Ã—', 'å¹´', 'å‡º', 'ç ”', 'ä¼‘æ—¥æ•°', 'å®Ÿå‹¤å‹™', 'å½“ç›´å›æ•°'];
            summaryHeaders.forEach(header => {
                html += `<th class="summary-header">${header}</th>`;
            });
            html += '</tr></thead>';
            
            html += '<tbody>';
            if (window.ceManager && window.ceManager.ceList) {
                window.ceManager.ceList.forEach(ce => {
                    const fullName = ce.fullName || ce.name || '';
                    html += `<tr><td class="name-cell">
                        <div class="font-medium">${fullName}</div>
                        <div class="text-xs text-gray-500">${ce.workType}</div>
                    </td>`;
                    
                    const summary = { A: 0, A1: 0, B: 0, non: 0, off: 0, year: 0, trip: 0, training: 0, holidays: 0, actual: 0, night: 0 };
                    
                    dates.forEach(date => {
                        const dateKey = this.formatDate(date);
                        const workData = scheduleData[ce.id]?.[dateKey] || {};
                        const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                        const status = workData.status || (isWeekend ? 'Ã—' : 'A');
                        const desired = workData.desired || false;
                        
                        if (isWeekend) summary.holidays++;
                        switch (status) {
                            case 'A': summary.A++; summary.actual++; break;
                            case 'A1': summary.A1++; summary.actual++; break;
                            case 'B': summary.B++; summary.actual++; summary.night++; break;
                            case 'é': summary.non++; summary.actual++; break;
                            case 'Ã—': summary.off++; break;
                            case 'å¹´': summary.year++; summary.actual++; break;
                            case 'å‡º': summary.trip++; summary.actual++; break;
                            case 'ç ”': summary.training++; summary.actual++; break;
                        }
                        
                        let cellClass = `work-cell type-${ce.workType.toLowerCase()}`;
                        if (status) cellClass += ` status-${status}`;
                        if (desired) cellClass += ' desired';
                        if (isWeekend) cellClass += ' holiday';
                        
                        html += `<td class="${cellClass}">${status}</td>`;
                    });
                    
                    const summaryValues = [summary.A, summary.A1, summary.B, summary.non, summary.off, summary.year, summary.trip, summary.training, summary.holidays, summary.actual, summary.night];
                    summaryValues.forEach(value => {
                        html += `<td class="summary-cell">${value}</td>`;
                    });
                    
                    html += '</tr>';
                });
            }
            html += '</tbody>';

            html += '<tfoot>';
            const footerTypes = [
                { label: 'OPE(A)', filter: (ce, status) => ce.workType === 'OPE' && status === 'A' },
                { label: 'OPE(A1)', filter: (ce, status) => ce.workType === 'OPE' && status === 'A1' },
                { label: 'ME', filter: (ce, status) => ce.workType === 'ME' && ['A', 'A1', 'B', 'é', 'å¹´', 'å‡º', 'ç ”'].includes(status) },
                { label: 'HD', filter: (ce, status) => ce.workType === 'HD' && ['A', 'A1', 'B', 'é', 'å¹´', 'å‡º', 'ç ”'].includes(status) },
                { label: 'FLEX', filter: (ce, status) => ce.workType === 'FLEX' && ['A', 'A1', 'B', 'é', 'å¹´', 'å‡º', 'ç ”'].includes(status) },
                { label: 'å½“ç›´', filter: (ce, status) => status === 'B' },
                { label: 'éç•ª', filter: (ce, status) => status === 'é' }
            ];

            if (window.ceManager && window.ceManager.ceList) {
                footerTypes.forEach(type => {
                    html += `<tr class="footer-summary-row"><th class="type-label">${type.label}</th>`;
                    
                    dates.forEach(date => {
                        const dateKey = this.formatDate(date);
                        let count = 0;
                        window.ceManager.ceList.forEach(ce => {
                            const workData = scheduleData[ce.id]?.[dateKey] || {};
                            const status = workData.status || (date.getDay() === 0 || date.getDay() === 6 ? 'Ã—' : 'A');
                            if (type.filter(ce, status)) {
                                count++;
                            }
                        });
                        
                        const cellClass = (type.label === 'å½“ç›´' || type.label === 'éç•ª') && (count === 0 || count >= 2) ? 'warning-count' : '';
                        html += `<td class="${cellClass}">${count}</td>`;
                    });
                    
                    for (let i = 0; i < summaryHeaders.length; i++) {
                        html += '<td></td>';
                    }
                    html += '</tr>';
                });
            }
            
            html += '</tfoot>';
            return html;
        }

        openScheduleEditor() {
            if (window.userRole === 'viewer') {
                window.showMessage('ç·¨é›†æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“', 'warning');
                return;
            }
            
            const url = 'pages/work-schedule-editor.html';
            const win = window.open(url, '_blank', 'noopener,noreferrer,width=1400,height=900');
            
            if (!win || win.closed || typeof win.closed === 'undefined') {
                if (confirm('æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸã€‚åŒã˜ã‚¿ãƒ–ã§å‹¤å‹™è¡¨ã‚¨ãƒ‡ã‚£ã‚¿ã‚’é–‹ãã¾ã™ã‹ï¼Ÿ')) {
                    window.location.href = url;
                } else {
                    window.showMessage('å‹¤å‹™è¡¨ã‚¨ãƒ‡ã‚£ã‚¿ã‚’é–‹ãã«ã¯ã€ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¨±å¯ã—ã¦ãã ã•ã„', 'warning');
                }
            }
        }

        formatDate(date) {
            return date.toISOString().slice(0, 10);
        }
    }

    class DashboardAuth {
        constructor() {
            this.isInitialized = false;
            this.selectedDate = new Date();
            this.monthlyTasks = {};
            this.eventsListener = null;
            this.init();
        }

        async init() {
            if (this.isInitialized) return;
            this.isInitialized = true;

            try {
                await window.waitForFirebase();
                await this.checkAuthWithRetry();
            } catch (error) {
                console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                this.redirectToLogin();
            }
        }

        async checkAuthWithRetry(maxRetries = 3) {
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    const targetUID = sessionStorage.getItem('targetUID');
                    const currentUsername = sessionStorage.getItem('currentUsername');
                    if (!targetUID || !currentUsername) {
                        this.redirectToLogin();
                        return;
                    }
                    await this.ensureAnonymousAuth();
                    
                    const userSnapshot = await window.database.ref(`${window.DATA_ROOT}/users/${targetUID}`).once('value');
                    const userData = userSnapshot.val();
                    
                    if (userData && userData.setupCompleted) {
                        window.userRole = userData.role || 'viewer';
                        window.currentUserData = userData;
                        this.showDashboard();
                        return;
                    } else {
                        this.redirectToLogin();
                        return;
                    }
                } catch (error) {
                    if (attempt === maxRetries) {
                        this.redirectToLogin();
                        return;
                    }
                    await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                }
            }
        }

        async ensureAnonymousAuth() {
            let user = window.auth.currentUser;
            if (!user) {
                const result = await window.auth.signInAnonymously();
                user = result.user;
            }
            return user;
        }
        async loadAndRenderEventsForSelectedDate() {
    const grid = document.getElementById('departmentGrid');
    if (!grid) return;

    const dateKey = this.formatDate(this.selectedDate);
    try {
        const snap = await window.database.ref(`${window.DATA_ROOT}/events/byDate/${dateKey}`).once('value');
        const eventsById = snap.val() || {};
        const events = Object.values(eventsById);

        // æ—¢å­˜ã®ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢ï¼ˆæœˆæ¬¡æ¥­å‹™ä»¥å¤–ï¼‰
        grid.querySelectorAll('.task-list').forEach(el => {
            const regularTasks = el.querySelectorAll('.glass-card:not([data-monthly])');
            regularTasks.forEach(task => task.remove());
        });

        // ã‚¤ãƒ™ãƒ³ãƒˆã‚’éƒ¨é–€ã”ã¨ã«è¡¨ç¤º
        events.forEach(ev => {
            const section = grid.querySelector(`.task-list[data-department="${ev.department}"]`);
            if (!section) return;

            const item = document.createElement('div');
            item.className = 'glass-card p-2 mb-2 rounded-lg shadow-sm';
            const timeText = (ev.startTime && ev.endTime) ? ` ${ev.startTime}-${ev.endTime}` : '';
            const assigned = Array.isArray(ev.assignedCEs) ? ev.assignedCEs.length : 0;
            const need = ev.requiredPeople ?? 0;

            item.innerHTML = `
                <div class="flex justify-between items-center">
                    <div class="font-semibold text-sm">
                        <i class="fas fa-briefcase mr-1"></i>${ev.name}${timeText}
                    </div>
                    <div class="text-xs text-gray-500">${assigned}/${need}å</div>
                </div>
                ${ev.description ? `<div class="text-xs text-gray-600 mt-1">${ev.description}</div>` : ''}
                ${window.userRole !== 'viewer' ? `
                    <button onclick="window.editEvent('${dateKey}', '${ev.id}')" 
                            class="text-blue-600 hover:text-blue-800 text-xs mt-1">
                        <i class="fas fa-edit mr-1"></i>ç·¨é›†
                    </button>
                ` : ''}
            `;
            section.appendChild(item);
        });

        console.log(`âœ… ${dateKey} ã®ã‚¤ãƒ™ãƒ³ãƒˆè¡¨ç¤ºå®Œäº†: ${events.length}ä»¶`);

    } catch (error) {
        console.error('âŒ æ—¥åˆ¥ã‚¤ãƒ™ãƒ³ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        window.showMessage('ã‚¤ãƒ™ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }
}

        redirectToLogin() {
            sessionStorage.clear();
            window.location.href = 'index.html';
        }

        setupRealtimeUpdates() {
    const updateEvents = () => {
        const dateKey = this.formatDate(this.selectedDate);
        
        // æ—¢å­˜ã®ãƒªã‚¹ãƒŠãƒ¼ãŒã‚ã‚Œã°å‰Šé™¤
        if (this.eventsListener) {
            this.eventsListener.off();
        }
        
        // æ–°ã—ã„ãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        this.eventsListener = window.database.ref(`${window.DATA_ROOT}/events/byDate/${dateKey}`)
            .on('value', (snapshot) => {
                console.log('ğŸ”„ ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿æ›´æ–°æ¤œçŸ¥');
                setTimeout(() => {
                    this.loadAndRenderEventsForSelectedDate();
                }, 300);
            });
    };
    
    // åˆå›è¨­å®š
    updateEvents();
    
    // æ—¥ä»˜å¤‰æ›´æ™‚ã«å†è¨­å®š
    const originalRenderSchedule = this.renderDailySchedule.bind(this);
    this.renderDailySchedule = function() {
        originalRenderSchedule();
        updateEvents();
    };
}

        showDashboard() {
            const loadingEl = document.getElementById('loading');
            const mainEl = document.getElementById('mainInterface');
            if (loadingEl) loadingEl.style.display = 'none';
            if (mainEl) mainEl.style.display = 'block';
            
            this.updateUserDisplay();
            this.setupNavigation();
            this.setupSidebar();
            this.setupDailySchedule();
            this.initializeV2System();
        }

        updateUserDisplay() {
            const userData = window.currentUserData;
            if (!userData) return;
            document.querySelectorAll('#currentUserDisplay').forEach(el => {
                el.textContent = userData.displayName || userData.username || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
            });
        }

        setupNavigation() {
            const navTabs = [
                { id: 'dailyScheduleTab', content: 'dailyScheduleContent' },
                { id: 'ceManagementTab', content: 'ceManagementContent' },
                { id: 'calendarTab', content: 'calendarContent' },
                { id: 'departmentTimelineTab', content: 'departmentTimelineContent' },
                { id: 'personalTimelineTab', content: 'personalTimelineContent' },
                { id: 'analysisTab', content: 'analysisContent' },
                { id: 'settingsTab', content: 'settingsContent' }
            ];

            navTabs.forEach(tab => {
                const element = document.getElementById(tab.id);
                if (element) {
                    element.onclick = () => {
                        this.showScreen(tab.content, tab.id);
                        if (tab.id === 'ceManagementTab') {
                            setTimeout(() => {
                                if (window.workScheduleViewer) {
                                    window.workScheduleViewer.displayCurrentPeriod();
                                }
                            }, 100);
                        }
                        if (tab.id === 'settingsTab') {
                            setTimeout(() => this.setupAdminSettings(), 100);
                        }
                    };
                }
            });

            const toggleBtn = document.getElementById('toggleSidebar');
            const sidebar = document.getElementById('sidebar');
            if (toggleBtn && sidebar) {
                toggleBtn.onclick = () => sidebar.classList.toggle('expanded');
            }
        }

        showScreen(contentId, tabId) {
            document.querySelectorAll('.screen-content').forEach(screen => {
                screen.style.display = 'none';
            });
            
            const contentEl = document.getElementById(contentId);
            if (contentEl) {
                contentEl.style.display = 'block';
            }
            
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            const tabEl = document.getElementById(tabId);
            if (tabEl) {
                tabEl.classList.add('active');
            }
            
            if (contentId === 'ceManagementContent' && window.workScheduleViewer) {
                setTimeout(() => {
                    window.workScheduleViewer.displayCurrentPeriod();
                }, 100);
            } else if (contentId === 'settingsContent') {
                setTimeout(() => this.setupAdminSettings(), 100);
            }
        }

        setupSidebar() {
            const saveBtn = document.getElementById('templateSaveButton');
            const loadBtn = document.getElementById('templateLoadButton');
            if (saveBtn) saveBtn.onclick = () => window.showMessage('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¿å­˜æ©Ÿèƒ½ï¼ˆå®Ÿè£…äºˆå®šï¼‰', 'info');
            if (loadBtn) loadBtn.onclick = () => window.showMessage('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­è¾¼æ©Ÿèƒ½ï¼ˆå®Ÿè£…äºˆå®šï¼‰', 'info');
        }

        setupDailySchedule() {
            const datePicker = document.getElementById('scheduleDatePicker');
            if (datePicker) {
                datePicker.value = this.formatDate(this.selectedDate);
                datePicker.onchange = (e) => {
                    this.selectedDate = new Date(e.target.value + 'T00:00:00');
                    this.renderDailySchedule();
                };
            }

            const prev = document.getElementById('prevDayBtn');
            const next = document.getElementById('nextDayBtn');
            const today = document.getElementById('todayBtn');
            if (prev) prev.onclick = () => { 
                this.selectedDate.setDate(this.selectedDate.getDate() - 1); 
                if (datePicker) datePicker.value = this.formatDate(this.selectedDate); 
                this.renderDailySchedule(); 
            };
            if (next) next.onclick = () => { 
                this.selectedDate.setDate(this.selectedDate.getDate() + 1); 
                if (datePicker) datePicker.value = this.formatDate(this.selectedDate); 
                this.renderDailySchedule(); 
            };
            if (today) today.onclick = () => { 
                this.selectedDate = new Date(); 
                if (datePicker) datePicker.value = this.formatDate(this.selectedDate); 
                this.renderDailySchedule(); 
            };

            // é€šå¸¸ã®æ¥­å‹™è¿½åŠ ãƒœã‚¿ãƒ³
            const quickBtn = document.getElementById('addEventButtonDaily');
            if (quickBtn) quickBtn.onclick = () => this.openQuickAddEvent();

            // æœŸé–“ä¸€æ‹¬æ¥­å‹™è¿½åŠ ãƒœã‚¿ãƒ³
            const bulkBtn = document.getElementById('addBulkEventBtn');
            if (bulkBtn) {
                bulkBtn.onclick = () => {
                    if (window.userRole === 'viewer') {
                        window.showMessage('ç·¨é›†æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“', 'warning');
                        return;
                    }
                    if (!window.eventManager && window.EventManager) {
                        try { 
                            window.eventManager = new window.EventManager(); 
                        } catch (e) { 
                            console.warn('EventManageråˆæœŸåŒ–å¤±æ•—:', e); 
                        }
                    }
                    if (!window.eventManager) {
                        window.showMessage('ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†ã®åˆæœŸåŒ–ã‚’å¾…æ©Ÿä¸­ã§ã™', 'info');
                        return;
                    }
                    if (typeof window.eventManager.openBulkAddModal === 'function') {
                        window.eventManager.openBulkAddModal();
                    } else {
                        window.showMessage('æœŸé–“ä¸€æ‹¬æ¥­å‹™è¿½åŠ æ©Ÿèƒ½ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                    }
                };
            }

            // æœˆæ¬¡æ¥­å‹™è¿½åŠ ãƒœã‚¿ãƒ³
            const monthlyBtn = document.getElementById('addMonthlyTaskBtn');
            if (monthlyBtn) {
                monthlyBtn.onclick = () => {
                    if (window.userRole === 'viewer') {
                        window.showMessage('ç·¨é›†æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“', 'warning');
                        return;
                    }
                    if (!window.eventManager && window.EventManager) {
                        try { 
                            window.eventManager = new window.EventManager(); 
                        } catch (e) { 
                            console.warn('EventManageråˆæœŸåŒ–å¤±æ•—:', e); 
                        }
                    }
                    if (!window.eventManager) {
                        window.showMessage('ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†ã®åˆæœŸåŒ–ã‚’å¾…æ©Ÿä¸­ã§ã™', 'info');
                        return;
                    }
                    if (typeof window.eventManager.openMonthlyTaskModal === 'function') {
                        window.eventManager.openMonthlyTaskModal();
                    } else {
                        window.showMessage('æœˆæ¬¡æ¥­å‹™è¿½åŠ æ©Ÿèƒ½ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                    }
                };
            }

            this.renderDailySchedule();
        }

        renderDailySchedule() {
            const title = document.getElementById('dailyScheduleTitle');
            const grid = document.getElementById('departmentGrid');
            if (title) {
                const dateStr = this.selectedDate.toLocaleDateString('ja-JP', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric', 
                    weekday: 'short' 
                });
                title.textContent = `æ—¥åˆ¥ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆ${dateStr}ï¼‰`;
            }
            if (window.ceManager) {
                window.ceManager.currentDisplayDate = this.selectedDate;
                window.ceManager.displayCEList();
            }
            if (!grid) return;

            grid.innerHTML = '';
            grid.className = 'grid grid-cols-3 gap-4 mb-6';

            if (window.DEPARTMENTS) {
                window.DEPARTMENTS.forEach(dept => {
                    const section = this.createDepartmentSection(dept);
                    grid.appendChild(section);
                });
            }

            this.updateCEListCount();
            
            this.loadAndRenderEventsForSelectedDate();

        }

        createDepartmentSection(dept) {
            const section = document.createElement('div');
            section.className = 'department-section p-4';
            section.style.setProperty('--dept-color', window.DEPARTMENT_COLORS?.[dept] || '#e5e7eb');
            
            section.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-bold text-sm flex items-center">
                        <i class="fas fa-${window.DEPARTMENT_ICONS?.[dept] || 'cog'} mr-2" style="color: ${window.DEPARTMENT_COLORS?.[dept] || '#2563eb'}"></i>
                        <span>${dept}</span>
                    </h3>
                    ${window.userRole !== 'viewer' ? `
                    <button class="btn-unified btn-primary-unified btn-small" onclick="window.dashboardAuth.openQuickAddEvent('${dept}')">
                        <i class="fas fa-plus mr-1"></i>æ¥­å‹™è¿½åŠ 
                    </button>` : ''}
                </div>
                <div class="task-list min-h-[120px] space-y-2" data-department="${dept}">
                    <!-- é€šå¸¸æ¥­å‹™ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
                <div class="monthly-plans" data-department="${dept}">
                    <!-- æœˆæ¬¡æ¥­å‹™ãŒã“ã“ã«çœã‚¹ãƒšãƒ¼ã‚¹è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
            `;

            return section;
        }

        openQuickAddEvent(department) {
            if (window.userRole === 'viewer') {
                window.showMessage('ç·¨é›†æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“', 'warning');
                return;
            }
            if (!window.eventManager && window.EventManager) {
                try { 
                    window.eventManager = new window.EventManager(); 
                } catch (e) { 
                    console.warn('EventManageråˆæœŸåŒ–å¤±æ•—:', e); 
                }
            }
            if (!window.eventManager) {
                window.showMessage('ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†ã®åˆæœŸåŒ–ã‚’å¾…æ©Ÿä¸­ã§ã™', 'info');
                return;
            }
            if (typeof window.eventManager.openAddEventModal === 'function') {
                window.eventManager.openAddEventModal(department);
            } else {
                window.showMessage('æ¥­å‹™è¿½åŠ ã®UIãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
            }
        }

        setupAdminSettings() {
            const settingsContent = document.getElementById('settingsContent');
            if (!settingsContent) return;

            if (window.userRole === 'admin') {
                settingsContent.innerHTML = `
                    <h2 class="text-2xl font-bold mb-6">è¨­å®š</h2>
                    <div class="glass-card p-6 mb-6">
                        <h3 class="text-lg font-semibold mb-4 text-red-600">
                            <i class="fas fa-shield-alt mr-2"></i>ç®¡ç†è€…æ©Ÿèƒ½
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button onclick="window.open('pages/admin-dashboard.html', '_blank')" class="btn-unified btn-primary-unified">
                                <i class="fas fa-users-cog mr-2"></i>ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
                            </button>
                        </div>
                    </div>
                    <div class="glass-card p-6 mb-6">
                        <h3 class="text-lg font-semibold mb-4">
                            <i class="fas fa-cog mr-2"></i>ä¸€èˆ¬è¨­å®š
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">è¡¨ç¤ºå</label>
                                <input type="text" id="displayNameSetting" class="input-unified" value="${window.currentUserData?.displayName || ''}">
                            </div>
                            <button id="saveSettingsBtn" class="btn-unified btn-primary-unified">
                                <i class="fas fa-save mr-2"></i>è¨­å®šä¿å­˜
                            </button>
                        </div>
                    </div>
                `;
            } else {
                settingsContent.innerHTML = `
                    <h2 class="text-2xl font-bold mb-6">è¨­å®š</h2>
                    <div class="glass-card p-6 mb-6">
                        <h3 class="text-lg font-semibold mb-4">å€‹äººè¨­å®š</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">è¡¨ç¤ºå</label>
                                <input type="text" id="displayNameSetting" class="input-unified" value="${window.currentUserData?.displayName || ''}">
                            </div>
                            <button id="saveSettingsBtn" class="btn-unified btn-primary-unified">
                                <i class="fas fa-save mr-2"></i>è¨­å®šä¿å­˜
                            </button>
                        </div>
                    </div>
                `;
            }
            
            const saveBtn = document.getElementById('saveSettingsBtn');
            if (saveBtn) {
                saveBtn.onclick = async () => {
                    const displayName = document.getElementById('displayNameSetting')?.value.trim();
                    if (!displayName) {
                        window.showMessage('è¡¨ç¤ºåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
                        return;
                    }
                    try {
                        const targetUID = sessionStorage.getItem('targetUID');
                        await window.database.ref(`${window.DATA_ROOT}/users/${targetUID}`).update({
                            displayName: displayName,
                            lastUpdated: Date.now()
                        });
                        window.currentUserData.displayName = displayName;
                        this.updateUserDisplay();
                        window.showMessage('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
                    } catch (error) {
                        console.error('è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                        window.showMessage('è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                    }
                };
            }
        }

        formatDate(date) {
            return date.toISOString().slice(0, 10);
        }

        updateCEListCount() {
            const el = document.getElementById('ceListCount');
            if (el) {
                const count = window.ceManager?.ceList?.length || 0;
                el.textContent = String(count);
            }
        }

        // V2ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ï¼ˆå®Œå…¨ä¿®æ­£ç‰ˆï¼‰
        initializeV2System() {
            setTimeout(async () => {
                try {
                    let attempts = 0;
                    while (attempts < 50) {
                        const allReady = (
                            typeof window.CalendarView !== 'undefined' &&
                            typeof window.EventManager !== 'undefined' &&
                            typeof window.CEManager !== 'undefined' &&
                            typeof window.showMessage !== 'undefined' &&
                            typeof window.CEDailyStatusManager !== 'undefined'
                        );
                        if (allReady) break;
                        await new Promise(resolve => setTimeout(resolve, 100));
                        attempts++;
                    }

                    // ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆï¼ˆã‚¨ãƒ©ãƒ¼è€æ€§ã‚ã‚Šï¼‰
                    try {
                        if (!window.calendarView && window.CalendarView) {
                            window.calendarView = new window.CalendarView();
                        }
                    } catch (e) { console.warn('CalendarViewåˆæœŸåŒ–å¤±æ•—:', e); }

                    try {
                        if (!window.eventManager && window.EventManager) {
                            window.eventManager = new window.EventManager();
                        }
                    } catch (e) { console.warn('EventManageråˆæœŸåŒ–å¤±æ•—:', e); }

                    try {
                        if (!window.ceManager && window.CEManager) {
                            window.ceManager = new window.CEManager();
                        }
                    } catch (e) { console.warn('CEManageråˆæœŸåŒ–å¤±æ•—:', e); }

                    try {
                        if (!window.ceDailyStatus && window.CEDailyStatusManager) {
                            window.ceDailyStatus = new window.CEDailyStatusManager();
                        }
                    } catch (e) { console.warn('CEDailyStatusManageråˆæœŸåŒ–å¤±æ•—:', e); }

                    try {
                        if (!window.workScheduleViewer) {
                            window.workScheduleViewer = new WorkScheduleViewer();
                        }
                    } catch (e) { console.warn('WorkScheduleVieweråˆæœŸåŒ–å¤±æ•—:', e); }

                    console.log('âœ… V2ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
                } catch (error) {
                    console.error('âŒ V2ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                }
            }, 1500);
        }
    }

    // åˆæœŸåŒ–
    if (!window.dashboardAuthInitialized) {
        window.dashboardAuthInitialized = true;
        document.addEventListener('DOMContentLoaded', () => {
            window.dashboardAuth = new DashboardAuth();
        });
    }
    </script>
</body>
</html>
