/*
 * æ¥­å‹™é…ç½®èª¿æ•´ã‚·ã‚¹ãƒ†ãƒ ï¼šå€‹äººã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ï¼ˆãƒãƒ¼è¡¨ç¤ºï¼‰& é€±é–“PDFä¸€æ‹¬å‡ºåŠ›
 * -------------------------------------------------------------
 * âœ… ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ãã®ã¾ã¾èª­ã¿è¾¼ã‚ã‚‹ drop-in å®Ÿè£…ã§ã™ã€‚
 *   1) æœ¬ãƒ•ã‚¡ã‚¤ãƒ«ã® <SCRIPT> éƒ¨åˆ†ã‚’æ—¢å­˜ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«è¿½åŠ 
 *   2) ä¸‹éƒ¨ã® <CSS> ã‚’ã‚¹ã‚¿ã‚¤ãƒ«ã‚·ãƒ¼ãƒˆã¸è¿½åŠ 
 *   3) æ—¢å­˜ã® renderWeeklyPersonalTimeline ã‚’ renderWeeklyPersonalTimelineWithBars ã«ç½®æ›
 *   4) hospitalStore ã®æ§‹é€ ï¼ˆstaff, assignments, dailyBusinesses, colorMap, currentWeekï¼‰ã«ä¾å­˜
 *
 * æœŸå¾…ã™ã‚‹ hospitalStore ä¾‹ï¼š
 *   hospitalStore = {
 *     staff: [{ id: 's001', name: 'å±±ç”°', baseCategory: 'ME', color: '#7C3AED' }, ...],
 *     // æ›œæ—¥ã‚­ãƒ¼: 'Mon' | 'Tue' | 'Wed' | 'Thu' | 'Fri'
 *     assignments: { Mon: { businessId1: ['s001','s002'], ... }, ... },
 *     dailyBusinesses: { Mon: [{ id:'businessId1', title:'æ‰‹è¡“å®¤A', category:'HD', startTime:'08:30', endTime:'12:00' }, ...], ... },
 *     colorMap: { HD:'#FF69B4', FLEX:'#FFD700', /* ä»–ã‚«ãƒ†ã‚´ãƒªè‰² */ },
 *     currentWeek: { startISO: '2025-08-18' } // é€±ã®æœˆæ›œISOæ—¥ä»˜ï¼ˆYYYY-MM-DDï¼‰
 *   }
 *
 * é‡è¦ï¼šHD=ãƒ”ãƒ³ã‚¯(#FF69B4), FLEX=ã‚´ãƒ¼ãƒ«ãƒ‰(#FFD700) ã¯å³å®ˆ
 */

// =========================
// ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³åŸºæœ¬è¨­å®š
// =========================
const TIMELINE_CONFIG = {
  startHour: 8,      // 8:00
  endHour: 17,       // 17:00
  totalHours: 9,     // 9æ™‚é–“
  laneHeight: 30,    // å„æ®µã®é«˜ã•ï¼ˆpxï¼‰
  barHeight: 26,     // ãƒãƒ¼ã®é«˜ã•ï¼ˆpxï¼‰
  padding: 4         // ã‚»ãƒ«å†…ã®ä¸Šä¸‹å·¦å³ä½™ç™½
};

// -------------------------
// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
// -------------------------
function timeToMinutes(timeStr) {
  const [h, m] = String(timeStr).split(':').map(Number);
  return h * 60 + (m || 0);
}

function timeToPercent(timeStr) {
  const minutes = timeToMinutes(timeStr);
  const start = TIMELINE_CONFIG.startHour * 60;
  const total = TIMELINE_CONFIG.totalHours * 60;
  return ((minutes - start) / total) * 100;
}

function clampPercent(p) {
  if (Number.isNaN(p)) return 0;
  return Math.max(0, Math.min(100, p));
}

function getReadableTextColor(bg) {
  // ç›¸å¯¾è¼åº¦ã«åŸºã¥ãç°¡æ˜“ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆï¼ˆWCAGè¿‘ä¼¼ï¼‰
  try {
    const hex = bg.replace('#','');
    const r = parseInt(hex.substring(0,2),16)/255;
    const g = parseInt(hex.substring(2,4),16)/255;
    const b = parseInt(hex.substring(4,6),16)/255;
    const Rs = (r <= 0.03928) ? r/12.92 : Math.pow((r+0.055)/1.055, 2.4);
    const Gs = (g <= 0.03928) ? g/12.92 : Math.pow((g+0.055)/1.055, 2.4);
    const Bs = (b <= 0.03928) ? b/12.92 : Math.pow((b+0.055)/1.055, 2.4);
    const L = 0.2126*Rs + 0.7152*Gs + 0.0722*Bs;
    return L > 0.54 ? '#111' : '#fff';
  } catch(e) {
    return '#fff';
  }
}

function getDayDisplayName(dayKey) {
  return ({ Mon:'æœˆ', Tue:'ç«', Wed:'æ°´', Thu:'æœ¨', Fri:'é‡‘' })[dayKey] || dayKey;
}

function isoToDate(iso) {
  const [y,m,d] = iso.split('-').map(Number);
  return new Date(y, m-1, d);
}

function formatDate(d) {
  return d.toLocaleDateString('ja-JP', { year:'numeric', month:'2-digit', day:'2-digit' }).replaceAll('/','-');
}

function getWeekStartDate() {
  if (window.hospitalStore?.currentWeek?.startISO) return isoToDate(hospitalStore.currentWeek.startISO);
  // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šç›´è¿‘ã®æœˆæ›œæ—¥
  const now = new Date();
  const dow = now.getDay(); // 0:æ—¥ 1:æœˆ ... 6:åœŸ
  const diffToMon = (dow + 6) % 7; // æœˆ=0
  const mon = new Date(now);
  mon.setDate(now.getDate() - diffToMon);
  mon.setHours(0,0,0,0);
  return mon;
}

function getWeekEndDate() {
  const start = getWeekStartDate();
  const end = new Date(start);
  end.setDate(start.getDate() + 4); // é‡‘æ›œæ—¥
  return end;
}

// çŠ¶æ…‹è¡¨ç¤ºï¼ˆéç•ªãƒ»ä¼‘æš‡ãƒ»å‡ºå¼µ ãªã©ï¼‰
function getStaffDayStatus(staffId, dayKey) {
  // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å®Ÿãƒ‡ãƒ¼ã‚¿ä»•æ§˜ã«åˆã‚ã›ã¦æ‹¡å¼µ
  // ä¾‹ï¼šhospitalStore.status[dayKey]?.[staffId] ã« 'offDuty' | 'annualLeave' | 'businessTrip' | 'available'
  return window.hospitalStore?.status?.[dayKey]?.[staffId] || 'available';
}

function getStatusOverlayStyle(status) {
  switch (status) {
    case 'offDuty':
      return 'repeating-linear-gradient(45deg, rgba(108,117,125,0.8), rgba(108,117,125,0.8) 10px, rgba(90,98,104,0.8) 10px, rgba(90,98,104,0.8) 20px)';
    case 'annualLeave':
      return 'repeating-linear-gradient(45deg, rgba(40,167,69,0.8), rgba(40,167,69,0.8) 10px, rgba(30,126,52,0.8) 10px, rgba(30,126,52,0.8) 20px)';
    case 'businessTrip':
      return 'repeating-linear-gradient(45deg, rgba(0,123,255,0.8), rgba(0,123,255,0.8) 10px, rgba(0,86,179,0.8) 10px, rgba(0,86,179,0.8) 20px)';
    default:
      return 'transparent';
  }
}

function getStatusDisplayName(status) {
  return ({ offDuty:'éç•ª', annualLeave:'ä¼‘æš‡', businessTrip:'å‡ºå¼µ' })[status] || '';
}

// ã‚¯ãƒªãƒƒã‚¯ã§ç·¨é›†
function editBusinessFromTimeline(businessId, dayKey) {
  if (typeof window.openBusinessEditor === 'function') {
    window.openBusinessEditor({ businessId, day: dayKey });
  } else {
    console.warn('openBusinessEditor ãŒæœªå®šç¾©ã§ã™');
  }
}

function showMessage(msg, type='info') {
  // ä»»æ„ã®ãƒˆãƒ¼ã‚¹ãƒˆ/UIã¸æ¥ç¶š
  console[type === 'error' ? 'error' : 'log'](`[${type}] ${msg}`);
}

// -------------------------
// ãƒ¬ãƒ¼ãƒ³å‰²å½“ & ãƒãƒ¼ç”Ÿæˆ
// -------------------------
function buildStaffDayBars(staffId, dayKey) {
  const dayAssignments = (window.hospitalStore?.assignments?.[dayKey]) || {};
  const businessesInDay = (window.hospitalStore?.dailyBusinesses?.[dayKey]) || [];
  const items = [];

  for (const [businessId, assignedStaffIds] of Object.entries(dayAssignments)) {
    if (Array.isArray(assignedStaffIds) && assignedStaffIds.includes(staffId)) {
      const b = businessesInDay.find(x => x.id === businessId);
      if (!b) continue;
      const startM = timeToMinutes(b.startTime);
      const endM = timeToMinutes(b.endTime);
      const inRange = endM > TIMELINE_CONFIG.startHour * 60 && startM < TIMELINE_CONFIG.endHour * 60;
      if (!inRange) continue;
      items.push({
        businessId,
        title: b.title,
        category: b.category,
        startTime: b.startTime,
        endTime: b.endTime,
        startMinutes: startM,
        endMinutes: endM
      });
    }
  }

  // é–‹å§‹æ™‚é–“ã§ã‚½ãƒ¼ãƒˆ
  items.sort((a,b) => a.startMinutes - b.startMinutes);

  // ãƒ¬ãƒ¼ãƒ³å‰²å½“ï¼ˆåŒºé–“ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ï¼‰
  const lanes = []; // å„ãƒ¬ãƒ¼ãƒ³ã®æœ€çµ‚çµ‚äº†æ™‚åˆ»ï¼ˆåˆ†ï¼‰
  for (const it of items) {
    let lane = -1;
    for (let i=0; i<lanes.length; i++) {
      if (it.startMinutes >= lanes[i]) { lane = i; break; }
    }
    if (lane === -1) { lane = lanes.length; lanes.push(0); }
    lanes[lane] = Math.max(lanes[lane], it.endMinutes);
    it.lane = lane;
  }

  return { items, maxLanes: lanes.length };
}

// -------------------------
// ã‚»ãƒ«æç”»
// -------------------------
function renderStaffDayTimeline(staffId, dayKey) {
  const { items, maxLanes } = buildStaffDayBars(staffId, dayKey);
  const cellHeight = Math.max(60, maxLanes * TIMELINE_CONFIG.laneHeight + TIMELINE_CONFIG.padding * 2);

  const barsHTML = items.map(item => {
    const left = clampPercent(timeToPercent(item.startTime));
    const right = clampPercent(timeToPercent(item.endTime));
    const width = Math.max(0, right - left);
    const top = TIMELINE_CONFIG.padding + (item.lane * TIMELINE_CONFIG.laneHeight);

    const bg = (window.hospitalStore?.colorMap?.[item.category]) || '#6c757d';
    const color = getReadableTextColor(bg);

    return `
      <div class="timeline-business-bar"
           style="position:absolute;left:${left}%;width:${width}%;top:${top}px;height:${TIMELINE_CONFIG.barHeight}px;background-color:${bg};color:${color};border-radius:6px;padding:2px 6px;font-size:12px;font-weight:600;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 4px rgba(0,0,0,0.15);cursor:pointer;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;"
           title="${item.title} (${item.startTime}-${item.endTime})"
           onclick="editBusinessFromTimeline('${item.businessId}','${dayKey}')"
           aria-label="${item.title} ${item.startTime} ã‹ã‚‰ ${item.endTime}">
        ${item.title}
      </div>`;
  }).join('');

  const status = getStaffDayStatus(staffId, dayKey);
  const statusOverlay = (status && status !== 'available') ? `
    <div class="status-overlay status-${status}"
         style="position:absolute;inset:0;background:${getStatusOverlayStyle(status)};display:flex;align-items:center;justify-content:center;font-weight:700;color:white;z-index:10;">
      ${getStatusDisplayName(status)}
    </div>` : '';

  const isAltBg = (dayKey === 'Tue' || dayKey === 'Thu');
  return `
    <div class="day-timeline-cell" style="position:relative;height:${cellHeight}px;border-right:2px solid #dee2e6;background:${isAltBg ? '#fafbfc' : 'white'};overflow:hidden;">
      ${barsHTML}
      ${statusOverlay}
    </div>`;
}

// -------------------------
// é€±é–“å…¨ä½“æç”»
// -------------------------
function renderWeeklyPersonalTimelineWithBars() {
  const days = ['Mon','Tue','Wed','Thu','Fri'];
  const headerTimeMarks = Array.from({ length: 10 }, (_, i) => {
    const t = (8 + i).toString().padStart(2,'0') + ':00';
    const left = (i / 9) * 100;
    return `<div class=\"time-mark\" style=\"left:${left}%\">${t}</div>`;
  }).join('');

  const staffRows = (window.hospitalStore?.staff || []).map(staff => {
    const infoCell = `
      <div class=\"staff-info-cell\" role=\"rowheader\" aria-label=\"${staff.name}\">
        <div class=\"staff-avatar\" style=\"background-color:${staff.color}\">${(staff.name||'').charAt(0)}</div>
        <div class=\"staff-details\">
          <div class=\"staff-name\">${staff.name}</div>
          <div class=\"staff-category\">${staff.baseCategory || ''}</div>
        </div>
      </div>`;
    const dayCells = days.map(dk => renderStaffDayTimeline(staff.id, dk)).join('');
    return `<div class=\"staff-timeline-row\">${infoCell}${dayCells}</div>`;
  }).join('');

  const html = `
    <div class=\"weekly-personal-timeline\" aria-label=\"å€‹äººåˆ¥é€±é–“ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ 8æ™‚ã‹ã‚‰17æ™‚\">
      <div class=\"timeline-header\">
        <h3>ğŸ‘¤ å€‹äººåˆ¥é€±é–“ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ (8:00-17:00)</h3>
        <div class=\"timeline-controls\">
          <button onclick=\"exportWeeklyTimelinePDF()\" class=\"btn btn-primary\">ğŸ“„ é€±é–“PDFå‡ºåŠ›</button>
          <button onclick=\"toggleTimelineView?.()\" class=\"btn btn-secondary\">ğŸ”„ è¡¨ç¤ºåˆ‡æ›¿</button>
        </div>
      </div>
      <div class=\"timeline-time-header\">
        <div class=\"staff-column-header\">ã‚¹ã‚¿ãƒƒãƒ•</div>
        ${['Mon','Tue','Wed','Thu','Fri'].map(day => `
          <div class=\"day-column-header\">
            <div class=\"day-info\">
              <div class=\"day-name\">${getDayDisplayName(day)}</div>
              <div class=\"day-date\">${formatDate(new Date(getWeekStartDate().getTime() + (['Mon','Tue','Wed','Thu','Fri'].indexOf(day))*86400000))}</div>
            </div>
            <div class=\"time-scale\">${headerTimeMarks}</div>
          </div>`).join('')}
      </div>
      <div class=\"timeline-body\">${staffRows}</div>
    </div>`;

  return html;
}

// -------------------------
// PDF å‡ºåŠ›ï¼ˆhtml2canvas + jsPDFï¼‰
// -------------------------
async function exportWeeklyTimelinePDF() {
  const container = document.querySelector('.weekly-personal-timeline');
  if (!container) { showMessage('ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“','error'); return; }

  showMessage('PDFã‚’ç”Ÿæˆä¸­...','info');

  try {
    // é«˜è§£åƒåº¦ã‚­ãƒ£ãƒ—ãƒãƒ£
    const canvas = await html2canvas(container, {
      scale: 2,
      useCORS: true,
      logging: false,
      scrollX: 0,
      scrollY: -window.scrollY,
      backgroundColor: '#ffffff',
      width: container.scrollWidth,
      height: container.scrollHeight
    });

    const imgData = canvas.toDataURL('image/png');
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('landscape','mm','a3');

    const pageW = pdf.internal.pageSize.getWidth();
    const pageH = pdf.internal.pageSize.getHeight();

    const margin = 10; // 10mm
    const titleH = 15;
    const availableH = pageH - (titleH + margin*2 + 10); // 10mm = ãƒ•ãƒƒã‚¿ãƒ¼é ˜åŸŸ

    const imgW = pageW - margin*2;

    // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚¢ã‚¹ãƒšã‚¯ãƒˆã«åˆã‚ã›ã¦é«˜ã•è¨ˆç®—
    const fullImgH = (canvas.height * imgW) / canvas.width;

    // ã‚¿ã‚¤ãƒˆãƒ«
    pdf.setFontSize(16);
    pdf.setFont('helvetica','bold');
    const title = `æ¥­å‹™é…ç½®èª¿æ•´ã‚·ã‚¹ãƒ†ãƒ  - é€±é–“ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ (${formatDate(getWeekStartDate())} ï½ ${formatDate(getWeekEndDate())})`;
    pdf.text(title, pageW/2, margin + 5, { align: 'center' });

    // è¤‡æ•°ãƒšãƒ¼ã‚¸ã¸ã®ã‚¹ãƒ©ã‚¤ã‚¹æç”»
    let drawnH = 0;
    let pageNum = 1;

    while (drawnH < fullImgH) {
      if (pageNum > 1) {
        pdf.addPage();
        pdf.setFontSize(16);
        pdf.setFont('helvetica','bold');
        pdf.text(title, pageW/2, margin + 5, { align: 'center' });
      }

      const sliceH = Math.min(availableH, fullImgH - drawnH);

      // ä¸€æ™‚ã‚­ãƒ£ãƒ³ãƒã‚¹ã§ãƒˆãƒªãƒŸãƒ³ã‚°
      const tmp = document.createElement('canvas');
      const ctx = tmp.getContext('2d');
      tmp.width = canvas.width;
      tmp.height = Math.round((sliceH / fullImgH) * canvas.height);

      ctx.drawImage(
        canvas,
        0, Math.round((drawnH / fullImgH) * canvas.height),
        canvas.width, tmp.height,
        0, 0,
        canvas.width, tmp.height
      );

      const sliceData = tmp.toDataURL('image/png');
      pdf.addImage(sliceData, 'PNG', margin, margin + 10, imgW, sliceH);

      // ãƒ•ãƒƒã‚¿ãƒ¼
      pdf.setFontSize(8);
      pdf.setFont('helvetica','normal');
      pdf.setTextColor(100,100,100);
      pdf.text(`å‡ºåŠ›æ—¥æ™‚: ${new Date().toLocaleString('ja-JP')}`, margin, pageH - 5);
      pdf.text(`ãƒšãƒ¼ã‚¸: ${pageNum}`, pageW - margin - 20, pageH - 5);

      drawnH += sliceH;
      pageNum++;
    }

    const fileName = `æ¥­å‹™é…ç½®_é€±é–“ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³_${formatDate(getWeekStartDate())}_${formatDate(getWeekEndDate())}.pdf`;
    pdf.save(fileName);
    showMessage('é€±é–“ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³PDFã‚’å‡ºåŠ›ã—ã¾ã—ãŸ','success');
  } catch (e) {
    console.error('PDFå‡ºåŠ›ã‚¨ãƒ©ãƒ¼:', e);
    showMessage('PDFå‡ºåŠ›ã«å¤±æ•—ã—ã¾ã—ãŸ','error');
  }
}

// -------------------------
// ç”»é¢ã¸ã®å·®ã—æ›¿ãˆï¼ˆä¾‹ï¼‰
// -------------------------
// æ—¢å­˜ã® renderWeeklyPersonalTimeline å‘¼å‡ºç®‡æ‰€ã‚’ä»¥ä¸‹ã«ç½®æ›ï¼š
// document.getElementById('personal-timeline').innerHTML = renderWeeklyPersonalTimelineWithBars();

// -------------------------
// ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ï¼ˆHTMLä¾‹ï¼‰
// -------------------------
/*
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
*/


/* =========================
   CSSï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®CSSã¸è¿½åŠ ï¼‰
   ========================= */
/* é€±é–“ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ï¼ˆãƒãƒ¼è¡¨ç¤ºå¯¾å¿œï¼‰ */
/* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å›ºå®šãƒ˜ãƒƒãƒ€ãƒ¼ */
/* ---- Paste from here into your stylesheet ---- */
/* é€±é–“ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ï¼ˆãƒãƒ¼è¡¨ç¤ºå¯¾å¿œï¼‰ */
/* ãƒ˜ãƒƒãƒ€ãƒ¼ */
/* .weekly-personal-timeline ã‚’ãƒ©ãƒƒãƒ‘ã¨ã—ã¦åˆ©ç”¨ */

/* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
/* grid: [ã‚¹ã‚¿ãƒƒãƒ•åˆ—200px] + [æ›œæ—¥Ã—5] */

/* å°åˆ·æ™‚æœ€é©åŒ– */

/* --- å®Ÿã‚¹ã‚¿ã‚¤ãƒ« --- */

// ä»¥ä¸‹ã¯ã‚¹ã‚¿ã‚¤ãƒ«ã‚·ãƒ¼ãƒˆï¼ˆ.cssï¼‰ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ï¼š
/*
.weekly-personal-timeline .timeline-header {
  display:flex; align-items:center; justify-content:space-between;
  padding:10px 12px; background:#f8f9fa; border:1px solid #dee2e6; border-bottom:none;
}
.weekly-personal-timeline .timeline-controls { display:flex; gap:8px; }

.timeline-time-header {
  display:grid; grid-template-columns:200px repeat(5, 1fr);
  background:#f8f9fa; border-bottom:3px solid #dee2e6; position:sticky; top:0; z-index:100;
}
.staff-column-header { padding:15px; font-weight:700; text-align:center; border-right:2px solid #dee2e6; background:#e9ecef; }
.day-column-header { border-right:2px solid #dee2e6; background:#fff; }
.day-info { text-align:center; padding:10px; background:#007bff; color:#fff; }
.time-scale { position:relative; height:25px; background:linear-gradient(to right, #f1f3f4 0%, #f1f3f4 100%); border-top:1px solid #dee2e6; }
.time-mark { position:absolute; top:2px; font-size:.7em; color:#495057; transform:translateX(-50%); background:rgba(255,255,255,0.8); padding:1px 3px; border-radius:2px; }

.staff-timeline-row { display:grid; grid-template-columns:200px repeat(5, 1fr); border-bottom:1px solid #dee2e6; }
.staff-info-cell { padding:15px; border-right:2px solid #dee2e6; display:flex; align-items:center; gap:12px; background:#f8f9fa; }
.staff-avatar { width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; font-size:1.1em; }
.staff-details .staff-name { font-weight:700; }
.staff-details .staff-category { font-size:.85em; color:#6c757d; }

.timeline-business-bar:hover { transform:translateY(-1px); box-shadow:0 4px 8px rgba(0,0,0,0.25) !important; z-index:20; }

/* çŠ¶æ…‹ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
.status-overlay.status-offDuty { background:repeating-linear-gradient(45deg, rgba(108,117,125,0.8), rgba(108,117,125,0.8) 10px, rgba(90,98,104,0.8) 10px, rgba(90,98,104,0.8) 20px) !important; }
.status-overlay.status-annualLeave { background:repeating-linear-gradient(45deg, rgba(40,167,69,0.8), rgba(40,167,69,0.8) 10px, rgba(30,126,52,0.8) 10px, rgba(30,126,52,0.8) 20px) !important; }
.status-overlay.status-businessTrip { background:repeating-linear-gradient(45deg, rgba(0,123,255,0.8), rgba(0,123,255,0.8) 10px, rgba(0,86,179,0.8) 10px, rgba(0,86,179,0.8) 20px) !important; }

/* å°åˆ·æœ€é©åŒ– */
@media print {
  .timeline-header, .timeline-controls { display:none !important; }
  .timeline-time-header { position:static !important; }
  .staff-avatar { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
}
*/

// ---- End of CSS ----

/*
å—ã‘å…¥ã‚ŒåŸºæº– å¯¾å¿œãƒ¡ãƒ¢
- ãƒãƒ¼è¡¨ç¤ºï¼ä½ç½®å¹…ï¼ˆé–‹å§‹ãƒ»çµ‚äº†åæ˜ ï¼‰ãƒ»ãƒ»ãƒ»timeToPercent + clampPercent + æç”»style
- é‡è¤‡ãƒ¬ãƒ¼ãƒ³è‡ªå‹•é…ç½®ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»buildStaffDayBars å†… lanes ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 
- ãƒãƒ¼å†…æ¥­å‹™åè¡¨ç¤ºãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»renderStaffDayTimeline ã® innerText
- åŒºåˆ†è‰²ï¼ˆHD=ãƒ”ãƒ³ã‚¯, FLEX=ã‚´ãƒ¼ãƒ«ãƒ‰ï¼‰ãƒ»ãƒ»hospitalStore.colorMap ã‚’ä½¿ç”¨
- éç•ª/ä¼‘æš‡/å‡ºå¼µã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»getStaffDayStatus + getStatusOverlayStyle + CSS
- 8:00-17:00æ™‚é–“è»¸ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ˜ãƒƒãƒ€ãƒ¼ time-mark ç”Ÿæˆ
- é€±é–“PDFä¸€æ‹¬ï¼ˆA3æ¨ª/è¤‡æ•°ãƒšãƒ¼ã‚¸ï¼‰ãƒ»ãƒ»ãƒ»ãƒ»exportWeeklyTimelinePDFï¼ˆhtml2canvas + jsPDFï¼‰
- ãƒ˜ãƒƒãƒ€ãƒ¼/ãƒ•ãƒƒã‚¿ãƒ¼ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ã‚¿ã‚¤ãƒˆãƒ« & å‡ºåŠ›æ—¥æ™‚/ãƒšãƒ¼ã‚¸æ•°
- æ—¢å­˜æ©Ÿèƒ½ç¶­æŒãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»æœ¬å®Ÿè£…ã¯æç”»ã¨å‡ºåŠ›ã®ã¿ã‚’ç½®æ›ãƒ»è¿½åŠ ã€‚ãƒ‡ãƒ¼ã‚¿ã‚„D&Dãƒ­ã‚¸ãƒƒã‚¯ã¯æ—¢å­˜ã‚’åˆ©ç”¨ã€‚
*/
